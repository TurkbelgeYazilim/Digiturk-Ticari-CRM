{
    "sourceFile": "fix_1403_fatura.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756560711417,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756560711417,
            "name": "Commit-0",
            "content": "<?php\r\n// 1403 ID'li fatura için özel düzeltme scripti (yeni problematik kayıt)\r\nheader('Content-Type: text/plain; charset=utf-8');\r\n\r\n$mysqli = new mysqli('localhost', 'ilekasoft_crmuser', 'KaleW356!', 'ilekasoft_crmdb');\r\n$mysqli->set_charset(\"utf8mb4\");\r\n\r\nif ($mysqli->connect_error) {\r\n    die('Connection failed: ' . $mysqli->connect_error);\r\n}\r\n\r\necho \"=== 1403 ID'li Fatura Düzeltme Scripti ===\\n\\n\";\r\n\r\n// Mevcut durumu göster\r\n$query = \"SELECT * FROM satisFaturasiStok WHERE satisStok_satisFaturasiID = 1403\";\r\n$result = $mysqli->query($query);\r\n\r\nif (!$result) {\r\n    die(\"Sorgu hatası: \" . $mysqli->error);\r\n}\r\n\r\necho \"Mevcut kayıtlar:\\n\";\r\n$records = [];\r\nwhile ($row = $result->fetch_assoc()) {\r\n    $records[] = $row;\r\n    echo \"ID: {$row['satisStok_id']}, Miktar: {$row['satisStok_miktar']}, BirimFiyat: {$row['satisStok_birimFiyat']}, FiyatMiktar: {$row['satisStok_fiyatMiktar']}, KDV: {$row['satisStok_kdv']}\\n\";\r\n}\r\n\r\nif (count($records) == 0) {\r\n    echo \"1403 ID'li faturada kayıt bulunamadı.\\n\";\r\n    $mysqli->close();\r\n    exit;\r\n}\r\n\r\necho \"\\n=== Düzeltme İşlemi ===\\n\";\r\n\r\n// Kullanıcının belirttiği bilgiye göre: 1000 TL KDV dahil tutar girilmişti\r\n$correct_total_kdv_dahil = 1000;\r\n\r\nforeach ($records as $record) {\r\n    $miktar = floatval($record['satisStok_miktar']);\r\n    $kdv_orani = floatval($record['satisStok_kdv']);\r\n    $record_id = $record['satisStok_id'];\r\n    \r\n    // KDV dahil toplam 1000 TL ise, birim fiyat = 1000 / miktar\r\n    $correct_birim_fiyat_kdv_dahil = $correct_total_kdv_dahil / $miktar;\r\n    $correct_fiyat_miktar = $correct_total_kdv_dahil;\r\n    $correct_toplam = $correct_total_kdv_dahil;\r\n    \r\n    echo \"Kayıt ID: $record_id\\n\";\r\n    echo \"  Miktar: $miktar\\n\";\r\n    echo \"  KDV Oranı: $kdv_orani%\\n\";\r\n    echo \"  Düzeltilecek BirimFiyat: $correct_birim_fiyat_kdv_dahil (KDV Dahil)\\n\";\r\n    echo \"  Düzeltilecek FiyatMiktar: $correct_fiyat_miktar\\n\";\r\n    echo \"  Düzeltilecek Toplam: $correct_toplam\\n\\n\";\r\n    \r\n    // Gerçek düzeltme işlemi\r\n    $update_query = \"\r\n        UPDATE satisFaturasiStok SET \r\n            satisStok_birimFiyat = ?,\r\n            satisStok_fiyatMiktar = ?\r\n        WHERE satisStok_id = ?\r\n    \";\r\n    \r\n    $stmt = $mysqli->prepare($update_query);\r\n    if (!$stmt) {\r\n        echo \"Prepare hatası: \" . $mysqli->error . \"\\n\";\r\n        continue;\r\n    }\r\n    \r\n    $stmt->bind_param(\"ddi\", $correct_birim_fiyat_kdv_dahil, $correct_fiyat_miktar, $record_id);\r\n    \r\n    if ($stmt->execute()) {\r\n        echo \"✓ Kayıt ID $record_id başarıyla güncellendi.\\n\\n\";\r\n    } else {\r\n        echo \"✗ Kayıt ID $record_id güncellenirken hata: \" . $stmt->error . \"\\n\\n\";\r\n    }\r\n    \r\n    $stmt->close();\r\n}\r\n\r\n// Ana fatura tablosunu da güncelleyelim\r\necho \"=== Ana Fatura Toplamlarını Güncelleme ===\\n\";\r\n\r\n$kdv_haric_toplam = 0;\r\n$kdv_dahil_toplam = $correct_total_kdv_dahil;\r\n\r\n// KDV dahil tutardan KDV hariç tutarı hesapla\r\n$kdv_orani = $records[0]['satisStok_kdv']; // İlk kaydın KDV oranını kullan\r\n$kdv_haric_toplam = round($kdv_dahil_toplam / (1 + $kdv_orani / 100), 2);\r\n$kdv_tutari = round($kdv_dahil_toplam - $kdv_haric_toplam, 2);\r\n\r\necho \"KDV Hariç Toplam: $kdv_haric_toplam TL\\n\";\r\necho \"KDV Tutarı: $kdv_tutari TL\\n\";\r\necho \"KDV Dahil Toplam: $kdv_dahil_toplam TL\\n\";\r\n\r\n$update_invoice_query = \"\r\n    UPDATE satisFaturasi SET \r\n        satis_araToplam = ?,\r\n        satis_kdvToplam = ?,\r\n        satis_genelToplam = ?,\r\n        satis_netTutar = ?,\r\n        satis_vergiDahilToplam = ?\r\n    WHERE satis_id = 1403\r\n\";\r\n\r\n$stmt2 = $mysqli->prepare($update_invoice_query);\r\nif ($stmt2) {\r\n    $stmt2->bind_param(\"ddddd\", $kdv_haric_toplam, $kdv_tutari, $kdv_dahil_toplam, $kdv_haric_toplam, $kdv_dahil_toplam);\r\n    \r\n    if ($stmt2->execute()) {\r\n        echo \"✓ Ana fatura toplamları güncellendi.\\n\";\r\n    } else {\r\n        echo \"✗ Ana fatura güncellenirken hata: \" . $stmt2->error . \"\\n\";\r\n    }\r\n    \r\n    $stmt2->close();\r\n}\r\n\r\necho \"\\n=== İşlem Tamamlandı ===\\n\";\r\necho \"Lütfen https://crm.ilekasoft.com/fatura/goruntule?tipi=satis&id=1403 adresini kontrol edin.\\n\";\r\n\r\n$mysqli->close();\r\n?>\r\n"
        }
    ]
}