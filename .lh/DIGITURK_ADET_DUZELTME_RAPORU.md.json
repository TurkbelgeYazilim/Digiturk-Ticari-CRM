{
    "sourceFile": "DIGITURK_ADET_DUZELTME_RAPORU.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1755697881284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755698217633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n-# DIGITURK Adet Toplam Sorunu Düzeltme Raporu\r\n+# DIGITURK ve S SPORT Adet Toplam Sorunu Düzeltme Raporu\r\n \r\n ## Sorun\r\n-`https://crm.ilekasoft.com/raporlar/digiturk-sehir-ciro-adet` sayfasındaki DIGITURK'e ait adet toplam alanı yanlış hesaplanıyor.\r\n+`https://crm.ilekasoft.com/raporlar/digiturk-sehir-ciro-adet` sayfasındaki DIGITURK ve S SPORT'e ait adet toplam alanları yanlış hesaplanıyor.\r\n \r\n ## Çözüm\r\n `application/controllers/Raporlar.php` dosyasındaki `digiturk_sehir_ciro_adet()` metodundaki SQL sorgusu düzeltildi.\r\n \r\n@@ -97,6 +97,59 @@\n ```\r\n \r\n Bizim düzeltilmiş sorgumuz bu mantığı takip ediyor, sadece tablo isimlerini CodeIgniter projesindeki doğru isimlere uyarladık.\r\n \r\n+### S SPORT Adet Hesaplama Doğrulaması\r\n+\r\n+S SPORT için zaten doğru mantık kullanılıyor:\r\n+\r\n+```sql\r\n+-- S Sport satış adedi (stok_stokGrupKoduID = 279)\r\n+COUNT(CASE \r\n+    WHEN st.stok_stokGrupKoduID = 279\r\n+    THEN 1 \r\n+    ELSE NULL \r\n+END) AS ssport_satis_adedi\r\n+```\r\n+\r\n+#### Kullanıcının Referans Sorgusu (S SPORT için):\r\n+```sql\r\n+SELECT\r\n+  COALESCE(i.il, '(Bilinmiyor)') AS Il,\r\n+  COUNT(*) AS Adet\r\n+FROM satisfaturasistok s\r\n+JOIN stok st           ON st.stok_id = s.satisStok_stokID\r\n+JOIN satisfaturasi f   ON f.satis_id = s.satisStok_satisFaturasiID\r\n+LEFT JOIN cari c       ON c.cari_id = f.satis_cariID\r\n+LEFT JOIN iller i      ON i.id = c.cari_il\r\n+WHERE st.stok_stokGrupKoduID = 279  -- S SPORT\r\n+GROUP BY COALESCE(i.id, 0), COALESCE(i.il, '(Bilinmiyor)')\r\n+ORDER BY Adet DESC;\r\n+```\r\n+\r\n+Bu sorgu mantığı, mevcut kodumuzda zaten uygulanıyor. S SPORT için `stok_stokGrupKoduID = 279` filtresi kullanılıyor ve `COUNT(CASE WHEN...)` ile her bir stok kalemi sayılıyor.\r\n+\r\n+### UI Düzeltmesi\r\n+\r\n+Ayrıca TOPLAM satırındaki hizalama sorunu da düzeltildi:\r\n+\r\n+**application/views/raporlar/digiturk-sehir-ciro-adet.php** dosyasında:\r\n+\r\n+**ÖNCEDEN:**\r\n+```html\r\n+<th colspan=\"2\" class=\"text-center\">TOPLAM:</th>\r\n+```\r\n+\r\n+**SONRA:**\r\n+```html\r\n+<th class=\"text-center\">TOPLAM:</th>\r\n+<th></th>\r\n+```\r\n+\r\n+Bu değişiklik ile TOPLAM satırı artık sütun başlıkları ile doğru şekilde hizalanıyor.\r\n+\r\n ### Sonuç\r\n-Bu değişiklik ile DIGITURK adet toplam alanı artık doğru şekilde hesaplanacak ve kullanıcının beklediği sonuçları gösterecektir.\r\n+Bu değişiklikler ile:\r\n+1. **DIGITURK adet toplam alanı** artık doğru şekilde hesaplanacak\r\n+2. **S SPORT adet toplam alanı** zaten doğru hesaplanıyor (kontrol edildi)\r\n+3. **TOPLAM satırı hizalaması** düzeltildi\r\n+4. Kullanıcının beklediği sonuçları gösterecektir.\r\n"
                }
            ],
            "date": 1755697881284,
            "name": "Commit-0",
            "content": "# DIGITURK Adet Toplam Sorunu Düzeltme Raporu\r\n\r\n## Sorun\r\n`https://crm.ilekasoft.com/raporlar/digiturk-sehir-ciro-adet` sayfasındaki DIGITURK'e ait adet toplam alanı yanlış hesaplanıyor.\r\n\r\n## Çözüm\r\n`application/controllers/Raporlar.php` dosyasındaki `digiturk_sehir_ciro_adet()` metodundaki SQL sorgusu düzeltildi.\r\n\r\n### Yapılan Değişiklikler:\r\n\r\n#### 1. Tablo Yapısının Doğrulaması\r\n- Veritabanında `satisFaturasiStok` ve `satisFaturasi` tabloları kullanılıyor\r\n- Kullanıcının verdiği örnek sorguda `satisfaturasistok` ve `satisfaturasi` tabloları belirtilmişti\r\n- Ancak CodeIgniter kodunda doğru tablo isimleri `satisFaturasiStok` ve `satisFaturasi`\r\n\r\n#### 2. SQL Sorgu Mantığının Düzeltilmesi\r\n\r\n**ÖNCEDEN (Yanlış):**\r\n```sql\r\n-- Digiturk satış adedi (stok_stokGrupKoduID = 1)\r\nCOUNT(DISTINCT CASE \r\n    WHEN s.stok_stokGrupKoduID = 1\r\n    THEN sf.satis_id \r\n    ELSE NULL \r\nEND) AS digiturk_satis_adedi\r\n```\r\n\r\n**SONRA (Doğru):**\r\n```sql\r\n-- Digiturk satış adedi (stok_stokGrupKoduID = 1) - DÜZELTME: COUNT(*) kullan\r\nCOUNT(CASE \r\n    WHEN st.stok_stokGrupKoduID = 1\r\n    THEN 1 \r\n    ELSE NULL \r\nEND) AS digiturk_satis_adedi\r\n```\r\n\r\n#### 3. FROM Clause Düzeltme\r\n\r\n**ÖNCEDEN (Karışık JOIN yapısı):**\r\n```sql\r\nFROM satisFaturasi sf\r\nJOIN cari c ON sf.satis_cariID = c.cari_id\r\nLEFT JOIN iller i ON c.cari_il = i.id\r\nLEFT JOIN satisFaturasiStok sfs ON sf.satis_id = sfs.satisStok_satisFaturasiID\r\nLEFT JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n```\r\n\r\n**SONRA (Net JOIN yapısı):**\r\n```sql\r\nFROM satisFaturasiStok s\r\nJOIN stok st ON st.stok_id = s.satisStok_stokID\r\nJOIN satisFaturasi f ON f.satis_id = s.satisStok_satisFaturasiID\r\nLEFT JOIN cari c ON c.cari_id = f.satis_cariID\r\nLEFT JOIN iller i ON i.id = c.cari_il\r\n```\r\n\r\n#### 4. GROUP BY ve ORDER BY Düzeltme\r\n\r\n**ÖNCEDEN:**\r\n```sql\r\nGROUP BY i.il, c.cari_il\r\nORDER BY toplam_ciro DESC\r\n```\r\n\r\n**SONRA:**\r\n```sql\r\nGROUP BY COALESCE(i.id, 0), COALESCE(i.il, '(Bilinmiyor)')\r\nORDER BY digiturk_satis_adedi DESC\r\n```\r\n\r\n### Ana Değişiklik Açıklaması\r\n\r\nSoruna neden olan ana faktör:\r\n\r\n1. **COUNT DISTINCT yerine COUNT kullanımı**: Önceki sorgu `COUNT(DISTINCT...)` kullanıyordu ve bu da her şehir için benzersiz fatura sayısını veriyordu. Ancak istenen adet hesaplaması için her satış kalemini saymalıyız.\r\n\r\n2. **Doğru tablo hiyerarşisi**: `satisFaturasiStok` tablosundan başlayarak, stok bilgilerini alıp, sonra fatura ve müşteri bilgilerine gitmek daha mantıklı.\r\n\r\n3. **Filtreli COUNT**: `COALESCE` kullanarak boş değerleri handle edip, sadece stok_stokGrupKoduID = 1 olanları sayıyoruz.\r\n\r\n### Kullanıcının Referans Sorgusu ile Uyumluluk\r\n\r\nKullanıcının verdiği örnek sorgu:\r\n```sql\r\nSELECT\r\n  COALESCE(i.il, '(Bilinmiyor)') AS Il,\r\n  COUNT(*) AS Adet\r\nFROM satisfaturasistok s\r\nJOIN stok st           ON st.stok_id = s.satisStok_stokID\r\nJOIN satisfaturasi f   ON f.satis_id = s.satisStok_satisFaturasiID\r\nLEFT JOIN cari c       ON c.cari_id = f.satis_cariID\r\nLEFT JOIN iller i      ON i.id = c.cari_il\r\nWHERE st.stok_stokGrupKoduID = 1  -- TURKIYE_TICARI\r\nGROUP BY COALESCE(i.id, 0), COALESCE(i.il, '(Bilinmiyor)')\r\nORDER BY Adet DESC;\r\n```\r\n\r\nBizim düzeltilmiş sorgumuz bu mantığı takip ediyor, sadece tablo isimlerini CodeIgniter projesindeki doğru isimlere uyarladık.\r\n\r\n### Sonuç\r\nBu değişiklik ile DIGITURK adet toplam alanı artık doğru şekilde hesaplanacak ve kullanıcının beklediği sonuçları gösterecektir.\r\n"
        }
    ]
}