{
    "sourceFile": "satis_gorsel_yukle_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1760450969536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1760450969536,
            "name": "Commit-0",
            "content": "<?php\r\n// Satış görselleri yükleme endpoint - Standalone\r\n\r\nheader('Content-Type: application/json; charset=utf-8');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: POST, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\n$satis_id = isset($_POST['satis_id']) ? intval($_POST['satis_id']) : 0;\r\n\r\nif (!$satis_id) {\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Satış ID bulunamadı'\r\n    ]);\r\n    exit;\r\n}\r\n\r\nif (!isset($_FILES['satis_gorseller']) || empty($_FILES['satis_gorseller']['name'][0])) {\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Dosya seçilmedi'\r\n    ]);\r\n    exit;\r\n}\r\n\r\ntry {\r\n    // Database connection\r\n    $mysqli = new mysqli('localhost', 'ilekasoft_crmuser', 'KaleW356!', 'ilekasoft_crmdb');\r\n    $mysqli->set_charset(\"utf8mb4\");\r\n    \r\n    if ($mysqli->connect_error) {\r\n        throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n    }\r\n    \r\n    // Mevcut satis_dosya değerini al\r\n    $query = \"SELECT satis_dosya FROM satisFaturasi WHERE satis_id = ?\";\r\n    $stmt = $mysqli->prepare($query);\r\n    $stmt->bind_param(\"i\", $satis_id);\r\n    $stmt->execute();\r\n    $result = $stmt->get_result();\r\n    $row = $result->fetch_assoc();\r\n    $stmt->close();\r\n    \r\n    $mevcut_dosyalar = [];\r\n    if (!empty($row['satis_dosya'])) {\r\n        $mevcut_dosyalar = array_map('trim', explode(',', $row['satis_dosya']));\r\n    }\r\n    \r\n    // Upload dizini\r\n    $upload_dir = __DIR__ . '/assets/uploads/faturalar/';\r\n    if (!is_dir($upload_dir)) {\r\n        mkdir($upload_dir, 0777, true);\r\n    }\r\n    \r\n    $yukle_count = count($_FILES['satis_gorseller']['name']);\r\n    $uploaded_files = [];\r\n    \r\n    for ($i = 0; $i < $yukle_count; $i++) {\r\n        if ($_FILES['satis_gorseller']['error'][$i] === UPLOAD_ERR_OK) {\r\n            $tmp_name = $_FILES['satis_gorseller']['tmp_name'][$i];\r\n            $file_name = $_FILES['satis_gorseller']['name'][$i];\r\n            $file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));\r\n            \r\n            // Dosya uzantısı kontrolü\r\n            $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n            if (!in_array($file_ext, $allowed_extensions)) {\r\n                continue;\r\n            }\r\n            \r\n            // Benzersiz dosya adı oluştur\r\n            $new_file_name = md5(uniqid(rand(), true)) . '.' . $file_ext;\r\n            $upload_path = $upload_dir . $new_file_name;\r\n            \r\n            if (move_uploaded_file($tmp_name, $upload_path)) {\r\n                // Veritabanı için relative path\r\n                $uploaded_files[] = 'faturalar/' . $new_file_name;\r\n            }\r\n        }\r\n    }\r\n    \r\n    if (empty($uploaded_files)) {\r\n        echo json_encode([\r\n            'success' => false,\r\n            'message' => 'Dosya yüklenemedi'\r\n        ]);\r\n        exit;\r\n    }\r\n    \r\n    // Yeni dosyaları mevcut listesine ekle\r\n    $tum_dosyalar = array_merge($mevcut_dosyalar, $uploaded_files);\r\n    $satis_dosya_str = implode(',', $tum_dosyalar);\r\n    \r\n    // Veritabanını güncelle\r\n    $update_query = \"UPDATE satisFaturasi SET satis_dosya = ? WHERE satis_id = ?\";\r\n    $update_stmt = $mysqli->prepare($update_query);\r\n    $update_stmt->bind_param(\"si\", $satis_dosya_str, $satis_id);\r\n    \r\n    if (!$update_stmt->execute()) {\r\n        throw new Exception(\"Veritabanı güncelleme hatası: \" . $update_stmt->error);\r\n    }\r\n    \r\n    $update_stmt->close();\r\n    $mysqli->close();\r\n    \r\n    echo json_encode([\r\n        'success' => true,\r\n        'message' => count($uploaded_files) . ' dosya başarıyla yüklendi',\r\n        'satis_dosya' => $satis_dosya_str,\r\n        'uploaded_files' => $uploaded_files\r\n    ]);\r\n    \r\n} catch (Exception $e) {\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Hata: ' . $e->getMessage()\r\n    ]);\r\n}\r\n?>\r\n"
        }
    ]
}