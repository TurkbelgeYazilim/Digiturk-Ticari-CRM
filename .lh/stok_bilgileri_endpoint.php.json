{
    "sourceFile": "stok_bilgileri_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 10,
            "patches": [
                {
                    "date": 1755584922759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755587228031,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,9 +14,9 @@\n \r\n // Debug table structure check\r\n if (isset($_GET['debug_table'])) {\r\n     try {\r\n-        $mysqli = new mysqli('localhost', 'ilekasoft_crmdb', 'ilekaDB*123', 'ilekasoft_crmdb');\r\n+        $mysqli = new mysqli('localhost', 'ilekasoft_crmuser', 'KaleW356!', 'ilekasoft_crmdb');\r\n         $mysqli->set_charset('utf8mb4');\r\n         \r\n         if ($mysqli->connect_error) {\r\n             throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n"
                },
                {
                    "date": 1755591503052,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,16 +21,18 @@\n         if ($mysqli->connect_error) {\r\n             throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n         }\r\n         \r\n+        $table_name = isset($_GET['table']) ? $_GET['table'] : 'satisFaturasiStok';\r\n+        \r\n         $columns = [];\r\n-        $result = $mysqli->query('DESCRIBE satisFaturasiStok');\r\n+        $result = $mysqli->query(\"DESCRIBE $table_name\");\r\n         while ($row = $result->fetch_assoc()) {\r\n             $columns[] = $row['Field'];\r\n         }\r\n         \r\n         // Get sample data\r\n-        $sample_result = $mysqli->query('SELECT * FROM satisFaturasiStok LIMIT 2');\r\n+        $sample_result = $mysqli->query(\"SELECT * FROM $table_name LIMIT 2\");\r\n         $sample_data = [];\r\n         if ($sample_result) {\r\n             while ($row = $sample_result->fetch_assoc()) {\r\n                 $sample_data[] = $row;\r\n@@ -39,8 +41,9 @@\n         \r\n         $mysqli->close();\r\n         \r\n         echo json_encode([\r\n+            'table_name' => $table_name,\r\n             'table_columns' => $columns,\r\n             'sample_data' => $sample_data\r\n         ]);\r\n         exit;\r\n"
                },
                {
                    "date": 1756562515617,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -130,9 +130,9 @@\n             sfs.satisStok_id,\r\n             sfs.satisStok_satisFaturasiID,\r\n             sfs.satisStok_stokID as stok_id,\r\n             sfs.satisStok_miktar,\r\n-            sfs.satisStok_birimFiyat,\r\n+            sfs.satisStok_fiyatMiktar,\r\n             sfs.satisStok_kdv,\r\n             COALESCE(s.stok_ad, 'Bilinmeyen Stok') as stok_adi,\r\n             s.stok_kodu\r\n         FROM satisFaturasiStok sfs\r\n"
                },
                {
                    "date": 1757332850769,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -132,8 +132,9 @@\n             sfs.satisStok_stokID as stok_id,\r\n             sfs.satisStok_miktar,\r\n             sfs.satisStok_fiyatMiktar,\r\n             sfs.satisStok_kdv,\r\n+            sfs.satisStok_kullanici_sayisi,\r\n             COALESCE(s.stok_ad, 'Bilinmeyen Stok') as stok_adi,\r\n             s.stok_kodu\r\n         FROM satisFaturasiStok sfs\r\n         LEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n"
                },
                {
                    "date": 1759744524757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -155,13 +155,142 @@\n         $data[] = $row;\r\n     }\r\n     \r\n     $stmt->close();\r\n+    \r\n+    // Tahsilat detayları sorgusu - Kullanıcının istediği sorgu\r\n+    $tahsilat_query = \"\r\n+        -- Önce cari ID değişkeni tanımla\r\n+        SET @CariID := ?;\r\n+        \r\n+        -- Rapor sorgusu\r\n+        SELECT 'Çek' AS Kalem,\r\n+               COALESCE((\r\n+                 SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(c.cek_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(c.cek_tutar, 2))\r\n+                                      ORDER BY c.cek_vadeTarih SEPARATOR ' | ')\r\n+                 FROM cek c\r\n+                 WHERE c.cek_cariID = @CariID\r\n+               ), '—') AS Detay,\r\n+               COALESCE((\r\n+                 SELECT FORMAT(SUM(c.cek_tutar), 2)\r\n+                 FROM cek c\r\n+                 WHERE c.cek_cariID = @CariID\r\n+               ), '0.00') AS Toplam\r\n+        UNION ALL\r\n+        SELECT 'Banka & Pos' AS Kalem,\r\n+               COALESCE((\r\n+                 SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(b.bh_tarih, '%Y-%m-%d'), ' / ', FORMAT(b.bh_giris, 2))\r\n+                                      ORDER BY b.bh_tarih SEPARATOR ' | ')\r\n+                 FROM bankahareketleri b\r\n+                 WHERE b.bh_cariID = @CariID\r\n+               ), '—') AS Detay,\r\n+               COALESCE((\r\n+                 SELECT FORMAT(SUM(b.bh_giris), 2)\r\n+                 FROM bankahareketleri b\r\n+                 WHERE b.bh_cariID = @CariID\r\n+               ), '0.00') AS Toplam\r\n+        UNION ALL\r\n+        SELECT 'Senet' AS Kalem,\r\n+               COALESCE((\r\n+                 SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(s.senet_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(s.senet_tutar, 2))\r\n+                                      ORDER BY s.senet_vadeTarih SEPARATOR ' | ')\r\n+                 FROM senet s\r\n+                 WHERE s.senet_cariID = @CariID\r\n+               ), '—') AS Detay,\r\n+               COALESCE((\r\n+                 SELECT FORMAT(SUM(s.senet_tutar), 2)\r\n+                 FROM senet s\r\n+                 WHERE s.senet_cariID = @CariID\r\n+               ), '0.00') AS Toplam\r\n+        UNION ALL\r\n+        SELECT 'Nakit (Kasa)' AS Kalem,\r\n+               COALESCE((\r\n+                 SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(k.kh_tarih, '%Y-%m-%d'), ' / ', FORMAT(k.kh_giris, 2))\r\n+                                      ORDER BY k.kh_tarih SEPARATOR ' | ')\r\n+                 FROM kasahareketleri k\r\n+                 WHERE k.kh_cariID = @CariID\r\n+               ), '—') AS Detay,\r\n+               COALESCE((\r\n+                 SELECT FORMAT(SUM(k.kh_giris), 2)\r\n+                 FROM kasahareketleri k\r\n+                 WHERE k.kh_cariID = @CariID\r\n+               ), '0.00') AS Toplam;\r\n+    \";\r\n+    \r\n+    // Tahsilat verilerini al\r\n+    $tahsilat_data = [];\r\n+    if ($cari_id) {\r\n+        // SET sorgusu ayrı çalıştır\r\n+        $mysqli->query(\"SET @CariID := \" . intval($cari_id));\r\n+        \r\n+        // Ana sorguyu çalıştır  \r\n+        $tahsilat_result = $mysqli->query(\"\r\n+            SELECT 'Çek' AS Kalem,\r\n+                   COALESCE((\r\n+                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(c.cek_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(c.cek_tutar, 2))\r\n+                                          ORDER BY c.cek_vadeTarih SEPARATOR ' | ')\r\n+                     FROM cek c\r\n+                     WHERE c.cek_cariID = \" . intval($cari_id) . \"\r\n+                   ), '—') AS Detay,\r\n+                   COALESCE((\r\n+                     SELECT FORMAT(SUM(c.cek_tutar), 2)\r\n+                     FROM cek c\r\n+                     WHERE c.cek_cariID = \" . intval($cari_id) . \"\r\n+                   ), '0.00') AS Toplam\r\n+            UNION ALL\r\n+            SELECT 'Banka & Pos' AS Kalem,\r\n+                   COALESCE((\r\n+                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(b.bh_tarih, '%Y-%m-%d'), ' / ', FORMAT(b.bh_giris, 2))\r\n+                                          ORDER BY b.bh_tarih SEPARATOR ' | ')\r\n+                     FROM bankahareketleri b\r\n+                     WHERE b.bh_cariID = \" . intval($cari_id) . \"\r\n+                   ), '—') AS Detay,\r\n+                   COALESCE((\r\n+                     SELECT FORMAT(SUM(b.bh_giris), 2)\r\n+                     FROM bankahareketleri b\r\n+                     WHERE b.bh_cariID = \" . intval($cari_id) . \"\r\n+                   ), '0.00') AS Toplam\r\n+            UNION ALL\r\n+            SELECT 'Senet' AS Kalem,\r\n+                   COALESCE((\r\n+                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(s.senet_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(s.senet_tutar, 2))\r\n+                                          ORDER BY s.senet_vadeTarih SEPARATOR ' | ')\r\n+                     FROM senet s\r\n+                     WHERE s.senet_cariID = \" . intval($cari_id) . \"\r\n+                   ), '—') AS Detay,\r\n+                   COALESCE((\r\n+                     SELECT FORMAT(SUM(s.senet_tutar), 2)\r\n+                     FROM senet s\r\n+                     WHERE s.senet_cariID = \" . intval($cari_id) . \"\r\n+                   ), '0.00') AS Toplam\r\n+            UNION ALL\r\n+            SELECT 'Nakit (Kasa)' AS Kalem,\r\n+                   COALESCE((\r\n+                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(k.kh_tarih, '%Y-%m-%d'), ' / ', FORMAT(k.kh_giris, 2))\r\n+                                          ORDER BY k.kh_tarih SEPARATOR ' | ')\r\n+                     FROM kasahareketleri k\r\n+                     WHERE k.kh_cariID = \" . intval($cari_id) . \"\r\n+                   ), '—') AS Detay,\r\n+                   COALESCE((\r\n+                     SELECT FORMAT(SUM(k.kh_giris), 2)\r\n+                     FROM kasahareketleri k\r\n+                     WHERE k.kh_cariID = \" . intval($cari_id) . \"\r\n+                   ), '0.00') AS Toplam\r\n+        \");\r\n+        \r\n+        if ($tahsilat_result) {\r\n+            while ($row = $tahsilat_result->fetch_assoc()) {\r\n+                $tahsilat_data[] = $row;\r\n+            }\r\n+        }\r\n+    }\r\n+    \r\n     $mysqli->close();\r\n     \r\n     echo json_encode([\r\n         'success' => true,\r\n-        'data' => $data\r\n+        'data' => $data,\r\n+        'tahsilat_data' => $tahsilat_data\r\n     ]);\r\n     \r\n } catch (Exception $e) {\r\n     echo json_encode([\r\n"
                },
                {
                    "date": 1759843133581,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -221,61 +221,105 @@\n     if ($cari_id) {\r\n         // SET sorgusu ayrı çalıştır\r\n         $mysqli->query(\"SET @CariID := \" . intval($cari_id));\r\n         \r\n-        // Ana sorguyu çalıştır  \r\n+        // Ana sorguyu çalıştır - onay durumu ile birlikte\r\n         $tahsilat_result = $mysqli->query(\"\r\n-            SELECT 'Çek' AS Kalem,\r\n-                   COALESCE((\r\n-                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(c.cek_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(c.cek_tutar, 2))\r\n-                                          ORDER BY c.cek_vadeTarih SEPARATOR ' | ')\r\n-                     FROM cek c\r\n-                     WHERE c.cek_cariID = \" . intval($cari_id) . \"\r\n-                   ), '—') AS Detay,\r\n-                   COALESCE((\r\n-                     SELECT FORMAT(SUM(c.cek_tutar), 2)\r\n-                     FROM cek c\r\n-                     WHERE c.cek_cariID = \" . intval($cari_id) . \"\r\n-                   ), '0.00') AS Toplam\r\n+            SELECT \r\n+                'Çek' AS Kalem,\r\n+                COALESCE((\r\n+                    SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(c.cek_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(c.cek_tutar, 2))\r\n+                                         ORDER BY c.cek_vadeTarih SEPARATOR ' | ')\r\n+                    FROM cek c\r\n+                    WHERE c.cek_cariID = \" . intval($cari_id) . \"\r\n+                ), '—') AS Detay,\r\n+                COALESCE((\r\n+                    SELECT FORMAT(SUM(c.cek_tutar), 2)\r\n+                    FROM cek c\r\n+                    WHERE c.cek_cariID = \" . intval($cari_id) . \"\r\n+                ), '0.00') AS Toplam,\r\n+                'cek_group' as unique_id,\r\n+                '2' as tip_kod,\r\n+                COALESCE((\r\n+                    SELECT mtd.onay_durumu \r\n+                    FROM muhasebe_tahsilat_durum mtd \r\n+                    WHERE mtd.tahsilat_tipi = 2 \r\n+                    AND mtd.kayit_id IN (SELECT c.cek_id FROM cek c WHERE c.cek_cariID = \" . intval($cari_id) . \") \r\n+                    AND mtd.onay_durumu = 1 \r\n+                    LIMIT 1\r\n+                ), 0) as onay_durumu\r\n             UNION ALL\r\n-            SELECT 'Banka & Pos' AS Kalem,\r\n-                   COALESCE((\r\n-                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(b.bh_tarih, '%Y-%m-%d'), ' / ', FORMAT(b.bh_giris, 2))\r\n-                                          ORDER BY b.bh_tarih SEPARATOR ' | ')\r\n-                     FROM bankahareketleri b\r\n-                     WHERE b.bh_cariID = \" . intval($cari_id) . \"\r\n-                   ), '—') AS Detay,\r\n-                   COALESCE((\r\n-                     SELECT FORMAT(SUM(b.bh_giris), 2)\r\n-                     FROM bankahareketleri b\r\n-                     WHERE b.bh_cariID = \" . intval($cari_id) . \"\r\n-                   ), '0.00') AS Toplam\r\n+            SELECT \r\n+                'Banka & Pos' AS Kalem,\r\n+                COALESCE((\r\n+                    SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(b.bh_tarih, '%Y-%m-%d'), ' / ', FORMAT(b.bh_giris, 2))\r\n+                                         ORDER BY b.bh_tarih SEPARATOR ' | ')\r\n+                    FROM bankahareketleri b\r\n+                    WHERE b.bh_cariID = \" . intval($cari_id) . \"\r\n+                ), '—') AS Detay,\r\n+                COALESCE((\r\n+                    SELECT FORMAT(SUM(b.bh_giris), 2)\r\n+                    FROM bankahareketleri b\r\n+                    WHERE b.bh_cariID = \" . intval($cari_id) . \"\r\n+                ), '0.00') AS Toplam,\r\n+                'bh_group' as unique_id,\r\n+                '1' as tip_kod,\r\n+                COALESCE((\r\n+                    SELECT mtd.onay_durumu \r\n+                    FROM muhasebe_tahsilat_durum mtd \r\n+                    WHERE mtd.tahsilat_tipi = 1 \r\n+                    AND mtd.kayit_id IN (SELECT b.bh_id FROM bankahareketleri b WHERE b.bh_cariID = \" . intval($cari_id) . \") \r\n+                    AND mtd.onay_durumu = 1 \r\n+                    LIMIT 1\r\n+                ), 0) as onay_durumu\r\n             UNION ALL\r\n-            SELECT 'Senet' AS Kalem,\r\n-                   COALESCE((\r\n-                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(s.senet_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(s.senet_tutar, 2))\r\n-                                          ORDER BY s.senet_vadeTarih SEPARATOR ' | ')\r\n-                     FROM senet s\r\n-                     WHERE s.senet_cariID = \" . intval($cari_id) . \"\r\n-                   ), '—') AS Detay,\r\n-                   COALESCE((\r\n-                     SELECT FORMAT(SUM(s.senet_tutar), 2)\r\n-                     FROM senet s\r\n-                     WHERE s.senet_cariID = \" . intval($cari_id) . \"\r\n-                   ), '0.00') AS Toplam\r\n+            SELECT \r\n+                'Senet' AS Kalem,\r\n+                COALESCE((\r\n+                    SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(s.senet_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(s.senet_tutar, 2))\r\n+                                         ORDER BY s.senet_vadeTarih SEPARATOR ' | ')\r\n+                    FROM senet s\r\n+                    WHERE s.senet_cariID = \" . intval($cari_id) . \"\r\n+                ), '—') AS Detay,\r\n+                COALESCE((\r\n+                    SELECT FORMAT(SUM(s.senet_tutar), 2)\r\n+                    FROM senet s\r\n+                    WHERE s.senet_cariID = \" . intval($cari_id) . \"\r\n+                ), '0.00') AS Toplam,\r\n+                's_group' as unique_id,\r\n+                '4' as tip_kod,\r\n+                COALESCE((\r\n+                    SELECT mtd.onay_durumu \r\n+                    FROM muhasebe_tahsilat_durum mtd \r\n+                    WHERE mtd.tahsilat_tipi = 4 \r\n+                    AND mtd.kayit_id IN (SELECT s.senet_id FROM senet s WHERE s.senet_cariID = \" . intval($cari_id) . \") \r\n+                    AND mtd.onay_durumu = 1 \r\n+                    LIMIT 1\r\n+                ), 0) as onay_durumu\r\n             UNION ALL\r\n-            SELECT 'Nakit (Kasa)' AS Kalem,\r\n-                   COALESCE((\r\n-                     SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(k.kh_tarih, '%Y-%m-%d'), ' / ', FORMAT(k.kh_giris, 2))\r\n-                                          ORDER BY k.kh_tarih SEPARATOR ' | ')\r\n-                     FROM kasahareketleri k\r\n-                     WHERE k.kh_cariID = \" . intval($cari_id) . \"\r\n-                   ), '—') AS Detay,\r\n-                   COALESCE((\r\n-                     SELECT FORMAT(SUM(k.kh_giris), 2)\r\n-                     FROM kasahareketleri k\r\n-                     WHERE k.kh_cariID = \" . intval($cari_id) . \"\r\n-                   ), '0.00') AS Toplam\r\n+            SELECT \r\n+                'Nakit (Kasa)' AS Kalem,\r\n+                COALESCE((\r\n+                    SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(k.kh_tarih, '%Y-%m-%d'), ' / ', FORMAT(k.kh_giris, 2))\r\n+                                         ORDER BY k.kh_tarih SEPARATOR ' | ')\r\n+                    FROM kasahareketleri k\r\n+                    WHERE k.kh_cariID = \" . intval($cari_id) . \"\r\n+                ), '—') AS Detay,\r\n+                COALESCE((\r\n+                    SELECT FORMAT(SUM(k.kh_giris), 2)\r\n+                    FROM kasahareketleri k\r\n+                    WHERE k.kh_cariID = \" . intval($cari_id) . \"\r\n+                ), '0.00') AS Toplam,\r\n+                'kh_group' as unique_id,\r\n+                '3' as tip_kod,\r\n+                COALESCE((\r\n+                    SELECT mtd.onay_durumu \r\n+                    FROM muhasebe_tahsilat_durum mtd \r\n+                    WHERE mtd.tahsilat_tipi = 3 \r\n+                    AND mtd.kayit_id IN (SELECT k.kh_id FROM kasahareketleri k WHERE k.kh_cariID = \" . intval($cari_id) . \") \r\n+                    AND mtd.onay_durumu = 1 \r\n+                    LIMIT 1\r\n+                ), 0) as onay_durumu\r\n         \");\r\n         \r\n         if ($tahsilat_result) {\r\n             while ($row = $tahsilat_result->fetch_assoc()) {\r\n"
                },
                {
                    "date": 1760449972172,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -132,9 +132,9 @@\n             sfs.satisStok_stokID as stok_id,\r\n             sfs.satisStok_miktar,\r\n             sfs.satisStok_fiyatMiktar,\r\n             sfs.satisStok_kdv,\r\n-            sfs.satisStok_kullanici_sayisi,\r\n+            sfs.satisStok_abonelikBitisTarihi,\r\n             COALESCE(s.stok_ad, 'Bilinmeyen Stok') as stok_adi,\r\n             s.stok_kodu\r\n         FROM satisFaturasiStok sfs\r\n         LEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n"
                },
                {
                    "date": 1760450260695,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -327,14 +327,27 @@\n             }\r\n         }\r\n     }\r\n     \r\n+    // Satis faturası bilgilerini al\r\n+    $satis_info = null;\r\n+    if ($satis_id) {\r\n+        $satis_query = \"SELECT satis_faturaTarihi, satis_faturaNo, satis_aciklama FROM satisFaturasi WHERE satis_id = ?\";\r\n+        $satis_stmt = $mysqli->prepare($satis_query);\r\n+        $satis_stmt->bind_param(\"i\", $satis_id);\r\n+        $satis_stmt->execute();\r\n+        $satis_result = $satis_stmt->get_result();\r\n+        $satis_info = $satis_result->fetch_assoc();\r\n+        $satis_stmt->close();\r\n+    }\r\n+    \r\n     $mysqli->close();\r\n     \r\n     echo json_encode([\r\n         'success' => true,\r\n         'data' => $data,\r\n-        'tahsilat_data' => $tahsilat_data\r\n+        'tahsilat_data' => $tahsilat_data,\r\n+        'satis_info' => $satis_info\r\n     ]);\r\n     \r\n } catch (Exception $e) {\r\n     echo json_encode([\r\n"
                },
                {
                    "date": 1760450969464,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -330,9 +330,9 @@\n     \r\n     // Satis faturası bilgilerini al\r\n     $satis_info = null;\r\n     if ($satis_id) {\r\n-        $satis_query = \"SELECT satis_faturaTarihi, satis_faturaNo, satis_aciklama FROM satisFaturasi WHERE satis_id = ?\";\r\n+        $satis_query = \"SELECT satis_faturaTarihi, satis_faturaNo, satis_aciklama, satis_dosya FROM satisFaturasi WHERE satis_id = ?\";\r\n         $satis_stmt = $mysqli->prepare($satis_query);\r\n         $satis_stmt->bind_param(\"i\", $satis_id);\r\n         $satis_stmt->execute();\r\n         $satis_result = $satis_stmt->get_result();\r\n"
                },
                {
                    "date": 1760451302422,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,12 +72,13 @@\n error_log(\"DEBUG: POST data: \" . print_r($_POST, true));\r\n error_log(\"DEBUG: Raw POST: \" . $raw_post);\r\n error_log(\"DEBUG: Parsed POST: \" . print_r($post_data, true));\r\n \r\n-if (!$satis_id) {\r\n+// satis_id null ise hata, ama 0 olabilir (yeni kayıt için)\r\n+if ($satis_id === null || $satis_id === '') {\r\n     // Debug: mevcut satış ID'leri göster\r\n     try {\r\n-        $mysqli = new mysqli($host, $username, $password, $dbname);\r\n+        $mysqli = new mysqli('localhost', 'ilekasoft_crmuser', 'KaleW356!', 'ilekasoft_crmdb');\r\n         $mysqli->set_charset(\"utf8mb4\");\r\n         \r\n         $sample_query = \"SELECT DISTINCT satisStok_satisFaturasiID FROM satisFaturasiStok LIMIT 10\";\r\n         $sample_result = $mysqli->query($sample_query);\r\n@@ -123,41 +124,45 @@\n     if ($mysqli->connect_error) {\r\n         throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n     }\r\n     \r\n-    // Simplified query with only existing columns\r\n-    $query = \"\r\n-        SELECT \r\n-            sfs.satisStok_id,\r\n-            sfs.satisStok_satisFaturasiID,\r\n-            sfs.satisStok_stokID as stok_id,\r\n-            sfs.satisStok_miktar,\r\n-            sfs.satisStok_fiyatMiktar,\r\n-            sfs.satisStok_kdv,\r\n-            sfs.satisStok_abonelikBitisTarihi,\r\n-            COALESCE(s.stok_ad, 'Bilinmeyen Stok') as stok_adi,\r\n-            s.stok_kodu\r\n-        FROM satisFaturasiStok sfs\r\n-        LEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n-        WHERE sfs.satisStok_satisFaturasiID = ?\r\n-        ORDER BY sfs.satisStok_id ASC\";\r\n+    // Yeni kayıt için (satis_id = 0) boş array döndür\r\n+    $data = [];\r\n     \r\n-    $stmt = $mysqli->prepare($query);\r\n-    if (!$stmt) {\r\n-        throw new Exception(\"Prepare failed: \" . $mysqli->error);\r\n+    if ($satis_id > 0) {\r\n+        // Simplified query with only existing columns\r\n+        $query = \"\r\n+            SELECT \r\n+                sfs.satisStok_id,\r\n+                sfs.satisStok_satisFaturasiID,\r\n+                sfs.satisStok_stokID as stok_id,\r\n+                sfs.satisStok_miktar,\r\n+                sfs.satisStok_fiyatMiktar,\r\n+                sfs.satisStok_kdv,\r\n+                sfs.satisStok_abonelikBitisTarihi,\r\n+                COALESCE(s.stok_ad, 'Bilinmeyen Stok') as stok_adi,\r\n+                s.stok_kodu\r\n+            FROM satisFaturasiStok sfs\r\n+            LEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n+            WHERE sfs.satisStok_satisFaturasiID = ?\r\n+            ORDER BY sfs.satisStok_id ASC\";\r\n+        \r\n+        $stmt = $mysqli->prepare($query);\r\n+        if (!$stmt) {\r\n+            throw new Exception(\"Prepare failed: \" . $mysqli->error);\r\n+        }\r\n+        \r\n+        $stmt->bind_param(\"i\", $satis_id);\r\n+        $stmt->execute();\r\n+        \r\n+        $result = $stmt->get_result();\r\n+        while ($row = $result->fetch_assoc()) {\r\n+            $data[] = $row;\r\n+        }\r\n+        \r\n+        $stmt->close();\r\n     }\r\n     \r\n-    $stmt->bind_param(\"i\", $satis_id);\r\n-    $stmt->execute();\r\n-    \r\n-    $result = $stmt->get_result();\r\n-    $data = [];\r\n-    while ($row = $result->fetch_assoc()) {\r\n-        $data[] = $row;\r\n-    }\r\n-    \r\n-    $stmt->close();\r\n-    \r\n     // Tahsilat detayları sorgusu - Kullanıcının istediği sorgu\r\n     $tahsilat_query = \"\r\n         -- Önce cari ID değişkeni tanımla\r\n         SET @CariID := ?;\r\n@@ -329,9 +334,9 @@\n     }\r\n     \r\n     // Satis faturası bilgilerini al\r\n     $satis_info = null;\r\n-    if ($satis_id) {\r\n+    if ($satis_id > 0) {\r\n         $satis_query = \"SELECT satis_faturaTarihi, satis_faturaNo, satis_aciklama, satis_dosya FROM satisFaturasi WHERE satis_id = ?\";\r\n         $satis_stmt = $mysqli->prepare($satis_query);\r\n         $satis_stmt->bind_param(\"i\", $satis_id);\r\n         $satis_stmt->execute();\r\n"
                }
            ],
            "date": 1755584922759,
            "name": "Commit-0",
            "content": "<?php\r\n// Stok bilgileri endpoint - Standalone\r\n// Manual database connection - CodeIgniter bypass\r\n\r\nheader('Content-Type: application/json');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: POST, GET, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\n// Debug table structure check\r\nif (isset($_GET['debug_table'])) {\r\n    try {\r\n        $mysqli = new mysqli('localhost', 'ilekasoft_crmdb', 'ilekaDB*123', 'ilekasoft_crmdb');\r\n        $mysqli->set_charset('utf8mb4');\r\n        \r\n        if ($mysqli->connect_error) {\r\n            throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n        }\r\n        \r\n        $columns = [];\r\n        $result = $mysqli->query('DESCRIBE satisFaturasiStok');\r\n        while ($row = $result->fetch_assoc()) {\r\n            $columns[] = $row['Field'];\r\n        }\r\n        \r\n        // Get sample data\r\n        $sample_result = $mysqli->query('SELECT * FROM satisFaturasiStok LIMIT 2');\r\n        $sample_data = [];\r\n        if ($sample_result) {\r\n            while ($row = $sample_result->fetch_assoc()) {\r\n                $sample_data[] = $row;\r\n            }\r\n        }\r\n        \r\n        $mysqli->close();\r\n        \r\n        echo json_encode([\r\n            'table_columns' => $columns,\r\n            'sample_data' => $sample_data\r\n        ]);\r\n        exit;\r\n    } catch (Exception $e) {\r\n        echo json_encode(['error' => $e->getMessage()]);\r\n        exit;\r\n    }\r\n}\r\n\r\n// POST verilerini al\r\n$raw_post = file_get_contents('php://input');\r\nparse_str($raw_post, $post_data);\r\n\r\n$satis_id = isset($_POST['satis_id']) ? $_POST['satis_id'] : (\r\n    isset($post_data['satis_id']) ? $post_data['satis_id'] : (\r\n        isset($_GET['satis_id']) ? $_GET['satis_id'] : null\r\n    )\r\n);\r\n$cari_id = isset($_POST['cari_id']) ? $_POST['cari_id'] : (\r\n    isset($post_data['cari_id']) ? $post_data['cari_id'] : (\r\n        isset($_GET['cari_id']) ? $_GET['cari_id'] : null\r\n    )\r\n);\r\n\r\nerror_log(\"DEBUG: stok_bilgileri_endpoint called with satis_id: $satis_id, cari_id: $cari_id\");\r\nerror_log(\"DEBUG: POST data: \" . print_r($_POST, true));\r\nerror_log(\"DEBUG: Raw POST: \" . $raw_post);\r\nerror_log(\"DEBUG: Parsed POST: \" . print_r($post_data, true));\r\n\r\nif (!$satis_id) {\r\n    // Debug: mevcut satış ID'leri göster\r\n    try {\r\n        $mysqli = new mysqli($host, $username, $password, $dbname);\r\n        $mysqli->set_charset(\"utf8mb4\");\r\n        \r\n        $sample_query = \"SELECT DISTINCT satisStok_satisFaturasiID FROM satisFaturasiStok LIMIT 10\";\r\n        $sample_result = $mysqli->query($sample_query);\r\n        $sample_ids = [];\r\n        if ($sample_result) {\r\n            while ($row = $sample_result->fetch_assoc()) {\r\n                $sample_ids[] = $row['satisStok_satisFaturasiID'];\r\n            }\r\n        }\r\n        $mysqli->close();\r\n    } catch (Exception $e) {\r\n        $sample_ids = ['error' => $e->getMessage()];\r\n    }\r\n    \r\n    echo json_encode([\r\n        'success' => false, \r\n        'message' => 'Satış ID bilgisi eksik',\r\n        'debug' => [\r\n            'post' => $_POST,\r\n            'raw_post' => $raw_post,\r\n            'parsed_post' => $post_data,\r\n            'get' => $_GET,\r\n            'server_method' => $_SERVER['REQUEST_METHOD'],\r\n            'sample_satis_ids' => $sample_ids\r\n        ]\r\n    ]);\r\n    exit;\r\n}\r\n\r\ntry {\r\n    // Database config\r\n    $host = 'localhost';\r\n    $dbname = 'ilekasoft_crmdb';\r\n    $username = 'ilekasoft_crmuser';\r\n    $password = 'KaleW356!';\r\n    \r\n    // MySQLi connection\r\n    $mysqli = new mysqli($host, $username, $password, $dbname);\r\n    \r\n    // Set charset\r\n    $mysqli->set_charset(\"utf8mb4\");\r\n    \r\n    if ($mysqli->connect_error) {\r\n        throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n    }\r\n    \r\n    // Simplified query with only existing columns\r\n    $query = \"\r\n        SELECT \r\n            sfs.satisStok_id,\r\n            sfs.satisStok_satisFaturasiID,\r\n            sfs.satisStok_stokID as stok_id,\r\n            sfs.satisStok_miktar,\r\n            sfs.satisStok_birimFiyat,\r\n            sfs.satisStok_kdv,\r\n            COALESCE(s.stok_ad, 'Bilinmeyen Stok') as stok_adi,\r\n            s.stok_kodu\r\n        FROM satisFaturasiStok sfs\r\n        LEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n        WHERE sfs.satisStok_satisFaturasiID = ?\r\n        ORDER BY sfs.satisStok_id ASC\";\r\n    \r\n    $stmt = $mysqli->prepare($query);\r\n    if (!$stmt) {\r\n        throw new Exception(\"Prepare failed: \" . $mysqli->error);\r\n    }\r\n    \r\n    $stmt->bind_param(\"i\", $satis_id);\r\n    $stmt->execute();\r\n    \r\n    $result = $stmt->get_result();\r\n    $data = [];\r\n    while ($row = $result->fetch_assoc()) {\r\n        $data[] = $row;\r\n    }\r\n    \r\n    $stmt->close();\r\n    $mysqli->close();\r\n    \r\n    echo json_encode([\r\n        'success' => true,\r\n        'data' => $data\r\n    ]);\r\n    \r\n} catch (Exception $e) {\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Database error: ' . $e->getMessage(),\r\n        'debug' => [\r\n            'satis_id' => $satis_id,\r\n            'cari_id' => $cari_id,\r\n            'error' => $e->getMessage()\r\n        ]\r\n    ]);\r\n}\r\n?>\r\n"
        }
    ]
}