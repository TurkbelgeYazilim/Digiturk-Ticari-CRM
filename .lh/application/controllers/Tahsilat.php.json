{
    "sourceFile": "application/controllers/Tahsilat.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1754924666052,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755152586369,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -336,11 +336,29 @@\n                 'ch_olusturmaTarihi' => date('Y-m-d'),\r\n                 'ch_olusturmaSaati' => date('H:i:s')\r\n             ];\r\n             \r\n-            // Check if cariHareketleri table exists\r\n-            if ($this->db->table_exists('cariHareketleri')) {\r\n-                $this->db->insert('cariHareketleri', $cari_data);\r\n+            // Insert into cariHareketleri using raw SQL (consistent with other controllers)\r\n+            $ch_cariID = $cari_data['ch_cariID'];\r\n+            $ch_tarih = $cari_data['ch_tarih'];\r\n+            $ch_alacak = $cari_data['ch_alacak'];\r\n+            $ch_turu = $cari_data['ch_turu'];\r\n+            $ch_aciklama = $cari_data['ch_aciklama'];\r\n+            $ch_belgeNumarasi = $cari_data['ch_belgeNumarasi'];\r\n+            $ch_olusturan = $cari_data['ch_olusturan'];\r\n+            $ch_olusturanAnaHesap = $cari_data['ch_olusturanAnaHesap'];\r\n+            $ch_olusturmaTarihi = $cari_data['ch_olusturmaTarihi'];\r\n+            $ch_olusturmaSaati = $cari_data['ch_olusturmaSaati'];\r\n+            \r\n+            $cari_sql = \"INSERT INTO cariHareketleri (ch_belgeNumarasi, ch_turu, ch_cariID, ch_paraBirimi, ch_alacak, ch_tarih, ch_aciklama, ch_olusturan, ch_olusturanAnaHesap, ch_olusturmaTarihi, ch_olusturmaSaati) VALUES ('$ch_belgeNumarasi', $ch_turu, $ch_cariID, 'TL', $ch_alacak, '$ch_tarih', '$ch_aciklama', '$ch_olusturan', '$ch_olusturanAnaHesap', '$ch_olusturmaTarihi', '$ch_olusturmaSaati')\";\r\n+            \r\n+            $cari_insert_result = $this->db->query($cari_sql);\r\n+            if (!$cari_insert_result) {\r\n+                error_log(\"TAHSILAT DEBUG: cariHareketleri insert failed with SQL: \" . $cari_sql);\r\n+                $db_error = $this->db->error();\r\n+                error_log(\"TAHSILAT DEBUG: Database error: \" . json_encode($db_error));\r\n+            } else {\r\n+                error_log(\"TAHSILAT DEBUG: cariHareketleri insert successful\");\r\n             }\r\n \r\n             $this->db->trans_complete();            if ($this->db->trans_status() === FALSE) {\r\n                 if ($tahsilat_odemeTipi == 3) {\r\n"
                },
                {
                    "date": 1755342118309,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -943,9 +943,9 @@\n                 case 2: // Çek\r\n                     $table = 'cek'; $id_field = 'cek_id'; $tutar_field = 'cek_tutar'; $aciklama_field = 'cek_notAciklama'; $gorsel_field = 'cek_gorsel'; $gorsel_path = './assets/uploads/cekler/';\r\n                     break;\r\n                 case 3: // Kasa\r\n-                    $table = 'kasaHareketleri'; $id_field = 'kh_id'; $tutar_field = 'kh_giris'; $aciklama_field = 'kh_aciklama'; $gorsel_field = 'kh_gorsel'; $gorsel_path = './assets/uploads/dekontlar/';\r\n+                    $table = 'kasahareketleri'; $id_field = 'kh_id'; $tutar_field = 'kh_giris'; $aciklama_field = 'kh_aciklama'; $gorsel_field = 'kh_gorsel'; $gorsel_path = './assets/uploads/dekontlar/';\r\n                     break;\r\n                 case 4: // Senet\r\n                     $table = 'senet'; $id_field = 'senet_id'; $tutar_field = 'senet_tutar'; $aciklama_field = 'senet_notAciklama'; $gorsel_field = 'senet_gorsel'; $gorsel_path = './assets/uploads/senetler/';\r\n                     break;\r\n@@ -1022,13 +1022,23 @@\n             \r\n             $this->db->where($id_field, $id)->update($table, $update);\r\n \r\n             if ($this->db->affected_rows() > 0) {\r\n-                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Başarılı\\n\", FILE_APPEND);\r\n+                // Ana tablo güncellendikten sonra carihareketleri tablosunu da güncelle\r\n+                $this->updateCariHareketleri($tip, $id, $tutar);\r\n+                \r\n+                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Başarılı, Response: OK\\n\", FILE_APPEND);\r\n                 echo 'OK';\r\n             } else {\r\n-                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Etkilenen satır yok\\n\", FILE_APPEND);\r\n-                echo 'ERROR';\r\n+                // Kayıt bulunamadı detayları\r\n+                $check_record = $this->db->get_where($table, [$id_field => $id])->row();\r\n+                if ($check_record) {\r\n+                    file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Kayıt var ama güncelleme yapılmadı. Response: ERROR_NO_UPDATE\\n\", FILE_APPEND);\r\n+                    echo 'ERROR_NO_UPDATE';\r\n+                } else {\r\n+                    file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Kayıt bulunamadı: $table tablosunda $id_field = $id. Response: ERROR_NOT_FOUND\\n\", FILE_APPEND);\r\n+                    echo 'ERROR_NOT_FOUND';\r\n+                }\r\n             }\r\n         } catch (Exception $e) {\r\n             file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Exception: \" . $e->getMessage() . \"\\n\", FILE_APPEND);\r\n             echo 'ERROR: ' . $e->getMessage();\r\n@@ -1039,8 +1049,83 @@\n         exit;\r\n     }\r\n     \r\n     /**\r\n+     * CariHareketleri tablosunu güncelle\r\n+     */\r\n+    private function updateCariHareketleri($tip, $id, $tutar) {\r\n+        try {\r\n+            $ch_field = '';\r\n+            $source_table = '';\r\n+            \r\n+            // Tip'e göre carihareketleri tablosundaki foreign key alanını ve kaynak tabloyu belirle\r\n+            switch ($tip) {\r\n+                case 1: // Banka\r\n+                    $ch_field = 'ch_bankaID';\r\n+                    $source_table = 'bankaHareketleri';\r\n+                    $source_id_field = 'bh_id';\r\n+                    $source_belge_field = 'bh_belgeNumarasi';\r\n+                    break;\r\n+                case 2: // Çek\r\n+                    $ch_field = 'ch_cekID';\r\n+                    $source_table = 'cek';\r\n+                    $source_id_field = 'cek_id';\r\n+                    $source_belge_field = 'cek_belgeNumarasi';\r\n+                    break;\r\n+                case 3: // Kasa\r\n+                    $ch_field = 'ch_khID';\r\n+                    $source_table = 'kasahareketleri';\r\n+                    $source_id_field = 'kh_id';\r\n+                    $source_belge_field = 'kh_belgeNumarasi';\r\n+                    break;\r\n+                case 4: // Senet\r\n+                    $ch_field = 'ch_senetID';\r\n+                    $source_table = 'senet';\r\n+                    $source_id_field = 'senet_id';\r\n+                    $source_belge_field = 'senet_belgeNumarasi';\r\n+                    break;\r\n+                default:\r\n+                    file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - CariHareketleri güncelleme: Geçersiz tip: $tip\\n\", FILE_APPEND);\r\n+                    return;\r\n+            }\r\n+            \r\n+            // Önce foreign key ile eşleşen kayıtları güncellemeyi dene\r\n+            $update_data = [\r\n+                'ch_alacak' => $tutar\r\n+            ];\r\n+            \r\n+            $this->db->where($ch_field, $id)->update('carihareketleri', $update_data);\r\n+            $affected_rows = $this->db->affected_rows();\r\n+            \r\n+            // Eğer foreign key ile eşleşme yoksa, belge numarasına göre eşleştirmeyi dene\r\n+            if ($affected_rows == 0) {\r\n+                // Kaynak tablodan belge numarasını al\r\n+                $source_record = $this->db->get_where($source_table, [$source_id_field => $id])->row();\r\n+                \r\n+                if ($source_record && !empty($source_record->$source_belge_field)) {\r\n+                    // Belge numarasına göre carihareketleri tablosunu güncelle\r\n+                    $this->db->where('ch_belgeNumarasi', $source_record->$source_belge_field);\r\n+                    $this->db->update('carihareketleri', $update_data);\r\n+                    $affected_rows = $this->db->affected_rows();\r\n+                    \r\n+                    // Aynı zamanda ch_khID alanını da güncelle\r\n+                    if ($affected_rows > 0) {\r\n+                        $this->db->where('ch_belgeNumarasi', $source_record->$source_belge_field);\r\n+                        $this->db->update('carihareketleri', [$ch_field => $id]);\r\n+                        \r\n+                        file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - CariHareketleri belge numarasına göre güncellendi: $affected_rows satır. Belge: {$source_record->$source_belge_field}, $ch_field = $id ayarlandı\\n\", FILE_APPEND);\r\n+                    }\r\n+                }\r\n+            }\r\n+            \r\n+            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - CariHareketleri güncelleme: $affected_rows satır güncellendi. Field: $ch_field, ID: $id, Tutar: $tutar\\n\", FILE_APPEND);\r\n+            \r\n+        } catch (Exception $e) {\r\n+            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - CariHareketleri güncelleme hatası: \" . $e->getMessage() . \"\\n\", FILE_APPEND);\r\n+        }\r\n+    }\r\n+    \r\n+    /**\r\n      * Ödeme tipi metni döndür\r\n      */\r\n     private function getOdemeTipiText($tip) {\r\n         switch($tip) {\r\n"
                },
                {
                    "date": 1756214554953,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -914,9 +914,9 @@\n             if (!function_exists('grup_modul_yetkisi_var')) {\r\n                 echo 'FUNC_ERROR'; exit;\r\n             }\r\n             \r\n-            if (!grup_modul_yetkisi_var(511)) {\r\n+            if (!grup_modul_yetkisi_var(511, 3)) {\r\n                 echo 'NO_AUTH'; exit;\r\n             }\r\n \r\n             $tip = $this->input->post('tip');\r\n"
                },
                {
                    "date": 1757162119156,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,15 @@\n \r\n class Tahsilat extends CI_Controller {\r\n     public function __construct() {\r\n         parent::__construct();\r\n+        error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n         $this->load->model('vt');\r\n+        $this->load->database();\r\n+        $this->load->library('session');\r\n+        $this->load->helper('general');\r\n+        $this->load->helper('url');\r\n+        \r\n         // Giriş kontrolü (örnek)\r\n         $control = session('r', 'login');\r\n         if (!$control) {\r\n             redirect('check');\r\n@@ -135,26 +141,32 @@\n                     'kh_olusturmaTarihi' => date('Y-m-d'),\r\n                     'kh_olusturmaSaati' => date('H:i:s')\r\n                 ];\r\n                 $this->db->insert('kasaHareketleri', $kasa_data);            } elseif ($tahsilat_odemeTipi == 2) { // Banka / POS\r\n-                // Banka dosya yükleme işlemi\r\n+                // Banka dosya yükleme işlemi - Manual upload without CodeIgniter Upload library\r\n                 $uploaded_file_name = null;\r\n                 if (isset($_FILES['banka_gorsel']) && !empty($_FILES['banka_gorsel']['name'])) {\r\n-                    $config['upload_path'] = './assets/uploads/dekontlar/';\r\n-                    $config['allowed_types'] = 'gif|jpg|png|jpeg|pdf';\r\n-                    $config['max_size'] = 5120; // 5MB\r\n-                    $config['encrypt_name'] = TRUE;\r\n+                    $upload_path = './assets/uploads/dekontlar/';\r\n+                    $allowed_types = array('gif', 'jpg', 'png', 'jpeg', 'pdf');\r\n+                    $max_size = 5120000; // 5MB in bytes\r\n                     \r\n                     // Upload dizinini kontrol et ve yoksa oluştur\r\n-                    if (!is_dir($config['upload_path'])) {\r\n-                        mkdir($config['upload_path'], 0755, true);\r\n+                    if (!is_dir($upload_path)) {\r\n+                        mkdir($upload_path, 0755, true);\r\n                     }\r\n                     \r\n-                    $this->load->library('upload', $config);\r\n+                    $file_info = pathinfo($_FILES['banka_gorsel']['name']);\r\n+                    $file_ext = strtolower($file_info['extension']);\r\n                     \r\n-                    if ($this->upload->do_upload('banka_gorsel')) {\r\n-                        $upload_data = $this->upload->data();\r\n-                        $uploaded_file_name = $upload_data['file_name'];\r\n+                    // Dosya türü kontrolü\r\n+                    if (in_array($file_ext, $allowed_types) && $_FILES['banka_gorsel']['size'] <= $max_size) {\r\n+                        // Güvenli dosya adı oluştur\r\n+                        $encrypted_name = md5(uniqid(rand(), true)) . '.' . $file_ext;\r\n+                        $upload_file = $upload_path . $encrypted_name;\r\n+                        \r\n+                        if (move_uploaded_file($_FILES['banka_gorsel']['tmp_name'], $upload_file)) {\r\n+                            $uploaded_file_name = $encrypted_name;\r\n+                        }\r\n                     }\r\n                 }\r\n \r\n                 $banka_data = [\r\n@@ -176,26 +188,32 @@\n                 // Çek bilgilerini al\r\n                 $cek_bankaID = $this->input->post('cek_bankaID');\r\n                 $cek_bankaSube = $this->input->post('cek_bankaSube');\r\n \r\n-                // Çek dosya yükleme işlemi\r\n+                // Çek dosya yükleme işlemi - Manual upload without CodeIgniter Upload library\r\n                 $uploaded_file_name = null;\r\n                 if (isset($_FILES['cek_gorsel']) && !empty($_FILES['cek_gorsel']['name'])) {\r\n-                    $config['upload_path'] = './assets/uploads/cekler/';\r\n-                    $config['allowed_types'] = 'gif|jpg|png|jpeg|pdf';\r\n-                    $config['max_size'] = 5120; // 5MB\r\n-                    $config['encrypt_name'] = TRUE;\r\n+                    $upload_path = './assets/uploads/cekler/';\r\n+                    $allowed_types = array('gif', 'jpg', 'png', 'jpeg', 'pdf');\r\n+                    $max_size = 5120000; // 5MB in bytes\r\n                     \r\n                     // Upload dizinini kontrol et ve yoksa oluştur\r\n-                    if (!is_dir($config['upload_path'])) {\r\n-                        mkdir($config['upload_path'], 0755, true);\r\n+                    if (!is_dir($upload_path)) {\r\n+                        mkdir($upload_path, 0755, true);\r\n                     }\r\n                     \r\n-                    $this->load->library('upload', $config);\r\n+                    $file_info = pathinfo($_FILES['cek_gorsel']['name']);\r\n+                    $file_ext = strtolower($file_info['extension']);\r\n                     \r\n-                    if ($this->upload->do_upload('cek_gorsel')) {\r\n-                        $upload_data = $this->upload->data();\r\n-                        $uploaded_file_name = $upload_data['file_name'];\r\n+                    // Dosya türü kontrolü\r\n+                    if (in_array($file_ext, $allowed_types) && $_FILES['cek_gorsel']['size'] <= $max_size) {\r\n+                        // Güvenli dosya adı oluştur\r\n+                        $encrypted_name = md5(uniqid(rand(), true)) . '.' . $file_ext;\r\n+                        $upload_file = $upload_path . $encrypted_name;\r\n+                        \r\n+                        if (move_uploaded_file($_FILES['cek_gorsel']['tmp_name'], $upload_file)) {\r\n+                            $uploaded_file_name = $encrypted_name;\r\n+                        }\r\n                     }\r\n                 }\r\n \r\n                 // Çek tablosuna kaydet\r\n@@ -251,33 +269,39 @@\n                             } else {\r\n                                 $formatted_vade = date('Y-m-d');\r\n                             }\r\n \r\n-                            // Dosya yükleme işlemi\r\n+                            // Dosya yükleme işlemi - Manual upload without CodeIgniter Upload library\r\n                             $uploaded_file_name = null;\r\n                             if (isset($_FILES['senet_gorsel']['name'][$i]) && !empty($_FILES['senet_gorsel']['name'][$i])) {\r\n-                                $config['upload_path'] = './assets/uploads/senetler/';\r\n-                                $config['allowed_types'] = 'gif|jpg|png|jpeg';\r\n-                                $config['max_size'] = 5120; // 5MB\r\n-                                $config['encrypt_name'] = TRUE;\r\n+                                $upload_path = './assets/uploads/senetler/';\r\n+                                $allowed_types = array('gif', 'jpg', 'png', 'jpeg');\r\n+                                $max_size = 5120000; // 5MB in bytes\r\n                                 \r\n                                 // Upload dizinini kontrol et ve yoksa oluştur\r\n-                                if (!is_dir($config['upload_path'])) {\r\n-                                    mkdir($config['upload_path'], 0755, true);\r\n+                                if (!is_dir($upload_path)) {\r\n+                                    mkdir($upload_path, 0755, true);\r\n                                 }\r\n                                 \r\n-                                $this->load->library('upload', $config);\r\n+                                $file_name = $_FILES['senet_gorsel']['name'][$i];\r\n+                                $file_tmp = $_FILES['senet_gorsel']['tmp_name'][$i];\r\n+                                $file_size = $_FILES['senet_gorsel']['size'][$i];\r\n+                                $file_error = $_FILES['senet_gorsel']['error'][$i];\r\n                                 \r\n-                                // Tek dosya upload için $_FILES'ı düzenle\r\n-                                $_FILES['senet_file']['name'] = $_FILES['senet_gorsel']['name'][$i];\r\n-                                $_FILES['senet_file']['type'] = $_FILES['senet_gorsel']['type'][$i];\r\n-                                $_FILES['senet_file']['tmp_name'] = $_FILES['senet_gorsel']['tmp_name'][$i];\r\n-                                $_FILES['senet_file']['error'] = $_FILES['senet_gorsel']['error'][$i];\r\n-                                $_FILES['senet_file']['size'] = $_FILES['senet_gorsel']['size'][$i];\r\n-                                \r\n-                                if ($this->upload->do_upload('senet_file')) {\r\n-                                    $upload_data = $this->upload->data();\r\n-                                    $uploaded_file_name = $upload_data['file_name'];\r\n+                                if ($file_error == 0 && $file_size <= $max_size) {\r\n+                                    $file_info = pathinfo($file_name);\r\n+                                    $file_ext = strtolower($file_info['extension']);\r\n+                                    \r\n+                                    // Dosya türü kontrolü\r\n+                                    if (in_array($file_ext, $allowed_types)) {\r\n+                                        // Güvenli dosya adı oluştur\r\n+                                        $encrypted_name = md5(uniqid(rand(), true)) . '.' . $file_ext;\r\n+                                        $upload_file = $upload_path . $encrypted_name;\r\n+                                        \r\n+                                        if (move_uploaded_file($file_tmp, $upload_file)) {\r\n+                                            $uploaded_file_name = $encrypted_name;\r\n+                                        }\r\n+                                    }\r\n                                 }\r\n                             }\r\n \r\n                             // Senet tablosuna kaydet\r\n"
                }
            ],
            "date": 1754924666052,
            "name": "Commit-0",
            "content": "<?php\r\n// filepath: application/controllers/Tahsilat.php\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\nclass Tahsilat extends CI_Controller {\r\n    public function __construct() {\r\n        parent::__construct();\r\n        $this->load->model('vt');\r\n        // Giriş kontrolü (örnek)\r\n        $control = session('r', 'login');\r\n        if (!$control) {\r\n            redirect('check');\r\n        }\r\n    }\r\n    \r\n    // Mobil cihaz kontrolü\r\n    private function is_mobile_device() {\r\n        $user_agent = $_SERVER['HTTP_USER_AGENT'];\r\n        return preg_match('/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i', $user_agent);\r\n    }\r\n    \r\n    public function tahsilat_kaydet() {\r\n        // Mobil cihaz kontrolü\r\n        $is_mobile = $this->is_mobile_device();\r\n        \r\n        // Formdan gelen veriler\r\n        $cari_id = $this->input->post('cari_id');\r\n        $tahsilat_cariKodu = $this->input->post('tahsilat_cariKodu');\r\n        $tahsilat_cariAdi = $this->input->post('tahsilat_cariAdi');\r\n        $tahsilat_odemeTipi = $this->input->post('tahsilat_odemeTipi');\r\n        $tahsilat_kasaID = $this->input->post('tahsilat_kasaID');\r\n        // Disabled alanlardan değer alamıyorsak hidden input'tan al\r\n        if (!$tahsilat_kasaID) {\r\n            $tahsilat_kasaID = $this->input->post('tahsilat_kasaID_hidden');\r\n        }\r\n        \r\n        // Debug için log ekle\r\n        error_log(\"Debug tahsilat_kaydet - kasaID normal: \" . var_export($this->input->post('tahsilat_kasaID'), true));\r\n        error_log(\"Debug tahsilat_kaydet - kasaID hidden: \" . var_export($this->input->post('tahsilat_kasaID_hidden'), true));\r\n        error_log(\"Debug tahsilat_kaydet - final kasaID: \" . var_export($tahsilat_kasaID, true));\r\n        $tahsilat_bankaID = $this->input->post('tahsilat_bankaID');\r\n        $tahsilat_tarih = $this->input->post('tahsilat_tarih');\r\n        $tahsilat_tutar = $this->input->post('tahsilat_tutar');\r\n        $tahsilat_aciklama = $this->input->post('tahsilat_aciklama');\r\n\r\n        // Validasyon kontrolleri\r\n        if (!$cari_id) {\r\n            $this->session->set_flashdata('tahsilat_hata', 'Lütfen geçerli bir cari seçiniz.');\r\n            redirect('tahsilat/tahsilat-olustur');\r\n            return;\r\n        }\r\n\r\n        if (!$tahsilat_odemeTipi) {\r\n            $this->session->set_flashdata('tahsilat_hata', 'Lütfen ödeme türü seçiniz.');\r\n            redirect('tahsilat/tahsilat-olustur');\r\n            return;\r\n        }\r\n\r\n        if ($tahsilat_odemeTipi == 1 && !$tahsilat_kasaID) {\r\n            $this->session->set_flashdata('tahsilat_hata', 'Kasa ödemesi için lütfen kasa seçiniz.');\r\n            redirect('tahsilat/tahsilat-olustur');\r\n            return;\r\n        }        if ($tahsilat_odemeTipi == 2 && !$tahsilat_bankaID) {\r\n            $this->session->set_flashdata('tahsilat_hata', 'Banka ödemesi için lütfen banka seçiniz.');\r\n            redirect('tahsilat/tahsilat-olustur');\r\n            return;\r\n        }// Çek ödemesi validasyonu\r\n        if ($tahsilat_odemeTipi == 3) {\r\n            $cek_bankaID = $this->input->post('cek_bankaID');\r\n            $cek_bankaSube = $this->input->post('cek_bankaSube');\r\n\r\n            if (!$cek_bankaID || !$cek_bankaSube) {\r\n                $this->session->set_flashdata('tahsilat_hata', 'Çek ödemesi için çek bankası ve banka şubesi bilgilerini doldurunuz.');\r\n                redirect('tahsilat/tahsilat-olustur');\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Senet ödemesi validasyonu\r\n        if ($tahsilat_odemeTipi == 4) {\r\n            $senet_tutar = $this->input->post('senet_tutar');\r\n            $senet_vade = $this->input->post('senet_vade');\r\n\r\n            // En az bir senet girişinin dolu olduğunu kontrol et\r\n            $valid_senet_count = 0;\r\n            if ($senet_tutar && $senet_vade) {\r\n                for ($i = 0; $i < count($senet_tutar); $i++) {\r\n                    if (!empty($senet_tutar[$i]) && !empty($senet_vade[$i])) {\r\n                        $valid_senet_count++;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if ($valid_senet_count == 0) {\r\n                $this->session->set_flashdata('tahsilat_hata', 'Senet ödemesi için en az bir senet bilgisi giriniz (tutar ve vade tarihi).');\r\n                redirect('tahsilat/tahsilat-olustur');\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Ana tutar alanı validasyonu (Senet ödemesi dışında zorunlu)\r\n        if ($tahsilat_odemeTipi != 4 && (empty($tahsilat_tutar) || $tahsilat_tutar <= 0)) {\r\n            $this->session->set_flashdata('tahsilat_hata', 'Lütfen geçerli bir tutar giriniz.');\r\n            redirect('tahsilat/tahsilat-olustur');\r\n            return;\r\n        }\r\n\r\n        // Get user and company info\r\n        $control2 = session(\"r\", \"login_info\");\r\n        $u_id = $control2->kullanici_id;\r\n        $anaHesap = anaHesapBilgisi();\r\n        \r\n        // Tarihi formatla\r\n        $tarih_parts = explode('.', $tahsilat_tarih);\r\n        if (count($tarih_parts) == 3) {\r\n            $formatted_tarih = $tarih_parts[2] . '-' . $tarih_parts[1] . '-' . $tarih_parts[0];\r\n        } else {\r\n            $formatted_tarih = date('Y-m-d');\r\n        }\r\n\r\n        // Generate unique document number\r\n        $belge_no = 'THS-' . date('Ymd') . '-' . time();        try {\r\n            $this->db->trans_start();            // Insert into appropriate movement table based on payment type\r\n            if ($tahsilat_odemeTipi == 1) { // Kasa\r\n                $kasa_data = [\r\n                    'kh_kasaID' => $tahsilat_kasaID,\r\n                    'kh_cariID' => $cari_id,\r\n                    'kh_tarih' => $formatted_tarih,\r\n                    'kh_giris' => $tahsilat_tutar, // Tahsilat için giriş alanını kullan\r\n                    'kh_turu' => 8, // Tahsilat türü\r\n                    'kh_aciklama' => $tahsilat_aciklama,\r\n                    'kh_belgeNumarasi' => $belge_no,\r\n                    'kh_olusturan' => $u_id,\r\n                    'kh_olusturanAnaHesap' => $anaHesap,\r\n                    'kh_olusturmaTarihi' => date('Y-m-d'),\r\n                    'kh_olusturmaSaati' => date('H:i:s')\r\n                ];\r\n                $this->db->insert('kasaHareketleri', $kasa_data);            } elseif ($tahsilat_odemeTipi == 2) { // Banka / POS\r\n                // Banka dosya yükleme işlemi\r\n                $uploaded_file_name = null;\r\n                if (isset($_FILES['banka_gorsel']) && !empty($_FILES['banka_gorsel']['name'])) {\r\n                    $config['upload_path'] = './assets/uploads/dekontlar/';\r\n                    $config['allowed_types'] = 'gif|jpg|png|jpeg|pdf';\r\n                    $config['max_size'] = 5120; // 5MB\r\n                    $config['encrypt_name'] = TRUE;\r\n                    \r\n                    // Upload dizinini kontrol et ve yoksa oluştur\r\n                    if (!is_dir($config['upload_path'])) {\r\n                        mkdir($config['upload_path'], 0755, true);\r\n                    }\r\n                    \r\n                    $this->load->library('upload', $config);\r\n                    \r\n                    if ($this->upload->do_upload('banka_gorsel')) {\r\n                        $upload_data = $this->upload->data();\r\n                        $uploaded_file_name = $upload_data['file_name'];\r\n                    }\r\n                }\r\n\r\n                $banka_data = [\r\n                    'bh_bankaID' => $tahsilat_bankaID,\r\n                    'bh_cariID' => $cari_id,\r\n                    'bh_tarih' => $formatted_tarih,\r\n                    'bh_giris' => $tahsilat_tutar, // Gelen havale/EFT/POS için giris alanını kullan\r\n                    'bh_turu' => 1, // Gelen Havale/EFT/POS türü\r\n                    'bh_aciklama' => $tahsilat_aciklama,\r\n                    'bh_belgeNumarasi' => $belge_no,\r\n                    'bh_gorsel' => $uploaded_file_name, // Yüklenen dosya adı\r\n                    'bh_olusturan' => $u_id,\r\n                    'bh_olusturanAnaHesap' => $anaHesap,\r\n                    'bh_olusturmaTarihi' => date('Y-m-d'),\r\n                    'bh_olusturmaSaati' => date('H:i:s')\r\n                ];\r\n                $this->db->insert('bankaHareketleri', $banka_data);\r\n                  } elseif ($tahsilat_odemeTipi == 3) { // Çek\r\n                // Çek bilgilerini al\r\n                $cek_bankaID = $this->input->post('cek_bankaID');\r\n                $cek_bankaSube = $this->input->post('cek_bankaSube');\r\n\r\n                // Çek dosya yükleme işlemi\r\n                $uploaded_file_name = null;\r\n                if (isset($_FILES['cek_gorsel']) && !empty($_FILES['cek_gorsel']['name'])) {\r\n                    $config['upload_path'] = './assets/uploads/cekler/';\r\n                    $config['allowed_types'] = 'gif|jpg|png|jpeg|pdf';\r\n                    $config['max_size'] = 5120; // 5MB\r\n                    $config['encrypt_name'] = TRUE;\r\n                    \r\n                    // Upload dizinini kontrol et ve yoksa oluştur\r\n                    if (!is_dir($config['upload_path'])) {\r\n                        mkdir($config['upload_path'], 0755, true);\r\n                    }\r\n                    \r\n                    $this->load->library('upload', $config);\r\n                    \r\n                    if ($this->upload->do_upload('cek_gorsel')) {\r\n                        $upload_data = $this->upload->data();\r\n                        $uploaded_file_name = $upload_data['file_name'];\r\n                    }\r\n                }\r\n\r\n                // Çek tablosuna kaydet\r\n                $cek_data = [\r\n                    'cek_cariID' => $cari_id,\r\n                    'cek_hareketTipi' => 1, // Alınan çek (sabit)\r\n                    'cek_kayitTarihi' => $formatted_tarih,\r\n                    'cek_notAciklama' => $tahsilat_aciklama,\r\n                    'cek_portfoyNo' => $belge_no, // Belge numarasını portföy no olarak kullan\r\n                    'cek_seriNo' => 'CHK-' . time(), // Otomatik seri no\r\n                    'cek_borcluID' => $cari_id, // Çeki veren kişi (tahsilat yapılan cari)\r\n                    'cek_vadeTarih' => $formatted_tarih, // Tahsilat tarihi ile aynı\r\n                    'cek_bankaID' => $cek_bankaID,\r\n                    'cek_bankaSube' => $cek_bankaSube,\r\n                    'cek_tutar' => $tahsilat_tutar,\r\n                    'cek_gorsel' => $uploaded_file_name, // Yüklenen dosya adı\r\n                    'cek_durum' => 0, // Aktif durum\r\n                    'cek_kullaniciID' => $u_id,\r\n                    'cek_olusturanAnaHesap' => $anaHesap,\r\n                    'cek_sistemKayitTarihi' => date('Y-m-d'),\r\n                    'cek_sistemKayitSaati' => date('H:i:s')                ];\r\n                $this->db->insert('cek', $cek_data);\r\n                  } elseif ($tahsilat_odemeTipi == 4) { // Senet\r\n                // Senet kontrol bilgilerini al\r\n                $senet_birim_tutari = $this->input->post('senet_tutari');\r\n                $senet_adedi = $this->input->post('senet_adedi'); \r\n                $senet_ilk_vade = $this->input->post('senet_vade_tarihi');\r\n                \r\n                // Dinamik senet bilgilerini al\r\n                $senet_tutar_array = $this->input->post('senet_tutar');\r\n                $senet_vade_array = $this->input->post('senet_vade');\r\n\r\n                // Validasyon: Kontrol alanları dolu olmalı\r\n                if (empty($senet_birim_tutari) || empty($senet_adedi) || empty($senet_ilk_vade)) {\r\n                    $this->session->set_flashdata('tahsilat_hata', 'Senet bilgileri eksik. Senet tutarı, adedi ve vade tarihi gereklidir.');\r\n                    redirect(base_url() . 'tahsilat/olustur');\r\n                    return;\r\n                }\r\n\r\n                // Validasyon: Senet adedi makul sınırlar içinde olmalı\r\n                if ($senet_adedi < 1 || $senet_adedi > 10) {\r\n                    $this->session->set_flashdata('tahsilat_hata', 'Senet adedi 1-10 arasında olmalıdır.');\r\n                    redirect(base_url() . 'tahsilat/olustur');\r\n                    return;\r\n                }                // Her bir senet için kayıt yap\r\n                if ($senet_tutar_array && $senet_vade_array && count($senet_tutar_array) == $senet_adedi) {\r\n                    for ($i = 0; $i < count($senet_tutar_array); $i++) {\r\n                        if (!empty($senet_tutar_array[$i]) && !empty($senet_vade_array[$i])) {\r\n                            // Vade tarihini formatla\r\n                            $vade_parts = explode('.', $senet_vade_array[$i]);\r\n                            if (count($vade_parts) == 3) {\r\n                                $formatted_vade = $vade_parts[2] . '-' . $vade_parts[1] . '-' . $vade_parts[0];\r\n                            } else {\r\n                                $formatted_vade = date('Y-m-d');\r\n                            }\r\n\r\n                            // Dosya yükleme işlemi\r\n                            $uploaded_file_name = null;\r\n                            if (isset($_FILES['senet_gorsel']['name'][$i]) && !empty($_FILES['senet_gorsel']['name'][$i])) {\r\n                                $config['upload_path'] = './assets/uploads/senetler/';\r\n                                $config['allowed_types'] = 'gif|jpg|png|jpeg';\r\n                                $config['max_size'] = 5120; // 5MB\r\n                                $config['encrypt_name'] = TRUE;\r\n                                \r\n                                // Upload dizinini kontrol et ve yoksa oluştur\r\n                                if (!is_dir($config['upload_path'])) {\r\n                                    mkdir($config['upload_path'], 0755, true);\r\n                                }\r\n                                \r\n                                $this->load->library('upload', $config);\r\n                                \r\n                                // Tek dosya upload için $_FILES'ı düzenle\r\n                                $_FILES['senet_file']['name'] = $_FILES['senet_gorsel']['name'][$i];\r\n                                $_FILES['senet_file']['type'] = $_FILES['senet_gorsel']['type'][$i];\r\n                                $_FILES['senet_file']['tmp_name'] = $_FILES['senet_gorsel']['tmp_name'][$i];\r\n                                $_FILES['senet_file']['error'] = $_FILES['senet_gorsel']['error'][$i];\r\n                                $_FILES['senet_file']['size'] = $_FILES['senet_gorsel']['size'][$i];\r\n                                \r\n                                if ($this->upload->do_upload('senet_file')) {\r\n                                    $upload_data = $this->upload->data();\r\n                                    $uploaded_file_name = $upload_data['file_name'];\r\n                                }\r\n                            }\r\n\r\n                            // Senet tablosuna kaydet\r\n                            $senet_data = [\r\n                                'senet_cariID' => $cari_id,\r\n                                'senet_hareketTipi' => 1, // Alınan senet (sabit)\r\n                                'senet_kayitTarihi' => $formatted_tarih,\r\n                                'senet_notAciklama' => $tahsilat_aciklama . ' - Senet ' . ($i + 1) . '/' . $senet_adedi,\r\n                                'senet_portfoyNo' => $belge_no . '-S' . ($i + 1), // Belge numarası + senet sırası\r\n                                'senet_seriNo' => 'SNT-' . time() . '-' . ($i + 1), // Otomatik seri no\r\n                                'senet_borcluID' => $cari_id, // Senedi veren kişi (tahsilat yapılan cari)\r\n                                'senet_vadeTarih' => $formatted_vade,\r\n                                'senet_tutar' => $senet_tutar_array[$i],\r\n                                'senet_gorsel' => $uploaded_file_name, // Yüklenen dosya adı\r\n                                'senet_durum' => 0, // Aktif durum\r\n                                'senet_kullaniciID' => $u_id,\r\n                                'senet_olusturanAnaHesap' => $anaHesap,\r\n                                'senet_sistemKayitTarihi' => date('Y-m-d'),\r\n                                'senet_sistemKayitSaati' => date('H:i:s')\r\n                            ];                            $this->db->insert('senet', $senet_data);\r\n                        }\r\n                    }\r\n                } else {\r\n                    $this->session->set_flashdata('tahsilat_hata', 'Senet detay bilgileri eksik veya tutarsız.');\r\n                    redirect(base_url() . 'tahsilat/olustur');\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Calculate total amount based on payment type\r\n            $total_amount = $tahsilat_tutar; // Default to main amount field\r\n            \r\n            // For Senet payments, calculate total from individual senet amounts\r\n            if ($tahsilat_odemeTipi == 4) {\r\n                $total_amount = 0;\r\n                $senet_tutar_array = $this->input->post('senet_tutar');\r\n                if ($senet_tutar_array && is_array($senet_tutar_array)) {\r\n                    foreach ($senet_tutar_array as $tutar) {\r\n                        if (!empty($tutar) && is_numeric($tutar)) {\r\n                            $total_amount += floatval($tutar);\r\n                        }\r\n                    }\r\n                }\r\n                  // Tahsilat tutarını senet toplamı ile güncelle\r\n                $tahsilat_tutar = $total_amount;\r\n            }            // Update cari balance (if cari hareketleri table exists)\r\n            $cari_data = [\r\n                'ch_cariID' => $cari_id,\r\n                'ch_tarih' => $formatted_tarih,\r\n                'ch_alacak' => $total_amount, // Use calculated total amount\r\n                'ch_turu' => $tahsilat_odemeTipi == 3 ? 8 : ($tahsilat_odemeTipi == 4 ? 9 : 7), // 8: Alınan çek, 9: Alınan senet, 7: Tahsilat\r\n                'ch_aciklama' => $tahsilat_aciklama,\r\n                'ch_belgeNumarasi' => $belge_no,\r\n                'ch_olusturan' => $u_id,\r\n                'ch_olusturanAnaHesap' => $anaHesap,\r\n                'ch_olusturmaTarihi' => date('Y-m-d'),\r\n                'ch_olusturmaSaati' => date('H:i:s')\r\n            ];\r\n            \r\n            // Check if cariHareketleri table exists\r\n            if ($this->db->table_exists('cariHareketleri')) {\r\n                $this->db->insert('cariHareketleri', $cari_data);\r\n            }\r\n\r\n            $this->db->trans_complete();            if ($this->db->trans_status() === FALSE) {\r\n                if ($tahsilat_odemeTipi == 3) {\r\n                    $this->session->set_flashdata('tahsilat_hata', 'Çek kaydedilirken bir hata oluştu.');\r\n                } else {\r\n                    $this->session->set_flashdata('tahsilat_hata', 'Tahsilat kaydedilirken bir hata oluştu.');\r\n                }\r\n            } else {\r\n                if ($tahsilat_odemeTipi == 3) {\r\n                    $this->session->set_flashdata('tahsilat_ok', 'Çek başarıyla kaydedildi.');\r\n                } else {\r\n                    $this->session->set_flashdata('tahsilat_ok', 'Tahsilat başarıyla kaydedildi.');\r\n                }\r\n            }\r\n\r\n        } catch (Exception $e) {\r\n            $this->session->set_flashdata('tahsilat_hata', 'Tahsilat kaydedilirken bir hata oluştu: ' . $e->getMessage());\r\n        }\r\n\r\n        redirect('tahsilat/tahsilat-olustur');\r\n    }    public function tahsilat_olustur() {\r\n        // Get current user's ID\r\n        $control2 = session(\"r\", \"login_info\");\r\n        $kullanici_id = $control2->kullanici_id;\r\n        $u_id = $kullanici_id;\r\n        \r\n        // Find user's assigned kasa using the helper function\r\n        $user_assigned_kasas = getUserResponsibleVaults($kullanici_id);\r\n        $user_assigned_kasa = !empty($user_assigned_kasas) ? $user_assigned_kasas[0] : null;\r\n        \r\n        // Pass data to view\r\n        $data['baslik'] = 'Tahsilat / Tahsilat Oluştur';\r\n        $data['user_assigned_kasa'] = $user_assigned_kasa;\r\n        \r\n        // Add permission variables for sidebar\r\n        // Cari permissions\r\n        // $data['yetkiSorgul1_cari'] = yetkiSorgula($u_id, 1, 1);\r\n        // $data['yetkiSorgul2_cari'] = yetkiSorgula($u_id, 1, 2);\r\n        // $data['yetkiSorgul3_cari'] = yetkiSorgula($u_id, 1, 3);\r\n        // $data['yetkiSorgul4_cari'] = yetkiSorgula($u_id, 1, 4);\r\n        // $data['yetkiSorgul5_cari'] = yetkiSorgula($u_id, 1, 5);\r\n        // $data['yetkiSorgul6_cari'] = yetkiSorgula($u_id, 1, 6);\r\n        // $data['yetkiSorgul7_cari'] = yetkiSorgula($u_id, 1, 7);\r\n        // $data['yetkiSorgul8_cari'] = yetkiSorgula($u_id, 1, 8);\r\n        // $data['yetkiSorgul9_cari'] = yetkiSorgula($u_id, 1, 9);\r\n        // Stok permissions\r\n        // $data['yetkiSorgul1_stok'] = yetkiSorgula($u_id, 2, 1);\r\n        // $data['yetkiSorgul2_stok'] = yetkiSorgula($u_id, 2, 2);\r\n        // $data['yetkiSorgul3_stok'] = yetkiSorgula($u_id, 2, 3);\r\n        // $data['yetkiSorgul4_stok'] = yetkiSorgula($u_id, 2, 4);\r\n        // $data['yetkiSorgul5_stok'] = yetkiSorgula($u_id, 2, 5);\r\n        // $data['yetkiSorgul6_stok'] = yetkiSorgula($u_id, 2, 6);\r\n        // $data['yetkiSorgul7_stok'] = yetkiSorgula($u_id, 2, 7);\r\n        // Fatura permissions\r\n        // $data['yetkiSorgul1_fatura'] = yetkiSorgula($u_id, 3, 1);\r\n        // $data['yetkiSorgul2_fatura'] = yetkiSorgula($u_id, 3, 2);\r\n        // $data['yetkiSorgul3_fatura'] = yetkiSorgula($u_id, 3, 3);\r\n        // $data['yetkiSorgul4_fatura'] = yetkiSorgula($u_id, 3, 4);\r\n        // $data['yetkiSorgul5_fatura'] = yetkiSorgula($u_id, 3, 5);\r\n        // $data['yetkiSorgul6_fatura'] = yetkiSorgula($u_id, 3, 6);\r\n        // $data['yetkiSorgul7_efatura'] = yetkiSorgula($u_id, 3, 7);\r\n        // $data['yetkiSorgul8_earsiv'] = yetkiSorgula($u_id, 3, 8);\r\n        // Kasa permissions\r\n        // $data['yetkiSorgul1_kasa'] = yetkiSorgula($u_id, 4, 1);\r\n        // $data['yetkiSorgul2_kasa'] = yetkiSorgula($u_id, 4, 2);\r\n        // $data['yetkiSorgul3_kasa'] = yetkiSorgula($u_id, 4, 3);\r\n        // $data['yetkiSorgul4_kasa'] = yetkiSorgula($u_id, 4, 4);\r\n        // $data['yetkiSorgul5_kasa'] = yetkiSorgula($u_id, 4, 5);\r\n        // $data['yetkiSorgul6_kasa'] = yetkiSorgula($u_id, 4, 6);\r\n        // $data['yetkiSorgul7_kasa'] = yetkiSorgula($u_id, 4, 7);\r\n        // $data['yetkiSorgul8_kasa'] = yetkiSorgula($u_id, 4, 8);\r\n        // $data['yetkiSorgul9_kasa'] = yetkiSorgula($u_id, 4, 9);\r\n        // $data['yetkiSorgul10_kasa'] = yetkiSorgula($u_id, 4, 10);\r\n        // $data['yetkiSorgul11_kasa'] = yetkiSorgula($u_id, 4, 11);\r\n        // $data['yetkiSorgul12_kasa'] = yetkiSorgula($u_id, 4, 12);\r\n        // Banka permissions\r\n        // $data['yetkiSorgul1_banka'] = yetkiSorgula($u_id, 5, 1);\r\n        // $data['yetkiSorgul2_banka'] = yetkiSorgula($u_id, 5, 2);\r\n        // $data['yetkiSorgul3_banka'] = yetkiSorgula($u_id, 5, 3);\r\n        // $data['yetkiSorgul4_banka'] = yetkiSorgula($u_id, 5, 4);\r\n        // $data['yetkiSorgul5_banka'] = yetkiSorgula($u_id, 5, 5);\r\n        // $data['yetkiSorgul6_banka'] = yetkiSorgula($u_id, 5, 6);\r\n        // $data['yetkiSorgul7_banka'] = yetkiSorgula($u_id, 5, 7);\r\n        // $data['yetkiSorgul8_banka'] = yetkiSorgula($u_id, 5, 8);\r\n        // $data['yetkiSorgul9_banka'] = yetkiSorgula($u_id, 5, 9);\r\n        // $data['yetkiSorgul10_banka'] = yetkiSorgula($u_id, 5, 10);\r\n        // $data['yetkiSorgul11_banka'] = yetkiSorgula($u_id, 5, 11);\r\n        // $data['yetkiSorgul12_banka'] = yetkiSorgula($u_id, 5, 12);\r\n        // Giderler permissions\r\n        // $data['yetkiSorgul1_giderler'] = yetkiSorgula($u_id, 7, 1);\r\n        // $data['yetkiSorgul2_giderler'] = yetkiSorgula($u_id, 7, 2);\r\n        // $data['yetkiSorgul3_giderler'] = yetkiSorgula($u_id, 7, 3);\r\n        \r\n        $this->load->view('tahsilat/tahsilat-olustur', $data);\r\n    }\r\n    \r\n    /**\r\n     * Tahsilat Listesi Sayfası\r\n     * Kullanıcının kendi tahsilat kayıtlarını listeler\r\n     */\r\n    public function tahsilat_listesi() {\r\n        // Memory limit artır (performans için)\r\n        ini_set('memory_limit', '256M');\r\n        ini_set('max_execution_time', 300);\r\n        \r\n        $data[\"baslik\"] = \"Tahsilat / Tahsilat Listesi\";\r\n        $anaHesap = anaHesapBilgisi();\r\n        \r\n        // Giriş yapan kullanıcı bilgisi\r\n        $control = session(\"r\", \"login_info\");\r\n        if (!$control || !isset($control->kullanici_id)) {\r\n            redirect(base_url('check'));\r\n            return;\r\n        }\r\n        $u_id = $control->kullanici_id;\r\n        \r\n        // Çek senkronizasyonu - çek tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n        $this->senkronizeCekler();\r\n        \r\n        // Banka hareketleri senkronizasyonu - bankaHareketleri tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n        $this->senkronizeBankaHareketleri();\r\n        \r\n        // Kasa hareketleri senkronizasyonu - kasaHareketleri tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n        $this->senkronizeKasaHareketleri();\r\n        \r\n        // Senet senkronizasyonu - senet tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n        $this->senkronizeSenetler();\r\n        \r\n        // Muhasebe tahsilat durum tablosunun varlığını kontrol et\r\n        $tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n        \r\n        if ($tableExists == 0) {\r\n            // Tablo yoksa boş veri döndür ve kullanıcıyı bilgilendir\r\n            $data[\"tahsilatlar\"] = array();\r\n            $data[\"toplam_tutar\"] = 0;\r\n            $data[\"toplam_adet\"] = 0;\r\n            $data[\"error_message\"] = \"Muhasebe tahsilat durum tablosu henüz oluşturulmamış. Lütfen 'muhase_database_setup.sql' dosyasını veritabanında çalıştırın.\";\r\n        } else {\r\n            // Bağımlı tabloların varlığını da kontrol et\r\n            $requiredTables = ['bankaHareketleri', 'cek', 'kasaHareketleri', 'senet', 'cari', 'kullanicilar'];\r\n            $missingTables = [];\r\n            \r\n            foreach($requiredTables as $table) {\r\n                $exists = $this->db->query(\"SHOW TABLES LIKE '$table'\")->num_rows();\r\n                if($exists == 0) {\r\n                    $missingTables[] = $table;\r\n                }\r\n            }\r\n            \r\n            if(!empty($missingTables)) {\r\n                $data[\"tahsilatlar\"] = array();\r\n                $data[\"toplam_tutar\"] = 0;\r\n                $data[\"toplam_adet\"] = 0;\r\n                $data[\"error_message\"] = \"Eksik tablolar tespit edildi: \" . implode(', ', $missingTables) . \". Lütfen veritabanı kurulumunu tamamlayın.\";\r\n            } else {\r\n                // Ana sorgu: Sadece giriş yapan kullanıcının tahsilatlarını getir\r\n                $tahsilatlarQ = \"SELECT \r\n                   mtd.id,\r\n                   mtd.tahsilat_tipi,\r\n                   CASE \r\n                       WHEN mtd.tahsilat_tipi = 1 THEN 'Banka'\r\n                       WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n                       WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa'\r\n                       WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n                       ELSE 'Bilinmiyor'\r\n                   END as tahsilat_tipi_adi,\r\n                   mtd.kayit_id,\r\n                   CASE \r\n                       WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n                       WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n                       WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n                       ELSE 'Bilinmiyor'\r\n                   END as durum_adi,\r\n                   mtd.durum,\r\n                   COALESCE(bh_cari.cari_ad, c_cari.cari_ad, kh_cari.cari_ad, s_cari.cari_ad) as musteri_adi,\r\n                   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as gorsel,\r\n                   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n                   -- Çek ek bilgileri\r\n                   c.cek_seriNo as cek_seri_no,\r\n                   c.cek_vadeTarih as cek_vade_tarih,\r\n                   c.cek_portfoyNo as cek_portfoy_no,\r\n                   c.cek_durum as cek_durum,\r\n                   -- Senet ek bilgileri\r\n                   s.senet_seriNo as senet_seri_no,\r\n                   s.senet_vadeTarih as senet_vade_tarih,\r\n                   s.senet_portfoyNo as senet_portfoy_no,\r\n                   s.senet_durum as senet_durum,\r\n                   s.senet_gorsel as senet_gorsel,\r\n                   -- Banka ek bilgileri\r\n                   bh.bh_belgeNumarasi as banka_belge_no,\r\n                   bh.bh_turu as banka_turu,\r\n                   bh.bh_bankaID as banka_id,\r\n                   bh.bh_tarih as banka_tarih,\r\n                   bh.bh_aciklama as banka_aciklama,\r\n                   b.banka_bankaAd as banka_adi,\r\n                   b.banka_hesapNo as banka_hesap_no,\r\n                   -- Kasa ek bilgileri\r\n                   kh.kh_belgeNumarasi as kasa_belge_no,\r\n                   kh.kh_turu as kasa_turu,\r\n                   kh.kh_kasaID as kasa_id,\r\n                   kh.kh_tarih as kasa_tarih,\r\n                   kh.kh_aciklama as kasa_aciklama,\r\n                   k.kasa_adi as kasa_adi,\r\n                   k.kasa_kodu as kasa_kodu,\r\n                   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n                   CASE \r\n                       WHEN mtd.tahsilat_tipi = 1 THEN CONCAT(bh_k.kullanici_ad, ' ', bh_k.kullanici_soyad)\r\n                       WHEN mtd.tahsilat_tipi = 2 THEN CONCAT(c_k.kullanici_ad, ' ', c_k.kullanici_soyad)\r\n                       WHEN mtd.tahsilat_tipi = 3 THEN CONCAT(kh_k.kullanici_ad, ' ', kh_k.kullanici_soyad)\r\n                       WHEN mtd.tahsilat_tipi = 4 THEN CONCAT(s_k.kullanici_ad, ' ', s_k.kullanici_soyad)\r\n                   END as islemi_yapan_personel,\r\n                   mtd.islem_tarihi,\r\n                   mtd.olusturma_tarihi,\r\n                   mtd.aciklama\r\n                FROM muhasebe_tahsilat_durum mtd\r\n                \r\n                -- Onay yapan personel\r\n                LEFT JOIN kullanicilar onay_k ON mtd.islemi_yapan = onay_k.kullanici_id\r\n                \r\n                -- Banka hareketleri\r\n                LEFT JOIN bankaHareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n                LEFT JOIN kullanicilar bh_k ON bh.bh_olusturan = bh_k.kullanici_id\r\n                LEFT JOIN cari bh_cari ON bh.bh_cariID = bh_cari.cari_id\r\n                LEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n                \r\n                -- Çek\r\n                LEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n                LEFT JOIN kullanicilar c_k ON c.cek_kullaniciID = c_k.kullanici_id\r\n                LEFT JOIN cari c_cari ON c.cek_cariID = c_cari.cari_id\r\n                \r\n                -- Kasa hareketleri\r\n                LEFT JOIN kasaHareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n                LEFT JOIN kullanicilar kh_k ON kh.kh_olusturan = kh_k.kullanici_id\r\n                LEFT JOIN cari kh_cari ON kh.kh_cariID = kh_cari.cari_id\r\n                LEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n                \r\n                -- Senet\r\n                LEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n                LEFT JOIN kullanicilar s_k ON s.senet_kullaniciID = s_k.kullanici_id\r\n                LEFT JOIN cari s_cari ON s.senet_cariID = s_cari.cari_id\r\n                \r\n                WHERE mtd.tahsilat_tipi IN (1, 2, 3, 4)\r\n                AND (\r\n                    (mtd.tahsilat_tipi = 1 AND bh.bh_olusturan = '$u_id') OR\r\n                    (mtd.tahsilat_tipi = 2 AND c.cek_kullaniciID = '$u_id') OR\r\n                    (mtd.tahsilat_tipi = 3 AND kh.kh_olusturan = '$u_id') OR\r\n                    (mtd.tahsilat_tipi = 4 AND s.senet_kullaniciID = '$u_id')\r\n                )\r\n                ORDER BY mtd.olusturma_tarihi DESC\";\r\n                \r\n                $data[\"tahsilatlar\"] = $this->db->query($tahsilatlarQ)->result();\r\n                \r\n                // İstatistikler\r\n                $data[\"toplam_adet\"] = count($data[\"tahsilatlar\"]);\r\n                \r\n                // Toplam tutar hesapla\r\n                $toplam_tutar = 0;\r\n                foreach($data[\"tahsilatlar\"] as $tahsilat) {\r\n                    if($tahsilat->tutar) {\r\n                        $toplam_tutar += $tahsilat->tutar;\r\n                    }\r\n                }\r\n                $data[\"toplam_tutar\"] = $toplam_tutar;\r\n                \r\n                // Durum bazında istatistikler\r\n                $onay_bekleyen = 0;\r\n                $onaylanan = 0;\r\n                $reddedilen = 0;\r\n                \r\n                foreach($data[\"tahsilatlar\"] as $tahsilat) {\r\n                    switch($tahsilat->durum) {\r\n                        case 1: $onay_bekleyen++; break;\r\n                        case 2: $onaylanan++; break;\r\n                        case 3: $reddedilen++; break;\r\n                    }\r\n                }\r\n                \r\n                $data[\"onay_bekleyen_adet\"] = $onay_bekleyen;\r\n                $data[\"onaylanan_adet\"] = $onaylanan;\r\n                $data[\"reddedilen_adet\"] = $reddedilen;\r\n            }\r\n        }\r\n        \r\n        // Sayfa yükle\r\n        $this->load->view('tahsilat/tahsilat-listesi', $data);\r\n    }\r\n    \r\n    /**\r\n     * Tahsilat Listesi AJAX\r\n     * Filtrelenmiş tahsilat kayıtlarını JSON olarak döner\r\n     */\r\n    public function tahsilat_listesi_ajax() {\r\n        // Yetki kontrolü\r\n        if (!grup_modul_yetkisi_var(511)) {\r\n            echo json_encode(['status' => 'error', 'message' => 'Yetkiniz bulunmuyor']);\r\n            return;\r\n        }\r\n        \r\n        // Filtre parametreleri\r\n        $cari_filter = $this->input->post('cari_filter');\r\n        $odeme_tipi_filter = $this->input->post('odeme_tipi_filter');\r\n        $baslangic_tarih = $this->input->post('baslangic_tarih');\r\n        $bitis_tarih = $this->input->post('bitis_tarih');\r\n        \r\n        try {\r\n            // Ana sorgu - Tüm tahsilat kayıtlarını getir\r\n            $this->db->select('t.*, c.cari_adi, k.kullanici_ad as olusturan_kullanici_adi');\r\n            $this->db->from('tahsilat t');\r\n            $this->db->join('cari c', 't.tahsilat_cariID = c.cari_id', 'left');\r\n            $this->db->join('kullanicilar k', 't.tahsilat_olusturanKullanici = k.kullanici_id', 'left');\r\n            \r\n            // Filtreler\r\n            if (!empty($cari_filter)) {\r\n                $this->db->where('t.tahsilat_cariID', $cari_filter);\r\n            }\r\n            \r\n            if (!empty($odeme_tipi_filter)) {\r\n                $this->db->where('t.tahsilat_odemeTipi', $odeme_tipi_filter);\r\n            }\r\n            \r\n            if (!empty($baslangic_tarih)) {\r\n                $this->db->where('DATE(t.tahsilat_tarih) >=', $baslangic_tarih);\r\n            }\r\n            \r\n            if (!empty($bitis_tarih)) {\r\n                $this->db->where('DATE(t.tahsilat_tarih) <=', $bitis_tarih);\r\n            }\r\n            \r\n            $this->db->order_by('t.tahsilat_tarih', 'DESC');\r\n            $this->db->limit(1000); // Performans için limit\r\n            \r\n            $result = $this->db->get()->result_array();\r\n            \r\n            echo json_encode([\r\n                'status' => 'success',\r\n                'data' => $result,\r\n                'message' => count($result) . ' kayıt bulundu'\r\n            ]);\r\n            \r\n        } catch (Exception $e) {\r\n            echo json_encode([\r\n                'status' => 'error',\r\n                'message' => 'Veritabanı hatası: ' . $e->getMessage()\r\n            ]);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Tahsilat Düzenleme Sayfası\r\n     */\r\n    public function tahsilat_duzenle($id) {\r\n        // Yetki kontrolü\r\n        if (!grup_modul_yetkisi_var(511)) {\r\n            redirect('home');\r\n            return;\r\n        }\r\n        \r\n        $data[\"baslik\"] = \"Tahsilat / Tahsilat Düzenle\";\r\n        \r\n        // Tahsilat bilgilerini getir\r\n        $tahsilat = $this->db->select('t.*, c.cari_adi, k.kullanici_ad as olusturan_kullanici_adi')\r\n                             ->from('tahsilat t')\r\n                             ->join('cari c', 't.tahsilat_cariID = c.cari_id', 'left')\r\n                             ->join('kullanicilar k', 't.tahsilat_olusturanKullanici = k.kullanici_id', 'left')\r\n                             ->where('t.tahsilat_id', $id)\r\n                             ->get()\r\n                             ->row();\r\n        \r\n        if (!$tahsilat) {\r\n            redirect('tahsilat/tahsilat-listesi');\r\n            return;\r\n        }\r\n        \r\n        $data['tahsilat'] = $tahsilat;\r\n        \r\n        // Cari listesi\r\n        $data['cariler'] = $this->db->select('cari_id, cari_kodu, cari_adi')\r\n                                   ->from('cari')\r\n                                   ->where('cari_durum', 1)\r\n                                   ->order_by('cari_adi', 'ASC')\r\n                                   ->get()\r\n                                   ->result();\r\n\r\n        // Kasa listesi\r\n        $data['kasalar'] = $this->db->select('kasa_id, kasa_adi')\r\n                                   ->from('kasa')\r\n                                   ->where('kasa_durum', 1)\r\n                                   ->order_by('kasa_adi', 'ASC')\r\n                                   ->get()\r\n                                   ->result();\r\n\r\n        // Banka listesi\r\n        $data['bankalar'] = $this->db->select('banka_id, banka_adi')\r\n                                    ->from('banka')\r\n                                    ->where('banka_durum', 1)\r\n                                    ->order_by('banka_adi', 'ASC')\r\n                                    ->get()\r\n                                    ->result();\r\n        \r\n        $this->load->view('tahsilat/tahsilat-duzenle', $data);\r\n    }\r\n    \r\n    /**\r\n     * Tahsilat Detay Sayfası\r\n     */\r\n    public function tahsilat_detay($id) {\r\n        // Yetki kontrolü\r\n        if (!grup_modul_yetkisi_var(511)) {\r\n            redirect('home');\r\n            return;\r\n        }\r\n        \r\n        $data[\"baslik\"] = \"Tahsilat / Tahsilat Detayı\";\r\n        \r\n        // Tahsilat bilgilerini getir\r\n        $tahsilat = $this->db->select('t.*, c.cari_adi, k.kullanici_ad as olusturan_kullanici_adi')\r\n                             ->from('tahsilat t')\r\n                             ->join('cari c', 't.tahsilat_cariID = c.cari_id', 'left')\r\n                             ->join('kullanicilar k', 't.tahsilat_olusturanKullanici = k.kullanici_id', 'left')\r\n                             ->where('t.tahsilat_id', $id)\r\n                             ->get()\r\n                             ->row();\r\n        \r\n        if (!$tahsilat) {\r\n            redirect('tahsilat/tahsilat-listesi');\r\n            return;\r\n        }\r\n        \r\n        $data['tahsilat'] = $tahsilat;\r\n        \r\n        $this->load->view('tahsilat/tahsilat-detay', $data);\r\n    }\r\n    \r\n    /**\r\n     * Tahsilat Silme\r\n     */\r\n    public function tahsilat_sil($id) {\r\n        // Yetki kontrolü\r\n        if (!grup_modul_yetkisi_var(511)) {\r\n            echo json_encode(['status' => 'error', 'message' => 'Yetkiniz bulunmuyor']);\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            $this->db->where('tahsilat_id', $id);\r\n            $this->db->delete('tahsilat');\r\n            \r\n            if ($this->db->affected_rows() > 0) {\r\n                echo json_encode(['status' => 'success', 'message' => 'Tahsilat başarıyla silindi']);\r\n            } else {\r\n                echo json_encode(['status' => 'error', 'message' => 'Tahsilat bulunamadı']);\r\n            }\r\n        } catch (Exception $e) {\r\n            echo json_encode(['status' => 'error', 'message' => 'Veritabanı hatası: ' . $e->getMessage()]);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Tahsilat Excel Export\r\n     */\r\n    public function tahsilat_excel_export() {\r\n        // Yetki kontrolü\r\n        if (!grup_modul_yetkisi_var(511)) {\r\n            redirect('home');\r\n            return;\r\n        }\r\n        \r\n        // Filtre parametreleri\r\n        $cari_filter = $this->input->get('cari_filter');\r\n        $odeme_tipi_filter = $this->input->get('odeme_tipi_filter');\r\n        $baslangic_tarih = $this->input->get('baslangic_tarih');\r\n        $bitis_tarih = $this->input->get('bitis_tarih');\r\n        \r\n        try {\r\n            // Ana sorgu\r\n            $this->db->select('t.*, c.cari_adi, k.kullanici_ad as olusturan_kullanici_adi');\r\n            $this->db->from('tahsilat t');\r\n            $this->db->join('cari c', 't.tahsilat_cariID = c.cari_id', 'left');\r\n            $this->db->join('kullanicilar k', 't.tahsilat_olusturanKullanici = k.kullanici_id', 'left');\r\n            \r\n            // Filtreler\r\n            if (!empty($cari_filter)) {\r\n                $this->db->where('t.tahsilat_cariID', $cari_filter);\r\n            }\r\n            \r\n            if (!empty($odeme_tipi_filter)) {\r\n                $this->db->where('t.tahsilat_odemeTipi', $odeme_tipi_filter);\r\n            }\r\n            \r\n            if (!empty($baslangic_tarih)) {\r\n                $this->db->where('DATE(t.tahsilat_tarih) >=', $baslangic_tarih);\r\n            }\r\n            \r\n            if (!empty($bitis_tarih)) {\r\n                $this->db->where('DATE(t.tahsilat_tarih) <=', $bitis_tarih);\r\n            }\r\n            \r\n            $this->db->order_by('t.tahsilat_tarih', 'DESC');\r\n            \r\n            $result = $this->db->get()->result_array();\r\n            \r\n            // Excel dosyası oluştur\r\n            $filename = 'tahsilat_listesi_' . date('Y-m-d_H-i-s') . '.xlsx';\r\n            \r\n            header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n            header('Content-Disposition: attachment;filename=\"' . $filename . '\"');\r\n            header('Cache-Control: max-age=0');\r\n            \r\n            // Basit CSV formatında çıktı (Excel uyumlu)\r\n            $output = fopen('php://output', 'w');\r\n            \r\n            // UTF-8 BOM ekle\r\n            fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));\r\n            \r\n            // Başlık satırı\r\n            fputcsv($output, [\r\n                'ID',\r\n                'Tarih',\r\n                'Cari',\r\n                'Ödeme Tipi',\r\n                'Tutar',\r\n                'Açıklama',\r\n                'Oluşturan'\r\n            ], ';');\r\n            \r\n            // Veri satırları\r\n            foreach ($result as $row) {\r\n                $odeme_tipi = $this->getOdemeTipiText($row['tahsilat_odemeTipi']);\r\n                \r\n                fputcsv($output, [\r\n                    $row['tahsilat_id'],\r\n                    $row['tahsilat_tarih'],\r\n                    $row['cari_adi'] ?: 'Bilinmiyor',\r\n                    $odeme_tipi,\r\n                    number_format($row['tahsilat_tutar'], 2, ',', '.') . ' ₺',\r\n                    $row['tahsilat_aciklama'] ?: '-',\r\n                    $row['olusturan_kullanici_adi'] ?: 'Bilinmiyor'\r\n                ], ';');\r\n            }\r\n            \r\n            fclose($output);\r\n            \r\n        } catch (Exception $e) {\r\n            echo \"Hata: \" . $e->getMessage();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Tahsilat Güncelleme\r\n     */\r\n    public function tahsilat_guncelle() {\r\n        try {\r\n            if (!function_exists('grup_modul_yetkisi_var')) {\r\n                echo 'FUNC_ERROR'; exit;\r\n            }\r\n            \r\n            if (!grup_modul_yetkisi_var(511)) {\r\n                echo 'NO_AUTH'; exit;\r\n            }\r\n\r\n            $tip = $this->input->post('tip');\r\n            $id = $this->input->post('id');\r\n            $tutar = $this->input->post('tutar');\r\n            $aciklama = $this->input->post('aciklama');\r\n            \r\n            // Parametreleri kontrol et\r\n            if(empty($tip) || empty($id)) {\r\n                echo 'MISSING_PARAMS'; exit;\r\n            }\r\n\r\n            $table = '';\r\n            $id_field = '';\r\n            $tutar_field = '';\r\n            $aciklama_field = '';\r\n            $gorsel_field = '';\r\n            $gorsel_path = '';\r\n\r\n            switch ($tip) {\r\n                case 1: // Banka\r\n                    $table = 'bankaHareketleri'; $id_field = 'bh_id'; $tutar_field = 'bh_giris'; $aciklama_field = 'bh_aciklama'; $gorsel_field = 'bh_gorsel'; $gorsel_path = './assets/uploads/dekontlar/';\r\n                    break;\r\n                case 2: // Çek\r\n                    $table = 'cek'; $id_field = 'cek_id'; $tutar_field = 'cek_tutar'; $aciklama_field = 'cek_notAciklama'; $gorsel_field = 'cek_gorsel'; $gorsel_path = './assets/uploads/cekler/';\r\n                    break;\r\n                case 3: // Kasa\r\n                    $table = 'kasaHareketleri'; $id_field = 'kh_id'; $tutar_field = 'kh_giris'; $aciklama_field = 'kh_aciklama'; $gorsel_field = 'kh_gorsel'; $gorsel_path = './assets/uploads/dekontlar/';\r\n                    break;\r\n                case 4: // Senet\r\n                    $table = 'senet'; $id_field = 'senet_id'; $tutar_field = 'senet_tutar'; $aciklama_field = 'senet_notAciklama'; $gorsel_field = 'senet_gorsel'; $gorsel_path = './assets/uploads/senetler/';\r\n                    break;\r\n                default:\r\n                    echo 'ERROR'; exit;\r\n            }\r\n\r\n            // Mevcut görseli bul\r\n            $row = $this->db->get_where($table, [$id_field => $id])->row();\r\n            $old_gorsel = $row ? $row->$gorsel_field : null;\r\n\r\n            // Dosya yükleme (Kasa tipi için görsel yükleme engellendi)\r\n            if (!empty($_FILES['gorsel']['name'])) {\r\n                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Dosya yükleme başlıyor. Tip: $tip, Dosya: \" . $_FILES['gorsel']['name'] . \"\\n\", FILE_APPEND);\r\n                \r\n                // Kasa tipi (tip=3) için görsel yükleme engelle\r\n                if ($tip == 3) {\r\n                    file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Kasa tipi için görsel yükleme engellendi\\n\", FILE_APPEND);\r\n                    echo 'KASA_GORSEL_HATASI'; exit;\r\n                }\r\n                \r\n                $config['upload_path'] = $gorsel_path;\r\n                $config['allowed_types'] = 'jpg|jpeg|png|gif|pdf';\r\n                $config['max_size'] = 4096;\r\n                $config['encrypt_name'] = TRUE;\r\n                $this->load->library('upload', $config);\r\n                \r\n                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Upload config: \" . json_encode($config) . \"\\n\", FILE_APPEND);\r\n                \r\n                if ($this->upload->do_upload('gorsel')) {\r\n                    $upload_data = $this->upload->data();\r\n                    $new_gorsel = $upload_data['file_name'];\r\n                    file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Dosya başarıyla yüklendi: $new_gorsel\\n\", FILE_APPEND);\r\n                    \r\n                    // Eski dosyayı sil\r\n                    if ($old_gorsel) {\r\n                        // Eski görsel JSON formatında ise decode et\r\n                        $old_gorsel_decoded = json_decode($old_gorsel, true);\r\n                        $old_file = is_array($old_gorsel_decoded) ? $old_gorsel_decoded[0] : $old_gorsel;\r\n                        if ($old_file && file_exists($gorsel_path . $old_file)) {\r\n                            @unlink($gorsel_path . $old_file);\r\n                            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Eski dosya silindi: $old_file\\n\", FILE_APPEND);\r\n                        }\r\n                    }\r\n                } else {\r\n                    $upload_errors = $this->upload->display_errors();\r\n                    file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Upload hatası: $upload_errors\\n\", FILE_APPEND);\r\n                    $new_gorsel = $old_gorsel;\r\n                }\r\n            } else {\r\n                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Yeni dosya yüklenmedi, mevcut görsel korunuyor\\n\", FILE_APPEND);\r\n                $new_gorsel = $old_gorsel;\r\n            }\r\n            \r\n            // Görsel alanını doğru formatta kaydet (string olarak, JSON array değil)\r\n            // Eğer mevcut değer JSON array formatındaysa decode et\r\n            if ($new_gorsel && !is_null($new_gorsel) && $new_gorsel !== '') {\r\n                $decoded = json_decode($new_gorsel, true);\r\n                if (is_array($decoded) && count($decoded) > 0) {\r\n                    // JSON array formatından string'e çevir\r\n                    $new_gorsel = $decoded[0];\r\n                }\r\n                // Dosya adı string formatında olmalı, JSON array formatında değil\r\n            }\r\n\r\n            $update = [\r\n                $tutar_field => $tutar,\r\n                $aciklama_field => $aciklama,\r\n                $gorsel_field => $new_gorsel\r\n            ];\r\n            \r\n            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Update verisi: \" . json_encode($update) . \"\\n\", FILE_APPEND);\r\n            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Tablo: $table, ID field: $id_field, ID: $id\\n\", FILE_APPEND);\r\n            \r\n            $this->db->where($id_field, $id)->update($table, $update);\r\n\r\n            if ($this->db->affected_rows() > 0) {\r\n                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Başarılı\\n\", FILE_APPEND);\r\n                echo 'OK';\r\n            } else {\r\n                file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Etkilenen satır yok\\n\", FILE_APPEND);\r\n                echo 'ERROR';\r\n            }\r\n        } catch (Exception $e) {\r\n            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Exception: \" . $e->getMessage() . \"\\n\", FILE_APPEND);\r\n            echo 'ERROR: ' . $e->getMessage();\r\n        } catch (Error $e) {\r\n            file_put_contents('./tahsilat_debug.log', date('Y-m-d H:i:s') . \" - Fatal Error: \" . $e->getMessage() . \"\\n\", FILE_APPEND);\r\n            echo 'FATAL_ERROR: ' . $e->getMessage();\r\n        }\r\n        exit;\r\n    }\r\n    \r\n    /**\r\n     * Ödeme tipi metni döndür\r\n     */\r\n    private function getOdemeTipiText($tip) {\r\n        switch($tip) {\r\n            case '1': return 'Kasa';\r\n            case '2': return 'Banka / POS';\r\n            case '3': return 'Çek';\r\n            case '4': return 'Senet';\r\n            default: return 'Bilinmiyor';\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Çek tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n     */\r\n    private function senkronizeCekler()\r\n    {\r\n        try {\r\n            // Muhasebe tablosunda olmayan çekleri bul\r\n            $ceklerQ = \"SELECT c.cek_id \r\n                        FROM cek c \r\n                        LEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id \r\n                        WHERE mtd.id IS NULL\";\r\n            \r\n            $cekler = $this->db->query($ceklerQ)->result();\r\n            \r\n            // Her çek için muhasebe tablosuna kayıt ekle\r\n            foreach($cekler as $cek) {\r\n                $data = array(\r\n                    'tahsilat_tipi' => 2, // 2 = Çek\r\n                    'kayit_id' => $cek->cek_id,\r\n                    'durum' => 1, // 1 = Onay bekliyor\r\n                    'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n                    'aciklama' => 'Çek tablosundan otomatik senkronize edildi'\r\n                );\r\n                \r\n                $this->db->insert('muhasebe_tahsilat_durum', $data);\r\n            }\r\n            \r\n            if(count($cekler) > 0) {\r\n                error_log(\"Muhasebe senkronizasyonu: \" . count($cekler) . \" çek kaydı eklendi.\");\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            error_log(\"Çek senkronizasyonu hatası: \" . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Banka hareketleri tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n     */\r\n    private function senkronizeBankaHareketleri()\r\n    {\r\n        try {\r\n            // Muhasebe tablosunda olmayan banka hareketlerini bul (sadece giriş hareketleri - tahsilat)\r\n            $bankaHareketleriQ = \"SELECT bh.bh_id \r\n                        FROM bankaHareketleri bh \r\n                        LEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id \r\n                        WHERE mtd.id IS NULL AND bh.bh_giris > 0\";\r\n            \r\n            $bankaHareketleri = $this->db->query($bankaHareketleriQ)->result();\r\n            \r\n            // Her banka hareketi için muhasebe tablosuna kayıt ekle\r\n            foreach($bankaHareketleri as $hareket) {\r\n                $data = array(\r\n                    'tahsilat_tipi' => 1, // 1 = Banka\r\n                    'kayit_id' => $hareket->bh_id,\r\n                    'durum' => 1, // 1 = Onay bekliyor\r\n                    'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n                    'aciklama' => 'Banka hareketleri tablosundan otomatik senkronize edildi'\r\n                );\r\n                \r\n                $this->db->insert('muhasebe_tahsilat_durum', $data);\r\n            }\r\n            \r\n            if(count($bankaHareketleri) > 0) {\r\n                error_log(\"Muhasebe senkronizasyonu: \" . count($bankaHareketleri) . \" banka hareketi kaydı eklendi.\");\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            error_log(\"Banka hareketleri senkronizasyonu hatası: \" . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Kasa hareketleri tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n     * Açılış bakiyesi kayıtları hariç tutulur\r\n     */\r\n    private function senkronizeKasaHareketleri()\r\n    {\r\n        try {\r\n            // Muhasebe tablosunda olmayan kasa hareketlerini bul (sadece giriş hareketleri - tahsilat)\r\n            // Açılış bakiyesi kayıtlarını hariç tut\r\n            $kasaHareketleriQ = \"SELECT kh.kh_id \r\n                        FROM kasaHareketleri kh \r\n                        LEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id \r\n                        WHERE mtd.id IS NULL \r\n                        AND kh.kh_giris > 0 \r\n                        AND (kh.kh_aciklama IS NULL OR kh.kh_aciklama NOT LIKE '%Açılış Bakiyesi%')\r\n                        AND (kh.kh_aciklama IS NULL OR kh.kh_aciklama NOT LIKE '%Otomatik Oluşturulan%')\";\r\n            \r\n            $kasaHareketleri = $this->db->query($kasaHareketleriQ)->result();\r\n            \r\n            // Her kasa hareketi için muhasebe tablosuna kayıt ekle\r\n            foreach($kasaHareketleri as $hareket) {\r\n                $data = array(\r\n                    'tahsilat_tipi' => 3, // 3 = Kasa\r\n                    'kayit_id' => $hareket->kh_id,\r\n                    'durum' => 1, // 1 = Onay bekliyor\r\n                    'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n                    'aciklama' => 'Kasa hareketleri tablosundan otomatik senkronize edildi'\r\n                );\r\n                \r\n                $this->db->insert('muhasebe_tahsilat_durum', $data);\r\n            }\r\n            \r\n            if(count($kasaHareketleri) > 0) {\r\n                error_log(\"Muhasebe senkronizasyonu: \" . count($kasaHareketleri) . \" kasa hareketi kaydı eklendi.\");\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            error_log(\"Kasa hareketleri senkronizasyonu hatası: \" . $e->getMessage());\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Senet tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n     */\r\n    private function senkronizeSenetler()\r\n    {\r\n        try {\r\n            // Muhasebe tablosunda olmayan senetleri bul\r\n            $senetlerQ = \"SELECT s.senet_id \r\n                        FROM senet s \r\n                        LEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id \r\n                        WHERE mtd.id IS NULL\";\r\n            \r\n            $senetler = $this->db->query($senetlerQ)->result();\r\n            \r\n            // Her senet için muhasebe tablosuna kayıt ekle\r\n            foreach($senetler as $senet) {\r\n                $data = array(\r\n                    'tahsilat_tipi' => 4, // 4 = Senet\r\n                    'kayit_id' => $senet->senet_id,\r\n                    'durum' => 1, // 1 = Onay bekliyor\r\n                    'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n                    'aciklama' => 'Senet tablosundan otomatik senkronize edildi'\r\n                );\r\n                \r\n                $this->db->insert('muhasebe_tahsilat_durum', $data);\r\n            }\r\n            \r\n            if(count($senetler) > 0) {\r\n                error_log(\"Muhasebe senkronizasyonu: \" . count($senetler) . \" senet kaydı eklendi.\");\r\n            }\r\n            \r\n        } catch (Exception $e) {\r\n            error_log(\"Senet senkronizasyonu hatası: \" . $e->getMessage());\r\n        }\r\n    }\r\n}\r\n"
        }
    ]
}