{
    "sourceFile": "application/controllers/Aktivasyon.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1757426227633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1757427668865,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -257,10 +257,71 @@\n         $this->load->view('aktivasyon/ssport_olustur', $data);\r\n \r\n     }\r\n \r\n+    public function ssport_kaydet()\r\n+    {\r\n+        // S SPORT Aktivasyon oluştur yetkisi kontrolü (ID: 903)\r\n+        if (!grup_modul_yetkisi_var(903)) {\r\n+            redirect(\"home/hata\");\r\n+        }\r\n \r\n+        $aktivasyon_id = $this->input->post('aktivasyon_id');\r\n+        $cari_id = $this->input->post('cari_id');\r\n+        $uye_no = $this->input->post('uye_no');\r\n+        $kampanya_kodu = $this->input->post('kampanya_kodu');\r\n+        $aktivasyon_tarihi = $this->input->post('aktivasyon_tarihi');\r\n+        $eposta = $this->input->post('eposta');\r\n+        $telefon = $this->input->post('telefon');\r\n+        $adi = $this->input->post('adi');\r\n+        $soyadi = $this->input->post('soyadi');\r\n+        $aciklama = $this->input->post('aciklama');\r\n+        $durum_id = $this->input->post('durum_id');\r\n \r\n+        // Kullanıcı ID'sini session'dan al\r\n+        $control = session(\"r\", \"login_info\");\r\n+        $kullanici_id = $control->kullanici_id;\r\n+\r\n+        $data = array(\r\n+            'aktivasyon_cari_id' => $cari_id,\r\n+            'aktivasyon_uye_no' => $uye_no,\r\n+            'aktivasyon_kampanya_kodu' => $kampanya_kodu,\r\n+            'aktivasyon_tarihi' => $aktivasyon_tarihi ? date('Y-m-d H:i:s', strtotime($aktivasyon_tarihi)) : null,\r\n+            'aktivasyon_eposta' => $eposta,\r\n+            'aktivasyon_telefon' => $telefon,\r\n+            'aktivasyon_adi' => $adi,\r\n+            'aktivasyon_soyad' => $soyadi,\r\n+            'kullanici_id' => $kullanici_id,\r\n+            'aktivasyon_aciklama' => $aciklama,\r\n+            'aktivasyon_durum_id' => $durum_id\r\n+        );\r\n+\r\n+        if ($aktivasyon_id) {\r\n+            // Güncelleme\r\n+            $where = array('aktivasyon_id' => $aktivasyon_id);\r\n+            $result = $this->vt->update('aktivasyon', $where, $data);\r\n+            \r\n+            if ($result) {\r\n+                $this->session->set_flashdata('success', 'S SPORT Aktivasyon başarıyla güncellendi.');\r\n+            } else {\r\n+                $this->session->set_flashdata('error', 'S SPORT Aktivasyon güncellenirken bir hata oluştu.');\r\n+            }\r\n+        } else {\r\n+            // Yeni kayıt\r\n+            $result = $this->vt->insert('aktivasyon', $data);\r\n+            \r\n+            if ($result) {\r\n+                $this->session->set_flashdata('success', 'S SPORT Aktivasyon başarıyla oluşturuldu.');\r\n+            } else {\r\n+                $this->session->set_flashdata('error', 'S SPORT Aktivasyon oluşturulurken bir hata oluştu.');\r\n+            }\r\n+        }\r\n+\r\n+        redirect('aktivasyon');\r\n+    }\r\n+\r\n+\r\n+\r\n     public function kaydet()\r\n \r\n     {\r\n \r\n"
                },
                {
                    "date": 1757427947200,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -291,9 +291,10 @@\n             'aktivasyon_adi' => $adi,\r\n             'aktivasyon_soyad' => $soyadi,\r\n             'kullanici_id' => $kullanici_id,\r\n             'aktivasyon_aciklama' => $aciklama,\r\n-            'aktivasyon_durum_id' => $durum_id\r\n+            'aktivasyon_durum_id' => $durum_id,\r\n+            'aktivasyon_stok' => 2  // S SPORT için her zaman 2 (1-DIGITURK, 2-S SPORT, 3-TABII, 4-EXXEN)\r\n         );\r\n \r\n         if ($aktivasyon_id) {\r\n             // Güncelleme\r\n"
                },
                {
                    "date": 1757430392674,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -123,9 +123,9 @@\n         }\r\n \r\n \r\n \r\n-        $data[\"baslik\"] = $aktivasyon_id ? \"Aktivasyon / Düzenle\" : \"Aktivasyon / Oluştur\";\r\n+        $data[\"baslik\"] = $aktivasyon_id ? \"Digiturk Aktivasyon / Düzenle\" : \"Digiturk Aktivasyon / Oluştur\";\r\n \r\n         \r\n \r\n         // Cari listesi - Ana hesap kısıtlaması kaldırıldı\r\n@@ -373,10 +373,12 @@\n             'kullanici_id' => $kullanici_id,\r\n \r\n             'aktivasyon_aciklama' => $aciklama,\r\n \r\n-            'aktivasyon_durum_id' => $durum_id\r\n+            'aktivasyon_durum_id' => $durum_id,\r\n \r\n+            'aktivasyon_stok' => 1  // DIGITURK için her zaman 1 (1-DIGITURK, 2-S SPORT, 3-TABII, 4-EXXEN)\r\n+\r\n         );\r\n \r\n \r\n \r\n@@ -391,13 +393,13 @@\n             \r\n \r\n             if ($result) {\r\n \r\n-                $this->session->set_flashdata('success', 'Aktivasyon başarıyla güncellendi.');\r\n+                $this->session->set_flashdata('success', 'Digiturk Aktivasyon başarıyla güncellendi.');\r\n \r\n             } else {\r\n \r\n-                $this->session->set_flashdata('error', 'Aktivasyon güncellenirken bir hata oluştu.');\r\n+                $this->session->set_flashdata('error', 'Digiturk Aktivasyon güncellenirken bir hata oluştu.');\r\n \r\n             }\r\n \r\n         } else {\r\n@@ -409,13 +411,13 @@\n             \r\n \r\n             if ($result) {\r\n \r\n-                $this->session->set_flashdata('success', 'Aktivasyon başarıyla oluşturuldu.');\r\n+                $this->session->set_flashdata('success', 'Digiturk Aktivasyon başarıyla oluşturuldu.');\r\n \r\n             } else {\r\n \r\n-                $this->session->set_flashdata('error', 'Aktivasyon oluşturulurken bir hata oluştu.');\r\n+                $this->session->set_flashdata('error', 'Digiturk Aktivasyon oluşturulurken bir hata oluştu.');\r\n \r\n             }\r\n \r\n         }\r\n@@ -491,9 +493,9 @@\n \r\n \r\n         if ($result) {\r\n \r\n-            $this->session->set_flashdata('success', 'Aktivasyon başarıyla silindi.');\r\n+            $this->session->set_flashdata('success', 'Digiturk Aktivasyon başarıyla silindi.');\r\n \r\n         } else {\r\n \r\n             $this->session->set_flashdata('error', 'Aktivasyon silinirken bir hata oluştu.');\r\n"
                },
                {
                    "date": 1757430994459,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -257,8 +257,82 @@\n         $this->load->view('aktivasyon/ssport_olustur', $data);\r\n \r\n     }\r\n \r\n+    public function tabii_olustur($aktivasyon_id = null)\r\n+\r\n+    {\r\n+\r\n+        // TABII Aktivasyon oluştur yetkisi kontrolü (ID: 904)\r\n+\r\n+        if (!grup_modul_yetkisi_var(904)) {\r\n+\r\n+            redirect(\"home/hata\");\r\n+\r\n+        }\r\n+\r\n+\r\n+\r\n+        $data[\"baslik\"] = $aktivasyon_id ? \"TABII Aktivasyon / Düzenle\" : \"TABII Aktivasyon / Oluştur\";\r\n+\r\n+        \r\n+\r\n+        // Cari listesi - Ana hesap kısıtlaması kaldırıldı\r\n+\r\n+        $cariQuery = \"SELECT c.cari_id, c.cari_ad, c.cari_firmaTelefon, \r\n+\r\n+                             i.il as il_adi, ilce.ilce as ilce_adi\r\n+\r\n+                      FROM cari c\r\n+\r\n+                      LEFT JOIN iller i ON c.cari_il = i.id\r\n+\r\n+                      LEFT JOIN ilceler ilce ON c.cari_ilce = ilce.id\r\n+\r\n+                      WHERE c.cari_durum = 1 \r\n+\r\n+                      ORDER BY c.cari_ad ASC\";\r\n+\r\n+        $data[\"cari_listesi\"] = $this->db->query($cariQuery)->result();\r\n+\r\n+\r\n+\r\n+        // Aktivasyon durum listesi\r\n+\r\n+        $durumQuery = \"SELECT aktivasyon_durum_id, aktivasyon_durum_adi FROM aktivasyon_durum WHERE durum = 1 ORDER BY aktivasyon_durum_adi ASC\";\r\n+\r\n+        $data[\"durum_listesi\"] = $this->db->query($durumQuery)->result();\r\n+\r\n+\r\n+\r\n+        // Düzenleme modu ise mevcut veriyi çek\r\n+\r\n+        if ($aktivasyon_id) {\r\n+\r\n+            $aktivasyonQuery = \"SELECT * FROM aktivasyon WHERE aktivasyon_id = ?\";\r\n+\r\n+            $aktivasyon = $this->db->query($aktivasyonQuery, array($aktivasyon_id))->row();\r\n+\r\n+            \r\n+\r\n+            if (!$aktivasyon) {\r\n+\r\n+                redirect(\"aktivasyon\");\r\n+\r\n+            }\r\n+\r\n+            \r\n+\r\n+            $data[\"aktivasyon\"] = $aktivasyon;\r\n+\r\n+        }\r\n+\r\n+\r\n+\r\n+        $this->load->view('aktivasyon/tabii_olustur', $data);\r\n+\r\n+    }\r\n+\r\n     public function ssport_kaydet()\r\n     {\r\n         // S SPORT Aktivasyon oluştur yetkisi kontrolü (ID: 903)\r\n         if (!grup_modul_yetkisi_var(903)) {\r\n@@ -319,10 +393,72 @@\n \r\n         redirect('aktivasyon');\r\n     }\r\n \r\n+    public function tabii_kaydet()\r\n+    {\r\n+        // TABII Aktivasyon oluştur yetkisi kontrolü (ID: 904)\r\n+        if (!grup_modul_yetkisi_var(904)) {\r\n+            redirect(\"home/hata\");\r\n+        }\r\n \r\n+        $aktivasyon_id = $this->input->post('aktivasyon_id');\r\n+        $cari_id = $this->input->post('cari_id');\r\n+        $uye_no = $this->input->post('uye_no');\r\n+        $kampanya_kodu = $this->input->post('kampanya_kodu');\r\n+        $aktivasyon_tarihi = $this->input->post('aktivasyon_tarihi');\r\n+        $eposta = $this->input->post('eposta');\r\n+        $telefon = $this->input->post('telefon');\r\n+        $adi = $this->input->post('adi');\r\n+        $soyadi = $this->input->post('soyadi');\r\n+        $aciklama = $this->input->post('aciklama');\r\n+        $durum_id = $this->input->post('durum_id');\r\n \r\n+        // Kullanıcı ID'sini session'dan al\r\n+        $control = session(\"r\", \"login_info\");\r\n+        $kullanici_id = $control->kullanici_id;\r\n+\r\n+        $data = array(\r\n+            'aktivasyon_cari_id' => $cari_id,\r\n+            'aktivasyon_uye_no' => $uye_no,\r\n+            'aktivasyon_kampanya_kodu' => $kampanya_kodu,\r\n+            'aktivasyon_tarihi' => $aktivasyon_tarihi ? date('Y-m-d H:i:s', strtotime($aktivasyon_tarihi)) : null,\r\n+            'aktivasyon_eposta' => $eposta,\r\n+            'aktivasyon_telefon' => $telefon,\r\n+            'aktivasyon_adi' => $adi,\r\n+            'aktivasyon_soyad' => $soyadi,\r\n+            'kullanici_id' => $kullanici_id,\r\n+            'aktivasyon_aciklama' => $aciklama,\r\n+            'aktivasyon_durum_id' => $durum_id,\r\n+            'aktivasyon_stok' => 3  // TABII için her zaman 3 (1-DIGITURK, 2-S SPORT, 3-TABII, 4-EXXEN)\r\n+        );\r\n+\r\n+        if ($aktivasyon_id) {\r\n+            // Güncelleme\r\n+            $where = array('aktivasyon_id' => $aktivasyon_id);\r\n+            $result = $this->vt->update('aktivasyon', $where, $data);\r\n+            \r\n+            if ($result) {\r\n+                $this->session->set_flashdata('success', 'TABII Aktivasyon başarıyla güncellendi.');\r\n+            } else {\r\n+                $this->session->set_flashdata('error', 'TABII Aktivasyon güncellenirken bir hata oluştu.');\r\n+            }\r\n+        } else {\r\n+            // Yeni kayıt\r\n+            $result = $this->vt->insert('aktivasyon', $data);\r\n+            \r\n+            if ($result) {\r\n+                $this->session->set_flashdata('success', 'TABII Aktivasyon başarıyla oluşturuldu.');\r\n+            } else {\r\n+                $this->session->set_flashdata('error', 'TABII Aktivasyon oluşturulurken bir hata oluştu.');\r\n+            }\r\n+        }\r\n+\r\n+        redirect('aktivasyon');\r\n+    }\r\n+\r\n+\r\n+\r\n     public function kaydet()\r\n \r\n     {\r\n \r\n"
                }
            ],
            "date": 1757426227633,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') or exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Aktivasyon extends CI_Controller\r\n\r\n{\r\n\r\n    public function __construct()\r\n\r\n    {\r\n\r\n        parent::__construct();\r\n\r\n        $this->load->model('vt');\r\n\r\n        $this->load->library('session');\r\n\r\n        $this->load->helper('url');\r\n\r\n        $this->load->database();\r\n\r\n\r\n\r\n        $control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n        // GIB yetki kontrolünü güvenli hale getir\r\n\r\n        $gib_yetki = 0;\r\n\r\n        try {\r\n\r\n            $gib_yetki = gibYetki();\r\n\r\n        } catch (Exception $e) {\r\n\r\n            error_log(\"GIB Yetki kontrolü hatası: \" . $e->getMessage());\r\n\r\n            $gib_yetki = 0;\r\n\r\n        }\r\n\r\n\r\n\r\n        if ($gib_yetki == 1)\r\n\r\n            redirect(\"home/hata\");\r\n\r\n\r\n\r\n        if (!$control) {\r\n\r\n            redirect(\"check\");\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    public function index()\r\n\r\n    {\r\n\r\n        // Aktivasyon ana menü yetkisi kontrolü (ID: 900)\r\n\r\n        if (!grup_modul_yetkisi_var(900)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = \"Aktivasyon / Ana Sayfa\";\r\n\r\n        \r\n\r\n        // Son 10 aktivasyonu çek\r\n\r\n        $aktivasyonQuery = \"\r\n\r\n            SELECT a.*, c.cari_ad, ad.aktivasyon_durum_adi, ad.aktivasyon_durum_renk, k.kullanici_ad\r\n\r\n            FROM aktivasyon a\r\n\r\n            LEFT JOIN cari c ON a.aktivasyon_cari_id = c.cari_id\r\n\r\n            LEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id\r\n\r\n            LEFT JOIN kullanicilar k ON a.kullanici_id = k.kullanici_id\r\n\r\n            ORDER BY a.olusturma_tarihi DESC\r\n\r\n            LIMIT 10\r\n\r\n        \";\r\n\r\n        $data[\"aktivasyonlar\"] = $this->db->query($aktivasyonQuery)->result();\r\n\r\n        \r\n\r\n        $this->load->view('aktivasyon/index', $data);\r\n\r\n    }\r\n\r\n\r\n\r\n    public function olustur($aktivasyon_id = null)\r\n\r\n    {\r\n\r\n        // Aktivasyon oluştur yetkisi kontrolü (ID: 901)\r\n\r\n        if (!grup_modul_yetkisi_var(901)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = $aktivasyon_id ? \"Aktivasyon / Düzenle\" : \"Aktivasyon / Oluştur\";\r\n\r\n        \r\n\r\n        // Cari listesi - Ana hesap kısıtlaması kaldırıldı\r\n\r\n        $cariQuery = \"SELECT c.cari_id, c.cari_ad, c.cari_firmaTelefon, \r\n\r\n                             i.il as il_adi, ilce.ilce as ilce_adi\r\n\r\n                      FROM cari c\r\n\r\n                      LEFT JOIN iller i ON c.cari_il = i.id\r\n\r\n                      LEFT JOIN ilceler ilce ON c.cari_ilce = ilce.id\r\n\r\n                      WHERE c.cari_durum = 1 \r\n\r\n                      ORDER BY c.cari_ad ASC\";\r\n\r\n        $data[\"cari_listesi\"] = $this->db->query($cariQuery)->result();\r\n\r\n\r\n\r\n        // Aktivasyon durum listesi\r\n\r\n        $durumQuery = \"SELECT aktivasyon_durum_id, aktivasyon_durum_adi FROM aktivasyon_durum WHERE durum = 1 ORDER BY aktivasyon_durum_adi ASC\";\r\n\r\n        $data[\"durum_listesi\"] = $this->db->query($durumQuery)->result();\r\n\r\n\r\n\r\n        // Düzenleme modu ise mevcut veriyi çek\r\n\r\n        if ($aktivasyon_id) {\r\n\r\n            $aktivasyonQuery = \"SELECT * FROM aktivasyon WHERE aktivasyon_id = ?\";\r\n\r\n            $aktivasyon = $this->db->query($aktivasyonQuery, array($aktivasyon_id))->row();\r\n\r\n            \r\n\r\n            if (!$aktivasyon) {\r\n\r\n                redirect(\"aktivasyon\");\r\n\r\n            }\r\n\r\n            \r\n\r\n            $data[\"aktivasyon\"] = $aktivasyon;\r\n\r\n        }\r\n\r\n\r\n\r\n        $this->load->view('aktivasyon/olustur', $data);\r\n\r\n    }\r\n\r\n    public function ssport_olustur($aktivasyon_id = null)\r\n\r\n    {\r\n\r\n        // S SPORT Aktivasyon oluştur yetkisi kontrolü (ID: 903)\r\n\r\n        if (!grup_modul_yetkisi_var(903)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = $aktivasyon_id ? \"S SPORT Aktivasyon / Düzenle\" : \"S SPORT Aktivasyon / Oluştur\";\r\n\r\n        \r\n\r\n        // Cari listesi - Ana hesap kısıtlaması kaldırıldı\r\n\r\n        $cariQuery = \"SELECT c.cari_id, c.cari_ad, c.cari_firmaTelefon, \r\n\r\n                             i.il as il_adi, ilce.ilce as ilce_adi\r\n\r\n                      FROM cari c\r\n\r\n                      LEFT JOIN iller i ON c.cari_il = i.id\r\n\r\n                      LEFT JOIN ilceler ilce ON c.cari_ilce = ilce.id\r\n\r\n                      WHERE c.cari_durum = 1 \r\n\r\n                      ORDER BY c.cari_ad ASC\";\r\n\r\n        $data[\"cari_listesi\"] = $this->db->query($cariQuery)->result();\r\n\r\n\r\n\r\n        // Aktivasyon durum listesi\r\n\r\n        $durumQuery = \"SELECT aktivasyon_durum_id, aktivasyon_durum_adi FROM aktivasyon_durum WHERE durum = 1 ORDER BY aktivasyon_durum_adi ASC\";\r\n\r\n        $data[\"durum_listesi\"] = $this->db->query($durumQuery)->result();\r\n\r\n\r\n\r\n        // Düzenleme modu ise mevcut veriyi çek\r\n\r\n        if ($aktivasyon_id) {\r\n\r\n            $aktivasyonQuery = \"SELECT * FROM aktivasyon WHERE aktivasyon_id = ?\";\r\n\r\n            $aktivasyon = $this->db->query($aktivasyonQuery, array($aktivasyon_id))->row();\r\n\r\n            \r\n\r\n            if (!$aktivasyon) {\r\n\r\n                redirect(\"aktivasyon\");\r\n\r\n            }\r\n\r\n            \r\n\r\n            $data[\"aktivasyon\"] = $aktivasyon;\r\n\r\n        }\r\n\r\n\r\n\r\n        $this->load->view('aktivasyon/ssport_olustur', $data);\r\n\r\n    }\r\n\r\n\r\n\r\n    public function kaydet()\r\n\r\n    {\r\n\r\n        // Aktivasyon oluştur yetkisi kontrolü (ID: 901)\r\n\r\n        if (!grup_modul_yetkisi_var(901)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $aktivasyon_id = $this->input->post('aktivasyon_id');\r\n\r\n        $cari_id = $this->input->post('cari_id');\r\n\r\n        $uye_no = $this->input->post('uye_no');\r\n\r\n        $kutu_no = $this->input->post('kutu_no');\r\n\r\n        $kart_no = $this->input->post('kart_no');\r\n\r\n        $aciklama = $this->input->post('aciklama');\r\n\r\n        $durum_id = $this->input->post('durum_id');\r\n\r\n\r\n\r\n        // Kullanıcı ID'sini session'dan al\r\n\r\n        $control = session(\"r\", \"login_info\");\r\n\r\n        $kullanici_id = $control->kullanici_id;\r\n\r\n\r\n\r\n        $data = array(\r\n\r\n            'aktivasyon_cari_id' => $cari_id,\r\n\r\n            'aktivasyon_uye_no' => $uye_no,\r\n\r\n            'aktivasyon_kutu_no' => $kutu_no,\r\n\r\n            'aktivasyon_kart_no' => $kart_no,\r\n\r\n            'kullanici_id' => $kullanici_id,\r\n\r\n            'aktivasyon_aciklama' => $aciklama,\r\n\r\n            'aktivasyon_durum_id' => $durum_id\r\n\r\n        );\r\n\r\n\r\n\r\n        if ($aktivasyon_id) {\r\n\r\n            // Güncelleme\r\n\r\n            $where = array('aktivasyon_id' => $aktivasyon_id);\r\n\r\n            $result = $this->vt->update('aktivasyon', $where, $data);\r\n\r\n            \r\n\r\n            if ($result) {\r\n\r\n                $this->session->set_flashdata('success', 'Aktivasyon başarıyla güncellendi.');\r\n\r\n            } else {\r\n\r\n                $this->session->set_flashdata('error', 'Aktivasyon güncellenirken bir hata oluştu.');\r\n\r\n            }\r\n\r\n        } else {\r\n\r\n            // Yeni kayıt\r\n\r\n            $result = $this->vt->insert('aktivasyon', $data);\r\n\r\n            \r\n\r\n            if ($result) {\r\n\r\n                $this->session->set_flashdata('success', 'Aktivasyon başarıyla oluşturuldu.');\r\n\r\n            } else {\r\n\r\n                $this->session->set_flashdata('error', 'Aktivasyon oluşturulurken bir hata oluştu.');\r\n\r\n            }\r\n\r\n        }\r\n\r\n\r\n\r\n        redirect('aktivasyon');\r\n\r\n    }\r\n\r\n\r\n\r\n    public function listele()\r\n\r\n    {\r\n\r\n        // Aktivasyon listesi yetkisi kontrolü (ID: 902)\r\n\r\n        if (!grup_modul_yetkisi_var(902)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = \"Aktivasyon / Liste\";\r\n\r\n        \r\n\r\n        $aktivasyonQuery = \"\r\n\r\n            SELECT a.*, c.cari_ad, ad.aktivasyon_durum_adi, ad.aktivasyon_durum_renk, k.kullanici_ad\r\n\r\n            FROM aktivasyon a\r\n\r\n            LEFT JOIN cari c ON a.aktivasyon_cari_id = c.cari_id\r\n\r\n            LEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id\r\n\r\n            LEFT JOIN kullanicilar k ON a.kullanici_id = k.kullanici_id\r\n\r\n            ORDER BY a.olusturma_tarihi DESC\r\n\r\n        \";\r\n\r\n        $data[\"aktivasyonlar\"] = $this->db->query($aktivasyonQuery)->result();\r\n\r\n\r\n\r\n        $this->load->view('aktivasyon/listele', $data);\r\n\r\n    }\r\n\r\n\r\n\r\n    public function sil($aktivasyon_id)\r\n\r\n    {\r\n\r\n        // Aktivasyon oluştur yetkisi kontrolü (ID: 901)\r\n\r\n        if (!grup_modul_yetkisi_var(901)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $result = $this->vt->del('aktivasyon', 'aktivasyon_id', $aktivasyon_id);\r\n\r\n\r\n\r\n        if ($result) {\r\n\r\n            $this->session->set_flashdata('success', 'Aktivasyon başarıyla silindi.');\r\n\r\n        } else {\r\n\r\n            $this->session->set_flashdata('error', 'Aktivasyon silinirken bir hata oluştu.');\r\n\r\n        }\r\n\r\n\r\n\r\n        redirect('aktivasyon');\r\n\r\n    }\r\n\r\n\r\n\r\n    // AJAX için cari arama\r\n\r\n    public function cari_ara()\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            $term = $this->input->get('q');\r\n\r\n            \r\n\r\n            $query = \"SELECT c.cari_id, c.cari_ad, c.cari_firmaTelefon, \r\n\r\n                             i.il as il_adi, ilce.ilce as ilce_adi\r\n\r\n                      FROM cari c\r\n\r\n                      LEFT JOIN iller i ON c.cari_il = i.id\r\n\r\n                      LEFT JOIN ilceler ilce ON c.cari_ilce = ilce.id\r\n\r\n                      WHERE c.cari_durum = 1 \r\n\r\n                      AND c.cari_ad LIKE ? \r\n\r\n                      ORDER BY c.cari_ad ASC \r\n\r\n                      LIMIT 20\";\r\n\r\n            \r\n\r\n            $result = $this->db->query($query, array(\"%$term%\"))->result();\r\n\r\n            \r\n\r\n            $data = array();\r\n\r\n            foreach ($result as $row) {\r\n\r\n                $displayText = $row->cari_ad;\r\n\r\n                \r\n\r\n                // İl, İlçe ve Telefon bilgilerini ekle\r\n\r\n                $extraInfo = array();\r\n\r\n                if (!empty($row->il_adi)) {\r\n\r\n                    $extraInfo[] = $row->il_adi;\r\n\r\n                }\r\n\r\n                if (!empty($row->ilce_adi)) {\r\n\r\n                    $extraInfo[] = $row->ilce_adi;\r\n\r\n                }\r\n\r\n                if (!empty($row->cari_firmaTelefon)) {\r\n\r\n                    $extraInfo[] = $row->cari_firmaTelefon;\r\n\r\n                }\r\n\r\n                \r\n\r\n                if (!empty($extraInfo)) {\r\n\r\n                    $displayText .= ' (' . implode(', ', $extraInfo) . ')';\r\n\r\n                }\r\n\r\n                \r\n\r\n                $data[] = array(\r\n\r\n                    'id' => $row->cari_id,\r\n\r\n                    'text' => $displayText\r\n\r\n                );\r\n\r\n            }\r\n\r\n            \r\n\r\n            header('Content-Type: application/json');\r\n\r\n            echo json_encode($data);\r\n\r\n        } catch (Exception $e) {\r\n\r\n            header('Content-Type: application/json');\r\n\r\n            echo json_encode(array('error' => $e->getMessage()));\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    // AJAX için cari detayları getir\r\n\r\n    public function cari_detay_getir()\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            $cari_id = $this->input->get('cari_id');\r\n\r\n            \r\n\r\n            if (!$cari_id) {\r\n\r\n                header('Content-Type: application/json');\r\n\r\n                echo json_encode(array('error' => 'Cari ID gerekli'));\r\n\r\n                return;\r\n\r\n            }\r\n\r\n            \r\n\r\n            // Cari bilgilerini personel ve evrak/görsel bilgileriyle birlikte getir\r\n\r\n            $query = \"SELECT c.cari_id, c.cari_ad, c.cari_olusturan, c.evrak_dosya, c.fotograf_dosya,\r\n\r\n                             k.kullanici_ad, k.kullanici_soyad\r\n\r\n                      FROM cari c\r\n\r\n                      LEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n\r\n                      WHERE c.cari_id = ? AND c.cari_durum = 1\";\r\n\r\n            \r\n\r\n            $result = $this->db->query($query, array($cari_id))->row();\r\n\r\n            \r\n\r\n            if (!$result) {\r\n\r\n                header('Content-Type: application/json');\r\n\r\n                echo json_encode(array('error' => 'Cari bulunamadı'));\r\n\r\n                return;\r\n\r\n            }\r\n\r\n\r\n\r\n            // Satış faturası bilgilerini getir (en son kaydı)\r\n\r\n            $satisQuery = \"SELECT satis_id, satis_kdvToplam, satis_aciklama, satis_dosya\r\n\r\n                          FROM satisFaturasi \r\n\r\n                          WHERE satis_cariID = ? \r\n\r\n                          ORDER BY satis_id DESC \r\n\r\n                          LIMIT 1\";\r\n\r\n            \r\n\r\n            $satisResult = $this->db->query($satisQuery, array($cari_id))->row();\r\n\r\n            \r\n\r\n            // Personel adı soyadı birleştir\r\n\r\n            $personel_adi = '';\r\n\r\n            if (!empty($result->kullanici_ad) || !empty($result->kullanici_soyad)) {\r\n\r\n                $personel_adi = trim($result->kullanici_ad . ' ' . $result->kullanici_soyad);\r\n\r\n            }\r\n\r\n            \r\n\r\n            // Evrak dosyalarını parse et\r\n\r\n            $evrak_dosyalar = array();\r\n\r\n            if (!empty($result->evrak_dosya)) {\r\n\r\n                $evraklar = explode(',', $result->evrak_dosya);\r\n\r\n                foreach ($evraklar as $evrak) {\r\n\r\n                    $evrak = trim($evrak);\r\n\r\n                    if (!empty($evrak)) {\r\n\r\n                        $evrak_dosyalar[] = array(\r\n\r\n                            'dosya' => $evrak,\r\n\r\n                            'link' => base_url('assets/uploads/' . $evrak)\r\n\r\n                        );\r\n\r\n                    }\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n            // Fotoğraf dosyalarını parse et\r\n\r\n            $fotograf_dosyalar = array();\r\n\r\n            if (!empty($result->fotograf_dosya)) {\r\n\r\n                $fotograflar = explode(',', $result->fotograf_dosya);\r\n\r\n                foreach ($fotograflar as $fotograf) {\r\n\r\n                    $fotograf = trim($fotograf);\r\n\r\n                    if (!empty($fotograf)) {\r\n\r\n                        $fotograf_dosyalar[] = array(\r\n\r\n                            'dosya' => $fotograf,\r\n\r\n                            'link' => base_url('assets/uploads/' . $fotograf)\r\n\r\n                        );\r\n\r\n                    }\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n            // Sözleşme görsel dosyalarını parse et\r\n\r\n            $sozlesme_dosyalar = array();\r\n\r\n            if ($satisResult && !empty($satisResult->satis_dosya)) {\r\n\r\n                $sozlesmeDosyalar = explode(',', $satisResult->satis_dosya);\r\n\r\n                foreach ($sozlesmeDosyalar as $sozlesmeDosya) {\r\n\r\n                    $sozlesmeDosya = trim($sozlesmeDosya);\r\n\r\n                    if (!empty($sozlesmeDosya)) {\r\n\r\n                        $sozlesme_dosyalar[] = array(\r\n\r\n                            'dosya' => $sozlesmeDosya,\r\n\r\n                            'link' => base_url('assets/uploads/' . $sozlesmeDosya)\r\n\r\n                        );\r\n\r\n                    }\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n            // Tahsilat bilgilerini getir (muhasebe_tahsilat_durum tablosundan)\r\n\r\n            $tahsilatlar = array();\r\n\r\n            \r\n\r\n            // Önce tablo varlığını kontrol et\r\n\r\n            $tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n\r\n            \r\n\r\n            if ($tableExists > 0) {\r\n\r\n                $tahsilatQuery = \"SELECT \r\n\r\n                                   mtd.id,\r\n\r\n                                   mtd.tahsilat_tipi,\r\n\r\n                                   mtd.kayit_id,\r\n\r\n                                   CASE \r\n\r\n                                       WHEN mtd.tahsilat_tipi = 1 THEN 'Banka'\r\n\r\n                                       WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n                                       WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa'\r\n\r\n                                       WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n                                       ELSE 'Bilinmiyor'\r\n\r\n                                   END as tahsilat_tipi_adi,\r\n\r\n                                   mtd.durum,\r\n\r\n                                   CASE \r\n\r\n                                       WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n                                       WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n                                       WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n                                       ELSE 'Bilinmiyor'\r\n\r\n                                   END as durum_adi,\r\n\r\n                                   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n\r\n                                   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as gorsel,\r\n\r\n                                   mtd.olusturma_tarihi\r\n\r\n                                FROM muhasebe_tahsilat_durum mtd\r\n\r\n                                -- Banka hareketleri\r\n\r\n                                LEFT JOIN bankaHareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\r\n                                LEFT JOIN cari bh_cari ON bh.bh_cariID = bh_cari.cari_id\r\n\r\n                                -- Çek\r\n\r\n                                LEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n\r\n                                LEFT JOIN cari c_cari ON c.cek_cariID = c_cari.cari_id\r\n\r\n                                -- Kasa hareketleri\r\n\r\n                                LEFT JOIN kasaHareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\r\n                                LEFT JOIN cari kh_cari ON kh.kh_cariID = kh_cari.cari_id\r\n\r\n                                -- Senet\r\n\r\n                                LEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n\r\n                                LEFT JOIN cari s_cari ON s.senet_cariID = s_cari.cari_id\r\n\r\n                                WHERE (bh_cari.cari_id = ? OR c_cari.cari_id = ? OR kh_cari.cari_id = ? OR s_cari.cari_id = ?)\r\n\r\n                                AND mtd.tahsilat_tipi IN (1, 2, 3, 4)\r\n\r\n                                ORDER BY mtd.olusturma_tarihi DESC\";\r\n\r\n                                \r\n\r\n                try {\r\n\r\n                    $tahsilatResult = $this->db->query($tahsilatQuery, array($cari_id, $cari_id, $cari_id, $cari_id))->result();\r\n\r\n                    \r\n\r\n                    foreach ($tahsilatResult as $tahsilat) {\r\n\r\n                        $gorsel_link = '';\r\n\r\n                        if (!empty($tahsilat->gorsel)) {\r\n\r\n                            // Tahsilat tipine göre doğru klasör yolunu belirle\r\n\r\n                            if($tahsilat->tahsilat_tipi == 1) {\r\n\r\n                                // Banka - dekontlar klasörü\r\n\r\n                                $gorsel_link = base_url('assets/uploads/dekontlar/' . $tahsilat->gorsel);\r\n\r\n                            } elseif($tahsilat->tahsilat_tipi == 2) {\r\n\r\n                                // Çek - cekler klasörü\r\n\r\n                                $gorsel_link = base_url('assets/uploads/cekler/' . $tahsilat->gorsel);\r\n\r\n                            } elseif($tahsilat->tahsilat_tipi == 4) {\r\n\r\n                                // Senet - senetler klasörü\r\n\r\n                                $gorsel_link = base_url('assets/uploads/senetler/' . $tahsilat->gorsel);\r\n\r\n                            } else {\r\n\r\n                                // Diğer durumlar - dekontlar klasörü (Kasa vs.)\r\n\r\n                                $gorsel_link = base_url('assets/uploads/dekontlar/' . $tahsilat->gorsel);\r\n\r\n                            }\r\n\r\n                        }\r\n\r\n                        \r\n\r\n                        $tahsilatlar[] = array(\r\n\r\n                            'id' => $tahsilat->kayit_id,\r\n\r\n                            'tahsilat_tipi' => $tahsilat->tahsilat_tipi_adi,\r\n\r\n                            'tahsilat_tipi_kodu' => $tahsilat->tahsilat_tipi,\r\n\r\n                            'tutar' => $tahsilat->tutar ? number_format($tahsilat->tutar, 2, ',', '.') . ' ₺' : '0,00 ₺',\r\n\r\n                            'durum' => $tahsilat->durum_adi,\r\n\r\n                            'durum_code' => $tahsilat->durum,\r\n\r\n                            'gorsel' => $tahsilat->gorsel,\r\n\r\n                            'gorsel_link' => $gorsel_link,\r\n\r\n                            'olusturma_tarihi' => $tahsilat->olusturma_tarihi\r\n\r\n                        );\r\n\r\n                    }\r\n\r\n                } catch (Exception $e) {\r\n\r\n                    // Hata durumunda boş array döndür\r\n\r\n                    error_log('Tahsilat verileri alınırken hata: ' . $e->getMessage());\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n            $data = array(\r\n\r\n                'personel' => $personel_adi,\r\n\r\n                'evrak_dosyalar' => $evrak_dosyalar,\r\n\r\n                'fotograf_dosyalar' => $fotograf_dosyalar,\r\n\r\n                'sozlesme_tutar' => $satisResult ? number_format($satisResult->satis_kdvToplam, 2, ',', '.') . ' ₺' : 'Belirtilmemiş',\r\n\r\n                'sozlesme_aciklama' => $satisResult && !empty($satisResult->satis_aciklama) ? $satisResult->satis_aciklama : 'Açıklama bulunmuyor',\r\n\r\n                'sozlesme_dosyalar' => $sozlesme_dosyalar,\r\n\r\n                'sozlesme_id' => $satisResult ? $satisResult->satis_id : null,\r\n\r\n                'duzenle_link' => base_url('cari/cari-karti-duzenle/' . $result->cari_id),\r\n\r\n                'tahsilatlar' => $tahsilatlar\r\n\r\n            );\r\n\r\n            \r\n\r\n            header('Content-Type: application/json');\r\n\r\n            echo json_encode($data);\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            header('Content-Type: application/json');\r\n\r\n            echo json_encode(array('error' => $e->getMessage()));\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    // Tahsilat görseli yükleme fonksiyonu\r\n\r\n    public function tahsilat_gorsel_yukle()\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            // Yetki kontrolü\r\n\r\n            if (!grup_modul_yetkisi_var(901)) {\r\n\r\n                header('Content-Type: application/json');\r\n\r\n                echo json_encode(array('success' => false, 'message' => 'Yetkiniz bulunmamaktadır.'));\r\n\r\n                return;\r\n\r\n            }\r\n\r\n\r\n\r\n            $tahsilat_id = postval('tahsilat_id');\r\n\r\n            $tahsilat_tipi = postval('tahsilat_tipi'); // 1: Banka, 2: Çek, 3: Kasa, 4: Senet\r\n\r\n            \r\n\r\n            if (!$tahsilat_id) {\r\n\r\n                header('Content-Type: application/json');\r\n\r\n                echo json_encode(array('success' => false, 'message' => 'Tahsilat ID gerekli.'));\r\n\r\n                return;\r\n\r\n            }\r\n\r\n\r\n\r\n            // Tahsilat tipine göre tablo ve klasör belirle\r\n\r\n            $tablo = '';\r\n\r\n            $id_field = '';\r\n\r\n            $gorsel_field = '';\r\n\r\n            $upload_folder = '';\r\n\r\n            \r\n\r\n            switch($tahsilat_tipi) {\r\n\r\n                case '1': // Banka\r\n\r\n                    $tablo = 'bankaHareketleri';\r\n\r\n                    $id_field = 'bh_id';\r\n\r\n                    $gorsel_field = 'bh_gorsel';\r\n\r\n                    $upload_folder = 'dekontlar';\r\n\r\n                    break;\r\n\r\n                case '2': // Çek\r\n\r\n                    $tablo = 'cek';\r\n\r\n                    $id_field = 'cek_id';\r\n\r\n                    $gorsel_field = 'cek_gorsel';\r\n\r\n                    $upload_folder = 'cekler';\r\n\r\n                    break;\r\n\r\n                case '3': // Kasa\r\n\r\n                    $tablo = 'kasaHareketleri';\r\n\r\n                    $id_field = 'kh_id';\r\n\r\n                    $gorsel_field = 'kh_gorsel';\r\n\r\n                    $upload_folder = 'dekontlar';\r\n\r\n                    break;\r\n\r\n                case '4': // Senet\r\n\r\n                    $tablo = 'senet';\r\n\r\n                    $id_field = 'senet_id';\r\n\r\n                    $gorsel_field = 'senet_gorsel';\r\n\r\n                    $upload_folder = 'senetler';\r\n\r\n                    break;\r\n\r\n                default:\r\n\r\n                    header('Content-Type: application/json');\r\n\r\n                    echo json_encode(array('success' => false, 'message' => 'Geçersiz tahsilat tipi.'));\r\n\r\n                    return;\r\n\r\n            }\r\n\r\n\r\n\r\n            // Dosya yükleme ayarları\r\n\r\n            $config['upload_path'] = \"./assets/uploads/$upload_folder/\";\r\n\r\n            $config['allowed_types'] = 'gif|jpg|png|jpeg';\r\n\r\n            $config['max_size'] = 5120; // 5MB\r\n\r\n            $config['encrypt_name'] = TRUE;\r\n\r\n            $config['remove_spaces'] = TRUE;\r\n\r\n\r\n\r\n            // Upload klasörü yoksa oluştur\r\n\r\n            if (!is_dir($config['upload_path'])) {\r\n\r\n                mkdir($config['upload_path'], 0755, true);\r\n\r\n            }\r\n\r\n\r\n\r\n            $this->load->library('upload', $config);\r\n\r\n\r\n\r\n            if ($this->upload->do_upload('gorsel')) {\r\n\r\n                $upload_data = $this->upload->data();\r\n\r\n                \r\n\r\n                // Eski görseli sil (varsa)\r\n\r\n                $eski_gorsel_query = \"SELECT $gorsel_field FROM $tablo WHERE $id_field = ?\";\r\n\r\n                $eski_gorsel = $this->db->query($eski_gorsel_query, array($tahsilat_id))->row();\r\n\r\n                \r\n\r\n                if ($eski_gorsel && !empty($eski_gorsel->{$gorsel_field})) {\r\n\r\n                    $eski_dosya_yolu = \"./assets/uploads/$upload_folder/\" . $eski_gorsel->{$gorsel_field};\r\n\r\n                    if (file_exists($eski_dosya_yolu)) {\r\n\r\n                        unlink($eski_dosya_yolu);\r\n\r\n                    }\r\n\r\n                }\r\n\r\n                \r\n\r\n                // Yeni görsel adını veritabanına kaydet\r\n\r\n                $update_data = array(\r\n\r\n                    $gorsel_field => $upload_data['file_name']\r\n\r\n                );\r\n\r\n                \r\n\r\n                $where = array($id_field => $tahsilat_id);\r\n\r\n                $result = $this->vt->update($tablo, $where, $update_data);\r\n\r\n                \r\n\r\n                if ($result) {\r\n\r\n                    header('Content-Type: application/json');\r\n\r\n                    echo json_encode(array(\r\n\r\n                        'success' => true, \r\n\r\n                        'message' => 'Görsel başarıyla yüklendi.',\r\n\r\n                        'file_name' => $upload_data['file_name']\r\n\r\n                    ));\r\n\r\n                } else {\r\n\r\n                    // Yüklenen dosyayı sil (veritabanı kaydı başarısız)\r\n\r\n                    unlink($upload_data['full_path']);\r\n\r\n                    header('Content-Type: application/json');\r\n\r\n                    echo json_encode(array('success' => false, 'message' => 'Veritabanı güncellenirken hata oluştu.'));\r\n\r\n                }\r\n\r\n            } else {\r\n\r\n                $error = $this->upload->display_errors('', '');\r\n\r\n                header('Content-Type: application/json');\r\n\r\n                echo json_encode(array('success' => false, 'message' => $error));\r\n\r\n            }\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            header('Content-Type: application/json');\r\n\r\n            echo json_encode(array('success' => false, 'message' => $e->getMessage()));\r\n\r\n        }\r\n\r\n    }\r\n\r\n}\r\n\r\n"
        }
    ]
}