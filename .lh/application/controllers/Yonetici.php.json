{
    "sourceFile": "application/controllers/Yonetici.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1754724668549,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755004842483,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1509,9 +1509,10 @@\n \t\t\t1901 => 'Voip - Operatör Tanımla',\r\n \t\t\t1902 => 'Voip - Numara Tanımla',\r\n \t\t\t1903 => 'Voip - Numara Teslim',\r\n \t\t\t1904 => 'Voip - Günlük Harcama',\r\n-\t\t\t1905 => 'Voip - Hakediş Tanımlama'\r\n+\t\t\t1905 => 'Voip - Hakediş Tanımlama',\r\n+\t\t\t1906 => 'Voip - Hakediş İris Rapor'\r\n \t\t];\r\n \r\n \t\t// Yetki listesi\r\n \t\t$data[\"yetkiler\"] = [\r\n"
                },
                {
                    "date": 1755012446403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1510,9 +1510,10 @@\n \t\t\t1902 => 'Voip - Numara Tanımla',\r\n \t\t\t1903 => 'Voip - Numara Teslim',\r\n \t\t\t1904 => 'Voip - Günlük Harcama',\r\n \t\t\t1905 => 'Voip - Hakediş Tanımlama',\r\n-\t\t\t1906 => 'Voip - Hakediş İris Rapor'\r\n+\t\t\t1906 => 'Voip - Hakediş İris Rapor',\r\n+\t\t\t1907 => 'Voip - Hakediş Bayi Hesapla'\r\n \t\t];\r\n \r\n \t\t// Yetki listesi\r\n \t\t$data[\"yetkiler\"] = [\r\n"
                }
            ],
            "date": 1754724668549,
            "name": "Commit-0",
            "content": "<?php\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\r\nuse PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\r\nuse PhpOffice\\PhpSpreadsheet\\Helper\\Sample;\r\nuse PhpOffice\\PhpSpreadsheet\\IOFactory;\r\n\r\nclass Yonetici extends CI_Controller {\r\n\r\n  public function __construct(){\r\n\t\tparent::__construct();\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\t\t$this->load->model('vt');\r\n\t\t\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\t  if(!$control){\r\n\t\t\tredirect(\"check\");\r\n\t\t}\r\n\t  //sessionKontrolHelper();\r\n\t}\r\n\r\n\tpublic function kullaniciLoglari(){\r\n\r\n\t\t$data[\"baslik\"] = \"Yönetici / Kullanıcı Logları\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$islem = $this->input->get('islem');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //küçük tarih\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //büyük tarih\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\t\t$segment = 2;\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\t\t$limit = 20;\r\n\r\n\t\tif($sayfa){$pagem = ($page-1)*$limit;}\r\n\t\telse{$pagem = 0;/*logekle(51,1);*/}\r\n\r\n\t\tif((isset($islem) && !empty($islem)) || (isset($tarihGet) && !empty($tarihGet))){\r\n\r\n\t\t\tif(!empty($islem)){$sorgu1 = \"AND log_islemTipi = '$islem'\";}\r\n\t\t\telse{$sorgu1 = \"\";}\r\n\r\n\r\n\t\t\tif(!empty($tarihGet)){$sorgu3 = \"AND log_islemTarih BETWEEN '$tarih1' AND '$tarih2'\";}\r\n\t\t\telse{$sorgu3 = \"\";}\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM loglar WHERE log_anaHesap = '$anaHesap'  \".$sorgu1.\" \".$sorgu3.\" \";\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM loglar WHERE log_anaHesap = '$anaHesap'  \".$sorgu1.\" \".$sorgu3.\" ORDER BY log_id DESC LIMIT $pagem,$limit\";\r\n\t\t}else{\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM loglar WHERE log_anaHesap = '$anaHesap'\";\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t\t$count = $countexe->total;\r\n\t\t\t$sorgu = \"SELECT * FROM loglar WHERE log_anaHesap = '$anaHesap' ORDER BY log_id DESC LIMIT $pagem,$limit\";\r\n\t\t}\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\t\t$config = array();\r\n\t\t$config[\"base_url\"] = base_url() . \"/yonetici/$urim\";\r\n\t\t$config[\"total_rows\"] = $count;\r\n\t\t$config[\"per_page\"] = $limit;\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\t\t$config['page_query_string'] = TRUE;\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\t\t$config['num_links'] = 9;\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\t\t$data[\"loglar\"] = $this->db->query($sorgu)->result();\r\n\r\n\t\t$this->load->view(\"yonetici/kullanici-loglari\",$data);\r\n\t}\tpublic function yeniKullaniciEkle(){\r\n\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\t\t$data[\"baslik\"] = \"Yönetici / Yeni Kullanıcı Ekle\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t\r\n\t\t// Kullanıcı gruplarını getir\r\n\t\t$kullaniciGruplariQ = \"SELECT * FROM kullanici_grubu WHERE kg_olusturanAnaHesap = '$anaHesap' ORDER BY kg_adi ASC\";\r\n\t\t$data[\"kullaniciGruplari\"] = $this->db->query($kullaniciGruplariQ)->result();\r\n\t\t\r\n\t\t// Sorumlu müdür seçimi için tüm kullanıcıları getir\r\n\t\t$tumKullanicilarQ = \"SELECT kullanici_id, kullanici_ad, kullanici_soyad FROM kullanicilar WHERE kullanici_sorumluMudur = '$anaHesap' AND kullanici_durum = 1 ORDER BY kullanici_ad ASC, kullanici_soyad ASC\";\r\n\t\t$data[\"tumKullanicilar\"] = $this->db->query($tumKullanicilarQ)->result();\r\n\t\t\r\n\t\t// İlleri getir\t\t\r\n\t\t$illerQ = \"SELECT * FROM iller ORDER BY il ASC\";\r\n\t\t$data[\"iller\"] = $this->db->query($illerQ)->result();\r\n\t\t\r\n\t\t// Ülkeleri getir - Eğer tablo yoksa boş array ata\r\n\t\t$data[\"ulkeler\"] = [];\r\n\t\t\r\n\t\t// Tablo varlığını kontrol et\r\n\t\tif ($this->db->table_exists('ulkeler')) {\r\n\t\t\ttry {\r\n\t\t\t\t$ulkelerQ = \"SELECT ulke_kodu as country_code, ulke_adi as country_name FROM ulkeler ORDER BY ulke_adi ASC\";\r\n\t\t\t\t$data[\"ulkeler\"] = $this->db->query($ulkelerQ)->result();\r\n\t\t\t} catch (Exception $e) {\r\n\t\t\t\t// Hata durumunda boş array bırak\r\n\t\t\t\t$data[\"ulkeler\"] = [];\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\t//logekle(48,1);\r\n\t\t$this->load->view(\"yonetici/kullanici\", $data);\r\n\t}\r\n\tpublic function kullaniciOlustur(){\r\n\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t// Debug log setup\r\n\t\t$debug_log_file = 'debug_kullanici_olustur.log';\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\t$log_entry = $timestamp . \" [START] Kullanıcı oluşturma işlemi başladı\\n\";\r\n\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$sifre = postval(\"kullanici_sifre\");\r\n\t\t$sifreTekrar = postval(\"kullanici_sifreTekrar\");\r\n\r\n\t\t$eposta = postval(\"kullanici_eposta\");\r\n\t\t\r\n\t\t$log_entry = $timestamp . \" [INFO] Form verileri alındı - Email: $eposta\\n\";\r\n\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\r\n\t\tif($sifre == $sifreTekrar){\t\t\t$data[\"kullanici_eposta\"] = $eposta;\t\t\t$data[\"kullanici_ad\"] = postval(\"kullanici_ad\");\r\n\t\t\t$data[\"kullanici_soyad\"] = postval(\"kullanici_soyad\");\r\n\t\t\t$data[\"kullanici_kullaniciAdi\"] = postval(\"kullanici_kullaniciAdi\");\r\n\t\t\t$data[\"kullanici_sifre\"] = md5($sifre);\r\n\t\t\t$data[\"grup_id\"] = postval(\"kullanici_grupID\"); // Form field adı kullanici_grupID ama database field grup_id\r\n\t\t\t$data[\"kullanici_durum\"] = postval(\"kullanici_durum\");\r\n\t\t\t\r\n\t\t\t// Sorumlu müdür alanı - eğer seçilmişse kullan, yoksa mevcut ana hesabı kullan\t\t\t$sorumluMudur = postval(\"kullanici_sorumluMudur\");\r\n\t\t\t$data[\"kullanici_sorumluMudur\"] = !empty($sorumluMudur) ? $sorumluMudur : $anaHesap;\r\n\t\t\t\r\n\t\t\t$data[\"kullanici_olusturmaTarihi\"] = $tarihi;\r\n\t\t\t$data[\"kullanici_olusturan\"] = $u_id;\r\n\r\n\t\t\t$kullaniciEpostaVarmiQ = \"SELECT * FROM kullanicilar WHERE kullanici_eposta = '$eposta'\";\r\n\t\t\t$kullaniciEpostaVarmi = $this->db->query($kullaniciEpostaVarmiQ)->row();\t\t\tif($kullaniciEpostaVarmi){\r\n\t\t\t\t$this->session->set_flashdata('kullanici_eposta_mevcut','OK');\r\n\t\t\t\tredirect(\"yonetici/yeni-kullanici-ekle\");\r\n\t\t\t}else{\r\n\t\t\t\t$this->vt->insert(\"kullanicilar\",$data);\r\n\t\t\t\t$kullanici_idsi = $this->db->insert_id();\r\n\t\t\t\t\r\n\t\t\t\t// Debug log file setup\r\n\t\t\t\t$debug_log_file = 'debug_sorumluluk_bolgesi_olustur.log';\r\n\t\t\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\t\t\t\r\n\t\t\t\t// Sorumluluk bölgelerini güncelle - sadece checkbox işaretliyse\r\n\t\t\t\t$sorumluluk_aktif = postval(\"sorumluluk_aktif\"); // Checkbox durumu\r\n\t\t\t\t$log_entry = $timestamp . \" [CREATE] Sorumluluk aktif checkbox durumu: \" . ($sorumluluk_aktif ? 'CHECKED' : 'NOT_CHECKED') . \"\\n\";\r\n\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t\r\n\t\t\t\tif ($sorumluluk_aktif) {\r\n\t\t\t\t\t// Sorumluluk bölgelerini kaydet\r\n\t\t\t\t\t$sorumlulukBolgeleri = postval(\"sorumluluk_bolgesi\");\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Yeni sorumluluk bölgesi alanlarını al\r\n\t\t\t\t\t$sorumluluk_baslangic_tarihi = postval(\"sorumluluk_baslangic_tarihi\");\r\n\t\t\t\t\t$sorumluluk_bitis_tarihi = postval(\"sorumluluk_bitis_tarihi\");\r\n\t\t\t\t\t$sorumluluk_ulke_id = postval(\"sorumluluk_ulke_id\");\r\n\t\t\t\t\t$sorumluluk_aciklama = postval(\"sorumluluk_aciklama\");\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(!empty($sorumlulukBolgeleri) && is_array($sorumlulukBolgeleri)){\r\n\t\t\t\t\tforeach($sorumlulukBolgeleri as $bolge){\r\n\t\t\t\t\t\t$bolgeParts = explode('_', $bolge);\r\n\t\t\t\t\t\tif(count($bolgeParts) == 2){\r\n\t\t\t\t\t\t\t$il_id = $bolgeParts[0];\r\n\t\t\t\t\t\t\t$ilce_id = $bolgeParts[1];\r\n\t\t\t\t\t\t\t\t\t// Tablo yapısını kontrol et\r\n\t\t\t\t\t\t\t$tableColumns = $this->db->list_fields('kullanici_sorumluluk_bolgesi');\r\n\t\t\t\t\t\t\t$hasExtendedColumns = in_array('baslangic_tarihi', $tableColumns) && \r\n\t\t\t\t\t\t\t\t\t\t\t\t  in_array('bitis_tarihi', $tableColumns) && \r\n\t\t\t\t\t\t\t\t\t\t\t\t  in_array('ulke_id', $tableColumns) && \r\n\t\t\t\t\t\t\t\t\t\t\t\t  in_array('aciklama', $tableColumns);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Temel veriler\r\n\t\t\t\t\t\t\t$sorumlulukData = array(\r\n\t\t\t\t\t\t\t\t\"kullanici\" => $kullanici_idsi,\r\n\t\t\t\t\t\t\t\t\"il_id\" => $il_id,\r\n\t\t\t\t\t\t\t\t\"ilce_id\" => $ilce_id,\r\n\t\t\t\t\t\t\t\t\"durum\" => 1\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Eğer genişletilmiş alanlar varsa ekle\r\n\t\t\t\t\t\t\tif ($hasExtendedColumns) {\r\n\t\t\t\t\t\t\t\t$sorumlulukData[\"baslangic_tarihi\"] = !empty($sorumluluk_baslangic_tarihi) ? $sorumluluk_baslangic_tarihi : null;\r\n\t\t\t\t\t\t\t\t$sorumlulukData[\"bitis_tarihi\"] = !empty($sorumluluk_bitis_tarihi) ? $sorumluluk_bitis_tarihi : null;\r\n\t\t\t\t\t\t\t\t$sorumlulukData[\"ulke_id\"] = !empty($sorumluluk_ulke_id) ? $sorumluluk_ulke_id : 'TR';\r\n\t\t\t\t\t\t\t\t$sorumlulukData[\"aciklama\"] = $sorumluluk_aciklama;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Eğer islemi_yapan ve islem_tarihi alanları da varsa ekle\r\n\t\t\t\t\t\t\t\tif (in_array('islemi_yapan', $tableColumns)) {\r\n\t\t\t\t\t\t\t\t\t$sorumlulukData[\"islemi_yapan\"] = $u_id;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (in_array('islem_tarihi', $tableColumns)) {\r\n\t\t\t\t\t\t\t\t\t$sorumlulukData[\"islem_tarihi\"] = date('Y-m-d H:i:s');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\t\t\t\t\t\t\t$this->vt->insert(\"kullanici_sorumluluk_bolgesi\", $sorumlulukData);\r\n\t\t\t\t\t\t\t$log_entry = $timestamp . \" [CREATE] Sorumluluk bölgesi eklendi: $il_id-$ilce_id\\n\";\r\n\t\t\t\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Checkbox işaretli değilse sorumluluk bölgesi işlemlerini atla\r\n\t\t\t\t\t$log_entry = $timestamp . \" [CREATE] Sorumluluk bölgesi checkbox işaretli değil, bu işlemler atlanıyor\\n\";\r\n\t\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t} // Sorumluluk aktif checkbox kontrolü sonu\r\n\t\t\t\t\r\n\t\t\t\t// Kullanıcı başarıyla oluşturulduktan sonra otomatik varsayılan kasa oluştur\r\n\t\t\t\t$this->otomatikKasaOlustur($kullanici_idsi, $u_id, $anaHesap, $tarihi);\r\n\t\t\t\t\t\t$this->session->set_flashdata('kullanici_ok','OK');\r\n\t\t\t\tlogekle(48,2);\r\n\t\t\t\tredirect(\"yonetici/mevcut-kullanici-duzenle/$kullanici_idsi\");\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\t$log_entry = $timestamp . \" [ERROR] Şifreler uyuşmuyor\\n\";\r\n\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t$this->session->set_flashdata('kullanici_sifreHata','OK');\r\n\t\t\tredirect(\"yonetici/yeni-kullanici-ekle\");\r\n\t\t}\r\n\t}\tpublic function mevcutKullaniciDuzenle($id){\r\n\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t$data[\"baslik\"] = \"Yönetici / Mevcut Kullanıcı Düzenle\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$kullaniciQ = \"SELECT * FROM kullanicilar WHERE kullanici_id = '$id'\";\r\n\t\t$data[\"kullanici\"] = $this->db->query($kullaniciQ)->row();\r\n\r\n\t\t// Kullanıcı gruplarını getir (ana hesap filtresi kaldırıldı)\r\n\t\t$kullaniciGruplariQ = \"SELECT * FROM kullanici_grubu ORDER BY kg_adi ASC\";\r\n\t\t$data[\"kullaniciGruplari\"] = $this->db->query($kullaniciGruplariQ)->result();\r\n\t\t\r\n\t\t// Sorumlu müdür seçimi için tüm kullanıcıları getir (ana hesap filtresi kaldırıldı)\r\n\t\t$tumKullanicilarQ = \"SELECT kullanici_id, kullanici_ad, kullanici_soyad FROM kullanicilar WHERE kullanici_durum = 1 ORDER BY kullanici_ad ASC, kullanici_soyad ASC\";\r\n\t\t$data[\"tumKullanicilar\"] = $this->db->query($tumKullanicilarQ)->result();\r\n\t\t\r\n\t\t// İlleri getir\r\n\t\t$illerQ = \"SELECT * FROM iller ORDER BY il ASC\";\t\t$data[\"iller\"] = $this->db->query($illerQ)->result();\r\n\t\t\t\t// Ülkeleri getir (updated to use correct field name from database schema)\r\n\t\t$ulkelerQ = \"SELECT ulke_kodu as country_code, ulke_adi as country_name FROM ulkeler ORDER BY ulke_adi ASC\";\r\n\t\t$data[\"ulkeler\"] = $this->db->query($ulkelerQ)->result();\r\n\t\t\r\n\t\t// Kullanıcının mevcut sorumluluk bölgelerini getir\r\n\t\t$kullaniciSorumlulukQ = \"SELECT sb.*, i.il, ilc.ilce, \r\n\t\t\t\t\t\t\t\t CONCAT(k.kullanici_ad, ' ', LEFT(k.kullanici_soyad, 1), '.') as islemi_yapan_adi\r\n\t\t\t\t\t\t\t\t FROM kullanici_sorumluluk_bolgesi sb\r\n\t\t\t\t\t\t\t\t LEFT JOIN iller i ON sb.il_id = i.id\r\n\t\t\t\t\t\t\t\t LEFT JOIN ilceler ilc ON sb.ilce_id = ilc.id\r\n\t\t\t\t\t\t\t\t LEFT JOIN kullanicilar k ON sb.islemi_yapan = k.kullanici_id\r\n\t\t\t\t\t\t\t\t WHERE sb.kullanici = '$id' AND sb.durum = 1\";\r\n\t\t$data[\"kullaniciSorumlulukBolgeleri\"] = $this->db->query($kullaniciSorumlulukQ)->result();// Kullanıcının sorumluluk bölgesi temel bilgilerini getir (ilk kayıt varsa)\r\n\t\t// Önce tablo yapısını kontrol et\r\n\t\t$tableColumns = $this->db->list_fields('kullanici_sorumluluk_bolgesi');\r\n\t\t$hasExtendedColumns = in_array('baslangic_tarihi', $tableColumns) && \r\n\t\t\t\t\t\t\t  in_array('bitis_tarihi', $tableColumns) && \r\n\t\t\t\t\t\t\t  in_array('ulke_id', $tableColumns) && \r\n\t\t\t\t\t\t\t  in_array('aciklama', $tableColumns);\r\n\t\t\r\n\t\tif ($hasExtendedColumns) {\r\n\t\t\t$kullaniciSorumlulukBilgiQ = \"SELECT baslangic_tarihi, bitis_tarihi, ulke_id, aciklama\r\n\t\t\t\t\t\t\t\t\t\t   FROM kullanici_sorumluluk_bolgesi \r\n\t\t\t\t\t\t\t\t\t\t   WHERE kullanici = '$id' AND durum = 1 \r\n\t\t\t\t\t\t\t\t\t\t   LIMIT 1\";\r\n\t\t} else {\r\n\t\t\t// Eski tablo yapısı için temel sorgu\r\n\t\t\t$kullaniciSorumlulukBilgiQ = \"SELECT kullanici, durum\r\n\t\t\t\t\t\t\t\t\t\t   FROM kullanici_sorumluluk_bolgesi \r\n\t\t\t\t\t\t\t\t\t\t   WHERE kullanici = '$id' AND durum = 1 \r\n\t\t\t\t\t\t\t\t\t\t   LIMIT 1\";\r\n\t\t}\t\t$data[\"kullaniciSorumlulukBilgi\"] = $this->db->query($kullaniciSorumlulukBilgiQ)->row();\r\n\t\t$data[\"hasExtendedColumns\"] = $hasExtendedColumns;\r\n\t\t\r\n\t\t//logekle(48,1);\r\n\t\t$this->load->view(\"yonetici/kullanici\", $data);\r\n\t}\r\n\r\n\tpublic function kullaniciDuzenle(){\r\n\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t$kullanici_id = postval(\"kullanici_id\");\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$sifre = postval(\"kullanici_sifre\");\r\n\t\t$sifreTekrar = postval(\"kullanici_sifreTekrar\");\r\n\t\t$eposta = postval(\"kullanici_eposta\");\r\n\r\n\t\tif(!empty($sifre) && !empty($sifreTekrar)){\r\n\t\t\tif($sifre == $sifreTekrar){\r\n\t\t\t\t$data[\"kullanici_sifre\"]  = md5($sifre);\r\n\t\t\t}else{\r\n\t\t\t\t$this->session->set_flashdata('kullanici_sifreHata','OK');\r\n\t\t\t\tredirect(\"yonetici/mevcut-kullanici-duzenle/$kullanici_id\");\r\n\t\t\t}\r\n\t\t}\r\n\t\t$data[\"kullanici_eposta\"] = $eposta;\t\t$data[\"kullanici_ad\"] = postval(\"kullanici_ad\");\t\t$data[\"kullanici_soyad\"] = postval(\"kullanici_soyad\");\r\n\t\t$data[\"kullanici_kullaniciAdi\"] = postval(\"kullanici_kullaniciAdi\");\r\n\t\t$data[\"grup_id\"] = postval(\"kullanici_grupID\"); // Form field adı kullanici_grupID ama database field grup_id\r\n\t\t$data[\"kullanici_durum\"] = postval(\"kullanici_durum\");\r\n\t\t$data[\"kullanici_sorumluMudur\"] = postval(\"kullanici_sorumluMudur\"); // Sorumlu müdür alanı\r\n\r\n\t\t$kullaniciEpostaVarmiQ = \"SELECT * FROM kullanicilar WHERE kullanici_eposta = '$eposta' AND kullanici_id != '$kullanici_id'\";\r\n\t\t$kullaniciEpostaVarmi = $this->db->query($kullaniciEpostaVarmiQ)->row();\r\n\t\tif($kullaniciEpostaVarmi){\r\n\t\t\t$this->session->set_flashdata('kullanici_eposta_mevcut','OK');\r\n\t\t\tredirect(\"yonetici/mevcut-kullanici-duzenle/$kullanici_id\");\r\n\t\t}else{\r\n\t\t\t$this->vt->update('kullanicilar', array('kullanici_id'=>$kullanici_id), $data);\r\n\t\t\t\t\t// Sorumluluk bölgelerini güncelle - sadece checkbox işaretliyse\r\n\t\t$sorumluluk_aktif = postval(\"sorumluluk_aktif\"); // Checkbox durumu\r\n\t\t$sorumlulukBolgeleri = postval(\"sorumluluk_bolgesi\");\r\n\t\t\r\n\t\t// GÜÇLENDIRILMIŞ DEBUG LOGGING\r\n\t\t$debug_log_file = FCPATH . 'debug_form_submission.log';\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\t\r\n\t\t// Detaylı debug bilgileri\r\n\t\t$debug_info = array(\r\n\t\t\t'timestamp' => $timestamp,\r\n\t\t\t'kullanici_id' => $kullanici_id,\r\n\t\t\t'sorumluluk_aktif' => $sorumluluk_aktif,\r\n\t\t\t'post_count' => count($_POST),\r\n\t\t\t'post_keys' => array_keys($_POST),\r\n\t\t\t'sorumluluk_bolgesi_raw' => isset($_POST['sorumluluk_bolgesi']) ? $_POST['sorumluluk_bolgesi'] : 'NOT_SET',\r\n\t\t\t'sorumluluk_bolgesi_parsed' => $sorumlulukBolgeleri,\r\n\t\t\t'is_array' => is_array($sorumlulukBolgeleri),\r\n\t\t\t'array_count' => is_array($sorumlulukBolgeleri) ? count($sorumlulukBolgeleri) : 0\r\n\t\t);\r\n\t\t\r\n\t\t// Log dosyasına yaz\r\n\t\t$log_entry = $timestamp . \" [INFO] Form submission debug: \" . json_encode($debug_info) . \"\\n\";\r\n\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\r\n\t\t// Eski error_log'ları da tut\r\n\t\terror_log(\"DEBUG - POST Verileri: \" . print_r($_POST, true));\r\n\t\terror_log(\"DEBUG - Sorumluluk Bölgeleri: \" . print_r($sorumlulukBolgeleri, true));\r\n\t\terror_log(\"DEBUG - Sorumluluk Aktif: \" . ($sorumluluk_aktif ? 'TRUE' : 'FALSE'));\r\n\t\t\r\n\t\t// Sorumluluk bölgesi işlemleri sadece checkbox işaretliyse yapılsın\r\n\t\tif ($sorumluluk_aktif) {\r\n\t\t\t// Önce mevcut sorumluluk bölgelerini pasif yap\r\n\t\t\t$this->db->query(\"UPDATE kullanici_sorumluluk_bolgesi SET durum = 0 WHERE kullanici = '$kullanici_id'\");\r\n\t\t\t\r\n\t\t\t// Yeni sorumluluk bölgesi alanlarını al\r\n\t\t\t$sorumluluk_baslangic_tarihi = postval(\"sorumluluk_baslangic_tarihi\");\r\n\t\t\t$sorumluluk_bitis_tarihi = postval(\"sorumluluk_bitis_tarihi\");\r\n\t\t\t$sorumluluk_ulke_id = postval(\"sorumluluk_ulke_id\") ?: 1; // Varsayılan: Türkiye\r\n\t\t\t$sorumluluk_aciklama = postval(\"sorumluluk_aciklama\");\r\n\t\t\t\r\n\t\t\t// Yeni sorumluluk bölgelerini ekle/aktif et\r\n\t\t\tif(!empty($sorumlulukBolgeleri) && is_array($sorumlulukBolgeleri)){\r\n\t\t\t\t$log_entry = $timestamp . \" [SUCCESS] Sorumluluk bölgeleri işleme başlıyor. Toplam: \" . count($sorumlulukBolgeleri) . \"\\n\";\r\n\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t\r\n\t\t\t\tforeach($sorumlulukBolgeleri as $index => $bolge){\r\n\t\t\t\t\t$bolgeParts = explode('_', $bolge);\r\n\t\t\t\t\t$log_entry = $timestamp . \" [INFO] İşlenen bölge #$index: '$bolge' -> Parts: \" . json_encode($bolgeParts) . \"\\n\";\r\n\t\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(count($bolgeParts) == 2){\r\n\t\t\t\t\t$il_id = $bolgeParts[0];\r\n\t\t\t\t\t$ilce_id = $bolgeParts[1];\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Önce var mı kontrol et\r\n\t\t\t\t\t$mevcutSorumlulukQ = \"SELECT * FROM kullanici_sorumluluk_bolgesi WHERE kullanici = '$kullanici_id' AND il_id = '$il_id' AND ilce_id = '$ilce_id'\";\r\n\t\t\t\t\t$mevcutSorumluluk = $this->db->query($mevcutSorumlulukQ)->row();\r\n\t\t\t\t\t\r\n\t\t\t\t\tif($mevcutSorumluluk){\r\n\t\t\t\t\t\t// Var ise aktif et ve yeni alanları güncelle\r\n\t\t\t\t\t\t$updateData = array(\r\n\t\t\t\t\t\t\t\"durum\" => 1,\r\n\t\t\t\t\t\t\t\"baslangic_tarihi\" => $sorumluluk_baslangic_tarihi ?: null,\r\n\t\t\t\t\t\t\t\"bitis_tarihi\" => $sorumluluk_bitis_tarihi ?: null,\r\n\t\t\t\t\t\t\t\"ulke_id\" => $sorumluluk_ulke_id,\r\n\t\t\t\t\t\t\t\"aciklama\" => $sorumluluk_aciklama ?: null,\r\n\t\t\t\t\t\t\t\"islem_tarihi\" => date('Y-m-d H:i:s')\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\t$this->db->where('kullanici', $kullanici_id);\r\n\t\t\t\t\t\t$this->db->where('il_id', $il_id);\r\n\t\t\t\t\t\t$this->db->where('ilce_id', $ilce_id);\r\n\t\t\t\t\t\t$update_result = $this->db->update('kullanici_sorumluluk_bolgesi', $updateData);\r\n\t\t\t\t\t\t$log_entry = $timestamp . \" [SUCCESS] Mevcut kayıt güncellendi: $il_id-$ilce_id (Result: \" . ($update_result ? 'OK' : 'FAIL') . \")\\n\";\r\n\t\t\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t// Yok ise yeni ekle\r\n\t\t\t\t\t\t$sorumlulukData = array(\r\n\t\t\t\t\t\t\t\"kullanici\" => $kullanici_id,\r\n\t\t\t\t\t\t\t\"il_id\" => $il_id,\r\n\t\t\t\t\t\t\t\"ilce_id\" => $ilce_id,\r\n\t\t\t\t\t\t\t\"baslangic_tarihi\" => $sorumluluk_baslangic_tarihi ?: null,\r\n\t\t\t\t\t\t\t\"bitis_tarihi\" => $sorumluluk_bitis_tarihi ?: null,\r\n\t\t\t\t\t\t\t\"ulke_id\" => $sorumluluk_ulke_id,\r\n\t\t\t\t\t\t\t\"aciklama\" => $sorumluluk_aciklama ?: null,\r\n\t\t\t\t\t\t\t\"durum\" => 1,\r\n\t\t\t\t\t\t\t\"islemi_yapan\" => $kullanici_id, // Current user updating\r\n\t\t\t\t\t\t\t\"islem_tarihi\" => date('Y-m-d H:i:s')\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\t$insert_result = $this->vt->insert(\"kullanici_sorumluluk_bolgesi\", $sorumlulukData);\r\n\t\t\t\t\t\t$log_entry = $timestamp . \" [SUCCESS] Yeni kayıt eklendi: $il_id-$ilce_id (Insert Result: \" . ($insert_result ? 'OK' : 'FAIL') . \")\\n\";\r\n\t\t\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$log_entry = $timestamp . \" [ERROR] Geçersiz bölge formatı: '$bolge'\\n\";\r\n\t\t\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\t\t}\r\n\t\t\t}\t\t} else {\r\n\t\t\t$empty_reason = empty($sorumlulukBolgeleri) ? 'EMPTY' : 'NOT_ARRAY';\r\n\t\t\t$log_entry = $timestamp . \" [WARNING] Sorumluluk bölgeleri işlenemedi. Sebep: $empty_reason\\n\";\r\n\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t}\r\n\t\t} else {\r\n\t\t\t// Checkbox işaretli değilse sorumluluk bölgesi işlemlerini atla\r\n\t\t\t$log_entry = $timestamp . \" [INFO] Sorumluluk bölgesi checkbox işaretli değil, bu işlemler atlanıyor\\n\";\r\n\t\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t}\r\n\t\t\t\r\n\t\t$this->session->set_flashdata('kullanici_update_ok','OK');\r\n\t\tlogekle(48,3);\r\n\t\t\tredirect(\"yonetici/mevcut-kullanici-duzenle/$kullanici_id\");\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function kullaniciListesi(){\r\n\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t$data[\"baslik\"] = \"Yönetici / Kullanıcı Listesi\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$kullaniciEposta = $this->input->get('kullaniciEposta');\r\n\t\t$kullaniciAdi = $this->input->get('kullaniciAdi');\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\t\t\r\n\t\t$segment = 2;\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\t\t$limit = 20;\r\n\r\n\t\tif($sayfa){$pagem = ($page-1)*$limit;}\r\n\t\telse{$pagem = 0;/*logekle(50,1);*/}\t\tif((isset($kullaniciEposta) && !empty($kullaniciEposta)) || (isset($kullaniciAdi) && !empty($kullaniciAdi))){\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM kullanicilar WHERE kullanici_eposta LIKE '%$kullaniciEposta%' AND kullanici_kullaniciAdi LIKE '%$kullaniciAdi%'\";\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t\t$count = $countexe->total;\t\t\t$sorgu = \"SELECT k.*, kg.kg_adi, sm.kullanici_ad as sorumlu_mudur_ad, sm.kullanici_soyad as sorumlu_mudur_soyad FROM kullanicilar k LEFT JOIN kullanici_grubu kg ON k.grup_id = kg.kg_id LEFT JOIN kullanicilar sm ON k.kullanici_sorumluMudur = sm.kullanici_id WHERE k.kullanici_eposta LIKE '%$kullaniciEposta%' AND k.kullanici_kullaniciAdi LIKE '%$kullaniciAdi%' ORDER BY k.kullanici_id DESC LIMIT $pagem,$limit\";\t\t}else{\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM kullanicilar\";\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t\t$count = $countexe->total;\r\n\t\t\t$sorgu = \"SELECT k.*, kg.kg_adi, sm.kullanici_ad as sorumlu_mudur_ad, sm.kullanici_soyad as sorumlu_mudur_soyad FROM kullanicilar k LEFT JOIN kullanici_grubu kg ON k.grup_id = kg.kg_id LEFT JOIN kullanicilar sm ON k.kullanici_sorumluMudur = sm.kullanici_id ORDER BY k.kullanici_id DESC LIMIT $pagem,$limit\";\r\n\t\t}\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\t\t$config = array();\r\n\t\t$config[\"base_url\"] = base_url() . \"/yonetici/$urim\";\r\n\t\t$config[\"total_rows\"] = $count;\r\n\t\t$config[\"per_page\"] = $limit;\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\t\t$config['page_query_string'] = TRUE;\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\t\t$config['num_links'] = 9;\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\t\t$data[\"kullanici\"] = $this->db->query($sorgu)->result();\r\n\r\n\t\t$this->load->view(\"yonetici/kullanici-listesi\",$data);\r\n\t}\r\n\r\n\tpublic function ayarlar(){\r\n\t\t$data[\"baslik\"] = \"Yönetici / Ayarlar\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t$ayarlarQ = \"SELECT * FROM ayarlar WHERE ayarlar_id = '$anaHesap'\";\r\n\t\t$data[\"ayar\"] = $this->db->query($ayarlarQ)->row();\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\t\tif($iller->num_rows() > 0){$data['_iller'] = $iller->result();\r\n\t\t}else{$data['_iller'] = false;}\r\n\r\n\t\t$ayarlarBanka=\"select * from ayarlar_banka where ayarlarbanka_ayarID='$anaHesap'\";\r\n\t\t$data[\"ayarlarBanka\"]=$this->db->query($ayarlarBanka)->result();\r\n\r\n\r\n\t\t//logekle(53,1);\r\n\t\t$this->load->view(\"yonetici/ayarlar\",$data);\r\n\t}\r\n\r\n\tpublic function ayarlarGuncelle(){\r\n\t\t$ayarlar_id = postval(\"ayarlar_id\");\r\n\r\n\t\t$data[\"ayarlar_firmaAd\"] = postval(\"ayarlar_firmaAd\");\r\n\t\t$data[\"ayarlar_firmaSektor\"] = postval(\"ayarlar_firmaSektor\");\r\n\t\t$data[\"ayarlar_telefon\"] = postval(\"ayarlar_telefon\");\r\n\t\t$data[\"ayarlar_eposta\"] = postval(\"ayarlar_eposta\");\r\n\t\t$data[\"ayarlar_vergiDairesi\"] = postval(\"ayarlar_vergiDairesi\");\r\n\t\t$data[\"ayarlar_vergiNo\"] = postval(\"ayarlar_vergiNo\");\r\n\t\t$data[\"ayarlar_il\"] = postval(\"ayarlar_il\");\r\n\t\t$data[\"ayarlar_ilce\"] = postval(\"ayarlar_ilce\");\r\n\t\t$data[\"ayarlar_adres\"] = postval(\"ayarlar_adres\");\r\n\r\n\r\n\t\t$data[\"ayarlar_deletePermission\"] = postval(\"ayarlar_deletePermission\");\r\n\r\n\t\t//$data[\"ayarlar_lisansAnahtari\"] = postval(\"ayarlar_lisansAnahtari\");\r\n\r\n\t\t$ayar=$this->vt->single('ayarlar',array('ayarlar_id'=>$ayarlar_id));\r\n\r\n\t\tif($ayar->ayarlar_deletePermission!=$data[\"ayarlar_deletePermission\"])\r\n\t\t\tif($data[\"ayarlar_deletePermission\"]==1)\r\n\t\t\t\tlogekle(64,3);\r\n\t\t\telse\r\n\t\t\t\tlogekle(65,3);\r\n\r\n\t\t$this->vt->update('ayarlar', array('ayarlar_id'=>$ayarlar_id), $data);\r\n\t\tlogekle(53,3);\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$this->db->delete('ayarlar_banka', array('ayarlarbanka_ayarID' => $ayarlar_id));\r\n\r\n\t\t$dataBanka[\"ayarlarbanka_ayarID\"]=$ayarlar_id;\r\n\t\t$bankaAd=postval(\"ayarlar_bankaadi\");\r\n\t\t$subeAd=postval(\"ayarlar_sube\");\r\n\t\t$iban=postval(\"ayarlar_iban\");\r\n\t\t$hesapNo=postval(\"ayarlar_hesapno\");\r\n\t\t$paraBirimi=postval(\"ayarlar_parabirimi\");\r\n\t\t$bankaCount=postval(\"bankaCount\");\r\n\t\tfor($i=0;$i<$bankaCount;$i++) {\r\n\t\t\t$dataBanka[\"ayarlarbanka_ad\"] =$bankaAd[$i];\r\n\t\t\t$dataBanka[\"ayarlarbanka_subeAd\"] =$subeAd[$i];\r\n\t\t\t$dataBanka[\"ayarlarbanka_iban\"] =$iban[$i];\r\n\t\t\t$dataBanka[\"ayarlarbanka_hesapNo\"] =$hesapNo[$i];\r\n\t\t\t$dataBanka[\"ayarlarbanka_paraBirim\"] =$paraBirimi[$i];\r\n\r\n\t\t\t$dataBanka[\"ayarlarbanka_olusturan\"] = $u_id;\r\n\t\t\t$dataBanka[\"ayarlarbanka_olusturanAnaHesap\"] = $anaHesap;\r\n\t\t\t$dataBanka[\"ayarlarbanka_olusturmaTarihi\"] = $tarihi;\r\n\t\t\t$dataBanka[\"ayarlarbanka_olusturmaSaati\"] = $saati;\r\n\t\t\t$this->vt->insert(\"ayarlar_banka\",$dataBanka);\r\n\t\t\tlogekle(53,2);\r\n\t\t}\r\n\r\n\t\t$this->session->set_flashdata('ayarlar_update_ok','OK');\r\n\t\tredirect(\"yonetici/ayarlar\");\r\n\r\n\t}\r\n\tpublic function kullaniciYetkileriDuzenle(){\r\n\t\t$data[\"baslik\"] = \"Yönetici / Kullanıcı Yetkileri Düzenle\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$kullanici = $this->input->get(\"kullanici\");\r\n\r\n\t\tif($kullanici){\r\n\t\t\t$this->load->view(\"yonetici/kullanici-yetkileri-duzenle\",$data);\r\n\t\t}else{\r\n\t\t\t$this->load->view(\"yonetici/kullanici-yetkileri-duzenle\",$data);\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\tpublic function kullaniciYetkileriGuncelle(){\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$kullanici_id = postval(\"kullanici_id\");\r\n\r\n\t\t$post = $this->input->post();\r\n\r\n\t\t//modülId = 1)Cari 2)Stok 3)Fatura 4)Kasa 5)Banka 6)Rapor 7)Giderler\r\n\r\n\t\tif($post[\"cari\"]){\r\n\t\t\t\t$m1Array2 = [];\r\n\r\n\t\t\t\tforeach($post[\"cari\"] as $ps){\r\n\t\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 1, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\r\n\t\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,1,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$m1Array2[] = $ps;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t $modul1q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 1 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul1 = $this->db->query($modul1q)->result();\r\n\r\n\t\t\t\t $m1Array = [];\r\n\r\n\t\t\t\t  foreach($modul1 as $m1exe){\r\n\t\t\t\t      $m1Array[] = $m1exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff1 = array_diff($m1Array, $m1Array2);\r\n\r\n\t\t\t\t  if(!empty($diff1)){\r\n\t\t\t\t      foreach($diff1 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 1, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"cari\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 1, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif($post[\"stok\"]){\r\n\t\t\t$m2Array2 = [];\r\n\r\n\t\t\tforeach($post[\"stok\"] as $ps){\r\n\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 2, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\t\t\t\t\r\n\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,2,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t$m2Array2[] = $ps;\r\n\t\t\t}\r\n\r\n\t\t\t$modul2q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 2 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul2 = $this->db->query($modul2q)->result();\r\n\r\n\t\t\t\t $m2Array = [];\r\n\r\n\t\t\t\t  foreach($modul2 as $m2exe){\r\n\t\t\t\t      $m2Array[] = $m2exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff2 = array_diff($m2Array, $m2Array2);\r\n\r\n\t\t\t\t  if(!empty($diff2)){\r\n\t\t\t\t      foreach($diff2 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 2, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"stok\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 2, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\t\tif($post[\"fatura\"]){\r\n\t\t\t$m3Array2 = [];\r\n\t\t\tforeach($post[\"fatura\"] as $ps){\r\n\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 3, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,3,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t$m3Array2[] = $ps;\r\n\t\t\t}\r\n\r\n\t\t\t$modul3q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 3 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul3 = $this->db->query($modul3q)->result();\r\n\r\n\t\t\t\t $m3Array = [];\r\n\r\n\t\t\t\t  foreach($modul3 as $m3exe){\r\n\t\t\t\t      $m3Array[] = $m3exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff3 = array_diff($m3Array, $m3Array2);\r\n\r\n\t\t\t\t  if(!empty($diff3)){\r\n\t\t\t\t      foreach($diff3 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 3, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"fatura\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 3, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\t\tif($post[\"kasa\"]){\r\n\t\t\t$m4Array2 = [];\r\n\t\t\tforeach($post[\"kasa\"] as $ps){\r\n\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 4, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,4,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t$m4Array2[] = $ps;\r\n\t\t\t}\r\n\r\n\t\t\t$modul4q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 4 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul4 = $this->db->query($modul4q)->result();\r\n\r\n\t\t\t\t $m1Array = [];\r\n\r\n\t\t\t\t  foreach($modul4 as $m4exe){\r\n\t\t\t\t      $m4Array[] = $m4exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff4 = array_diff($m4Array, $m4Array2);\r\n\r\n\t\t\t\t  if(!empty($diff4)){\r\n\t\t\t\t      foreach($diff4 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 4, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"kasa\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 4, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\t\tif($post[\"banka\"]){\r\n\t\t\t$m5Array2 = [];\r\n\t\t\tforeach($post[\"banka\"] as $ps){\r\n\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 5, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,5,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t$m5Array2[] = $ps;\r\n\t\t\t}\r\n\r\n\t\t\t$modul5q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 5 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul5 = $this->db->query($modul5q)->result();\r\n\r\n\t\t\t\t $m5Array = [];\r\n\r\n\t\t\t\t  foreach($modul5 as $m5exe){\r\n\t\t\t\t      $m5Array[] = $m5exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff5 = array_diff($m5Array, $m5Array2);\r\n\r\n\t\t\t\t  if(!empty($diff5)){\r\n\t\t\t\t      foreach($diff5 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 5, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"banka\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 5, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\t\tif($post[\"rapor\"]){\r\n\t\t\t$m6Array2 = [];\r\n\t\t\tforeach($post[\"rapor\"] as $ps){\r\n\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 6, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,6,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t$m6Array2[] = $ps;\r\n\t\t\t}\r\n\r\n\t\t\t$modul6q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 6 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul6 = $this->db->query($modul6q)->result();\r\n\r\n\t\t\t\t $m6Array = [];\r\n\r\n\t\t\t\t  foreach($modul6 as $m6exe){\r\n\t\t\t\t      $m6Array[] = $m6exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff6 = array_diff($m6Array, $m6Array2);\r\n\r\n\t\t\t\t  if(!empty($diff6)){\r\n\t\t\t\t      foreach($diff6 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 6, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"rapor\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 6, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\t\tif($post[\"giderler\"]){\r\n\t\t\t$m7Array2 = [];\r\n\t\t\tforeach($post[\"giderler\"] as $ps){\r\n\t\t\t\t$data = array(\"ky_kullaniciID\" => $kullanici_id, \"ky_modul\" => 7, \"ky_yetki\"=>$ps, \"ky_guncelleyen\"=>$u_id);\r\n\t\t\t\t$yetkiSorgula = yetkiSorgula($kullanici_id,7,$ps);\r\n\r\n\t\t\t\t\tif(!$yetkiSorgula){\r\n\t\t\t\t\t\t$this->vt->insert(\"kullaniciYetkileri\", $data);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t$m7Array2[] = $ps;\r\n\t\t\t}\r\n\r\n\t\t\t$modul7q = \"SELECT * FROM kullaniciYetkileri WHERE ky_modul = 7 AND ky_kullaniciID = '$kullanici_id'\";\r\n\t\t\t\t $modul7 = $this->db->query($modul7q)->result();\r\n\r\n\t\t\t\t $m7Array = [];\r\n\r\n\t\t\t\t  foreach($modul7 as $m7exe){\r\n\t\t\t\t      $m7Array[] = $m7exe->ky_yetki;\r\n\t\t\t\t  }\r\n\r\n\t\t\t\t  $diff7 = array_diff($m7Array, $m7Array2);\r\n\r\n\t\t\t\t  if(!empty($diff7)){\r\n\t\t\t\t      foreach($diff7 as $key => $value){\r\n\t\t\t\t      \t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 7, 'ky_yetki' => $value, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t\t\t      }\r\n\t\t\t\t  }\r\n\t\t}else if(empty($post[\"giderler\"])){\r\n\t\t\t$this->db->delete('kullaniciYetkileri', array('ky_modul' => 7, 'ky_kullaniciID' => $kullanici_id));\r\n\t\t}\r\n\r\n\t\t$this->session->set_flashdata('kullanici_yetkileri_ok','OK');\r\n\t\tlogekle(49,3);\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t}\r\n\r\n\tpublic function logoGuncelle(){\r\n\t\tif(!empty($_FILES['file']['name'])){\r\n            $config['upload_path'] = 'assets/bulut/logo'; \r\n            $config['allowed_types'] = 'jpg|png|jpeg';\r\n            $config['max_size'] = '100';\r\n            $config['file_name'] = $_FILES['file']['name'];\r\n            $config['encrypt_name'] = TRUE;\r\n            $config['max_width'] = 250;\r\n            $config['max_height'] = 250;\r\n\r\n            $this->load->library('upload',$config); \r\n\r\n            if($this->upload->do_upload('file')){\r\n                $fileName = $this->upload->data('file_name');\r\n                $originalName = $this->upload->data('orig_name');\r\n\r\n                $uploadData = $this->upload->data();\r\n\r\n                if($uploadData){\r\n                    $data_upload[\"ayarlar_logoName\"] = $fileName;\r\n                    $data_upload[\"ayarlar_logoOriginalFileName\"] = $originalName;\r\n\r\n                    $aid = postval(\"anaHesap\");\r\n\r\n                    $this->vt->update('ayarlar', array('ayarlar_id'=>$aid), $data_upload);\r\n\r\n                    $this->session->set_flashdata('document_uploaded','ok');\r\n\r\n                    redirect($_SERVER['HTTP_REFERER']);\r\n                }\r\n            }else{\r\n            \t$this->session->set_flashdata('document_uploaded_error','ok');\r\n\r\n                    redirect($_SERVER['HTTP_REFERER']);\r\n            }\r\n        }\r\n\t}\r\n\r\n\tpublic function yukle($id){\r\n\t\tif($id == 1){//akınsoft\r\n\t\t\t$data[\"erp\"] = 1;\r\n\t\t\t$data[\"erpBaslik\"] = \"Akınsoft\";\r\n\t\t\t$this->load->view(\"yonetici/yukle\",$data);\r\n\t\t}else{\r\n\t\t\t//diğer\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function yukle_islem(){\r\n\t\t/* \r\n\t\t\r\n\t\tCari Hareketleri\r\n\r\n\t\t1 = Alış Faturası\r\n\t\t2 = Satış Faturası \r\n\t\t3 = Banka Havalesi \r\n\t\t4 = Banka EFT\r\n\t\t5 = Kasa Tahsilat\r\n\t\t6 = Kasa Ödeme\r\n\t\t7 = Cari Dekont \r\n\t\t8 = Alınan Çek\r\n\t\t9 = Verilen Çek\r\n\t\t10 = Alınan Senet\r\n\t\t11 = Verilen Senet\r\n\t\t12 = E-Fatura\r\n\t\t13 = E-Arşiv\r\n\r\n\r\n\t\tOnların \r\n\r\n\t\tÇek\r\n\t\tDekont\r\n\t\tEFT\r\n\t\tEvrak\r\n\t\tFatura\r\n\t\tHavale\r\n\t\tNakit\r\n\r\n\r\n\r\n\t\tALIŞ FATURASI = ch_alacak\r\n\t\tSATIŞ FATURASI = ch_borc\r\n\r\n\r\n\t\tch_belgeNumarasi = 6\r\n\t\tch_turu = 3\r\n\t\tch_cariID = 1 (sorgulanmış hali)\r\n\t\tch_paraBirimi = TL\r\n\r\n\t\t\t4 , 0 değilse\r\n\t\tch_borc\r\n\t\t\t5 , 0 değilse\r\n\t\tch_alacak\r\n\r\n\r\n\t\tch_tarih == 2022-04-05\r\n\t\tch_olusturan = 106\r\n\t\tch_olusturanAnaHesap = 91\r\n\r\n\t\tch_olusturmaTarihi = 2022-04-05\r\n\t\tch_olusturmaSaati = 09:00:00\r\n\r\n\r\n\r\n\r\n \r\n\r\n\t\t*/\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('Y-m-d');\r\n\t\t$saat = (new DateTime('now'))->format('H:i:s');\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\tif(!empty($_FILES['file']['name'])){\r\n          $config['upload_path'] = 'assets/bulut'; \r\n          $config['allowed_types'] = 'xls|xlsx';\r\n          $config['encrypt_name'] = TRUE;\r\n\r\n          $this->load->library('upload',$config); \r\n\r\n          if($this->upload->do_upload('file')){\r\n          \t$fileName = $this->upload->data('file_name');\r\n\r\n            $uploadData = $this->upload->data();\r\n            if($uploadData){\r\n            \t$inputFileName = './assets/bulut/'.$fileName;\r\n\r\n            \ttry {\r\n            \t$inputFileType = PhpOffice\\PhpSpreadsheet\\IOFactory::identify($inputFileName);\r\n\t\t\t\t\t    $objReader = PhpOffice\\PhpSpreadsheet\\IOFactory::createReader($inputFileType);\r\n\t\t\t\t\t    $objPHPExcel = $objReader->load($inputFileName);\r\n\t\t\t\t\t    }catch(Exception $e) {\r\n\t\t\t\t\t\t\t    die('Hata \"'.pathinfo($inputFileName,PATHINFO_BASENAME).'\": '.$e->getMessage());\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t$sheet = $objPHPExcel->getSheet(0); \r\n\t\t\t\t\t\t\t$highestRow = $sheet->getHighestRow(); \r\n\t\t\t\t\t\t\t$highestColumn = $sheet->getHighestColumn();\r\n\r\n\t\t\t\t\t\t\tfor ($row = 1; $row <= $highestRow; $row++){ \r\n\t\t\t\t\t\t\t    $rowData = $sheet->rangeToArray('A' . $row . ':' . $highestColumn . $row, NULL, TRUE, FALSE);\r\n\r\n\t\t\t\t\t\t\t    $cariKod = $rowData[0][0];\r\n\t\t\t\t\t\t\t    $stokKod = $rowData[0][1];\r\n\r\n\t\t\t\t\t\t\t    $sorgu1 = $this->db->query(\"SELECT cari_id FROM cari WHERE cari_kodu = '\".$cariKod.\"' \")->row();\r\n\t\t\t\t\t\t\t\t\t$cid = $sorgu1->cari_id;\r\n\r\n\t\t\t\t\t\t\t\t\t$sorgu2 = $this->db->query(\"SELECT stok_id FROM stok WHERE stok_kodu = '\".$stokKod.\"' \")->row();\r\n\t\t\t\t\t\t\t\t\t$sid = $sorgu2->stok_id;\r\n\r\n\t\t\t\t\t\t\t\t\t$islemTuru = $rowData[0][4];\r\n\r\n\t\t\t\t\t\t\t\t\t$belgeNumarasi = $rowData[0][7];\r\n\r\n\t\t\t\t\t\t\t\t\t$kpbTutar = $rowData[0][6];\r\n\r\n\r\n\t\t\t\t\t\t\t\t/*\tif($cid && $sid){\r\n\t\t\t\t\t\t\t\t\t\tif($islemTuru == 'Giren'){//1 alış faturası (giriş)\r\n\t\t\t\t\t\t\t\t\t\t$sh_turu = 1;\r\n\t\t\t\t\t\t\t\t\t\t$sh_giris = $rowData[0][2];\r\n\r\n\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO stokHareketleri (sh_turu,sh_giris,sh_cariID,sh_stokID,sh_belgeNumarasi,sh_paraBirimi,sh_tarih,sh_toplamFiyat,sh_olusturan,sh_olusturanAnaHesap,sh_olusturmaTarihi,sh_olusturmaSaati) VALUES ($sh_turu, $sh_giris,$cid,$sid,'$belgeNumarasi','TL','$tarih',$kpbTutar,$u_id,$anaHesap,'$tarih','$saat')\");\r\n\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if($islemTuru == 'Çıkan'){//2 satış faturası (çıkış)\r\n\t\t\t\t\t\t\t\t\t\t\t$sh_turu = 2;\r\n\t\t\t\t\t\t\t\t\t\t\t$sh_cikis = $rowData[0][3];\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO stokHareketleri (sh_turu,sh_cikis,sh_cariID,sh_stokID,sh_belgeNumarasi,sh_paraBirimi,sh_tarih,sh_toplamFiyat,sh_olusturan,sh_olusturanAnaHesap,sh_olusturmaTarihi,sh_olusturmaSaati) VALUES ($sh_turu, $sh_cikis,$cid,$sid,'$belgeNumarasi','TL','$tarih',$kpbTutar,$u_id,$anaHesap,'$tarih','$saat')\");\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}  */\r\n\r\n\r\n\t\t\t\t\t\t\t\t\tif($cid){\r\n\t\t\t\t\t\t\t\t\t\tif($turu == \"Fatura\"){\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 1;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saat.\"')\");\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t}else  if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 2;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\tif($turu == \"Çek\"){\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 8;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}else if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 9;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if($turu == \"Dekont\"){\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 7;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}else if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 7;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if($turu == \"EFT\"){\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 4;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}else if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 4;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if($turu == \"Evrak\"){//olmayacak\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 8;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}else if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 9;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if($turu == \"Havale\"){\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 3;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}else if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 3;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if($turu == \"Nakit\"){//olmayacak\r\n\t\t\t\t\t\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t5 = Kasa Tahsilat\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t6 = Kasa Ödeme\r\n\t\t\t\t\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\t\t\t\t\tif($borc == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 5;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_alacak = $alacak;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_alacak,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_alacak, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}else if($alacak == 0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_turu = 6;\r\n\t\t\t\t\t\t\t\t\t\t\t\t$ch_borc = $borc;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$this->db->query(\"INSERT INTO cariHareketleri (ch_belgeNumarasi,ch_turu,ch_cariID,ch_paraBirimi,ch_borc,ch_tarih,ch_olusturan,ch_olusturanAnaHesap,ch_olusturmaTarihi,ch_olusturmaSaati) VALUES ('\".$belgeNumarasi.\"', $ch_turu, $cid, 'TL', $ch_borc, '\".$tarih.\"', '106','91','\".$tarih.\"','\".$saati.\"')\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t    /* $cariAd = $rowData[0][1];\r\n\r\n\t\t\t\t\t\t\t\t\t$sorgu1 = $this->db->query(\"SELECT cari_id FROM cari WHERE cari_ad = '\".$cariAd.\"' \")->row();\r\n\t\t\t\t\t\t\t\t\t$cid = $sorgu1->cari_id;\r\n\r\n\t\t\t\t\t\t\t\t\t$vkn = $rowData[0][6];\r\n\t\t\t\t\t\t\t\t\t$vknLength = strlen($vkn);\r\n\r\n\t\t\t\t\t\t\t\t\t$vd = $rowData[0][5];\r\n\r\n\t\t\t\t\t\t\t\t\tif($vknLength == 10){//vkn\r\n\t\t\t\t\t\t\t\t\t\t$this->db->query(\"UPDATE cari SET cari_vergiNumarasi = $vkn, cari_vergiDairesi = '$vd' WHERE cari_id = $cid \");\r\n\t\t\t\t\t\t\t\t\t}else if($vknLength == 11){//tckn\r\n\t\t\t\t\t\t\t\t\t\t$this->db->query(\"UPDATE cari SET cari_vergiNumarasi = '', cari_tckn = $vkn  WHERE cari_id = $cid \");\r\n\t\t\t\t\t\t\t\t\t} */\r\n\t\t\t\t\t\t\t}\r\n            }else{\r\n            \techo $this->upload->display_errors();\r\n            }\r\n            \r\n          }\r\n\t\t\t}\t\t}\r\n\r\n\t/**\r\n\t * Yeni kullanıcı oluşturulduğunda otomatik olarak varsayılan kasa oluşturur\r\n\t *\r\n\t * @param int $kullanici_id Oluşturulan kullanıcının ID'si\r\n\t * @param int $olusturan_kullanici_id Kasayı oluşturan kullanıcının ID'si\r\n\t * @param int $anaHesap Ana hesap ID'si\r\n\t * @param string $tarih Oluşturma tarihi\r\n\t */\r\n\tprivate function otomatikKasaOlustur($kullanici_id, $olusturan_kullanici_id, $anaHesap, $tarih) {\r\n\t\ttry {\r\n\t\t\t// Kullanıcı bilgilerini al\r\n\t\t\t$kullaniciQ = \"SELECT kullanici_ad, kullanici_soyad FROM kullanicilar WHERE kullanici_id = '$kullanici_id'\";\r\n\t\t\t$kullanici = $this->db->query($kullaniciQ)->row();\r\n\t\t\t\r\n\t\t\tif ($kullanici) {\r\n\t\t\t\t$kullaniciAdSoyad = $kullanici->kullanici_ad . ' ' . $kullanici->kullanici_soyad;\r\n\t\t\t\t\r\n\t\t\t\t// Otomatik kasa bilgileri\r\n\t\t\t\t$kasaKodu = \"KASA-\" . str_pad($kullanici_id, 4, '0', STR_PAD_LEFT);\r\n\t\t\t\t$kasaAdi = $kullaniciAdSoyad . \" - Varsayılan Kasa\";\r\n\t\t\t\t$kasaBaslangic = 0; // Başlangıç bakiyesi 0\r\n\t\t\t\t\r\n\t\t\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\t\t\t\t\r\n\t\t\t\t// Aynı kasa kodunun var olup olmadığını kontrol et\r\n\t\t\t\t$kasaVarmiQ = \"SELECT * FROM kasa WHERE kasa_kodu = '$kasaKodu' AND kasa_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t\t\t$kasaVarmi = $this->db->query($kasaVarmiQ)->row();\r\n\t\t\t\t\r\n\t\t\t\tif (!$kasaVarmi) {\r\n\t\t\t\t\t// Kasa tablosuna kayıt ekle\r\n\t\t\t\t$dataKasa = array(\r\n\t\t\t\t\t\"kasa_kodu\" => $kasaKodu,\r\n\t\t\t\t\t\"kasa_adi\" => $kasaAdi,\r\n\t\t\t\t\t\"kasa_baslangic\" => $kasaBaslangic,\r\n\t\t\t\t\t\"kasa_aciklama\" => \"Kullanıcı oluşturulduğunda otomatik oluşturulan varsayılan kasa\",\r\n\t\t\t\t\t\"kasa_sorumlusu\" => $kullanici_id, // Yeni eklenen alan - kullanıcı ID'si\r\n\t\t\t\t\t\"kasa_olusturanAnaHesap\" => $anaHesap,\r\n\t\t\t\t\t\"kasa_olusturan\" => $olusturan_kullanici_id,\r\n\t\t\t\t\t\"kasa_olusturmaTarihi\" => $tarih,\r\n\t\t\t\t\t\"kasa_olusturmaSaati\" => $saati\r\n\t\t\t\t);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$this->vt->insert(\"kasa\", $dataKasa);\r\n\t\t\t\t\t$kasa_id = $this->db->insert_id();\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Kasa hareketleri tablosuna başlangıç kaydı ekle\r\n\t\t\t\t\t$dataKasaHareket = array(\r\n\t\t\t\t\t\t\"kh_kasaID\" => $kasa_id,\r\n\t\t\t\t\t\t\"kh_turu\" => 14, // Kasa açılış bakiyesi türü\r\n\t\t\t\t\t\t\"kh_giris\" => $kasaBaslangic,\r\n\t\t\t\t\t\t\"kh_tarih\" => $tarih,\r\n\t\t\t\t\t\t\"kh_aciklama\" => \"Otomatik Oluşturulan Kasa - Açılış Bakiyesi\",\r\n\t\t\t\t\t\t\"kh_olusturan\" => $olusturan_kullanici_id,\r\n\t\t\t\t\t\t\"kh_olusturanAnaHesap\" => $anaHesap,\r\n\t\t\t\t\t\t\"kh_olusturmaTarihi\" => $tarih,\r\n\t\t\t\t\t\t\"kh_olusturmaSaati\" => $saati\r\n\t\t\t\t\t);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$this->vt->insert(\"kasaHareketleri\", $dataKasaHareket);\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Log ekle (opsiyonel - eğer logekle fonksiyonu varsa)\r\n\t\t\t\t\tif (function_exists('logekle')) {\r\n\t\t\t\t\t\tlogekle(50, 2); // Kasa oluşturma log kodu\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (Exception $e) {\r\n\t\t\t// Hata durumunda sessizce devam et, kullanıcı oluşturma işlemini etkilemesin\r\n\t\t\t// İsteğe bağlı olarak log kaydı yapılabilir\r\n\t\t\tlog_message('error', 'Otomatik kasa oluşturma hatası: ' . $e->getMessage());\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Kullanıcı Grubu Yönetimi\r\n\t */\r\n\tpublic function kullaniciGrubu(){\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t$data[\"baslik\"] = \"Yönetici / Kullanıcı Grupları\";\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t// Kullanıcı gruplarını getir\r\n\t\t$gruplarQ = \"SELECT kg.*, \r\n\t\t\t\t\t COUNT(DISTINCT k.kullanici_id) as kullanici_sayisi,\r\n\t\t\t\t\t COUNT(DISTINCT kgy.kgy_id) as yetki_sayisi\r\n\t\t\t\t\t FROM kullanici_grubu kg \r\n\t\t\t\t\t LEFT JOIN kullanicilar k ON kg.kg_id = k.grup_id \r\n\t\t\t\t\t LEFT JOIN kullanici_grubu_yetkisi kgy ON kg.kg_id = kgy.kgy_grupID\r\n\t\t\t\t\t WHERE kg.kg_olusturanAnaHesap = '$anaHesap'\r\n\t\t\t\t\t GROUP BY kg.kg_id\r\n\t\t\t\t\t ORDER BY kg.kg_id DESC\";\r\n\t\t$data[\"gruplar\"] = $this->db->query($gruplarQ)->result();\r\n\r\n\t\t// Modül listesi\r\n\t\t$data[\"moduller\"] = [\r\n\t\t\t1 => 'Cari',\r\n\t\t\t2 => 'Stok', \r\n\t\t\t3 => 'Fatura',\r\n\t\t\t4 => 'Kasa',\r\n\t\t\t5 => 'Banka',\r\n\t\t\t6 => 'Rapor',\r\n\t\t\t7 => 'Giderler',\r\n\t\t\t8 => 'Tahsilat'\r\n\t\t];\r\n\r\n\t\t// Yetki listesi\r\n\t\t$data[\"yetkiler\"] = [\r\n\t\t\t1 => 'Görüntüleme',\r\n\t\t\t2 => 'Ekleme',\r\n\t\t\t3 => 'Düzenleme', \r\n\t\t\t4 => 'Silme'\r\n\t\t];\r\n\r\n\t\t$this->load->view(\"yonetici/kullanici-grubu\", $data);\r\n\t}\r\n\r\n\tpublic function kullaniciGrubuOlustur(){\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y-m-d');\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\t\t$data[\"kg_adi\"] = postval(\"kg_adi\");\r\n\t\t$data[\"kg_aciklama\"] = postval(\"kg_aciklama\");\r\n\t\t$data[\"kg_durum\"] = 1;\r\n\t\t$data[\"kg_olusturan\"] = $u_id;\r\n\t\t$data[\"kg_olusturanAnaHesap\"] = $anaHesap;\r\n\t\t$data[\"kg_olusturmaTarihi\"] = $tarihi;\r\n\t\t$data[\"kg_olusturmaSaati\"] = $saati;\r\n\r\n\t\t$this->vt->insert(\"kullanici_grubu\", $data);\r\n\t\t$grup_id = $this->db->insert_id();\r\n\r\n\t\t// Seçilen yetkileri kaydet\r\n\t\t$yetkiler = $this->input->post();\r\n\t\tforeach($yetkiler as $key => $value){\r\n\t\t\tif(strpos($key, 'yetki_') === 0 && is_array($value)){\r\n\t\t\t\t$parts = explode('_', $key);\r\n\t\t\t\t$modul = $parts[1];\r\n\t\t\t\t\r\n\t\t\t\tforeach($value as $yetki){\r\n\t\t\t\t\t$dataYetki = array(\r\n\t\t\t\t\t\t\"kgy_grupID\" => $grup_id,\r\n\t\t\t\t\t\t\"kgy_modul\" => $modul,\r\n\t\t\t\t\t\t\"kgy_yetki\" => $yetki,\r\n\t\t\t\t\t\t\"kgy_olusturan\" => $u_id,\r\n\t\t\t\t\t\t\"kgy_olusturanAnaHesap\" => $anaHesap,\r\n\t\t\t\t\t\t\"kgy_olusturmaTarihi\" => $tarihi,\r\n\t\t\t\t\t\t\"kgy_olusturmaSaati\" => $saati\r\n\t\t\t\t\t);\r\n\t\t\t\t\t$this->vt->insert(\"kullanici_grubu_yetkisi\", $dataYetki);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t$this->session->set_flashdata('kullanici_grubu_ok','OK');\r\n\t\tredirect(\"yonetici/kullanici-grubu\");\r\n\t}\t/**\r\n\t * Yeni kullanıcı grubu ekleme (POST handler)\r\n\t */\r\n\tpublic function kullaniciGrubuEkle(){\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y-m-d');\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\t\t// Form verilerini al\r\n\t\t$kg_adi = postval(\"kg_adi\");\r\n\t\t$kg_aciklama = postval(\"kg_aciklama\");\r\n\t\t// Basit doğrulama\r\n\t\tif(empty($kg_adi)){\r\n\t\t\t$this->session->set_flashdata('kullanici_grubu_hata','Grup adı boş olamaz!');\r\n\t\t\tredirect(\"yonetici/kullaniciGrubu\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$data[\"kg_adi\"] = $kg_adi;\r\n\t\t$data[\"kg_aciklama\"] = $kg_aciklama;\r\n\t\t$data[\"kg_durum\"] = 1;\r\n\t\t$data[\"kg_olusturan\"] = $u_id;\r\n\t\t$data[\"kg_olusturanAnaHesap\"] = $anaHesap;\r\n\t\t$data[\"kg_olusturmaTarihi\"] = $tarihi;\r\n\t\t$data[\"kg_olusturmaSaati\"] = $saati;\r\n\t\ttry {\r\n\t\t\t$this->vt->insert(\"kullanici_grubu\", $data);\r\n\t\t\t$this->session->set_flashdata('kullanici_grubu_ok','Kullanıcı Grubu başarıyla oluşturuldu!');\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$this->session->set_flashdata('kullanici_grubu_hata','Grup eklenirken hata oluştu: ' . $e->getMessage());\r\n\t\t}\r\n\r\n\t\tredirect(\"yonetici/kullaniciGrubu\");\r\n\t}\r\n\r\n\tpublic function kullaniciGrubuSil($id){\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t// Grubun bu ana hesaba ait olduğunu kontrol et\r\n\t\t$grupQ = \"SELECT * FROM kullanici_grubu WHERE kg_id = '$id' AND kg_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$grup = $this->db->query($grupQ)->row();\r\n\t\tif($grup){\r\n\t\t\t// Bu gruba bağlı kullanıcıları güncelle (grup bağlantısını kaldır)\r\n\t\t\t$this->db->query(\"UPDATE kullanicilar SET grup_id = NULL WHERE grup_id = '$id'\");\r\n\t\t\t\r\n\t\t\t// Grup yetkilerini sil\r\n\t\t\t$this->db->delete('kullanici_grubu_yetkisi', array('kgy_grupID' => $id));\r\n\t\t\t\r\n\t\t\t// Grubu sil\r\n\t\t\t$this->db->delete('kullanici_grubu', array('kg_id' => $id));\r\n\r\n\t\t\t$this->session->set_flashdata('kullanici_grubu_sil_ok','OK');\r\n\t\t}\r\n\r\n\t\tredirect(\"yonetici/kullanici-grubu\");\r\n\t}\r\n\r\n\tpublic function kullaniciGrubuDuzenle($id = null){\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t// Eğer ID verilmemişse kullanıcı grubu listesine yönlendir\r\n\t\tif(empty($id)) {\r\n\t\t\tredirect(\"yonetici/kullanici-grubu\");\r\n\t\t}\r\n\r\n\t\t$data[\"baslik\"] = \"Yönetici / Kullanıcı Grubu Düzenle\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t// Grup bilgilerini getir\r\n\t\t$grupQ = \"SELECT * FROM kullanici_grubu WHERE kg_id = '$id' AND kg_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$data[\"grup\"] = $this->db->query($grupQ)->row();\r\n\r\n\t\tif(!$data[\"grup\"]){\r\n\t\t\tredirect(\"yonetici/kullanici-grubu\");\r\n\t\t}\r\n\r\n\t\t// Grup yetkilerini getir\r\n\t\t$yetkilerQ = \"SELECT * FROM kullanici_grubu_yetkisi WHERE kgy_grupID = '$id'\";\r\n\t\t$yetkilerResult = $this->db->query($yetkilerQ)->result();\r\n\t\t\r\n\t\t$data[\"grup_yetkileri\"] = [];\r\n\t\tforeach($yetkilerResult as $yetki){\r\n\t\t\t$data[\"grup_yetkileri\"][$yetki->kgy_modul][] = $yetki->kgy_yetki;\r\n\t\t}\r\n\r\n\t\t// Modül listesi\r\n\t\t$data[\"moduller\"] = [\r\n\t\t\t1 => 'Cari',\r\n\t\t\t2 => 'Stok', \r\n\t\t\t3 => 'Fatura',\r\n\t\t\t4 => 'Kasa',\r\n\t\t\t5 => 'Banka',\r\n\t\t\t6 => 'Rapor',\r\n\t\t\t7 => 'Giderler',\r\n\t\t\t8 => 'Tahsilat',\r\n\t\t\t9 => 'Aktivasyon',\r\n\t\t\t1900 => 'Voip & Hakediş',\r\n\t\t\t1901 => 'Voip - Operatör Tanımla',\r\n\t\t\t1902 => 'Voip - Numara Tanımla',\r\n\t\t\t1903 => 'Voip - Numara Teslim',\r\n\t\t\t1904 => 'Voip - Günlük Harcama',\r\n\t\t\t1905 => 'Voip - Hakediş Tanımlama'\r\n\t\t];\r\n\r\n\t\t// Yetki listesi\r\n\t\t$data[\"yetkiler\"] = [\r\n\t\t\t1 => 'Görüntüleme',\r\n\t\t\t2 => 'Ekleme',\r\n\t\t\t3 => 'Düzenleme', \r\n\t\t\t4 => 'Silme'\r\n\t\t];\r\n\r\n\t\t$this->load->view(\"yonetici/kullanici-grubu-duzenle\", $data);\r\n\t}\r\n\r\n\tpublic function kullaniciGrubuGuncelle(){\r\n\t\tif(gibYetki()==1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif(isDemoActive() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y-m-d');\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\t\t$grup_id = postval(\"kg_id\");\r\n\r\n\t\t$data[\"kg_adi\"] = postval(\"kg_adi\");\r\n\t\t$data[\"kg_aciklama\"] = postval(\"kg_aciklama\");\r\n\t\t$data[\"kg_guncelleyen\"] = $u_id;\r\n\t\t$data[\"kg_guncellemeTarihi\"] = $tarihi;\r\n\t\t$data[\"kg_guncellemeSaati\"] = $saati;\r\n\r\n\t\t$this->vt->update('kullanici_grubu', array('kg_id' => $grup_id), $data);\r\n\r\n\t\t// Mevcut yetkileri sil\r\n\t\t$this->db->delete('kullanici_grubu_yetkisi', array('kgy_grupID' => $grup_id));\r\n\t\t\r\n\t\t// DEBUG: Confirm deletion\r\n\t\tif($u_id == 187) {\r\n\t\t\tlog_message('debug', \"PERMISSIONS DELETED for group: $grup_id\");\r\n\t\t}\r\n\r\n\t\t// Yeni yetkileri kaydet\r\n\t\t$yetkiler = $this->input->post();\r\n\t\t\r\n\t\t// DEBUG: Log all POST data for user 187 (your test user)\r\n\t\tif($u_id == 187) {\r\n\t\t\tlog_message('debug', 'GRUP YETKI GUNCELLEME DEBUG - User ID: ' . $u_id . ', Grup ID: ' . $grup_id);\r\n\t\t\tlog_message('debug', 'POST DATA: ' . json_encode($yetkiler));\r\n\t\t}\r\n\t\t\r\n\t\tforeach($yetkiler as $key => $value){\r\n\t\t\tif(strpos($key, 'yetki_') === 0 && is_array($value)){\r\n\t\t\t\t$parts = explode('_', $key);\r\n\t\t\t\t$modul = $parts[1];\r\n\t\t\t\t\r\n\t\t\t\t// DEBUG: Log each permission being saved\r\n\t\t\t\tif($u_id == 187) {\r\n\t\t\t\t\tlog_message('debug', \"PERMISSION SAVE - Module: $modul, Permissions: \" . json_encode($value));\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tforeach($value as $yetki){\r\n\t\t\t\t\t// Duplicate entry kontrolü\r\n\t\t\t\t\t$existingYetki = $this->vt->single('kullanici_grubu_yetkisi', array(\r\n\t\t\t\t\t\t'kgy_grupID' => $grup_id,\r\n\t\t\t\t\t\t'kgy_modul' => $modul,\r\n\t\t\t\t\t\t'kgy_yetki' => $yetki\r\n\t\t\t\t\t));\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (!$existingYetki) {\r\n\t\t\t\t\t\t$dataYetki = array(\r\n\t\t\t\t\t\t\t\"kgy_grupID\" => $grup_id,\r\n\t\t\t\t\t\t\t\"kgy_modul\" => $modul,\r\n\t\t\t\t\t\t\t\"kgy_yetki\" => $yetki,\r\n\t\t\t\t\t\t\t\"kgy_olusturan\" => $u_id,\r\n\t\t\t\t\t\t\t\"kgy_olusturanAnaHesap\" => $anaHesap,\r\n\t\t\t\t\t\t\t\"kgy_olusturmaTarihi\" => $tarihi,\r\n\t\t\t\t\t\t\t\"kgy_olusturmaSaati\" => $saati\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\t$this->vt->insert(\"kullanici_grubu_yetkisi\", $dataYetki);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// DEBUG: Confirm insertion\r\n\t\t\t\t\t\tif($u_id == 187) {\r\n\t\t\t\t\t\t\tlog_message('debug', \"INSERTED - Group: $grup_id, Module: $modul, Permission: $yetki\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// DEBUG: Already exists\r\n\t\t\t\t\t\tif($u_id == 187) {\r\n\t\t\t\t\t\t\tlog_message('debug', \"DUPLICATE SKIPPED - Group: $grup_id, Module: $modul, Permission: $yetki\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$this->session->set_flashdata('kullanici_grubu_guncelle_ok','OK');\r\n\t\tredirect(\"yonetici/kullaniciGrubu\");\r\n\t}\r\n\t/**\r\n\t * AJAX endpoint to get all countries (for responsibility areas modal)\r\n\t */\tpublic function getCountries(){\r\n\t\t$ulkelerQ = \"SELECT ulke_kodu as country_code, ulke_adi as country_name FROM ulkeler ORDER BY ulke_adi ASC\";\r\n\t\t$ulkeler = $this->db->query($ulkelerQ);\r\n\t\t\r\n\t\tif ($ulkeler->num_rows() > 0) {\r\n\t\t\t$countryList = array();\r\n\t\t\tforeach ($ulkeler->result() as $item) {\t\t\t\t$countryList[] = array(\r\n\t\t\t\t\t'code' => $item->country_code, \r\n\t\t\t\t\t'name' => $item->country_name\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\t$data = array('status' => 'ok', 'message' => '', 'data' => $countryList);\r\n\t\t} else {\r\n\t\t\t$data = array('status' => 'error', 'message' => 'Ülke Bulunamadı..!');\r\n\t\t}\r\n\t\t\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\t}\r\n\t/**\r\n\t * AJAX endpoint to get all provinces (for responsibility areas modal)\r\n\t * Enhanced to support country filtering\r\n\t */\r\n\tpublic function getProvinces(){\r\n\t\t$ulke_kodu = $this->input->post('ulke_kodu');\r\n\t\t\r\n\t\t// Base query for provinces\r\n\t\tif (!empty($ulke_kodu)) {\r\n\t\t\t// If iller table has ulke_kodu column, filter by it\r\n\t\t\t// For now, assume Turkey (code 1) gets all provinces, others get none\r\n\t\t\tif ($ulke_kodu == '1') {\r\n\t\t\t\t$illerQ = \"SELECT id, il FROM iller ORDER BY il ASC\";\r\n\t\t\t} else {\r\n\t\t\t\t// For other countries, return empty result or handle appropriately\r\n\t\t\t\t$illerQ = \"SELECT id, il FROM iller WHERE 1=0\"; // No results for non-Turkey countries\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Default: get all Turkish provinces\r\n\t\t\t$illerQ = \"SELECT id, il FROM iller ORDER BY il ASC\";\r\n\t\t}\r\n\t\t\r\n\t\t$iller = $this->db->query($illerQ);\r\n\t\t\r\n\t\tif ($iller->num_rows() > 0) {\r\n\t\t\t$provinceList = array();\r\n\t\t\tforeach ($iller->result() as $item) {\r\n\t\t\t\t$provinceList[] = array(\r\n\t\t\t\t\t'id' => $item->id, \r\n\t\t\t\t\t'il' => $item->il\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\t$data = array('status' => 'success', 'message' => '', 'data' => $provinceList);\r\n\t\t} else {\r\n\t\t\t$data = array('status' => 'error', 'message' => 'Bu ülke için il bulunamadı');\r\n\t\t}\r\n\t\t\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\t}\r\n\t/**\r\n\t * AJAX endpoint to get districts for a province (for responsibility areas)\r\n\t */\tpublic function getDistricts(){\r\n\t\t$il_id = $this->input->post('il_id');\r\n\t\t\r\n\t\tif (empty($il_id)) {\r\n\t\t\t$data = array('status' => 'error', 'message' => 'İl ID Bilgisi Alınamadı');\r\n\t\t} else {\r\n\t\t\t$ilceler = $this->db->get_where('ilceler', array('il_id' => $il_id));\r\n\t\t\tif ($ilceler->num_rows() > 0) {\r\n\t\t\t\t$ilceList = array();\r\n\t\t\t\tforeach ($ilceler->result() as $item) {\r\n\t\t\t\t\t$ilceList[] = array('id' => $item->id, 'ilce' => $item->ilce);\r\n\t\t\t\t}\r\n\t\t\t\t$data = array('status' => 'success', 'message' => '', 'data' => $ilceList);\r\n\t\t\t} else {\r\n\t\t\t\t$data = array('status' => 'error', 'message' => 'Bu il için ilçe bulunamadı');\r\n\t\t\t}\r\n\t\t}\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\t}\r\n\t/**\r\n\t * AJAX - Sorumluluk Bölgesi Ekle\r\n\t */\r\n\tpublic function addResponsibilityArea(){\r\n\t\t$this->output->set_content_type('application/json');\r\n\t\t\r\n\t\tif(gibYetki() == 1) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetkiniz yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$kullanici_id = $this->input->post('kullanici_id');\r\n\t\t$il_id = $this->input->post('il_id');\r\n\t\t$ilce_id = $this->input->post('ilce_id');\r\n\r\n\t\tif(!$kullanici_id || !$il_id || !$ilce_id) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Eksik parametreler']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Önce aynı kayıt var mı kontrol et\r\n\t\t$existing = $this->db->get_where('kullanici_sorumluluk_bolgesi', [\r\n\t\t\t'kullanici' => $kullanici_id,\r\n\t\t\t'il_id' => $il_id,\r\n\t\t\t'ilce_id' => $ilce_id,\r\n\t\t\t'durum' => 1\r\n\t\t])->row();\r\n\r\n\t\tif($existing) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu bölge zaten mevcut']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$data = [\r\n\t\t\t'kullanici' => $kullanici_id,\r\n\t\t\t'il_id' => $il_id,\r\n\t\t\t'ilce_id' => $ilce_id,\r\n\t\t\t'islemi_yapan' => $u_id,\r\n\t\t\t'islem_tarihi' => date('Y-m-d H:i:s'),\r\n\t\t\t'durum' => 1\r\n\t\t];\r\n\r\n\t\t$result = $this->db->insert('kullanici_sorumluluk_bolgesi', $data);\r\n\t\t\r\n\t\tif($result) {\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Sorumluluk bölgesi başarıyla eklendi']);\r\n\t\t} else {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt eklenirken hata oluştu']);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * AJAX - Sorumluluk Bölgesi Sil\r\n\t */\r\n\tpublic function deleteResponsibilityArea(){\r\n\t\t$this->output->set_content_type('application/json');\r\n\t\t\r\n\t\tif(gibYetki() == 1) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetkiniz yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$id = $this->input->post('id');\r\n\r\n\t\tif(!$id) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'ID parametresi eksik']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Kayıt var mı kontrol et\r\n\t\t$existing = $this->db->get_where('kullanici_sorumluluk_bolgesi', [\r\n\t\t\t'sorumluluk_id' => $id,\r\n\t\t\t'durum' => 1\r\n\t\t])->row();\r\n\r\n\t\tif(!$existing) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt bulunamadı']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Silmek yerine durumu pasif yap\r\n\t\t$data = [\r\n\t\t\t'durum' => 0,\r\n\t\t\t'islemi_yapan' => $u_id,\r\n\t\t\t'islem_tarihi' => date('Y-m-d H:i:s')\r\n\t\t];\r\n\r\n\t\t$result = $this->db->where('sorumluluk_id', $id)->update('kullanici_sorumluluk_bolgesi', $data);\r\n\t\t\r\n\t\tif($result) {\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Sorumluluk bölgesi başarıyla silindi']);\r\n\t\t} else {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Silme işlemi sırasında hata oluştu']);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Çoklu sorumluluk bölgesi ekleme\r\n\tpublic function addMultipleResponsibilityAreas(){\r\n\t\tif(gibYetki() == 1) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Yetkiniz yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$regions = $this->input->post('regions');\r\n\r\n\t\t// Validation\r\n\t\tif(!$regions || !is_array($regions) || empty($regions)) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Eksik parametre']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$successCount = 0;\r\n\t\t$duplicateCount = 0;\r\n\t\t$errorCount = 0;\r\n\t\t$addedRegions = [];\r\n\t\t$errors = [];\r\n\t\tforeach($regions as $region) {\r\n\t\t\t$kullanici_id = $region['kullanici_id'] ?? null;\r\n\t\t\t$ulke_kodu = $region['ulke_kodu'] ?? null;\r\n\t\t\t$il_id = $region['il_id'] ?? null;\r\n\t\t\t$ilce_id = $region['ilce_id'] ?? null;\r\n\t\t\t$durum = $region['durum'] ?? 1;\r\n\t\t\t$baslangic_tarihi = $region['baslangic_tarihi'] ?? null;\r\n\t\t\t$bitis_tarihi = $region['bitis_tarihi'] ?? null;\r\n\t\t\t$aciklama = $region['aciklama'] ?? null;\r\n\r\n\t\t\t// Her bölge için validation\r\n\t\t\tif(!$kullanici_id || !$il_id || !$ilce_id) {\r\n\t\t\t\t$errorCount++;\r\n\t\t\t\t$errors[] = \"Eksik parametre: Kullanıcı, İl veya İlçe ID\";\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t// Tarih validasyonu\r\n\t\t\tif($baslangic_tarihi && $bitis_tarihi && $baslangic_tarihi > $bitis_tarihi) {\r\n\t\t\t\t$errorCount++;\r\n\t\t\t\t$errors[] = \"Geçersiz tarih aralığı\";\r\n\t\t\t\tcontinue;\r\n\t\t\t}\t\t\t// Duplicate kontrolü\r\n\t\t\t$existing = $this->db->get_where('kullanici_sorumluluk_bolgesi', [\r\n\t\t\t\t'kullanici' => $kullanici_id,\r\n\t\t\t\t'ulke_kodu' => $ulke_kodu,\r\n\t\t\t\t'il_id' => $il_id,\r\n\t\t\t\t'ilce_id' => $ilce_id,\r\n\t\t\t\t'durum' => 1 // Aktif kayıtları kontrol et\r\n\t\t\t])->row();\r\n\r\n\t\t\tif($existing) {\r\n\t\t\t\t$duplicateCount++;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\t\t\t// Veritabanına ekle\r\n\t\t\t$data = [\r\n\t\t\t\t'kullanici' => $kullanici_id,\r\n\t\t\t\t'ulke_kodu' => !empty($ulke_kodu) ? $ulke_kodu : '1', // Default to Turkey\r\n\t\t\t\t'il_id' => $il_id,\r\n\t\t\t\t'ilce_id' => $ilce_id,\r\n\t\t\t\t'durum' => $durum,\r\n\t\t\t\t'islemi_yapan' => $u_id,\r\n\t\t\t\t'islem_tarihi' => date('Y-m-d H:i:s')\r\n\t\t\t];\r\n\r\n\t\t\t// Ek alanları ekle (eğer migration yapıldıysa)\r\n\t\t\tif($baslangic_tarihi) {\r\n\t\t\t\t$data['baslangic_tarihi'] = $baslangic_tarihi;\r\n\t\t\t}\r\n\t\t\tif($bitis_tarihi) {\r\n\t\t\t\t$data['bitis_tarihi'] = $bitis_tarihi;\r\n\t\t\t}\r\n\t\t\tif($aciklama) {\r\n\t\t\t\t$data['aciklama'] = $aciklama;\r\n\t\t\t}\r\n\r\n\t\t\t$result = $this->db->insert('kullanici_sorumluluk_bolgesi', $data);\r\n\t\t\t\r\n\t\t\tif($result) {\r\n\t\t\t\t$successCount++;\r\n\t\t\t\t\r\n\t\t\t\t// İl ve ilçe isimlerini al\r\n\t\t\t\t$il = $this->db->get_where('iller', ['id' => $il_id])->row();\r\n\t\t\t\t$ilce = $this->db->get_where('ilceler', ['id' => $ilce_id])->row();\r\n\t\t\t\t\r\n\t\t\t\t$addedRegions[] = [\r\n\t\t\t\t\t'id' => $this->db->insert_id(),\r\n\t\t\t\t\t'il_adi' => $il ? $il->il : '',\r\n\t\t\t\t\t'ilce_adi' => $ilce ? $ilce->ilce : '',\r\n\t\t\t\t\t'durum' => $durum,\r\n\t\t\t\t\t'baslangic_tarihi' => $baslangic_tarihi,\r\n\t\t\t\t\t'bitis_tarihi' => $bitis_tarihi,\r\n\t\t\t\t\t'aciklama' => $aciklama,\r\n\t\t\t\t\t'islem_tarihi' => date('Y-m-d H:i:s')\r\n\t\t\t\t];\r\n\t\t\t} else {\r\n\t\t\t\t$errorCount++;\r\n\t\t\t\t$errors[] = \"Veritabanı hatası\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Sonuç mesajı oluştur\r\n\t\t$message = '';\r\n\t\tif($successCount > 0) {\r\n\t\t\t$message .= $successCount . ' bölge başarıyla eklendi. ';\r\n\t\t}\r\n\t\tif($duplicateCount > 0) {\r\n\t\t\t$message .= $duplicateCount . ' bölge zaten mevcut. ';\r\n\t\t}\r\n\t\tif($errorCount > 0) {\r\n\t\t\t$message .= $errorCount . ' bölgede hata oluştu. ';\r\n\t\t}\r\n\r\n\t\tif($successCount > 0) {\r\n\t\t\techo json_encode([\r\n\t\t\t\t'status' => 'success', \r\n\t\t\t\t'message' => trim($message),\r\n\t\t\t\t'data' => $addedRegions,\r\n\t\t\t\t'stats' => [\r\n\t\t\t\t\t'success' => $successCount,\r\n\t\t\t\t\t'duplicate' => $duplicateCount,\r\n\t\t\t\t\t'error' => $errorCount\r\n\t\t\t\t]\r\n\t\t\t]);\r\n\t\t} else {\r\n\t\t\techo json_encode([\r\n\t\t\t\t'status' => 'error', \r\n\t\t\t\t'message' => $errorCount > 0 ? 'Hiçbir bölge eklenemedi: ' . implode(', ', array_unique($errors)) : 'Hiçbir bölge eklenmedi'\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * Backward compatibility alias for the old method name\r\n\t */\r\n\tpublic function kullaniciSorumlulukEkle(){\r\n\t\treturn $this->addResponsibilityArea();\r\n\t}\r\n\r\n\t/**\r\n\t * Sorumluluk Bölgesi Yönetimi Sayfası\r\n\t */\r\n\tpublic function sorumlulukBolgesi(){\r\n\t\t$data[\"baslik\"] = \"Yönetici / Sorumluluk Bölgesi Yönetimi\";\r\n\t\t// Kullanıcıları çek\r\n\t\t$data[\"kullanicilar\"] = $this->db->query(\"\r\n\t\t\tSELECT kullanici_id, kullanici_ad, kullanici_soyad, kullanici_kullaniciAdi as kullanici_adi \r\n\t\t\tFROM kullanicilar \r\n\t\t\tWHERE kullanici_durum = 1 \r\n\t\t\tORDER BY kullanici_ad, kullanici_soyad\r\n\t\t\")->result();\r\n\t\t\t\t// İlleri çek\r\n\t\t$data[\"iller\"] = $this->db->query(\"\r\n\t\t\tSELECT DISTINCT id as il_id, il as il_adi \r\n\t\t\tFROM iller \r\n\t\t\tORDER BY il\r\n\t\t\")->result();\r\n\t\t\t\t// Mevcut sorumluluk bölgelerini çek\r\n\t\t$data[\"sorumluluk_bolgeler\"] = $this->db->query(\"\r\n\t\t\tSELECT \r\n\t\t\t\tksb.*,\r\n\t\t\t\tk.kullanici_ad,\r\n\t\t\t\tk.kullanici_soyad,\r\n\t\t\t\ti.il as il_adi,\r\n\t\t\t\tic.ilce as ilce_adi\r\n\t\t\tFROM kullanici_sorumluluk_bolgesi ksb\r\n\t\t\tLEFT JOIN kullanicilar k ON ksb.kullanici = k.kullanici_id\r\n\t\t\tLEFT JOIN iller i ON ksb.il_id = i.id\r\n\t\t\tLEFT JOIN ilceler ic ON ksb.ilce_id = ic.id\r\n\t\t\tWHERE ksb.durum = 1\r\n\t\t\tORDER BY k.kullanici_ad, i.il, ic.ilce\r\n\t\t\")->result();\r\n\t\t\r\n\t\t$this->load->view('include/header', $data);\r\n\t\t$this->load->view('yonetici/sorumluluk-bolgesi', $data);\r\n\t\t$this->load->view('include/footer');\r\n\t}\r\n\t/**\r\n\t * AJAX - İlçeleri Getir\r\n\t */\r\n\tpublic function ilceler(){\r\n\t\t$this->output->set_content_type('application/json');\r\n\t\t\r\n\t\t$il_id = $this->input->post('il_id');\r\n\t\t\r\n\t\tif(!$il_id) {\r\n\t\t\techo json_encode([]);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t$ilceler = $this->db->query(\"\r\n\t\t\tSELECT id as ilce_id, ilce as ilce_adi \r\n\t\t\tFROM ilceler \r\n\t\t\tWHERE il_id = ? \r\n\t\t\tORDER BY ilce\t\t\", [$il_id])->result();\r\n\t\t\t\techo json_encode($ilceler);\t}\r\n}\r\n"
        }
    ]
}