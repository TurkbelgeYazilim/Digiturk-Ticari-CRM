{
    "sourceFile": "application/controllers/Home.php.backup",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1760110206331,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1760110220763,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-﻿<?php\r\n+<?php\r\n \r\n defined('BASEPATH') or exit('No direct script access allowed');\r\n \r\n \r\n@@ -1201,9 +1201,9 @@\n \t\t$this->email->set_crlf(\"\\r\\n\");\r\n \t\t$this->email->set_header('Content-Type', 'text/html; charset=UTF-8');\r\n \t\t$this->email->set_header('Content-Transfer-Encoding', '8bit');\r\n \t\t$this->email->to(\"talep@turkbelge.com.tr\");\r\n-\t\t$this->email->from(\"noreply@ileka.com.tr\",\"İleka CRM Sistemi\");\r\n+\t\t$this->email->from(\"bilgi@ileka.com.tr\",\"İleka CRM Sistemi\");\r\n \t\t$this->email->subject($mail_baslik);\r\n \t\t$this->email->message($mail_mesaj);\r\n \r\n \t\t// E-posta göndermeyi dene ama hata olursa kullanıcıyı bilgilendir\r\n"
                },
                {
                    "date": 1760110323229,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-﻿<?php\r\n+<?php\r\n \r\n defined('BASEPATH') or exit('No direct script access allowed');\r\n \r\n \r\n@@ -1463,10 +1463,10 @@\n \t\t\t\t\t'protocol' => 'smtp',\r\n \t\t\t\t\t'smtp_crypto' => 'tls',\r\n \t\t\t\t\t'smtp_host' => 'smtp.gmail.com',\r\n \t\t\t\t\t'smtp_port' => 587,\r\n-\t\t\t\t\t'smtp_user' => 'batuhan.kahraman@turkbelge.com.tr',\r\n-\t\t\t\t\t'smtp_pass' => 'gvcu gipq veov jkmh',\r\n+\t\t\t\t\t'smtp_user' => 'bilgi@ileka.com.tr',\r\n+\t\t\t\t\t'smtp_pass' => 'qcel gfig rgao qefo',\r\n \t\t\t\t\t'charset'   => 'utf-8',\r\n \t\t\t\t\t'mailtype'  => 'html',\r\n \t\t\t\t\t'wordwrap' => FALSE,\r\n \t\t\t\t\t'newline' => \"\\r\\n\",\r\n"
                }
            ],
            "date": 1760110206331,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') or exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Home extends CI_Controller\r\n\r\n{\r\n\r\n\r\n\r\n\tpublic function __construct()\r\n\r\n\t{\r\n\r\n\t\tparent::__construct();\r\n\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n\t\t$this->load->model('vt');\r\n\r\n\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n\t\t/*$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\tif(isDemoActive() == 1){\r\n\r\n\t\t\tif(demoDateExpireControl($control2->kullanici_id) <= -1){\r\n\r\n\t\t\t\tredirect('hata/hata2');\r\n\r\n\t\t\t}\r\n\r\n\t\t}*/\r\n\r\n\r\n\r\n\t\tif(!$control){\r\n\r\n\t\t\tredirect(\"check\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function index(){\r\n\r\n\t\r\n\r\n\t\t$data[\"baslik\"] = \"Anasayfa\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$modulGibSorgula = modulSorgula($anaHesap, 2);\r\n\r\n\t\t$modulOcrSorgula = modulSorgula($anaHesap, 4);\r\n\r\n\t\tif ($modulGibSorgula) {\r\n\r\n\t\t\tredirect(\"gib/index\");\r\n\r\n\t\t}else if ($modulOcrSorgula) {\r\n\r\n\t\t\tredirect(\"ocr/index\");\r\n\r\n\t\t} \t else {\t\t\t// Get logged-in user ID to filter only their sales invoices\r\n\r\n\t\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t\t$logged_in_user_id = $control2->kullanici_id;\r\n\r\n\t\t\t\r\n\r\n\t\t\t$satisFaturasiQ = \"SELECT satis_faturaTarihi as faturaTarihi,satis_faturaNo as faturaNo,satis_genelToplam as genelToplam,satis_paraBirimi as paraBirimi,'satis' as tip,satis_id as id,cari.cari_id,concat(cari.cari_ad,' ',cari.cari_soyad) as cari_ad FROM satisFaturasi inner join cari on satisFaturasi.satis_cariID=cari.cari_id  WHERE satis_olusturanAnaHesap = '$anaHesap' and satis_InvoiceType is null and satis_olusturan = '$logged_in_user_id' ORDER BY satis_id DESC LIMIT 6\";\r\n\r\n\t\t\t$alisFaturasiQ = \"SELECT alis_faturaTarihi as faturaTarihi,alis_faturaNo as faturaNo,alis_genelToplam as genelToplam,alis_paraBirimi as paraBirimi,'alis' as tip,alis_id as id,cari.cari_id,concat(cari.cari_ad,' ',cari.cari_soyad) as cari_ad FROM alisFaturasi inner join cari on alisFaturasi.alis_cariID=cari.cari_id  WHERE alis_olusturanAnaHesap = '$anaHesap' and alis_olusturan = '$logged_in_user_id' ORDER BY alis_id DESC LIMIT 6\";\r\n\r\n    \t\t\r\n\r\n    \t\t$af = $this->db->query($alisFaturasiQ)->result();\r\n\r\n            $sf = $this->db->query($satisFaturasiQ)->result();\r\n\r\n    \t\t\r\n\r\n    \t\r\n\r\n    \t$sf=seciliAlanlarSorgu($satisFaturasiQ);\r\n\r\n      \t$af=seciliAlanlarSorgu($alisFaturasiQ);\r\n\r\n         \r\n\r\n    \t\t$fatura = array_merge($sf, $af);\r\n\r\n    \t\trsort($fatura);\r\n\r\n    \t\t$data[\"fatura\"] = array_chunk($fatura, 6)[0];  \t\t// Calculate sales count and total amount for the logged-in user for today only\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$satis_adedi_bugun = 0;\r\n\r\n\t\t$satis_toplam_bugun = 0;\r\n\r\n\t\t\r\n\r\n\t\tif ($control2 && isset($control2->kullanici_id)) {\r\n\r\n\t\t\t$logged_in_user_id = $control2->kullanici_id;\r\n\r\n\t\t\t$bugun = date('Y-m-d');\r\n\r\n\t\t\t\t\t$satis_adedi_query = \"SELECT COUNT(*) as toplam_satis_faturasi \r\n\r\n\t\t\t\t\t\t\t\t  FROM satisFaturasi \r\n\r\n\t\t\t\t\t\t\t\t  WHERE satis_olusturan = '$logged_in_user_id' \r\n\r\n\t\t\t\t\t\t\t\t\tAND satis_faturaTarihi = '$bugun'\r\n\r\n\t\t\t\t\t\t\t\t\tAND satis_olusturanAnaHesap = '$anaHesap'\r\n\r\n\t\t\t\t\t\t\t\t\tAND satis_InvoiceType IS NULL\";\r\n\r\n\t\t\t$satis_adedi_result = $this->db->query($satis_adedi_query)->row();\r\n\r\n\t\t\t\r\n\r\n\t\t\tif ($satis_adedi_result && isset($satis_adedi_result->toplam_satis_faturasi)) {\r\n\r\n\t\t\t\t$satis_adedi_bugun = $satis_adedi_result->toplam_satis_faturasi;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Calculate total sales amount for today\r\n\r\n\t\t\t$satis_toplam_query = \"SELECT SUM(satis_genelToplam) as toplam_satis_tutari \r\n\r\n\t\t\t\t\t\t\t\t   FROM satisFaturasi \r\n\r\n\t\t\t\t\t\t\t\t   WHERE satis_olusturan = '$logged_in_user_id' \r\n\r\n\t\t\t\t\t\t\t\t\t AND satis_faturaTarihi = '$bugun'\r\n\r\n\t\t\t\t\t\t\t\t\t AND satis_olusturanAnaHesap = '$anaHesap'\r\n\r\n\t\t\t\t\t\t\t\t\t AND satis_InvoiceType IS NULL\";\r\n\r\n\t\t\t$satis_toplam_result = $this->db->query($satis_toplam_query)->row();\r\n\r\n\t\t\t\r\n\r\n\t\t\tif ($satis_toplam_result && isset($satis_toplam_result->toplam_satis_tutari)) {\r\n\r\n\t\t\t\t$satis_toplam_bugun = $satis_toplam_result->toplam_satis_tutari ?: 0;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"satis_adedi_bugun\"] = $satis_adedi_bugun;\r\n\r\n\t\t$data[\"satis_toplam_bugun\"] = $satis_toplam_bugun;\r\n\r\n         \r\n\r\n\t\t\t$this->load->view('index', $data);\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function istatistikDonut()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$satisFaturasiQ = \"SELECT sum(satis_genelToplam) as toplam,'satis' as tip,satis_id as id FROM satisFaturasi WHERE satis_olusturanAnaHesap = '$anaHesap' and satis_InvoiceType is null ORDER BY satis_id DESC LIMIT 6\";\r\n\r\n\t\t$sf = $this->db->query($satisFaturasiQ)->row();\r\n\r\n\r\n\r\n\t\t$alisFaturasiQ = \"SELECT sum(alis_genelToplam) as toplam,'alis' as tip,alis_id as id FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap' ORDER BY alis_id DESC LIMIT 6\";\r\n\r\n\t\t$af = $this->db->query($alisFaturasiQ)->row();\r\n\r\n\t\t$data = \"$sf->toplam,$af->toplam\";\r\n\r\n\t\t\r\n\r\n\t\tprint ($data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function istatistikBar()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$bugun = date(\"Y-m-d\");\r\n\r\n\t\t$once = strtotime('-6 days', strtotime($bugun));\r\n\r\n\t\t$dateOnce = date(\"Y-m-d\", $once);\r\n\r\n\r\n\r\n\t\t$satisFaturasiQ = \"SELECT satis_faturaTarihi,sum(satis_genelToplam) as satis_genelToplam FROM satisFaturasi where satis_InvoiceType is null and satis_olusturanAnaHesap=$anaHesap and satis_faturaTarihi BETWEEN '$dateOnce' and '$bugun'  GROUP by satis_faturaTarihi order by satis_faturaTarihi ASC \";\r\n\r\n\t\t$sf = $this->db->query($satisFaturasiQ)->result();\r\n\r\n\t\t$alisFaturasiQ = \"SELECT alis_faturaTarihi,sum(alis_genelToplam) as alis_genelToplam FROM alisFaturasi where alis_olusturanAnaHesap=$anaHesap and alis_faturaTarihi BETWEEN '$dateOnce' and '$bugun' GROUP by alis_faturaTarihi order by alis_faturaTarihi ASC\";\r\n\r\n\r\n\r\n\t\t$af = $this->db->query($alisFaturasiQ)->result();\r\n\r\n\t\t$dataSf = \"\";\r\n\r\n\t\t$dataAf = \"\";\r\n\r\n\t\t$dataGun = \"\";\r\n\r\n\r\n\r\n\t\tfor ($i = $once; $i <= strtotime($bugun); $i = $i + 86400) {\r\n\r\n\t\t\t$date = date(\"Y-m-d\", $i);\r\n\r\n\r\n\r\n\t\t\t$dataGun .= gunler(date('w', $i)) . \",\";\r\n\r\n\t\t\t$j = 0;\r\n\r\n\t\t\t$k = 0;\r\n\r\n\t\t\tforeach ($sf as $satis) {\r\n\r\n\t\t\t\tif ($satis->satis_faturaTarihi == $date) {\r\n\r\n\t\t\t\t\t$dataSf .= \"\" . round($satis->satis_genelToplam, 2) . \",\";\r\n\r\n\t\t\t\t\t$j = 1;\r\n\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif ($j == 0)\r\n\r\n\t\t\t\t$dataSf .= \"0,\";\r\n\r\n\r\n\r\n\t\t\tforeach ($af as $alis) {\r\n\r\n\t\t\t\tif ($alis->alis_faturaTarihi == $date) {\r\n\r\n\t\t\t\t\t$dataAf .= \"\" . round($alis->alis_genelToplam, 2) . \",\";\r\n\r\n\t\t\t\t\t$k = 1;\r\n\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif ($k == 0)\r\n\r\n\t\t\t\t$dataAf .= \"0,\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t$data = trim($dataSf, \",\") . \"-\" . trim($dataAf, \",\") . \"-\" . trim($dataGun, \",\");\r\n\r\n\r\n\r\n\t\tprint ($data);\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function get_ilceler()\r\n\r\n\t{\r\n\r\n\t\t//ajaxta post ile gelen il id'si\r\n\r\n\t\t$il_id = $this->input->post('il_id');\r\n\r\n\t\tif (empty($il_id)) {\r\n\r\n\t\t\t$data = array('status' => 'error', 'message' => 'Ä°l ID Bilgisi AlÄ±namadÄ±..!');\r\n\r\n\t\t} else {\r\n\r\n\t\t\t//ile gÃ¶re ilÃ§eler Ã§ekiliyor...\r\n\r\n\t\t\t$ilceler = $this->db->get_where('ilceler', array('il_id' => $il_id));\r\n\r\n\t\t\tif ($ilceler->num_rows() > 0) {\r\n\r\n\t\t\t\t$ilceList = array();\r\n\r\n\t\t\t\tforeach ($ilceler->result() as $item) {\r\n\r\n\t\t\t\t\t$ilceList[] = array('id' => $item->id, 'ilce' => $item->ilce);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//var olan iller data keyine aktarÄ±lÄ±yor...\r\n\r\n\t\t\t\t$data = array('status' => 'ok', 'message' => '', 'data' => $ilceList);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$data = array('status' => 'error', 'message' => 'Ä°lÃ§e BulunamadÄ±..!');\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t//Ã§Ä±ktÄ±yÄ± jsona uygun bir yapÄ±da set ediyoruz...\r\n\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t * İlleri getir (ülke bazında)\r\n\t */\r\n\tpublic function get_iller()\r\n\t{\r\n\t\t$ulke_id = $this->input->post('ulke_id');\r\n\t\tif (empty($ulke_id)) {\r\n\t\t\t// Eğer ulke_id yoksa, tüm illeri getir (Türkiye için)\r\n\t\t\t$iller = $this->db->order_by('il', 'ASC')->get('iller');\r\n\t\t} else {\r\n\t\t\t// Belirtilen ülkeye ait illeri getir\r\n\t\t\t$iller = $this->db->where('ulke_id', $ulke_id)->order_by('il', 'ASC')->get('iller');\r\n\t\t}\r\n\t\t\r\n\t\tif ($iller->num_rows() > 0) {\r\n\t\t\t$ilList = array();\r\n\t\t\tforeach ($iller->result() as $item) {\r\n\t\t\t\t$ilList[] = array('id' => $item->id, 'il' => $item->il);\r\n\t\t\t}\r\n\t\t\t$data = array('status' => 'ok', 'message' => '', 'data' => $ilList);\r\n\t\t} else {\r\n\t\t\t$data = array('status' => 'error', 'message' => 'İl Bulunamadı..!');\r\n\t\t}\r\n\t\t\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\t}\r\n\r\n\t/**\r\n\t * Ülkeleri getir\r\n\t */\r\n\tpublic function get_ulkeler()\r\n\t{\r\n\t\t$ulkeler = $this->db->order_by('ulke_adi', 'ASC')->get('ulkeler');\r\n\t\t\r\n\t\tif ($ulkeler->num_rows() > 0) {\r\n\t\t\t$ulkeList = array();\r\n\t\t\tforeach ($ulkeler->result() as $item) {\r\n\t\t\t\t$ulkeList[] = array(\r\n\t\t\t\t\t'id' => $item->id, \r\n\t\t\t\t\t'ulke_adi' => $item->ulke_adi,\r\n\t\t\t\t\t'ulke_kodu' => $item->ulke_kodu\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\t$data = array('status' => 'ok', 'message' => '', 'data' => $ulkeList);\r\n\t\t} else {\r\n\t\t\t$data = array('status' => 'error', 'message' => 'Ülke Bulunamadı..!');\r\n\t\t}\r\n\t\t\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\t}\r\n\r\n\t/**\r\n\t * Test endpoint for countries - remove after testing\r\n\t */\r\n\tpublic function test_ulkeler()\r\n\t{\r\n\t\t$ulkeler = $this->db->order_by('ulke_adi', 'ASC')->get('ulkeler');\r\n\t\techo \"<h3>Ülkeler Tablosu Test</h3>\";\r\n\t\techo \"<p>Toplam kayıt: \" . $ulkeler->num_rows() . \"</p>\";\r\n\t\tif ($ulkeler->num_rows() > 0) {\r\n\t\t\techo \"<table border='1'>\";\r\n\t\t\techo \"<tr><th>ID</th><th>Ülke Adı</th><th>Ülke Kodu</th></tr>\";\r\n\t\t\tforeach ($ulkeler->result() as $ulke) {\r\n\t\t\t\techo \"<tr><td>\" . $ulke->id . \"</td><td>\" . $ulke->ulke_adi . \"</td><td>\" . $ulke->ulke_kodu . \"</td></tr>\";\r\n\t\t\t}\r\n\t\t\techo \"</table>\";\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function hata()\r\n\r\n\t{\r\n\r\n\t\t//logekle(54,7);\r\n\r\n\t\t$this->load->view('hata');\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function hata2($id)\r\n\r\n\t{\r\n\r\n\t\tif($id == 1){//gib modÃ¼l yok\r\n\r\n\t\t\t$data[\"hataBaslik\"] = \"ModÃ¼le sahip deÄŸilsiniz!\";\r\n\r\n\t\t\t$data[\"hataMesaji\"] = \"GIB/IVD'ye gelen ilekaSoft Ã¼zerinde gÃ¶rÃ¼ntÃ¼leyebilmek, muhasebe iÅŸlemlerinize dahil edebilmek iÃ§in modÃ¼le sahip olmanÄ±z gerekmektedir! <hr>DetaylÄ± bilgi ve modÃ¼lÃ¼ talep etmek iÃ§in lÃ¼tfen arayÄ±nÄ±z: <a href='tel:0850 333 0 353' style='text-decoration: underline;color:#000!important;'>0850 333 0 353</a>\";\r\n\r\n\t\t}else if($id == 2){//admin deÄŸil\r\n\r\n\t\t\t$data[\"hataBaslik\"] = \"Yetkiniz yok!\";\r\n\r\n\t\t\t$data[\"hataMesaji\"] = \"Yetkiniz olmayan bir sayfaya girmek istediÄŸiniz iÃ§in bu sayfa sizlerle paylaÅŸÄ±lamÄ±yor.\";\r\n\r\n\t\t}else if($id == 3){//demo sÃ¼resi bitti\r\n\r\n\t\t\t$data[\"hataBaslik\"] = \"Demo sÃ¼reniz sona erdi.\";\r\n\r\n\t\t\t$data[\"hataMesaji\"] = \"Ãœcretsiz kullanÄ±m sÃ¼reniz sona ermiÅŸ, bilgileriniz bir sÃ¼re daha sunucularÄ±mÄ±zda saklanmaya devam edecektir, Ã¼yeliÄŸinizi devam ettirmek iÃ§in <a href='#'>satÄ±n alma</a> sayfasÄ±nÄ± ziyaret ediniz.\";\r\n\r\n\t\t}\r\n\r\n\t\t$this->load->view('hata_d',$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function logout()\r\n\r\n\t{\r\n\r\n\t\tlogekle(54, 6);\r\n\r\n\t\t$this->session->sess_destroy();\r\n\r\n\t\tredirect(base_url('giris'));\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function tests2()\r\n\r\n\t{\r\n\r\n\t\t$ws = 'https://apiportal.turkbelge.com.tr/TurkBelgeWS.asmx?wsdl';\r\n\r\n\r\n\r\n\t\t$trace = true;\r\n\r\n\t\t$exceptions = false;\r\n\r\n\r\n\r\n\t\t$xml_array->request = '';\r\n\r\n\r\n\r\n\t\t$client = new SoapClient($ws, array('trace' => $trace, 'exceptions' => $exceptions));\r\n\r\n\r\n\r\n\t\t//var_dump($client->__getFunctions());die;\r\n\r\n\r\n\r\n\t\t$response = $client->GetGibUserListAdded($xml_array);\r\n\r\n\t\tprint_r($response);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function ubltest(){\r\n\r\n\t\t$xml = new SimpleXMLElement('<?xml version=\"1.0\" encoding=\"UTF-8\"?><Invoice/>');\r\n\r\n\t\t$xml->addAttribute('xmlns', 'urn:oasis:names:specification:ubl:schema:xsd:Invoice-2');\r\n\r\n\t\t$xml->addAttribute('xmlns:qdt', 'urn:oasis:names:specification:ubl:schema:xsd:QualifiedDatatypes-2');\r\n\r\n\t\t$xml->addAttribute('xmlns:cbc', 'urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2');\r\n\r\n\t\t$xml->addAttribute('xmlns:udt', 'urn:un:unece:uncefact:data:draft:UnqualifiedDataTypesSchemaModule:2');\r\n\r\n\t\t$xml->addAttribute('xmlns:cac', 'urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2');\r\n\r\n\t\t$xml->addAttribute('xmlns:ccts', 'urn:un:unece:uncefact:data:draft:UnqualifiedDataTypesSchemaModule:2');\r\n\r\n\t\t$xml->addAttribute('xmlns:udt', 'urn:oasis:names:specification:ubl:schema:xsd:CoreComponentParameters-2');\r\n\r\n\t\t$xml->addAttribute('xmlns:stat', 'urn:oasis:names:specification:ubl:schema:xsd:DocumentStatusCode-1.0');\r\n\r\n\r\n\r\n\t\t$xml->addChild('cbc:UBLVersionID', '2.1');\r\n\r\n\r\n\r\n\t\techo $xml->asXml();\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function sessionKontrol(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$sql=\"select * from kullanicilar where kullanici_id=$u_id\";\r\n\r\n\t\t$exe=$this->db->query($sql)->row();\r\n\r\n\t\t\tif ($_SESSION[\"kullanici_oturumDurum\"] == $exe->kullanici_oturumDurum)\r\n\r\n\t\t\t\t$sonuc = \"0\";\r\n\r\n\t\t\telse {\r\n\r\n\t\t\t\t$sonuc = \"1\";\r\n\r\n\t\t\t}\r\n\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($sonuc));\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function destek(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Destek Sistemi\";\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(1);\r\n\r\n\r\n\r\n\t\t$segment = 1;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif($sayfa){$pagem = ($page-1)*$limit;}\r\n\r\n\t\telse{$pagem = 0;}\r\n\r\n\r\n\r\n\t\t// Filtreler\r\n\r\n\t\t$durum_filtre = $this->input->get(\"durum\");\r\n\r\n\t\t$kullanici_filtre = $this->input->get(\"kullanici\");\r\n\r\n\r\n\r\n\t\t// grup_id = 1 olan kullanıcılar tüm talepleri görebilir, diğerleri sadece kendi taleplerini\r\n\r\n\t\t$this->load->helper('destek');\r\n\r\n\t\t$user_group_id = $control2->grup_id; $isAdminGroup = ($user_group_id == 1);\r\n\r\n\t\t\r\n\r\n\t\t// WHERE koÅŸullarÄ±nÄ± hazÄ±rla\r\n\r\n\t\t$where_conditions = array();\r\n\r\n\t\t\r\n\r\n\t\tif($isAdminGroup){\r\n\r\n\t\t\t// Admin kullanÄ±cÄ± - tÃ¼m talepleri gÃ¶ster (kullanÄ±cÄ± bilgileri ile birlikte)\r\n\r\n\t\t\t$base_query = \"SELECT d.*, d.destek_unreadReplies, CONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as kullanici_adsoyad, k.kullanici_eposta\r\n\r\n\t\t\t\t\t  FROM destek d \r\n\r\n\t\t\t\t\t  LEFT JOIN kullanicilar k ON d.destek_olusturan = k.kullanici_id\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Filtre koÅŸullarÄ±nÄ± ekle\r\n\r\n\t\t\tif (!empty($durum_filtre)) {\r\n\r\n\t\t\t\t$where_conditions[] = \"d.destek_status = \" . intval($durum_filtre);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif (!empty($kullanici_filtre)) {\r\n\r\n\t\t\t\t$where_conditions[] = \"d.destek_olusturan = \" . intval($kullanici_filtre);\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Normal kullanÄ±cÄ± - sadece kendi taleplerini gÃ¶ster\r\n\r\n\t\t\t$base_query = \"SELECT d.*, d.destek_unreadReplies, CONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as kullanici_adsoyad, k.kullanici_eposta,\r\n\r\n\t\t\t\t\t  (SELECT COUNT(*) FROM destek_yanit dy WHERE dy.dyanit_destekID = d.destek_id AND dy.dyanit_yanitlayan != $u_id AND (dy.dyanit_isRead = 0 OR dy.dyanit_isRead IS NULL)) as destek_unreadReplies \r\n\r\n\t\t\t\t\t  FROM destek d \r\n\r\n\t\t\t\t\t  LEFT JOIN kullanicilar k ON d.destek_olusturan = k.kullanici_id\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$where_conditions[] = \"d.destek_olusturan = $u_id\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Filtre koÅŸullarÄ±nÄ± ekle\r\n\r\n\t\t\tif (!empty($durum_filtre)) {\r\n\r\n\t\t\t\t$where_conditions[] = \"d.destek_status = \" . intval($durum_filtre);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// WHERE koÅŸullarÄ±nÄ± birleÅŸtir\r\n\r\n\t\t$where_clause = \"\";\r\n\r\n\t\tif (!empty($where_conditions)) {\r\n\r\n\t\t\t$where_clause = \" WHERE \" . implode(\" AND \", $where_conditions);\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Count sorgusu\r\n\r\n\t\t$countq = \"SELECT COUNT(*) as total FROM destek d\" . \r\n\r\n\t\t\t\t  ($isAdminGroup ? \"\" : \" WHERE d.destek_olusturan = $u_id\") .\r\n\r\n\t\t\t\t  (!empty($durum_filtre) ? ($isAdminGroup ? \" WHERE\" : \" AND\") . \" d.destek_status = \" . intval($durum_filtre) : \"\") .\r\n\r\n\t\t\t\t  (!empty($kullanici_filtre) && $isAdminGroup ? (!empty($durum_filtre) ? \" AND\" : \" WHERE\") . \" d.destek_olusturan = \" . intval($kullanici_filtre) : \"\");\r\n\r\n\t\t\r\n\r\n\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t$count = $countexe->total;\r\n\r\n\t\t\r\n\r\n\t\t// Ana sorgu\r\n\r\n\t\t$sorgu = $base_query . $where_clause . \" ORDER BY d.destek_id DESC LIMIT $pagem,$limit\";\r\n\r\n\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"destekler\"] = $this->db->query($sorgu)->result();\r\n\r\n\t\t$data[\"isAdmin\"] = $isAdminGroup;\r\n\r\n\t\t\r\n\r\n\t\t// Filtre verileri\r\n\r\n\t\t$data[\"durum_filtre\"] = $durum_filtre;\r\n\r\n\t\t$data[\"kullanici_filtre\"] = $kullanici_filtre;\r\n\r\n\t\t\r\n\r\n\t\t// Destek durumlarÄ±\r\n\r\n\t\t$data[\"destek_durumlari\"] = array(\r\n\r\n\t\t\t1 => 'AÃ§Ä±k',\r\n\r\n\t\t\t2 => 'Beklemede', \r\n\r\n\t\t\t3 => 'KapalÄ±'\r\n\r\n\t\t);\r\n\r\n\t\t\r\n\r\n\t\t// KullanÄ±cÄ± listesi (sadece admin iÃ§in)\r\n\r\n\t\tif ($isAdminGroup) {\r\n\r\n\t\t\t$data[\"kullanicilar\"] = $this->db->query(\"\r\n\r\n\t\t\t\tSELECT DISTINCT k.kullanici_id, CONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as kullanici_adsoyad\r\n\r\n\t\t\t\tFROM kullanicilar k\r\n\r\n\t\t\t\tINNER JOIN destek d ON k.kullanici_id = d.destek_olusturan\r\n\r\n\t\t\t\tORDER BY k.kullanici_ad, k.kullanici_soyad\r\n\r\n\t\t\t\")->result();\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$this->load->view(\"destek\",$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function yeniTicket(){\r\n\t\t// Upload library'yi yükle\r\n\t\t$this->load->library('upload');\r\n\t\t\r\n\t\t// Session kontrolü\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\tif(!$control2 || !isset($control2->kullanici_id)) {\r\n\t\t\t// Session yoksa login sayfasına yönlendir\r\n\t\t\tredirect(base_url(\"check\"));\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t// POST veri kontrolü - sadece form gönderilmişse işlem yap\r\n\t\tif(!$_POST || empty(postval(\"destek_title\"))) {\r\n\t\t\t// POST verisi yoksa destek sayfasına yönlendir\r\n\t\t\tredirect(base_url('destek'));\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarih = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\t\t$data[\"destek_title\"] = postval(\"destek_title\");\r\n\t\t$data[\"destek_department\"] = postval(\"destek_department\");\r\n\t\t$data[\"destek_priority\"] = postval(\"destek_priority\");\r\n\r\n\t\t$data[\"destek_status\"] = 1;\r\n\r\n\t\t$data[\"destek_isRead\"] = 1;\r\n\r\n\t\t$data[\"destek_date\"] = $tarih;\r\n\r\n\t\t$data[\"destek_ip\"] = ipadresial();\r\n\r\n\t\t$data[\"destek_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"destek_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"destek\", $data);\r\n\r\n\r\n\r\n\t\t$destek_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t$this->load->library('upload');\r\n\r\n\t\t$config['upload_path'] = './assets/bulut/tickets/';\r\n\r\n\t\t$config['encrypt_name'] = TRUE;\r\n\r\n\t\t$config['allowed_types']=\"jpg|jpeg|png|xml|pdf\";\r\n\r\n\t\t$config['max_size']=\"1024\";\r\n\r\n\t\t$config['remove_space']=true;\r\n\r\n\r\n\r\n\t\t$this->upload->initialize($config);\r\n\r\n\r\n\r\n\t\t// Ã‡oklu dosya yÃ¼kleme\r\n\r\n\t\t$uploaded_files = array();\r\n\r\n\t\t$upload_errors = array();\r\n\r\n\t\t\r\n\r\n\t\tif(isset($_FILES['destek_files']) && !empty($_FILES['destek_files']['name'][0])){\r\n\r\n\t\t\t$file_count = count($_FILES['destek_files']['name']);\r\n\r\n\t\t\t\r\n\r\n\t\t\tfor($i = 0; $i < $file_count; $i++){\r\n\r\n\t\t\t\tif(!empty($_FILES['destek_files']['name'][$i])){\r\n\r\n\t\t\t\t\t$_FILES['single_file']['name'] = $_FILES['destek_files']['name'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['type'] = $_FILES['destek_files']['type'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['tmp_name'] = $_FILES['destek_files']['tmp_name'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['error'] = $_FILES['destek_files']['error'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['size'] = $_FILES['destek_files']['size'][$i];\r\n\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\tif ($this->upload->do_upload('single_file')){\r\n\r\n\t\t\t\t\t\t$datam = $this->upload->data();\r\n\r\n\t\t\t\t\t\t$uploaded_files[] = $datam['file_name'];\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t$upload_errors[] = $this->upload->display_errors();\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// EÄŸer hata varsa ve hiÃ§ dosya yÃ¼klenmediyse talebi sil\r\n\r\n\t\t\tif(!empty($upload_errors) && empty($uploaded_files)){\r\n\r\n\t\t\t\t$this->session->set_flashdata('resim_hata','OK');\r\n\r\n\t\t\t\t$this->vt->del(\"destek\",\"destek_id\",$destek_id);\r\n\r\n\t\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Ana mesajÄ± destek_yanit tablosuna ekle\r\n\r\n\t\t$data_d[\"dyanit_destekID\"] = $destek_id;\r\n\r\n\t\t$data_d[\"dyanit_yanitlayan\"] = $u_id;\r\n\r\n\t\t$data_d[\"dyanit_mesaj\"] = postval(\"destek_msg\");\r\n\r\n\t\t$data_d[\"dyanit_resim\"] = !empty($uploaded_files) ? $uploaded_files[0] : NULL; // Ä°lk dosyayÄ± ana resim olarak kaydet\r\n\r\n\t\t$data_d[\"dyanit_tarih\"] = $tarih;\r\n\r\n\t\t$data_d[\"dyanit_isAdmin\"] = 0;\r\n\r\n\t\t$data_d[\"dyanit_yanitlayanAnaHesap\"] = $anaHesap;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"destek_yanit\", $data_d);\r\n\r\n\t\t\r\n\r\n\t\t// EÄŸer birden fazla dosya varsa, diÄŸerlerini ayrÄ± yanÄ±tlar olarak kaydet\r\n\r\n\t\tif(count($uploaded_files) > 1){\r\n\r\n\t\t\tfor($i = 1; $i < count($uploaded_files); $i++){\r\n\r\n\t\t\t\t$data_extra[\"dyanit_destekID\"] = $destek_id;\r\n\r\n\t\t\t\t$data_extra[\"dyanit_yanitlayan\"] = $u_id;\r\n\r\n\t\t\t\t$data_extra[\"dyanit_mesaj\"] = \"\"; // Ek dosya iÃ§in mesaj boÅŸ\r\n\r\n\t\t\t\t$data_extra[\"dyanit_resim\"] = $uploaded_files[$i];\r\n\r\n\t\t\t\t$data_extra[\"dyanit_tarih\"] = $tarih;\r\n\r\n\t\t\t\t$data_extra[\"dyanit_isAdmin\"] = 0;\r\n\r\n\t\t\t\t$data_extra[\"dyanit_yanitlayanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->vt->insert(\"destek_yanit\", $data_extra);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$mail_config = Array(\r\n\t\t\t'protocol' => 'smtp',\r\n\t\t\t'smtp_crypto' => 'tls',\r\n\t\t\t'smtp_host' => 'smtp.gmail.com',\r\n\t\t\t'smtp_port' => 587,\r\n\t\t\t'smtp_user' => 'batuhan.kahraman@turkbelge.com.tr',\r\n\t\t\t'smtp_pass' => 'gvcu gipq veov jkmh',\r\n\t\t\t'charset'   => 'utf-8',\r\n\t\t\t'mailtype'  => 'html',\r\n\t\t\t'wordwrap' => FALSE,\r\n\t\t\t'newline' => \"\\r\\n\",\r\n\t\t\t'crlf' => \"\\r\\n\",\r\n\t\t\t'dsn' => FALSE,\r\n\t\t\t'multipart' => 'mixed'\r\n\t\t);\r\n\r\n\r\n\r\n\t\t// Talep bilgilerini al\r\n\r\n\t\t$son_talep = $this->db->query(\"SELECT * FROM destek WHERE destek_olusturan = $u_id ORDER BY destek_id DESC LIMIT 1\")->row();\r\n\r\n\t\t$kullanici = session(\"r\", \"login_info\");\r\n\r\n\t\t$mesaj_icerigi = postval(\"destek_msg\"); // GerÃ§ek mesaj iÃ§eriÄŸini al\r\n\r\n\t\t\r\n\r\n\t\t// Mail içeriğini zenginleştir\r\n\r\n\t\t$mail_baslik = 'İlekaSoft CRM - Yeni Destek Talebi #' . ($son_talep ? $son_talep->destek_id : 'N/A');\r\n\r\n\t\t$mail_mesaj = '\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\r\n    <meta charset=\"UTF-8\">\r\n    <style>\r\n\r\n        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }\r\n\r\n        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\r\n\r\n        .header { background-color: #007bff; color: white; padding: 20px; text-align: center; }\r\n\r\n        .content { padding: 30px; }\r\n\r\n        .info-box { background-color: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; }\r\n\r\n        .btn { display: inline-block; padding: 12px 24px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; margin: 15px 0; }\r\n\r\n        .footer { background-color: #6c757d; color: white; padding: 15px; text-align: center; font-size: 12px; }\r\n\r\n    </style>\r\n\r\n</head>\r\n\r\n<body>\r\n\r\n    <div class=\"container\">\r\n\r\n        <div class=\"header\">\r\n\r\n            <h2>ğŸ« Yeni Destek Talebi</h2>\r\n\r\n        </div>\r\n\r\n        <div class=\"content\">\r\n\r\n            <p>Merhaba,</p>\r\n\r\n            <p>Sistemde yeni bir destek talebi oluÅŸturuldu. Detaylar aÅŸaÄŸÄ±daki gibidir:</p>\r\n\r\n            \r\n\r\n            <div class=\"info-box\">\r\n\r\n                <h4>ğŸ“‹ Talep Bilgileri</h4>\r\n\r\n                <p><strong>Talep ID:</strong> #' . ($son_talep ? $son_talep->destek_id : 'N/A') . '</p>\r\n\r\n                <p><strong>KullanÄ±cÄ±:</strong> ' . ($kullanici->kullanici_ad ?? 'Bilinmiyor') . ' ' . ($kullanici->kullanici_soyad ?? '') . '</p>\r\n\r\n                <p><strong>E-posta:</strong> ' . ($kullanici->kullanici_eposta ?? 'Bilinmiyor') . '</p>\r\n\r\n                <p><strong>BaÅŸlÄ±k:</strong> ' . ($son_talep ? htmlspecialchars($son_talep->destek_title) : 'Bilinmiyor') . '</p>\r\n\r\n                <p><strong>OluÅŸturma Tarihi:</strong> ' . date('d.m.Y H:i:s') . '</p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <div class=\"info-box\">\r\n\r\n                <h4>ğŸ’¬ Mesaj Ä°Ã§eriÄŸi</h4>\r\n\r\n                <p>' . (!empty($mesaj_icerigi) ? nl2br(htmlspecialchars(substr($mesaj_icerigi, 0, 300))) : 'Mesaj iÃ§eriÄŸi bulunamadÄ±') . \r\n\r\n                (!empty($mesaj_icerigi) && strlen($mesaj_icerigi) > 300 ? '...' : '') . '</p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <p>LÃ¼tfen en kÄ±sa sÃ¼rede talebi inceleyin ve gerekli iÅŸlemleri yapÄ±n.</p>\r\n\r\n            \r\n\r\n            <a href=\"https://crm.ilekasoft.com/destek/detay/' . ($son_talep ? $son_talep->destek_id : '') . '\" class=\"btn\">ğŸ”— Talebi GÃ¶rÃ¼ntÃ¼le</a>\r\n\r\n        </div>\r\n\r\n        <div class=\"footer\">\r\n\r\n            <p>Bu e-posta Ä°lekaSoft CRM sistemi tarafÄ±ndan otomatik olarak gÃ¶nderilmiÅŸtir.</p>\r\n\r\n            <p>' . date('Y') . ' Â© Ä°lekaSoft - TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</body>\r\n\r\n</html>';\r\n\r\n\r\n\r\n\t\t$this->load->library('email', $mail_config);\r\n\t\t$this->email->clear(TRUE);\r\n\t\t$this->email->set_newline(\"\\r\\n\");\r\n\t\t$this->email->set_crlf(\"\\r\\n\");\r\n\t\t$this->email->set_header('Content-Type', 'text/html; charset=UTF-8');\r\n\t\t$this->email->set_header('Content-Transfer-Encoding', '8bit');\r\n\t\t$this->email->to(\"talep@turkbelge.com.tr\");\r\n\t\t$this->email->from(\"noreply@ileka.com.tr\",\"İleka CRM Sistemi\");\r\n\t\t$this->email->subject($mail_baslik);\r\n\t\t$this->email->message($mail_mesaj);\r\n\r\n\t\t// E-posta göndermeyi dene ama hata olursa kullanıcıyı bilgilendir\r\n\t\ttry {\r\n\t\t\t// Debug: E-posta gönderme öncesi log\r\n\t\t\tfile_put_contents('debug_email.log', \"E-posta gönderiliyor: \" . date('Y-m-d H:i:s') . \"\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\tfile_put_contents('debug_email.log', \"Alıcı: talep@turkbelge.com.tr\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\tfile_put_contents('debug_email.log', \"Konu: \" . $mail_baslik . \"\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\t\r\n\t\t\tif (!$this->email->send()) {\r\n\t\t\t\t// E-posta gönderilemedi ama talep oluşturuldu\r\n\t\t\t\t$debug_info = $this->email->print_debugger();\r\n\t\t\t\tfile_put_contents('debug_email.log', \"E-posta hatası:\\n\" . $debug_info . \"\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\t\t$this->session->set_flashdata('email_uyari', 'Destek talebiniz başarıyla oluşturuldu ancak bildirim e-postası gönderilemedi.');\r\n\t\t\t} else {\r\n\t\t\t\t// E-posta başarıyla gönderildi\r\n\t\t\t\tfile_put_contents('debug_email.log', \"E-posta başarıyla gönderildi!\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\t\t$this->session->set_flashdata('destek_ok', 'OK');\r\n\t\t\t}\r\n\t\t} catch (Exception $e) {\r\n\t\t\t// E-posta hatası - talep yine de oluşturuldu\r\n\t\t\tfile_put_contents('debug_email.log', \"E-posta exception: \" . $e->getMessage() . \"\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\t$this->session->set_flashdata('email_uyari', 'Destek talebiniz başarıyla oluşturuldu ancak bildirim e-postası gönderilemedi.');\r\n\t\t}\r\n\r\n\t\t// Her durumda success flash message'ı set et\r\n\t\t$this->session->set_flashdata('destek_ok','OK');\r\n\t\t\r\n\t\t// Destek sayfasına yönlendir\r\n\t\tredirect(base_url('destek'));\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function destekdetay($id){\r\n\t\t// Emergency debug - sayfanın başında çıktı\r\n\t\techo \"<!-- DEBUG: Controller destekdetay çalıştı, ID: $id -->\";\r\n\t\t\r\n\t\t// Debug: Controller başlangıcı\r\n\t\tfile_put_contents('debug_controller.log', \"Controller başlatıldı: \" . date('Y-m-d H:i:s') . \"\\n\", FILE_APPEND | LOCK_EX);\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t\r\n\t\t// Session kontrolü\r\n\t\tif(!$control2 || !isset($control2->kullanici_id)) {\r\n\t\t\tfile_put_contents('debug_controller.log', \"Session hatası!\\n\", FILE_APPEND | LOCK_EX);\r\n\t\t\techo \"<div class='alert alert-danger'>Giriş yapmanız gerekiyor!</div>\";\r\n\t\t\techo \"<a href='\" . base_url('check') . \"'>Giriş Yap</a>\";\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\t\tfile_put_contents('debug_controller.log', \"User ID: $u_id\\n\", FILE_APPEND | LOCK_EX);\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Destek Sistemi - Detay\";\r\n\r\n\t\t$data[\"talep\"] = $this->db->query(\"SELECT * FROM destek WHERE destek_id = $id\")->row();\r\n\r\n\t\t$data[\"yanitlar\"] = $this->db->query(\"SELECT * FROM destek_yanit WHERE dyanit_destekID = $id\")->result();\r\n\r\n\t\t// Debug log\r\n\t\t$yanit_sayisi = is_array($data[\"yanitlar\"]) ? count($data[\"yanitlar\"]) : 0;\r\n\t\terror_log(\"DEBUG: Destek ID: $id, Talep bulundu: \" . ($data[\"talep\"] ? 'Evet' : 'Hayır') . \", Yanıt sayısı: $yanit_sayisi\");\r\n\t\t\r\n\t\t// Debug dosyasına yaz\r\n\t\t$debug_text = \"DEBUG \" . date('Y-m-d H:i:s') . \": ID=$id, Talep=\" . ($data[\"talep\"] ? 'VAR' : 'YOK') . \", Yanıt=$yanit_sayisi\\n\";\r\n\t\tfile_put_contents('debug_controller.log', $debug_text, FILE_APPEND | LOCK_EX);\r\n\t\t\r\n\t\t// Talep bulunamadıysa hata sayfasına yönlendir\r\n\t\tif(!$data[\"talep\"]) {\r\n\t\t\tredirect(\"home/hata2/3\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$isRead = $data[\"talep\"]->destek_isRead;\r\n\r\n\t\t$kim = $data[\"talep\"]->destek_olusturan;\r\n\r\n\r\n\r\n\t\t// grup_id = 1 olan kullanıcılar tüm talepleri görebilir, diğerleri sadece kendi taleplerini\r\n\r\n\t\t$this->load->helper('destek');\r\n\r\n\t\t$user_group_id = $control2->grup_id; $isAdminGroup = ($user_group_id == 1);\r\n\r\n\t\t$data[\"isAdmin\"] = $isAdminGroup;\r\n\r\n\r\n\r\n\t\tif($kim == $u_id || $isAdminGroup){\r\n\r\n\t\t\tif($isRead == 0){\r\n\r\n\t\t\t\t$data_a[\"destek_isRead\"] = 1;\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->update('destek', array('destek_id'=>$id), $data_a);\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$this->load->view(\"destek-detay\",$data);\r\n\r\n\t\t}else{\r\n\r\n\t\t\tredirect(\"home/hata2/2\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n    public function dovizKur(){\r\n\r\n        $this->load->view(\"doviz-kur\");\r\n\r\n    }\r\n\r\n\r\n\r\n\tpublic function dyanit_gonder(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\r\n\r\n\t\t$destek_id = postval(\"dyanit_destekID\");\r\n\r\n\t\t\r\n\r\n\t\t// Talebin sahibini kontrol et\r\n\r\n\t\t$talep = $this->db->query(\"SELECT destek_olusturan, destek_title FROM destek WHERE destek_id = $destek_id\")->row();\r\n\r\n\t\t\r\n\r\n\t\t// grup_id = 1 olan kullanıcılar tüm taleplere yanıt gönderebilir, diğerleri sadece kendi taleplerini\r\n\r\n\t\t$this->load->helper('destek');\r\n\r\n\t\t$this->load->helper('bildirim');\r\n\r\n\t\t$user_group_id = $control2->grup_id; $isAdminGroup = ($user_group_id == 1);\r\n\r\n\t\t\r\n\r\n\t\tif($talep && ($talep->destek_olusturan == $u_id || $isAdminGroup)){\r\n\r\n\t\t\t$data[\"dyanit_destekID\"] = $destek_id;\r\n\r\n\t\t\t$data[\"dyanit_mesaj\"] = postval(\"dyanit_mesaj\");\r\n\r\n\t\t\t$data[\"dyanit_yanitlayan\"] = $u_id;\r\n\r\n\t\t\t$data[\"dyanit_yanitlayanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data[\"dyanit_tarih\"] = $tarih;\r\n\r\n\t\t\t$data[\"dyanit_isAdmin\"] = $isAdminGroup ? 1 : 0;\r\n\r\n\t\t\t$data[\"dyanit_isRead\"] = 0; // Yeni yanÄ±t okunmamÄ±ÅŸ olarak iÅŸaretle\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"destek_yanit\", $data);\r\n\r\n\r\n\r\n\t\t\t// Destek tablosunu gÃ¼ncelle\r\n\r\n\t\t\t$data_u[\"destek_lastUpdateDate\"] = $tarih;\r\n\r\n\t\t\t$data_u[\"destek_lastReplyDate\"] = $tarih;\r\n\r\n\t\t\t$data_u[\"destek_lastReplyBy\"] = $u_id;\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Cevap verildiÄŸinde durumu otomatik olarak \"KapalÄ±\" yap\r\n\r\n\t\t\t$data_u[\"destek_status\"] = 3; // 3 = KapalÄ±\r\n\r\n\r\n\r\n\t\t\t$this->vt->update('destek', array('destek_id'=>$destek_id), $data_u);\r\n\r\n\r\n\r\n\t\t\t// OkunmamÄ±ÅŸ yanÄ±t sayÄ±sÄ±nÄ± gÃ¼ncelle\r\n\r\n\t\t\tdestek_okunmamis_yanit_sayisi_guncelle($destek_id);\r\n\r\n\r\n\r\n\t\t\t// Bildirim gÃ¶nder (yanÄ±tlayan kiÅŸi talep sahibi deÄŸilse)\r\n\r\n\t\t\tif($talep->destek_olusturan != $u_id) {\r\n\r\n\t\t\t\t$yanitlayan_bilgi = $this->db->query(\"SELECT CONCAT(kullanici_ad, ' ', kullanici_soyad) as kullanici_adsoyad FROM kullanicilar WHERE kullanici_id = $u_id\")->row();\r\n\r\n\t\t\t\t$yanitlayan_ad = $yanitlayan_bilgi ? $yanitlayan_bilgi->kullanici_adsoyad : 'Destek Ekibi';\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\tbildirim_gonder(\r\n\r\n\t\t\t\t\t$talep->destek_olusturan,\r\n\r\n\t\t\t\t\t'destek_yanit',\r\n\r\n\t\t\t\t\t'Destek Talebinize YanÄ±t Geldi',\r\n\r\n\t\t\t\t\t$yanitlayan_ad . ' tarafÄ±ndan \"' . $talep->destek_title . '\" konulu destek talebinize yanÄ±t verildi.',\r\n\r\n\t\t\t\t\tbase_url(\"destek/detay/$destek_id\"),\r\n\r\n\t\t\t\t\t$destek_id\r\n\r\n\t\t\t\t);\r\n\r\n\r\n\r\n\t\t\t\t// E-posta bildirimi gÃ¶nder\r\n\r\n\t\t\t\tdestek_eposta_bildirim_gonder($destek_id, 'yeni_yanit', $yanitlayan_ad . ' tarafÄ±ndan yanÄ±tlandÄ±.');\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t// Admin bildirimi (talep sahibi yanÄ±t verdiyse)\r\n\r\n\t\t\tif($talep->destek_olusturan == $u_id) {\r\n\r\n\t\t\t\t$mail_config = Array(\r\n\t\t\t\t\t'protocol' => 'smtp',\r\n\t\t\t\t\t'smtp_crypto' => 'tls',\r\n\t\t\t\t\t'smtp_host' => 'smtp.gmail.com',\r\n\t\t\t\t\t'smtp_port' => 587,\r\n\t\t\t\t\t'smtp_user' => 'batuhan.kahraman@turkbelge.com.tr',\r\n\t\t\t\t\t'smtp_pass' => 'gvcu gipq veov jkmh',\r\n\t\t\t\t\t'charset'   => 'utf-8',\r\n\t\t\t\t\t'mailtype'  => 'html',\r\n\t\t\t\t\t'wordwrap' => FALSE,\r\n\t\t\t\t\t'newline' => \"\\r\\n\",\r\n\t\t\t\t\t'crlf' => \"\\r\\n\",\r\n\t\t\t\t\t'dsn' => FALSE,\r\n\t\t\t\t\t'multipart' => 'mixed'\r\n\t\t\t\t);\r\n\r\n\r\n\r\n\t\t\t\t// YanÄ±tlayan kullanÄ±cÄ± bilgilerini al\r\n\r\n\t\t\t\t$yanitlayan_bilgi = $this->db->query(\"SELECT CONCAT(kullanici_ad, ' ', kullanici_soyad) as kullanici_adsoyad, kullanici_eposta FROM kullanicilar WHERE kullanici_id = $u_id\")->row();\r\n\r\n\t\t\t\t$yanit_mesaji = postval(\"dyanit_mesaj\");\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// Mail içeriğini zenginleştir\r\n\r\n\t\t\t\t$mail_baslik = '[TALEP] İlekaSoft CRM - Destek Talebine Yanıt #' . $destek_id;\r\n\r\n\t\t\t\t$admin_mail_mesaj = '\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\r\n    <meta charset=\"UTF-8\">\r\n    <style>\r\n\r\n        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }\r\n\r\n        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\r\n\r\n        .header { background-color: #17a2b8; color: white; padding: 20px; text-align: center; }\r\n\r\n        .content { padding: 30px; }\r\n\r\n        .info-box { background-color: #f8f9fa; border-left: 4px solid #17a2b8; padding: 15px; margin: 15px 0; }\r\n\r\n        .response-box { background-color: #e8f4fd; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; }\r\n\r\n        .btn { display: inline-block; padding: 12px 24px; background-color: #17a2b8; color: white; text-decoration: none; border-radius: 4px; margin: 15px 0; }\r\n\r\n        .footer { background-color: #6c757d; color: white; padding: 15px; text-align: center; font-size: 12px; }\r\n\r\n    </style>\r\n\r\n</head>\r\n\r\n<body>\r\n\r\n    <div class=\"container\">\r\n\r\n        <div class=\"header\">\r\n\r\n            <h2>ğŸ’¬ Destek Talebine Yeni YanÄ±t</h2>\r\n\r\n        </div>\r\n\r\n        <div class=\"content\">\r\n\r\n            <p>Merhaba,</p>\r\n\r\n            <p>Bir destek talebine kullanÄ±cÄ± tarafÄ±ndan yanÄ±t verildi. LÃ¼tfen inceleyin:</p>\r\n\r\n            \r\n\r\n            <div class=\"info-box\">\r\n\r\n                <h4>ğŸ“‹ Talep Bilgileri</h4>\r\n\r\n                <p><strong>Talep ID:</strong> #' . $destek_id . '</p>\r\n\r\n                <p><strong>Talep BaÅŸlÄ±ÄŸÄ±:</strong> ' . htmlspecialchars($talep->destek_title) . '</p>';\r\n\r\n                \r\n\r\n                if($yanitlayan_bilgi) {\r\n\r\n                    $admin_mail_mesaj .= '\r\n\r\n                    <p><strong>YanÄ±tlayan KullanÄ±cÄ±:</strong> ' . htmlspecialchars($yanitlayan_bilgi->kullanici_adsoyad) . '</p>\r\n\r\n                    <p><strong>E-posta:</strong> ' . htmlspecialchars($yanitlayan_bilgi->kullanici_eposta) . '</p>';\r\n\r\n                }\r\n\r\n                \r\n\r\n                $admin_mail_mesaj .= '\r\n\r\n                <p><strong>YanÄ±t Tarihi:</strong> ' . date('d.m.Y H:i:s') . '</p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <div class=\"response-box\">\r\n\r\n                <h4>ğŸ’¬ KullanÄ±cÄ± YanÄ±tÄ±</h4>\r\n\r\n                <p>' . (!empty($yanit_mesaji) ? nl2br(htmlspecialchars(substr($yanit_mesaji, 0, 300))) : 'YanÄ±t iÃ§eriÄŸi bulunamadÄ±') . \r\n\r\n                (!empty($yanit_mesaji) && strlen($yanit_mesaji) > 300 ? '...' : '') . '</p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <p>Bu yanÄ±t kullanÄ±cÄ±nÄ±n talebine karÅŸÄ± verdiÄŸi geri bildirimdir. LÃ¼tfen gerekli durumlarda tekrar yanÄ±t verin.</p>\r\n\r\n            \r\n\r\n            <a href=\"https://crm.ilekasoft.com/destek/detay/' . $destek_id . '\" class=\"btn\">ğŸ”— Talebi GÃ¶rÃ¼ntÃ¼le ve YanÄ±tla</a>\r\n\r\n        </div>\r\n\r\n        <div class=\"footer\">\r\n\r\n            <p>Bu e-posta Ä°lekaSoft CRM sistemi tarafÄ±ndan otomatik olarak gÃ¶nderilmiÅŸtir.</p>\r\n\r\n            <p>' . date('Y') . ' Â© Ä°lekaSoft - TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</body>\r\n\r\n</html>';\r\n\r\n\r\n\r\n\t\t\t\t$this->load->library('email', $mail_config);\r\n\t\t\t\t$this->email->clear(TRUE);\r\n\t\t\t\t$this->email->set_newline(\"\\r\\n\");\r\n\t\t\t\t$this->email->set_crlf(\"\\r\\n\");\r\n\t\t\t\t$this->email->set_header('Content-Type', 'text/html; charset=UTF-8');\r\n\t\t\t\t$this->email->set_header('Content-Transfer-Encoding', '8bit');\r\n\t\t\t\t$this->email->to(\"talep@turkbelge.com.tr\");\r\n\t\t\t\t$this->email->from(\"bilgi@ileka.com.tr\",\"İleka CRM\");\r\n\t\t\t\t$this->email->subject($mail_baslik);\r\n\t\t\t\t$this->email->message($admin_mail_mesaj);\r\n\r\n\t\t\t\tif (!$this->email->send()){\r\n\r\n\t\t\t\t\techo $this->email->print_debugger();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$this->session->set_flashdata('destekyanit_ok','OK');\r\n\r\n\t\t\tredirect('destek'); // Destek sayfasÄ±na geri dÃ¶n\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Yetkisiz eriÅŸim\r\n\r\n\t\t\tredirect(\"home/hata2/2\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function destek_durum_degistir($destek_id, $yeni_durum){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\t// Admin yetkisi kontrolÃ¼\r\n\r\n\t\t$this->load->helper('destek');\r\n\r\n\t\t$this->load->helper('bildirim');\r\n\r\n\t\t$user_group_id = $control2->grup_id; $isAdminGroup = ($user_group_id == 1);\r\n\r\n\t\t\r\n\r\n\t\tif(!$isAdminGroup){\r\n\r\n\t\t\tredirect(\"home/hata2/2\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// GeÃ§erli durumlar: 1=AÃ§Ä±k, 2=Ä°ÅŸlemde, 3=KapalÄ±, 4=Cevap bekleniyor\r\n\r\n\t\t$gecerli_durumlar = array(1, 2, 3, 4);\r\n\r\n\t\tif(!in_array($yeni_durum, $gecerli_durumlar)){\r\n\r\n\t\t\t$this->session->set_flashdata('destek_durum_hata','GeÃ§ersiz durum!');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Destek talebi var mÄ± kontrol et\r\n\r\n\t\t$talep = $this->db->query(\"SELECT destek_olusturan, destek_title FROM destek WHERE destek_id = $destek_id\")->row();\r\n\r\n\t\tif(!$talep){\r\n\r\n\t\t\t$this->session->set_flashdata('destek_durum_hata','Destek talebi bulunamadÄ±!');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Durumu gÃ¼ncelle\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\t\t\r\n\r\n\t\t$data[\"destek_status\"] = $yeni_durum;\r\n\r\n\t\t$data[\"destek_lastUpdateDate\"] = $tarih;\r\n\r\n\r\n\r\n\t\t$this->vt->update('destek', array('destek_id'=>$destek_id), $data);\r\n\r\n\r\n\r\n\t\t// Durum metinlerini belirle\r\n\r\n\t\t$durum_metinleri = array(\r\n\r\n\t\t\t1 => 'AÃ§Ä±k',\r\n\r\n\t\t\t2 => 'Ä°ÅŸlemde', \r\n\r\n\t\t\t3 => 'KapalÄ±',\r\n\r\n\t\t\t4 => 'Cevap bekleniyor'\r\n\r\n\t\t);\r\n\r\n\t\t\r\n\r\n\t\t$yeni_durum_text = $durum_metinleri[$yeni_durum];\r\n\r\n\r\n\r\n\t\t// KullanÄ±cÄ±ya bildirim gÃ¶nder\r\n\r\n\t\tbildirim_gonder(\r\n\r\n\t\t\t$talep->destek_olusturan,\r\n\r\n\t\t\t'destek_durum',\r\n\r\n\t\t\t'Destek Talebinizin Durumu DeÄŸiÅŸti',\r\n\r\n\t\t\t'\"' . $talep->destek_title . '\" konulu destek talebinizin durumu \"' . $yeni_durum_text . '\" olarak deÄŸiÅŸtirildi.',\r\n\r\n\t\t\tbase_url(\"destek/detay/$destek_id\"),\r\n\r\n\t\t\t$destek_id\r\n\r\n\t\t);\r\n\r\n\r\n\r\n\t\t// E-posta bildirimi gÃ¶nder\r\n\r\n\t\tdestek_eposta_bildirim_gonder($destek_id, 'durum_degisti', $yeni_durum_text);\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('destek_durum_ok', 'Destek durumu \"'.$yeni_durum_text.'\" olarak gÃ¼ncellendi.');\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t// Bildirim sistemi iÃ§in API endpoint'leri\r\n\r\n\tpublic function bildirim_listesi(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control2) {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'Oturum bulunamadÄ±'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$this->load->helper('bildirim');\r\n\r\n\t\t\r\n\r\n\t\t$limit = $this->input->get('limit') ? (int)$this->input->get('limit') : 10;\r\n\r\n\t\t$bildirimler = okunmamis_bildirimler($u_id, $limit);\r\n\r\n\t\t\r\n\r\n\t\t$response = array(\r\n\r\n\t\t\t'success' => true,\r\n\r\n\t\t\t'bildirimler' => $bildirimler,\r\n\r\n\t\t\t'toplam' => okunmamis_bildirim_sayisi($u_id)\r\n\r\n\t\t);\r\n\r\n\t\t\r\n\r\n\t\techo json_encode($response);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function bildirim_okundu(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control2) {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'Oturum bulunamadÄ±'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$bildirim_id = $this->input->post('bildirim_id');\r\n\r\n\t\t\r\n\r\n\t\tif($bildirim_id){\r\n\r\n\t\t\t$this->load->helper('bildirim');\r\n\r\n\t\t\t$result = bildirim_okundu_isaretle($bildirim_id, $u_id);\r\n\r\n\t\t\t\r\n\r\n\t\t\tif($result){\r\n\r\n\t\t\t\techo json_encode(array('success' => true, 'message' => 'Bildirim okundu olarak iÅŸaretlendi'));\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\techo json_encode(array('success' => false, 'message' => 'Bildirim gÃ¼ncellenemedi'));\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'Bildirim ID bulunamadÄ±'));\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function yanit_okundu(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control2) {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'Oturum bulunamadÄ±'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$yanit_id = $this->input->post('yanit_id');\r\n\r\n\t\t\r\n\r\n\t\tif($yanit_id){\r\n\r\n\t\t\t$this->load->helper('bildirim');\r\n\r\n\t\t\t$result = destek_yanit_okundu_isaretle($yanit_id, $u_id);\r\n\r\n\t\t\t\r\n\r\n\t\t\tif($result){\r\n\r\n\t\t\t\techo json_encode(array('success' => true, 'message' => 'YanÄ±t okundu olarak iÅŸaretlendi'));\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\techo json_encode(array('success' => false, 'message' => 'YanÄ±t gÃ¼ncellenemedi'));\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'YanÄ±t ID bulunamadÄ±'));\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function bildirim_temizle(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control2) {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'Oturum bulunamadÄ±'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// KullanÄ±cÄ±nÄ±n tÃ¼m bildirimlerini okundu olarak iÅŸaretle\r\n\r\n\t\t$data = array('bildirim_okundu' => 1);\r\n\r\n\t\t$where = array('bildirim_kullanici_id' => $u_id, 'bildirim_okundu' => 0);\r\n\r\n\t\t\r\n\r\n\t\t$result = $this->vt->update('kullanici_bildirim', $where, $data);\r\n\r\n\t\t\r\n\r\n\t\tif($result){\r\n\r\n\t\techo json_encode(array('success' => true, 'message' => 'TÃ¼m bildirimler temizlendi'));\r\n\r\n\t} else {\r\n\r\n\t\techo json_encode(array('success' => false, 'message' => 'Bildirimler temizlenemedi'));\r\n\r\n\t}\r\n\r\n}\r\n\r\n\t/**\r\n\t * Changelog verilerini getir (AJAX endpoint)\r\n\t */\r\n\tpublic function getChangelog()\r\n\t{\r\n\t\t// Session kontrolü\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Oturum süresi dolmuş']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\t// Changelog dosyasını oku\r\n\t\t\t$changelog_path = APPPATH . 'config/changelog.json';\r\n\t\t\t\r\n\t\t\tif (!file_exists($changelog_path)) {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Changelog dosyası bulunamadı']);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t$changelog_content = file_get_contents($changelog_path);\r\n\t\t\t$changelog_data = json_decode($changelog_content, true);\r\n\r\n\t\t\tif (json_last_error() !== JSON_ERROR_NONE) {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Changelog dosyası geçersiz JSON formatında']);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Response döndür\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => true,\r\n\t\t\t\t'data' => $changelog_data,\r\n\t\t\t\t'file_path' => $changelog_path,\r\n\t\t\t\t'last_modified' => date('Y-m-d H:i:s', filemtime($changelog_path))\r\n\t\t\t]);\r\n\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Changelog verileri yüklenirken hata oluştu: ' . $e->getMessage()]);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function testMethod() {\r\n\t\techo \"Test method çalışıyor!<br>\";\r\n\t\techo \"REQUEST_URI: \" . $_SERVER['REQUEST_URI'] . \"<br>\";\r\n\t\techo \"Bu sayfa çalışıyorsa CodeIgniter routing düzgün çalışıyor.\";\r\n\t}\r\n\r\n}"
        }
    ]
}