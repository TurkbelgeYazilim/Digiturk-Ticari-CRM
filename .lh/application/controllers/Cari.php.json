{
    "sourceFile": "application/controllers/Cari.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 14,
            "patches": [
                {
                    "date": 1754904082238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755268348330,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1059,8 +1059,12 @@\n \t\t$user_group_id = $control->grup_id;\r\n \t\t$admin_groups = [1, 2, 5, 7];\r\n \t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n \t\t\r\n+\t\t// URL parametrelerini kontrol et\r\n+\t\t$tip = $this->input->get('tip'); // 'satis' olabilir\r\n+\t\t$satis_id = $this->input->get('satis_id');\r\n+\t\t\r\n \t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n \t\t$allowed_user_ids = array($u_id);\r\n \t\tif ($u_id > 0) {\r\n \t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n@@ -1071,28 +1075,61 @@\n \t\t\t}\r\n \t\t}\r\n \t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n \t\t\r\n-\t\t// Cari kaydını getir\r\n-\t\tif ($is_admin) {\r\n-\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n-\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true\";\r\n+\t\tif ($tip == 'satis' && $satis_id) {\r\n+\t\t\t// Satış görsellerini getir\r\n+\t\t\tif ($is_admin) {\r\n+\t\t\t\t$satisQ = \"SELECT sf.satis_dosya, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t   FROM satisfaturasi sf \r\n+\t\t\t\t\t\t   INNER JOIN cari c ON sf.satis_cariID = c.cari_id \r\n+\t\t\t\t\t\t   WHERE sf.satis_id = '$satis_id' AND c.cari_id = '$cari_id'\";\r\n+\t\t\t} else {\r\n+\t\t\t\t$satisQ = \"SELECT sf.satis_dosya, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t   FROM satisfaturasi sf \r\n+\t\t\t\t\t\t   INNER JOIN cari c ON sf.satis_cariID = c.cari_id \r\n+\t\t\t\t\t\t   WHERE sf.satis_id = '$satis_id' AND c.cari_id = '$cari_id' \r\n+\t\t\t\t\t\t   AND c.cari_olusturan IN ($allowed_user_ids_str)\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$satis = $this->db->query($satisQ)->row();\r\n+\t\t\t\r\n+\t\t\tif (!$satis) {\r\n+\t\t\t\tshow_error('Satış kaydı bulunamadı!');\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$data['cari'] = $satis;\r\n+\t\t\t$data['cari_id'] = $cari_id;\r\n+\t\t\t$data['satis_id'] = $satis_id;\r\n+\t\t\t$data['is_admin'] = $is_admin;\r\n+\t\t\t$data['tip'] = 'satis';\r\n+\t\t\t$data['dosya_field'] = $satis->satis_dosya;\r\n+\t\t\t\r\n \t\t} else {\r\n-\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n-\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n+\t\t\t// Cari görsellerini getir (eski davranış)\r\n+\t\t\tif ($is_admin) {\r\n+\t\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n+\t\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true\";\r\n+\t\t\t} else {\r\n+\t\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n+\t\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$cari = $this->db->query($cariQ)->row();\r\n+\t\t\t\r\n+\t\t\tif (!$cari) {\r\n+\t\t\t\tshow_error('Cari kaydı bulunamadı!');\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$data['cari'] = $cari;\r\n+\t\t\t$data['cari_id'] = $cari_id;\r\n+\t\t\t$data['is_admin'] = $is_admin;\r\n+\t\t\t$data['tip'] = 'cari';\r\n+\t\t\t$data['dosya_field'] = $cari->fotograf_dosya;\r\n \t\t}\r\n \t\t\r\n-\t\t$cari = $this->db->query($cariQ)->row();\r\n-\t\t\r\n-\t\tif (!$cari) {\r\n-\t\t\tshow_error('Cari kaydı bulunamadı!');\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\t$data['cari'] = $cari;\r\n-\t\t$data['cari_id'] = $cari_id;\r\n-\t\t$data['is_admin'] = $is_admin;\r\n-\t\t\r\n \t\t$this->load->view('cari/gorsel-goster', $data);\r\n \t}\r\n \t\r\n \tpublic function evrakGoster($cari_id)\r\n"
                },
                {
                    "date": 1755274331082,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1060,9 +1060,9 @@\n \t\t$admin_groups = [1, 2, 5, 7];\r\n \t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n \t\t\r\n \t\t// URL parametrelerini kontrol et\r\n-\t\t$tip = $this->input->get('tip'); // 'satis' olabilir\r\n+\t\t$tip = $this->input->get('tip'); // 'satis', 'banka', 'cek', 'senet' olabilir\r\n \t\t$satis_id = $this->input->get('satis_id');\r\n \t\t\r\n \t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n \t\t$allowed_user_ids = array($u_id);\r\n@@ -1104,8 +1104,98 @@\n \t\t\t$data['is_admin'] = $is_admin;\r\n \t\t\t$data['tip'] = 'satis';\r\n \t\t\t$data['dosya_field'] = $satis->satis_dosya;\r\n \t\t\t\r\n+\t\t} else if ($tip == 'banka') {\r\n+\t\t\t// Banka hareketleri görsellerini getir\r\n+\t\t\tif ($is_admin) {\r\n+\t\t\t\t$bankaQ = \"SELECT GROUP_CONCAT(bh_gorsel SEPARATOR ',') as banka_gorselleri, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t   FROM bankahareketleri bh \r\n+\t\t\t\t\t\t   INNER JOIN cari c ON bh.bh_cariID = c.cari_id \r\n+\t\t\t\t\t\t   WHERE bh.bh_cariID = '$cari_id' AND bh.bh_gorsel IS NOT NULL AND bh.bh_gorsel != ''\r\n+\t\t\t\t\t\t   GROUP BY c.cari_id\";\r\n+\t\t\t} else {\r\n+\t\t\t\t$bankaQ = \"SELECT GROUP_CONCAT(bh_gorsel SEPARATOR ',') as banka_gorselleri, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t   FROM bankahareketleri bh \r\n+\t\t\t\t\t\t   INNER JOIN cari c ON bh.bh_cariID = c.cari_id \r\n+\t\t\t\t\t\t   WHERE bh.bh_cariID = '$cari_id' AND bh.bh_gorsel IS NOT NULL AND bh.bh_gorsel != ''\r\n+\t\t\t\t\t\t   AND c.cari_olusturan IN ($allowed_user_ids_str)\r\n+\t\t\t\t\t\t   GROUP BY c.cari_id\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$banka = $this->db->query($bankaQ)->row();\r\n+\t\t\t\r\n+\t\t\tif (!$banka) {\r\n+\t\t\t\tshow_error('Banka hareketi bulunamadı!');\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$data['cari'] = $banka;\r\n+\t\t\t$data['cari_id'] = $cari_id;\r\n+\t\t\t$data['is_admin'] = $is_admin;\r\n+\t\t\t$data['tip'] = 'banka';\r\n+\t\t\t$data['dosya_field'] = $banka->banka_gorselleri;\r\n+\t\t\t\r\n+\t\t} else if ($tip == 'cek') {\r\n+\t\t\t// Çek görsellerini getir\r\n+\t\t\tif ($is_admin) {\r\n+\t\t\t\t$cekQ = \"SELECT GROUP_CONCAT(cek_gorsel SEPARATOR ',') as cek_gorselleri, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t FROM cek \r\n+\t\t\t\t\t\t INNER JOIN cari c ON cek.cek_cariID = c.cari_id \r\n+\t\t\t\t\t\t WHERE cek.cek_cariID = '$cari_id' AND cek.cek_gorsel IS NOT NULL AND cek.cek_gorsel != ''\r\n+\t\t\t\t\t\t GROUP BY c.cari_id\";\r\n+\t\t\t} else {\r\n+\t\t\t\t$cekQ = \"SELECT GROUP_CONCAT(cek_gorsel SEPARATOR ',') as cek_gorselleri, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t FROM cek \r\n+\t\t\t\t\t\t INNER JOIN cari c ON cek.cek_cariID = c.cari_id \r\n+\t\t\t\t\t\t WHERE cek.cek_cariID = '$cari_id' AND cek.cek_gorsel IS NOT NULL AND cek.cek_gorsel != ''\r\n+\t\t\t\t\t\t AND c.cari_olusturan IN ($allowed_user_ids_str)\r\n+\t\t\t\t\t\t GROUP BY c.cari_id\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$cek = $this->db->query($cekQ)->row();\r\n+\t\t\t\r\n+\t\t\tif (!$cek) {\r\n+\t\t\t\tshow_error('Çek kaydı bulunamadı!');\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$data['cari'] = $cek;\r\n+\t\t\t$data['cari_id'] = $cari_id;\r\n+\t\t\t$data['is_admin'] = $is_admin;\r\n+\t\t\t$data['tip'] = 'cek';\r\n+\t\t\t$data['dosya_field'] = $cek->cek_gorselleri;\r\n+\t\t\t\r\n+\t\t} else if ($tip == 'senet') {\r\n+\t\t\t// Senet görsellerini getir\r\n+\t\t\tif ($is_admin) {\r\n+\t\t\t\t$senetQ = \"SELECT GROUP_CONCAT(senet_gorsel SEPARATOR ',') as senet_gorselleri, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t   FROM senet \r\n+\t\t\t\t\t\t   INNER JOIN cari c ON senet.senet_cariID = c.cari_id \r\n+\t\t\t\t\t\t   WHERE senet.senet_cariID = '$cari_id' AND senet.senet_gorsel IS NOT NULL AND senet.senet_gorsel != ''\r\n+\t\t\t\t\t\t   GROUP BY c.cari_id\";\r\n+\t\t\t} else {\r\n+\t\t\t\t$senetQ = \"SELECT GROUP_CONCAT(senet_gorsel SEPARATOR ',') as senet_gorselleri, c.cari_ad, c.cari_soyad \r\n+\t\t\t\t\t\t   FROM senet \r\n+\t\t\t\t\t\t   INNER JOIN cari c ON senet.senet_cariID = c.cari_id \r\n+\t\t\t\t\t\t   WHERE senet.senet_cariID = '$cari_id' AND senet.senet_gorsel IS NOT NULL AND senet.senet_gorsel != ''\r\n+\t\t\t\t\t\t   AND c.cari_olusturan IN ($allowed_user_ids_str)\r\n+\t\t\t\t\t\t   GROUP BY c.cari_id\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$senet = $this->db->query($senetQ)->row();\r\n+\t\t\t\r\n+\t\t\tif (!$senet) {\r\n+\t\t\t\tshow_error('Senet kaydı bulunamadı!');\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$data['cari'] = $senet;\r\n+\t\t\t$data['cari_id'] = $cari_id;\r\n+\t\t\t$data['is_admin'] = $is_admin;\r\n+\t\t\t$data['tip'] = 'senet';\r\n+\t\t\t$data['dosya_field'] = $senet->senet_gorselleri;\r\n+\t\t\t\r\n \t\t} else {\r\n \t\t\t// Cari görsellerini getir (eski davranış)\r\n \t\t\tif ($is_admin) {\r\n \t\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n"
                },
                {
                    "date": 1756217159860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -745,53 +745,95 @@\n \t\tif (isset($getCari) && !empty($getCari)) {\r\n \t\t\t// Get customer information - NO RESTRICTION by account (allows any logged-in user to view any customer)\r\n \t\t\t$cariQ = \"SELECT * FROM cari WHERE cari_id = '$getCari'\";\r\n \t\t\t$cariExe = $this->db->query($cariQ)->row();\r\n+\t\t\t$data[\"cariExe\"] = $cariExe;\r\n \t\t\t\r\n \t\t\tif ($cariExe) {\r\n-\t\t\t\t// Calculate customer balance\r\n-\t\t\t\t$toplamBorcQ = \"SELECT SUM(ch_borc) AS toplamBorc FROM cariHareketleri WHERE ch_olusturanAnaHesap = '$anaHesap' AND ch_cariID = '$getCari'\";\r\n-\t\t\t\t$toplamBorcExe = $this->db->query($toplamBorcQ)->row();\r\n+\t\t\t\t// Yeni UNION sorgusu ile tüm hareketleri getir\r\n+\t\t\t\t$cariHareketleriQ = \"\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tbh_tarih AS Tarih,\r\n+\t\t\t\t\t\t'Banka' AS Tahsilat_Tipi,\r\n+\t\t\t\t\t\tNULL    AS Borc,\r\n+\t\t\t\t\t\tCOALESCE(bh_giris, bh_cikis) AS Alacak,\r\n+\t\t\t\t\t\tbh_aciklama AS Aciklama,\r\n+\t\t\t\t\t\tbh_gorsel AS Gorsel,\r\n+\t\t\t\t\t\tbh_id AS kayit_id,\r\n+\t\t\t\t\t\t'banka' AS tablo\r\n+\t\t\t\t\tFROM bankahareketleri\r\n+\t\t\t\t\tWHERE bh_cariID = '$getCari'\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tcek_kayitTarihi AS Tarih,\r\n+\t\t\t\t\t\t'Çek' AS Tahsilat_Tipi,\r\n+\t\t\t\t\t\tNULL           AS Borc,\r\n+\t\t\t\t\t\tcek_tutar      AS Alacak,\r\n+\t\t\t\t\t\tcek_notAciklama AS Aciklama,\r\n+\t\t\t\t\t\tcek_gorsel     AS Gorsel,\r\n+\t\t\t\t\t\tcek_id AS kayit_id,\r\n+\t\t\t\t\t\t'cek' AS tablo\r\n+\t\t\t\t\tFROM cek\r\n+\t\t\t\t\tWHERE cek_cariID = '$getCari'\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tkh_tarih AS Tarih,\r\n+\t\t\t\t\t\t'Kasa'  AS Tahsilat_Tipi,\r\n+\t\t\t\t\t\tNULL    AS Borc,\r\n+\t\t\t\t\t\tCOALESCE(kh_giris, kh_cikis) AS Alacak,\r\n+\t\t\t\t\t\tkh_aciklama AS Aciklama,\r\n+\t\t\t\t\t\tNULL AS Gorsel,\r\n+\t\t\t\t\t\tkh_id AS kayit_id,\r\n+\t\t\t\t\t\t'kasa' AS tablo\r\n+\t\t\t\t\tFROM kasahareketleri\r\n+\t\t\t\t\tWHERE kh_cariID = '$getCari'\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tsenet_kayitTarihi AS Tarih,\r\n+\t\t\t\t\t\t'Senet' AS Tahsilat_Tipi,\r\n+\t\t\t\t\t\tNULL     AS Borc,\r\n+\t\t\t\t\t\tsenet_tutar AS Alacak,\r\n+\t\t\t\t\t\tsenet_notAciklama AS Aciklama,\r\n+\t\t\t\t\t\tsenet_gorsel AS Gorsel,\r\n+\t\t\t\t\t\tsenet_id AS kayit_id,\r\n+\t\t\t\t\t\t'senet' AS tablo\r\n+\t\t\t\t\tFROM senet\r\n+\t\t\t\t\tWHERE senet_cariID = '$getCari'\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT\r\n+\t\t\t\t\t\tsatis_faturaTarihi AS Tarih,\r\n+\t\t\t\t\t\t'Satış Faturası'   AS Tahsilat_Tipi,\r\n+\t\t\t\t\t\tsatis_genelToplam  AS Borc,\r\n+\t\t\t\t\t\tNULL               AS Alacak,\r\n+\t\t\t\t\t\tsatis_aciklama     AS Aciklama,\r\n+\t\t\t\t\t\tsatis_dosya        AS Gorsel,\r\n+\t\t\t\t\t\tsatis_id AS kayit_id,\r\n+\t\t\t\t\t\t'satis' AS tablo\r\n+\t\t\t\t\tFROM satisfaturasi\r\n+\t\t\t\t\tWHERE satis_cariID = '$getCari'\r\n+\r\n+\t\t\t\t\tORDER BY Tarih DESC\r\n+\t\t\t\t\";\r\n \t\t\t\t\r\n-\t\t\t\t$toplamAlacakQ = \"SELECT SUM(ch_alacak) AS toplamAlacak FROM cariHareketleri WHERE ch_olusturanAnaHesap = '$anaHesap' AND ch_cariID = '$getCari'\";\r\n-\t\t\t\t$toplamAlacakExe = $this->db->query($toplamAlacakQ)->row();\r\n+\t\t\t\t$data[\"cariHareketleri\"] = $this->db->query($cariHareketleriQ)->result();\r\n \t\t\t\t\r\n-\t\t\t\t$toplamBorc = $toplamBorcExe->toplamBorc ?? 0;\r\n-\t\t\t\t$toplamAlacak = $toplamAlacakExe->toplamAlacak ?? 0;\r\n+\t\t\t\t// Bakiye hesaplama\r\n+\t\t\t\t$toplamBorc = 0;\r\n+\t\t\t\t$toplamAlacak = 0;\r\n+\t\t\t\tforeach($data[\"cariHareketleri\"] as $hareket) {\r\n+\t\t\t\t\tif($hareket->Borc) $toplamBorc += $hareket->Borc;\r\n+\t\t\t\t\tif($hareket->Alacak) $toplamAlacak += $hareket->Alacak;\r\n+\t\t\t\t}\r\n \t\t\t\t$kalan = $toplamBorc - $toplamAlacak;\r\n-\t\t\t\t\r\n \t\t\t\t$data[\"kalan\"] = $kalan;\r\n-\t\t\t\t\r\n-\t\t\t\t// Build transaction query with filters\r\n-\t\t\t\t$where_conditions = \"ch_olusturanAnaHesap = '$anaHesap' AND ch_cariID = '$getCari'\";\r\n-\t\t\t\t\r\n-\t\t\t\tif (isset($hareketTuru) && !empty($hareketTuru)) {\r\n-\t\t\t\t\t$where_conditions .= \" AND ch_turu = '$hareketTuru'\";\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\tif (isset($belgeNo) && !empty($belgeNo)) {\r\n-\t\t\t\t\t$where_conditions .= \" AND ch_belgeNumarasi LIKE '%$belgeNo%'\";\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\tif (isset($tarihAraligi) && !empty($tarihAraligi)) {\r\n-\t\t\t\t\t$tarihAraligi_array = explode(' - ', $tarihAraligi);\r\n-\t\t\t\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi_array[0]));\r\n-\t\t\t\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi_array[1]));\r\n-\t\t\t\t\t$where_conditions .= \" AND ch_tarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t// Set sorting\r\n-\t\t\t\t$order_by = \"ch_id DESC\";\r\n-\t\t\t\tif (isset($siralama) && !empty($siralama)) {\r\n-\t\t\t\t\tif ($siralama == \"eskiTarih\") {\r\n-\t\t\t\t\t\t$order_by = \"ch_tarihi ASC\";\r\n-\t\t\t\t\t} elseif ($siralama == \"yeniTarih\") {\r\n-\t\t\t\t\t\t$order_by = \"ch_tarihi DESC\";\r\n-\t\t\t\t\t}\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t$cariHareketleriQ = \"SELECT * FROM cariHareketleri WHERE $where_conditions ORDER BY $order_by\";\r\n-\t\t\t\t$data[\"cariHareketleri\"] = $this->db->query($cariHareketleriQ)->result();\r\n \t\t\t} else {\r\n \t\t\t\t$data[\"cariHareketleri\"] = array();\r\n \t\t\t\t$data[\"kalan\"] = 0;\r\n \t\t\t}\r\n"
                },
                {
                    "date": 1756915659179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1353,5 +1353,122 @@\n \t\t\r\n \t\t// Return JSON response\r\n \t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n \t}\r\n+\r\n+\tpublic function gorselYukle() {\r\n+\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n+\t\t$control = session(\"r\", \"login_info\");\r\n+\t\t$u_id = $control->kullanici_id;\r\n+\t\t$user_group_id = $control->grup_id;\r\n+\t\t$admin_groups = [1, 2, 5, 7];\r\n+\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n+\r\n+\t\tif (!$is_admin) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Yetkiniz yok!']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t$cari_id = postval('cari_id');\r\n+\t\t$tip = postval('tip');\r\n+\t\t$satis_id = postval('satis_id');\r\n+\r\n+\t\tif (empty($_FILES['gorsel_dosyalar']['name'][0])) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Dosya seçilmedi!']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Upload path'ini tip'e göre belirle\r\n+\t\t$upload_path = './assets/uploads/';\r\n+\t\tswitch($tip) {\r\n+\t\t\tcase 'satis':\r\n+\t\t\t\t$upload_path = './assets/uploads/faturalar/';\r\n+\t\t\t\tbreak;\r\n+\t\t\tcase 'banka':\r\n+\t\t\t\t$upload_path = './assets/uploads/dekontlar/';\r\n+\t\t\t\tbreak;\r\n+\t\t\tcase 'cek':\r\n+\t\t\t\t$upload_path = './assets/uploads/cekler/';\r\n+\t\t\t\tbreak;\r\n+\t\t\tcase 'senet':\r\n+\t\t\t\t$upload_path = './assets/uploads/senetler/';\r\n+\t\t\t\tbreak;\r\n+\t\t\tdefault:\r\n+\t\t\t\t$upload_path = './assets/uploads/';\r\n+\t\t\t\tbreak;\r\n+\t\t}\r\n+\r\n+\t\tif (!file_exists($upload_path)) {\r\n+\t\t\tmkdir($upload_path, 0777, true);\r\n+\t\t}\r\n+\r\n+\t\t$uploaded_files = array();\r\n+\r\n+\t\tforeach ($_FILES['gorsel_dosyalar']['name'] as $key => $name) {\r\n+\t\t\tif (!empty($name)) {\r\n+\t\t\t\t$tmp_name = $_FILES['gorsel_dosyalar']['tmp_name'][$key];\r\n+\t\t\t\t$size = $_FILES['gorsel_dosyalar']['size'][$key];\r\n+\t\t\t\t$error = $_FILES['gorsel_dosyalar']['error'][$key];\r\n+\r\n+\t\t\t\tif ($error === 0) {\r\n+\t\t\t\t\t$allowed_types = array('jpg', 'jpeg', 'png', 'pdf');\r\n+\t\t\t\t\t$file_ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));\r\n+\r\n+\t\t\t\t\tif (in_array($file_ext, $allowed_types) && $size <= 10485760) { // 10MB limit\r\n+\t\t\t\t\t\t$encrypted_name = md5(uniqid(rand(), true)) . '.' . $file_ext;\r\n+\t\t\t\t\t\t$destination = $upload_path . $encrypted_name;\r\n+\r\n+\t\t\t\t\t\tif (move_uploaded_file($tmp_name, $destination)) {\r\n+\t\t\t\t\t\t\t// Tip'e göre veritabanına kaydedilecek yolu belirle\r\n+\t\t\t\t\t\t\t$db_path = '';\r\n+\t\t\t\t\t\t\tswitch($tip) {\r\n+\t\t\t\t\t\t\t\tcase 'satis':\r\n+\t\t\t\t\t\t\t\t\t$db_path = 'faturalar/' . $encrypted_name;\r\n+\t\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\tcase 'banka':\r\n+\t\t\t\t\t\t\t\t\t$db_path = 'dekontlar/' . $encrypted_name;\r\n+\t\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t\t\t\t\t$db_path = 'cekler/' . $encrypted_name;\r\n+\t\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\tcase 'senet':\r\n+\t\t\t\t\t\t\t\t\t$db_path = 'senetler/' . $encrypted_name;\r\n+\t\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\tdefault:\r\n+\t\t\t\t\t\t\t\t\t$db_path = $encrypted_name;\r\n+\t\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t$uploaded_files[] = $db_path;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n+\t\tif (!empty($uploaded_files)) {\r\n+\t\t\t$file_list = implode(',', $uploaded_files);\r\n+\t\t\t\r\n+\t\t\t// Tip'e göre veritabanını güncelle\r\n+\t\t\tif ($tip == 'satis' && $satis_id) {\r\n+\t\t\t\t// Mevcut dosyaları al\r\n+\t\t\t\t$existing = $this->db->query(\"SELECT satis_dosya FROM satisFaturasi WHERE satis_id = '$satis_id'\")->row();\r\n+\t\t\t\t$current_files = $existing && !empty($existing->satis_dosya) ? $existing->satis_dosya . ',' : '';\r\n+\t\t\t\t$new_files = $current_files . $file_list;\r\n+\t\t\t\t\r\n+\t\t\t\t$dataUpdate = array('satis_dosya' => $new_files);\r\n+\t\t\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $dataUpdate);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Cari fotoğrafları için\r\n+\t\t\t\t$existing = $this->db->query(\"SELECT fotograf_dosya FROM cari WHERE cari_id = '$cari_id'\")->row();\r\n+\t\t\t\t$current_files = $existing && !empty($existing->fotograf_dosya) ? $existing->fotograf_dosya . ',' : '';\r\n+\t\t\t\t$new_files = $current_files . $file_list;\r\n+\t\t\t\t\r\n+\t\t\t\t$dataUpdate = array('fotograf_dosya' => $new_files);\r\n+\t\t\t\t$this->vt->update('cari', array('cari_id' => $cari_id), $dataUpdate);\r\n+\t\t\t}\r\n+\r\n+\t\t\techo json_encode(['success' => true, 'message' => count($uploaded_files) . ' dosya başarıyla yüklendi.']);\r\n+\t\t} else {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Dosya yüklenemedi!']);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757002108588,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,15 +15,32 @@\n \t\tparent::__construct();\r\n \t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n \t\t$this->load->model('vt');\r\n \r\n-\t\t$control = session(\"r\", \"login\");\r\n+\t\t// AJAX endpoint'ler için session kontrolünü bypass et\r\n+\t\t$current_url = $_SERVER['REQUEST_URI'] ?? '';\r\n+\t\t$ajax_endpoints = [\r\n+\t\t\t'/cari/getPersonelList',\r\n+\t\t\t'/cari/updateCariOlusturan'\r\n+\t\t];\r\n+\t\t\r\n+\t\t$is_ajax_endpoint = false;\r\n+\t\tforeach ($ajax_endpoints as $endpoint) {\r\n+\t\t\tif (strpos($current_url, $endpoint) !== false) {\r\n+\t\t\t\t$is_ajax_endpoint = true;\r\n+\t\t\t\tbreak;\r\n+\t\t\t}\r\n+\t\t}\r\n \r\n-\t\tif (gibYetki() == 1)\r\n-\t\t\tredirect(\"home/hata\");\r\n+\t\tif (!$is_ajax_endpoint) {\r\n+\t\t\t$control = session(\"r\", \"login\");\r\n \r\n-\t\tif (!$control) {\r\n-\t\t\tredirect(\"check\");\r\n+\t\t\tif (gibYetki() == 1)\r\n+\t\t\t\tredirect(\"home/hata\");\r\n+\r\n+\t\t\tif (!$control) {\r\n+\t\t\t\tredirect(\"check\");\r\n+\t\t\t}\r\n \t\t}\r\n \r\n \t\t//sessionKontrolHelper();\r\n \t}\r\n@@ -1470,5 +1487,100 @@\n \t\t} else {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Dosya yüklenemedi!']);\r\n \t\t}\r\n \t}\r\n+\t\r\n+\t/**\r\n+\t * Personel listesini getir\r\n+\t */\r\n+\tpublic function getPersonelList()\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t$personelQ = \"SELECT kullanici_id, kullanici_ad, kullanici_soyad \r\n+\t\t\t\t\t\t  FROM kullanicilar \r\n+\t\t\t\t\t\t  WHERE kullanici_durum = 1 \r\n+\t\t\t\t\t\t  ORDER BY kullanici_ad ASC, kullanici_soyad ASC\";\r\n+\t\t\t\r\n+\t\t\t$personeller = $this->db->query($personelQ)->result();\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true,\r\n+\t\t\t\t'data' => $personeller\r\n+\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Personel listesi alınırken hata oluştu: ' . $e->getMessage()\r\n+\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Cari oluşturan personeli güncelle\r\n+\t */\r\n+\tpublic function updateCariOlusturan()\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\t$cari_olusturan = $this->input->post('cari_olusturan');\r\n+\t\t\t\r\n+\t\t\tif (empty($cari_id) || empty($cari_olusturan)) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => false,\r\n+\t\t\t\t\t'message' => 'Gerekli parametreler eksik!'\r\n+\t\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Cari kaydının varlığını kontrol et\r\n+\t\t\t$this->db->where('cari_id', $cari_id);\r\n+\t\t\t$cari_exists = $this->db->get('cari')->num_rows();\r\n+\t\t\t\r\n+\t\t\tif ($cari_exists == 0) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => false,\r\n+\t\t\t\t\t'message' => 'Cari kaydı bulunamadı!'\r\n+\t\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Personelin varlığını kontrol et\r\n+\t\t\t$this->db->where('kullanici_id', $cari_olusturan);\r\n+\t\t\t$personel_exists = $this->db->get('kullanicilar')->num_rows();\r\n+\t\t\t\r\n+\t\t\tif ($personel_exists == 0) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => false,\r\n+\t\t\t\t\t'message' => 'Personel bulunamadı!'\r\n+\t\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Güncelleme işlemi\r\n+\t\t\t$update_data = [\r\n+\t\t\t\t'cari_olusturan' => $cari_olusturan\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\t$this->db->where('cari_id', $cari_id);\r\n+\t\t\t$result = $this->db->update('cari', $update_data);\r\n+\t\t\t\r\n+\t\t\tif ($result) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => true,\r\n+\t\t\t\t\t'message' => 'Sorumlu personel başarıyla güncellendi!'\r\n+\t\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => false,\r\n+\t\t\t\t\t'message' => 'Güncelleme işlemi başarısız!'\r\n+\t\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Güncelleme sırasında hata oluştu: ' . $e->getMessage()\r\n+\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759148252087,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -128,8 +128,16 @@\n \t\t} else {\r\n \t\t\t$data['_iller'] = false;\r\n \t\t}\r\n \r\n+\t\t// Ülkeleri yükle\r\n+\t\t$ulkeler = $this->db->order_by('ulke_adi', 'ASC')->get('ulkeler');\r\n+\t\tif ($ulkeler->num_rows() > 0) {\r\n+\t\t\t$data['_ulkeler'] = $ulkeler->result();\r\n+\t\t} else {\r\n+\t\t\t$data['_ulkeler'] = false;\r\n+\t\t}\r\n+\r\n \t\t//logekle(1,1);\r\n \t\t$this->load->view(\"cari/cari-karti-olustur\", $data);\r\n \t}\tpublic function yeniCariKartiOlustur()\r\n \t{\r\n@@ -439,8 +447,16 @@\n \t\t} else {\r\n \t\t\t$data['_iller'] = false;\r\n \t\t}\r\n \t\t\r\n+\t\t// Ülkeler listesi\r\n+\t\t$ulkeler = $this->db->order_by('ulke_adi', 'ASC')->get('ulkeler');\r\n+\t\tif ($ulkeler->num_rows() > 0) {\r\n+\t\t\t$data['_ulkeler'] = $ulkeler->result();\r\n+\t\t} else {\r\n+\t\t\t$data['_ulkeler'] = false;\r\n+\t\t}\r\n+\t\t\r\n \t\t// Müşteri grupları\r\n \t\tif ($is_admin) {\r\n \t\t\t// Admin gruplar için tüm grupları göster\r\n \t\t\t$cariGruplariQ = \"SELECT * FROM cariGruplari\";\r\n"
                },
                {
                    "date": 1759149230647,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1598,5 +1598,26 @@\n \t\t\t\t'message' => 'Güncelleme sırasında hata oluştu: ' . $e->getMessage()\r\n \t\t\t], JSON_UNESCAPED_UNICODE);\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Ülkeye göre illeri getir\r\n+\t */\r\n+\tpublic function getIllerByUlke()\r\n+\t{\r\n+\t\t$ulke_id = $this->input->post('ulke_id');\r\n+\t\tif (empty($ulke_id)) {\r\n+\t\t\t$data = array('status' => 'error', 'message' => 'Ülke ID Bilgisi Alınamadı..!');\r\n+\t\t} else {\r\n+\t\t\t// Ülkeye göre iller çekiliyor...\r\n+\t\t\t$iller = $this->db->get_where('iller', array('ulke_id' => $ulke_id));\r\n+\t\t\tif ($iller->num_rows() > 0) {\r\n+\t\t\t\t$data = array('status' => 'success', 'data' => $iller->result());\r\n+\t\t\t} else {\r\n+\t\t\t\t$data = array('status' => 'error', 'message' => 'Bu ülkeye ait il bilgisi bulunamadı..!');\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\theader('Content-Type: application/json');\r\n+\t\techo json_encode($data);\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759746593669,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1067,33 +1067,113 @@\n \t\t\t\t\r\n \t\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad FROM cari WHERE cari_id = ? AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n \t\t\t\t$cari = $this->db->query($cariQ, array($cari_id))->row();\r\n \t\t\t\t\r\n-\t\t\t\t// Cari hareketlerinden bakiye hesapla (anaHesap kısıtlaması kaldırıldı)\r\n-\t\t\t\t$toplamBorcQ = \"SELECT COALESCE(SUM(ch_borc), 0) as toplam_borc \r\n-\t\t\t\t\t\t\t\tFROM cariHareketleri \r\n-\t\t\t\t\t\t\t\tWHERE ch_cariID = ?\";\r\n-\t\t\t\t$toplamBorc = $this->db->query($toplamBorcQ, array($cari_id))->row()->toplam_borc;\r\n+\t\t\t\t// Cari hareketleri sayfasındaki UNION sorgusu ile tutarlı hesaplama\r\n+\t\t\t\t$cariHareketleriQ = \"\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL    AS Borc,\r\n+\t\t\t\t\t\tCOALESCE(bh_giris, bh_cikis) AS Alacak\r\n+\t\t\t\t\tFROM bankahareketleri\r\n+\t\t\t\t\tWHERE bh_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL           AS Borc,\r\n+\t\t\t\t\t\tcek_tutar      AS Alacak\r\n+\t\t\t\t\tFROM cek\r\n+\t\t\t\t\tWHERE cek_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL    AS Borc,\r\n+\t\t\t\t\t\tCOALESCE(kh_giris, kh_cikis) AS Alacak\r\n+\t\t\t\t\tFROM kasahareketleri\r\n+\t\t\t\t\tWHERE kh_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL     AS Borc,\r\n+\t\t\t\t\t\tsenet_tutar AS Alacak\r\n+\t\t\t\t\tFROM senet\r\n+\t\t\t\t\tWHERE senet_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT\r\n+\t\t\t\t\t\tsatis_genelToplam  AS Borc,\r\n+\t\t\t\t\t\tNULL               AS Alacak\r\n+\t\t\t\t\tFROM satisfaturasi\r\n+\t\t\t\t\tWHERE satis_cariID = ?\r\n+\t\t\t\t\";\r\n \t\t\t\t\r\n-\t\t\t\t$toplamAlacakQ = \"SELECT COALESCE(SUM(ch_alacak), 0) as toplam_alacak \r\n-\t\t\t\t\t\t\t\t  FROM cariHareketleri \r\n-\t\t\t\t\t\t\t\t  WHERE ch_cariID = ?\";\r\n-\t\t\t\t$toplamAlacak = $this->db->query($toplamAlacakQ, array($cari_id))->row()->toplam_alacak;\r\n+\t\t\t\t$hareketler = $this->db->query($cariHareketleriQ, array($cari_id, $cari_id, $cari_id, $cari_id, $cari_id))->result();\r\n+\t\t\t\t\r\n+\t\t\t\t// Bakiye hesaplama\r\n+\t\t\t\t$toplamBorc = 0;\r\n+\t\t\t\t$toplamAlacak = 0;\r\n+\t\t\t\tforeach($hareketler as $hareket) {\r\n+\t\t\t\t\tif($hareket->Borc) $toplamBorc += $hareket->Borc;\r\n+\t\t\t\t\tif($hareket->Alacak) $toplamAlacak += $hareket->Alacak;\r\n+\t\t\t\t}\r\n \t\t\t} else {\r\n \t\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n \t\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad FROM cari WHERE cari_id = ?\";\r\n \t\t\t\t$cari = $this->db->query($cariQ, array($cari_id))->row();\r\n \t\t\t\t\r\n-\t\t\t\t// Cari hareketlerinden bakiye hesapla (kısıtlamasız)\r\n-\t\t\t\t$toplamBorcQ = \"SELECT COALESCE(SUM(ch_borc), 0) as toplam_borc \r\n-\t\t\t\t\t\t\t\tFROM cariHareketleri \r\n-\t\t\t\t\t\t\t\tWHERE ch_cariID = ?\";\r\n-\t\t\t\t$toplamBorc = $this->db->query($toplamBorcQ, array($cari_id))->row()->toplam_borc;\r\n+\t\t\t\t// Cari hareketleri sayfasındaki UNION sorgusu ile tutarlı hesaplama\r\n+\t\t\t\t$cariHareketleriQ = \"\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL    AS Borc,\r\n+\t\t\t\t\t\tCOALESCE(bh_giris, bh_cikis) AS Alacak\r\n+\t\t\t\t\tFROM bankahareketleri\r\n+\t\t\t\t\tWHERE bh_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL           AS Borc,\r\n+\t\t\t\t\t\tcek_tutar      AS Alacak\r\n+\t\t\t\t\tFROM cek\r\n+\t\t\t\t\tWHERE cek_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL    AS Borc,\r\n+\t\t\t\t\t\tCOALESCE(kh_giris, kh_cikis) AS Alacak\r\n+\t\t\t\t\tFROM kasahareketleri\r\n+\t\t\t\t\tWHERE kh_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tNULL     AS Borc,\r\n+\t\t\t\t\t\tsenet_tutar AS Alacak\r\n+\t\t\t\t\tFROM senet\r\n+\t\t\t\t\tWHERE senet_cariID = ?\r\n+\r\n+\t\t\t\t\tUNION ALL\r\n+\r\n+\t\t\t\t\tSELECT\r\n+\t\t\t\t\t\tsatis_genelToplam  AS Borc,\r\n+\t\t\t\t\t\tNULL               AS Alacak\r\n+\t\t\t\t\tFROM satisfaturasi\r\n+\t\t\t\t\tWHERE satis_cariID = ?\r\n+\t\t\t\t\";\r\n \t\t\t\t\r\n-\t\t\t\t$toplamAlacakQ = \"SELECT COALESCE(SUM(ch_alacak), 0) as toplam_alacak \r\n-\t\t\t\t\t\t\t\t  FROM cariHareketleri \r\n-\t\t\t\t\t\t\t\t  WHERE ch_cariID = ?\";\r\n-\t\t\t\t$toplamAlacak = $this->db->query($toplamAlacakQ, array($cari_id))->row()->toplam_alacak;\r\n+\t\t\t\t$hareketler = $this->db->query($cariHareketleriQ, array($cari_id, $cari_id, $cari_id, $cari_id, $cari_id))->result();\r\n+\t\t\t\t\r\n+\t\t\t\t// Bakiye hesaplama\r\n+\t\t\t\t$toplamBorc = 0;\r\n+\t\t\t\t$toplamAlacak = 0;\r\n+\t\t\t\tforeach($hareketler as $hareket) {\r\n+\t\t\t\t\tif($hareket->Borc) $toplamBorc += $hareket->Borc;\r\n+\t\t\t\t\tif($hareket->Alacak) $toplamAlacak += $hareket->Alacak;\r\n+\t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\tif (!$cari) {\r\n \t\t\t\t$response['message'] = 'Cari bulunamadı';\r\n"
                },
                {
                    "date": 1759748248180,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -760,8 +760,22 @@\n \t\t$config['next_tag_close'] = '</li></span>';\r\n \t\t$this->pagination->initialize($config);\r\n \t\t$data[\"links\"] = $this->pagination->create_links();\r\n \t\t$data[\"cari\"] = $this->db->query($sorgu)->result();\r\n+\t\t\r\n+\t\t// Toplam satış faturası tutarını hesapla\r\n+\t\t$toplamSatisTutarQ = \"SELECT COALESCE(SUM(sf.satis_genelToplam), 0) as toplam_satis_tutar \r\n+\t\t\t\t\t\t\t  FROM satisfaturasi sf \r\n+\t\t\t\t\t\t\t  INNER JOIN cari c ON sf.satis_cariID = c.cari_id \r\n+\t\t\t\t\t\t\t  WHERE c.cari_durum=true AND c.cari_olusturan IN ($allowed_user_ids_str)\";\r\n+\t\t\r\n+\t\tif ((isset($cariKodu) && !empty($cariKodu)) || (isset($cariAdi) && !empty($cariAdi)) || (isset($islemYapan) && !empty($islemYapan)) || (isset($bulunduguIl) && !empty($bulunduguIl)) || (isset($tarihGet) && !empty($tarihGet)) || ($cariTipi != 2)) {\r\n+\t\t\t$toplamSatisTutarQ .= \" AND c.cari_kodu LIKE '%$cariKodu%' AND c.cari_ad LIKE '%$cariAdi%' $sorgu1 $sorgu2 $sorgu3 $sorgu4\";\r\n+\t\t}\r\n+\t\t\r\n+\t\t$toplamSatisTutarResult = $this->db->query($toplamSatisTutarQ)->row();\r\n+\t\t$data[\"toplamSatisTutar\"] = $toplamSatisTutarResult->toplam_satis_tutar;\r\n+\t\t\r\n \t\t$this->load->view(\"cari/cari-listesi\", $data);\r\n \t}\r\n \r\n \tpublic function cariHareketleri()\r\n"
                },
                {
                    "date": 1759818908776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -285,8 +285,9 @@\n \t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n \t\t$data[\"cari_firmaEPosta\"] = postval(\"cari_firmaEPosta\");\r\n \t\t$data[\"cari_firmaTelefon\"] = postval(\"cari_firmaTelefon\");\r\n \t\t$data[\"cari_adres\"] = mb_strtoupper(postval(\"cari_adres\"), \"UTF-8\");\r\n+\t\t$data[\"potansiyel_postaKodu\"] = postval(\"potansiyel_postaKodu\");\r\n \t\t$data[\"cari_olusturan\"] = $u_id;\r\n \t\t$data[\"cari_olusturanAnaHesap\"] = $anaHesap;\r\n \t\t$data[\"cari_olusturmaTarihi\"] = $tarihi;\r\n \t\t$data[\"cari_olusturmaSaati\"] = $saati;\t\t$data[\"cari_bireysel\"] = $cariTipi;\r\n"
                },
                {
                    "date": 1759819215871,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -285,9 +285,9 @@\n \t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n \t\t$data[\"cari_firmaEPosta\"] = postval(\"cari_firmaEPosta\");\r\n \t\t$data[\"cari_firmaTelefon\"] = postval(\"cari_firmaTelefon\");\r\n \t\t$data[\"cari_adres\"] = mb_strtoupper(postval(\"cari_adres\"), \"UTF-8\");\r\n-\t\t$data[\"potansiyel_postaKodu\"] = postval(\"potansiyel_postaKodu\");\r\n+\t\t$data[\"cari_postaKod\"] = postval(\"cari_postaKod\");\r\n \t\t$data[\"cari_olusturan\"] = $u_id;\r\n \t\t$data[\"cari_olusturanAnaHesap\"] = $anaHesap;\r\n \t\t$data[\"cari_olusturmaTarihi\"] = $tarihi;\r\n \t\t$data[\"cari_olusturmaSaati\"] = $saati;\t\t$data[\"cari_bireysel\"] = $cariTipi;\r\n"
                },
                {
                    "date": 1759819314680,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -285,9 +285,9 @@\n \t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n \t\t$data[\"cari_firmaEPosta\"] = postval(\"cari_firmaEPosta\");\r\n \t\t$data[\"cari_firmaTelefon\"] = postval(\"cari_firmaTelefon\");\r\n \t\t$data[\"cari_adres\"] = mb_strtoupper(postval(\"cari_adres\"), \"UTF-8\");\r\n-\t\t$data[\"cari_postaKod\"] = postval(\"cari_postaKod\");\r\n+\t\t$data[\"cari_postaKodu\"] = postval(\"cari_postaKodu\");\r\n \t\t$data[\"cari_olusturan\"] = $u_id;\r\n \t\t$data[\"cari_olusturanAnaHesap\"] = $anaHesap;\r\n \t\t$data[\"cari_olusturmaTarihi\"] = $tarihi;\r\n \t\t$data[\"cari_olusturmaSaati\"] = $saati;\t\t$data[\"cari_bireysel\"] = $cariTipi;\r\n"
                },
                {
                    "date": 1760086613704,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -255,19 +255,11 @@\n \t\t\t\t\t\tdie;\r\n \t\t\t\t\t}\r\n \t\t\t\t}*/\r\n \r\n-\t\t$vergiKontrolQ = \"SELECT * FROM cari WHERE cari_olusturanAnaHesap = '$anaHesap' AND cari_vergiNumarasi = '$cariVergiNo' AND cari_durum=true\";\r\n-\t\t$vergiKontrol = $this->db->query($vergiKontrolQ)->row();\r\n+\t\t// TC Kimlik/Vergi numarası kontrolü kaldırıldı - aynı numara ile kayıt olmasına izin verildi\r\n+\t\t// Önceki kontroller: cari_tckn ve cari_vergiNumarasi tekrar kontrolleri devre dışı bırakıldı\r\n \r\n-\t\tif ($cariTipi == 0) {\r\n-\t\t\tif ($vergiKontrol) {\r\n-\t\t\t\t$this->session->set_flashdata('cari_kodu_vergino', 'OK');\r\n-\t\t\t\tredirect(\"cari/cari-karti-olustur\");\r\n-\t\t\t\tdie;\r\n-\t\t\t}\r\n-\t\t}\r\n-\r\n \t\tif ($cariVergiNoLen == 10)\r\n \t\t\t$data[\"cari_vergiNumarasi\"] = $cariVergiNo;\r\n \t\telse if ($cariVergiNoLen == 11)\r\n \t\t\t$data[\"cari_tckn\"] = $cariVergiNo;\r\n"
                },
                {
                    "date": 1760446763311,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,8 @@\n \t\t$data[\"cari_ad\"] = mb_strtoupper(postval(\"cari_ad\"), \"UTF-8\");\r\n \t\t$data[\"cari_soyad\"] = mb_strtoupper(postval(\"cari_soyad\"), \"UTF-8\");\r\n \t\t$data[\"cari_vergiDairesi\"] = mb_strtoupper(postval(\"cari_vergiDairesi\"), \"UTF-8\");\t\t/*\t\t$data[\"cari_vergiNumarasi\"] = $cariVergiNo;\r\n \t\t\t\t$data[\"cari_tckn\"] = $tckn;*/\r\n-\t\t$data[\"cari_cariGrupKoduID\"] = postval(\"cari_cariGrupKoduID\");\r\n \t\t$data[\"cari_ulke\"] = postval(\"cari_ulke\");\r\n \t\t$data[\"cari_il\"] = postval(\"cari_il\");\r\n \t\t$data[\"cari_ilce\"] = postval(\"cari_ilce\");\r\n \t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n@@ -529,9 +528,8 @@\n \t\t$data[\"cari_kodu\"] = mb_strtoupper(postval(\"cari_kodu\"), \"UTF-8\");\r\n \t\t$data[\"cari_ad\"] = mb_strtoupper(postval(\"cari_ad\"), \"UTF-8\");\r\n \t\t$data[\"cari_soyad\"] = mb_strtoupper(postval(\"cari_soyad\"), \"UTF-8\");\r\n \t\t$data[\"cari_vergiDairesi\"] = mb_strtoupper(postval(\"cari_vergiDairesi\"), \"UTF-8\");\r\n-\t\t$data[\"cari_cariGrupKoduID\"] = postval(\"cari_cariGrupKoduID\");\r\n \t\t$data[\"cari_ulke\"] = postval(\"cari_ulke\");\r\n \t\t$data[\"cari_il\"] = postval(\"cari_il\");\r\n \t\t$data[\"cari_ilce\"] = postval(\"cari_ilce\");\r\n \t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n"
                }
            ],
            "date": 1754904082238,
            "name": "Commit-0",
            "content": "<?php\r\ndefined('BASEPATH') or exit('No direct script access allowed');\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\r\nuse PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\r\nuse PhpOffice\\PhpSpreadsheet\\Helper\\Sample;\r\nuse PhpOffice\\PhpSpreadsheet\\IOFactory;\r\nuse furkankadioglu\\eFatura\\InvoiceManager;\r\n\r\nclass Cari extends CI_Controller\r\n{\r\n\r\n\tpublic function __construct()\r\n\t{\r\n\t\tparent::__construct();\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\t\t$this->load->model('vt');\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\t\tif (gibYetki() == 1)\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\tif (!$control) {\r\n\t\t\tredirect(\"check\");\r\n\t\t}\r\n\r\n\t\t//sessionKontrolHelper();\r\n\t}\r\n\r\n\tpublic function cariGruplari()\r\n\t{\r\n\t\t$data[\"baslik\"] = \"Cari / Cari Grupları\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$cariGruplariQ = \"SELECT * FROM cariGruplari WHERE cariGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$data[\"cariGruplari\"] = $this->db->query($cariGruplariQ)->result();\r\n\r\n\t\t$countq = \"SELECT COUNT(*) as total FROM cariGruplari WHERE cariGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t$count = $countexe->total;\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\t\t//logekle(4,1);\r\n\t\t$this->load->view('cari/cari-gruplari', $data);\r\n\t}\r\n\r\n\tpublic function yeniCariGrubuEkle()\r\n\t{\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$cariGrup_kodu = postval(\"cariGrup_kodu\");\r\n\r\n\t\t$data[\"cariGrup_kodu\"] = $cariGrup_kodu;\r\n\t\t$data[\"cariGrup_ad\"] = postval(\"cariGrup_ad\");\r\n\t\t$data[\"cariGrup_olusturan\"] = $u_id;\r\n\t\t$data[\"cariGrup_olusturanAnaHesap\"] = $anaHesap;\r\n\t\t$data[\"cariGrup_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$cariGrupKoduVarmiQ = \"SELECT * FROM cariGruplari WHERE cariGrup_kodu = '$cariGrup_kodu' AND cariGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$cariGrupKoduVarmi = $this->db->query($cariGrupKoduVarmiQ)->row();\r\n\r\n\t\tif ($cariGrupKoduVarmi) {\r\n\t\t\t$this->session->set_flashdata('cari_grup_kodvar', 'OK');\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t\t} else {\r\n\t\t\t$this->vt->insert(\"cariGruplari\", $data);\r\n\t\t\t$this->session->set_flashdata('cari_grup_ok', 'OK');\r\n\t\t\tlogekle(4, 2);\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function mevcutCariGrubuDuzenle()\r\n\t{\r\n\t\t$id = postval(\"cariGrup_id\");\r\n\t\t$cariGrup_kodu = postval(\"cariGrup_kodu\");\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$data[\"cariGrup_kodu\"] = $cariGrup_kodu;\r\n\t\t$data[\"cariGrup_ad\"] = postval(\"cariGrup_ad\");\r\n\r\n\t\t$cariGrupKoduVarmiQ = \"SELECT * FROM cariGruplari WHERE cariGrup_kodu = '$cariGrup_kodu' AND cariGrup_olusturanAnaHesap = '$anaHesap' AND cariGrup_id != $id\";\r\n\t\t$cariGrupKoduVarmi = $this->db->query($cariGrupKoduVarmiQ)->row();\r\n\r\n\t\tif ($cariGrupKoduVarmi) {\r\n\t\t\t$this->session->set_flashdata('cari_grup_kodvar', 'OK');\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t\t} else {\r\n\t\t\t$this->vt->update('cariGruplari', array('cariGrup_id' => $id), $data);\r\n\t\t\t$this->session->set_flashdata('cari_grup_updt_ok', 'OK');\r\n\t\t\tlogekle(4, 3);\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function cariKartiOlustur()\r\n\t{\r\n\t\t$data[\"baslik\"] = \"Cari / Cari Kartı Oluştur\";\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\t\t} else {\r\n\t\t\t$data['_iller'] = false;\r\n\t\t}\r\n\r\n\t\t//logekle(1,1);\r\n\t\t$this->load->view(\"cari/cari-karti-olustur\", $data);\r\n\t}\tpublic function yeniCariKartiOlustur()\r\n\t{\r\n\t\t// DEBUGGING: Log all POST data to understand mobile submission issues\r\n\t\t$debug_log_file = FCPATH . 'debug_cari_listesi.log';\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\t\r\n\t\t// Get user agent to identify mobile devices\r\n\t\t$user_agent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : 'Unknown';\r\n\t\t$is_mobile = preg_match('/(android|iphone|ipad|mobile)/i', $user_agent);\r\n\t\t\r\n\t\t// Detailed debug information\r\n\t\t$debug_info = array(\r\n\t\t\t'timestamp' => $timestamp,\r\n\t\t\t'user_agent' => $user_agent,\r\n\t\t\t'is_mobile' => $is_mobile,\r\n\t\t\t'post_data_count' => count($_POST),\r\n\t\t\t'post_data' => $_POST,\r\n\t\t\t'files_data' => $_FILES,\r\n\t\t\t'request_method' => $_SERVER['REQUEST_METHOD'],\r\n\t\t\t'content_type' => isset($_SERVER['CONTENT_TYPE']) ? $_SERVER['CONTENT_TYPE'] : 'Not set',\r\n\t\t\t'content_length' => isset($_SERVER['CONTENT_LENGTH']) ? $_SERVER['CONTENT_LENGTH'] : 'Not set'\r\n\t\t);\r\n\t\t\r\n\t\t// Log to file\r\n\t\t$log_entry = $timestamp . \" [CARI_CREATION_DEBUG] \" . json_encode($debug_info, JSON_PRETTY_PRINT) . \"\\n\\n\";\r\n\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$cariTipi = postval(\"cari_bireysel\");\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\t\t$cariVergiNo = postval(\"cari_vergiNumarasi\");\r\n\t\t//\t$tckn = postval(\"cari_tckn\");\r\n\t\t$alias_pk = postval(\"cari_alias_pk\");\r\n\t\t\r\n\t\t// ENHANCED DEBUG: Log specific form values for mobile debugging\r\n\t\t$debug_values = array(\r\n\t\t\t'cari_bireysel' => $cariTipi,\r\n\t\t\t'cari_kodu' => $cariKodu,\r\n\t\t\t'cari_vergiNumarasi' => $cariVergiNo,\r\n\t\t\t'cari_ad' => postval(\"cari_ad\"),\r\n\t\t\t'cari_soyad' => postval(\"cari_soyad\"),\r\n\t\t\t'cari_il' => postval(\"cari_il\"),\r\n\t\t\t'cari_ilce' => postval(\"cari_ilce\"),\r\n\t\t\t'cari_firmaTelefon' => postval(\"cari_firmaTelefon\"),\r\n\t\t\t'cari_firmaEPosta' => postval(\"cari_firmaEPosta\"),\r\n\t\t\t'files_count' => count($_FILES),\r\n\t\t\t'all_post_keys' => array_keys($_POST)\r\n\t\t);\r\n\t\t\r\n\t\t$log_entry2 = $timestamp . \" [CARI_VALUES_DEBUG] \" . json_encode($debug_values, JSON_PRETTY_PRINT) . \"\\n\\n\";\r\n\t\tfile_put_contents($debug_log_file, $log_entry2, FILE_APPEND | LOCK_EX);\r\n\t\t\r\n\t\t// Check if we have critical empty values that shouldn't be empty (mobile issue detection)\r\n\t\t$empty_critical_fields = array();\r\n\t\tif (empty($cariTipi)) $empty_critical_fields[] = 'cari_bireysel';\r\n\t\tif (empty(postval(\"cari_ad\"))) $empty_critical_fields[] = 'cari_ad';\r\n\t\tif (empty(postval(\"cari_il\"))) $empty_critical_fields[] = 'cari_il';\r\n\t\t\r\n\t\tif (!empty($empty_critical_fields)) {\r\n\t\t\t$log_entry3 = $timestamp . \" [MOBILE_ISSUE_DETECTED] Empty critical fields: \" . implode(', ', $empty_critical_fields) . \"\\n\";\r\n\t\t\tfile_put_contents($debug_log_file, $log_entry3, FILE_APPEND | LOCK_EX);\r\n\t\t\t\r\n\t\t\t// For mobile devices with empty data, redirect back with error\r\n\t\t\tif ($is_mobile && count($empty_critical_fields) >= 2) {\r\n\t\t\t\t$this->session->set_flashdata('mobile_form_error', 'OK');\r\n\t\t\t\tredirect(\"cari/cari-karti-olustur\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($alias_pk === \"\") {//earşiv\r\n\t\t\t$cariEInvoiceType = 2;\r\n\t\t} else {\r\n\t\t\t$cariEInvoiceType = 1;\r\n\t\t}\r\n\t\t$cariKoduLen = strlen($cariKodu);\r\n\t\t$cariVergiNoLen = strlen($cariVergiNo);\r\n\t\t\r\n\t\t// Cari Kodu boşsa otomatik oluştur\r\n\t\tif (empty($cariKodu) || $cariKoduLen < 3) {\r\n\t\t\t// Son cari kodunu bul ve +1 artırarak yeni kod oluştur\r\n\t\t\t$sonCariKoduQ = \"SELECT cari_kodu FROM cari WHERE cari_olusturanAnaHesap = '$anaHesap' AND cari_kodu REGEXP '^[0-9]+$' ORDER BY CAST(cari_kodu AS UNSIGNED) DESC LIMIT 1\";\r\n\t\t\t$sonCariKodu = $this->db->query($sonCariKoduQ)->row();\r\n\t\t\t\r\n\t\t\tif ($sonCariKodu) {\r\n\t\t\t\t$yeniKodNumara = intval($sonCariKodu->cari_kodu) + 1;\r\n\t\t\t} else {\r\n\t\t\t\t$yeniKodNumara = 1;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$cariKodu = str_pad($yeniKodNumara, 3, '0', STR_PAD_LEFT);\r\n\t\t}\r\n\t\t/*\r\n\t\t\t\tif($cariTipi == 0) {\r\n\t\t\t\t\tif ($cariVergiNoLen < 10) {\r\n\t\t\t\t\t\t$this->session->set_flashdata('cari_kodu_vkn_karakter', 'OK');\r\n\t\t\t\t\t\tredirect(\"cari/cari-karti-olustur\");\r\n\t\t\t\t\t\tdie;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif($cariTipi == 1) {\r\n\t\t\t\t\tif ($cariVergiNoLen < 11) {\r\n\t\t\t\t\t\t$this->session->set_flashdata('cari_kodu_tckn_karakter', 'OK');\r\n\t\t\t\t\t\tredirect(\"cari/cari-karti-olustur\");\r\n\t\t\t\t\t\tdie;\r\n\t\t\t\t\t}\r\n\t\t\t\t}*/\r\n\r\n\t\t$vergiKontrolQ = \"SELECT * FROM cari WHERE cari_olusturanAnaHesap = '$anaHesap' AND cari_vergiNumarasi = '$cariVergiNo' AND cari_durum=true\";\r\n\t\t$vergiKontrol = $this->db->query($vergiKontrolQ)->row();\r\n\r\n\t\tif ($cariTipi == 0) {\r\n\t\t\tif ($vergiKontrol) {\r\n\t\t\t\t$this->session->set_flashdata('cari_kodu_vergino', 'OK');\r\n\t\t\t\tredirect(\"cari/cari-karti-olustur\");\r\n\t\t\t\tdie;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($cariVergiNoLen == 10)\r\n\t\t\t$data[\"cari_vergiNumarasi\"] = $cariVergiNo;\r\n\t\telse if ($cariVergiNoLen == 11)\r\n\t\t\t$data[\"cari_tckn\"] = $cariVergiNo;\r\n\r\n\r\n\t\t$data[\"cari_kodu\"] = mb_strtoupper($cariKodu, \"UTF-8\");;\r\n\t\t$data[\"cari_ad\"] = mb_strtoupper(postval(\"cari_ad\"), \"UTF-8\");\r\n\t\t$data[\"cari_soyad\"] = mb_strtoupper(postval(\"cari_soyad\"), \"UTF-8\");\r\n\t\t$data[\"cari_vergiDairesi\"] = mb_strtoupper(postval(\"cari_vergiDairesi\"), \"UTF-8\");\t\t/*\t\t$data[\"cari_vergiNumarasi\"] = $cariVergiNo;\r\n\t\t\t\t$data[\"cari_tckn\"] = $tckn;*/\r\n\t\t$data[\"cari_cariGrupKoduID\"] = postval(\"cari_cariGrupKoduID\");\r\n\t\t$data[\"cari_ulke\"] = postval(\"cari_ulke\");\r\n\t\t$data[\"cari_il\"] = postval(\"cari_il\");\r\n\t\t$data[\"cari_ilce\"] = postval(\"cari_ilce\");\r\n\t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n\t\t$data[\"cari_firmaEPosta\"] = postval(\"cari_firmaEPosta\");\r\n\t\t$data[\"cari_firmaTelefon\"] = postval(\"cari_firmaTelefon\");\r\n\t\t$data[\"cari_adres\"] = mb_strtoupper(postval(\"cari_adres\"), \"UTF-8\");\r\n\t\t$data[\"cari_olusturan\"] = $u_id;\r\n\t\t$data[\"cari_olusturanAnaHesap\"] = $anaHesap;\r\n\t\t$data[\"cari_olusturmaTarihi\"] = $tarihi;\r\n\t\t$data[\"cari_olusturmaSaati\"] = $saati;\t\t$data[\"cari_bireysel\"] = $cariTipi;\r\n\t\t$data[\"cari_EInvoiceType\"] = $cariEInvoiceType;\r\n\t\t$data[\"cari_alias_pk\"] = $alias_pk;\t\t// Handle file upload for photos\r\n\t\t$fotograf_dosyalar = [];\r\n\t\tif (!empty($_FILES['cari_fotograflar']['name'][0])) {\r\n\t\t\t$count = count($_FILES['cari_fotograflar']['name']);\r\n\t\t\t$gorsel_dir = FCPATH . 'assets/uploads/cariler/gorseller/';\r\n\t\t\tif (!is_dir($gorsel_dir)) { \r\n\t\t\t\tmkdir($gorsel_dir, 0777, true); \r\n\t\t\t}\r\n\t\t\tfor ($i = 0; $i < $count; $i++) {\r\n\t\t\t\tif ($_FILES['cari_fotograflar']['error'][$i] == 0) {\r\n\t\t\t\t\t$tmp_name = $_FILES['cari_fotograflar']['tmp_name'][$i];\r\n\t\t\t\t\t$original_name = $_FILES['cari_fotograflar']['name'][$i];\r\n\t\t\t\t\t$name = uniqid('foto_') . '_' . basename($original_name);\r\n\t\t\t\t\t$target_path = $gorsel_dir . $name;\r\n\t\t\t\t\tif (move_uploaded_file($tmp_name, $target_path)) {\r\n\t\t\t\t\t\t$fotograf_dosyalar[] = 'cariler/gorseller/' . $name;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (count($fotograf_dosyalar) > 0) {\r\n\t\t\t$data['fotograf_dosya'] = implode(',', $fotograf_dosyalar);\r\n\t\t}\t\t// Handle file upload for documents\r\n\t\t$evrak_dosyalar = [];\r\n\t\tif (!empty($_FILES['cari_dosya']['name'][0])) {\r\n\t\t\t$count = count($_FILES['cari_dosya']['name']);\r\n\t\t\t$evrak_dir = FCPATH . 'assets/uploads/cariler/evraklar/';\r\n\t\t\tif (!is_dir($evrak_dir)) { \r\n\t\t\t\tmkdir($evrak_dir, 0777, true); \r\n\t\t\t}\r\n\t\t\tfor ($i = 0; $i < $count; $i++) {\r\n\t\t\t\tif ($_FILES['cari_dosya']['error'][$i] == 0) {\r\n\t\t\t\t\t$tmp_name = $_FILES['cari_dosya']['tmp_name'][$i];\r\n\t\t\t\t\t$original_name = $_FILES['cari_dosya']['name'][$i];\r\n\t\t\t\t\t$name = uniqid('evrak_') . '_' . basename($original_name);\r\n\t\t\t\t\t$target_path = $evrak_dir . $name;\r\n\t\t\t\t\tif (move_uploaded_file($tmp_name, $target_path)) {\r\n\t\t\t\t\t\t$evrak_dosyalar[] = 'cariler/evraklar/' . $name;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (count($evrak_dosyalar) > 0) {\r\n\t\t\t$data['evrak_dosya'] = implode(',', $evrak_dosyalar);\r\n\t\t}\t\t$cariKoduVarmiQ = \"SELECT * FROM cari WHERE cari_kodu = '$cariKodu' AND cari_olusturanAnaHesap = '$anaHesap' AND cari_durum=true\";\r\n\t\t$cariKoduVarmi = $this->db->query($cariKoduVarmiQ)->row();\r\n\r\n\t\t$page = postval(\"page\");\r\n\t\tif ($page == \"satisfatura\") {\r\n\t\t\tif ($cariKoduVarmi) {\r\n\t\t\t\t$this->session->set_flashdata('cari_kodu_mevcut', 'OK');\r\n\t\t\t} else {\r\n\t\t\t\t$this->vt->insert(\"cari\", $data);\r\n\t\t\t\t$cari_id = $this->db->insert_id();\r\n\t\t\t\t$this->session->set_flashdata('cari_ok', 'OK');\r\n\t\t\t\tlogekle(1, 2);\r\n\t\t\t}\r\n\t\t\tredirect(\"fatura/satis-faturasi/$cari_id/1\");\r\n\t\t} else if ($page == \"alisfatura\") {\r\n\t\t\tif ($cariKoduVarmi) {\r\n\t\t\t\t$this->session->set_flashdata('cari_kodu_mevcut', 'OK');\r\n\t\t\t} else {\r\n\t\t\t\t$this->vt->insert(\"cari\", $data);\r\n\t\t\t\t$cari_id = $this->db->insert_id();\r\n\t\t\t\t$this->session->set_flashdata('cari_ok', 'OK');\r\n\t\t\t\tlogekle(1, 2);\r\n\t\t\t}\r\n\t\t\tredirect(\"fatura/alis-faturasi/$cari_id/1\");\r\n\t\t} else if ($page == \"earsivfatura\") {\r\n\t\t\tif ($cariKoduVarmi) {\r\n\t\t\t\t$this->session->set_flashdata('cari_kodu_mevcut', 'OK');\r\n\t\t\t} else {\r\n\t\t\t\t$this->vt->insert(\"cari\", $data);\r\n\t\t\t\t$cari_id = $this->db->insert_id();\r\n\t\t\t\t$this->session->set_flashdata('cari_ok', 'OK');\r\n\t\t\t\tlogekle(1, 2);\r\n\t\t\t}\r\n\t\t\tredirect(\"fatura/earsiv-olustur/$cari_id/1\");\r\n\t\t} else if ($page == \"efatura\") {\r\n\t\t\tif ($cariKoduVarmi) {\r\n\t\t\t\t$this->session->set_flashdata('cari_kodu_mevcut', 'OK');\r\n\t\t\t} else {\r\n\t\t\t\t$this->vt->insert(\"cari\", $data);\r\n\t\t\t\t$cari_id = $this->db->insert_id();\r\n\t\t\t\t$this->session->set_flashdata('cari_ok', 'OK');\r\n\t\t\t\tlogekle(1, 2);\r\n\t\t\t}\r\n\t\t\tredirect(\"fatura/efatura-olustur/$cari_id/1\");\r\n\t\t} else {\r\n\t\t\tif ($cariKoduVarmi) {\r\n\t\t\t\t$this->session->set_flashdata('cari_kodu_mevcut', 'OK');\r\n\t\t\t\tredirect(\"cari/cari-karti-olustur\");\r\n\t\t\t} else {\r\n\t\t\t\t$this->vt->insert(\"cari\", $data);\r\n\t\t\t\t$cari_id = $this->db->insert_id();\r\n\t\t\t\t$this->session->set_flashdata('cari_ok', 'OK');\r\n\t\t\t\tlogekle(1, 2);\r\n\t\t\t\tredirect(\"cari/cari-karti-duzenle/$cari_id\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\tpublic function cariKartiDuzenle($id)\r\n\t{\r\n\t\t$data[\"baslik\"] = \"Cari / Cari Kartı Düzenle\";\r\n\t\t\r\n\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control->kullanici_id;\r\n\t\t$user_group_id = $control->grup_id;\r\n\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\r\n\t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n\t\t$allowed_user_ids = array($u_id);\r\n\t\tif ($u_id > 0) {\r\n\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\r\n\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t}\r\n\t\t}\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\r\n\t\t// Müşteri bilgilerini getir\r\n\t\tif ($is_admin) {\r\n\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n\t\t\t$cariQ = \"SELECT c.*, i.il as il_adi, il.ilce as ilce_adi \r\n\t\t\t\t\t  FROM cari c \r\n\t\t\t\t\t  LEFT JOIN iller i ON c.cari_il = i.id \r\n\t\t\t\t\t  LEFT JOIN ilceler il ON c.cari_ilce = il.id \r\n\t\t\t\t\t  WHERE c.cari_id = '$id' AND c.cari_durum = true\";\r\n\t\t} else {\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n\t\t\t$cariQ = \"SELECT c.*, i.il as il_adi, il.ilce as ilce_adi \r\n\t\t\t\t\t  FROM cari c \r\n\t\t\t\t\t  LEFT JOIN iller i ON c.cari_il = i.id \r\n\t\t\t\t\t  LEFT JOIN ilceler il ON c.cari_ilce = il.id \r\n\t\t\t\t\t  WHERE c.cari_id = '$id' AND c.cari_durum = true AND c.cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t}\r\n\t\t\r\n\t\t$cari = $this->db->query($cariQ)->row();\r\n\t\t\r\n\t\tif (!$cari) {\r\n\t\t\tshow_error('Müşteri bulunamadı!');\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t$data[\"cari\"] = $cari;\r\n\t\t\r\n\t\t// İller listesi\r\n\t\t$iller = $this->db->get('iller');\r\n\t\tif ($iller->num_rows() > 0) {\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\t\t} else {\r\n\t\t\t$data['_iller'] = false;\r\n\t\t}\r\n\t\t\r\n\t\t// Müşteri grupları\r\n\t\tif ($is_admin) {\r\n\t\t\t// Admin gruplar için tüm grupları göster\r\n\t\t\t$cariGruplariQ = \"SELECT * FROM cariGruplari\";\r\n\t\t} else {\r\n\t\t\t// Normal kullanıcılar için kısıtlama kaldırıldı (Dashboard mantığı)\r\n\t\t\t$cariGruplariQ = \"SELECT * FROM cariGruplari\";\r\n\t\t}\r\n\t\t$data[\"cariGruplari\"] = $this->db->query($cariGruplariQ)->result();\r\n\t\t\r\n\t\t// Detaylı iletişim bilgileri\r\n\t\t$cariDetayliQ = \"SELECT * FROM cariDetayliIletisim WHERE cdetay_cariID = '$id'\";\r\n\t\t$data[\"detaylıIletisim\"] = $this->db->query($cariDetayliQ)->result();\r\n\t\t\r\n\t\t// Detaylı banka bilgileri\r\n\t\t$cariDetayliBankaQ = \"SELECT * FROM cariDetayliBanka WHERE cdetayBanka_cariID = '$id'\";\r\n\t\t$data[\"detayliBanka\"] = $this->db->query($cariDetayliBankaQ)->result();\r\n\t\t\r\n\t\t// View'ı yükle\r\n\t\t$this->load->view('cari/cari-karti-olustur', $data);\r\n\t}\r\n\r\n\tpublic function mevcutCariKartiDuzenle()\r\n\t{\r\n\t\t// Debug logging to track form submissions\r\n\t\t$debug_file = FCPATH . 'debug_form_update.log';\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\tfile_put_contents($debug_file, \"=== FORM DEBUG START ===\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Timestamp: $timestamp\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Method: mevcutCariKartiDuzenle()\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"POST Data: \" . print_r($_POST, true) . \"\\n\", FILE_APPEND);\r\n\t\t\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t\r\n\t\t// Get the customer ID from POST data\r\n\t\t$cari_id = postval(\"cari_id\");\r\n\t\t\r\n\t\tif (!$cari_id) {\r\n\t\t\tfile_put_contents($debug_file, \"ERROR: No cari_id found in POST data\\n\", FILE_APPEND);\r\n\t\t\t$this->session->set_flashdata('cari_update_error', 'OK');\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tfile_put_contents($debug_file, \"Customer ID: $cari_id\\n\", FILE_APPEND);\r\n\t\t\r\n\t\t// Prepare update data\r\n\t\t$cariTipi = postval(\"cari_bireysel\");\r\n\t\t$cariVergiNo = postval(\"cari_vergiNumarasi\");\r\n\t\t$alias_pk = postval(\"cari_alias_pk\");\r\n\r\n\t\tif ($alias_pk === \"\") {\r\n\t\t\t$cariEInvoiceType = 2;\r\n\t\t} else {\r\n\t\t\t$cariEInvoiceType = 1;\r\n\t\t}\r\n\t\t\r\n\t\t$cariVergiNoLen = strlen($cariVergiNo);\r\n\t\t\r\n\t\t// Build update data array\r\n\t\t$data = array();\r\n\t\t\r\n\t\tif ($cariVergiNoLen == 10) {\r\n\t\t\t$data[\"cari_vergiNumarasi\"] = $cariVergiNo;\r\n\t\t\t$data[\"cari_tckn\"] = null;\r\n\t\t} else if ($cariVergiNoLen == 11) {\r\n\t\t\t$data[\"cari_tckn\"] = $cariVergiNo;\r\n\t\t\t$data[\"cari_vergiNumarasi\"] = null;\r\n\t\t}\r\n\r\n\t\t$data[\"cari_kodu\"] = mb_strtoupper(postval(\"cari_kodu\"), \"UTF-8\");\r\n\t\t$data[\"cari_ad\"] = mb_strtoupper(postval(\"cari_ad\"), \"UTF-8\");\r\n\t\t$data[\"cari_soyad\"] = mb_strtoupper(postval(\"cari_soyad\"), \"UTF-8\");\r\n\t\t$data[\"cari_vergiDairesi\"] = mb_strtoupper(postval(\"cari_vergiDairesi\"), \"UTF-8\");\r\n\t\t$data[\"cari_cariGrupKoduID\"] = postval(\"cari_cariGrupKoduID\");\r\n\t\t$data[\"cari_ulke\"] = postval(\"cari_ulke\");\r\n\t\t$data[\"cari_il\"] = postval(\"cari_il\");\r\n\t\t$data[\"cari_ilce\"] = postval(\"cari_ilce\");\r\n\t\t$data[\"cari_websitesi\"] = postval(\"cari_websitesi\");\r\n\t\t$data[\"cari_firmaEPosta\"] = postval(\"cari_firmaEPosta\");\r\n\t\t$data[\"cari_firmaTelefon\"] = postval(\"cari_firmaTelefon\");\r\n\t\t$data[\"cari_adres\"] = mb_strtoupper(postval(\"cari_adres\"), \"UTF-8\");\r\n\t\t$data[\"cari_bireysel\"] = $cariTipi;\r\n\t\t$data[\"cari_EInvoiceType\"] = $cariEInvoiceType;\r\n\t\t$data[\"cari_alias_pk\"] = $alias_pk;\r\n\t\t\r\n\t\t// Get current customer data to merge with existing files\r\n\t\t$current_cari = $this->db->where('cari_id', $cari_id)->get('cari')->row();\r\n\t\t\r\n\t\t// Handle file upload for photos\r\n\t\t$fotograf_dosyalar = [];\r\n\t\tif ($current_cari && !empty($current_cari->fotograf_dosya)) {\r\n\t\t\t$fotograf_dosyalar = explode(',', $current_cari->fotograf_dosya);\r\n\t\t}\r\n\t\t\r\n\t\tif (!empty($_FILES['cari_fotograflar']['name'][0])) {\r\n\t\t\t$count = count($_FILES['cari_fotograflar']['name']);\r\n\t\t\t$gorsel_dir = FCPATH . 'assets/uploads/cariler/gorseller/';\r\n\t\t\tif (!is_dir($gorsel_dir)) { \r\n\t\t\t\tmkdir($gorsel_dir, 0777, true); \r\n\t\t\t}\r\n\t\t\tfor ($i = 0; $i < $count; $i++) {\r\n\t\t\t\tif ($_FILES['cari_fotograflar']['error'][$i] == 0) {\r\n\t\t\t\t\t$tmp_name = $_FILES['cari_fotograflar']['tmp_name'][$i];\r\n\t\t\t\t\t$original_name = $_FILES['cari_fotograflar']['name'][$i];\r\n\t\t\t\t\t$name = uniqid('foto_') . '_' . basename($original_name);\r\n\t\t\t\t\t$target_path = $gorsel_dir . $name;\r\n\t\t\t\t\tif (move_uploaded_file($tmp_name, $target_path)) {\r\n\t\t\t\t\t\t$fotograf_dosyalar[] = 'cariler/gorseller/' . $name;\r\n\t\t\t\t\t\tfile_put_contents($debug_file, \"Photo uploaded: \" . $name . \"\\n\", FILE_APPEND);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (count($fotograf_dosyalar) > 0) {\r\n\t\t\t$data['fotograf_dosya'] = implode(',', $fotograf_dosyalar);\r\n\t\t}\r\n\t\t\r\n\t\t// Handle file upload for documents\r\n\t\t$evrak_dosyalar = [];\r\n\t\tif ($current_cari && !empty($current_cari->evrak_dosya)) {\r\n\t\t\t$evrak_dosyalar = explode(',', $current_cari->evrak_dosya);\r\n\t\t}\r\n\t\t\r\n\t\tif (!empty($_FILES['cari_dosya']['name'][0])) {\r\n\t\t\t$count = count($_FILES['cari_dosya']['name']);\r\n\t\t\t$evrak_dir = FCPATH . 'assets/uploads/cariler/evraklar/';\r\n\t\t\tif (!is_dir($evrak_dir)) { \r\n\t\t\t\tmkdir($evrak_dir, 0777, true); \r\n\t\t\t}\r\n\t\t\tfor ($i = 0; $i < $count; $i++) {\r\n\t\t\t\tif ($_FILES['cari_dosya']['error'][$i] == 0) {\r\n\t\t\t\t\t$tmp_name = $_FILES['cari_dosya']['tmp_name'][$i];\r\n\t\t\t\t\t$original_name = $_FILES['cari_dosya']['name'][$i];\r\n\t\t\t\t\t$name = uniqid('evrak_') . '_' . basename($original_name);\r\n\t\t\t\t\t$target_path = $evrak_dir . $name;\r\n\t\t\t\t\tif (move_uploaded_file($tmp_name, $target_path)) {\r\n\t\t\t\t\t\t$evrak_dosyalar[] = 'cariler/evraklar/' . $name;\r\n\t\t\t\t\t\tfile_put_contents($debug_file, \"Document uploaded: \" . $name . \"\\n\", FILE_APPEND);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (count($evrak_dosyalar) > 0) {\r\n\t\t\t$data['evrak_dosya'] = implode(',', $evrak_dosyalar);\r\n\t\t}\r\n\t\t\r\n\t\tfile_put_contents($debug_file, \"Update data prepared: \" . print_r($data, true) . \"\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"FILES data: \" . print_r($_FILES, true) . \"\\n\", FILE_APPEND);\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// Update the customer record\r\n\t\t\t$this->vt->update('cari', array('cari_id' => $cari_id), $data);\r\n\t\t\t\r\n\t\t\tfile_put_contents($debug_file, \"Database update successful\\n\", FILE_APPEND);\r\n\t\t\t\r\n\t\t\t// Set success message\r\n\t\t\t$this->session->set_flashdata('cari_update_ok', 'OK');\r\n\t\t\tlogekle(1, 3); // Log the update action\r\n\t\t\t\r\n\t\t\tfile_put_contents($debug_file, \"=== FORM DEBUG END - SUCCESS ===\\n\\n\", FILE_APPEND);\r\n\t\t\t\r\n\t\t\t// Redirect back to the edit form\r\n\t\t\tredirect(\"cari/cari-karti-duzenle/$cari_id\");\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\tfile_put_contents($debug_file, \"Database update failed: \" . $e->getMessage() . \"\\n\", FILE_APPEND);\r\n\t\t\tfile_put_contents($debug_file, \"=== FORM DEBUG END - ERROR ===\\n\\n\", FILE_APPEND);\r\n\t\t\t\t\t$this->session->set_flashdata('cari_update_error', 'OK');\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic function cariListesi()\r\n\t{\r\n\t\t$data[\"baslik\"] = \"Cari / Cari Listesi\";\r\n\t\t\r\n\t\t// Giriş yapan kullanıcı bilgisi\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control->kullanici_id;\r\n\t\t\r\n\t\t// Dashboard'daki \"Son Satışlarım\" mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t$allowed_user_ids = array($u_id);\r\n\t\tif ($u_id > 0) {\r\n\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\r\n\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t}\r\n\t\t}\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\r\n\t\t$cariKodu = $this->input->get('cariKodu');\r\n\t\t$cariAdi = $this->input->get('cariAdi');\r\n\t\t$cariTipi = $this->input->get('bireysel');\r\n\t\tif ($cariTipi == \"true\") {\r\n\t\t\t$cariTipi2 = 1;\r\n\t\t} else if ($cariTipi == \"false\") {\r\n\t\t\t$cariTipi2 = 0;\r\n\t\t} else {\r\n\t\t\t$cariTipi2 = 2;\r\n\t\t}\t\t$islemYapan = $this->input->get('islemYapan');\r\n\t\t$bulunduguIl = $this->input->get('bulunduguIl');\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0]));\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1]));\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\t\t$segment = 2;\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\t\t$limit = 20;\r\n\t\t$pagem = $sayfa ? ($page - 1) * $limit : 0;\r\n\t\tif ((isset($cariKodu) && !empty($cariKodu)) || (isset($cariAdi) && !empty($cariAdi)) || (isset($islemYapan) && !empty($islemYapan)) || (isset($bulunduguIl) && !empty($bulunduguIl)) || (isset($tarihGet) && !empty($tarihGet)) || ($cariTipi != 2)) {\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t\t$sorgu1 = !empty($islemYapan) ? \"AND cari_olusturan = '$islemYapan'\" : \"\";\r\n\t\t\t$sorgu2 = !empty($bulunduguIl) ? \"AND cari_il = '$bulunduguIl'\" : \"\";\r\n\t\t\t$sorgu3 = !empty($tarihGet) ? \"AND cari_olusturmaTarihi BETWEEN '$tarih1' AND '$tarih2'\" : \"\";\r\n\t\t\t$sorgu4 = !empty($cariTipi) ? \"AND cari_bireysel = '$cariTipi2'\" : \"\";\r\n\t\t\t\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM cari WHERE cari_durum=true AND cari_olusturan IN ($allowed_user_ids_str) AND cari_kodu LIKE '%$cariKodu%' AND cari_ad LIKE '%$cariAdi%' $sorgu1 $sorgu2 $sorgu3 $sorgu4\";\r\n\t\t\t$sorgu = \"SELECT * FROM cari WHERE cari_durum=true AND cari_olusturan IN ($allowed_user_ids_str) AND cari_kodu LIKE '%$cariKodu%' AND cari_ad LIKE '%$cariAdi%' $sorgu1 $sorgu2 $sorgu3 $sorgu4 ORDER BY cari_id DESC LIMIT $pagem,$limit\";\r\n\t\t\t\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t\t$count = $countexe->total;\r\n\t\t} else {\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM cari WHERE cari_durum=true AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t\t$sorgu = \"SELECT * FROM cari WHERE cari_durum=true AND cari_olusturan IN ($allowed_user_ids_str) ORDER BY cari_id DESC LIMIT $pagem,$limit\";\r\n\t\t\t\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\t\t\t$count = $countexe->total;\r\n\t\t}\r\n\t\t\r\n\t\t// DEBUG: Log sorgu bilgilerini\r\n\t\t$debug_file = FCPATH . 'debug_cari_listesi.log';\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\tfile_put_contents($debug_file, \"=== CARI LİSTESİ DEBUG ===\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Timestamp: $timestamp\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"User ID: $u_id\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Allowed User IDs: \" . implode(', ', $allowed_user_ids) . \"\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Kısıtlama: Dashboard mantığı - Kendisi + bağlı kullanıcılar (cari_olusturan IN ($allowed_user_ids_str))\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Count Query: $countq\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Main Query: $sorgu\\n\", FILE_APPEND);\r\n\t\tfile_put_contents($debug_file, \"Count Result: $count\\n\", FILE_APPEND);\r\n\t\t\r\n\t\t// Toplam kayıt kontrolü\r\n\t\t$totalCariQ = \"SELECT COUNT(*) as total FROM cari WHERE cari_durum=true\";\r\n\t\t$totalCariResult = $this->db->query($totalCariQ)->row();\r\n\t\tfile_put_contents($debug_file, \"Total active cari (no filter): \" . $totalCariResult->total . \"\\n\", FILE_APPEND);\r\n\t\t\r\n\t\t$kullaniciCariQ = \"SELECT COUNT(*) as total FROM cari WHERE cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t$kullaniciCariResult = $this->db->query($kullaniciCariQ)->row();\r\n\t\tfile_put_contents($debug_file, \"Total cari with allowed users filter: \" . $kullaniciCariResult->total . \"\\n\", FILE_APPEND);\r\n\t\t\r\n\t\t// Örnek kayıtları göster\r\n\t\t$ornekKayitlarQ = \"SELECT cari_id, cari_kodu, cari_ad, cari_olusturan, cari_durum FROM cari LIMIT 5\";\r\n\t\t$ornekKayitlar = $this->db->query($ornekKayitlarQ)->result();\r\n\t\tfile_put_contents($debug_file, \"Sample records:\\n\", FILE_APPEND);\r\n\t\tforeach($ornekKayitlar as $kayit) {\r\n\t\t\t$is_allowed = in_array($kayit->cari_olusturan, $allowed_user_ids) ? 'YES' : 'NO';\r\n\t\t\tfile_put_contents($debug_file, \"ID: {$kayit->cari_id}, Kod: {$kayit->cari_kodu}, Ad: {$kayit->cari_ad}, Oluşturan: {$kayit->cari_olusturan}, Durum: {$kayit->cari_durum}, Allowed: $is_allowed\\n\", FILE_APPEND);\r\n\t\t}\r\n\t\tfile_put_contents($debug_file, \"=== DEBUG END ===\\n\\n\", FILE_APPEND);\r\n\t\t\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\t\t$this->load->library(\"pagination\");\r\n\t\t$config = array();\r\n\t\t$config[\"base_url\"] = base_url() . \"/cari/$urim\";\r\n\t\t$config[\"total_rows\"] = $count;\r\n\t\t$config[\"per_page\"] = $limit;\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\t\t$config['page_query_string'] = TRUE;\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\t\t$config['num_links'] = 9;\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\t\t$config['next_link'] = '&raquo;';\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\t\t$this->pagination->initialize($config);\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\t\t$data[\"cari\"] = $this->db->query($sorgu)->result();\r\n\t\t$this->load->view(\"cari/cari-listesi\", $data);\r\n\t}\r\n\r\n\tpublic function cariHareketleri()\r\n\t{\r\n\t\t$data[\"baslik\"] = \"Cari / Cari Hareketleri\";\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t\r\n\t\t$getCari = $this->input->get('cari');\r\n\t\t$hareketTuru = $this->input->get('hareketTuru');\r\n\t\t$belgeNo = $this->input->get('belgeNo');\r\n\t\t$tarihAraligi = $this->input->get('tarihAraligi');\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n\t\tif (isset($getCari) && !empty($getCari)) {\r\n\t\t\t// Get customer information - NO RESTRICTION by account (allows any logged-in user to view any customer)\r\n\t\t\t$cariQ = \"SELECT * FROM cari WHERE cari_id = '$getCari'\";\r\n\t\t\t$cariExe = $this->db->query($cariQ)->row();\r\n\t\t\t\r\n\t\t\tif ($cariExe) {\r\n\t\t\t\t// Calculate customer balance\r\n\t\t\t\t$toplamBorcQ = \"SELECT SUM(ch_borc) AS toplamBorc FROM cariHareketleri WHERE ch_olusturanAnaHesap = '$anaHesap' AND ch_cariID = '$getCari'\";\r\n\t\t\t\t$toplamBorcExe = $this->db->query($toplamBorcQ)->row();\r\n\t\t\t\t\r\n\t\t\t\t$toplamAlacakQ = \"SELECT SUM(ch_alacak) AS toplamAlacak FROM cariHareketleri WHERE ch_olusturanAnaHesap = '$anaHesap' AND ch_cariID = '$getCari'\";\r\n\t\t\t\t$toplamAlacakExe = $this->db->query($toplamAlacakQ)->row();\r\n\t\t\t\t\r\n\t\t\t\t$toplamBorc = $toplamBorcExe->toplamBorc ?? 0;\r\n\t\t\t\t$toplamAlacak = $toplamAlacakExe->toplamAlacak ?? 0;\r\n\t\t\t\t$kalan = $toplamBorc - $toplamAlacak;\r\n\t\t\t\t\r\n\t\t\t\t$data[\"kalan\"] = $kalan;\r\n\t\t\t\t\r\n\t\t\t\t// Build transaction query with filters\r\n\t\t\t\t$where_conditions = \"ch_olusturanAnaHesap = '$anaHesap' AND ch_cariID = '$getCari'\";\r\n\t\t\t\t\r\n\t\t\t\tif (isset($hareketTuru) && !empty($hareketTuru)) {\r\n\t\t\t\t\t$where_conditions .= \" AND ch_turu = '$hareketTuru'\";\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (isset($belgeNo) && !empty($belgeNo)) {\r\n\t\t\t\t\t$where_conditions .= \" AND ch_belgeNumarasi LIKE '%$belgeNo%'\";\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (isset($tarihAraligi) && !empty($tarihAraligi)) {\r\n\t\t\t\t\t$tarihAraligi_array = explode(' - ', $tarihAraligi);\r\n\t\t\t\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi_array[0]));\r\n\t\t\t\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi_array[1]));\r\n\t\t\t\t\t$where_conditions .= \" AND ch_tarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Set sorting\r\n\t\t\t\t$order_by = \"ch_id DESC\";\r\n\t\t\t\tif (isset($siralama) && !empty($siralama)) {\r\n\t\t\t\t\tif ($siralama == \"eskiTarih\") {\r\n\t\t\t\t\t\t$order_by = \"ch_tarihi ASC\";\r\n\t\t\t\t\t} elseif ($siralama == \"yeniTarih\") {\r\n\t\t\t\t\t\t$order_by = \"ch_tarihi DESC\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t$cariHareketleriQ = \"SELECT * FROM cariHareketleri WHERE $where_conditions ORDER BY $order_by\";\r\n\t\t\t\t$data[\"cariHareketleri\"] = $this->db->query($cariHareketleriQ)->result();\r\n\t\t\t} else {\r\n\t\t\t\t$data[\"cariHareketleri\"] = array();\r\n\t\t\t\t$data[\"kalan\"] = 0;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t$data[\"cariHareketleri\"] = array();\r\n\t\t\t$data[\"kalan\"] = 0;\r\n\t\t}\r\n\t\t\r\n\t\t$this->load->view(\"cari/cari-hareketleri\", $data);\r\n\t}\tpublic function gorselSil()\r\n\t{\r\n\t\t$response = array('success' => false, 'message' => '');\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$cari_id = $this->input->post('cari_id');\r\n\t\t\t$dosya_adi = $this->input->post('dosya_adi');\r\n\t\t\t\r\n\t\t\tif (!$cari_id || !$dosya_adi) {\r\n\t\t\t\t$response['message'] = 'Gerekli parametreler eksik - Cari ID: ' . $cari_id . ', Dosya: ' . $dosya_adi;\r\n\t\t\t\techo json_encode($response);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t\t$control = session(\"r\", \"login_info\");\r\n\t\t\t$u_id = $control->kullanici_id;\r\n\t\t\t$user_group_id = $control->grup_id;\r\n\t\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\t\r\n\t\t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n\t\t\t$allowed_user_ids = array($u_id);\r\n\t\t\tif ($u_id > 0) {\r\n\t\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\t\r\n\t\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\t\r\n\t\t\t// Cari kaydını getir\r\n\t\t\tif ($is_admin) {\r\n\t\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n\t\t\t\t$cariQ = \"SELECT fotograf_dosya FROM cari WHERE cari_id = '$cari_id'\";\r\n\t\t\t} else {\r\n\t\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n\t\t\t\t$cariQ = \"SELECT fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$cariData = $this->db->query($cariQ)->row();\r\n\t\t\t\r\n\t\t\tif (!$cariData) {\r\n\t\t\t\t$response['message'] = 'Cari kaydı bulunamadı - ID: ' . $cari_id;\r\n\t\t\t\techo json_encode($response);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Mevcut görselleri al\r\n\t\t\t$mevcutGorseller = $cariData->fotograf_dosya;\r\n\t\t\t$gorselArray = explode(',', $mevcutGorseller);\r\n\t\t\t\r\n\t\t\t// Silinecek dosyayı listeden çıkar\r\n\t\t\t$yeniGorselArray = array();\r\n\t\t\tforeach ($gorselArray as $gorsel) {\r\n\t\t\t\tif (trim($gorsel) !== trim($dosya_adi)) {\r\n\t\t\t\t\t$yeniGorselArray[] = trim($gorsel);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Yeni listeyi oluştur\r\n\t\t\t$yeniGorselListesi = implode(',', $yeniGorselArray);\r\n\t\t\t\r\n\t\t\t// Veritabanını güncelle\r\n\t\t\t$updateData = array('fotograf_dosya' => $yeniGorselListesi);\r\n\t\t\t$this->vt->update('cari', array('cari_id' => $cari_id), $updateData);\r\n\t\t\t\r\n\t\t\t$response['success'] = true;\r\n\t\t\t$response['message'] = 'Görsel başarıyla silindi';\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$response['message'] = 'Hata oluştu: ' . $e->getMessage();\r\n\t\t}\r\n\t\t\r\n\t\techo json_encode($response);\r\n\t}\r\n\tpublic function evrakSil()\r\n\t{\r\n\t\t$response = array('success' => false, 'message' => '');\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$cari_id = $this->input->post('cari_id');\r\n\t\t\t$dosya_adi = $this->input->post('dosya_adi');\r\n\t\t\t\r\n\t\t\tif (!$cari_id || !$dosya_adi) {\r\n\t\t\t\t$response['message'] = 'Gerekli parametreler eksik - Cari ID: ' . $cari_id . ', Dosya: ' . $dosya_adi;\r\n\t\t\t\techo json_encode($response);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t\t$control = session(\"r\", \"login_info\");\r\n\t\t\t$u_id = $control->kullanici_id;\r\n\t\t\t$user_group_id = $control->grup_id;\r\n\t\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\t\r\n\t\t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n\t\t\t$allowed_user_ids = array($u_id);\r\n\t\t\tif ($u_id > 0) {\r\n\t\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\t\r\n\t\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\t\r\n\t\t\t// Cari kaydını getir\r\n\t\t\tif ($is_admin) {\r\n\t\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n\t\t\t\t$cariQ = \"SELECT evrak_dosya FROM cari WHERE cari_id = '$cari_id'\";\r\n\t\t\t} else {\r\n\t\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n\t\t\t\t$cariQ = \"SELECT evrak_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$cariData = $this->db->query($cariQ)->row();\r\n\t\t\t\r\n\t\t\tif (!$cariData) {\r\n\t\t\t\t$response['message'] = 'Cari kaydı bulunamadı - ID: ' . $cari_id;\r\n\t\t\t\techo json_encode($response);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Mevcut evrakları al\r\n\t\t\t$mevcutEvraklar = $cariData->evrak_dosya;\r\n\t\t\t$evrakArray = explode(',', $mevcutEvraklar);\r\n\t\t\t\r\n\t\t\t// Silinecek dosyayı listeden çıkar\r\n\t\t\t$yeniEvrakArray = array();\r\n\t\t\tforeach ($evrakArray as $evrak) {\r\n\t\t\t\tif (trim($evrak) !== trim($dosya_adi)) {\r\n\t\t\t\t\t$yeniEvrakArray[] = trim($evrak);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Yeni listeyi oluştur\r\n\t\t\t$yeniEvrakListesi = implode(',', $yeniEvrakArray);\r\n\t\t\t\r\n\t\t\t// Veritabanını güncelle\r\n\t\t\t$updateData = array('evrak_dosya' => $yeniEvrakListesi);\r\n\t\t\t$this->vt->update('cari', array('cari_id' => $cari_id), $updateData);\r\n\t\t\t\r\n\t\t\t$response['success'] = true;\r\n\t\t\t$response['message'] = 'Evrak başarıyla silindi';\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$response['message'] = 'Hata oluştu: ' . $e->getMessage();\r\n\t\t}\r\n\t\t\r\n\t\techo json_encode($response);\r\n\t}\r\n\tpublic function cariBakiyeGetir()\r\n\t{\r\n\t\t$response = array('success' => false, 'bakiye' => '');\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$cari_id = $this->input->post('cari_id');\r\n\t\t\t\r\n\t\t\tif (empty($cari_id)) {\r\n\t\t\t\t$response['message'] = 'Cari ID boş';\r\n\t\t\t\techo json_encode($response);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t\t$control = session(\"r\", \"login_info\");\r\n\t\t\t$u_id = $control->kullanici_id;\r\n\t\t\t$user_group_id = $control->grup_id;\r\n\t\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\t\r\n\t\t\tif (!$is_admin) {\r\n\t\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t\t\t$allowed_user_ids = array($u_id);\r\n\t\t\t\tif ($u_id > 0) {\r\n\t\t\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\t\t\r\n\t\t\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\t\t\r\n\t\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad FROM cari WHERE cari_id = ? AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t\t\t$cari = $this->db->query($cariQ, array($cari_id))->row();\r\n\t\t\t\t\r\n\t\t\t\t// Cari hareketlerinden bakiye hesapla (anaHesap kısıtlaması kaldırıldı)\r\n\t\t\t\t$toplamBorcQ = \"SELECT COALESCE(SUM(ch_borc), 0) as toplam_borc \r\n\t\t\t\t\t\t\t\tFROM cariHareketleri \r\n\t\t\t\t\t\t\t\tWHERE ch_cariID = ?\";\r\n\t\t\t\t$toplamBorc = $this->db->query($toplamBorcQ, array($cari_id))->row()->toplam_borc;\r\n\t\t\t\t\r\n\t\t\t\t$toplamAlacakQ = \"SELECT COALESCE(SUM(ch_alacak), 0) as toplam_alacak \r\n\t\t\t\t\t\t\t\t  FROM cariHareketleri \r\n\t\t\t\t\t\t\t\t  WHERE ch_cariID = ?\";\r\n\t\t\t\t$toplamAlacak = $this->db->query($toplamAlacakQ, array($cari_id))->row()->toplam_alacak;\r\n\t\t\t} else {\r\n\t\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n\t\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad FROM cari WHERE cari_id = ?\";\r\n\t\t\t\t$cari = $this->db->query($cariQ, array($cari_id))->row();\r\n\t\t\t\t\r\n\t\t\t\t// Cari hareketlerinden bakiye hesapla (kısıtlamasız)\r\n\t\t\t\t$toplamBorcQ = \"SELECT COALESCE(SUM(ch_borc), 0) as toplam_borc \r\n\t\t\t\t\t\t\t\tFROM cariHareketleri \r\n\t\t\t\t\t\t\t\tWHERE ch_cariID = ?\";\r\n\t\t\t\t$toplamBorc = $this->db->query($toplamBorcQ, array($cari_id))->row()->toplam_borc;\r\n\t\t\t\t\r\n\t\t\t\t$toplamAlacakQ = \"SELECT COALESCE(SUM(ch_alacak), 0) as toplam_alacak \r\n\t\t\t\t\t\t\t\t  FROM cariHareketleri \r\n\t\t\t\t\t\t\t\t  WHERE ch_cariID = ?\";\r\n\t\t\t\t$toplamAlacak = $this->db->query($toplamAlacakQ, array($cari_id))->row()->toplam_alacak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!$cari) {\r\n\t\t\t\t$response['message'] = 'Cari bulunamadı';\r\n\t\t\t\techo json_encode($response);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Net bakiye = Borç - Alacak \r\n\t\t\t// Pozitif: Müşterinin bizden alacağı var\r\n\t\t\t// Negatif: Müşterinin bize borcu var\r\n\t\t\t$bakiye = $toplamBorc - $toplamAlacak;\r\n\t\t\t\r\n\t\t\t// Formatla\r\n\t\t\t$bakiye_formatted = number_format(abs($bakiye), 2, ',', '.') . ' ₺';\r\n\t\t\tif ($bakiye > 0) {\r\n\t\t\t\t$bakiye_formatted = '<span class=\"text-danger\">-' . $bakiye_formatted . '</span> <small>(Müşteri alacaklı)</small>';\r\n\t\t\t} elseif ($bakiye < 0) {\r\n\t\t\t\t$bakiye_formatted = '<span class=\"text-success\">+' . $bakiye_formatted . '</span> <small>(Müşteri borçlu)</small>';\r\n\t\t\t} else {\r\n\t\t\t\t$bakiye_formatted = '<span class=\"text-muted\">' . $bakiye_formatted . '</span> <small>(Bakiye sıfır)</small>';\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$response['success'] = true;\r\n\t\t\t$response['bakiye'] = $bakiye_formatted;\r\n\t\t\t$response['bakiye_raw'] = $bakiye;\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$response['message'] = 'Hata oluştu: ' . $e->getMessage();\r\n\t\t}\r\n\t\t\r\n\t\techo json_encode($response);\r\n\t}\r\n\tpublic function gorselGoster($cari_id)\r\n\t{\r\n\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control->kullanici_id;\r\n\t\t$user_group_id = $control->grup_id;\r\n\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\r\n\t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n\t\t$allowed_user_ids = array($u_id);\r\n\t\tif ($u_id > 0) {\r\n\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\r\n\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t}\r\n\t\t}\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\r\n\t\t// Cari kaydını getir\r\n\t\tif ($is_admin) {\r\n\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true\";\r\n\t\t} else {\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, fotograf_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t}\r\n\t\t\r\n\t\t$cari = $this->db->query($cariQ)->row();\r\n\t\t\r\n\t\tif (!$cari) {\r\n\t\t\tshow_error('Cari kaydı bulunamadı!');\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t$data['cari'] = $cari;\r\n\t\t$data['cari_id'] = $cari_id;\r\n\t\t$data['is_admin'] = $is_admin;\r\n\t\t\r\n\t\t$this->load->view('cari/gorsel-goster', $data);\r\n\t}\r\n\t\r\n\tpublic function evrakGoster($cari_id)\r\n\t{\r\n\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control->kullanici_id;\r\n\t\t$user_group_id = $control->grup_id;\r\n\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\r\n\t\t// Allowed user IDs (kendisi + bağlı kullanıcılar)\r\n\t\t$allowed_user_ids = array($u_id);\r\n\t\tif ($u_id > 0) {\r\n\t\t\t$bağlı_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\t\t\t$bağlı_kullanicilar = $this->db->query($bağlı_kullanicilarQ)->result();\r\n\t\t\t\r\n\t\t\tforeach ($bağlı_kullanicilar as $user) {\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\t\t\t}\r\n\t\t}\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\t\t\r\n\t\t// Cari kaydını getir\r\n\t\tif ($is_admin) {\r\n\t\t\t// Admin gruplar için hiçbir kısıtlama yok\r\n\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, evrak_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true\";\r\n\t\t} else {\r\n\t\t\t// Dashboard mantığı: Kendisi + bağlı kullanıcılar (anaHesap kısıtlaması kaldırıldı)\r\n\t\t\t$cariQ = \"SELECT cari_ad, cari_soyad, evrak_dosya FROM cari WHERE cari_id = '$cari_id' AND cari_durum = true AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\t\t}\r\n\t\t\r\n\t\t$cari = $this->db->query($cariQ)->row();\r\n\t\t\r\n\t\tif (!$cari) {\r\n\t\t\tshow_error('Cari kaydı bulunamadı!');\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t$data['cari'] = $cari;\r\n\t\t$data['cari_id'] = $cari_id;\r\n\t\t$data['is_admin'] = $is_admin;\r\n\t\t\r\n\t\t$this->load->view('cari/evrak-goster', $data);\r\n\t}\r\n\t\r\n\t/**\r\n\t * Mobile-friendly method to get districts based on city ID\r\n\t * Used for AJAX calls from customer creation form\r\n\t */\r\n\tpublic function getIlceler()\r\n\t{\r\n\t\t// Get city ID from POST request\r\n\t\t$il_id = $this->input->post('il_id');\r\n\t\t\r\n\t\t// Debug logging for mobile issues\r\n\t\t$debug_log_file = FCPATH . 'debug_cari_listesi.log';\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\t\t$user_agent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : 'Unknown';\r\n\t\t$is_mobile = preg_match('/(android|iphone|ipad|mobile)/i', $user_agent);\r\n\t\t\r\n\t\t$debug_info = array(\r\n\t\t\t'timestamp' => $timestamp,\r\n\t\t\t'method' => 'getIlceler',\r\n\t\t\t'il_id' => $il_id,\r\n\t\t\t'is_mobile' => $is_mobile,\r\n\t\t\t'user_agent' => $user_agent\r\n\t\t);\r\n\t\t\r\n\t\t$log_entry = $timestamp . \" [ILCE_REQUEST] \" . json_encode($debug_info) . \"\\n\";\r\n\t\tfile_put_contents($debug_log_file, $log_entry, FILE_APPEND | LOCK_EX);\r\n\t\t\r\n\t\tif (empty($il_id)) {\r\n\t\t\t$data = array('status' => 'error', 'message' => 'İl ID Bilgisi Alınamadı..!');\r\n\t\t} else {\r\n\t\t\t// Get districts for the given city ID\r\n\t\t\t$ilceler = $this->db->get_where('ilceler', array('il_id' => $il_id));\r\n\t\t\t\r\n\t\t\tif ($ilceler->num_rows() > 0) {\r\n\t\t\t\t$ilceList = array();\r\n\t\t\t\tforeach ($ilceler->result() as $item) {\r\n\t\t\t\t\t$ilceList[] = array('id' => $item->id, 'ilce' => $item->ilce);\r\n\t\t\t\t}\r\n\t\t\t\t$data = array('status' => 'ok', 'message' => '', 'data' => $ilceList);\r\n\t\t\t} else {\r\n\t\t\t\t$data = array('status' => 'error', 'message' => 'İlçe Bulunamadı..!');\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Return JSON response\r\n\t\t$this->output->set_content_type('application/json')->set_output(json_encode($data));\r\n\t}\r\n}"
        }
    ]
}