{
    "sourceFile": "application/controllers/Talepler.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1755240556362,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1755240556362,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Talepler extends CI_Controller {    public function __construct()\r\n\r\n    {\r\n\r\n        parent::__construct();\r\n\r\n        error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n        $this->load->model('Vt', 'vt');\r\n\r\n        $this->load->database();\r\n\r\n        $this->load->library('session');\r\n\r\n        $this->load->library('form_validation');\r\n\r\n        $this->load->helper(['date', 'url', 'form']);\r\n\r\n\r\n\r\n        // Session kontrolü\r\n\r\n        $control = session(\"r\", \"login\");\r\n\r\n        if (!$control) {\r\n\r\n            redirect(\"check\");\r\n\r\n        }\r\n\r\n    }/**\r\n\r\n     * Ana menü - Talepler listesi\r\n\r\n     */\r\n\r\n    public function index()\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1800)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = \"Talepler Listesi\";\r\n\r\n        \r\n\r\n        // Kullanıcı bilgilerini al\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        $u_id = $control2->kullanici_id;\r\n        $grup_id = $control2->grup_id; // Kullanıcının grup ID'sini al\r\n\r\n        $bugun = date('Y-m-d');\r\n\r\n        \r\n        // Grup ID = 1 ise tüm talepler görülebilir, değilse sadece kullanıcının kendi talepler\r\n        $isAdminGroup = ($grup_id == 1);\r\n\r\n        // Kullanıcının sorumlu olduğu il ve ilçeleri çek (sadece admin grubu değilse)\r\n\r\n        $sorumluIlIds = array();\r\n\r\n        $sorumluIlceIds = array();\r\n\r\n        \r\n\r\n        if ($u_id && !$isAdminGroup) {\r\n\r\n            // İl sorumluluklarını çek (ilce_id = 0 olanlar tüm il için sorumluluk)\r\n\r\n            $sorumluIllerQ = \"SELECT DISTINCT il_id \r\n\r\n                             FROM kullanici_sorumluluk_bolgesi \r\n\r\n                             WHERE kullanici = '$u_id' \r\n\r\n                             AND durum = 1 \r\n\r\n                             AND il_id IS NOT NULL\r\n\r\n                             AND il_id > 0\r\n\r\n                             AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                             AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n            $sorumluIller = $this->db->query($sorumluIllerQ)->result();\r\n\r\n            \r\n\r\n            foreach ($sorumluIller as $il) {\r\n\r\n                $sorumluIlIds[] = $il->il_id;\r\n\r\n            }\r\n\r\n            \r\n\r\n            // İlçe sorumluluklarını çek (ilce_id > 0 olanlar)\r\n\r\n            $sorumluIlcelerQ = \"SELECT DISTINCT ilce_id \r\n\r\n                               FROM kullanici_sorumluluk_bolgesi \r\n\r\n                               WHERE kullanici = '$u_id' \r\n\r\n                               AND durum = 1 \r\n\r\n                               AND ilce_id IS NOT NULL\r\n\r\n                               AND ilce_id > 0\r\n\r\n                               AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                               AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n            $sorumluIlceler = $this->db->query($sorumluIlcelerQ)->result();\r\n\r\n            \r\n\r\n            foreach ($sorumluIlceler as $ilce) {\r\n\r\n                $sorumluIlceIds[] = $ilce->ilce_id;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Potansiyel cari listesini getir (sadece talep olanlar) ve en son durum bilgisi\r\n\r\n        $this->db->select('pc.*, s.sektor_adi, u.ulke_adi, il.il as il_adi, ilce.ilce as ilce_adi, CONCAT(k.kullanici_ad, \" \", k.kullanici_soyad) as kullanici_adsoyad, \r\n\r\n                          pd.Durum_Adi as son_durum_adi,\r\n\r\n                          (SELECT ps.durum_id FROM potansiyel_satis ps WHERE ps.potansiyel_cari_id = pc.id ORDER BY ps.id DESC LIMIT 1) as son_durum_id');\r\n\r\n        $this->db->from('potansiyel_cari pc');\r\n\r\n        $this->db->join('sektorler s', 'pc.sektor_id = s.sektor_id', 'left');\r\n\r\n        $this->db->join('ulkeler u', 'pc.potansiyel_ulke_id = u.id', 'left');\r\n\r\n        $this->db->join('iller il', 'pc.potansiyel_il_id = il.id', 'left');\r\n\r\n        $this->db->join('ilceler ilce', 'pc.potansiyel_ilce_id = ilce.id', 'left');\r\n\r\n        $this->db->join('kullanicilar k', 'pc.olusturan_kullanici = k.kullanici_id', 'left');\r\n\r\n        $this->db->join('potansiyel_durumlar pd', 'pd.id = (SELECT ps.durum_id FROM potansiyel_satis ps WHERE ps.potansiyel_cari_id = pc.id ORDER BY ps.id DESC LIMIT 1)', 'left');\r\n\r\n        $this->db->where('pc.potansitel_talep', 1); // Sadece talep olanları getir\r\n\r\n        \r\n\r\n        // Grup ID = 1 ise tüm talepler görülebilir, değilse sorumluluk bölgesi filtresi uygula\r\n        if (!$isAdminGroup) {\r\n            // Admin grubu değilse, sorumluluk bölgesi filtrelemesi (sadece il ve ilçe)\r\n            if (!empty($sorumluIlIds) || !empty($sorumluIlceIds)) {\r\n                $this->db->group_start();\r\n                \r\n                // İl bazlı sorumluluk\r\n                if (!empty($sorumluIlIds)) {\r\n                    $this->db->or_where_in('pc.potansiyel_il_id', $sorumluIlIds);\r\n                }\r\n                \r\n                // İlçe bazlı sorumluluk\r\n                if (!empty($sorumluIlceIds)) {\r\n                    $this->db->or_where_in('pc.potansiyel_ilce_id', $sorumluIlceIds);\r\n                }\r\n                \r\n                $this->db->group_end();\r\n            } else {\r\n                // Sorumluluk bölgesi yoksa sadece kendi oluşturduğu talepleri göster\r\n                $this->db->where('pc.olusturan_kullanici', $u_id);\r\n            }\r\n        }\r\n        // Admin grubu (grup_id = 1) ise hiçbir filtre uygulanmaz, tüm talepler görülür\r\n\r\n        \r\n\r\n        $this->db->order_by('pc.id', 'DESC');\r\n\r\n        $talepler = $this->db->get()->result();\r\n\r\n        \r\n\r\n        // Telefon numaralarını formatla\r\n\r\n        foreach ($talepler as &$talep) {\r\n\r\n            if (!empty($talep->potansiyel_cari_firmaTelefon)) {\r\n\r\n                $talep->potansiyel_cari_firmaTelefon = $this->format_phone_number($talep->potansiyel_cari_firmaTelefon);\r\n\r\n            }\r\n\r\n        }\r\n\r\n        \r\n\r\n        $data[\"talepler\"] = $talepler;\r\n\r\n        \r\n\r\n        // Potansiyel durumları getir (modal için)\r\n\r\n        $this->db->select('*');\r\n\r\n        $this->db->from('potansiyel_durumlar');\r\n\r\n        $this->db->order_by('Durum_Adi', 'ASC');\r\n\r\n        $data[\"potansiyelDurumlar\"] = $this->db->get()->result();\r\n\r\n        \r\n\r\n        $this->load->view(\"talepler/talep-listesi\", $data);\r\n\r\n    }    /**\r\n\r\n     * Talep oluştur sayfası\r\n\r\n     */\r\n\r\n    public function talep_olustur()\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1810)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = \"Talep Oluştur\";\r\n\r\n        \r\n\r\n        // Kullanıcı bilgilerini al\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        $data[\"kullanici\"] = $control2;\r\n\r\n        \r\n\r\n        // Talep kaynakları\r\n\r\n        $data[\"talep_kaynaklari\"] = $this->vt->multiple('talep_kaynaklari', [], 'talep_kaynaklari_adi ASC');\r\n\r\n        \r\n\r\n        // Talep durumları (aktif olanlar)\r\n\r\n        $data[\"talep_durumlari\"] = $this->vt->multiple('talep_durumlari', ['talep_durumlari_durum' => 1], 'talep_durumlari_adi ASC');\r\n\r\n        \r\n\r\n        // Sektörler (varsa)\r\n\r\n        $data[\"sektorler\"] = $this->vt->multiple('sektorler', [], 'sektor_adi ASC');        // Ülkeler\r\n\r\n        $data[\"ulkeler\"] = $this->vt->multiple('ulkeler', [], 'ulke_adi ASC');\r\n\r\n        // İller - Türkiye illeri (ulke_id = 3)\r\n\r\n        $data[\"iller\"] = $this->vt->multiple('iller', ['ulke_id' => 3], 'il ASC');\r\n\r\n\r\n\r\n        $this->load->view(\"talepler/talep-olustur\", $data);\r\n\r\n    }    /**\r\n\r\n     * Talep kaydet/güncelle (POST)\r\n\r\n     */\r\n\r\n    public function talep_kaydet()\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1810)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        $u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n        date_default_timezone_set('Europe/Istanbul');\r\n\r\n        $tarih = date('Y-m-d H:i:s');\r\n\r\n\r\n\r\n        // Güncelleme mi yoksa yeni kayıt mı?\r\n\r\n        $talep_id = $this->input->post('talep_id');\r\n\r\n        $is_update = !empty($talep_id);\r\n\r\n\r\n\r\n        // Randevu tarih ve saati birleştir (sadece talep_cari için gerekli)\r\n\r\n        $randevu_tarihi = $this->input->post('talep_cari_randevu_tarih');\r\n\r\n        $randevu_saati = $this->input->post('talep_cari_randevu_saat');\r\n\r\n        $randevu = null;\r\n\r\n        if ($randevu_tarihi && $randevu_saati) {\r\n\r\n            $randevu = $randevu_tarihi . ' ' . $randevu_saati;\r\n\r\n        }\r\n\r\n\r\n\r\n        if ($is_update) {\r\n\r\n            // Güncelleme işlemi - potansiyel_cari tablosunu güncelle\r\n\r\n            $telefon = $this->format_phone_number($this->input->post('talep_cari_telefon'));\r\n\r\n            \r\n\r\n            $data_potansiyel = array(\r\n\r\n                'potansiyel_cari_ad' => $this->input->post('talep_cari_adsoyad') . \r\n\r\n                                        ($this->input->post('talep_cari_firma') ? ' - ' . $this->input->post('talep_cari_firma') : ''),\r\n\r\n                'potansiyel_cari_firmaTelefon' => $telefon,\r\n\r\n                'sektor_id' => $this->input->post('talep_cari_sektor_id') ?: null,\r\n\r\n                'potansiyel_ulke_id' => $this->input->post('talep_cari_ulke_id') ?: null,\r\n\r\n                'potansiyel_il_id' => $this->input->post('talep_cari_il_id') ?: null,\r\n\r\n                'potansiyel_ilce_id' => $this->input->post('talep_cari_ilce_id') ?: null,\r\n\r\n                'potansiyel_mahalle' => $this->input->post('talep_cari_mahalle'),\r\n\r\n                'potansiyel_cari_adres' => $this->input->post('talep_cari_adres')\r\n\r\n            );\r\n\r\n            \r\n\r\n            // Önce kayıt var mı kontrol et\r\n\r\n            $existing = $this->db->where('id', $talep_id)->get('potansiyel_cari')->row();\r\n\r\n            if (!$existing) {\r\n\r\n                $this->session->set_flashdata('talep_hata', 'Güncellenecek kayıt bulunamadı.');\r\n\r\n                redirect('talepler/talepler-listesi');\r\n\r\n                return;\r\n\r\n            }\r\n\r\n            \r\n\r\n            // CodeIgniter'ın built-in update metodunu kullan\r\n\r\n            $this->db->where('id', $talep_id);\r\n\r\n            $result = $this->db->update('potansiyel_cari', $data_potansiyel);\r\n\r\n            \r\n\r\n            // Veritabanı hatası var mı kontrol et\r\n\r\n            $db_error = $this->db->error();\r\n\r\n            if ($db_error['code'] != 0) {\r\n\r\n                $this->session->set_flashdata('talep_hata', 'Veritabanı hatası: ' . $db_error['message']);\r\n\r\n                redirect('talepler/talep-detay/' . $talep_id);\r\n\r\n                return;\r\n\r\n            }\r\n\r\n            \r\n\r\n            // Kaç satır etkilendi kontrol et\r\n\r\n            $affected_rows = $this->db->affected_rows();\r\n\r\n            \r\n\r\n            if ($result && $affected_rows > 0) {\r\n\r\n                $this->session->set_flashdata('talep_basarili', 'Potansiyel müşteri başarıyla güncellendi.');\r\n\r\n                logekle(1810, 3); // Talep güncelle için log\r\n\r\n            } else {\r\n\r\n                $this->session->set_flashdata('talep_hata', 'Hiçbir değişiklik yapılmadı veya güncellenemedi.');\r\n\r\n            }\r\n\r\n            \r\n\r\n            redirect('talepler/talep-detay/' . $talep_id);\r\n\r\n        } else {\r\n\r\n            // Yeni kayıt işlemi - potansiyel_cari tablosuna ekle\r\n\r\n            $telefon = $this->format_phone_number($this->input->post('talep_cari_telefon'));\r\n\r\n            \r\n\r\n            $data_potansiyel = array(\r\n\r\n                'sezon_id' => 5, // Default sezon\r\n\r\n                'potansiyel_cari_ad' => $this->input->post('talep_cari_adsoyad') . \r\n\r\n                                        ($this->input->post('talep_cari_firma') ? ' - ' . $this->input->post('talep_cari_firma') : ''),\r\n\r\n                'potansiyel_cari_firmaTelefon' => $telefon,\r\n\r\n                'sektor_id' => $this->input->post('talep_cari_sektor_id') ?: null,\r\n\r\n                'potansiyel_ulke_id' => $this->input->post('talep_cari_ulke_id') ?: null,\r\n\r\n                'potansiyel_il_id' => $this->input->post('talep_cari_il_id') ?: null,\r\n\r\n                'potansiyel_ilce_id' => $this->input->post('talep_cari_ilce_id') ?: null,\r\n\r\n                'potansiyel_mahalle' => $this->input->post('talep_cari_mahalle'),\r\n\r\n                'potansiyel_cari_adres' => $this->input->post('talep_cari_adres'),\r\n\r\n                'potansitel_talep' => 1,\r\n\r\n                'olusturan_kullanici' => $u_id,\r\n\r\n                'olusturma_zamani' => $tarih\r\n\r\n            );\r\n\r\n            \r\n\r\n            $result = $this->vt->insert('potansiyel_cari', $data_potansiyel);\r\n\r\n            \r\n\r\n            if ($result) {\r\n\r\n                // Yeni eklenen kaydın ID'sini al\r\n\r\n                $yeni_talep_id = $this->db->insert_id();\r\n\r\n                \r\n\r\n                // Admin'e bildirim gönder\r\n\r\n                $this->_send_new_talep_notification($yeni_talep_id, $data_potansiyel);\r\n\r\n                \r\n\r\n                $this->session->set_flashdata('talep_basarili', 'Potansiyel müşteri başarıyla oluşturuldu.');\r\n\r\n                logekle(1810, 2); // Talep oluştur modülü için log\r\n\r\n            } else {\r\n\r\n                $this->session->set_flashdata('talep_hata', 'Potansiyel müşteri oluşturulurken bir hata oluştu.');\r\n\r\n            }\r\n\r\n\r\n\r\n            redirect('talepler/talepler-listesi');\r\n\r\n        }\r\n\r\n    }    /**\r\n\r\n     * Talep detayı görüntüle\r\n\r\n     */\r\n\r\n    public function talep_detay($id)\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1800)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = \"Talep Detayı\";\r\n\r\n        \r\n\r\n        // Kullanıcı bilgilerini al\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        $u_id = $control2->kullanici_id;\r\n\r\n        $bugun = date('Y-m-d');\r\n\r\n\r\n\r\n        // Potansiyel cari bilgilerini getir (JOIN ile ilişkili veriler)\r\n\r\n        $this->db->select('pc.*, s.sektor_adi, u.ulke_adi, il.il as il_adi, ilce.ilce as ilce_adi, CONCAT(k.kullanici_ad, \" \", k.kullanici_soyad) as kullanici_adsoyad');\r\n\r\n        $this->db->from('potansiyel_cari pc');\r\n\r\n        $this->db->join('kullanicilar k', 'pc.olusturan_kullanici = k.kullanici_id', 'left');\r\n\r\n        $this->db->join('sektorler s', 'pc.sektor_id = s.sektor_id', 'left');\r\n\r\n        $this->db->join('ulkeler u', 'pc.potansiyel_ulke_id = u.id', 'left');\r\n\r\n        $this->db->join('iller il', 'pc.potansiyel_il_id = il.id', 'left');\r\n\r\n        $this->db->join('ilceler ilce', 'pc.potansiyel_ilce_id = ilce.id', 'left');\r\n\r\n        $this->db->where('pc.id', $id);\r\n\r\n        $this->db->where('pc.potansitel_talep', 1); // Sadece talep olanları\r\n\r\n        $query = $this->db->get();\r\n\r\n        $data[\"talep\"] = $query->row();\r\n\r\n        \r\n\r\n        if (!$data[\"talep\"]) {\r\n\r\n            $this->session->set_flashdata('hata', 'Potansiyel müşteri bulunamadı.');\r\n\r\n            redirect('talepler/talepler-listesi');\r\n\r\n            return;\r\n\r\n        }\r\n\r\n\r\n\r\n        // Kullanıcının bu bölgede yetkili olup olmadığını kontrol et\r\n\r\n        $yetkiVarMi = false;\r\n\r\n        \r\n\r\n        // İl bazlı yetki kontrolü\r\n\r\n        if ($data[\"talep\"]->potansiyel_il_id) {\r\n\r\n            $ilYetkiQ = \"SELECT COUNT(*) as sayac \r\n\r\n                        FROM kullanici_sorumluluk_bolgesi \r\n\r\n                        WHERE kullanici = '$u_id' \r\n\r\n                        AND durum = 1 \r\n\r\n                        AND il_id = '{$data[\"talep\"]->potansiyel_il_id}'\r\n\r\n                        AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                        AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n            $ilYetki = $this->db->query($ilYetkiQ)->row();\r\n\r\n            if ($ilYetki->sayac > 0) {\r\n\r\n                $yetkiVarMi = true;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        \r\n\r\n        // İlçe bazlı yetki kontrolü\r\n\r\n        if (!$yetkiVarMi && $data[\"talep\"]->potansiyel_ilce_id) {\r\n\r\n            $ilceYetkiQ = \"SELECT COUNT(*) as sayac \r\n\r\n                          FROM kullanici_sorumluluk_bolgesi \r\n\r\n                          WHERE kullanici = '$u_id' \r\n\r\n                          AND durum = 1 \r\n\r\n                          AND ilce_id = '{$data[\"talep\"]->potansiyel_ilce_id}'\r\n\r\n                          AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                          AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n            $ilceYetki = $this->db->query($ilceYetkiQ)->row();\r\n\r\n            if ($ilceYetki->sayac > 0) {\r\n\r\n                $yetkiVarMi = true;\r\n\r\n            }\r\n\r\n        }\r\n\r\n\r\n\r\n        if (!$yetkiVarMi) {\r\n\r\n            $this->session->set_flashdata('hata', 'Bu bölgedeki talebe erişim yetkiniz bulunmamaktadır.');\r\n\r\n            redirect('talepler/talepler-listesi');\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Telefon numarasını formatla\r\n\r\n        if (!empty($data[\"talep\"]->potansiyel_cari_firmaTelefon)) {\r\n\r\n            $data[\"talep\"]->potansiyel_cari_firmaTelefon = $this->format_phone_number($data[\"talep\"]->potansiyel_cari_firmaTelefon);\r\n\r\n        }\r\n\r\n\r\n\r\n        $this->load->view(\"talepler/talep-detay\", $data);\r\n\r\n    }    /**\r\n\r\n     * İlçeleri AJAX ile getir\r\n\r\n     */\r\n\r\n    public function get_ilceler($il_id = null)\r\n\r\n    {\r\n\r\n        // Header'ları ayarla\r\n\r\n        header('Content-Type: application/json; charset=utf-8');\r\n\r\n        header('Access-Control-Allow-Origin: *');\r\n\r\n        header('Access-Control-Allow-Methods: GET, POST');\r\n\r\n        header('Access-Control-Allow-Headers: Content-Type');\r\n\r\n        \r\n\r\n        // GET parametresi veya POST ile gelen il_id\r\n\r\n        if ($il_id === null) {\r\n\r\n            $il_id = $this->input->post('il_id');\r\n\r\n        }\r\n\r\n        \r\n\r\n        // GET parametresinden de alabilir\r\n\r\n        if ($il_id === null) {\r\n\r\n            $il_id = $this->input->get('il_id');\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Debug için log ekleyelim\r\n\r\n        error_log(\"get_ilceler called with il_id: \" . $il_id);\r\n\r\n        error_log(\"REQUEST METHOD: \" . $_SERVER['REQUEST_METHOD']);\r\n\r\n        error_log(\"REQUEST URI: \" . $_SERVER['REQUEST_URI']);\r\n\r\n        \r\n\r\n        if (empty($il_id)) {\r\n\r\n            $data = array('status' => 'error', 'message' => 'İl ID Bilgisi Alınamadı..!');\r\n\r\n        } else {\r\n\r\n            // Database sorgusu ile ilçeleri getir\r\n\r\n            $this->db->where('il_id', $il_id);\r\n\r\n            $this->db->order_by('ilce', 'ASC');\r\n\r\n            $ilceler = $this->db->get('ilceler');\r\n\r\n            \r\n\r\n            error_log(\"Found \" . $ilceler->num_rows() . \" ilceler for il_id: \" . $il_id);\r\n\r\n            \r\n\r\n            if ($ilceler->num_rows() > 0) {\r\n\r\n                $ilceList = array();\r\n\r\n                foreach ($ilceler->result() as $item) {\r\n\r\n                    $ilceList[] = array(\r\n\r\n                        'id' => $item->id, \r\n\r\n                        'ilce_adi' => $item->ilce, \r\n\r\n                        'ilce' => $item->ilce,\r\n\r\n                        'il_id' => $item->il_id\r\n\r\n                    );\r\n\r\n                }\r\n\r\n                $data = array('status' => 'ok', 'message' => '', 'data' => $ilceList);\r\n\r\n            } else {\r\n\r\n                $data = array('status' => 'error', 'message' => 'İlçe Bulunamadı..!');\r\n\r\n            }\r\n\r\n        }\r\n\r\n        \r\n\r\n        error_log(\"Returning result: \" . json_encode($data, JSON_UNESCAPED_UNICODE));\r\n\r\n        \r\n\r\n        // JSON response gönder\r\n\r\n        echo json_encode($data, JSON_UNESCAPED_UNICODE);\r\n\r\n        exit;\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * İlleri AJAX ile getir (ülke bazında)\r\n\r\n     */\r\n\r\n    public function get_iller($ulke_id = null)\r\n\r\n    {\r\n\r\n        // Header'ları ayarla\r\n\r\n        header('Content-Type: application/json; charset=utf-8');\r\n\r\n        header('Access-Control-Allow-Origin: *');\r\n\r\n        header('Access-Control-Allow-Methods: GET, POST');\r\n\r\n        header('Access-Control-Allow-Headers: Content-Type');\r\n\r\n        \r\n\r\n        // GET parametresi veya POST ile gelen ulke_id\r\n\r\n        if ($ulke_id === null) {\r\n\r\n            $ulke_id = $this->input->post('ulke_id');\r\n\r\n        }\r\n\r\n        \r\n\r\n        // GET parametresinden de alabilir\r\n\r\n        if ($ulke_id === null) {\r\n\r\n            $ulke_id = $this->input->get('ulke_id');\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Debug için log ekleyelim\r\n\r\n        error_log(\"get_iller called with ulke_id: \" . $ulke_id);\r\n\r\n        error_log(\"REQUEST METHOD: \" . $_SERVER['REQUEST_METHOD']);\r\n\r\n        error_log(\"REQUEST URI: \" . $_SERVER['REQUEST_URI']);\r\n\r\n        \r\n\r\n        if (empty($ulke_id)) {\r\n\r\n            $data = array('status' => 'error', 'message' => 'Ülke ID Bilgisi Alınamadı..!');\r\n\r\n        } else {\r\n\r\n            // Database sorgusu ile illeri getir\r\n\r\n            $this->db->where('ulke_id', $ulke_id);\r\n\r\n            $this->db->order_by('il', 'ASC');\r\n\r\n            $iller = $this->db->get('iller');\r\n\r\n            \r\n\r\n            error_log(\"Found \" . $iller->num_rows() . \" iller for ulke_id: \" . $ulke_id);\r\n\r\n            \r\n\r\n            if ($iller->num_rows() > 0) {\r\n\r\n                $ilList = array();\r\n\r\n                foreach ($iller->result() as $item) {\r\n\r\n                    $ilList[] = array(\r\n\r\n                        'id' => $item->id, \r\n\r\n                        'il_adi' => $item->il, \r\n\r\n                        'il' => $item->il,\r\n\r\n                        'ulke_id' => $item->ulke_id\r\n\r\n                    );\r\n\r\n                }\r\n\r\n                $data = array('status' => 'ok', 'message' => '', 'data' => $ilList);\r\n\r\n            } else {\r\n\r\n                $data = array('status' => 'error', 'message' => 'İl Bulunamadı..!');\r\n\r\n            }\r\n\r\n        }\r\n\r\n        \r\n\r\n        error_log(\"Returning result: \" . json_encode($data, JSON_UNESCAPED_UNICODE));\r\n\r\n        \r\n\r\n        // JSON response gönder\r\n\r\n        echo json_encode($data, JSON_UNESCAPED_UNICODE);\r\n\r\n        exit;\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Talep durumu güncelle\r\n\r\n     */\r\n\r\n    public function durum_guncelle()\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1800)) {\r\n\r\n            echo json_encode(['success' => false, 'message' => 'Yetkiniz yok']);\r\n\r\n            return;\r\n\r\n        }\r\n\r\n\r\n\r\n        $talep_id = $this->input->post('talep_id');\r\n\r\n        $yeni_durum = $this->input->post('yeni_durum');\r\n\r\n\r\n\r\n        // Potansiyel_satis tablosuna yeni durum kaydı ekle\r\n\r\n        $satis_data = [\r\n\r\n            'potansiyel_cari_id' => $talep_id,\r\n\r\n            'durum_id' => $yeni_durum,\r\n\r\n            'tarih' => date('Y-m-d H:i:s'),\r\n\r\n            'olusturan_kullanici' => $this->session->userdata('kullanici_id')\r\n\r\n        ];\r\n\r\n        $result = $this->vt->insert('potansiyel_satis', $satis_data);\r\n\r\n        \r\n\r\n        if ($result) {\r\n\r\n            logekle(1800, 3); // Talepler modülü güncelleme log\r\n\r\n            echo json_encode(['success' => true, 'message' => 'Durum başarıyla güncellendi']);\r\n\r\n        } else {\r\n\r\n            echo json_encode(['success' => false, 'message' => 'Güncelleme başarısız']);\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Debug - iller tablosunun sütunlarını göster\r\n\r\n     */\r\n\r\n    public function debug_iller() \r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1800)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n        \r\n\r\n        $fields = $this->db->list_fields('iller');\r\n\r\n        echo \"<h3>İller Tablosu Sütunları:</h3>\";\r\n\r\n        echo \"<ul>\";\r\n\r\n        foreach ($fields as $field) {\r\n\r\n            echo \"<li>\" . $field . \"</li>\";\r\n\r\n        }\r\n\r\n        echo \"</ul>\";\r\n\r\n        \r\n\r\n        // Birkaç örnek kayıt göster\r\n\r\n        $sample = $this->db->limit(5)->get('iller')->result();\r\n\r\n        echo \"<h3>Örnek Kayıtlar:</h3>\";\r\n\r\n        echo \"<pre>\";\r\n\r\n        print_r($sample);\r\n\r\n        echo \"</pre>\";\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Debug - İlçeler tablosunu kontrol et\r\n\r\n     */\r\n\r\n    public function debug_ilceler($il_id = 1)\r\n\r\n    {\r\n\r\n        echo \"<h3>İlçeler Debug - İl ID: $il_id</h3>\";\r\n\r\n        \r\n\r\n        // Tablo var mı kontrol et\r\n\r\n        if ($this->db->table_exists('ilceler')) {\r\n\r\n            echo \"<p style='color:green'>✓ İlceler tablosu mevcut</p>\";\r\n\r\n        } else {\r\n\r\n            echo \"<p style='color:red'>✗ İlceler tablosu yok</p>\";\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Tablo yapısını göster\r\n\r\n        $fields = $this->db->list_fields('ilceler');\r\n\r\n        echo \"<p><strong>Tablo alanları:</strong> \" . implode(', ', $fields) . \"</p>\";\r\n\r\n        \r\n\r\n        // İl ID'ye göre ilçeleri getir\r\n\r\n        $this->db->where('il_id', $il_id);\r\n\r\n        $this->db->order_by('ilce', 'ASC');\r\n\r\n        $ilceler = $this->db->get('ilceler')->result();\r\n\r\n        \r\n\r\n        echo \"<p><strong>İl ID $il_id için bulunan ilçe sayısı:</strong> \" . count($ilceler) . \"</p>\";\r\n\r\n        \r\n\r\n        if (count($ilceler) > 0) {\r\n\r\n            echo \"<h4>İlçeler:</h4><ul>\";\r\n\r\n            foreach ($ilceler as $ilce) {\r\n\r\n                echo \"<li>ID: {$ilce->id}, İlçe: {$ilce->ilce}, İl ID: {$ilce->il_id}</li>\";\r\n\r\n            }\r\n\r\n            echo \"</ul>\";\r\n\r\n            \r\n\r\n            // JSON formatında da göster\r\n\r\n            $result = [];\r\n\r\n            foreach ($ilceler as $ilce) {\r\n\r\n                $result[] = [\r\n\r\n                    'id' => $ilce->id,\r\n\r\n                    'ilce_adi' => $ilce->ilce,\r\n\r\n                    'il_id' => $ilce->il_id\r\n\r\n                ];\r\n\r\n            }\r\n\r\n            echo \"<h4>JSON Response:</h4>\";\r\n\r\n            echo \"<pre>\" . json_encode($result, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . \"</pre>\";\r\n\r\n        } else {\r\n\r\n            echo \"<p style='color:orange'>Bu ile ait ilçe bulunamadı</p>\";\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Örnek iller tablosundan 5 kayıt göster\r\n\r\n        echo \"<h4>Örnek İller:</h4>\";\r\n\r\n        $sample = $this->db->limit(5)->get('iller')->result();\r\n\r\n        foreach ($sample as $il) {\r\n\r\n            echo \"<p>İl ID: {$il->id}, İl: {$il->il}</p>\";\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Debug - Kullanıcının sorumluluk bölgelerini test et\r\n\r\n     */\r\n\r\n    public function debug_sorumluluk($user_id = null)\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1800)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n        \r\n\r\n        if (!$user_id) {\r\n\r\n            $control2 = session(\"r\", \"login_info\");\r\n\r\n            $user_id = $control2->kullanici_id;\r\n\r\n        }\r\n\r\n        \r\n\r\n        $bugun = date('Y-m-d');\r\n\r\n        \r\n\r\n        echo \"<h3>Kullanıcı ID: $user_id için Sorumluluk Bölgesi Debug</h3>\";\r\n\r\n        echo \"<p><strong>Bugünün tarihi:</strong> $bugun</p>\";\r\n\r\n        \r\n\r\n        // Ham sorumluluk verilerini göster\r\n\r\n        $hamVeriQ = \"SELECT * FROM kullanici_sorumluluk_bolgesi WHERE kullanici = '$user_id'\";\r\n\r\n        $hamVeri = $this->db->query($hamVeriQ)->result();\r\n\r\n        \r\n\r\n        echo \"<h4>Ham Sorumluluk Verileri:</h4>\";\r\n\r\n        echo \"<table border='1' style='border-collapse: collapse;'>\";\r\n\r\n        echo \"<tr><th>ID</th><th>Ülke</th><th>İl ID</th><th>İlçe ID</th><th>Durum</th><th>Başlangıç</th><th>Bitiş</th></tr>\";\r\n\r\n        foreach ($hamVeri as $veri) {\r\n\r\n            echo \"<tr>\";\r\n\r\n            echo \"<td>{$veri->sorumluluk_id}</td>\";\r\n\r\n            echo \"<td>{$veri->ulke_kodu}</td>\";\r\n\r\n            echo \"<td>{$veri->il_id}</td>\";\r\n\r\n            echo \"<td>{$veri->ilce_id}</td>\";\r\n\r\n            echo \"<td>{$veri->durum}</td>\";\r\n\r\n            echo \"<td>{$veri->baslangic_tarihi}</td>\";\r\n\r\n            echo \"<td>{$veri->bitis_tarihi}</td>\";\r\n\r\n            echo \"</tr>\";\r\n\r\n        }\r\n\r\n        echo \"</table>\";\r\n\r\n        \r\n\r\n        // Aktif il sorumluluklarını çek\r\n\r\n        $sorumluIllerQ = \"SELECT DISTINCT il_id \r\n\r\n                         FROM kullanici_sorumluluk_bolgesi \r\n\r\n                         WHERE kullanici = '$user_id' \r\n\r\n                         AND durum = 1 \r\n\r\n                         AND il_id IS NOT NULL\r\n\r\n                         AND il_id > 0\r\n\r\n                         AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                         AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n        $sorumluIller = $this->db->query($sorumluIllerQ)->result();\r\n\r\n        \r\n\r\n        echo \"<h4>Aktif İl Sorumlulukları:</h4>\";\r\n\r\n        $ilIds = [];\r\n\r\n        foreach ($sorumluIller as $il) {\r\n\r\n            $ilIds[] = $il->il_id;\r\n\r\n        }\r\n\r\n        echo \"<p><strong>İl ID'leri:</strong> \" . implode(', ', $ilIds) . \"</p>\";\r\n\r\n        \r\n\r\n        // İl isimlerini getir\r\n\r\n        if (!empty($ilIds)) {\r\n\r\n            $this->db->where_in('id', $ilIds);\r\n\r\n            $iller = $this->db->get('iller')->result();\r\n\r\n            echo \"<ul>\";\r\n\r\n            foreach ($iller as $il) {\r\n\r\n                echo \"<li>ID: {$il->id}, İl: {$il->il}</li>\";\r\n\r\n            }\r\n\r\n            echo \"</ul>\";\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Aktif ilçe sorumluluklarını çek\r\n\r\n        $sorumluIlcelerQ = \"SELECT DISTINCT ilce_id \r\n\r\n                           FROM kullanici_sorumluluk_bolgesi \r\n\r\n                           WHERE kullanici = '$user_id' \r\n\r\n                           AND durum = 1 \r\n\r\n                           AND ilce_id IS NOT NULL\r\n\r\n                           AND ilce_id > 0\r\n\r\n                           AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                           AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n        $sorumluIlceler = $this->db->query($sorumluIlcelerQ)->result();\r\n\r\n        \r\n\r\n        echo \"<h4>Aktif İlçe Sorumlulukları:</h4>\";\r\n\r\n        $ilceIds = [];\r\n\r\n        foreach ($sorumluIlceler as $ilce) {\r\n\r\n            $ilceIds[] = $ilce->ilce_id;\r\n\r\n        }\r\n\r\n        echo \"<p><strong>İlçe ID'leri:</strong> \" . implode(', ', $ilceIds) . \"</p>\";\r\n\r\n        \r\n\r\n        // Test sorgusu - bu kullanıcının görebileceği talep sayısı\r\n\r\n        echo \"<h4>Test Filtreleme:</h4>\";\r\n\r\n        if (!empty($ilIds) || !empty($ilceIds)) {\r\n\r\n            $this->db->select('COUNT(*) as toplam');\r\n\r\n            $this->db->from('potansiyel_cari pc');\r\n\r\n            $this->db->where('pc.potansitel_talep', 1);\r\n\r\n            \r\n\r\n            $this->db->group_start();\r\n\r\n            if (!empty($ilIds)) {\r\n\r\n                $this->db->or_where_in('pc.potansiyel_il_id', $ilIds);\r\n\r\n            }\r\n\r\n            if (!empty($ilceIds)) {\r\n\r\n                $this->db->or_where_in('pc.potansiyel_ilce_id', $ilceIds);\r\n\r\n            }\r\n\r\n            $this->db->group_end();\r\n\r\n            \r\n\r\n            $sonuc = $this->db->get()->row();\r\n\r\n            echo \"<p><strong>Bu kullanıcının görebileceği talep sayısı:</strong> {$sonuc->toplam}</p>\";\r\n\r\n        } else {\r\n\r\n            echo \"<p style='color:red;'><strong>Bu kullanıcının hiç aktif sorumluluk bölgesi yok!</strong></p>\";\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Debug - Kullanıcının modül yetkilerini kontrol et\r\n\r\n     */\r\n\r\n    public function debug_yetkiler($user_id = null)\r\n\r\n    {\r\n\r\n        if (!$user_id) {\r\n\r\n            $control2 = session(\"r\", \"login_info\");\r\n\r\n            $user_id = $control2->kullanici_id;\r\n\r\n        }\r\n\r\n        \r\n\r\n        echo \"<h3>Kullanıcı ID: $user_id için Modül Yetkileri Debug</h3>\";\r\n\r\n        \r\n\r\n        // 1800 ve 1810 modül yetkilerini kontrol et\r\n\r\n        $yetki1800 = grup_modul_yetkisi_var(1800);\r\n\r\n        $yetki1810 = grup_modul_yetkisi_var(1810);\r\n\r\n        \r\n\r\n        echo \"<p><strong>1800 (Talepler Listesi) Yetkisi:</strong> \" . ($yetki1800 ? \"VAR\" : \"YOK\") . \"</p>\";\r\n\r\n        echo \"<p><strong>1810 (Teklif Ekleme) Yetkisi:</strong> \" . ($yetki1810 ? \"VAR\" : \"YOK\") . \"</p>\";\r\n\r\n        \r\n\r\n        // Kullanıcının tüm grup yetkilerini göster\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        echo \"<h4>Session Bilgileri:</h4>\";\r\n\r\n        echo \"<pre>\";\r\n\r\n        print_r($control2);\r\n\r\n        echo \"</pre>\";\r\n\r\n        \r\n\r\n        // Grup modül yetkilerini direkt sorgudan kontrol et\r\n\r\n        if (function_exists('grup_modul_yetkisi_var')) {\r\n\r\n            echo \"<h4>grup_modul_yetkisi_var Fonksiyonu Mevcut</h4>\";\r\n\r\n        } else {\r\n\r\n            echo \"<h4 style='color:red;'>grup_modul_yetkisi_var Fonksiyonu Bulunamadı!</h4>\";\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Talep düzenle\r\n\r\n     */\r\n\r\n    public function talep_duzenle($id)\r\n\r\n    {\r\n\r\n        if (!grup_modul_yetkisi_var(1810)) {\r\n\r\n            redirect(\"home/hata\");\r\n\r\n        }\r\n\r\n\r\n\r\n        $data[\"baslik\"] = \"Talep Düzenle\";\r\n\r\n        \r\n\r\n        // Kullanıcı bilgilerini al\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        $data[\"kullanici\"] = $control2;\r\n\r\n        \r\n\r\n        // Mevcut talep bilgilerini getir\r\n\r\n        $this->db->select('tc.*');\r\n\r\n        $this->db->from('potansiyel_cari tc');\r\n\r\n        $this->db->where('tc.id', $id);\r\n\r\n        $query = $this->db->get();\r\n\r\n        $data[\"talep\"] = $query->row();\r\n\r\n        \r\n\r\n        if (!$data[\"talep\"]) {\r\n\r\n            $this->session->set_flashdata('hata', 'Talep bulunamadı.');\r\n\r\n            redirect('talepler/talepler-listesi');\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Dropdown verileri\r\n\r\n        $data[\"talep_kaynaklari\"] = $this->vt->multiple('talep_kaynaklari', [], 'talep_kaynaklari_adi ASC');\r\n\r\n        $data[\"talep_durumlari\"] = $this->vt->multiple('talep_durumlari', ['talep_durumlari_durum' => 1], 'talep_durumlari_adi ASC');\r\n\r\n        $data[\"sektorler\"] = $this->vt->multiple('sektorler', [], 'sektor_adi ASC');\r\n\r\n        $data[\"ulkeler\"] = $this->vt->multiple('ulkeler', [], 'ulke_adi ASC');\r\n\r\n        $data[\"iller\"] = $this->vt->multiple('iller', ['ulke_id' => 3], 'il ASC');\r\n\r\n        \r\n\r\n        // Seçili ile ait ilçeleri getir\r\n\r\n        if ($data[\"talep\"]->potansiyel_il_id) {\r\n\r\n            $data[\"ilceler\"] = $this->vt->multiple('ilceler', ['il_id' => $data[\"talep\"]->potansiyel_il_id], 'ilce ASC');\r\n\r\n        } else {\r\n\r\n            $data[\"ilceler\"] = [];\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Edit mode flag\r\n\r\n        $data[\"edit_mode\"] = true;\r\n\r\n        $data[\"talep_id\"] = $id;\r\n\r\n\r\n\r\n        $this->load->view(\"talepler/talep-olustur\", $data);\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Potansiyel satış (teklif) ekleme\r\n\r\n     */\r\n\r\n    public function potansiyel_satis_ekle()\r\n\r\n    {\r\n\r\n        // Debug için log\r\n\r\n        error_log(\"potansiyel_satis_ekle metodu çağrıldı\");\r\n\r\n        error_log(\"HTTP Method: \" . $_SERVER['REQUEST_METHOD']);\r\n\r\n        error_log(\"POST data: \" . print_r($_POST, true));\r\n\r\n        \r\n\r\n        // Geçici olarak yetki kontrolünü devre dışı bırak\r\n\r\n        // if (!grup_modul_yetkisi_var(1810)) {\r\n\r\n        //     error_log(\"Yetki hatası\");\r\n\r\n        //     redirect(\"home/hata\");\r\n\r\n        // }\r\n\r\n\r\n\r\n        if ($this->input->method() == 'post') {\r\n\r\n            error_log(\"POST metodu ile gelen veri işleniyor\");\r\n\r\n            \r\n\r\n            $potansiyel_cari_id = $this->input->post('potansiyel_cari_id');\r\n\r\n            $durum_id = $this->input->post('durum_id');\r\n\r\n            $fiyat1 = $this->input->post('fiyat1');\r\n\r\n            $fiyat2 = $this->input->post('fiyat2');\r\n\r\n            $fiyat3 = $this->input->post('fiyat3');\r\n\r\n            $aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n            error_log(\"Potansiyel cari ID: \" . $potansiyel_cari_id);\r\n\r\n            error_log(\"Durum ID: \" . $durum_id);\r\n\r\n\r\n\r\n            // Kullanıcı bilgilerini al\r\n\r\n            $control2 = session(\"r\", \"login_info\");\r\n\r\n            $u_id = $control2->kullanici_id;\r\n\r\n            $bugun = date('Y-m-d');\r\n\r\n\r\n\r\n            // Önce potansiyel cari kaydının mevcut olduğunu ve kullanıcının bu bölgede yetkili olduğunu kontrol et\r\n\r\n            $this->db->select('pc.*, u.ulke_adi, il.il as il_adi, ilce.ilce as ilce_adi');\r\n\r\n            $this->db->from('potansiyel_cari pc');\r\n\r\n            $this->db->join('ulkeler u', 'pc.potansiyel_ulke_id = u.id', 'left');\r\n\r\n            $this->db->join('iller il', 'pc.potansiyel_il_id = il.id', 'left');\r\n\r\n            $this->db->join('ilceler ilce', 'pc.potansiyel_ilce_id = ilce.id', 'left');\r\n\r\n            $this->db->where('pc.id', $potansiyel_cari_id);\r\n\r\n            $this->db->where('pc.potansitel_talep', 1);\r\n\r\n            $potansiyel_cari = $this->db->get()->row();\r\n\r\n\r\n\r\n            if (!$potansiyel_cari) {\r\n\r\n                error_log(\"Potansiyel cari bulunamadı\");\r\n\r\n                $this->session->set_flashdata('error', 'Geçersiz talep ID.');\r\n\r\n                redirect('talepler/talepler-listesi');\r\n\r\n                return;\r\n\r\n            }\r\n\r\n\r\n\r\n            error_log(\"Potansiyel cari bulundu: \" . $potansiyel_cari->potansiyel_cari_ad);\r\n\r\n\r\n\r\n            // Kullanıcının bu bölgede yetkili olup olmadığını kontrol et\r\n\r\n            $yetkiVarMi = false;\r\n\r\n            \r\n\r\n            // İl bazlı yetki kontrolü\r\n\r\n            if ($potansiyel_cari->potansiyel_il_id) {\r\n\r\n                $ilYetkiQ = \"SELECT COUNT(*) as sayac \r\n\r\n                            FROM kullanici_sorumluluk_bolgesi \r\n\r\n                            WHERE kullanici = '$u_id' \r\n\r\n                            AND durum = 1 \r\n\r\n                            AND il_id = '{$potansiyel_cari->potansiyel_il_id}'\r\n\r\n                            AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                            AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n                $ilYetki = $this->db->query($ilYetkiQ)->row();\r\n\r\n                if ($ilYetki->sayac > 0) {\r\n\r\n                    $yetkiVarMi = true;\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n            // İlçe bazlı yetki kontrolü\r\n\r\n            if (!$yetkiVarMi && $potansiyel_cari->potansiyel_ilce_id) {\r\n\r\n                $ilceYetkiQ = \"SELECT COUNT(*) as sayac \r\n\r\n                              FROM kullanici_sorumluluk_bolgesi \r\n\r\n                              WHERE kullanici = '$u_id' \r\n\r\n                              AND durum = 1 \r\n\r\n                              AND ilce_id = '{$potansiyel_cari->potansiyel_ilce_id}'\r\n\r\n                              AND (baslangic_tarihi IS NULL OR baslangic_tarihi <= '$bugun') \r\n\r\n                              AND (bitis_tarihi IS NULL OR bitis_tarihi >= '$bugun')\";\r\n\r\n                $ilceYetki = $this->db->query($ilceYetkiQ)->row();\r\n\r\n                if ($ilceYetki->sayac > 0) {\r\n\r\n                    $yetkiVarMi = true;\r\n\r\n                }\r\n\r\n            }\r\n\r\n\r\n\r\n            if (!$yetkiVarMi) {\r\n\r\n                error_log(\"Yetki yok\");\r\n\r\n                $this->session->set_flashdata('error', 'Bu bölgede teklif ekleme yetkiniz bulunmamaktadır.');\r\n\r\n                redirect('talepler/talepler-listesi');\r\n\r\n                return;\r\n\r\n            }\r\n\r\n\r\n\r\n            // Fiyat alanlarını formatla (virgülü noktaya çevir)\r\n\r\n            $fiyat1 = !empty($fiyat1) ? str_replace(',', '.', str_replace('.', '', $fiyat1)) : null;\r\n\r\n            $fiyat2 = !empty($fiyat2) ? str_replace(',', '.', str_replace('.', '', $fiyat2)) : null;\r\n\r\n            $fiyat3 = !empty($fiyat3) ? str_replace(',', '.', str_replace('.', '', $fiyat3)) : null;\r\n\r\n\r\n\r\n            $data = array(\r\n\r\n                'potansiyel_cari_id' => $potansiyel_cari_id,\r\n\r\n                'durum_id' => $durum_id,\r\n\r\n                'fiyat1' => $fiyat1,\r\n\r\n                'fiyat2' => $fiyat2,\r\n\r\n                'fiyat3' => $fiyat3,\r\n\r\n                'aciklama' => $aciklama,\r\n\r\n                'islemi_yapan' => $u_id,\r\n\r\n                'islem_tarihi' => date('Y-m-d H:i:s')\r\n\r\n            );\r\n\r\n\r\n\r\n            error_log(\"Veritabanına eklenecek veri: \" . print_r($data, true));\r\n\r\n\r\n\r\n            $result = $this->db->insert('potansiyel_satis', $data);\r\n\r\n\r\n\r\n            if ($result) {\r\n\r\n                error_log(\"Teklif başarıyla eklendi\");\r\n\r\n                $this->session->set_flashdata('success', 'Teklif başarıyla eklendi.');\r\n\r\n            } else {\r\n\r\n                error_log(\"Teklif eklenirken hata oluştu\");\r\n\r\n                $this->session->set_flashdata('error', 'Teklif eklenirken bir hata oluştu.');\r\n\r\n            }\r\n\r\n\r\n\r\n            redirect('talepler/talepler-listesi');\r\n\r\n        } else {\r\n\r\n            error_log(\"POST metodu değil, redirect yapılıyor\");\r\n\r\n            redirect('talepler/talepler-listesi');\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Telefon numarasını standart formata çevir (05xxxxxxxxx)\r\n\r\n     */\r\n\r\n    private function format_phone_number($phone)\r\n\r\n    {\r\n\r\n        if (empty($phone)) {\r\n\r\n            return $phone;\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Sadece rakamları al\r\n\r\n        $phone = preg_replace('/[^0-9]/', '', $phone);\r\n\r\n        \r\n\r\n        // Boş ise geri döndür\r\n\r\n        if (empty($phone)) {\r\n\r\n            return $phone;\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Türkiye telefon formatına çevir\r\n\r\n        if (strlen($phone) == 10 && substr($phone, 0, 1) == '5') {\r\n\r\n            // 5xxxxxxxxx -> 05xxxxxxxxx\r\n\r\n            return '0' . $phone;\r\n\r\n        } elseif (strlen($phone) == 11 && substr($phone, 0, 2) == '05') {\r\n\r\n            // 05xxxxxxxxx -> 05xxxxxxxxx (zaten doğru format)\r\n\r\n            return $phone;\r\n\r\n        } elseif (strlen($phone) == 12 && substr($phone, 0, 3) == '905') {\r\n\r\n            // 905xxxxxxxxx -> 05xxxxxxxxx\r\n\r\n            return '0' . substr($phone, 2);\r\n\r\n        } elseif (strlen($phone) == 13 && substr($phone, 0, 4) == '+905') {\r\n\r\n            // +905xxxxxxxxx -> 05xxxxxxxxx\r\n\r\n            return '0' . substr($phone, 3);\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Diğer durumlar için olduğu gibi döndür\r\n\r\n        return $phone;\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Potansiyel müşteri için teklifleri getir (AJAX)\r\n\r\n     */\r\n\r\n    public function get_teklifler()\r\n\r\n    {\r\n\r\n        // JSON response için header ayarla\r\n\r\n        header('Content-Type: application/json; charset=utf-8');\r\n\r\n        \r\n\r\n        $cari_id = $this->input->get('cari_id');\r\n\r\n        \r\n\r\n        if (empty($cari_id)) {\r\n\r\n            echo json_encode(['success' => false, 'message' => 'Geçersiz müşteri ID']);\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        try {\r\n\r\n            // Potansiyel satış tablosundan teklifleri getir\r\n\r\n            $this->db->select('ps.*, pd.Durum_Adi, ps.islem_tarihi as tarih');\r\n\r\n            $this->db->from('potansiyel_satis ps');\r\n\r\n            $this->db->join('potansiyel_durumlar pd', 'ps.durum_id = pd.id', 'left');\r\n\r\n            $this->db->where('ps.potansiyel_cari_id', $cari_id);\r\n\r\n            $this->db->order_by('ps.id', 'DESC');\r\n\r\n            \r\n\r\n            $query = $this->db->get();\r\n\r\n            $teklifler = $query->result();\r\n\r\n            \r\n\r\n            // Sonuçları formatla\r\n\r\n            $formatted_teklifler = array();\r\n\r\n            foreach ($teklifler as $teklif) {\r\n\r\n                $formatted_teklifler[] = array(\r\n\r\n                    'id' => $teklif->id,\r\n\r\n                    'tarih' => date('d.m.Y H:i', strtotime($teklif->tarih)),\r\n\r\n                    'durum' => $teklif->Durum_Adi ?: 'Belirtilmemiş',\r\n\r\n                    'fiyat1' => $teklif->fiyat1 ? number_format($teklif->fiyat1, 2, ',', '.') . ' ₺' : null,\r\n\r\n                    'fiyat2' => $teklif->fiyat2 ? number_format($teklif->fiyat2, 2, ',', '.') . ' ₺' : null,\r\n\r\n                    'fiyat3' => $teklif->fiyat3 ? number_format($teklif->fiyat3, 2, ',', '.') . ' ₺' : null,\r\n\r\n                    'aciklama' => $teklif->aciklama\r\n\r\n                );\r\n\r\n            }\r\n\r\n            \r\n\r\n            echo json_encode([\r\n\r\n                'success' => true,\r\n\r\n                'teklifler' => $formatted_teklifler,\r\n\r\n                'total' => count($formatted_teklifler)\r\n\r\n            ], JSON_UNESCAPED_UNICODE);\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            echo json_encode(['success' => false, 'message' => 'Veriler alınırken hata oluştu: ' . $e->getMessage()]);\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Otomatik destek talebi oluşturma (mobil upload hataları için)\r\n\r\n     */\r\n\r\n    public function otomatik_talep_olustur()\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            // POST verilerini al\r\n\r\n            $error_type = $this->input->post('error_type');\r\n\r\n            $user_agent = $this->input->post('user_agent');\r\n\r\n            $screen_resolution = $this->input->post('screen_resolution');\r\n\r\n            $viewport_size = $this->input->post('viewport_size');\r\n\r\n            $url = $this->input->post('url');\r\n\r\n            $timestamp = $this->input->post('timestamp');\r\n\r\n            $browser_info = $this->input->post('browser_info');\r\n\r\n            $device_info = $this->input->post('device_info');\r\n\r\n            $error_details = $this->input->post('error_details');\r\n\r\n            \r\n\r\n            // Kullanıcı bilgilerini al\r\n\r\n            $control = session(\"r\", \"login_info\");\r\n\r\n            $kullanici_id = $control->kullanici_id;\r\n\r\n            $kullanici_adi = $control->kullanici_adi;\r\n\r\n            $firma_id = $control->firma_id;\r\n\r\n            \r\n\r\n            // Talep başlığı ve açıklaması oluştur\r\n\r\n            $baslik = \"Otomatik Destek Talebi - \" . ($error_type == 'ERR_FILE_ACCESS' ? 'Dosya Erişim Hatası' : 'Mobil Dosya Yükleme Hatası');\r\n\r\n            $aciklama = \"Bu talep otomatik olarak oluşturulmuştur.\\n\\n\";\r\n\r\n            $aciklama .= \"**Hata Türü:** \" . $error_type . \"\\n\";\r\n\r\n            $aciklama .= \"**Kullanıcı:** \" . $kullanici_adi . \"\\n\";\r\n\r\n            $aciklama .= \"**Sayfa:** \" . $url . \"\\n\";\r\n\r\n            $aciklama .= \"**Zaman:** \" . $timestamp . \"\\n\\n\";\r\n\r\n            $aciklama .= \"**Teknik Bilgiler:**\\n\";\r\n\r\n            $aciklama .= \"- Tarayıcı: \" . $browser_info . \"\\n\";\r\n\r\n            $aciklama .= \"- User Agent: \" . $user_agent . \"\\n\";\r\n\r\n            $aciklama .= \"- Ekran Çözünürlüğü: \" . $screen_resolution . \"\\n\";\r\n\r\n            $aciklama .= \"- Viewport Boyutu: \" . $viewport_size . \"\\n\";\r\n\r\n            $aciklama .= \"- Cihaz Bilgisi: \" . $device_info . \"\\n\\n\";\r\n\r\n            $aciklama .= \"**Hata Detayları:**\\n\" . $error_details . \"\\n\\n\";\r\n\r\n            $aciklama .= \"**Önerilen Çözümler:**\\n\";\r\n\r\n            $aciklama .= \"- Dosyayı tekrar seçmek\\n\";\r\n\r\n            $aciklama .= \"- Tarayıcıyı yeniden başlatmak\\n\";\r\n\r\n            $aciklama .= \"- Farklı dosya formatı denemek\\n\";\r\n\r\n            $aciklama .= \"- Dosya boyutunu küçültmek\\n\";\r\n\r\n            \r\n\r\n            // Destek talebi verisini hazırla (mevcut tablo yapısına uygun)\r\n\r\n            $destek_data = array(\r\n\r\n                'destek_title' => $baslik,\r\n\r\n                'destek_priority' => 2, // Orta öncelik\r\n\r\n                'destek_department' => 1, // Teknik departman\r\n\r\n                'destek_status' => 1, // Açık\r\n\r\n                'destek_date' => date('Y-m-d H:i:s'),\r\n\r\n                'destek_lastUpdateDate' => date('Y-m-d H:i:s'),\r\n\r\n                'destek_ip' => $this->input->ip_address(),\r\n\r\n                'destek_olusturan' => $kullanici_id,\r\n\r\n                'destek_olusturanAnaHesap' => $firma_id,\r\n\r\n                'destek_isRead' => 0\r\n\r\n                // Not: Yeni alanlar veritabanına eklendikten sonra aşağıdaki satırlar açılacak\r\n\r\n                /*\r\n\r\n                'destek_otomatik_olusturuldu' => 1,\r\n\r\n                'destek_hata_turu' => $error_type,\r\n\r\n                'destek_user_agent' => $user_agent,\r\n\r\n                'destek_screen_resolution' => $screen_resolution,\r\n\r\n                'destek_viewport_size' => $viewport_size,\r\n\r\n                'destek_browser_info' => $browser_info,\r\n\r\n                'destek_device_info' => $device_info,\r\n\r\n                'destek_url' => $url,\r\n\r\n                'destek_error_timestamp' => date('Y-m-d H:i:s', strtotime($timestamp)),\r\n\r\n                'destek_teknik_detay' => $error_details\r\n\r\n                */\r\n\r\n            );\r\n\r\n            \r\n\r\n            // Destek talebini veritabanına ekle\r\n\r\n            $this->db->insert('destek', $destek_data);\r\n\r\n            $destek_id = $this->db->insert_id();\r\n\r\n            \r\n\r\n            if ($destek_id) {\r\n\r\n                // Destek yanıtı ekle (otomatik mesaj)\r\n\r\n                $yanit_data = array(\r\n\r\n                    'destek_id' => $destek_id,\r\n\r\n                    'destek_mesaj' => $aciklama,\r\n\r\n                    'destek_mesaj_tarih' => date('Y-m-d H:i:s'),\r\n\r\n                    'destek_mesaj_olusturan' => $kullanici_id,\r\n\r\n                    'destek_mesaj_olusturanAnaHesap' => $firma_id,\r\n\r\n                    'destek_mesaj_tipi' => 'otomatik'\r\n\r\n                );\r\n\r\n                $this->db->insert('destek_yanit', $yanit_data);\r\n\r\n                \r\n\r\n                // Başarılı response\r\n\r\n                echo json_encode([\r\n\r\n                    'success' => true,\r\n\r\n                    'ticket_id' => $destek_id,\r\n\r\n                    'message' => 'Otomatik destek talebi oluşturuldu'\r\n\r\n                ]);\r\n\r\n                \r\n\r\n                // Destek ekibine bildirim gönder (opsiyonel)\r\n\r\n                $this->_send_auto_ticket_notification($destek_id, $kullanici_adi, $error_type);\r\n\r\n                \r\n\r\n            } else {\r\n\r\n                echo json_encode([\r\n\r\n                    'success' => false,\r\n\r\n                    'message' => 'Destek talebi oluşturulurken hata oluştu'\r\n\r\n                ]);\r\n\r\n            }\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            echo json_encode([\r\n\r\n                'success' => false,\r\n\r\n                'message' => 'Sistem hatası: ' . $e->getMessage()\r\n\r\n            ]);\r\n\r\n        }\r\n\r\n    }\r\n\r\n    \r\n\r\n    /**\r\n\r\n     * Otomatik talep için destek ekibine bildirim\r\n\r\n     */\r\n\r\n    private function _send_auto_ticket_notification($talep_id, $kullanici_adi, $error_type)\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            // Destek ekibi e-posta adresleri (config'den alınabilir)\r\n\r\n            $destek_emails = ['destek@ilekasoft.com', 'teknik@ilekasoft.com'];\r\n\r\n            \r\n\r\n            // Kullanıcı bilgilerini al\r\n\r\n            $control2 = session(\"r\", \"login_info\");\r\n\r\n            $kullanici = $control2 ? $control2 : null;\r\n\r\n            \r\n\r\n            // Talep detaylarını al\r\n\r\n            $talep_detay = $this->db->query(\"SELECT pc.*, s.sektor_adi, il.il as il_adi, ilce.ilce as ilce_adi \r\n\r\n                                           FROM potansiyel_cari pc \r\n\r\n                                           LEFT JOIN sektorler s ON pc.sektor_id = s.sektor_id \r\n\r\n                                           LEFT JOIN iller il ON pc.potansiyel_il_id = il.id \r\n\r\n                                           LEFT JOIN ilceler ilce ON pc.potansiyel_ilce_id = ilce.id \r\n\r\n                                           WHERE pc.id = $talep_id\")->row();\r\n\r\n            \r\n\r\n            $konu = \"🎫 İlekaSoft CRM - Yeni Otomatik Destek Talebi #\" . $talep_id . \" - \" . $error_type;\r\n\r\n            \r\n\r\n            // HTML mail içeriği\r\n\r\n            $mesaj = '\r\n\r\n<!DOCTYPE html>\r\n\r\n<html>\r\n\r\n<head>\r\n\r\n    <meta charset=\"utf-8\">\r\n\r\n    <style>\r\n\r\n        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }\r\n\r\n        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\r\n\r\n        .header { background-color: #dc3545; color: white; padding: 20px; text-align: center; }\r\n\r\n        .content { padding: 30px; }\r\n\r\n        .info-box { background-color: #f8f9fa; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; }\r\n\r\n        .warning-box { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }\r\n\r\n        .btn { display: inline-block; padding: 12px 24px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 4px; margin: 15px 0; }\r\n\r\n        .footer { background-color: #6c757d; color: white; padding: 15px; text-align: center; font-size: 12px; }\r\n\r\n    </style>\r\n\r\n</head>\r\n\r\n<body>\r\n\r\n    <div class=\"container\">\r\n\r\n        <div class=\"header\">\r\n\r\n            <h2>⚠️ Otomatik Destek Talebi Oluşturuldu</h2>\r\n\r\n        </div>\r\n\r\n        <div class=\"content\">\r\n\r\n            <p>Merhaba,</p>\r\n\r\n            <p>Sistemde otomatik olarak yeni bir destek talebi oluşturuldu. Bu talep sistem hatası nedeniyle otomatik olarak açılmıştır.</p>\r\n\r\n            \r\n\r\n            <div class=\"warning-box\">\r\n\r\n                <h4>⚠️ Hata Türü</h4>\r\n\r\n                <p><strong>' . htmlspecialchars($error_type) . '</strong></p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <div class=\"info-box\">\r\n\r\n                <h4>📋 Talep Bilgileri</h4>\r\n\r\n                <p><strong>Talep ID:</strong> #' . $talep_id . '</p>\r\n\r\n                <p><strong>Kullanıcı:</strong> ' . htmlspecialchars($kullanici_adi) . '</p>';\r\n\r\n                \r\n\r\n            if ($kullanici) {\r\n\r\n                $mesaj .= '<p><strong>Kullanıcı E-posta:</strong> ' . htmlspecialchars($kullanici->kullanici_eposta ?? 'Bilinmiyor') . '</p>';\r\n\r\n                $mesaj .= '<p><strong>Kullanici ID:</strong> ' . ($kullanici->kullanici_id ?? 'Bilinmiyor') . '</p>';\r\n\r\n            }\r\n\r\n            \r\n\r\n            $mesaj .= '<p><strong>Oluşturma Tarihi:</strong> ' . date('d.m.Y H:i:s') . '</p>\r\n\r\n            </div>';\r\n\r\n            \r\n\r\n            if ($talep_detay) {\r\n\r\n                $mesaj .= '\r\n\r\n                <div class=\"info-box\">\r\n\r\n                    <h4>👤 Potansiyel Müşteri Bilgileri</h4>\r\n\r\n                    <p><strong>Müşteri Adı:</strong> ' . htmlspecialchars($talep_detay->potansiyel_cari_ad ?? 'Bilinmiyor') . '</p>\r\n\r\n                    <p><strong>Telefon:</strong> ' . htmlspecialchars($talep_detay->potansiyel_cari_firmaTelefon ?? 'Bilinmiyor') . '</p>\r\n\r\n                    <p><strong>Sektör:</strong> ' . htmlspecialchars($talep_detay->sektor_adi ?? 'Bilinmiyor') . '</p>\r\n\r\n                    <p><strong>Konum:</strong> ' . htmlspecialchars($talep_detay->il_adi ?? 'Bilinmiyor') . \r\n\r\n                    ($talep_detay->ilce_adi ? ' / ' . htmlspecialchars($talep_detay->ilce_adi) : '') . '</p>\r\n\r\n                    <p><strong>Adres:</strong> ' . htmlspecialchars(substr($talep_detay->potansiyel_cari_adres ?? 'Bilinmiyor', 0, 100)) . \r\n\r\n                    (strlen($talep_detay->potansiyel_cari_adres ?? '') > 100 ? '...' : '') . '</p>\r\n\r\n                </div>';\r\n\r\n            }\r\n\r\n            \r\n\r\n            $mesaj .= '\r\n\r\n            <p>Bu otomatik talep acil olarak incelenmeli ve gerekli teknik müdahale yapılmalıdır.</p>\r\n\r\n            \r\n\r\n            <a href=\"https://crm.ilekasoft.com/talepler/talep-detay/' . $talep_id . '\" class=\"btn\">🔗 Talebi Görüntüle</a>\r\n\r\n        </div>\r\n\r\n        <div class=\"footer\">\r\n\r\n            <p>Bu e-posta İlekaSoft CRM sistemi tarafından otomatik olarak gönderilmiştir.</p>\r\n\r\n            <p>' . date('Y') . ' © İlekaSoft - Tüm hakları saklıdır.</p>\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</body>\r\n\r\n</html>';\r\n\r\n            \r\n\r\n            // E-posta gönderimi (mevcut mail konfigürasyonu kullanılabilir)\r\n\r\n            foreach ($destek_emails as $email) {\r\n\r\n                // CI'ın email library'si kullan\r\n\r\n                $mail_config = Array(\r\n\r\n                    'protocol' => 'smtp',\r\n\r\n                    'smtp_crypto' => 'ssl',\r\n\r\n                    'smtp_host' => 'mail.ilekasoft.com',\r\n\r\n                    'smtp_port' => 465,\r\n\r\n                    'smtp_user' => 'ticket@ilekasoft.com',\r\n\r\n                    'smtp_pass' => '0oqZknrfOw',\r\n\r\n                    'charset'   => 'utf-8',\r\n\r\n                    'mailtype'  => 'html',\r\n\r\n                    'wordwrap' => TRUE\r\n\r\n                );\r\n\r\n                \r\n\r\n                $this->load->library('email', $mail_config);\r\n\r\n                $this->email->clear();\r\n\r\n                $this->email->set_newline(\"\\r\\n\");\r\n\r\n                $this->email->to($email);\r\n\r\n                $this->email->from(\"ticket@ilekasoft.com\", \"İlekaSoft CRM Sistemi\");\r\n\r\n                $this->email->subject($konu);\r\n\r\n                $this->email->message($mesaj);\r\n\r\n                \r\n\r\n                if (!$this->email->send()) {\r\n\r\n                    log_message('error', 'Otomatik talep mail gönderimi başarısız: ' . $this->email->print_debugger());\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            // Bildirim hatası önemli değil, loglama yapılabilir\r\n\r\n            log_message('error', 'Auto ticket notification failed: ' . $e->getMessage());\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Yeni talep için admin'e bildirim gönder\r\n\r\n     */\r\n\r\n    private function _send_new_talep_notification($talep_id, $talep_data)\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            // Admin e-posta adresleri\r\n\r\n            $admin_emails = ['destek@ilekasoft.com', 'teknik@ilekasoft.com'];\r\n\r\n            \r\n\r\n            // Kullanıcı bilgilerini al\r\n\r\n            $control2 = session(\"r\", \"login_info\");\r\n\r\n            $kullanici = $control2 ? $control2 : null;\r\n\r\n            \r\n\r\n            // Sektör, il, ilçe bilgilerini al\r\n\r\n            $sektor_adi = 'Bilinmiyor';\r\n\r\n            $il_adi = 'Bilinmiyor';\r\n\r\n            $ilce_adi = 'Bilinmiyor';\r\n\r\n            \r\n\r\n            if (!empty($talep_data['sektor_id'])) {\r\n\r\n                $sektor = $this->db->query(\"SELECT sektor_adi FROM sektorler WHERE sektor_id = \" . $talep_data['sektor_id'])->row();\r\n\r\n                if ($sektor) $sektor_adi = $sektor->sektor_adi;\r\n\r\n            }\r\n\r\n            \r\n\r\n            if (!empty($talep_data['potansiyel_il_id'])) {\r\n\r\n                $il = $this->db->query(\"SELECT il FROM iller WHERE id = \" . $talep_data['potansiyel_il_id'])->row();\r\n\r\n                if ($il) $il_adi = $il->il;\r\n\r\n            }\r\n\r\n            \r\n\r\n            if (!empty($talep_data['potansiyel_ilce_id'])) {\r\n\r\n                $ilce = $this->db->query(\"SELECT ilce FROM ilceler WHERE id = \" . $talep_data['potansiyel_ilce_id'])->row();\r\n\r\n                if ($ilce) $ilce_adi = $ilce->ilce;\r\n\r\n            }\r\n\r\n            \r\n\r\n            $konu = \"🎯 İlekaSoft CRM - Yeni Potansiyel Müşteri Talebi #\" . $talep_id;\r\n\r\n            \r\n\r\n            // HTML mail içeriği\r\n\r\n            $mesaj = '\r\n\r\n<!DOCTYPE html>\r\n\r\n<html>\r\n\r\n<head>\r\n\r\n    <meta charset=\"utf-8\">\r\n\r\n    <style>\r\n\r\n        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }\r\n\r\n        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\r\n\r\n        .header { background-color: #28a745; color: white; padding: 20px; text-align: center; }\r\n\r\n        .content { padding: 30px; }\r\n\r\n        .info-box { background-color: #f8f9fa; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; }\r\n\r\n        .customer-box { background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 15px 0; }\r\n\r\n        .btn { display: inline-block; padding: 12px 24px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; margin: 15px 0; }\r\n\r\n        .footer { background-color: #6c757d; color: white; padding: 15px; text-align: center; font-size: 12px; }\r\n\r\n        .highlight { background-color: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }\r\n\r\n    </style>\r\n\r\n</head>\r\n\r\n<body>\r\n\r\n    <div class=\"container\">\r\n\r\n        <div class=\"header\">\r\n\r\n            <h2>🎯 Yeni Potansiyel Müşteri Talebi</h2>\r\n\r\n        </div>\r\n\r\n        <div class=\"content\">\r\n\r\n            <p>Merhaba,</p>\r\n\r\n            <p>Sistemde yeni bir potansiyel müşteri talebi oluşturuldu. Bu fırsat değerlendirilmelidir!</p>\r\n\r\n            \r\n\r\n            <div class=\"info-box\">\r\n\r\n                <h4>📋 Talep Bilgileri</h4>\r\n\r\n                <p><strong>Talep ID:</strong> #' . $talep_id . '</p>';\r\n\r\n                \r\n\r\n            if ($kullanici) {\r\n\r\n                $mesaj .= '<p><strong>Oluşturan Kullanıcı:</strong> ' . htmlspecialchars($kullanici->kullanici_ad . ' ' . $kullanici->kullanici_soyad) . '</p>';\r\n\r\n                $mesaj .= '<p><strong>Kullanıcı E-posta:</strong> ' . htmlspecialchars($kullanici->kullanici_eposta ?? 'Bilinmiyor') . '</p>';\r\n\r\n            }\r\n\r\n            \r\n\r\n            $mesaj .= '<p><strong>Oluşturma Tarihi:</strong> ' . date('d.m.Y H:i:s') . '</p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <div class=\"customer-box\">\r\n\r\n                <h4>👤 Potansiyel Müşteri Bilgileri</h4>\r\n\r\n                <p><strong>Müşteri/Firma Adı:</strong> ' . htmlspecialchars($talep_data['potansiyel_cari_ad'] ?? 'Bilinmiyor') . '</p>\r\n\r\n                <p><strong>Telefon:</strong> ' . htmlspecialchars($talep_data['potansiyel_cari_firmaTelefon'] ?? 'Bilinmiyor') . '</p>\r\n\r\n                <p><strong>Sektör:</strong> ' . htmlspecialchars($sektor_adi) . '</p>\r\n\r\n                <p><strong>Konum:</strong> ' . htmlspecialchars($il_adi) . \r\n\r\n                ($ilce_adi !== 'Bilinmiyor' ? ' / ' . htmlspecialchars($ilce_adi) : '') . '</p>';\r\n\r\n                \r\n\r\n            if (!empty($talep_data['potansiyel_mahalle'])) {\r\n\r\n                $mesaj .= '<p><strong>Mahalle:</strong> ' . htmlspecialchars($talep_data['potansiyel_mahalle']) . '</p>';\r\n\r\n            }\r\n\r\n            \r\n\r\n            if (!empty($talep_data['potansiyel_cari_adres'])) {\r\n\r\n                $mesaj .= '<p><strong>Adres:</strong> ' . htmlspecialchars($talep_data['potansiyel_cari_adres']) . '</p>';\r\n\r\n            }\r\n\r\n            \r\n\r\n            $mesaj .= '\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <div class=\"highlight\">\r\n\r\n                <h4>⚡ Hızlı İşlem Gerekli</h4>\r\n\r\n                <p>Bu potansiyel müşteri ile en kısa sürede iletişime geçilmesi önerilir. Fırsatın kaçırılmaması için gerekli takip işlemlerini başlatın.</p>\r\n\r\n            </div>\r\n\r\n            \r\n\r\n            <p>Detaylı bilgi için CRM panelini kontrol edin ve gerekli işlemleri yapın.</p>\r\n\r\n            \r\n\r\n            <a href=\"https://crm.ilekasoft.com/talepler/talep-detay/' . $talep_id . '\" class=\"btn\">🔗 Talebi Görüntüle ve İşle</a>\r\n\r\n        </div>\r\n\r\n        <div class=\"footer\">\r\n\r\n            <p>Bu e-posta İlekaSoft CRM sistemi tarafından otomatik olarak gönderilmiştir.</p>\r\n\r\n            <p>' . date('Y') . ' © İlekaSoft - Tüm hakları saklıdır.</p>\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</body>\r\n\r\n</html>';\r\n\r\n            \r\n\r\n            // E-posta gönderimi\r\n\r\n            foreach ($admin_emails as $email) {\r\n\r\n                $mail_config = Array(\r\n\r\n                    'protocol' => 'smtp',\r\n\r\n                    'smtp_crypto' => 'ssl',\r\n\r\n                    'smtp_host' => 'mail.ilekasoft.com',\r\n\r\n                    'smtp_port' => 465,\r\n\r\n                    'smtp_user' => 'ticket@ilekasoft.com',\r\n\r\n                    'smtp_pass' => '0oqZknrfOw',\r\n\r\n                    'charset'   => 'utf-8',\r\n\r\n                    'mailtype'  => 'html',\r\n\r\n                    'wordwrap' => TRUE\r\n\r\n                );\r\n\r\n                \r\n\r\n                $this->load->library('email', $mail_config);\r\n\r\n                $this->email->clear();\r\n\r\n                $this->email->set_newline(\"\\r\\n\");\r\n\r\n                $this->email->to($email);\r\n\r\n                $this->email->from(\"ticket@ilekasoft.com\", \"İlekaSoft CRM Sistemi\");\r\n\r\n                $this->email->subject($konu);\r\n\r\n                $this->email->message($mesaj);\r\n\r\n                \r\n\r\n                if (!$this->email->send()) {\r\n\r\n                    log_message('error', 'Yeni talep mail gönderimi başarısız: ' . $this->email->print_debugger());\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            log_message('error', 'New talep notification failed: ' . $e->getMessage());\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    // ...existing code...\r\n\r\n}\r\n\r\n?>\r\n\r\n"
        }
    ]
}