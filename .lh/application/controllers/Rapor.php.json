{
    "sourceFile": "application/controllers/Rapor.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1760110165525,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1760110172051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1131,9 +1131,9 @@\n             $this->email->clear();\r\n \r\n             \r\n \r\n-            $this->email->from('noreply@turkbelge.com.tr', 'IlekaSoft CRM Sistemi');\r\n+            $this->email->from('bilgi@ileka.com.tr, 'IlekaSoft CRM Sistemi');\r\n \r\n             $this->email->to($email);\r\n \r\n             $this->email->subject($konu);\r\n"
                },
                {
                    "date": 1760110198350,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1393,9 +1393,9 @@\n         echo \"<p><strong>SMTP Host:</strong> smtp.gmail.com</p>\";\r\n \r\n         echo \"<p><strong>SMTP Port:</strong> 465 (SSL)</p>\";\r\n \r\n-        echo \"<p><strong>GÃ¶nderen:</strong> noreply@turkbelge.com.tr</p>\";\r\n+        echo \"<p><strong>GÃ¶nderen:</strong> bilgi@ileka.com.tr</p>\";\r\n \r\n         echo \"<p><strong>GÃ¶nderen AdÄ±:</strong> IlekaSoft CRM Sistemi</p>\";\r\n \r\n         \r\n"
                }
            ],
            "date": 1760110165525,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Rapor extends CI_Controller {\r\n\r\n    \r\n\r\n    public function __construct()\r\n\r\n    {\r\n\r\n        parent::__construct();\r\n\r\n        error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n        $this->load->model('Vt', 'vt');\r\n\r\n        $this->load->database();\r\n\r\n        $this->load->library('email');\r\n\r\n        $this->load->library('session');\r\n\r\n        $this->load->helper('date');\r\n\r\n        $this->load->helper('url');\r\n\r\n\r\n\r\n        // Session kontrolÃ¼ - gunluk_rapor iÃ§in bypass\r\n\r\n        $requested_method = $this->uri->segment(2);\r\n\r\n        if ($requested_method !== 'gunluk_rapor') {\r\n\r\n            $control = session(\"r\", \"login\");\r\n\r\n            if (!$control) {\r\n\r\n                redirect(\"check\");\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }    /**\r\n\r\n     * Test endpoint to verify which file is being executed\r\n\r\n     */\r\n\r\n    public function test_dosya_kontrol()\r\n\r\n    {\r\n\r\n        $dosya_yolu = __FILE__;\r\n\r\n        $son_degisiklik = filemtime(__FILE__);\r\n\r\n        $tarih = date('Y-m-d H:i:s', $son_degisiklik);\r\n\r\n        \r\n\r\n        echo \"Ã‡alÄ±ÅŸan dosya: \" . $dosya_yolu . \"\\n\";\r\n\r\n        echo \"Son deÄŸiÅŸiklik: \" . $tarih . \"\\n\";\r\n\r\n        echo \"Test zamanÄ±: \" . date('Y-m-d H:i:s') . \"\\n\";\r\n\r\n        echo \"UNIK TEST KODU: RAPOR-2025-06-25-17:05\\n\";\r\n\r\n        \r\n\r\n        log_message('info', 'Test dosya kontrol Ã§aÄŸrÄ±ldÄ± - Dosya: ' . $dosya_yolu . ' - Son deÄŸiÅŸiklik: ' . $tarih);\r\n\r\n    }\r\n\r\n\r\n\r\n        /**\r\n\r\n     * GÃ¼nlÃ¼k raporlarÄ± gÃ¶nder - Cron job tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r\r\n\r\n     */\r\n\r\n    public function gunluk_rapor()\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            // OpCache temizleme deneyelim\r\n\r\n            if (function_exists('opcache_reset')) {\r\n\r\n                opcache_reset();\r\n\r\n                log_message('info', 'OpCache temizlendi');\r\n\r\n            }\r\n\r\n            \r\n\r\n            $this->load->helper('url');\r\n\r\n              // Ã–nceki gÃ¼nÃ¼n tarih bilgileri - Her sabah saat 9'da Ã¶nceki gÃ¼nÃ¼n raporu gÃ¶nderilecek\r\n\r\n            $onceki_gun = date('Y-m-d', strtotime('-1 day'));\r\n\r\n            $onceki_gun_formatted = date('d.m.Y', strtotime('-1 day'));\r\n\r\n            \r\n\r\n            log_message('info', 'GÃ¼nlÃ¼k rapor iÅŸlemi baÅŸlatÄ±ldÄ± - Ã–nceki GÃ¼n Tarihi: ' . $onceki_gun_formatted);\r\n\r\n            log_message('info', 'UNIK TEST MESAJI - KOD VERSIYON 2025-07-26-09:00 - Ã–NCEKÄ° GÃœN VERÄ°LERÄ°');\r\n\r\n              // Test modu kontrolÃ¼ - Ã–nce Admin grubuna gÃ¶nder\r\n\r\n            $test_modu = false; // CANLI: GerÃ§ek mÃ¼dÃ¼rlere gÃ¶nderim AÃ‡IK\r\n\r\n              if ($test_modu) {\r\n\r\n                $this->admin_test_raporu($onceki_gun, $onceki_gun_formatted);\r\n\r\n            } else {\r\n\r\n                // Genel MÃ¼dÃ¼r raporunu hem Genel MÃ¼dÃ¼r hem BÃ¶lge MÃ¼dÃ¼r gruplarÄ±na gÃ¶nder\r\n\r\n                $this->genel_mudur_raporu($onceki_gun, $onceki_gun_formatted);\r\n\r\n                \r\n\r\n                // BÃ¶lge MÃ¼dÃ¼rleri raporlarÄ± geÃ§ici askÄ±ya alÄ±ndÄ±\r\n\r\n                // $this->bolge_mudur_raporlari($onceki_gun, $onceki_gun_formatted);\r\n\r\n            }\r\n\r\n            \r\n\r\n            log_message('info', 'GÃ¼nlÃ¼k rapor iÅŸlemi tamamlandÄ±');\r\n\r\n            \r\n\r\n            if ($this->input->is_cli_request()) {\r\n\r\n                echo \"Rapor gÃ¶nderim iÅŸlemi tamamlandÄ± - \" . date('Y-m-d H:i:s') . \"\\n\";\r\n\r\n            } else {\r\n\r\n                echo json_encode(['status' => 'success', 'message' => 'Raporlar baÅŸarÄ±yla gÃ¶nderildi']);\r\n\r\n            }\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            log_message('error', 'GÃ¼nlÃ¼k rapor hatasÄ±: ' . $e->getMessage());\r\n\r\n            $this->hata_bildirimi($e->getMessage());\r\n\r\n            \r\n\r\n            if ($this->input->is_cli_request()) {\r\n\r\n                echo \"HATA: \" . $e->getMessage() . \"\\n\";\r\n\r\n            } else {\r\n\r\n                echo json_encode(['status' => 'error', 'message' => $e->getMessage()]);\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Test modu - Admin grubuna rapor gÃ¶nder\r\n\r\n     */\r\n\r\n    private function admin_test_raporu($tarih, $tarih_formatted)\r\n\r\n    {        log_message('info', 'Test modu - Admin grubuna rapor gÃ¶nderiliyor');        // Admin grubu kullanÄ±cÄ±larÄ±nÄ± al (grup_id = 1)\r\n\r\n        $adminler = $this->vt->multiple('kullanicilar', ['grup_id' => 1, 'kullanici_durum' => 1]);\r\n\r\n        \r\n\r\n        if (empty($adminler)) {\r\n\r\n            throw new Exception('Admin kullanÄ±cÄ± bulunamadÄ±');\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Genel mÃ¼dÃ¼r raporunu hazÄ±rla (test iÃ§in)\r\n\r\n        $rapor_html = $this->genel_mudur_rapor_hazirla($tarih, $tarih_formatted);        foreach ($adminler as $admin) {\r\n\r\n            if (!empty($admin->kullanici_eposta)) {\r\n\r\n                $admin_adi = trim($admin->kullanici_ad . ' ' . $admin->kullanici_soyad);\r\n\r\n                $konu = \"[TEST] GÃ¼nlÃ¼k CRM Raporu - \" . $tarih_formatted;\r\n\r\n                $this->rapor_gonder($admin->kullanici_eposta, $admin_adi, $konu, $rapor_html);\r\n\r\n                log_message('info', 'Test raporu gÃ¶nderildi: ' . $admin->kullanici_eposta);\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }    /**\r\n\r\n     * Genel MÃ¼dÃ¼r raporu gÃ¶nder - Hem Genel MÃ¼dÃ¼r hem BÃ¶lge MÃ¼dÃ¼r gruplarÄ±na\r\n\r\n     */\r\n\r\n    private function genel_mudur_raporu($tarih, $tarih_formatted)\r\n\r\n    {\r\n\r\n        log_message('info', 'Genel MÃ¼dÃ¼r raporu hazÄ±rlanÄ±yor (Genel+BÃ¶lge MÃ¼dÃ¼r gruplarÄ±na)');\r\n\r\n        \r\n\r\n        // Hem Genel MÃ¼dÃ¼r (grup_id = 7) hem de BÃ¶lge MÃ¼dÃ¼r (grup_id = 6) gruplarÄ±nÄ± al\r\n\r\n        $genel_mudurler = $this->vt->multiple('kullanicilar', ['grup_id' => 7, 'kullanici_durum' => 1]);\r\n\r\n        $bolge_mudurler = $this->vt->multiple('kullanicilar', ['grup_id' => 6, 'kullanici_durum' => 1]);\r\n\r\n        \r\n\r\n        // TÃ¼m alÄ±cÄ±larÄ± birleÅŸtir\r\n\r\n        $tum_alicilar = array_merge($genel_mudurler, $bolge_mudurler);\r\n\r\n        \r\n\r\n        if (empty($tum_alicilar)) {\r\n\r\n            log_message('warning', 'Genel MÃ¼dÃ¼r ve BÃ¶lge MÃ¼dÃ¼r bulunamadÄ±');\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        // Raporu hazÄ±rla\r\n\r\n        $rapor_html = $this->genel_mudur_rapor_hazirla($tarih, $tarih_formatted);\r\n\r\n        \r\n\r\n        // Her mÃ¼dÃ¼re gÃ¶nder\r\n\r\n        foreach ($tum_alicilar as $mudur) {\r\n\r\n            if (!empty($mudur->kullanici_eposta)) {\r\n\r\n                $mudur_adi = trim($mudur->kullanici_ad . ' ' . $mudur->kullanici_soyad);\r\n\r\n                $konu = \"GÃ¼nlÃ¼k CRM Raporu - \" . $tarih_formatted;\r\n\r\n                $this->rapor_gonder($mudur->kullanici_eposta, $mudur_adi, $konu, $rapor_html);\r\n\r\n                log_message('info', 'GÃ¼nlÃ¼k rapor gÃ¶nderildi: ' . $mudur->kullanici_eposta);\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }    /**\r\n\r\n     * BÃ¶lge MÃ¼dÃ¼rleri raporlarÄ±nÄ± gÃ¶nder\r\n\r\n     * ASKIYA ALINDI - Ä°leride kullanmak iÃ§in yorum satÄ±rÄ±nda tutuldu\r\n\r\n     */\r\n\r\n    /*\r\n\r\n    private function bolge_mudur_raporlari($tarih, $tarih_formatted)\r\n\r\n    {\r\n\r\n        log_message('info', 'BÃ¶lge MÃ¼dÃ¼r raporlarÄ± hazÄ±rlanÄ±yor');\r\n\r\n        \r\n\r\n        // BÃ¶lge MÃ¼dÃ¼rlerini al (grup_id = 6)\r\n\r\n        $bolge_mudurler = $this->vt->multiple('kullanicilar', ['grup_id' => 6, 'kullanici_durum' => 1]);\r\n\r\n        \r\n\r\n        if (empty($bolge_mudurler)) {\r\n\r\n            log_message('warning', 'BÃ¶lge MÃ¼dÃ¼rÃ¼ bulunamadÄ±');\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        foreach ($bolge_mudurler as $mudur) {\r\n\r\n            if (!empty($mudur->kullanici_eposta)) {\r\n\r\n                // Bu bÃ¶lge mÃ¼dÃ¼rÃ¼ ve astlarÄ±nÄ±n raporunu hazÄ±rla\r\n\r\n                $rapor_html = $this->bolge_mudur_rapor_hazirla($mudur->kullanici_id, $tarih, $tarih_formatted);\r\n\r\n                \r\n\r\n                $mudur_adi = trim($mudur->kullanici_ad . ' ' . $mudur->kullanici_soyad);\r\n\r\n                $konu = \"GÃ¼nlÃ¼k BÃ¶lge Raporu - \" . $tarih_formatted;\r\n\r\n                $this->rapor_gonder($mudur->kullanici_eposta, $mudur_adi, $konu, $rapor_html);\r\n\r\n                log_message('info', 'BÃ¶lge MÃ¼dÃ¼r raporu gÃ¶nderildi: ' . $mudur->kullanici_eposta);\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    *//**\r\n\r\n     * Genel MÃ¼dÃ¼r raporu HTML iÃ§eriÄŸini hazÄ±rla\r\n\r\n     */\r\n\r\n    private function genel_mudur_rapor_hazirla($tarih, $tarih_formatted)\r\n\r\n    {\r\n\r\n        // Genel_Mudur_Rapor.txt'den alÄ±nan kapsamlÄ± SQL sorgusu - 12 sÃ¼tunlu tam rapor\r\n\r\n        $sql = \"SELECT \r\n\r\n                    CONCAT(u.kullanici_ad, ' ', u.kullanici_soyad) as personel_adi,\r\n\r\n                    COALESCE(m.yeni_musteri_sayisi, 0) as toplam_musteri,\r\n\r\n                    CONCAT(COALESCE(sf.sozlesme_adedi, 0), ' (', FORMAT(COALESCE(sf.sozlesme_ciro, 0), 2), ' TL)') as satis_sozlesmesi,\r\n\r\n                    CONCAT(COALESCE(bh.tahsilat_adedi, 0), ' (', FORMAT(COALESCE(bh.tahsilat_toplam, 0), 2), ' TL)') as tahsilat_banka_pos,\r\n\r\n                    CONCAT(COALESCE(kh.nakit_adedi, 0), ' (', FORMAT(COALESCE(kh.nakit_toplam, 0), 2), ' TL)') as tahsilat_nakit,\r\n\r\n                    CONCAT(COALESCE(ck.cek_adedi, 0), ' (', FORMAT(COALESCE(ck.cek_toplam, 0), 2), ' TL)') as tahsilat_cek,\r\n\r\n                    COALESCE(p.yeni_potansiyel_sayisi, 0) as catkapi_musteri_sayisi,\r\n\r\n                    COALESCE(ps.iptal_isletme_yok, 0) as iptal_isletme_yok,\r\n\r\n                    COALESCE(ps.iptal_unvan_degismis, 0) as iptal_unvan_degismis,\r\n\r\n                    COALESCE(ps.iptal_istemiyor, 0) as iptal_istemiyor,\r\n\r\n                    COALESCE(ps.teklif_verildi, 0) as teklif_verildi,\r\n\r\n                    CONCAT(COALESCE(ps.satildi, 0), ' (', FORMAT(COALESCE(ps.satildi_tutar, 0), 2), ' TL)') as satildi_teklif\r\n\r\n                FROM kullanicilar u\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        cari_olusturan,\r\n\r\n                        COUNT(*) as yeni_musteri_sayisi\r\n\r\n                    FROM cari \r\n\r\n                    WHERE cari_olusturmaTarihi = ?\r\n\r\n                        AND cari_durum = 1\r\n\r\n                    GROUP BY cari_olusturan\r\n\r\n                ) m ON m.cari_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        satis_olusturan,\r\n\r\n                        COUNT(*) as sozlesme_adedi,\r\n\r\n                        SUM(satis_vergiDahilToplam) as sozlesme_ciro\r\n\r\n                    FROM satisFaturasi \r\n\r\n                    WHERE satis_faturaTarihi = ?\r\n\r\n                    GROUP BY satis_olusturan\r\n\r\n                ) sf ON sf.satis_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        bh_olusturan,\r\n\r\n                        COUNT(*) as tahsilat_adedi,\r\n\r\n                        SUM(bh_giris) as tahsilat_toplam\r\n\r\n                    FROM bankaHareketleri \r\n\r\n                    WHERE bh_olusturmaTarihi = ?\r\n\r\n                        AND bh_giris > 0\r\n\r\n                    GROUP BY bh_olusturan\r\n\r\n                ) bh ON bh.bh_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        kh_olusturan,\r\n\r\n                        COUNT(*) as nakit_adedi,\r\n\r\n                        SUM(kh_giris) as nakit_toplam\r\n\r\n                    FROM kasaHareketleri \r\n\r\n                    WHERE kh_olusturmaTarihi = ?\r\n\r\n                        AND kh_giris > 0\r\n\r\n                    GROUP BY kh_olusturan\r\n\r\n                ) kh ON kh.kh_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        cek_kullaniciID,\r\n\r\n                        COUNT(*) as cek_adedi,\r\n\r\n                        SUM(cek_tutar) as cek_toplam\r\n\r\n                    FROM cek \r\n\r\n                    WHERE cek_sistemKayitTarihi = ?\r\n\r\n                        AND cek_tutar > 0\r\n\r\n                    GROUP BY cek_kullaniciID\r\n\r\n                ) ck ON ck.cek_kullaniciID = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        olusturan_kullanici,\r\n\r\n                        COUNT(*) as yeni_potansiyel_sayisi\r\n\r\n                    FROM potansiyel_cari \r\n\r\n                    WHERE DATE(olusturma_zamani) = ?\r\n\r\n                    GROUP BY olusturan_kullanici\r\n\r\n                ) p ON p.olusturan_kullanici = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        islemi_yapan,\r\n\r\n                        SUM(CASE WHEN durum_id = 1 THEN 1 ELSE 0 END) as iptal_isletme_yok,\r\n\r\n                        SUM(CASE WHEN durum_id = 2 THEN 1 ELSE 0 END) as iptal_unvan_degismis,\r\n\r\n                        SUM(CASE WHEN durum_id = 3 THEN 1 ELSE 0 END) as iptal_istemiyor,\r\n\r\n                        SUM(CASE WHEN durum_id = 4 THEN 1 ELSE 0 END) as teklif_verildi,\r\n\r\n                        SUM(CASE WHEN durum_id = 5 THEN 1 ELSE 0 END) as satildi,\r\n\r\n                        SUM(CASE WHEN durum_id = 5 THEN fiyat1 ELSE 0 END) as satildi_tutar\r\n\r\n                    FROM potansiyel_satis \r\n\r\n                    WHERE DATE(islem_tarihi) = ?\r\n\r\n                    GROUP BY islemi_yapan\r\n\r\n                ) ps ON ps.islemi_yapan = u.kullanici_id\r\n\r\n                WHERE u.kullanici_durum = 1\r\n\r\n                ORDER BY COALESCE(m.yeni_musteri_sayisi, 0) DESC\";\r\n\r\n        \r\n\r\n        $query = $this->db->query($sql, [$tarih, $tarih, $tarih, $tarih, $tarih, $tarih, $tarih]);\r\n\r\n        $sonuclar = $query->result();\r\n\r\n        \r\n\r\n        // Debug: SQL ve sonuÃ§larÄ± logla\r\n\r\n        log_message('info', 'GÃ¼nlÃ¼k rapor SQL Ã§alÄ±ÅŸtÄ±rÄ±ldÄ± - SonuÃ§ sayÄ±sÄ±: ' . count($sonuclar));\r\n\r\n        log_message('info', 'SQL sorgusu: ' . $this->db->last_query());\r\n\r\n        \r\n\r\n        return $this->rapor_html_olustur($sonuclar, '', $tarih_formatted);\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n    /**\r\n\r\n     * BÃ¶lge MÃ¼dÃ¼r raporu HTML iÃ§eriÄŸini hazÄ±rla\r\n\r\n     */\r\n\r\n    \r\n\r\n    /**\r\n\r\n     * BÃ¶lge MÃ¼dÃ¼r raporu HTML iÃ§eriÄŸini hazÄ±rla\r\n\r\n     * ASKIYA ALINDI - Ä°leride kullanmak iÃ§in yorum satÄ±rÄ±nda tutuldu\r\n\r\n     */\r\n\r\n    /*\r\n\r\n    private function bolge_mudur_rapor_hazirla($mudur_id, $tarih, $tarih_formatted)\r\n\r\n    {\r\n\r\n        // Bu mÃ¼dÃ¼r ve astlarÄ±nÄ±n ID'lerini al\r\n\r\n        $kullanici_ids = [$mudur_id];\r\n\r\n          // AstlarÄ±nÄ± bul (kullanici_sorumluMudur = $mudur_id)\r\n\r\n        $astlar = $this->vt->multiple('kullanicilar', ['kullanici_sorumluMudur' => $mudur_id, 'kullanici_durum' => 1]);\r\n\r\n        foreach ($astlar as $ast) {\r\n\r\n            $kullanici_ids[] = $ast->kullanici_id;\r\n\r\n        }\r\n\r\n          $kullanici_ids_str = implode(',', $kullanici_ids);\r\n\r\n          // DÃœZELTILMIÅ SQL sorgusu - Genel MÃ¼dÃ¼r raporu ile aynÄ± format (12 sÃ¼tun)\r\n\r\n        $sql = \"SELECT \r\n\r\n                    CONCAT(u.kullanici_ad, ' ', u.kullanici_soyad) as personel_adi,\r\n\r\n                    COALESCE(m.yeni_musteri_sayisi, 0) as toplam_musteri,\r\n\r\n                    CONCAT(COALESCE(sf.sozlesme_adedi, 0), ' (', FORMAT(COALESCE(sf.sozlesme_ciro, 0), 2), ' TL)') as satis_sozlesmesi,\r\n\r\n                    CONCAT(COALESCE(bh.tahsilat_adedi, 0), ' (', FORMAT(COALESCE(bh.tahsilat_toplam, 0), 2), ' TL)') as tahsilat_banka_pos,\r\n\r\n                    CONCAT(COALESCE(kh.nakit_adedi, 0), ' (', FORMAT(COALESCE(kh.nakit_toplam, 0), 2), ' TL)') as tahsilat_nakit,\r\n\r\n                    CONCAT(COALESCE(ck.cek_adedi, 0), ' (', FORMAT(COALESCE(ck.cek_toplam, 0), 2), ' TL)') as tahsilat_cek,\r\n\r\n                    COALESCE(p.yeni_potansiyel_sayisi, 0) as catkapi_musteri_sayisi,\r\n\r\n                    COALESCE(ps.iptal_isletme_yok, 0) as iptal_isletme_yok,\r\n\r\n                    COALESCE(ps.iptal_unvan_degismis, 0) as iptal_unvan_degismis,\r\n\r\n                    COALESCE(ps.iptal_istemiyor, 0) as iptal_istemiyor,\r\n\r\n                    COALESCE(ps.teklif_verildi, 0) as teklif_verildi,\r\n\r\n                    CONCAT(COALESCE(ps.satildi, 0), ' (', FORMAT(COALESCE(ps.satildi_tutar, 0), 2), ' TL)') as satildi_teklif\r\n\r\n                FROM kullanicilar u\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        cari_olusturan,\r\n\r\n                        COUNT(*) as yeni_musteri_sayisi\r\n\r\n                    FROM cari \r\n\r\n                    WHERE cari_olusturmaTarihi = ? AND cari_olusturan IN ($kullanici_ids_str)\r\n\r\n                        AND cari_durum = 1\r\n\r\n                    GROUP BY cari_olusturan\r\n\r\n                ) m ON m.cari_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        olusturan_kullanici,\r\n\r\n                        COUNT(*) as yeni_potansiyel_sayisi\r\n\r\n                    FROM potansiyel_cari \r\n\r\n                    WHERE DATE(olusturma_zamani) = ? AND olusturan_kullanici IN ($kullanici_ids_str)\r\n\r\n                    GROUP BY olusturan_kullanici\r\n\r\n                ) p ON p.olusturan_kullanici = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        satis_olusturan,\r\n\r\n                        COUNT(*) as sozlesme_adedi,\r\n\r\n                        SUM(satis_vergiDahilToplam) as sozlesme_ciro\r\n\r\n                    FROM satisFaturasi \r\n\r\n                    WHERE satis_faturaTarihi = ? AND satis_olusturan IN ($kullanici_ids_str)\r\n\r\n                    GROUP BY satis_olusturan\r\n\r\n                ) sf ON sf.satis_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        bh_olusturan,\r\n\r\n                        COUNT(*) as tahsilat_adedi,\r\n\r\n                        SUM(bh_giris) as tahsilat_toplam\r\n\r\n                    FROM bankaHareketleri \r\n\r\n                    WHERE bh_olusturmaTarihi = ? AND bh_olusturan IN ($kullanici_ids_str)\r\n\r\n                        AND bh_giris > 0\r\n\r\n                    GROUP BY bh_olusturan\r\n\r\n                ) bh ON bh.bh_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        kh_olusturan,\r\n\r\n                        COUNT(*) as nakit_adedi,\r\n\r\n                        SUM(kh_giris) as nakit_toplam\r\n\r\n                    FROM kasaHareketleri \r\n\r\n                    WHERE kh_olusturmaTarihi = ? AND kh_olusturan IN ($kullanici_ids_str)\r\n\r\n                        AND kh_giris > 0\r\n\r\n                    GROUP BY kh_olusturan\r\n\r\n                ) kh ON kh.kh_olusturan = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        cek_kullaniciID,\r\n\r\n                        COUNT(*) as cek_adedi,\r\n\r\n                        SUM(cek_tutar) as cek_toplam\r\n\r\n                    FROM cek \r\n\r\n                    WHERE cek_sistemKayitTarihi = ? AND cek_kullaniciID IN ($kullanici_ids_str)\r\n\r\n                        AND cek_tutar > 0\r\n\r\n                    GROUP BY cek_kullaniciID\r\n\r\n                ) ck ON ck.cek_kullaniciID = u.kullanici_id\r\n\r\n                LEFT JOIN (\r\n\r\n                    SELECT \r\n\r\n                        islemi_yapan,\r\n\r\n                        SUM(CASE WHEN durum_id = 1 THEN 1 ELSE 0 END) as iptal_isletme_yok,\r\n\r\n                        SUM(CASE WHEN durum_id = 2 THEN 1 ELSE 0 END) as iptal_unvan_degismis,\r\n\r\n                        SUM(CASE WHEN durum_id = 3 THEN 1 ELSE 0 END) as iptal_istemiyor,\r\n\r\n                        SUM(CASE WHEN durum_id = 4 THEN 1 ELSE 0 END) as teklif_verildi,\r\n\r\n                        SUM(CASE WHEN durum_id = 5 THEN 1 ELSE 0 END) as satildi,\r\n\r\n                        SUM(CASE WHEN durum_id = 5 THEN fiyat1 ELSE 0 END) as satildi_tutar\r\n\r\n                    FROM potansiyel_satis \r\n\r\n                    WHERE DATE(islem_tarihi) = ? AND islemi_yapan IN ($kullanici_ids_str)\r\n\r\n                    GROUP BY islemi_yapan\r\n\r\n                ) ps ON ps.islemi_yapan = u.kullanici_id\r\n\r\n                WHERE u.kullanici_durum = 1 AND u.kullanici_id IN ($kullanici_ids_str)\r\n\r\n                ORDER BY COALESCE(sf.sozlesme_ciro, 0) DESC\";        \r\n\r\n        $query = $this->db->query($sql, [$tarih, $tarih, $tarih, $tarih, $tarih, $tarih, $tarih]);\r\n\r\n        $sonuclar = $query->result();\r\n\r\n        \r\n\r\n        return $this->rapor_html_olustur($sonuclar, 'BÃ¶lge MÃ¼dÃ¼r Raporu', $tarih_formatted);\r\n\r\n    }\r\n\r\n    */\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Rapor HTML tablosunu oluÅŸtur\r\n\r\n    /**\r\n\r\n     * HTML rapor tablosu oluÅŸtur\r\n\r\n     */\r\n\r\n    private function rapor_html_olustur($sonuclar, $rapor_tipi, $tarih_formatted)\r\n\r\n    {\r\n\r\n        // Debug: HTML oluÅŸturma baÅŸlangÄ±cÄ±\r\n\r\n        log_message('info', 'HTML rapor oluÅŸturuluyor - SonuÃ§ sayÄ±sÄ±: ' . count($sonuclar));\r\n\r\n        if (!empty($sonuclar)) {\r\n\r\n            $first_result = $sonuclar[0];\r\n\r\n            log_message('info', 'Ä°lk sonuÃ§ alanlarÄ±: ' . implode(', ', array_keys((array)$first_result)));\r\n\r\n        }\r\n\r\n        \r\n\r\n        $html = \"\r\n\r\n        <!DOCTYPE html>\r\n\r\n        <html>\r\n\r\n        <head>\r\n\r\n            <meta charset='UTF-8'>\r\n\r\n            <style>\r\n\r\n                body { font-family: Arial, sans-serif; margin: 20px; }\r\n\r\n                .header { background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }\r\n\r\n                .header h2 { color: #343a40; margin: 0; }\r\n\r\n                .header p { color: #6c757d; margin: 5px 0 0 0; }\r\n\r\n                table { border-collapse: collapse; width: 100%; margin-top: 10px; }\r\n\r\n                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\r\n\r\n                th { background-color: #f2f2f2; font-weight: bold; }\r\n\r\n                tr:nth-child(even) { background-color: #f9f9f9; }\r\n\r\n                .number { text-align: right; }\r\n\r\n                .positive-value { background-color: #6d3eca; color: white; font-weight: bold; padding: 4px 8px; border-radius: 4px; }\r\n\r\n                .footer { margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px; font-size: 12px; color: #6c757d; }\r\n\r\n            </style>\r\n\r\n        </head>\r\n\r\n        <body>\";\r\n\r\n        \r\n\r\n        // Sadece rapor tipi boÅŸ deÄŸilse baÅŸlÄ±k gÃ¶ster\r\n\r\n        if (!empty($rapor_tipi)) {\r\n\r\n            $html .= \"\r\n\r\n            <div class='header'>\r\n\r\n                <h2>$rapor_tipi</h2>\r\n\r\n                <p>Tarih: $tarih_formatted</p>\r\n\r\n                <p>OluÅŸturulma: \" . date('d.m.Y H:i:s') . \"</p>\r\n\r\n            </div>\";\r\n\r\n        } else {\r\n\r\n            $html .= \"\r\n\r\n            <div class='header'>\r\n\r\n                <p>Tarih: $tarih_formatted</p>\r\n\r\n                <p>OluÅŸturulma: \" . date('d.m.Y H:i:s') . \"</p>\r\n\r\n            </div>\";\r\n\r\n        }\r\n\r\n        \r\n\r\n        $html .= \"\r\n\r\n            <table>\r\n\r\n                <thead>\r\n\r\n                    <tr>\r\n\r\n                        <th>Personel AdÄ±</th>\r\n\r\n                        <th>Toplam MÃ¼ÅŸteri</th>\r\n\r\n                        <th>SatÄ±ÅŸ SÃ¶zleÅŸmesi</th>\r\n\r\n                        <th>Tahsilat-Banka/Pos</th>\r\n\r\n                        <th>Tahsilat-Nakit</th>\r\n\r\n                        <th>Tahsilat-Ã‡ek</th>\r\n\r\n                        <th>Ã‡atKapÄ± MÃ¼ÅŸteri</th>\r\n\r\n                        <th>Ä°ptal-Ä°ÅŸletme Yok</th>\r\n\r\n                        <th>Ä°ptal-Ãœnvan DeÄŸiÅŸmiÅŸ</th>\r\n\r\n                        <th>Ä°ptal-Ä°stemiyor</th>\r\n\r\n                        <th>Teklif Verildi</th>\r\n\r\n                        <th>SatÄ±ldÄ± (Teklif)</th>\r\n\r\n                    </tr>\r\n\r\n                </thead>\r\n\r\n                <tbody>\";\r\n\r\n        \r\n\r\n        if (empty($sonuclar)) {\r\n\r\n            $html .= \"<tr><td colspan='12' style='text-align: center; color: #6c757d;'>Bu tarih iÃ§in veri bulunamadÄ±.</td></tr>\";\r\n\r\n        } else {\r\n\r\n            foreach ($sonuclar as $satir) {\r\n\r\n                $html .= \"<tr>\";\r\n\r\n                $html .= \"<td>\" . htmlspecialchars($satir->personel_adi) . \"</td>\";\r\n\r\n                \r\n\r\n                // SayÄ±sal deÄŸerleri kontrol et ve 0'dan bÃ¼yÃ¼kse vurgula\r\n\r\n                $toplam_musteri = intval($satir->toplam_musteri);\r\n\r\n                $catkapi_musteri = intval($satir->catkapi_musteri_sayisi);\r\n\r\n                $iptal_isletme = intval($satir->iptal_isletme_yok);\r\n\r\n                $iptal_unvan = intval($satir->iptal_unvan_degismis);\r\n\r\n                $iptal_istemiyor = intval($satir->iptal_istemiyor);\r\n\r\n                $teklif_verildi = intval($satir->teklif_verildi);\r\n\r\n                \r\n\r\n                // SÃ¶zleÅŸme sayÄ±sÄ±nÄ± al (parantez iÃ§indeki sayÄ±dan)\r\n\r\n                $satis_sozlesmesi_parts = explode(' (', $satir->satis_sozlesmesi);\r\n\r\n                $sozlesme_sayisi = intval($satis_sozlesmesi_parts[0]);\r\n\r\n                \r\n\r\n                // Tahsilat sayÄ±larÄ±nÄ± al\r\n\r\n                $tahsilat_banka_parts = explode(' (', $satir->tahsilat_banka_pos);\r\n\r\n                $tahsilat_banka_sayisi = intval($tahsilat_banka_parts[0]);\r\n\r\n                \r\n\r\n                $tahsilat_nakit_parts = explode(' (', $satir->tahsilat_nakit);\r\n\r\n                $tahsilat_nakit_sayisi = intval($tahsilat_nakit_parts[0]);\r\n\r\n                \r\n\r\n                $tahsilat_cek_parts = explode(' (', $satir->tahsilat_cek);\r\n\r\n                $tahsilat_cek_sayisi = intval($tahsilat_cek_parts[0]);\r\n\r\n                \r\n\r\n                // SatÄ±ldÄ± teklif sayÄ±sÄ±nÄ± al\r\n\r\n                $satildi_teklif_parts = explode(' (', $satir->satildi_teklif);\r\n\r\n                $satildi_sayisi = intval($satildi_teklif_parts[0]);\r\n\r\n                \r\n\r\n                $html .= \"<td class='number\" . ($toplam_musteri > 0 ? \" positive-value\" : \"\") . \"'>\" . number_format($toplam_musteri) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($sozlesme_sayisi > 0 ? \" positive-value\" : \"\") . \"'>\" . htmlspecialchars($satir->satis_sozlesmesi) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($tahsilat_banka_sayisi > 0 ? \" positive-value\" : \"\") . \"'>\" . htmlspecialchars($satir->tahsilat_banka_pos) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($tahsilat_nakit_sayisi > 0 ? \" positive-value\" : \"\") . \"'>\" . htmlspecialchars($satir->tahsilat_nakit) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($tahsilat_cek_sayisi > 0 ? \" positive-value\" : \"\") . \"'>\" . htmlspecialchars($satir->tahsilat_cek) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($catkapi_musteri > 0 ? \" positive-value\" : \"\") . \"'>\" . number_format($catkapi_musteri) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($iptal_isletme > 0 ? \" positive-value\" : \"\") . \"'>\" . number_format($iptal_isletme) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($iptal_unvan > 0 ? \" positive-value\" : \"\") . \"'>\" . number_format($iptal_unvan) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($iptal_istemiyor > 0 ? \" positive-value\" : \"\") . \"'>\" . number_format($iptal_istemiyor) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($teklif_verildi > 0 ? \" positive-value\" : \"\") . \"'>\" . number_format($teklif_verildi) . \"</td>\";\r\n\r\n                $html .= \"<td class='number\" . ($satildi_sayisi > 0 ? \" positive-value\" : \"\") . \"'>\" . htmlspecialchars($satir->satildi_teklif) . \"</td>\";\r\n\r\n                $html .= \"</tr>\";\r\n\r\n            }\r\n\r\n        }\r\n\r\n        \r\n\r\n        $html .= \"\r\n\r\n                </tbody>\r\n\r\n            </table>\r\n\r\n            \r\n\r\n            <div class='footer'>\r\n\r\n                Bu rapor otomatik olarak oluÅŸturulmuÅŸtur - Ä°leka Soft CRM Sistemi<br>\r\n\r\n                Bu e-postayÄ± yanÄ±tlamayÄ±n. SorularÄ±nÄ±z iÃ§in destek ekibimizle iletiÅŸime geÃ§in.\r\n\r\n            </div>\r\n\r\n        </body>\r\n\r\n        </html>\";\r\n\r\n        \r\n\r\n        // Debug: HTML iÃ§eriÄŸini logla\r\n\r\n        log_message('info', 'HTML rapor iÃ§eriÄŸi (ilk 500 karakter): ' . substr($html, 0, 500));\r\n\r\n        \r\n\r\n        return $html;    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * E-posta gÃ¶nder\r\n\r\n     */\r\n\r\n    private function rapor_gonder($email, $isim, $konu, $html_icerik)\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            // Email library'yi yÃ¼kle\r\n\r\n            $this->load->library('email');\r\n\r\n            \r\n\r\n            // Debug iÃ§in web'de gÃ¶ster\r\n\r\n            if (!$this->input->is_cli_request()) {\r\n\r\n                echo \"<div style='background: #e3f2fd; padding: 10px; border: 1px solid #2196f3; margin: 10px 0;'>\";\r\n\r\n                echo \"<h4>ğŸ“§ Email GÃ¶nderim DetaylarÄ±:</h4>\";\r\n\r\n                echo \"<p><strong>AlÄ±cÄ±:</strong> {$email}</p>\";\r\n\r\n                echo \"<p><strong>Ä°sim:</strong> {$isim}</p>\";\r\n\r\n                echo \"<p><strong>Konu:</strong> {$konu}</p>\";\r\n\r\n                echo \"<p><strong>Zaman:</strong> \" . date('Y-m-d H:i:s') . \"</p>\";\r\n\r\n                echo \"<p><strong>SMTP Server:</strong> smtp.gmail.com:465 (SSL)</p>\";\r\n\r\n                echo \"<p><strong>Sender:</strong> noreply@turkbelge.com.tr</p>\";\r\n\r\n                echo \"</div>\";\r\n\r\n            }\r\n\r\n            \r\n\r\n            // E-posta ayarlarÄ± - Gmail SMTP (CodeIgniter iÃ§in optimize)\r\n\r\n            $config = [\r\n\r\n                'protocol' => 'smtp',\r\n\r\n                'smtp_host' => 'smtp.gmail.com',\r\n\r\n                'smtp_port' => 465,\r\n\r\n                'smtp_user' => 'noreply@turkbelge.com.tr',\r\n\r\n                'smtp_pass' => 'tbfm ybso mzjp eave',\r\n\r\n                'smtp_crypto' => 'ssl',\r\n\r\n                'smtp_timeout' => 30,\r\n\r\n                'mailtype' => 'html',\r\n\r\n                'charset' => 'utf-8',\r\n\r\n                'newline' => \"\\r\\n\",\r\n\r\n                'crlf' => \"\\r\\n\",\r\n\r\n                'wordwrap' => true,\r\n\r\n                'validate' => false,\r\n\r\n                'priority' => 3,\r\n\r\n                'bcc_batch_mode' => false,\r\n\r\n                'bcc_batch_size' => 200\r\n\r\n            ];\r\n\r\n            \r\n\r\n            $this->email->initialize($config);\r\n\r\n            $this->email->clear();\r\n\r\n            \r\n\r\n            $this->email->from('noreply@turkbelge.com.tr', 'IlekaSoft CRM Sistemi');\r\n\r\n            $this->email->to($email);\r\n\r\n            $this->email->subject($konu);\r\n\r\n            $this->email->message($html_icerik);\r\n\r\n            \r\n\r\n            // Debug: Email iÃ§eriÄŸini logla\r\n\r\n            log_message('info', 'Email gÃ¶nderimi - AlÄ±cÄ±: ' . $email . ', Ä°Ã§erik uzunluÄŸu: ' . strlen($html_icerik) . ' karakter');\r\n\r\n            log_message('info', 'Email HTML iÃ§eriÄŸi (ilk 1000 karakter): ' . substr($html_icerik, 0, 1000));\r\n\r\n            \r\n\r\n            // Email gÃ¶ndermeyi dene\r\n\r\n            $gonderim_sonucu = $this->email->send();\r\n\r\n            \r\n\r\n            if ($gonderim_sonucu) {\r\n\r\n                log_message('info', \"E-posta baÅŸarÄ±yla gÃ¶nderildi: $email\");\r\n\r\n                \r\n\r\n                // Debug iÃ§in web'de gÃ¶ster\r\n\r\n                if (!$this->input->is_cli_request()) {\r\n\r\n                    echo \"<div style='background: #e8f5e8; padding: 10px; border: 1px solid #4caf50; margin: 10px 0;'>\";\r\n\r\n                    echo \"<h4>âœ… Email BaÅŸarÄ±yla GÃ¶nderildi!</h4>\";\r\n\r\n                    echo \"<p>AlÄ±cÄ±: {$email}</p>\";\r\n\r\n                    echo \"<p>GÃ¶nderim Saati: \" . date('Y-m-d H:i:s') . \"</p>\";\r\n\r\n                    echo \"<p>SMTP Response: Email sent successfully</p>\";\r\n\r\n                    echo \"</div>\";\r\n\r\n                    \r\n\r\n                    // Email debug Ã§Ä±ktÄ±sÄ±nÄ± gÃ¶ster\r\n\r\n                    echo \"<div style='background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #ccc;'>\";\r\n\r\n                    echo \"<h5>ğŸ“§ SMTP Debug Ã‡Ä±ktÄ±sÄ±:</h5>\";\r\n\r\n                    echo \"<pre>\" . htmlspecialchars($this->email->print_debugger()) . \"</pre>\";\r\n\r\n                    echo \"</div>\";\r\n\r\n                }\r\n\r\n                return true;\r\n\r\n            } else {\r\n\r\n                $error = $this->email->print_debugger();\r\n\r\n                log_message('error', \"E-posta gÃ¶nderim hatasÄ± ($email): $error\");\r\n\r\n                \r\n\r\n                // Debug iÃ§in web'de de gÃ¶ster\r\n\r\n                if (!$this->input->is_cli_request()) {\r\n\r\n                    echo \"<div style='background: #ffebee; padding: 10px; border: 1px solid #f44336; margin: 10px 0;'>\";\r\n\r\n                    echo \"<h4>âŒ E-posta GÃ¶nderim HatasÄ±:</h4>\";\r\n\r\n                    echo \"<p><strong>AlÄ±cÄ±:</strong> {$email}</p>\";\r\n\r\n                    echo \"<p><strong>SMTP Response:</strong> Email send failed</p>\";\r\n\r\n                    echo \"</div>\";\r\n\r\n                    \r\n\r\n                    // Email hata Ã§Ä±ktÄ±sÄ±nÄ± gÃ¶ster\r\n\r\n                    echo \"<div style='background: #ffebee; padding: 10px; margin: 10px 0; border: 1px solid #f44336;'>\";\r\n\r\n                    echo \"<h5>ğŸš« SMTP Hata DetaylarÄ±:</h5>\";\r\n\r\n                    echo \"<pre>\" . htmlspecialchars($error) . \"</pre>\";\r\n\r\n                    echo \"</div>\";\r\n\r\n                }\r\n\r\n                return false;\r\n\r\n            }\r\n\r\n              } catch (Exception $e) {\r\n\r\n            log_message('error', \"E-posta gÃ¶nderim exception ($email): \" . $e->getMessage());\r\n\r\n            \r\n\r\n            // Debug iÃ§in web'de gÃ¶ster\r\n\r\n            if (!$this->input->is_cli_request()) {\r\n\r\n                echo \"<div style='background: #ffebee; padding: 10px; border: 1px solid #f44336; margin: 10px 0;'>\";\r\n\r\n                echo \"<h4>âŒ E-posta Exception HatasÄ±:</h4>\";\r\n\r\n                echo \"<p><strong>AlÄ±cÄ±:</strong> {$email}</p>\";\r\n\r\n                echo \"<p><strong>Hata:</strong> \" . htmlspecialchars($e->getMessage()) . \"</p>\";\r\n\r\n                echo \"<p><strong>Dosya:</strong> \" . $e->getFile() . \"</p>\";\r\n\r\n                echo \"<p><strong>SatÄ±r:</strong> \" . $e->getLine() . \"</p>\";\r\n\r\n                echo \"</div>\";\r\n\r\n            }\r\n\r\n            return false;\r\n\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    /**\r\n\r\n     * Hata durumunda admin grubuna bildirim gÃ¶nder\r\n\r\n     */\r\n\r\n    private function hata_bildirimi($hata_mesaji)\r\n\r\n    {\r\n\r\n        try {\r\n\r\n            $adminler = $this->vt->multiple('kullanicilar', ['grup_id' => 1, 'kullanici_durum' => 1]);\r\n\r\n            \r\n\r\n            $html = \"\r\n\r\n            <h3>CRM GÃ¼nlÃ¼k Rapor Sistemi HatasÄ±</h3>\r\n\r\n            <p><strong>Tarih:</strong> \" . date('d.m.Y H:i:s') . \"</p>\r\n\r\n            <p><strong>Hata:</strong> \" . htmlspecialchars($hata_mesaji) . \"</p>\r\n\r\n            <p>LÃ¼tfen sistemi kontrol edin ve gerekli mÃ¼dahaleyi yapÄ±n.</p>\r\n\r\n            \";            foreach ($adminler as $admin) {\r\n\r\n                if (!empty($admin->kullanici_eposta)) {\r\n\r\n                    $admin_adi = trim($admin->kullanici_ad . ' ' . $admin->kullanici_soyad);\r\n\r\n                    $this->rapor_gonder(\r\n\r\n                        $admin->kullanici_eposta, \r\n\r\n                        $admin_adi,\r\n\r\n                        'CRM Rapor Sistemi HatasÄ± - ' . date('d.m.Y'),\r\n\r\n                        $html\r\n\r\n                    );\r\n\r\n                }\r\n\r\n            }\r\n\r\n            \r\n\r\n        } catch (Exception $e) {\r\n\r\n            log_message('error', 'Hata bildirimi gÃ¶nderilemedi: ' . $e->getMessage());\r\n\r\n        }\r\n\r\n    }    /**\r\n\r\n     * Manuel test iÃ§in - Sadece Admin kullanÄ±cÄ±larÄ± eriÅŸebilir\r\n\r\n     */\r\n\r\n    public function test()\r\n\r\n    {\r\n\r\n        // Header.php'deki gibi session kontrolÃ¼\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        if (!$control2) {\r\n\r\n            echo \"<h3>EriÅŸim Reddedildi</h3>\";\r\n\r\n            echo \"<p style='color: red;'>Session bulunamadÄ± - Login olun</p>\";\r\n\r\n            echo \"<p><a href='\" . base_url() . \"giris'>Login SayfasÄ±na Git</a></p>\";\r\n\r\n            return;\r\n\r\n        }\r\n\r\n          // Admin yetki kontrolÃ¼\r\n\r\n        $user_id = $control2->kullanici_id;\r\n\r\n        $user_info = $this->db->query(\"SELECT grup_id FROM kullanicilar WHERE kullanici_id = ?\", [$user_id])->row();\r\n\r\n        \r\n\r\n        if (!$user_info || $user_info->grup_id != 1) {\r\n\r\n            echo \"<h3>EriÅŸim Reddedildi</h3>\";\r\n\r\n            echo \"<p style='color: red;'>Bu sayfaya sadece Admin kullanÄ±cÄ±larÄ± eriÅŸebilir.</p>\";\r\n\r\n            echo \"<p>KullanÄ±cÄ± ID: $user_id</p>\";\r\n\r\n            echo \"<p>KullanÄ±cÄ± Grup ID: \" . ($user_info ? $user_info->grup_id : 'BulunamadÄ±') . \"</p>\";\r\n\r\n            echo \"<p><a href='\" . base_url() . \"rapor/debug'>Debug SayfasÄ±na Git</a></p>\";\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        echo \"<h3>GÃ¼nlÃ¼k Rapor Test</h3>\";\r\n\r\n        echo \"<p style='color: green;'>âœ“ Admin kullanÄ±cÄ± onaylandÄ±. Test baÅŸlatÄ±lÄ±yor...</p>\";\r\n\r\n        echo \"<p>KullanÄ±cÄ± ID: $user_id</p>\";\r\n\r\n        echo \"<p>KullanÄ±cÄ± Grup ID: \" . $user_info->grup_id . \"</p>\";\r\n\r\n        \r\n\r\n        // Email ayarlarÄ±nÄ± gÃ¶ster\r\n\r\n        echo \"<hr><h4>ğŸ“§ Email KonfigÃ¼rasyonu:</h4>\";\r\n\r\n        echo \"<p><strong>SMTP Host:</strong> smtp.gmail.com</p>\";\r\n\r\n        echo \"<p><strong>SMTP Port:</strong> 465 (SSL)</p>\";\r\n\r\n        echo \"<p><strong>GÃ¶nderen:</strong> noreply@turkbelge.com.tr</p>\";\r\n\r\n        echo \"<p><strong>GÃ¶nderen AdÄ±:</strong> IlekaSoft CRM Sistemi</p>\";\r\n\r\n        \r\n\r\n        // Admin kullanÄ±cÄ±larÄ±nÄ± gÃ¶ster\r\n\r\n        $adminler = $this->vt->multiple('kullanicilar', ['grup_id' => 1, 'kullanici_durum' => 1]);\r\n\r\n        echo \"<hr><h4>ğŸ‘¥ Admin KullanÄ±cÄ±larÄ± (AlÄ±cÄ±lar):</h4>\";\r\n\r\n        if (empty($adminler)) {\r\n\r\n            echo \"<p style='color: red;'>âŒ Admin kullanÄ±cÄ± bulunamadÄ±!</p>\";\r\n\r\n        } else {            echo \"<ul>\";\r\n\r\n            foreach ($adminler as $admin) {\r\n\r\n                $admin_adi = trim($admin->kullanici_ad . ' ' . $admin->kullanici_soyad);\r\n\r\n                $email_status = !empty($admin->kullanici_eposta) ? \"âœ…\" : \"âŒ Email boÅŸ\";\r\n\r\n                echo \"<li><strong>{$admin_adi}</strong> - {$admin->kullanici_eposta} {$email_status}</li>\";\r\n\r\n            }\r\n\r\n            echo \"</ul>\";\r\n\r\n        }\r\n\r\n        \r\n\r\n        echo \"<hr>\";\r\n\r\n        \r\n\r\n        try {\r\n\r\n            $this->gunluk_rapor();\r\n\r\n            echo \"<p style='color: green;'>âœ“ Test tamamlandÄ±</p>\";\r\n\r\n        } catch (Exception $e) {\r\n\r\n            echo \"<p style='color: red;'>âœ— Test hatasÄ±: \" . $e->getMessage() . \"</p>\";\r\n\r\n            echo \"<p>Stack trace:</p>\";\r\n\r\n            echo \"<pre>\" . $e->getTraceAsString() . \"</pre>\";\r\n\r\n        }\r\n\r\n    }\r\n\r\n      /**\r\n\r\n     * KullanÄ±cÄ± bilgilerini kontrol et\r\n\r\n     */\r\n\r\n    public function debug()\r\n\r\n    {\r\n\r\n        echo \"<h3>KullanÄ±cÄ± Debug Bilgileri</h3>\";\r\n\r\n        \r\n\r\n        // Header.php'deki gibi session kontrolÃ¼\r\n\r\n        $control2 = session(\"r\", \"login_info\");\r\n\r\n        if (!$control2) {\r\n\r\n            echo \"<p style='color: red;'>Session bulunamadÄ± (login_info) - Login olun</p>\";\r\n\r\n            echo \"<p>Kontrol edilen session key: 'login_info'</p>\";\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        \r\n\r\n        echo \"<p style='color: green;'>âœ“ Session bulundu</p>\";        echo \"<p>Session User ID: \" . $control2->kullanici_id . \"</p>\";\r\n\r\n        echo \"<p>Session Email: \" . $control2->kullanici_eposta . \"</p>\";\r\n\r\n        echo \"<p>Session Grup ID: \" . $control2->grup_id . \"</p>\";\r\n\r\n        \r\n\r\n        // KullanÄ±cÄ± bilgilerini veritabanÄ±ndan da al\r\n\r\n        $user_info = $this->db->query(\"SELECT * FROM kullanicilar WHERE kullanici_id = ?\", [$control2->kullanici_id])->row();\r\n\r\n          if ($user_info) {\r\n\r\n            echo \"<h4>VeritabanÄ± KullanÄ±cÄ± Bilgileri:</h4>\";\r\n\r\n            echo \"<p>ID: \" . $user_info->kullanici_id . \"</p>\";\r\n\r\n            echo \"<p>Ad: \" . $user_info->kullanici_ad . \" \" . $user_info->kullanici_soyad . \"</p>\";\r\n\r\n            echo \"<p>Email: \" . $user_info->kullanici_eposta . \"</p>\";\r\n\r\n            echo \"<p>Grup ID: \" . $user_info->grup_id . \"</p>\";\r\n\r\n            \r\n\r\n            // Grup adÄ±nÄ± al\r\n\r\n            if ($user_info->grup_id) {\r\n\r\n                $grup_info = $this->db->query(\"SELECT * FROM kullanici_grubu WHERE kg_id = ?\", [$user_info->grup_id])->row();\r\n\r\n                echo \"<p>Grup AdÄ±: \" . ($grup_info ? $grup_info->kg_adi : 'BulunamadÄ±') . \"</p>\";\r\n\r\n            }\r\n\r\n            \r\n\r\n            if ($user_info->grup_id == 1) {\r\n\r\n                echo \"<p style='color: green;'>âœ“ Admin yetkisi var - Test sayfasÄ±na eriÅŸebilir</p>\";\r\n\r\n                echo \"<p><a href='\" . base_url() . \"rapor/test'>Test SayfasÄ±na Git</a></p>\";\r\n\r\n            } else {\r\n\r\n                echo \"<p style='color: orange;'>âš  Admin yetkisi yok (Grup ID: \" . $user_info->grup_id . \")</p>\";\r\n\r\n            }\r\n\r\n        } else {\r\n\r\n            echo \"<p style='color: red;'>KullanÄ±cÄ± bilgileri veritabanÄ±nda bulunamadÄ±</p>\";\r\n\r\n        }\r\n\r\n    }\r\n\r\n    \r\n\r\n    /**\r\n\r\n     * Cron job isteÄŸi mi kontrol et\r\n\r\n     */\r\n\r\n    private function is_cron_request()\r\n\r\n    {\r\n\r\n        // User-Agent kontrolÃ¼ ile cron job'dan gelip gelmediÄŸini anla\r\n\r\n        $user_agent = $this->input->server('HTTP_USER_AGENT');\r\n\r\n        return (strpos($user_agent, 'CRM Cron Job') !== false) || \r\n\r\n               ($this->uri->segment(1) === 'rapor' && $this->uri->segment(2) === 'gunluk_rapor');\r\n\r\n    }\r\n\r\n    \r\n\r\n    /**\r\n\r\n     * Basit test method'u\r\n\r\n     */\r\n\r\n    public function basit_test()\r\n\r\n    {\r\n\r\n        echo \"Basit test method'u Ã§alÄ±ÅŸÄ±yor - \" . date('Y-m-d H:i:s');\r\n\r\n        exit;\r\n\r\n    }\r\n\r\n}\r\n\r\n?>\r\n\r\n"
        }
    ]
}