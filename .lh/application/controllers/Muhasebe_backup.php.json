{
    "sourceFile": "application/controllers/Muhasebe_backup.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1757432844817,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1757432844817,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Muhasebe extends CI_Controller {\r\n\r\n\t\tpublic function __construct()\r\n\r\n\t{\r\n\r\n\t\tparent::__construct();\r\n\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n\t\t$this->load->model('vt');\r\n\r\n\t\t$this->load->database();\r\n\r\n\t\t$this->load->library('session');\r\n\r\n\t\t$this->load->helper('general');\r\n\r\n\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n\t\tif (!$control) {\r\n\r\n\t\t\tredirect(\"check\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Session kontrolü - varsa aktifleştir\r\n\r\n\t\t// sessionKontrolHelper();\r\n\r\n\t}\tpublic function onayBekleyenTahsilatlar()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '512M');\r\n\r\n\t\tini_set('max_execution_time', 600);\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Onay Bekleyen Tahsilatlar\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\t\t// Giriş yapan kullanıcı bilgisi\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosunun varlığını kontrol et\r\n\r\n\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n\r\n\t\t\r\n\r\n\t\tif ($tableExists == 0) {\r\n\r\n\t\t\t// Tablo yoksa boş veri döndür ve kullanıcıyı bilgilendir\r\n\r\n\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t$data[\"error_message\"] = \"Muhasebe tahsilat durum tablosu henüz oluşturulmamış. Lütfen 'muhase_database_setup.sql' dosyasını veritabanında çalıştırın.\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Bağımlı tabloların varlığını da kontrol et\r\n\r\n\t\t\t$requiredTables = ['bankaHareketleri', 'cek', 'kasaHareketleri', 'senet', 'cari', 'kullanicilar'];\r\n\r\n\t\t\t$missingTables = [];\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach($requiredTables as $table) {\r\n\r\n\t\t\t\t$exists = $this->db->query(\"SHOW TABLES LIKE '$table'\")->num_rows();\r\n\r\n\t\t\t\tif($exists == 0) {\r\n\r\n\t\t\t\t\t$missingTables[] = $table;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(!empty($missingTables)) {\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t\t$data[\"toplam_adet\"] = 0;\t\t\t\t$data[\"error_message\"] = \"Eksik tablolar tespit edildi: \" . implode(', ', $missingTables) . \". Lütfen veritabanı kurulumunu tamamlayın.\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t// Detaylı sorgu - Gerçek verilerle JOIN'ler\r\n\r\n\t\t\t\t$tahsilatlarQ = \"SELECT DISTINCT\r\n\r\n\t\t\t\t   mtd.id,\r\n\r\n\t\t\t\t   mtd.tahsilat_tipi,\r\n\r\n\t\t\t\t   mtd.kayit_id,\r\n\r\n\t\t\t\t   mtd.durum,\r\n\r\n\t\t\t\t   mtd.islem_tarihi,\r\n\r\n\t\t\t\t   mtd.olusturma_tarihi,\r\n\r\n\t\t\t\t   mtd.aciklama,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN 'Banka Hareketi'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa Hareketi'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as tahsilat_tipi_adi,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as durum_adi,\r\n\r\n\t\t\t\t   COALESCE(c.cari_ad, c.cari_soyad, 'Bilinmiyor') as musteri_adi,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN bh.bh_gorsel\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN ck.cek_gorsel\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN kh.kh_gorsel\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN s.senet_gorsel\r\n\r\n\t\t\t\t\t   ELSE NULL\r\n\r\n\t\t\t\t   END as gorsel,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN COALESCE(bh.bh_giris, bh.bh_cikis, 0)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN COALESCE(ck.cek_tutar, 0)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN COALESCE(kh.kh_giris, kh.kh_cikis, 0)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN COALESCE(s.senet_tutar, 0)\r\n\r\n\t\t\t\t\t   ELSE 0\r\n\r\n\t\t\t\t   END as tutar,\r\n\r\n\t\t\t\t   COALESCE(CONCAT(onay_personel.kullanici_ad, ' ', onay_personel.kullanici_soyad), onay_personel.kullanici_ad, 'Bilinmiyor') as onay_yapan_personel,\r\n\r\n\t\t\t\t   COALESCE(CONCAT(islem_personel.kullanici_ad, ' ', islem_personel.kullanici_soyad), islem_personel.kullanici_ad, 'Bilinmiyor') as islemi_yapan_personel\r\n\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n\r\n\t\t\t\tLEFT JOIN bankaHareketleri bh ON (mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id)\r\n\r\n\t\t\t\tLEFT JOIN cek ck ON (mtd.tahsilat_tipi = 2 AND mtd.kayit_id = ck.cek_id)\r\n\r\n\t\t\t\tLEFT JOIN kasaHareketleri kh ON (mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id)\r\n\r\n\t\t\t\tLEFT JOIN senet s ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n\r\n\t\t\t\tLEFT JOIN cari c ON (\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND c.cari_id = bh.bh_cariID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND c.cari_id = ck.cek_cariID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND c.cari_id = kh.kh_cariID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND c.cari_id = s.senet_cariID)\r\n\r\n\t\t\t\t)\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar onay_personel ON mtd.islemi_yapan = onay_personel.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar islem_personel ON (\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND islem_personel.kullanici_id = bh.bh_olusturan) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND islem_personel.kullanici_id = ck.cek_kullaniciID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND islem_personel.kullanici_id = kh.kh_olusturan) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND islem_personel.kullanici_id = s.senet_kullaniciID)\r\n\r\n\t\t\t\t)\r\n\r\n\t\t\t\tWHERE mtd.durum = 1 AND mtd.tahsilat_tipi IN (1, 2, 3, 4)\r\n\r\n\t\t\t\tORDER BY mtd.olusturma_tarihi DESC\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Veritabanı sorgusunu try-catch ile çalıştır\r\n\r\n\t\t\ttry {\r\n\r\n\t\t\t\t$result = $this->db->query($tahsilatlarQ);\r\n\r\n\t\t\t\tif ($result) {\r\n\r\n\t\t\t\t\t$data[\"tahsilatlar\"] = $result->result();\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\tthrow new Exception(\"Veritabanı sorgusu başarısız oldu.\");\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} catch (Exception $e) {\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t\t$data[\"error_message\"] = \"Veritabanı hatası: \" . $e->getMessage();\r\n\r\n\t\t\t\terror_log(\"Muhasebe onay bekleyen tahsilatlar sorgu hatası: \" . $e->getMessage());\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// İstatistikler\r\n\r\n\t\t\t$data[\"toplam_adet\"] = count($data[\"tahsilatlar\"]);\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Toplam tutar hesapla\r\n\r\n\t\t\t$toplam_tutar = 0;\r\n\r\n\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n\r\n\t\t\t\tif($tahsilat->tutar) {\r\n\r\n\t\t\t\t\t$toplam_tutar += $tahsilat->tutar;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = $toplam_tutar;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Veri kontrolü\r\n\r\n\t\tif (!isset($data[\"tahsilatlar\"])) {\r\n\r\n\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t$data[\"error_message\"] = \"Tahsilat verileri yüklenemedi.\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfa yükle - Try-catch ile hata yakalama\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$this->load->view(\"muhasebe/onay-bekleyen-tahsilatlar\", $data);\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t// Hata durumunda basit hata sayfası göster\r\n\r\n\t\t\techo \"<h3>Sayfa Yükleme Hatası</h3>\";\r\n\r\n\t\t\techo \"<p>Hata: \" . $e->getMessage() . \"</p>\";\r\n\r\n\t\t\techo \"<p><a href='\" . base_url('muhasebe') . \"'>Muhasebe Ana Sayfaya Dön</a></p>\";\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function tahsilatOnay($tahsilat_id)\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosundan bilgiyi kontrol et\r\n\r\n\t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n\r\n\t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif ($tahsilat && $tahsilat->durum == 1) { // Sadece onay bekleyen durumda olanlar\r\n\r\n\t\t\t// Görsel yükleme işlemi\r\n\r\n\t\t\t$gorsel_path = null;\r\n\r\n\t\t\t$upload_error = null;\r\n\r\n\t\t\t\r\n\r\n\t\t\tif (!empty($_FILES['tahsilat_gorsel']['name'])) {\r\n\r\n\t\t\t\t$upload_path = FCPATH . 'assets/uploads/';\r\n\r\n\t\t\t\tif (!is_dir($upload_path)) {\r\n\r\n\t\t\t\t\tmkdir($upload_path, 0777, true);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// Dosya uzantısını kontrol et\r\n\r\n\t\t\t\t$file_extension = strtolower(pathinfo($_FILES['tahsilat_gorsel']['name'], PATHINFO_EXTENSION));\r\n\r\n\t\t\t\t$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif'];\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\tif (in_array($file_extension, $allowed_extensions)) {\r\n\r\n\t\t\t\t\t// Dosya adını oluştur\r\n\r\n\t\t\t\t\t$file_name = 'tahsilat_' . $tahsilat_id . '_' . time() . '.' . $file_extension;\r\n\r\n\t\t\t\t\t$full_path = $upload_path . $file_name;\r\n\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\t// Dosya boyutunu kontrol et (5MB = 5242880 bytes)\r\n\r\n\t\t\t\t\tif ($_FILES['tahsilat_gorsel']['size'] <= 5242880) {\r\n\r\n\t\t\t\t\t\tif (move_uploaded_file($_FILES['tahsilat_gorsel']['tmp_name'], $full_path)) {\r\n\r\n\t\t\t\t\t\t\t$gorsel_path = $file_name; // Sadece dosya adını saklıyoruz\r\n\r\n\t\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t\t$upload_error = \"Dosya yükleme sırasında hata oluştu.\";\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t$upload_error = \"Dosya boyutu 5MB'dan büyük olamaz.\";\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$upload_error = \"Sadece JPG, JPEG, PNG ve GIF formatları desteklenmektedir.\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Onay işlemi\r\n\r\n\t\t\t$data = array(\r\n\r\n\t\t\t\t'durum' => 2, // 2 = Onaylandı\r\n\r\n\t\t\t\t'islem_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t'islemi_yapan' => $u_id\r\n\r\n\t\t\t);\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Görsel varsa ekle\r\n\r\n\t\t\tif ($gorsel_path) {\r\n\r\n\t\t\t\t$data['gorsel'] = $gorsel_path;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Açıklama varsa ekle veya mevcut açıklamayı koru\r\n\r\n\t\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\t\t\tif (!empty($aciklama)) {\r\n\r\n\t\t\t\t// Mevcut açıklama varsa ona ekle, yoksa yeni açıklama yap\r\n\r\n\t\t\t\t$mevcut_aciklama = $tahsilat->aciklama ? $tahsilat->aciklama . \"\\n\\n\" : \"\";\r\n\r\n\t\t\t\t$data['aciklama'] = $mevcut_aciklama . \"Onay Açıklaması: \" . $aciklama;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->db->where('id', $tahsilat_id);\r\n\r\n\t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t\r\n\r\n\t\t\tif ($this->db->affected_rows() > 0) {\r\n\r\n\t\t\t\t$success_message = 'Tahsilat başarıyla onaylandı.';\r\n\r\n\t\t\t\tif ($gorsel_path) {\r\n\r\n\t\t\t\t\t$success_message .= ' Görsel yüklendi.';\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ($upload_error) {\r\n\r\n\t\t\t\t\t$success_message .= ' Ancak: ' . $upload_error;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$this->session->set_flashdata('tahsilat_onay_ok', $success_message);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'Tahsilat onaylama işlemi sırasında hata oluştu.');\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tlogekle(1, 3); // Log ekle\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'Geçersiz tahsilat veya tahsilat zaten işlenmiş.');\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function tahsilatRed($tahsilat_id)\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosundan bilgiyi kontrol et\r\n\r\n\t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n\r\n\t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif ($tahsilat && $tahsilat->durum == 1) { // Sadece onay bekleyen durumda olanlar\r\n\r\n\t\t\t// Red işlemi\r\n\r\n\t\t\t$data = array(\r\n\r\n\t\t\t\t'durum' => 3, // 3 = Reddedildi\r\n\r\n\t\t\t\t'islem_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t'islemi_yapan' => $u_id\r\n\r\n\t\t\t);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->db->where('id', $tahsilat_id);\r\n\r\n\t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->session->set_flashdata('tahsilat_red_ok', 'OK');\r\n\r\n\t\t\tlogekle(1, 3); // Log ekle\r\n\r\n\t\t} else {\t\t\t$this->session->set_flashdata('tahsilat_red_hata', 'OK');\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n\r\n\t}\r\n\r\n\tpublic function tahsilatGeriAl($tahsilat_id)\r\n\t{\r\n\t\t// Memory limit artır (performans için)\r\n\t\tini_set('memory_limit', '256M');\r\n\t\tini_set('max_execution_time', 300);\r\n\t\t\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\t\t\tredirect(base_url('check'));\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t$u_id = $control->kullanici_id;\r\n\t\t\r\n\t\t// Muhasebe tahsilat durum tablosundan bilgiyi kontrol et\r\n\t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n\t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n\t\t\r\n\t\tif ($tahsilat && $tahsilat->durum == 2) { // Sadece onaylanmış durumda olanlar geri alınabilir\r\n\t\t\t// Geri alma işlemi - durumu onay bekliyor'a çevir\r\n\t\t\t$data = array(\r\n\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\t\t\t\t'islem_tarihi' => null, // İşlem tarihini sıfırla\r\n\t\t\t\t'islemi_yapan' => null, // Onay yapan kişiyi sıfırla\r\n\t\t\t\t'gorsel' => null, // Onay görselini temizle\r\n\t\t\t);\r\n\t\t\t\r\n\t\t\t// Mevcut açıklama varsa geri alma notunu ekle\r\n\t\t\t$mevcut_aciklama = $tahsilat->aciklama ? $tahsilat->aciklama . \"\\n\\n\" : \"\";\r\n\t\t\t$data['aciklama'] = $mevcut_aciklama . \"Geri Alma İşlemi: \" . date('d.m.Y H:i:s') . \" tarihinde \" . $control->kullanici_ad . \" \" . $control->kullanici_soyad . \" tarafından geri alındı.\";\r\n\t\t\t\r\n\t\t\t$this->db->where('id', $tahsilat_id);\r\n\t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n\t\t\t\r\n\t\t\tif ($this->db->affected_rows() > 0) {\r\n\t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_ok', 'Tahsilat başarıyla geri alındı ve onay bekleyen duruma getirildi.');\r\n\t\t\t} else {\r\n\t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_hata', 'Tahsilat geri alma işlemi sırasında hata oluştu.');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlogekle(1, 3); // Log ekle\r\n\t\t} else {\r\n\t\t\t$this->session->set_flashdata('tahsilat_geri_al_hata', 'Geçersiz tahsilat veya tahsilat zaten onaylanmamış durumda.');\r\n\t\t}\r\n\t\t\r\n\t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n\t}\r\n\r\n\tpublic function tahsilatDetay($tahsilat_id)\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosundan detayı getir\r\n\r\n\t\t$tahsilatQ = \"SELECT \r\n\r\n\t\t   mtd.id,\r\n\r\n\t\t   mtd.tahsilat_tipi,\r\n\r\n\t\t   CASE \r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN 'Banka'\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa'\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t   END as tahsilat_tipi_adi,\r\n\r\n\t\t   mtd.kayit_id,\r\n\r\n\t\t   CASE \r\n\r\n\t\t\t   WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n\t\t\t   WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n\t\t\t   WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t   END as durum_adi,\r\n\r\n\t\t   mtd.durum,\r\n\r\n\t\t   COALESCE(bh_cari.cari_ad, c_cari.cari_ad, kh_cari.cari_ad, s_cari.cari_ad) as musteri_adi,\r\n\r\n\t\t   COALESCE(bh_cari.cari_kodu, c_cari.cari_kodu, kh_cari.cari_kodu, s_cari.cari_kodu) as musteri_kodu,\r\n\r\n\t\t   COALESCE(bh_cari.cari_firmaTelefon, c_cari.cari_firmaTelefon, kh_cari.cari_firmaTelefon, s_cari.cari_firmaTelefon) as musteri_telefon,\r\n\r\n\t\t   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as gorsel,\r\n\r\n\t\t   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n\r\n\t\t   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n\r\n\t\t   CASE \r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN CONCAT(bh_k.kullanici_ad, ' ', bh_k.kullanici_soyad)\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN CONCAT(c_k.kullanici_ad, ' ', c_k.kullanici_soyad)\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN CONCAT(kh_k.kullanici_ad, ' ', kh_k.kullanici_soyad)\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN CONCAT(s_k.kullanici_ad, ' ', s_k.kullanici_soyad)\r\n\r\n\t\t   END as islemi_yapan_personel,\r\n\r\n\t\t   mtd.islem_tarihi,\r\n\r\n\t\t   mtd.olusturma_tarihi,\r\n\r\n\t\t   mtd.aciklama\r\n\r\n\t\tFROM muhasebe_tahsilat_durum mtd\r\n\r\n\t\t\r\n\r\n\t\t-- Onay yapan personel\r\n\r\n\t\tLEFT JOIN kullanicilar onay_k ON mtd.islemi_yapan = onay_k.kullanici_id\r\n\r\n\t\t\r\n\r\n\t\t-- Banka hareketleri\r\n\r\n\t\tLEFT JOIN bankaHareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\r\n\t\tLEFT JOIN kullanicilar bh_k ON bh.bh_olusturan = bh_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari bh_cari ON bh.bh_cariID = bh_cari.cari_id\r\n\r\n\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n\r\n\t\t\r\n\r\n\t\t-- Çek\r\n\r\n\t\tLEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n\r\n\t\tLEFT JOIN kullanicilar c_k ON c.cek_kullaniciID = c_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari c_cari ON c.cek_cariID = c_cari.cari_id\r\n\r\n\t\t\r\n\r\n\t\t-- Kasa hareketleri\r\n\r\n\t\tLEFT JOIN kasaHareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\r\n\t\tLEFT JOIN kullanicilar kh_k ON kh.kh_olusturan = kh_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari kh_cari ON kh.kh_cariID = kh_cari.cari_id\r\n\r\n\t\t\r\n\r\n\t\t-- Senet\r\n\r\n\t\tLEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n\r\n\t\tLEFT JOIN kullanicilar s_k ON s.senet_kullaniciID = s_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari s_cari ON s.senet_cariID = s_cari.cari_id\r\n\r\n\t\t\r\n\r\n\t\tWHERE mtd.id = '$tahsilat_id'\";\r\n\r\n\t\t\r\n\r\n\t\t$data[\"tahsilat\"] = $this->db->query($tahsilatQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif ($data[\"tahsilat\"]) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Muhasebe / Tahsilat Detayı\";\r\n\r\n\t\t\t$this->load->view(\"muhasebe/tahsilat-detay\", $data);\r\n\r\n\t\t} else {\r\n\r\n\t\t\tredirect('hata');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\tpublic function tahsilatListesi()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Tahsilat Listesi\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Giriş yapan kullanıcı bilgisi\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Çek senkronizasyonu - çek tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeCekler();\r\n\r\n\t\t\r\n\r\n\t\t// Banka hareketleri senkronizasyonu - bankaHareketleri tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeBankaHareketleri();\r\n\r\n\t\t\r\n\r\n\t\t// Kasa hareketleri senkronizasyonu - kasaHareketleri tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeKasaHareketleri();\r\n\r\n\t\t\r\n\r\n\t\t// Senet senkronizasyonu - senet tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeSenetler();\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosunun varlığını kontrol et\r\n\r\n\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n\r\n\t\t\r\n\r\n\t\tif ($tableExists == 0) {\r\n\r\n\t\t\t// Tablo yoksa boş veri döndür ve kullanıcıyı bilgilendir\r\n\r\n\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t$data[\"error_message\"] = \"Muhasebe tahsilat durum tablosu henüz oluşturulmamış. Lütfen 'muhase_database_setup.sql' dosyasını veritabanında çalıştırın.\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Bağımlı tabloların varlığını da kontrol et\r\n\r\n\t\t\t$requiredTables = ['bankaHareketleri', 'cek', 'kasaHareketleri', 'senet', 'cari', 'kullanicilar'];\r\n\r\n\t\t\t$missingTables = [];\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach($requiredTables as $table) {\r\n\r\n\t\t\t\t$exists = $this->db->query(\"SHOW TABLES LIKE '$table'\")->num_rows();\r\n\r\n\t\t\t\tif($exists == 0) {\r\n\r\n\t\t\t\t\t$missingTables[] = $table;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(!empty($missingTables)) {\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t\t$data[\"error_message\"] = \"Eksik tablolar tespit edildi: \" . implode(', ', $missingTables) . \". Lütfen veritabanı kurulumunu tamamlayın.\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t// Ana sorgu: Muhasebe tahsilat durum tablosundan tüm tahsilatları çek (durum filtresi yok)\r\n\r\n\t\t\t\t$tahsilatlarQ = \"SELECT \r\n\r\n\t\t\t\t   mtd.id,\r\n\r\n\t\t\t\t   mtd.tahsilat_tipi,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN 'Banka'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as tahsilat_tipi_adi,\r\n\r\n\t\t\t\t   mtd.kayit_id,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as durum_adi,\r\n\r\n\t\t\t\t   mtd.durum,\r\n\r\n\t\t\t\t   mtd.gorsel as onay_gorsel,\r\n\r\n\t\t\t\t   COALESCE(bh_cari.cari_ad, c_cari.cari_ad, kh_cari.cari_ad, s_cari.cari_ad) as musteri_adi,\r\n\r\n\t\t\t\t   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as tahsilat_gorsel,\r\n\r\n\t\t\t\t   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n\r\n\t\t\t\t   -- Çek ek bilgileri\r\n\r\n\t\t\t\t   c.cek_seriNo as cek_seri_no,\r\n\r\n\t\t\t\t   c.cek_vadeTarih as cek_vade_tarih,\r\n\r\n\t\t\t\t   c.cek_portfoyNo as cek_portfoy_no,\r\n\r\n\t\t\t\t   c.cek_durum as cek_durum,\r\n\r\n\t\t\t\t   -- Senet ek bilgileri\r\n\r\n\t\t\t\t   s.senet_seriNo as senet_seri_no,\r\n\r\n\t\t\t\t   s.senet_vadeTarih as senet_vade_tarih,\r\n\r\n\t\t\t\t   s.senet_portfoyNo as senet_portfoy_no,\r\n\r\n\t\t\t\t   s.senet_durum as senet_durum,\r\n\r\n\t\t\t\t   s.senet_gorsel as senet_gorsel,\r\n\r\n\t\t\t\t   -- Banka ek bilgileri\r\n\r\n\t\t\t\t   bh.bh_belgeNumarasi as banka_belge_no,\r\n\r\n\t\t\t\t   bh.bh_turu as banka_turu,\r\n\r\n\t\t\t\t   bh.bh_bankaID as banka_id,\r\n\r\n\t\t\t\t   bh.bh_tarih as banka_tarih,\r\n\r\n\t\t\t\t   bh.bh_aciklama as banka_aciklama,\r\n\r\n\t\t\t\t   b.banka_bankaAd as banka_adi,\r\n\r\n\t\t\t\t   b.banka_hesapNo as banka_hesap_no,\r\n\r\n\t\t\t\t   -- Kasa ek bilgileri\r\n\r\n\t\t\t\t   kh.kh_belgeNumarasi as kasa_belge_no,\r\n\r\n\t\t\t\t   kh.kh_turu as kasa_turu,\r\n\r\n\t\t\t\t   kh.kh_kasaID as kasa_id,\r\n\r\n\t\t\t\t   kh.kh_tarih as kasa_tarih,\r\n\r\n\t\t\t\t   kh.kh_aciklama as kasa_aciklama,\r\n\r\n\t\t\t\t   k.kasa_adi as kasa_adi,\r\n\r\n\t\t\t\t   k.kasa_kodu as kasa_kodu,\r\n\r\n\t\t\t\t   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN CONCAT(bh_k.kullanici_ad, ' ', bh_k.kullanici_soyad)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN CONCAT(c_k.kullanici_ad, ' ', c_k.kullanici_soyad)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN CONCAT(kh_k.kullanici_ad, ' ', kh_k.kullanici_soyad)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN CONCAT(s_k.kullanici_ad, ' ', s_k.kullanici_soyad)\r\n\r\n\t\t\t\t   END as islemi_yapan_personel,\r\n\r\n\t\t\t\t   mtd.islem_tarihi,\r\n\r\n\t\t\t\t   mtd.olusturma_tarihi,\r\n\r\n\t\t\t\t   mtd.aciklama\r\n\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Onay yapan personel\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar onay_k ON mtd.islemi_yapan = onay_k.kullanici_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Banka hareketleri\r\n\r\n\t\t\t\tLEFT JOIN bankaHareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar bh_k ON bh.bh_olusturan = bh_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari bh_cari ON bh.bh_cariID = bh_cari.cari_id\r\n\r\n\t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Çek (ek dosyasından gelen yapıya göre güncellenmiş)\r\n\r\n\t\t\t\tLEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar c_k ON c.cek_kullaniciID = c_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari c_cari ON c.cek_cariID = c_cari.cari_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Kasa hareketleri\r\n\r\n\t\t\t\tLEFT JOIN kasaHareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar kh_k ON kh.kh_olusturan = kh_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari kh_cari ON kh.kh_cariID = kh_cari.cari_id\r\n\r\n\t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Senet\r\n\r\n\t\t\t\tLEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar s_k ON s.senet_kullaniciID = s_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari s_cari ON s.senet_cariID = s_cari.cari_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\tWHERE mtd.tahsilat_tipi IN (1, 2, 3, 4)\r\n\r\n\t\t\t\tORDER BY mtd.olusturma_tarihi DESC\";\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = $this->db->query($tahsilatlarQ)->result();\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// İstatistikler\r\n\r\n\t\t\t\t$data[\"toplam_adet\"] = count($data[\"tahsilatlar\"]);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// Toplam tutar hesapla\r\n\r\n\t\t\t\t$toplam_tutar = 0;\r\n\r\n\t\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n\r\n\t\t\t\t\tif($tahsilat->tutar) {\r\n\r\n\t\t\t\t\t\t$toplam_tutar += $tahsilat->tutar;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$data[\"toplam_tutar\"] = $toplam_tutar;\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// Durum bazında istatistikler\r\n\r\n\t\t\t\t$onay_bekleyen = 0;\r\n\r\n\t\t\t\t$onaylanan = 0;\r\n\r\n\t\t\t\t$reddedilen = 0;\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n\r\n\t\t\t\t\tswitch($tahsilat->durum) {\r\n\r\n\t\t\t\t\t\tcase 1: $onay_bekleyen++; break;\r\n\r\n\t\t\t\t\t\tcase 2: $onaylanan++; break;\r\n\r\n\t\t\t\t\t\tcase 3: $reddedilen++; break;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$data[\"onay_bekleyen_adet\"] = $onay_bekleyen;\r\n\r\n\t\t\t\t$data[\"onaylanan_adet\"] = $onaylanan;\r\n\r\n\t\t\t\t$data[\"reddedilen_adet\"] = $reddedilen;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfa yükle\r\n\r\n\t\t$this->load->view(\"muhasebe/tahsilat-listesi\", $data);\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Senet Yönetimi - Muhasebe altında\r\n\r\n\t */\r\n\r\n\tpublic function senet_yonetim()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t// Session kontrolü\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Yetki kontrolü - Senet Yönetimi (ID: 522)\r\n\r\n\t\tif (!grup_modul_yetkisi_var(522)) {\r\n\r\n\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Senet Yönetimi (ID: 522)', 403);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Debug bilgisi - kullanıcı 187 için\r\n\r\n\t\t$debug_info = \"\";\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$debug_info = \"<!-- SENET YONETIM DEBUG: User={$control->kullanici_id}, Group={$control->grup_id}, YetkiKontrolü=522 -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Senet Yönetimi\";\r\n\r\n\t\t\r\n\r\n\t\t// Debug bilgisini data'ya ekle\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] = $debug_info . \"<!-- SENET YONETIM SUCCESS: Fonksiyon başarıyla başladı -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Durum filtresi\r\n\r\n\t\t$durum_filter = $this->input->get('durum');\r\n\r\n\t\t$valid_durumlar = ['eldeki', 'bankaya-verilen', 'tahsil-edilen', 'protesto', 'vadesi-gecen'];\r\n\r\n\t\t\r\n\r\n\t\tif (!$durum_filter || !in_array($durum_filter, $valid_durumlar)) {\r\n\r\n\t\t\t$durum_filter = 'eldeki'; // Default\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data['durum_filter'] = $durum_filter;\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Durum filtresi\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] .= \"<!-- DURUM FILTER: $durum_filter -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Durum ID'lerini map et\r\n\r\n\t\t$durum_map = [\r\n\r\n\t\t\t'eldeki' => 1,           // Eldeki Bekleyen Senetler\r\n\r\n\t\t\t'bankaya-verilen' => 2,  // Bankaya Verilen Senetler  \r\n\r\n\t\t\t'tahsil-edilen' => 3,    // Bankadan Tahsil Edilen Senetler\r\n\r\n\t\t\t'protesto' => 4,         // Protesto Olan Senetler\r\n\r\n\t\t\t'vadesi-gecen' => 5      // Vadesi Geçen Tahsilatlar\r\n\r\n\t\t];\r\n\r\n\t\t\r\n\r\n\t\t$durum_id = $durum_map[$durum_filter];\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Durum ID\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] .= \"<!-- DURUM ID: $durum_id -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfalama\r\n\r\n\t\t$page = $this->input->get('sayfa') ? $this->input->get('sayfa') : 1;\r\n\r\n\t\t$limit = 20;\r\n\r\n\t\t$offset = ($page - 1) * $limit;\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Ana sorgu - Vadesi geçen durumu için özel sorgu\r\n\r\n\t\tif ($durum_filter == 'vadesi-gecen') {\r\n\r\n\t\t\t$senetlerQ = \"\r\n\r\n\t\t\t\tSELECT s.*, \r\n\r\n\t\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n\r\n\t\t\t\t\t   c.cari_firmaTelefon as cari_telefon,\r\n\r\n\t\t\t\t\t   CONCAT_WS(' ', k.kullanici_ad, k.kullanici_soyad) as personel_adi,\r\n\r\n\t\t\t\t\t   s.senet_gorsel,\r\n\r\n\t\t\t\t\t   'Vadesi Geçen' as son_durum,\r\n\r\n\t\t\t\t\t   '#dc3545' as durum_rengi,\r\n\r\n\t\t\t\t\t   'fa-exclamation-triangle' as durum_ikonu,\r\n\r\n\t\t\t\t\t   NULL as son_hareket_tarihi,\r\n\r\n\t\t\t\t\t   NULL as banka_hesap_adi,\r\n\r\n\t\t\t\t\t   DATEDIFF(s.senet_vadeTarih, CURDATE()) as vade_gun_kalan\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n\r\n\t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n\r\n\t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n\r\n\t\t\t\tLIMIT $offset, $limit\r\n\r\n\t\t\t\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Ana sorgu - Senet tablosu için doğru sütun adlarını kullan\r\n\r\n\t\t\t$senetlerQ = \"\r\n\r\n\t\t\t\tSELECT s.*, \r\n\r\n\t\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n\r\n\t\t\t\t\t   c.cari_firmaTelefon as cari_telefon,\r\n\r\n\t\t\t\t\t   CONCAT_WS(' ', k.kullanici_ad, k.kullanici_soyad) as personel_adi,\r\n\r\n\t\t\t\t\t   s.senet_gorsel,\r\n\r\n\t\t\t\t\t   skt.skt_adi as son_durum,\r\n\r\n\t\t\t\t\t   skt.skt_renk as durum_rengi,\r\n\r\n\t\t\t\t\t   skt.skt_ikon as durum_ikonu,\r\n\r\n\t\t\t\t\t   sh_son.sh_tarih as son_hareket_tarihi,\r\n\r\n\t\t\t\t\t   b.banka_bankaAd as banka_hesap_adi,\r\n\r\n\t\t\t\t\t   DATEDIFF(s.senet_vadeTarih, CURDATE()) as vade_gun_kalan\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN (\r\n\r\n\t\t\t\t\tSELECT sh1.sh_senet_id, MAX(sh1.sh_id) as max_id\r\n\r\n\t\t\t\t\tFROM senet_hareketleri sh1\r\n\r\n\t\t\t\t\tGROUP BY sh1.sh_senet_id\r\n\r\n\t\t\t\t) son_hareket ON s.senet_id = son_hareket.sh_senet_id\r\n\r\n\t\t\t\tLEFT JOIN senet_hareketleri sh_son ON son_hareket.max_id = sh_son.sh_id\r\n\r\n\t\t\t\tLEFT JOIN senet_konum_tipleri skt ON sh_son.sh_konum_tip_id = skt.skt_id\r\n\r\n\t\t\t\tLEFT JOIN banka b ON sh_son.sh_banka_id = b.banka_id\r\n\r\n\t\t\t\tWHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\r\n\r\n\t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n\r\n\t\t\t\tLIMIT $offset, $limit\r\n\r\n\t\t\t\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sorguyu çalıştır ve hata kontrolü yap\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$senetlerResult = $this->db->query($senetlerQ);\r\n\r\n\t\t\tif (!$senetlerResult) {\r\n\r\n\t\t\t\tthrow new Exception(\"Senet listesi sorgusu başarısız: \" . $this->db->error()['message']);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data['senetler'] = $senetlerResult->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Debug - Sorgu sonucu\r\n\r\n\t\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t\t$data['debug_info'] .= \"<!-- SENET SORGUSU: \" . count($data['senetler']) . \" senet bulundu -->\";\r\n\r\n\t\t\t\t$data['debug_info'] .= \"<!-- SQL SORGU: \" . str_replace(\"\\n\", \" \", $senetlerQ) . \" -->\";\r\n\r\n\t\t\t\tif (!empty($data['senetler'])) {\r\n\r\n\t\t\t\t\t$ilkSenet = $data['senetler'][0];\r\n\r\n\t\t\t\t\t$data['debug_info'] .= \"<!-- İLK SENET: cari_ad='\" . $ilkSenet->cari_ad . \"', senet_cariID='\" . $ilkSenet->senet_cariID . \"' -->\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['senetler'] = array();\r\n\r\n\t\t\t$data['error_message'] = \"Senet listesi yüklenirken hata oluştu: \" . $e->getMessage();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Debug - Hata mesajı\r\n\r\n\t\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t\t$data['debug_info'] .= \"<!-- SENET SORGUSU HATA: \" . $e->getMessage() . \" -->\";\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Toplam sayı - Vadesi geçen durumu için özel sorgu\r\n\r\n\t\tif ($durum_filter == 'vadesi-gecen') {\r\n\r\n\t\t\t$countQ = \"\r\n\r\n\t\t\t\tSELECT COUNT(*) as total\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n\r\n\t\t\t\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countQ = \"\r\n\r\n\t\t\t\tSELECT COUNT(*) as total\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tLEFT JOIN (\r\n\r\n\t\t\t\t\tSELECT sh1.sh_senet_id, MAX(sh1.sh_id) as max_id\r\n\r\n\t\t\t\t\tFROM senet_hareketleri sh1\r\n\r\n\t\t\t\t\tGROUP BY sh1.sh_senet_id\r\n\r\n\t\t\t\t) son_hareket ON s.senet_id = son_hareket.sh_senet_id\r\n\r\n\t\t\t\tLEFT JOIN senet_hareketleri sh_son ON son_hareket.max_id = sh_son.sh_id\r\n\r\n\t\t\t\tWHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\r\n\r\n\t\t\t\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$countResult = $this->db->query($countQ);\r\n\r\n\t\t\tif (!$countResult) {\r\n\r\n\t\t\t\tthrow new Exception(\"Toplam sayı sorgusu başarısız: \" . $this->db->error()['message']);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data['total_count'] = $countResult->row()->total;\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['total_count'] = 0;\r\n\r\n\t\t\tif (!isset($data['error_message'])) {\r\n\r\n\t\t\t\t$data['error_message'] = \"Toplam sayı hesaplanırken hata oluştu: \" . $e->getMessage();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfalama\r\n\r\n\t\t$this->load->library('pagination');\r\n\r\n\t\t$config['base_url'] = base_url(\"muhasebe/senet-yonetim?durum=$durum_filter\");\r\n\r\n\t\t$config['total_rows'] = $data['total_count'];\r\n\r\n\t\t$config['per_page'] = $limit;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t\r\n\r\n\t\t// Pagination style\r\n\r\n\t\t$config['full_tag_open'] = '<nav><ul class=\"pagination justify-content-center\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></nav>';\r\n\r\n\t\t$config['first_link'] = 'İlk';\r\n\r\n\t\t$config['last_link'] = 'Son';\r\n\r\n\t\t$config['first_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li>';\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li>';\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li>';\r\n\r\n\t\t$config['last_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li>';\r\n\r\n\t\t$config['cur_tag_open'] = '<li class=\"page-item active\"><a class=\"page-link\" href=\"#\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</a></li>';\r\n\r\n\t\t$config['num_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li>';\r\n\r\n\t\t$config['attributes'] = array('class' => 'page-link');\r\n\r\n\t\t\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\t\t$data['pagination'] = $this->pagination->create_links();\r\n\r\n\t\t\r\n\r\n\t\t// Konum tipleri - Veritabanından doğru tablo adını kullanarak getir\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$data['konum_tipleri'] = $this->db->query(\"SELECT skt_id as kt_id, skt_adi as kt_ad, skt_renk as kt_ikon, skt_sira_no as kt_sira FROM senet_konum_tipleri WHERE skt_aktif = '1' ORDER BY skt_sira_no ASC\")->result();\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t// Eğer tablo hata verirse fallback data kullan\r\n\r\n\t\t\t$data['konum_tipleri'] = array(\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 1,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Eldeki',\r\n\r\n\t\t\t\t\t'kt_renk' => '#17a2b8',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-clock',\r\n\r\n\t\t\t\t\t'kt_sira' => 1\r\n\r\n\t\t\t\t),\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 2,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Bankaya Verilen',\r\n\r\n\t\t\t\t\t'kt_renk' => '#ffc107',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-university',\r\n\r\n\t\t\t\t\t'kt_sira' => 2\r\n\r\n\t\t\t\t),\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 3,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Tahsil Edilen',\r\n\r\n\t\t\t\t\t'kt_renk' => '#28a745',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-check',\r\n\r\n\t\t\t\t\t'kt_sira' => 3\r\n\r\n\t\t\t\t),\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 4,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Protesto',\r\n\r\n\t\t\t\t\t'kt_renk' => '#dc3545',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-times',\r\n\r\n\t\t\t\t\t'kt_sira' => 4\r\n\r\n\t\t\t\t)\r\n\r\n\t\t\t);\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Bankalar\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$data['bankalar'] = $this->db->query(\"SELECT * FROM banka ORDER BY banka_bankaAd ASC\")->result();\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['bankalar'] = array();\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// İstatistikler - hata olmadan çalıştırmaya çalış\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$data['istatistikler'] = $this->getSenetIstatistikleri();\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['istatistikler'] = (object)[\r\n\r\n\t\t\t\t'toplam_senet' => 0,\r\n\r\n\t\t\t\t'toplam_tutar' => 0,\r\n\r\n\t\t\t\t'vadesi_gecen' => 0,\r\n\r\n\t\t\t\t'vadesi_yaklasan' => 0\r\n\r\n\t\t\t];\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Final\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] .= \"<!-- VIEW YUKLENIYOR: muhasebe/senet-yonetim -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Durum başlıkları\r\n\r\n\t\t$data['durum_basliklar'] = [\r\n\r\n\t\t\t'eldeki' => 'Eldeki Bekleyen Senetler',\r\n\r\n\t\t\t'bankaya-verilen' => 'Bankaya Verilen Senetler',\r\n\r\n\t\t\t'tahsil-edilen' => 'Bankadan Tahsil Edilen Senetler',\r\n\r\n\t\t\t'protesto' => 'Protesto Olan Senetler',\r\n\r\n\t\t\t'vadesi-gecen' => 'Vadesi Geçen Tahsilatlar'\r\n\r\n\t\t];\r\n\r\n\t\t\r\n\r\n\t\t$this->load->view('muhasebe/senet-yonetim', $data);\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Senet istatistikleri - Doğru sütun adlarını kullan\r\n\r\n\t */\r\n\r\n\tprivate function getSenetIstatistikleri()\r\n\r\n\t{\r\n\r\n\t\t$istatistikQ = \"\r\n\r\n\t\t\tSELECT \r\n\r\n\t\t\t\tCOUNT(*) as toplam_senet,\r\n\r\n\t\t\t\tSUM(s.senet_tutar) as toplam_tutar,\r\n\r\n\t\t\t\tCOUNT(CASE WHEN s.senet_vadeTarih < CURDATE() THEN 1 END) as vadesi_gecen,\r\n\r\n\t\t\t\tCOUNT(CASE WHEN s.senet_vadeTarih BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY) THEN 1 END) as vadesi_yaklasan\r\n\r\n\t\t\tFROM senet s\r\n\r\n\t\t\";\r\n\r\n\r\n\r\n\t\treturn $this->db->query($istatistikQ)->row();\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function senet_detay($id)\r\n\r\n\t{\r\n\r\n\t\t// Yetki kontrolü - Senet Yönetimi (ID: 522)\r\n\r\n\t\tif (!grup_modul_yetkisi_var(522)) {\r\n\r\n\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Senet Yönetimi (ID: 522)', 403);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Senet Detayı\";\r\n\r\n\t\t\r\n\r\n\t\t// Debug bilgisi ekle\r\n\r\n\t\t$data[\"debug_info\"] = \"<!-- DEBUG: Senet ID: $id -->\";\r\n\r\n\t\t\r\n\r\n\t\t// Ana hesap kısıtlaması kaldırıldı - tüm senetleri göster\r\n\r\n\t\t$senetQ = \"SELECT s.*, \r\n\r\n\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n\r\n\t\t\t\t   c.cari_firmaTelefon as cari_telefon\r\n\r\n\t\t\t\t   FROM senet s\r\n\r\n\t\t\t\t   LEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n\r\n\t\t\t\t   WHERE s.senet_id = '$id'\";\r\n\r\n\t\t\r\n\r\n\t\t$data[\"senet\"] = $this->db->query($senetQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif (!$data[\"senet\"]) {\r\n\r\n\t\t\t// Debug: Senet bulunamadı bilgisi\r\n\r\n\t\t\t$data[\"error_message\"] = \"Senet bulunamadı (ID: $id)\";\r\n\r\n\t\t\t$this->load->view(\"hata\", $data);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Senet hareketleri - ana hesap kısıtlaması kaldırıldı\r\n\r\n\t\t$hareketlerQ = \"SELECT sh.*, \r\n\r\n\t\t\t\t\t\tskt.skt_adi as konum_adi,\r\n\r\n\t\t\t\t\t\tskt.skt_renk as kt_renk,\r\n\r\n\t\t\t\t\t\tskt.skt_ikon as kt_ikon,\r\n\r\n\t\t\t\t\t\tb.banka_bankaAd as banka_ad,\r\n\r\n\t\t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as islem_yapan\r\n\r\n\t\t\t\t\t\tFROM senet_hareketleri sh\r\n\r\n\t\t\t\t\t\tLEFT JOIN senet_konum_tipleri skt ON sh.sh_konum_tip_id = skt.skt_id\r\n\r\n\t\t\t\t\t\tLEFT JOIN banka b ON sh.sh_banka_id = b.banka_id\r\n\r\n\t\t\t\t\t\tLEFT JOIN kullanicilar k ON sh.sh_kullanici_id = k.kullanici_id\r\n\r\n\t\t\t\t\t\tWHERE sh.sh_senet_id = '$id'\r\n\r\n\t\t\t\t\t\tORDER BY sh.sh_tarih DESC, sh.sh_id DESC\";\r\n\r\n\t\t\r\n\r\n\t\t$data[\"hareketler\"] = $this->db->query($hareketlerQ)->result();\r\n\r\n\t\t\r\n\r\n\t\t// Konum tipleri ve bankalar bilgilerini de ekleyelim\r\n\r\n\t\t$data[\"konum_tipleri\"] = $this->db->query(\"SELECT * FROM senet_konum_tipleri ORDER BY skt_adi\")->result();\r\n\r\n\t\t$data[\"bankalar\"] = $this->db->query(\"SELECT * FROM banka ORDER BY banka_bankaAd\")->result();\r\n\r\n\t\t\r\n\r\n\t\t$this->load->view(\"muhasebe/senet-detay\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function senet_konum_degistir()\r\n\r\n\t{\r\n\r\n\t\t// Session kontrolü\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// POST verilerini al\r\n\r\n\t\t$senet_id = $this->input->post('senet_id');\r\n\r\n\t\t$yeni_konum = $this->input->post('yeni_konum');\r\n\r\n\t\t$banka_id = $this->input->post('banka_id');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\t// Veri doğrulama\r\n\r\n\t\tif (!$senet_id || !$yeni_konum) {\r\n\r\n\t\t\t$this->session->set_flashdata('hata', 'Gerekli alanlar eksik!');\r\n\r\n\t\t\tredirect('muhasebe/senet-detay/' . $senet_id);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Senet varlığını kontrol et\r\n\r\n\t\t$senet = $this->db->query(\"SELECT * FROM senet WHERE senet_id = '$senet_id'\")->row();\r\n\r\n\t\tif (!$senet) {\r\n\r\n\t\t\t$this->session->set_flashdata('hata', 'Senet bulunamadı!');\r\n\r\n\t\t\tredirect('muhasebe/senet-yonetim');\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Yeni hareket kaydı ekle\r\n\r\n\t\t$hareket_data = array(\r\n\r\n\t\t\t'sh_senet_id' => $senet_id,\r\n\r\n\t\t\t'sh_konum_tip_id' => $yeni_konum,\r\n\r\n\t\t\t'sh_banka_id' => $banka_id ? $banka_id : null,\r\n\r\n\t\t\t'sh_kullanici_id' => $control->kullanici_id,\r\n\r\n\t\t\t'sh_tarih' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t'sh_not' => $aciklama ? $aciklama : 'Konum değiştirildi'\r\n\r\n\t\t);\r\n\r\n\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$this->db->insert('senet_hareketleri', $hareket_data);\r\n\r\n\t\t\t$this->session->set_flashdata('basarili', 'Senet konumu başarıyla değiştirildi!');\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$this->session->set_flashdata('hata', 'Konum değiştirme işlemi başarısız: ' . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Detay sayfasına geri dön\r\n\r\n\t\tredirect('muhasebe/senet-detay/' . $senet_id);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Çek tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeCekler()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan çekleri bul\r\n\r\n\t\t\t$ceklerQ = \"SELECT c.cek_id \r\n\r\n\t\t\t\t\t\tFROM cek c \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$cekler = $this->db->query($ceklerQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her çek için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($cekler as $cek) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 2, // 2 = Çek\r\n\r\n\t\t\t\t\t'kayit_id' => $cek->cek_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Çek tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($cekler) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($cekler) . \" çek kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Çek senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Banka hareketleri tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeBankaHareketleri()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan banka hareketlerini bul (sadece giriş hareketleri - tahsilat)\r\n\r\n\t\t\t$bankaHareketleriQ = \"SELECT bh.bh_id \r\n\r\n\t\t\t\t\t\tFROM bankaHareketleri bh \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL AND bh.bh_giris > 0\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$bankaHareketleri = $this->db->query($bankaHareketleriQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her banka hareketi için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($bankaHareketleri as $hareket) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 1, // 1 = Banka\r\n\r\n\t\t\t\t\t'kayit_id' => $hareket->bh_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Banka hareketleri tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($bankaHareketleri) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($bankaHareketleri) . \" banka hareketi kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Banka hareketleri senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Kasa hareketleri tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t * Açılış bakiyesi kayıtları hariç tutulur\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeKasaHareketleri()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan kasa hareketlerini bul (sadece giriş hareketleri - tahsilat)\r\n\r\n\t\t\t// Açılış bakiyesi kayıtlarını hariç tut\r\n\r\n\t\t\t$kasaHareketleriQ = \"SELECT kh.kh_id \r\n\r\n\t\t\t\t\t\tFROM kasaHareketleri kh \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL \r\n\r\n\t\t\t\t\t\tAND kh.kh_giris > 0 \r\n\r\n\t\t\t\t\t\tAND (kh.kh_aciklama IS NULL OR kh.kh_aciklama NOT LIKE '%Açılış Bakiyesi%')\r\n\r\n\t\t\t\t\t\tAND (kh.kh_aciklama IS NULL OR kh.kh_aciklama NOT LIKE '%Otomatik Oluşturulan%')\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$kasaHareketleri = $this->db->query($kasaHareketleriQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her kasa hareketi için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($kasaHareketleri as $hareket) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 3, // 3 = Kasa\r\n\r\n\t\t\t\t\t'kayit_id' => $hareket->kh_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Kasa hareketleri tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($kasaHareketleri) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($kasaHareketleri) . \" kasa hareketi kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Kasa hareketleri senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Senet tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeSenetler()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan senetleri bul\r\n\r\n\t\t\t$senetlerQ = \"SELECT s.senet_id \r\n\r\n\t\t\t\t\t\tFROM senet s \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$senetler = $this->db->query($senetlerQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her senet için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($senetler as $senet) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 4, // 4 = Senet\r\n\r\n\t\t\t\t\t'kayit_id' => $senet->senet_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Senet tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($senetler) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($senetler) . \" senet kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Senet senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function musteriListesi()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '512M');\r\n\r\n\t\tini_set('max_execution_time', 600);\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Müşteri Listesi\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Giriş yapan kullanıcı bilgisi\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Yetki kontrolü - Müşteri Listesi (ID: 530)\r\n\r\n\t\tif (!grup_modul_yetkisi_var(530)) {\r\n\r\n\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Müşteri Listesi (ID: 530)', 403);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Database kütüphanesini yükle\r\n\r\n\t\t$this->load->database();\r\n\r\n\t\t\r\n\r\n\t\t// Cari tablosunun varlığını kontrol et - basit\r\n\r\n\t\t$data[\"musteriler\"] = array();\r\n\r\n\t\t$data[\"toplam_musteri\"] = 0;\r\n\r\n\t\t\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Basit sorgu - tüm cari kayıtlarını getir\r\n\r\n\t\t\t$musteriler = $this->vt->multiple(\"cari\", array(), \"cari_olusturmaTarihi\", \"DESC\");\r\n\r\n\t\t\tif ($musteriler && is_array($musteriler)) {\r\n\r\n\t\t\t\t$data[\"musteriler\"] = $musteriler;\r\n\r\n\t\t\t\t$data[\"toplam_musteri\"] = count($musteriler);\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data[\"error_message\"] = \"Veritabanı hatası: \" . $e->getMessage();\r\n\r\n\t\t\terror_log(\"Muhasebe müşteri listesi sorgu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Aktif müşteri sayısı hesapla\r\n\r\n\t\t$aktif_musteri = 0;\r\n\r\n\t\tif (!empty($data[\"musteriler\"])) {\r\n\r\n\t\t\tforeach($data[\"musteriler\"] as $musteri) {\r\n\r\n\t\t\t\tif(isset($musteri->cari_durum) && $musteri->cari_durum == 1) {\r\n\r\n\t\t\t\t\t$aktif_musteri++;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"aktif_musteri\"] = $aktif_musteri;\r\n\r\n\t\t$data[\"pasif_musteri\"] = $data[\"toplam_musteri\"] - $aktif_musteri;\r\n\r\n\t\t\r\n\r\n\t\t// View yükle\r\n\r\n\t\t$this->load->view(\"muhasebe/musteri-listesi\", $data);\r\n\r\n\t}\r\n\t\r\n\t/**\r\n\t * Cari Silme Kontrolü ve Silme İşlemi\r\n\t */\r\n\tpublic function cari_sil_kontrol()\r\n\t{\r\n\t\t// Yetki kontrolü\r\n\t\tif (!grup_modul_yetkisi_var(530)) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Kütüphaneleri yükle\r\n\t\t$this->load->database();\r\n\r\n\t\t$cari_id = $this->input->post('cari_id');\r\n\t\t\r\n\t\tif (!$cari_id) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari ID belirtilmemiş.']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Cari bilgilerini getir\r\n\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n\t\tif (!$cari) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari bulunamadı.']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// İlişkili verileri kontrol et\r\n\t\t$bagimli_veriler = [];\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// Cari hareketleri kontrolü\r\n\t\t\t$this->db->where('ch_cariID', $cari_id);\r\n\t\t\t$cari_hareketleri = $this->db->count_all_results('carihareketleri');\r\n\t\t\tif ($cari_hareketleri > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Cari Hareketleri',\r\n\t\t\t\t\t'adet' => $cari_hareketleri,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait mali hareketler mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Satış faturaları kontrolü\r\n\t\t\t$this->db->where('satis_cariID', $cari_id);\r\n\t\t\t$satis_faturalari = $this->db->count_all_results('satisFaturasi');\r\n\t\t\tif ($satis_faturalari > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Satış Faturaları',\r\n\t\t\t\t\t'adet' => $satis_faturalari,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait satış faturaları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Alış faturaları kontrolü\r\n\t\t\t$this->db->where('alis_cariID', $cari_id);\r\n\t\t\t$alis_faturalari = $this->db->count_all_results('alisFaturasi');\r\n\t\t\tif ($alis_faturalari > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Alış Faturaları',\r\n\t\t\t\t\t'adet' => $alis_faturalari,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait alış faturaları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Proforma faturaları kontrolü\r\n\t\t\t$this->db->where('proforma_cariID', $cari_id);\r\n\t\t\t$proforma_faturalari = $this->db->count_all_results('proformaFaturasi');\r\n\t\t\tif ($proforma_faturalari > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Proforma Faturaları',\r\n\t\t\t\t\t'adet' => $proforma_faturalari,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait proforma faturaları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Banka hareketleri kontrolü (giriş/çıkış)\r\n\t\t\t$this->db->where('bh_cariID', $cari_id);\r\n\t\t\t$banka_giris = $this->db->count_all_results('bankahareketleri');\r\n\t\t\tif ($banka_giris > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Banka Hareketleri',\r\n\t\t\t\t\t'adet' => $banka_giris,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait banka hareketleri mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Kasa hareketleri kontrolü\r\n\t\t\t$this->db->where('kh_cariID', $cari_id);\r\n\t\t\t$kasa_hareketleri = $this->db->count_all_results('kasahareketleri');\r\n\t\t\tif ($kasa_hareketleri > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Kasa Hareketleri',\r\n\t\t\t\t\t'adet' => $kasa_hareketleri,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait kasa hareketleri mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Çek kontrolü\r\n\t\t\t$this->db->where('cek_cariID', $cari_id);\r\n\t\t\t$cekler = $this->db->count_all_results('cek');\r\n\t\t\tif ($cekler > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Çekler',\r\n\t\t\t\t\t'adet' => $cekler,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait çek kayıtları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Senet kontrolü\r\n\t\t\t$this->db->where('senet_cariID', $cari_id);\r\n\t\t\t$senetler = $this->db->count_all_results('senet');\r\n\t\t\tif ($senetler > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Senetler',\r\n\t\t\t\t\t'adet' => $senetler,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait senet kayıtları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Aktivasyon kontrolü\r\n\t\t\t$this->db->where('aktivasyon_cari_id', $cari_id);\r\n\t\t\t$aktivasyonlar = $this->db->count_all_results('aktivasyon');\r\n\t\t\tif ($aktivasyonlar > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Aktivasyonlar',\r\n\t\t\t\t\t'adet' => $aktivasyonlar,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait aktivasyon kayıtları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Potansiyel satış kontrolü\r\n\t\t\t$this->db->where('potansiyel_cari_id', $cari_id);\r\n\t\t\t$potansiyel_satislar = $this->db->count_all_results('potansiyel_satis');\r\n\t\t\tif ($potansiyel_satislar > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Potansiyel Satışlar',\r\n\t\t\t\t\t'adet' => $potansiyel_satislar,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait potansiyel satış kayıtları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Muhasebe tahsilat durum kontrolü (indirekt bağlantı)\r\n\t\t\t$muhasebe_tahsilat = $this->db->query(\"\r\n\t\t\t\tSELECT COUNT(*) as toplam FROM muhasebe_tahsilat_durum mtd\r\n\t\t\t\tWHERE (\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND mtd.kayit_id IN (SELECT bh_id FROM bankahareketleri WHERE bh_cariID = ?)) OR\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND mtd.kayit_id IN (SELECT cek_id FROM cek WHERE cek_cariID = ?)) OR\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND mtd.kayit_id IN (SELECT kh_id FROM kasahareketleri WHERE kh_cariID = ?)) OR\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND mtd.kayit_id IN (SELECT senet_id FROM senet WHERE senet_cariID = ?))\r\n\t\t\t\t)\r\n\t\t\t\", [$cari_id, $cari_id, $cari_id, $cari_id])->row()->toplam;\r\n\t\t\t\r\n\t\t\tif ($muhasebe_tahsilat > 0) {\r\n\t\t\t\t$bagimli_veriler[] = [\r\n\t\t\t\t\t'tablo' => 'Muhasebe Tahsilat Durum',\r\n\t\t\t\t\t'adet' => $muhasebe_tahsilat,\r\n\t\t\t\t\t'aciklama' => 'Bu cariye ait muhasebe tahsilat durum kayıtları mevcut'\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\t// Eğer bağımlı veri varsa uyarı göster\r\n\t\t\tif (!empty($bagimli_veriler)) {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'warning',\r\n\t\t\t\t\t'message' => 'Bu cari kaydının silinmesi durumunda aşağıdaki veriler de silinecektir:',\r\n\t\t\t\t\t'data' => $bagimli_veriler,\r\n\t\t\t\t\t'cari_bilgi' => [\r\n\t\t\t\t\t\t'id' => $cari->cari_id,\r\n\t\t\t\t\t\t'ad' => $cari->cari_ad . ($cari->cari_soyad ? ' ' . $cari->cari_soyad : ''),\r\n\t\t\t\t\t\t'telefon' => $cari->cari_firmaTelefon\r\n\t\t\t\t\t]\r\n\t\t\t\t]);\r\n\t\t\t} else {\r\n\t\t\t\t// Bağımlı veri yoksa doğrudan silme onayı iste\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'confirm',\r\n\t\t\t\t\t'message' => 'Bu cari kaydı silinecektir. Devam etmek istiyor musunuz?',\r\n\t\t\t\t\t'cari_bilgi' => [\r\n\t\t\t\t\t\t'id' => $cari->cari_id,\r\n\t\t\t\t\t\t'ad' => $cari->cari_ad . ($cari->cari_soyad ? ' ' . $cari->cari_soyad : ''),\r\n\t\t\t\t\t\t'telefon' => $cari->cari_firmaTelefon\r\n\t\t\t\t\t]\r\n\t\t\t\t]);\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Kontrol sırasında hata oluştu: ' . $e->getMessage()]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Cari Silme İşlemi - GÜVENLİ VERSİYON\r\n\t */\r\n\tpublic function cari_sil()\r\n\t{\r\n\t\t// JSON header ayarla\r\n\t\theader('Content-Type: application/json');\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$cari_id = isset($_POST['cari_id']) ? $_POST['cari_id'] : null;\r\n\t\t\t$onay = isset($_POST['onay']) ? $_POST['onay'] : null;\r\n\t\t\t\r\n\t\t\t// Temel validasyon\r\n\t\t\tif (!$cari_id || $onay !== 'evet') {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'error',\r\n\t\t\t\t\t'message' => 'Geçersiz parametreler'\r\n\t\t\t\t]);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Numeric kontrolü\r\n\t\t\tif (!is_numeric($cari_id) || intval($cari_id) <= 0) {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'error',\r\n\t\t\t\t\t'message' => 'Geçersiz Cari ID formatı'\r\n\t\t\t\t]);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$cari_id = intval($cari_id);\r\n\t\t\t\r\n\t\t\t// Yetki kontrolü - grup_modul_yetkisi_var fonksiyonu varsa kullan\r\n\t\t\tif (function_exists('grup_modul_yetkisi_var') && !grup_modul_yetkisi_var(530)) {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'error',\r\n\t\t\t\t\t'message' => 'Bu işlem için yetkiniz bulunmamaktadır'\r\n\t\t\t\t]);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Database ve model yükle\r\n\t\t\tif (!isset($this->db)) {\r\n\t\t\t\t$this->load->database();\r\n\t\t\t}\r\n\t\t\tif (!isset($this->vt)) {\r\n\t\t\t\t$this->load->model('vt');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Cari var mı kontrol et\r\n\t\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n\t\t\tif (!$cari) {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'error',\r\n\t\t\t\t\t'message' => 'Cari bulunamadı'\r\n\t\t\t\t]);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Transaction başlat\r\n\t\t\t$this->db->trans_start();\r\n\t\t\t\r\n\t\t\t$total_deleted = 0;\r\n\t\t\t\r\n\t\t\t// 1. İlişkili stok kayıtlarını sil\r\n\t\t\t$stok_queries = [\r\n\t\t\t\t\"DELETE sfs FROM satisFaturasiStok sfs \r\n\t\t\t\t INNER JOIN satisFaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n\t\t\t\t WHERE sf.satis_cariID = ?\",\r\n\t\t\t\t\"DELETE als FROM alisFaturasiStok als \r\n\t\t\t\t INNER JOIN alisFaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n\t\t\t\t WHERE af.alis_cariID = ?\",\r\n\t\t\t\t\"DELETE pfs FROM proformaFaturasiStok pfs \r\n\t\t\t\t INNER JOIN proformaFaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n\t\t\t\t WHERE pf.proforma_cariID = ?\"\r\n\t\t\t];\r\n\t\t\t\r\n\t\t\tforeach ($stok_queries as $query) {\r\n\t\t\t\t$this->db->query($query, [$cari_id]);\r\n\t\t\t\t$total_deleted += $this->db->affected_rows();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// 2. Ana tabloları sil\r\n\t\t\t$tables_to_delete = [\r\n\t\t\t\t['table' => 'carihareketleri', 'where' => 'ch_cariID'],\r\n\t\t\t\t['table' => 'satisFaturasi', 'where' => 'satis_cariID'],\r\n\t\t\t\t['table' => 'alisFaturasi', 'where' => 'alis_cariID'],\r\n\t\t\t\t['table' => 'proformaFaturasi', 'where' => 'proforma_cariID'],\r\n\t\t\t\t['table' => 'bankahareketleri', 'where' => 'bh_cariID'],\r\n\t\t\t\t['table' => 'kasahareketleri', 'where' => 'kh_cariID'],\r\n\t\t\t\t['table' => 'cek', 'where' => 'cek_cariID'],\r\n\t\t\t\t['table' => 'senet', 'where' => 'senet_cariID'],\r\n\t\t\t\t['table' => 'aktivasyon', 'where' => 'aktivasyon_cari_id'],\r\n\t\t\t\t['table' => 'potansiyel_satis', 'where' => 'potansiyel_cari_id'],\r\n\t\t\t\t['table' => 'caridetaylibanka', 'where' => 'cdetayBanka_cariID'],\r\n\t\t\t\t['table' => 'caridetayliiletisim', 'where' => 'cdetay_cariID']\r\n\t\t\t];\r\n\t\t\t\r\n\t\t\tforeach ($tables_to_delete as $table_info) {\r\n\t\t\t\t$this->db->where($table_info['where'], $cari_id);\r\n\t\t\t\t$this->db->delete($table_info['table']);\r\n\t\t\t\t$total_deleted += $this->db->affected_rows();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// 3. Son olarak cari kaydını sil\r\n\t\t\t$this->db->where('cari_id', $cari_id);\r\n\t\t\t$this->db->delete('cari');\r\n\t\t\t$cari_deleted = $this->db->affected_rows();\r\n\t\t\t$total_deleted += $cari_deleted;\r\n\t\t\t\r\n\t\t\tif ($cari_deleted === 0) {\r\n\t\t\t\tthrow new Exception(\"Cari kaydı silinemedi\");\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Transaction'ı tamamla\r\n\t\t\t$this->db->trans_complete();\r\n\t\t\t\r\n\t\t\tif ($this->db->trans_status() === FALSE) {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'error',\r\n\t\t\t\t\t'message' => 'Silme işlemi sırasında veritabanı hatası oluştu'\r\n\t\t\t\t]);\r\n\t\t\t} else {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'status' => 'success',\r\n\t\t\t\t\t'message' => $cari->cari_ad . ' adlı cari ve bağlı tüm veriler başarıyla silindi. (Toplam ' . $total_deleted . ' kayıt)'\r\n\t\t\t\t]);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\tif (isset($this->db)) {\r\n\t\t\t\t$this->db->trans_rollback();\r\n\t\t\t}\r\n\t\t\techo json_encode([\r\n\t\t\t\t'status' => 'error',\r\n\t\t\t\t'message' => 'Silme işlemi sırasında hata oluştu: ' . $e->getMessage()\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tam Ana Rapor - ID: 531\r\n\t */\r\n\tpublic function tam_ana_rapor()\r\n\t{\r\n\t\t// Memory limit artır (performans için)\r\n\t\tini_set('memory_limit', '512M');\r\n\t\tini_set('max_execution_time', 600);\r\n\t\t\r\n\t\t// Yetki kontrolü\r\n\t\t$control2 = session(\"r\", \"login\");\r\n\t\tif (!grup_modul_yetkisi_var(531)) {\r\n\t\t\tredirect(base_url(\"illegal\"));\r\n\t\t}\r\n\t\t\r\n\t\t$data = [];\r\n\t\t\r\n\t\t// Arama parametrelerini al\r\n\t\t$cari_search = $this->input->get('cari_search');\r\n\t\t$aktivasyon_durum = $this->input->get('aktivasyon_durum');\r\n\t\t\r\n\t\ttry {\r\n\t\t// WHERE koşulları için dizi\r\n\t\t$where_conditions = ['c.cari_durum = 1'];\r\n\t\t\r\n\t\t// Cari arama koşulu ekleme\r\n\t\tif (!empty($cari_search)) {\r\n\t\t\t$search_term = $this->db->escape_like_str($cari_search);\r\n\t\t\t$where_conditions[] = \"(\r\n\t\t\t\tc.cari_ad LIKE '%{$search_term}%' OR \r\n\t\t\t\tc.cari_soyad LIKE '%{$search_term}%' OR \r\n\t\t\t\tc.cari_vergiNumarasi LIKE '%{$search_term}%' OR \r\n\t\t\t\tc.cari_firmaTelefon LIKE '%{$search_term}%' OR \r\n\t\t\t\tc.cari_tckn LIKE '%{$search_term}%'\r\n\t\t\t)\";\r\n\t\t}\r\n\t\t\r\n\t\t// WHERE koşullarını birleştir\r\n\t\t$where_clause = 'WHERE ' . implode(' AND ', $where_conditions);\r\n\t\t\r\n\t\t// Aktivasyon durum filtresi için HAVING koşulu\r\n\t\t$having_clause = '';\r\n\t\tif (!empty($aktivasyon_durum)) {\r\n\t\t\t$having_clause = \"HAVING aktivasyon_durum = '\" . $this->db->escape_str($aktivasyon_durum) . \"'\";\r\n\t\t}\r\n\t\t\r\n\t\t// Tam Ana Rapor sorgusu\r\n\t\t$query = \"\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\tc.cari_id,\r\n\t\t\t\tc.cari_ad,\r\n\t\t\t\tc.cari_soyad,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n\t\t\t\t\tTHEN c.cari_ad \r\n\t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n\t\t\t\tEND as cari_isletme,\r\n\t\t\t\t\r\n\t\t\t\t-- Kayıt tarihi (en yeni önce sıralama için)\r\n\t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n\t\t\t\t\r\n\t\t\t\t-- Satış sözleşmesi bilgileri (en yeni satış)\r\n\t\t\t\t(SELECT sf2.satis_id FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n\t\t\t\t-- Toplam satış sayısı\r\n\t\t\t\t(SELECT COUNT(*) FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id) as toplam_satis_sayisi,\r\n\t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - birden fazla stok göstermek için GROUP_CONCAT kullan\r\n\t\t\t\t(SELECT GROUP_CONCAT(\r\n\t\t\t\t\tCASE \r\n\t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 1 THEN 'DIGITURK'\r\n\t\t\t\t\t\tWHEN s.stok_id = 16 THEN 'S SPORT'\r\n\t\t\t\t\t\tWHEN s.stok_id = 13 THEN 'TABII'\r\n\t\t\t\t\t\tELSE s.stok_ad\r\n\t\t\t\t\tEND\r\n\t\t\t\t\tSEPARATOR ', '\r\n\t\t\t\t )\r\n\t\t\t\t FROM satisFaturasi sf2 \r\n\t\t\t\t INNER JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf2.satis_id\r\n\t\t\t\t INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n\t\t\t\t WHERE sf2.satis_cariID = c.cari_id AND sf2.satis_id = (\r\n\t\t\t\t\t SELECT sf3.satis_id FROM satisFaturasi sf3 WHERE sf3.satis_cariID = c.cari_id ORDER BY sf3.satis_id DESC LIMIT 1\r\n\t\t\t\t )\r\n\t\t\t\t GROUP BY sf2.satis_id\r\n\t\t\t\t) as satis_sozlesme_hizmeti,\r\n\t\t\t\t\r\n\t\t\t\t-- İşletme görsel sayısını hesapla (fotograf_dosya kolonundan)\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN c.fotograf_dosya IS NOT NULL AND c.fotograf_dosya != '' \r\n\t\t\t\t\tTHEN (LENGTH(c.fotograf_dosya) - LENGTH(REPLACE(c.fotograf_dosya, ',', '')) + 1)\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND as isletme_gorsel_sayisi,\r\n\t\t\t\t\r\n\t\t\t\t-- Evrak sayısını hesapla  \r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN c.evrak_dosya IS NOT NULL AND c.evrak_dosya != '' \r\n\t\t\t\t\tTHEN (LENGTH(c.evrak_dosya) - LENGTH(REPLACE(c.evrak_dosya, ',', '')) + 1)\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND as evrak_sayisi,\r\n\t\t\t\t\r\n\t\t\t\t-- Satış görsel sayısını hesapla (en yeni satıştan)\r\n\t\t\t\t(SELECT CASE \r\n\t\t\t\t\tWHEN sf2.satis_dosya IS NOT NULL AND sf2.satis_dosya != '' \r\n\t\t\t\t\tTHEN (LENGTH(sf2.satis_dosya) - LENGTH(REPLACE(sf2.satis_dosya, ',', '')) + 1)\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_gorsel_sayisi,\r\n\t\t\t\t\r\n\t\t\t\t-- Banka görsel sayısını hesapla\r\n\t\t\t\tCOALESCE(banka_gorseller.banka_gorsel_sayisi, 0) as banka_gorsel_sayisi,\r\n\t\t\t\t\r\n\t\t\t\t-- Çek görsel sayısını hesapla\r\n\t\t\t\tCOALESCE(cek_gorseller.cek_gorsel_sayisi, 0) as cek_gorsel_sayisi,\r\n\t\t\t\t\r\n\t\t\t\t-- Senet görsel sayısını hesapla\r\n\t\t\t\tCOALESCE(senet_gorseller.senet_gorsel_sayisi, 0) as senet_gorsel_sayisi,\r\n\t\t\t\t\r\n\t\t\t\t-- Tahsilat görsel sayısını hesapla (carihareketleri ile bağlantılı tablolardan)\r\n\t\t\t\tCOALESCE(tahsilat_gorseller.toplam_gorsel, 0) as tahsilat_gorsel_sayisi,\r\n\t\t\t\t\r\n\t\t\t\tNULL as evrak_gorselleri,\r\n\t\t\t\tNULL as sozlesme_gorselleri,\r\n\t\t\t\tNULL as tahsilat_gorselleri,\r\n\t\t\t\t\r\n\t\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap (banka, çek, kasa, senet)\r\n\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n\t\t\t\t\r\n\t\t\t\t-- Aktivasyon durumu (en yeni aktivasyondan)\r\n\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_adi, 'Tanımlanmamış') \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_renk, '#6c757d') \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum_renk,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_durum_id \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum_id,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT ad2.durum \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum_aktif,\r\n\t\t\t\t\r\n\t\t\t\t(SELECT a2.aktivasyon_id \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_id,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_tarihi \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_tarihi,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.olusturma_tarihi \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as olusturma_tarihi,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_uye_no \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_uye_no,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_kutu_no \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kutu_no,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_kart_no \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kart_no,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_aciklama \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_aciklama,\r\n\t\t\t\t \r\n\t\t\t\t(SELECT a2.aktivasyon_kampanya_kodu \r\n\t\t\t\t FROM aktivasyon a2 \r\n\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kampanya_kodu,\r\n\t\t\t\t\r\n\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel,\r\n\t\t\t\tk.kullanici_eposta,\r\n\t\t\t\tk.kullanici_id\r\n\t\t\t\t\r\n\t\t\tFROM cari c\r\n\t\t\t\r\n\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap\r\n\t\t\tLEFT JOIN (\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tc2.cari_id,\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t-- Banka/Pos tahsilatları\r\n\t\t\t\t\t\tCOALESCE((SELECT SUM(bh.bh_giris) FROM bankahareketleri bh WHERE bh.bh_cariID = c2.cari_id), 0) +\r\n\t\t\t\t\t\t-- Çek tahsilatları  \r\n\t\t\t\t\t\tCOALESCE((SELECT SUM(ck.cek_tutar) FROM cek ck WHERE ck.cek_cariID = c2.cari_id), 0) +\r\n\t\t\t\t\t\t-- Kasa/Nakit tahsilatları\r\n\t\t\t\t\t\tCOALESCE((SELECT SUM(kh.kh_giris) FROM kasahareketleri kh WHERE kh.kh_cariID = c2.cari_id), 0) +\r\n\t\t\t\t\t\t-- Senet tahsilatları\r\n\t\t\t\t\t\tCOALESCE((SELECT SUM(s.senet_tutar) FROM senet s WHERE s.senet_cariID = c2.cari_id), 0)\r\n\t\t\t\t\t) as toplam_tahsilat\r\n\t\t\t\tFROM cari c2\r\n\t\t\t) ch_toplam ON c.cari_id = ch_toplam.cari_id\r\n\t\t\t\r\n\t\t\t-- Banka görselleri sayısını al\r\n\t\t\tLEFT JOIN (\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tbh_cariID,\r\n\t\t\t\t\tCOUNT(CASE WHEN bh_gorsel IS NOT NULL AND bh_gorsel != '' THEN 1 END) as banka_gorsel_sayisi\r\n\t\t\t\tFROM bankahareketleri \r\n\t\t\t\tWHERE bh_cariID IS NOT NULL\r\n\t\t\t\tGROUP BY bh_cariID\r\n\t\t\t) banka_gorseller ON c.cari_id = banka_gorseller.bh_cariID\r\n\t\t\t\r\n\t\t\t-- Çek görsel sayısını al\r\n\t\t\tLEFT JOIN (\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tcek_cariID,\r\n\t\t\t\t\tCOUNT(CASE WHEN cek_gorsel IS NOT NULL AND cek_gorsel != '' THEN 1 END) as cek_gorsel_sayisi\r\n\t\t\t\tFROM cek \r\n\t\t\t\tWHERE cek_cariID IS NOT NULL\r\n\t\t\t\tGROUP BY cek_cariID\r\n\t\t\t) cek_gorseller ON c.cari_id = cek_gorseller.cek_cariID\r\n\t\t\t\r\n\t\t\t-- Senet görsel sayısını al\r\n\t\t\tLEFT JOIN (\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tsenet_cariID,\r\n\t\t\t\t\tCOUNT(CASE WHEN senet_gorsel IS NOT NULL AND senet_gorsel != '' THEN 1 END) as senet_gorsel_sayisi\r\n\t\t\t\tFROM senet \r\n\t\t\t\tWHERE senet_cariID IS NOT NULL\r\n\t\t\t\tGROUP BY senet_cariID\r\n\t\t\t) senet_gorseller ON c.cari_id = senet_gorseller.senet_cariID\r\n\t\t\t\r\n\t\t\t-- Tahsilat görsellerini say (bankahareketleri ve kasahareketleri)\r\n\t\t\tLEFT JOIN (\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tch.ch_cariID,\r\n\t\t\t\t\tSUM(\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN bh.bh_gorsel IS NOT NULL AND bh.bh_gorsel != '' \r\n\t\t\t\t\t\t\tTHEN (LENGTH(bh.bh_gorsel) - LENGTH(REPLACE(bh.bh_gorsel, ',', '')) + 1)\r\n\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\tEND +\r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN kh.kh_gorsel IS NOT NULL AND kh.kh_gorsel != '' \r\n\t\t\t\t\t\t\tTHEN (LENGTH(kh.kh_gorsel) - LENGTH(REPLACE(kh.kh_gorsel, ',', '')) + 1)\r\n\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t) as toplam_gorsel\r\n\t\t\t\tFROM carihareketleri ch\r\n\t\t\t\tLEFT JOIN bankahareketleri bh ON ch.ch_bhID = bh.bh_id\r\n\t\t\t\tLEFT JOIN kasahareketleri kh ON ch.ch_khID = kh.kh_id\r\n\t\t\t\tWHERE ch.ch_alacak IS NOT NULL AND ch.ch_alacak > 0\r\n\t\t\t\tGROUP BY ch.ch_cariID\r\n\t\t\t) tahsilat_gorseller ON c.cari_id = tahsilat_gorseller.ch_cariID\r\n\t\t\t\r\n\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n\t\t\t\r\n\t\t\t{$where_clause}\r\n\t\t\tGROUP BY c.cari_id\r\n\t\t\t{$having_clause}\r\n\t\t\tORDER BY \r\n\t\t\t\tCASE WHEN c.cari_olusturmaTarihi IS NULL THEN 1 ELSE 0 END,\r\n\t\t\t\tc.cari_olusturmaTarihi DESC, \r\n\t\t\t\tc.cari_ad, c.cari_soyad\r\n\t\t\";\r\n\t\t\t\r\n\t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n\t\t\t\r\n\t\t\t// İstatistikler\r\n\t\t\t$data[\"toplam_kayit\"] = count($data[\"rapor_verileri\"]);\r\n\t\t\t\r\n\t\t\t$toplam_satis_tutar = 0;\r\n\t\t\t$toplam_tahsilat_tutar = 0;\r\n\t\t\t$onaylanan_sayisi = 0;\r\n\t\t\t$onay_bekleyen_sayisi = 0;\r\n\t\t\t\r\n\t\t\tforeach($data[\"rapor_verileri\"] as $veri) {\r\n\t\t\t\tif($veri->satis_sozlesme_tutar_kdv_dahil) {\r\n\t\t\t\t\t$toplam_satis_tutar += $veri->satis_sozlesme_tutar_kdv_dahil;\r\n\t\t\t\t}\r\n\t\t\t\tif($veri->tahsilat_tutar) {\r\n\t\t\t\t\t$toplam_tahsilat_tutar += $veri->tahsilat_tutar;\r\n\t\t\t\t}\r\n\t\t\t\t// Aktivasyon durumuna göre sayaçları güncelle\r\n\t\t\t\tif($veri->aktivasyon_durum == 'Aktif' || $veri->aktivasyon_durum == 'Tamamlandı') {\r\n\t\t\t\t\t$onaylanan_sayisi++;\r\n\t\t\t\t}\r\n\t\t\t\tif($veri->aktivasyon_durum == 'Beklemede' || $veri->aktivasyon_durum == 'İşlemde') {\r\n\t\t\t\t\t$onay_bekleyen_sayisi++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$data[\"toplam_satis_tutar\"] = $toplam_satis_tutar;\r\n\t\t\t$data[\"toplam_tahsilat_tutar\"] = $toplam_tahsilat_tutar;\r\n\t\t\t$data[\"onaylanan_sayisi\"] = $onaylanan_sayisi;\r\n\t\t\t$data[\"onay_bekleyen_sayisi\"] = $onay_bekleyen_sayisi;\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$data[\"error_message\"] = \"Veri yuklenirken bir hata olustu: \" . $e->getMessage();\r\n\t\t\t$data[\"rapor_verileri\"] = [];\r\n\t\t}\r\n\t\t\r\n\t\t// View yukle\r\n\t\t$this->load->view(\"muhasebe/tam-ana-rapor\", $data);\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tahsilat detaylarını getir - AJAX\r\n\t */\r\n\tpublic function getTahsilatDetay()\r\n\t{\r\n\t\t// AJAX isteği kontrolü - Geçici olarak devre dışı\r\n\t\t// if (!$this->input->is_ajax_request()) {\r\n\t\t//\tshow_404();\r\n\t\t//\treturn;\r\n\t\t// }\r\n\t\t\r\n\t\t$cari_id = $this->input->post('cari_id');\r\n\t\t\r\n\t\tif (!$cari_id) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// Tahsilat detaylarını farklı tablolardan getir - cari hareket ID'si ve görsel alanları ile birlikte\r\n\t\t\t$query = \"\r\n\t\t\t\t-- Banka/Pos tahsilatları\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tCONCAT('bh_', bh.bh_id) as unique_id,\r\n\t\t\t\t\tbh.bh_id as source_id,\r\n\t\t\t\t\t'Banka/Pos' as tahsilat_tipi,\r\n\t\t\t\t\tbh.bh_tarih as tarih,\r\n\t\t\t\t\tbh.bh_belgeNumarasi as belge_no,\r\n\t\t\t\t\tbh.bh_giris as tutar,\r\n\t\t\t\t\tbh.bh_aciklama as aciklama,\r\n\t\t\t\t\tb.banka_bankaAd as detay,\r\n\t\t\t\t\t'1' as tip_kod,\r\n\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n\t\t\t\t\tbh.bh_gorsel as gorsel_dosya,\r\n\t\t\t\t\t'dekontlar' as gorsel_klasor,\r\n\t\t\t\t\tNULL as vade_tarih\r\n\t\t\t\tFROM bankahareketleri bh\r\n\t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_bankaID = bh.bh_id AND ch.ch_cariID = bh.bh_cariID\r\n\t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n\t\t\t\t\r\n\t\t\t\tUNION ALL\r\n\t\t\t\t\r\n\t\t\t\t-- Çek tahsilatları  \r\n\t\t\t\tSELECT \r\n\t\t\t\t\tCONCAT('cek_', c.cek_id) as unique_id,\r\n\t\t\t\t\tc.cek_id as source_id,\r\n\t\t\t\t\t'Çek' as tahsilat_tipi,\r\n\t\t\t\t\tc.cek_vadeTarih as tarih,\r\n\t\t\t\t\tc.cek_portfoyNo as belge_no,\r\n\t\t\t\t\tc.cek_tutar as tutar,\r\n\t\t\t\t\tc.cek_notAciklama as aciklama,\r\n\t\t\t\t\tCONCAT('Çek No: ', c.cek_portfoyNo) as detay,\r\n\t\t\t\t\t'2' as tip_kod,\r\n\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n\t\t\t\t\tc.cek_gorsel as gorsel_dosya,\r\n\t\t\t\t\t'cekler' as gorsel_klasor,\r\n\t\t\t\t\tc.cek_vadeTarih as vade_tarih\r\n\t\t\t\tFROM cek c\r\n\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_cekID = c.cek_id AND ch.ch_cariID = c.cek_cariID\r\n\t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n\t\t\t\t\r\n\t\t\t\tUNION ALL\r\n\t\t\t\t\r\n\t\t\t\t-- Kasa/Nakit tahsilatları\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tCONCAT('kh_', kh.kh_id) as unique_id,\r\n\t\t\t\t\tkh.kh_id as source_id,\r\n\t\t\t\t\t'Kasa/Nakit' as tahsilat_tipi,\r\n\t\t\t\t\tkh.kh_tarih as tarih,\r\n\t\t\t\t\tkh.kh_belgeNumarasi as belge_no,\r\n\t\t\t\t\tkh.kh_giris as tutar,\r\n\t\t\t\t\tkh.kh_aciklama as aciklama,\r\n\t\t\t\t\tk.kasa_adi as detay,\r\n\t\t\t\t\t'3' as tip_kod,\r\n\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n\t\t\t\t\tNULL as gorsel_dosya,\r\n\t\t\t\t\tNULL as gorsel_klasor,\r\n\t\t\t\t\tNULL as vade_tarih\r\n\t\t\t\tFROM kasahareketleri kh\r\n\t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_kasaID = kh.kh_id AND ch.ch_cariID = kh.kh_cariID\r\n\t\t\t\tWHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n\t\t\t\t\r\n\t\t\t\tUNION ALL\r\n\t\t\t\t\r\n\t\t\t\t-- Senet tahsilatları\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tCONCAT('s_', s.senet_id) as unique_id,\r\n\t\t\t\t\ts.senet_id as source_id,\r\n\t\t\t\t\t'Senet' as tahsilat_tipi,\r\n\t\t\t\t\ts.senet_vadeTarih as tarih,\r\n\t\t\t\t\ts.senet_portfoyNo as belge_no,\r\n\t\t\t\t\ts.senet_tutar as tutar,\r\n\t\t\t\t\ts.senet_notAciklama as aciklama,\r\n\t\t\t\t\tCONCAT('Senet No: ', s.senet_portfoyNo) as detay,\r\n\t\t\t\t\t'4' as tip_kod,\r\n\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n\t\t\t\t\ts.senet_gorsel as gorsel_dosya,\r\n\t\t\t\t\t'senetler' as gorsel_klasor,\r\n\t\t\t\t\ts.senet_vadeTarih as vade_tarih\r\n\t\t\t\tFROM senet s\r\n\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_senetID = s.senet_id AND ch.ch_cariID = s.senet_cariID\r\n\t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n\t\t\t\t\r\n\t\t\t\tORDER BY tarih DESC\r\n\t\t\t\";\r\n\t\t\t\r\n\t\t\t$result = $this->db->query($query, [$cari_id, $cari_id, $cari_id, $cari_id])->result();\r\n\t\t\t\r\n\t\t\t// Her kayıt için çoklu görsel bilgilerini al\r\n\t\t\tforeach ($result as $row) {\r\n\t\t\t\t$row->gorseller = $this->getTahsilatGorselleri($row->tip_kod, $row->source_id);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Tarihleri formatla\r\n\t\t\tforeach ($result as $row) {\r\n\t\t\t\t$row->tarih = date('d.m.Y', strtotime($row->tarih));\r\n\t\t\t\t// Vade tarihini formatla (sadece çek ve senet için)\r\n\t\t\t\tif ($row->vade_tarih) {\r\n\t\t\t\t\t$row->vade_tarih_formatted = date('d.m.Y', strtotime($row->vade_tarih));\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$row->vade_tarih_formatted = '-';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => true,\r\n\t\t\t\t'data' => $result,\r\n\t\t\t\t'count' => count($result)\r\n\t\t\t]);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => false,\r\n\t\t\t\t'message' => 'Veri alınırken hata oluştu: ' . $e->getMessage()\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tahsilat görsel listesini getir (çoklu)\r\n\t */\r\n\tprivate function getTahsilatGorselleri($tipKod, $sourceId)\r\n\t{\r\n\t\t$gorseller = [];\r\n\t\t\r\n\t\ttry {\r\n\t\t\tswitch($tipKod) {\r\n\t\t\t\tcase '1': // Banka\r\n\t\t\t\t\t$record = $this->db->select('bh_gorsel')->where('bh_id', $sourceId)->get('bankahareketleri')->row();\r\n\t\t\t\t\tif ($record && $record->bh_gorsel) {\r\n\t\t\t\t\t\t$dosya_listesi = explode(',', $record->bh_gorsel);\r\n\t\t\t\t\t\t$dosya_listesi = array_filter($dosya_listesi); // Boş elemanları temizle\r\n\t\t\t\t\t\tforeach ($dosya_listesi as $index => $dosya) {\r\n\t\t\t\t\t\t\t$gorseller[] = [\r\n\t\t\t\t\t\t\t\t'id' => 'bh_' . $sourceId . '_' . $index,\r\n\t\t\t\t\t\t\t\t'dosya_adi' => $dosya,\r\n\t\t\t\t\t\t\t\t'klasor' => 'dekontlar',\r\n\t\t\t\t\t\t\t\t'url' => base_url('assets/uploads/dekontlar/' . $dosya),\r\n\t\t\t\t\t\t\t\t'tip' => $index === 0 ? 'ana' : 'ek'\r\n\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tcase '2': // Çek\r\n\t\t\t\t\t$record = $this->db->select('cek_gorsel')->where('cek_id', $sourceId)->get('cek')->row();\r\n\t\t\t\t\tif ($record && $record->cek_gorsel) {\r\n\t\t\t\t\t\t$dosya_listesi = explode(',', $record->cek_gorsel);\r\n\t\t\t\t\t\t$dosya_listesi = array_filter($dosya_listesi);\r\n\t\t\t\t\t\tforeach ($dosya_listesi as $index => $dosya) {\r\n\t\t\t\t\t\t\t$gorseller[] = [\r\n\t\t\t\t\t\t\t\t'id' => 'cek_' . $sourceId . '_' . $index,\r\n\t\t\t\t\t\t\t\t'dosya_adi' => $dosya,\r\n\t\t\t\t\t\t\t\t'klasor' => 'cekler',\r\n\t\t\t\t\t\t\t\t'url' => base_url('assets/uploads/cekler/' . $dosya),\r\n\t\t\t\t\t\t\t\t'tip' => $index === 0 ? 'ana' : 'ek'\r\n\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tcase '4': // Senet\r\n\t\t\t\t\t$record = $this->db->select('senet_gorsel')->where('senet_id', $sourceId)->get('senet')->row();\r\n\t\t\t\t\tif ($record && $record->senet_gorsel) {\r\n\t\t\t\t\t\t$dosya_listesi = explode(',', $record->senet_gorsel);\r\n\t\t\t\t\t\t$dosya_listesi = array_filter($dosya_listesi);\r\n\t\t\t\t\t\tforeach ($dosya_listesi as $index => $dosya) {\r\n\t\t\t\t\t\t\t$gorseller[] = [\r\n\t\t\t\t\t\t\t\t'id' => 's_' . $sourceId . '_' . $index,\r\n\t\t\t\t\t\t\t\t'dosya_adi' => $dosya,\r\n\t\t\t\t\t\t\t\t'klasor' => 'senetler',\r\n\t\t\t\t\t\t\t\t'url' => base_url('assets/uploads/senetler/' . $dosya),\r\n\t\t\t\t\t\t\t\t'tip' => $index === 0 ? 'ana' : 'ek'\r\n\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tcase '3': // Kasa - görsel yok\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// İleride ek görsel tablosu eklenirse burada sorgulanabilir\r\n\t\t\t// Örnek: tahsilat_gorselleri tablosu\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t// Hata durumunda boş array dön\r\n\t\t}\r\n\t\t\r\n\t\treturn $gorseller;\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tahsilat görsel yükleme (çoklu dosya)\r\n\t */\r\n\tpublic function uploadTahsilatGorsel()\r\n\t{\r\n\t\ttry {\r\n\t\t\t$tip = $this->input->post('tip'); // 'bh', 'cek', 'senet'\r\n\t\t\t$id = $this->input->post('id');\r\n\t\t\t\r\n\t\t\tif (!$tip || !$id) {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Tip ve ID gerekli']);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Dosya yükleme konfigürasyonu\r\n\t\t\t$config['upload_path'] = './assets/uploads/';\r\n\t\t\t$config['allowed_types'] = 'gif|jpg|png|jpeg|pdf';\r\n\t\t\t$config['max_size'] = 10240; // 10MB\r\n\t\t\t$config['encrypt_name'] = TRUE;\r\n\t\t\t\r\n\t\t\t// Tip'e göre klasör belirleme\r\n\t\t\tswitch($tip) {\r\n\t\t\t\tcase 'bh':\r\n\t\t\t\t\t$config['upload_path'] .= 'dekontlar/';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'cek':\r\n\t\t\t\t\t$config['upload_path'] .= 'cekler/';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'senet':\r\n\t\t\t\t\t$config['upload_path'] .= 'senetler/';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tip']);\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Klasör yoksa oluştur\r\n\t\t\tif (!is_dir($config['upload_path'])) {\r\n\t\t\t\tmkdir($config['upload_path'], 0777, true);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$this->load->library('upload', $config);\r\n\t\t\t\r\n\t\t\t$uploaded_files = [];\r\n\t\t\t$upload_errors = [];\r\n\t\t\t\r\n\t\t\t// Çoklu dosya kontrolü\r\n\t\t\tif (isset($_FILES['gorseller']) && is_array($_FILES['gorseller']['name'])) {\r\n\t\t\t\t// Çoklu dosya yükleme\r\n\t\t\t\t$file_count = count($_FILES['gorseller']['name']);\r\n\t\t\t\t\r\n\t\t\t\tfor ($i = 0; $i < $file_count; $i++) {\r\n\t\t\t\t\tif ($_FILES['gorseller']['error'][$i] == 0) {\r\n\t\t\t\t\t\t// Dosya bilgilerini tek dosya formatına çevir\r\n\t\t\t\t\t\t$_FILES['single_file']['name'] = $_FILES['gorseller']['name'][$i];\r\n\t\t\t\t\t\t$_FILES['single_file']['type'] = $_FILES['gorseller']['type'][$i];\r\n\t\t\t\t\t\t$_FILES['single_file']['tmp_name'] = $_FILES['gorseller']['tmp_name'][$i];\r\n\t\t\t\t\t\t$_FILES['single_file']['error'] = $_FILES['gorseller']['error'][$i];\r\n\t\t\t\t\t\t$_FILES['single_file']['size'] = $_FILES['gorseller']['size'][$i];\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif ($this->upload->do_upload('single_file')) {\r\n\t\t\t\t\t\t\t$upload_data = $this->upload->data();\r\n\t\t\t\t\t\t\t$uploaded_files[] = $upload_data['file_name'];\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t$upload_errors[] = $this->upload->display_errors('', '');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// Tek dosya yükleme (mevcut sistem)\r\n\t\t\t\tif ($this->upload->do_upload('gorsel')) {\r\n\t\t\t\t\t$upload_data = $this->upload->data();\r\n\t\t\t\t\t$uploaded_files[] = $upload_data['file_name'];\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$upload_errors[] = $this->upload->display_errors('', '');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!empty($uploaded_files)) {\r\n\t\t\t\t// Mevcut dosyaları al\r\n\t\t\t\t$existing_files = [];\r\n\t\t\t\tswitch($tip) {\r\n\t\t\t\t\tcase 'bh':\r\n\t\t\t\t\t\t$record = $this->db->select('bh_gorsel')->where('bh_id', $id)->get('bankahareketleri')->row();\r\n\t\t\t\t\t\tif ($record && $record->bh_gorsel) {\r\n\t\t\t\t\t\t\t// Virgülle ayrılmış string formatından array'e çevir\r\n\t\t\t\t\t\t\t$existing_files = explode(',', $record->bh_gorsel);\r\n\t\t\t\t\t\t\t$existing_files = array_filter($existing_files); // Boş elemanları temizle\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'cek':\r\n\t\t\t\t\t\t$record = $this->db->select('cek_gorsel')->where('cek_id', $id)->get('cek')->row();\r\n\t\t\t\t\t\tif ($record && $record->cek_gorsel) {\r\n\t\t\t\t\t\t\t$existing_files = explode(',', $record->cek_gorsel);\r\n\t\t\t\t\t\t\t$existing_files = array_filter($existing_files);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'senet':\r\n\t\t\t\t\t\t$record = $this->db->select('senet_gorsel')->where('senet_id', $id)->get('senet')->row();\r\n\t\t\t\t\t\tif ($record && $record->senet_gorsel) {\r\n\t\t\t\t\t\t\t$existing_files = explode(',', $record->senet_gorsel);\r\n\t\t\t\t\t\t\t$existing_files = array_filter($existing_files);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Yeni dosyaları mevcut dosyalarla birleştir\r\n\t\t\t\t$all_files = array_merge($existing_files, $uploaded_files);\r\n\t\t\t\t$files_string = implode(',', $all_files);\r\n\t\t\t\t\r\n\t\t\t\t// Veritabanını güncelle\r\n\t\t\t\tswitch($tip) {\r\n\t\t\t\t\tcase 'bh':\r\n\t\t\t\t\t\t$this->db->where('bh_id', $id);\r\n\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_gorsel' => $files_string]);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'cek':\r\n\t\t\t\t\t\t$this->db->where('cek_id', $id);\r\n\t\t\t\t\t\t$this->db->update('cek', ['cek_gorsel' => $files_string]);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'senet':\r\n\t\t\t\t\t\t$this->db->where('senet_id', $id);\r\n\t\t\t\t\t\t$this->db->update('senet', ['senet_gorsel' => $files_string]);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\theader('Content-Type: application/json');\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'success' => true,\r\n\t\t\t\t\t'message' => count($uploaded_files) . ' görsel başarıyla yüklendi',\r\n\t\t\t\t\t'files' => $uploaded_files,\r\n\t\t\t\t\t'total_files' => count($all_files),\r\n\t\t\t\t\t'errors' => $upload_errors\r\n\t\t\t\t]);\r\n\t\t\t} else {\r\n\t\t\t\theader('Content-Type: application/json');\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'success' => false,\r\n\t\t\t\t\t'message' => 'Yükleme hatası: ' . implode(', ', $upload_errors)\r\n\t\t\t\t]);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => false,\r\n\t\t\t\t'message' => 'Hata: ' . $e->getMessage()\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tahsilat görsel silme\r\n\t */\r\n\tpublic function deleteTahsilatGorsel()\r\n\t{\r\n\t\ttry {\r\n\t\t\t$tip = $this->input->post('tip');\r\n\t\t\t$id = $this->input->post('id');\r\n\t\t\t\r\n\t\t\tif (!$tip || !$id) {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Tip ve ID gerekli']);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Mevcut dosyayı al\r\n\t\t\t$dosya_adi = null;\r\n\t\t\tswitch($tip) {\r\n\t\t\t\tcase 'bh':\r\n\t\t\t\t\t$record = $this->db->select('bh_gorsel')->where('bh_id', $id)->get('bankahareketleri')->row();\r\n\t\t\t\t\t$dosya_adi = $record ? $record->bh_gorsel : null;\r\n\t\t\t\t\t$klasor = 'dekontlar';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'cek':\r\n\t\t\t\t\t$record = $this->db->select('cek_gorsel')->where('cek_id', $id)->get('cek')->row();\r\n\t\t\t\t\t$dosya_adi = $record ? $record->cek_gorsel : null;\r\n\t\t\t\t\t$klasor = 'cekler';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'senet':\r\n\t\t\t\t\t$record = $this->db->select('senet_gorsel')->where('senet_id', $id)->get('senet')->row();\r\n\t\t\t\t\t$dosya_adi = $record ? $record->senet_gorsel : null;\r\n\t\t\t\t\t$klasor = 'senetler';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tip']);\r\n\t\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// JSON array kontrolü ve dosya silme\r\n\t\t\tif ($dosya_adi) {\r\n\t\t\t\t$dosya_listesi = explode(',', $dosya_adi);\r\n\t\t\t\t$dosya_listesi = array_filter($dosya_listesi); // Boş elemanları temizle\r\n\t\t\t\t\r\n\t\t\t\t// Tüm dosyaları sil\r\n\t\t\t\tforeach ($dosya_listesi as $dosya) {\r\n\t\t\t\t\t$dosya_yolu = './assets/uploads/' . $klasor . '/' . $dosya;\r\n\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n\t\t\t\t\t\tunlink($dosya_yolu);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Veritabanını güncelle\r\n\t\t\tswitch($tip) {\r\n\t\t\t\tcase 'bh':\r\n\t\t\t\t\t$this->db->where('bh_id', $id);\r\n\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_gorsel' => null]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'cek':\r\n\t\t\t\t\t$this->db->where('cek_id', $id);\r\n\t\t\t\t\t$this->db->update('cek', ['cek_gorsel' => null]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'senet':\r\n\t\t\t\t\t$this->db->where('senet_id', $id);\r\n\t\t\t\t\t$this->db->update('senet', ['senet_gorsel' => null]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => true,\r\n\t\t\t\t'message' => 'Görsel başarıyla silindi'\r\n\t\t\t]);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tahsilat güncelleme (tutar ve vade tarihi)\r\n\t */\r\n\tpublic function tahsilatGuncelle()\r\n\t{\r\n\t\theader('Content-Type: application/json');\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$degisiklikler = $this->input->post('degisiklikler');\r\n\t\t\t\r\n\t\t\tif (!$degisiklikler || !is_array($degisiklikler)) {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Değişiklik verileri bulunamadı']);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$this->db->trans_start();\r\n\t\t\t$basarili_guncelleme = 0;\r\n\t\t\t$hata_mesajlari = [];\r\n\t\t\t\r\n\t\t\tforeach ($degisiklikler as $degisiklik) {\r\n\t\t\t\t$tip_kod = $degisiklik['tip_kod'];\r\n\t\t\t\t$source_id = $degisiklik['source_id'];\r\n\t\t\t\t$degisiklik_tipi = $degisiklik['degisiklik_tipi'];\r\n\t\t\t\t\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif ($degisiklik_tipi == 'tutar') {\r\n\t\t\t\t\t\t// Tutar güncelleme\r\n\t\t\t\t\t\t$yeni_tutar = floatval($degisiklik['yeni_tutar']);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tswitch($tip_kod) {\r\n\t\t\t\t\t\t\tcase '1': // Banka\r\n\t\t\t\t\t\t\t\t$this->db->where('bh_id', $source_id);\r\n\t\t\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_giris' => $yeni_tutar]);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcase '2': // Çek\r\n\t\t\t\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n\t\t\t\t\t\t\t\t$this->db->update('cek', ['cek_tutar' => $yeni_tutar]);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcase '3': // Kasa\r\n\t\t\t\t\t\t\t\t$this->db->where('kh_id', $source_id);\r\n\t\t\t\t\t\t\t\t$this->db->update('kasahareketleri', ['kh_giris' => $yeni_tutar]);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcase '4': // Senet\r\n\t\t\t\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n\t\t\t\t\t\t\t\t$this->db->update('senet', ['senet_tutar' => $yeni_tutar]);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Cari hareketi de güncelle\r\n\t\t\t\t\t\tif (isset($degisiklik['ch_id']) && $degisiklik['ch_id']) {\r\n\t\t\t\t\t\t\t$this->db->where('ch_id', $degisiklik['ch_id']);\r\n\t\t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t} elseif ($degisiklik_tipi == 'vade_tarihi') {\r\n\t\t\t\t\t\t// Vade tarihi güncelleme (sadece çek ve senet için)\r\n\t\t\t\t\t\t$yeni_vade_tarihi = $degisiklik['yeni_vade_tarihi'];\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif ($tip_kod == '2') { // Çek\r\n\t\t\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n\t\t\t\t\t\t\t$this->db->update('cek', ['cek_vadeTarih' => $yeni_vade_tarihi]);\r\n\t\t\t\t\t\t} elseif ($tip_kod == '4') { // Senet\r\n\t\t\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n\t\t\t\t\t\t\t$this->db->update('senet', ['senet_vadeTarih' => $yeni_vade_tarihi]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t$basarili_guncelleme++;\r\n\t\t\t\t\t\r\n\t\t\t\t} catch (Exception $e) {\r\n\t\t\t\t\t$hata_mesajlari[] = \"ID {$source_id} güncellenirken hata: \" . $e->getMessage();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$this->db->trans_complete();\r\n\t\t\t\r\n\t\t\tif ($this->db->trans_status() === FALSE) {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'success' => false,\r\n\t\t\t\t\t'message' => 'Veritabanı işlemi başarısız: ' . implode(', ', $hata_mesajlari)\r\n\t\t\t\t]);\r\n\t\t\t} else {\r\n\t\t\t\techo json_encode([\r\n\t\t\t\t\t'success' => true,\r\n\t\t\t\t\t'message' => \"{$basarili_guncelleme} adet kayıt başarıyla güncellendi.\",\r\n\t\t\t\t\t'basarili_guncelleme' => $basarili_guncelleme,\r\n\t\t\t\t\t'hata_sayisi' => count($hata_mesajlari)\r\n\t\t\t\t]);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => false,\r\n\t\t\t\t'message' => 'Güncelleme sırasında hata oluştu: ' . $e->getMessage()\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Yeni tahsilat ekleme fonksiyonu\r\n\t */\r\n\tpublic function yeniTahsilatEkle()\r\n\t{\r\n\t\t$tip_kod = $this->input->post('tip_kod');\r\n\t\t$tutar = $this->input->post('tutar');\r\n\t\t$tarih = $this->input->post('tarih');\r\n\t\t$belge_no = $this->input->post('belge_no');\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\t\t$cari_id = $this->input->post('cari_id');\r\n\t\t\r\n\t\tif (!$tip_kod || !$tutar || !$tarih || !$cari_id) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Gerekli alanlar eksik']);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$this->db->trans_start();\r\n\t\t\t\r\n\t\t\t$olusturan = $this->session->userdata('kullanici_id') ?? 1;\r\n\t\t\t$olusturanAnaHesap = $this->session->userdata('anaHesap_id') ?? 1;\r\n\t\t\t$bugun = date('Y-m-d');\r\n\t\t\t$suan = date('H:i:s');\r\n\t\t\t\r\n\t\t\t// Tip koduna göre ilgili tabloya kayıt ekle\r\n\t\t\tswitch($tip_kod) {\r\n\t\t\t\tcase '1': // Banka\r\n\t\t\t\t\t$banka_data = [\r\n\t\t\t\t\t\t'bh_belgeNumarasi' => $belge_no,\r\n\t\t\t\t\t\t'bh_turu' => 1, // Giriş\r\n\t\t\t\t\t\t'bh_giris' => $tutar,\r\n\t\t\t\t\t\t'bh_cikis' => 0,\r\n\t\t\t\t\t\t'bh_cariID' => $cari_id,\r\n\t\t\t\t\t\t'bh_bankaID' => 1, // Varsayılan banka\r\n\t\t\t\t\t\t'bh_tarih' => $tarih,\r\n\t\t\t\t\t\t'bh_aciklama' => $aciklama,\r\n\t\t\t\t\t\t'bh_olusturan' => $olusturan,\r\n\t\t\t\t\t\t'bh_olusturanAnaHesap' => $olusturanAnaHesap,\r\n\t\t\t\t\t\t'bh_olusturmaTarihi' => $bugun,\r\n\t\t\t\t\t\t'bh_olusturmaSaati' => $suan,\r\n\t\t\t\t\t\t'tahsilat_durum_id' => 2\r\n\t\t\t\t\t];\r\n\t\t\t\t\t$this->db->insert('bankahareketleri', $banka_data);\r\n\t\t\t\t\t$source_id = $this->db->insert_id();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tcase '2': // Çek\r\n\t\t\t\t\t$cek_data = [\r\n\t\t\t\t\t\t'cek_cariID' => $cari_id,\r\n\t\t\t\t\t\t'cek_hareketTipi' => 1,\r\n\t\t\t\t\t\t'cek_kayitTarihi' => $tarih,\r\n\t\t\t\t\t\t'cek_notAciklama' => $aciklama,\r\n\t\t\t\t\t\t'cek_portfoyNo' => $belge_no,\r\n\t\t\t\t\t\t'cek_vadeTarih' => $tarih,\r\n\t\t\t\t\t\t'cek_tutar' => $tutar,\r\n\t\t\t\t\t\t'cek_durum' => 1,\r\n\t\t\t\t\t\t'cek_kullaniciID' => $olusturan,\r\n\t\t\t\t\t\t'cek_olusturanAnaHesap' => $olusturanAnaHesap,\r\n\t\t\t\t\t\t'cek_sistemKayitTarihi' => $bugun,\r\n\t\t\t\t\t\t'cek_sistemKayitSaati' => $suan\r\n\t\t\t\t\t];\r\n\t\t\t\t\t$this->db->insert('cek', $cek_data);\r\n\t\t\t\t\t$source_id = $this->db->insert_id();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tcase '3': // Kasa\r\n\t\t\t\t\t$kasa_data = [\r\n\t\t\t\t\t\t'kh_belgeNumarasi' => $belge_no,\r\n\t\t\t\t\t\t'kh_turu' => 1,\r\n\t\t\t\t\t\t'kh_giris' => $tutar,\r\n\t\t\t\t\t\t'kh_cikis' => 0,\r\n\t\t\t\t\t\t'kh_cariID' => $cari_id,\r\n\t\t\t\t\t\t'kh_tarih' => $tarih,\r\n\t\t\t\t\t\t'kh_aciklama' => $aciklama,\r\n\t\t\t\t\t\t'kh_kasaID' => 1, // Varsayılan kasa\r\n\t\t\t\t\t\t'kh_olusturan' => $olusturan,\r\n\t\t\t\t\t\t'kh_olusturanAnaHesap' => $olusturanAnaHesap,\r\n\t\t\t\t\t\t'kh_olusturmaTarihi' => $bugun,\r\n\t\t\t\t\t\t'kh_olusturmaSaati' => $suan\r\n\t\t\t\t\t];\r\n\t\t\t\t\t$this->db->insert('kasahareketleri', $kasa_data);\r\n\t\t\t\t\t$source_id = $this->db->insert_id();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tcase '4': // Senet\r\n\t\t\t\t\t$senet_data = [\r\n\t\t\t\t\t\t'senet_cariID' => $cari_id,\r\n\t\t\t\t\t\t'senet_hareketTipi' => 1,\r\n\t\t\t\t\t\t'senet_kayitTarihi' => $tarih,\r\n\t\t\t\t\t\t'senet_notAciklama' => $aciklama,\r\n\t\t\t\t\t\t'senet_portfoyNo' => $belge_no,\r\n\t\t\t\t\t\t'senet_vadeTarih' => $tarih,\r\n\t\t\t\t\t\t'senet_tutar' => $tutar,\r\n\t\t\t\t\t\t'senet_durum' => 1,\r\n\t\t\t\t\t\t'senet_kullaniciID' => $olusturan,\r\n\t\t\t\t\t\t'senet_olusturanAnaHesap' => $olusturanAnaHesap,\r\n\t\t\t\t\t\t'senet_sistemKayitTarihi' => $bugun,\r\n\t\t\t\t\t\t'senet_sistemKayitSaati' => $suan\r\n\t\t\t\t\t];\r\n\t\t\t\t\t$this->db->insert('senet', $senet_data);\r\n\t\t\t\t\t$source_id = $this->db->insert_id();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\t\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthrow new Exception('Geçersiz tahsilat tipi');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Cari hareket kaydı ekle\r\n\t\t\t$cari_hareket_data = [\r\n\t\t\t\t'ch_cariID' => $cari_id,\r\n\t\t\t\t'ch_sfID' => $satis_id,\r\n\t\t\t\t'ch_tip' => 'Satış Faturası',\r\n\t\t\t\t'ch_borc' => 0,\r\n\t\t\t\t'ch_alacak' => $tutar,\r\n\t\t\t\t'ch_aciklama' => $aciklama,\r\n\t\t\t\t'ch_olusturan' => $olusturan,\r\n\t\t\t\t'ch_olusturanAnaHesap' => $olusturanAnaHesap,\r\n\t\t\t\t'ch_olusturmaTarihi' => $bugun,\r\n\t\t\t\t'ch_olusturmaSaati' => $suan\r\n\t\t\t];\r\n\t\t\t\r\n\t\t\t// İlgili ID'yi ayarla\r\n\t\t\tswitch($tip_kod) {\r\n\t\t\t\tcase '1': $cari_hareket_data['ch_bankaID'] = $source_id; break;\r\n\t\t\t\tcase '2': $cari_hareket_data['ch_cekID'] = $source_id; break;\r\n\t\t\t\tcase '3': $cari_hareket_data['ch_kasaID'] = $source_id; break;\r\n\t\t\t\tcase '4': $cari_hareket_data['ch_senetID'] = $source_id; break;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$this->db->insert('carihareketleri', $cari_hareket_data);\r\n\t\t\t\r\n\t\t\t$this->db->trans_complete();\r\n\t\t\t\r\n\t\t\tif ($this->db->trans_status() === FALSE) {\r\n\t\t\t\tthrow new Exception('Veritabanı işlemi başarısız');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Yeni tahsilat başarıyla eklendi']);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat eklenirken hata oluştu: ' . $e->getMessage()]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Stok görsel yükleme fonksiyonu\r\n\t */\r\n\tpublic function stokGorselYukle()\r\n\t{\r\n\t\t// Debug: Method called\r\n\t\tlog_message('debug', 'stokGorselYukle method called');\r\n\t\tlog_message('debug', 'POST data: ' . print_r($_POST, true));\r\n\t\tlog_message('debug', 'FILES data: ' . print_r($_FILES, true));\r\n\t\t\r\n\t\t$satisStok_id = $this->input->post('satisStok_id');\r\n\t\t$stok_adi = $this->input->post('stok_adi');\r\n\t\t\r\n\t\tif (!$satisStok_id) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Stok ID gerekli']);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t// $_FILES kontrolü - array syntax ile gelen dosyalar\r\n\t\tif (empty($_FILES['stok_gorseller']) || !isset($_FILES['stok_gorseller']['tmp_name'])) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Dosya seçilmedi']);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// Upload path - relative path kullan\r\n\t\t\t$upload_path = './assets/uploads/stok_gorselleri/';\r\n\t\t\tif (!is_dir($upload_path)) {\r\n\t\t\t\tif (!mkdir($upload_path, 0777, true)) {\r\n\t\t\t\t\tthrow new Exception('Upload klasörü oluşturulamadı: ' . $upload_path);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$uploaded_files = [];\r\n\t\t\t$files = $_FILES['stok_gorseller'];\r\n\t\t\t\r\n\t\t\t// Debug: File structure\r\n\t\t\tlog_message('debug', 'File structure: ' . print_r($files, true));\r\n\t\t\t\r\n\t\t\t// Tek dosya mı yoksa çoklu dosya mı kontrolü\r\n\t\t\tif (is_array($files['tmp_name'])) {\r\n\t\t\t\t// Çoklu dosya yükleme işlemi\r\n\t\t\t\t$file_count = count($files['tmp_name']);\r\n\t\t\t\tlog_message('debug', 'Multiple files detected: ' . $file_count);\r\n\t\t\t\t\r\n\t\t\t\tfor ($i = 0; $i < $file_count; $i++) {\r\n\t\t\t\t\tif (isset($files['error'][$i]) && $files['error'][$i] == UPLOAD_ERR_OK) {\r\n\t\t\t\t\t\t$tmp_name = $files['tmp_name'][$i];\r\n\t\t\t\t\t\t$original_name = $files['name'][$i];\r\n\t\t\t\t\t\t$size = $files['size'][$i];\r\n\t\t\t\t\t\t$type = isset($files['type'][$i]) ? $files['type'][$i] : '';\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Dosya boyutu kontrolü (max 10MB)\r\n\t\t\t\t\t\tif ($size > 10 * 1024 * 1024) {\r\n\t\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Dosya tipi kontrolü - daha geniş format desteği\r\n\t\t\t\t\t\t$ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));\r\n\t\t\t\t\t\t$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n\t\t\t\t\t\tif (!in_array($ext, $allowed_extensions)) {\r\n\t\t\t\t\t\t\tthrow new Exception($original_name . ' dosya tipi desteklenmiyor. İzin verilen: ' . implode(', ', $allowed_extensions));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Dosya adını oluştur\r\n\t\t\t\t\t\t$filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n\t\t\t\t\t\t$filepath = $upload_path . $filename;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Debug: File upload attempt\r\n\t\t\t\t\t\tlog_message('debug', 'Attempting to upload: ' . $tmp_name . ' to ' . $filepath);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Dosyayı yükle\r\n\t\t\t\t\t\tif (move_uploaded_file($tmp_name, $filepath)) {\r\n\t\t\t\t\t\t\t$uploaded_files[] = $filename;\r\n\t\t\t\t\t\t\tlog_message('debug', 'File uploaded successfully: ' . $filename);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tlog_message('error', 'Failed to upload file: ' . $original_name);\r\n\t\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası yüklenemedi');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$error_code = isset($files['error'][$i]) ? $files['error'][$i] : 'Unknown';\r\n\t\t\t\t\t\tlog_message('error', 'File upload error for file ' . $i . ': ' . $error_code);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// Tek dosya yükleme\r\n\t\t\t\tif ($files['error'] == UPLOAD_ERR_OK) {\r\n\t\t\t\t\t$tmp_name = $files['tmp_name'];\r\n\t\t\t\t\t$original_name = $files['name'];\r\n\t\t\t\t\t$size = $files['size'];\r\n\t\t\t\t\t$type = $files['type'];\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Dosya boyutu kontrolü (max 10MB)\r\n\t\t\t\t\tif ($size > 10 * 1024 * 1024) {\r\n\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Dosya tipi kontrolü\r\n\t\t\t\t\t$ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));\r\n\t\t\t\t\t$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n\t\t\t\t\tif (!in_array($ext, $allowed_extensions)) {\r\n\t\t\t\t\t\tthrow new Exception($original_name . ' dosya tipi desteklenmiyor');\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Dosya adını oluştur\r\n\t\t\t\t\t$filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n\t\t\t\t\t$filepath = $upload_path . $filename;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Dosyayı yükle\r\n\t\t\t\t\tif (move_uploaded_file($tmp_name, $filepath)) {\r\n\t\t\t\t\t\t$uploaded_files[] = $filename;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası yüklenemedi');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (empty($uploaded_files)) {\r\n\t\t\t\tthrow new Exception('Hiçbir dosya yüklenemedi');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Debug: Uploaded files\r\n\t\t\tlog_message('debug', 'Uploaded files: ' . print_r($uploaded_files, true));\r\n\t\t\t\r\n\t\t\t// Mevcut görsel listesini al\r\n\t\t\t$current_record = $this->db->select('satisStok_gorsel')->where('satisStok_id', $satisStok_id)->get('satisstok')->row();\r\n\t\t\t$current_images = [];\r\n\t\t\t\r\n\t\t\tif ($current_record && $current_record->satisStok_gorsel) {\r\n\t\t\t\t$current_images = explode(',', $current_record->satisStok_gorsel);\r\n\t\t\t\t$current_images = array_filter($current_images); // Boş elemanları temizle\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Yeni dosyaları ekle\r\n\t\t\t$all_images = array_merge($current_images, $uploaded_files);\r\n\t\t\t$image_string = implode(',', $all_images);\r\n\t\t\t\r\n\t\t\t// Debug: Database update\r\n\t\t\tlog_message('debug', 'Updating database for satisStok_id: ' . $satisStok_id . ' with images: ' . $image_string);\r\n\t\t\t\r\n\t\t\t// Veritabanını güncelle\r\n\t\t\t$this->db->where('satisStok_id', $satisStok_id);\r\n\t\t\t$update_result = $this->db->update('satisstok', ['satisStok_gorsel' => $image_string]);\r\n\t\t\t\r\n\t\t\tif (!$update_result) {\r\n\t\t\t\tlog_message('error', 'Database update failed: ' . $this->db->error());\r\n\t\t\t\tthrow new Exception('Veritabanı güncellenemedi');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlog_message('debug', 'Database updated successfully');\r\n\t\t\t\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => true, \r\n\t\t\t\t'message' => count($uploaded_files) . ' dosya başarıyla yüklendi',\r\n\t\t\t\t'uploaded_files' => $uploaded_files\r\n\t\t\t]);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\tlog_message('error', 'stokGorselYukle error: ' . $e->getMessage());\r\n\t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Stok görsel silme fonksiyonu\r\n\t */\r\n\tpublic function stokGorselSil()\r\n\t{\r\n\t\t$gorsel_id = $this->input->post('gorsel_id');\r\n\t\t$satisStok_id = $this->input->post('satisStok_id');\r\n\t\t\r\n\t\tif (!$gorsel_id || !$satisStok_id) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Gerekli parametreler eksik']);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// Dosya adını görsel ID'den çıkar\r\n\t\t\t$filename_parts = explode('_', $gorsel_id);\r\n\t\t\t$filename = end($filename_parts);\r\n\t\t\t\r\n\t\t\t// Mevcut görsel listesini al\r\n\t\t\t$current_record = $this->db->select('satisStok_gorsel')->where('satisStok_id', $satisStok_id)->get('satisstok')->row();\r\n\t\t\t\r\n\t\t\tif (!$current_record || !$current_record->satisStok_gorsel) {\r\n\t\t\t\tthrow new Exception('Görsel bulunamadı');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$current_images = explode(',', $current_record->satisStok_gorsel);\r\n\t\t\t$current_images = array_filter($current_images);\r\n\t\t\t\r\n\t\t\t// Silinecek dosyayı listeden çıkar\r\n\t\t\t$updated_images = array_filter($current_images, function($img) use ($filename) {\r\n\t\t\t\treturn $img !== $filename;\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t// Veritabanını güncelle\r\n\t\t\t$image_string = implode(',', $updated_images);\r\n\t\t\t$this->db->where('satisStok_id', $satisStok_id);\r\n\t\t\t$this->db->update('satisstok', ['satisStok_gorsel' => $image_string]);\r\n\t\t\t\r\n\t\t\t// Dosyayı fiziksel olarak sil\r\n\t\t\t$file_path = FCPATH . 'assets/uploads/stok_gorselleri/' . $filename;\r\n\t\t\tif (file_exists($file_path)) {\r\n\t\t\t\tunlink($file_path);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Görsel başarıyla silindi']);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Tahsilat silme fonksiyonu\r\n\t */\r\n\tpublic function tahsilatSil()\r\n\t{\r\n\t\ttry {\r\n\t\t\t// POST verilerini al\r\n\t\t\t$unique_id = $this->input->post('unique_id');\r\n\t\t\t$tip_kod = $this->input->post('tip_kod');\r\n\t\t\t$source_id = $this->input->post('source_id');\r\n\t\t\t$ch_id = $this->input->post('ch_id'); // Eski sistem için\r\n\t\t\t\r\n\t\t\t// Debug log\r\n\t\t\terror_log(\"Tahsilat Silme İsteği: unique_id=$unique_id, tip_kod=$tip_kod, source_id=$source_id, ch_id=$ch_id\");\r\n\t\t\t\r\n\t\t\t// Parametre kontrolü\r\n\t\t\tif (empty($ch_id) && (empty($unique_id) || empty($tip_kod) || empty($source_id))) {\r\n\t\t\t\tthrow new Exception('Gerekli parametreler eksik');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$this->db->trans_start();\r\n\t\t\t\r\n\t\t\t// Eski sistem ile uyumluluk (ch_id varsa)\r\n\t\t\tif (!empty($ch_id)) {\r\n\t\t\t\t// Cari hareket ID'si ile silme\r\n\t\t\t\t$cari_hareket = $this->db->where('ch_id', $ch_id)->get('cariHareketleri')->row();\r\n\t\t\t\tif (!$cari_hareket) {\r\n\t\t\t\t\tthrow new Exception('Cari hareket kaydı bulunamadı');\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Cari hareket kaydını sil\r\n\t\t\t\t$this->db->where('ch_id', $ch_id)->delete('cariHareketleri');\r\n\t\t\t\t\r\n\t\t\t\tif ($this->db->affected_rows() == 0) {\r\n\t\t\t\t\tthrow new Exception('Cari hareket kaydı silinemedi');\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\terror_log(\"Cari hareket silindi: ch_id=$ch_id\");\r\n\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\t// Yeni sistem ile silme (unique_id, tip_kod, source_id)\r\n\t\t\t\t$deleted = false;\r\n\t\t\t\t\r\n\t\t\t\tswitch ($tip_kod) {\r\n\t\t\t\t\tcase '1': // Banka Hareketleri\r\n\t\t\t\t\t\t$record = $this->db->where('bh_id', $source_id)->get('bankaHareketleri')->row();\r\n\t\t\t\t\t\tif ($record) {\r\n\t\t\t\t\t\t\t// Görsel dosyasını sil\r\n\t\t\t\t\t\t\tif (!empty($record->bh_gorsel)) {\r\n\t\t\t\t\t\t\t\t$file_path = FCPATH . 'assets/uploads/dekontlar/' . $record->bh_gorsel;\r\n\t\t\t\t\t\t\t\tif (file_exists($file_path)) {\r\n\t\t\t\t\t\t\t\t\tunlink($file_path);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Banka hareket kaydını sil\r\n\t\t\t\t\t\t\t$this->db->where('bh_id', $source_id)->delete('bankaHareketleri');\r\n\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase '2': // Çekler\r\n\t\t\t\t\t\t$record = $this->db->where('cek_id', $source_id)->get('cek')->row();\r\n\t\t\t\t\t\tif ($record) {\r\n\t\t\t\t\t\t\t// Görsel dosyasını sil\r\n\t\t\t\t\t\t\tif (!empty($record->cek_gorsel)) {\r\n\t\t\t\t\t\t\t\t$file_path = FCPATH . 'assets/uploads/cekler/' . $record->cek_gorsel;\r\n\t\t\t\t\t\t\t\tif (file_exists($file_path)) {\r\n\t\t\t\t\t\t\t\t\tunlink($file_path);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Çek kaydını sil\r\n\t\t\t\t\t\t\t$this->db->where('cek_id', $source_id)->delete('cek');\r\n\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase '3': // Kasa Hareketleri\r\n\t\t\t\t\t\t$record = $this->db->where('kh_id', $source_id)->get('kasaHareketleri')->row();\r\n\t\t\t\t\t\tif ($record) {\r\n\t\t\t\t\t\t\t// Kasa hareket kaydını sil\r\n\t\t\t\t\t\t\t$this->db->where('kh_id', $source_id)->delete('kasaHareketleri');\r\n\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcase '4': // Senetler\r\n\t\t\t\t\t\t$record = $this->db->where('senet_id', $source_id)->get('senet')->row();\r\n\t\t\t\t\t\tif ($record) {\r\n\t\t\t\t\t\t\t// Görsel dosyasını sil\r\n\t\t\t\t\t\t\tif (!empty($record->senet_gorsel)) {\r\n\t\t\t\t\t\t\t\t$file_path = FCPATH . 'assets/uploads/senetler/' . $record->senet_gorsel;\r\n\t\t\t\t\t\t\t\tif (file_exists($file_path)) {\r\n\t\t\t\t\t\t\t\t\tunlink($file_path);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Senet kaydını sil\r\n\t\t\t\t\t\t\t$this->db->where('senet_id', $source_id)->delete('senet');\r\n\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthrow new Exception('Bilinmeyen tahsilat tipi: ' . $tip_kod);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (!$deleted) {\r\n\t\t\t\t\tthrow new Exception('Tahsilat kaydı silinemedi veya bulunamadı');\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\terror_log(\"Tahsilat silindi: tip_kod=$tip_kod, source_id=$source_id\");\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$this->db->trans_complete();\r\n\t\t\t\r\n\t\t\tif ($this->db->trans_status() === FALSE) {\r\n\t\t\t\tthrow new Exception('Veritabanı işlemi başarısız');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => true,\r\n\t\t\t\t'message' => 'Tahsilat kaydı başarıyla silindi'\r\n\t\t\t]);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$this->db->trans_rollback();\r\n\t\t\terror_log(\"Tahsilat Silme Hatası: \" . $e->getMessage());\r\n\t\t\t\r\n\t\t\techo json_encode([\r\n\t\t\t\t'success' => false,\r\n\t\t\t\t'message' => 'Tahsilat silinirken beklenmeyen bir hata oluştu: ' . $e->getMessage()\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n}"
        }
    ]
}