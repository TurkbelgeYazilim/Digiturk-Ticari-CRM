{
    "sourceFile": "application/controllers/Fatura.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1755443239969,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755497723452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-﻿<?php\r\n+<?php\r\n \r\n defined('BASEPATH') or exit('No direct script access allowed');\r\n \r\n \r\n"
                },
                {
                    "date": 1755502542389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-﻿<?php\r\n+<?php\r\n \r\n defined('BASEPATH') or exit('No direct script access allowed');\r\n \r\n \r\n"
                }
            ],
            "date": 1755443239969,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') or exit('No direct script access allowed');\r\n\r\n\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Helper\\Sample;\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\IOFactory;\r\n\r\n\r\n\r\nclass Fatura extends CI_Controller\r\n\r\n{\r\n\r\n\r\n\r\n\tpublic function __construct()\r\n\r\n\t{\r\n\r\n\t\tparent::__construct();\r\n\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n\t\t$this->load->model('vt');\r\n\r\n\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n\r\n\r\n\t\tif(gibYetki()==1)\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\r\n\r\n\t\tif (!$control) {\r\n\r\n\t\t\tredirect(\"check\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//sessionKontrolHelper();\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satisFaturasi($id = 0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / SatÄ±ÅŸ SÃ¶zleÅŸmesi OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n//dÃ¼zenleme iÃ§in veritabanÄ±ndan verilerin Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Fatura / SatÄ±ÅŸ Fatura DÃ¼zenle\";\r\n\r\n\t\t\t$sql = \"select * from satisFaturasi where satis_id=\" . $id;\r\n\r\n\t\t\t$faturaDetay = $this->db->query($sql)->row();\r\n\r\n\t\t\t$data[\"faturaDetay\"]=$faturaDetay ;\r\n\r\n\r\n\r\n\t\t\t$sqlEtiket=\"select * from etiketler where etiket_id=\".$faturaDetay->satis_faturaEtiketID;\r\n\r\n\t\t\t$exeEtiket=$this->db->query($sqlEtiket)->row();\r\n\r\n\t\t\t$data[\"etiket\"]=$exeEtiket;\r\n\r\n\r\n\r\n\t\t\t$sqlStok = \"select * from satisFaturasiStok inner join stok on satisStok_stokID=stok_id inner join stokBirimleri on stokBirim_id=stok_birimID where satisStok_satisFaturasiID=\" . $id;\r\n\r\n\t\t\t$data[\"stok\"] = $this->db->query($sqlStok)->result();\r\n\r\n\t\t\t$sqlGenelIskonto = \"select * from genel_iskonto inner join satisFaturasi on iskonto_satis_id=satis_id where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"genelIskonto\"] = $this->db->query($sqlGenelIskonto)->result();\r\n\r\n\t\t\t$sqlIade = \"select * from iade_fatura_numaralari inner join satisFaturasi on iade_fatura_numaralari.satis_id=satisFaturasi.satis_id where satisFaturasi.satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $this->db->query($sqlIade)->result();\r\n\r\n\t\t\t$sqlCari = \"select * from satisFaturasi inner join cari on satis_cariID=cari_id where satis_cariID=\" . $data[\"faturaDetay\"]->satis_cariID;\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\t\t\t$sqlInternet = \"select * from earsiv_internet_bilgileri where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"earsivInternet\"] = $this->db->query($sqlInternet)->row();\r\n\r\n\t\t\t$sqlBanka = \"select * from faturabanka_bilgileri inner join ayarlar_banka on faturabanka_ayarbankaID=ayarlarbanka_id where faturabanka_faturaID=\" . $id . \" \";\r\n\r\n\r\n\r\n\t\t\t$data[\"faturabankaDuzenle\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/satis-faturasi', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function satisFaturasiCari($id = 0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / SatÄ±ÅŸ SÃ¶zleÅŸmesi OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n//cari kaydÄ±nÄ± getir\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\r\n\r\n\t\t\t$sqlCari = \"select * from cari where  cari_id=$id\";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/satis-faturasi', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eFaturaOlustur($id = 0)\r\n\r\n\t{\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-Fatura OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t//dÃ¼zenleme iÃ§in verilerin veritabanÄ±ndan Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Fatura / E-Fatura DÃ¼zenle\";\r\n\r\n\t\t\t$sql = \"select * from satisFaturasi where satis_id=\" . $id;\r\n\r\n\t\t\t$faturaDetay = $this->db->query($sql)->row();\r\n\r\n\t\t\t$data[\"faturaDetay\"]=$faturaDetay ;\r\n\r\n\r\n\r\n\t\t\t$sqlEtiket=\"select * from etiketler where etiket_id=\".$faturaDetay->satis_faturaEtiketID;\r\n\r\n\t\t\t$exeEtiket=$this->db->query($sqlEtiket)->row();\r\n\r\n\t\t\t$data[\"etiket\"]=$exeEtiket;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$sqlStok = \"select * from satisFaturasiStok inner join stok on satisStok_stokID=stok_id inner join stokBirimleri on stokBirim_id=stok_birimID where satisStok_satisFaturasiID=\".$id;\r\n\r\n\t\t\t$data[\"stok\"] = $this->db->query($sqlStok)->result();\r\n\r\n\t\t\t$sqlGenelIskonto = \"select * from genel_iskonto inner join satisFaturasi on iskonto_satis_id=satis_id where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"genelIskonto\"] = $this->db->query($sqlGenelIskonto)->result();\r\n\r\n\t\t\t$sqlIade = \"select * from iade_fatura_numaralari inner join satisFaturasi on iade_fatura_numaralari.satis_id=satisFaturasi.satis_id where satisFaturasi.satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $this->db->query($sqlIade)->result();\r\n\r\n\t\t\t$sqlCari = \"select * from satisFaturasi inner join cari on satis_cariID=cari_id where satis_cariID=\" . $data[\"faturaDetay\"]->satis_cariID;\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\t\t\t$sqlBanka = \"select * from faturabanka_bilgileri inner join ayarlar_banka on faturabanka_ayarbankaID=ayarlarbanka_id where faturabanka_faturaID=\" . $id . \" \";\r\n\r\n\r\n\r\n\t\t\t$data[\"faturabankaDuzenle\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/efatura-olustur', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eFaturaOlusturCari($id = 0)\r\n\r\n\t{\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-Fatura OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t//dÃ¼zenleme iÃ§in verilerin veritabanÄ±ndan Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\r\n\r\n\t\t\t$sqlCari = \"select * from cari where  cari_id=$id\";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/efatura-olustur', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eArsivOlustur($id = 0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-ArÅŸiv OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t//dÃ¼zenleme iÃ§in veritabanÄ±ndan verilerin Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Fatura / E-ArÅŸiv DÃ¼zenle\";\r\n\r\n\t\t\t$sql = \"select * from satisFaturasi where satis_id=\" . $id;\r\n\r\n\t\t\t$faturaDetay = $this->db->query($sql)->row();\r\n\r\n\t\t\t$data[\"faturaDetay\"]=$faturaDetay ;\r\n\r\n\r\n\r\n\t\t\t$sqlEtiket=\"select * from etiketler where etiket_id=\".$faturaDetay->satis_faturaEtiketID;\r\n\r\n\t\t\t$exeEtiket=$this->db->query($sqlEtiket)->row();\r\n\r\n\t\t\t$data[\"etiket\"]=$exeEtiket;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$sqlStok = \"select * from satisFaturasiStok inner join stok on satisStok_stokID=stok_id inner join stokBirimleri on stokBirim_id=stok_birimID where satisStok_satisFaturasiID=\" . $id;\r\n\r\n\t\t\t$data[\"stok\"] = $this->db->query($sqlStok)->result();\r\n\r\n\t\t\t$sqlGenelIskonto = \"select * from genel_iskonto inner join satisFaturasi on iskonto_satis_id=satis_id where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"genelIskonto\"] = $this->db->query($sqlGenelIskonto)->result();\r\n\r\n\t\t\t$sqlIade = \"select * from iade_fatura_numaralari inner join satisFaturasi on iade_fatura_numaralari.satis_id=satisFaturasi.satis_id where satisFaturasi.satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $this->db->query($sqlIade)->result();\r\n\r\n\t\t\t$sqlCari = \"select * from satisFaturasi inner join cari on satis_cariID=cari_id where satis_cariID=\" . $data[\"faturaDetay\"]->satis_cariID;\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t\t$sqlInternet = \"select * from earsiv_internet_bilgileri where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"earsivInternet\"] = $this->db->query($sqlInternet)->row();\r\n\r\n\r\n\r\n\t\t\t$sqlBanka = \"select * from faturabanka_bilgileri inner join ayarlar_banka on faturabanka_ayarbankaID=ayarlarbanka_id where faturabanka_faturaID=\" . $id . \" \";\r\n\r\n\t\t\t$data[\"faturabankaDuzenle\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/earsiv-olustur', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eArsivOlusturCari($id = 0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-ArÅŸiv OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t//dÃ¼zenleme iÃ§in veritabanÄ±ndan verilerin Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$sqlCari = \"select * from cari where  cari_id=$id\";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/earsiv-olustur', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eirsaliyeolustur($id = 0){\r\n\r\n\t\t$data['baslik'] = 'E-Ä°rsaliye OluÅŸtur';\r\n\r\n\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Fatura / E-ArÅŸiv DÃ¼zenle\";\r\n\r\n\t\t\t$sql = \"select * from satisFaturasi where satis_id=\" . $id;\r\n\r\n\t\t\t$faturaDetay = $this->db->query($sql)->row();\r\n\r\n\t\t\t$data[\"faturaDetay\"]=$faturaDetay ;\r\n\r\n\r\n\r\n\t\t\t$irsaliyeDetay = $this->db->query(\"select * from irsaliye_bilgileri where irs_faturaID = '$id' \")->row();\r\n\r\n\t\t\t$data[\"irsaliyeDetay\"] = $irsaliyeDetay;\r\n\r\n\r\n\r\n \t\t\t$sqlStok = \"select * from satisFaturasiStok inner join stok on satisStok_stokID=stok_id inner join stokBirimleri on stokBirim_id=stok_birimID where satisStok_satisFaturasiID=\" . $id;\r\n\r\n\t\t\t$data[\"stok\"] = $this->db->query($sqlStok)->result();\r\n\r\n\t\t\t$sqlGenelIskonto = \"select * from genel_iskonto inner join satisFaturasi on iskonto_satis_id=satis_id where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"genelIskonto\"] = $this->db->query($sqlGenelIskonto)->result();\r\n\r\n\t\t\t$sqlIade = \"select * from iade_fatura_numaralari inner join satisFaturasi on iade_fatura_numaralari.satis_id=satisFaturasi.satis_id where satisFaturasi.satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $this->db->query($sqlIade)->result();\r\n\r\n\t\t\t$sqlCari = \"select * from satisFaturasi inner join cari on satis_cariID=cari_id where satis_cariID=\" . $data[\"faturaDetay\"]->satis_cariID;\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t\t$sqlInternet = \"select * from earsiv_internet_bilgileri where satis_id=\" . $id;\r\n\r\n\t\t\t$data[\"earsivInternet\"] = $this->db->query($sqlInternet)->row();\r\n\r\n\r\n\r\n\t\t\t$sqlBanka = \"select * from faturabanka_bilgileri inner join ayarlar_banka on faturabanka_ayarbankaID=ayarlarbanka_id where faturabanka_faturaID=\" . $id . \" \";\r\n\r\n\t\t\t$data[\"faturabankaDuzenle\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\r\n\r\n\t\t$this->load->view('fatura/eirsaliye-olustur', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function irsaliyeOlustur(){\r\n\r\n\t\techo \"123\";\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function irsaliyeGuncelle(){\r\n\r\n\t\techo \"123\";\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByNameEArsiv()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m carileri gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows($conditions, null); // Ana hesap null yapÄ±ldÄ±\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\t\t\t\t$cariGrubu = $row['cari_cariGrupKoduID'];\r\n\r\n\t\t\t\t$cariGrubuQ = \"SELECT cariGrup_ad FROM cariGruplari WHERE cariGrup_id = '$cariGrubu'\";\r\n\r\n\t\t\t\t$cariGrubuE = $this->db->query($cariGrubuQ)->row();\r\n\r\n\t\t\t\tif ($row['cari_tckn'] != null)\r\n\r\n\t\t\t\t\t$tcknvkn = $row['cari_tckn'];\r\n\r\n\t\t\t\telse if ($row['cari_vergiNumarasi'] != null)\r\n\r\n\t\t\t\t\t$tcknvkn = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\telse $tcknvkn = \"\";\r\n\r\n\t\t\t\tif ($row[\"cari_soyad\"] != null)\r\n\r\n\t\t\t\t\t$cariSoyad = \" \" . $row[\"cari_soyad\"];\r\n\r\n\t\t\t\telse $cariSoyad = \"\";\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['cari_id'];\r\n\r\n\t\t\t\t$data['value'] = $tcknvkn . \" - \" . $row['cari_ad'] . $cariSoyad;\r\n\r\n\t\t\t\t$data['cari_kodu'] = $row['cari_kodu'];\r\n\r\n\t\t\t\t$data['cari_grubu'] = $cariGrubuE->cariGrup_ad;\r\n\r\n\t\t\t\t$data['cari_vergiDairesi'] = $row['cari_vergiDairesi'];\r\n\r\n\t\t\t\t$data['cari_vergiNumarasi'] = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\t$data['cari_tckn'] = $row['cari_tckn'];\r\n\r\n\t\t\t\t$data['cari_adres'] = $row['cari_adres'] ? $row['cari_adres'] : ''; // BoÅŸ ise boÅŸ string dÃ¶ndÃ¼r\r\n\r\n\t\t\t\t$data['cari_firmaEPosta'] = $row['cari_firmaEPosta'];\r\n\r\n\t\t\t\t$data['cari_aliasPK'] = $row['cari_alias_pk'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByTcknVknEarsiv()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m carileri gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows($conditions, null); // Ana hesap null yapÄ±ldÄ±\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\t\t\t\t$cariGrubu = $row['cari_cariGrupKoduID'];\r\n\r\n\t\t\t\t$cariGrubuQ = \"SELECT cariGrup_ad FROM cariGruplari WHERE cariGrup_id = '$cariGrubu'\";\r\n\r\n\t\t\t\t$cariGrubuE = $this->db->query($cariGrubuQ)->row();\r\n\r\n\r\n\r\n\t\t\t\tif ($row['cari_tckn'] != null)\r\n\r\n\t\t\t\t\t$tcknvkn = $row['cari_tckn'];\r\n\r\n\t\t\t\telse if ($row['cari_vergiNumarasi'] != null)\r\n\r\n\t\t\t\t\t$tcknvkn = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\telse $tcknvkn = \"\";\r\n\r\n\t\t\t\tif ($row[\"cari_soyad\"] != null)\r\n\r\n\t\t\t\t\t$cariSoyad = \" \" . $row[\"cari_soyad\"];\r\n\r\n\t\t\t\telse $cariSoyad = \"\";\r\n\r\n\t\t\t\t$data['id'] = $row['cari_id'];\r\n\r\n\t\t\t\t$data['value'] = $tcknvkn . \" - \" . $row['cari_ad'] . $cariSoyad;\r\n\r\n\t\t\t\t$data['cari_kodu'] = $row['cari_kodu'];\r\n\r\n\t\t\t\t$data['cari_grubu'] = $cariGrubuE->cariGrup_ad;\r\n\r\n\t\t\t\t$data['cari_vergiDairesi'] = $row['cari_vergiDairesi'];\r\n\r\n\t\t\t\t$data['cari_vergiNumarasi'] = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\t$data['cari_tckn'] = $row['cari_tckn'];\r\n\r\n\t\t\t\t$data['cari_adres'] = $row['cari_adres'];\r\n\r\n\t\t\t\t$data['cari_firmaEPosta'] = $row['cari_firmaEPosta'];\r\n\r\n\t\t\t\t$data['cari_aliasPK'] = $row['cari_alias_pk'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByCariGib()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m carileri gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRowsTCKNVKN($conditions, null); // Ana hesap null yapÄ±ldÄ±\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\r\n\r\n\t\t\t\tif ($row['cari_tckn'] != null)\r\n\r\n\t\t\t\t\t$tcknvkn = $row['cari_tckn'];\r\n\r\n\t\t\t\telse if ($row['cari_vergiNumarasi'] != null)\r\n\r\n\t\t\t\t\t$tcknvkn = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\telse $tcknvkn = \"\";\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['cari_id'];\r\n\r\n\t\t\t\t$data['value'] = $tcknvkn ;\r\n\r\n\t\t\t\t$data['cari_ad']= $row['cari_ad'] ;\r\n\r\n\t\t\t\t$data['cari_soyad']=$row[\"cari_soyad\"];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByName()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m carileri gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows($conditions, null); // Ana hesap null yapÄ±ldÄ±\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\t\t\t\t$cariGrubu = $row['cari_cariGrupKoduID'];\r\n\r\n\t\t\t\t$cariGrubuQ = \"SELECT cariGrup_ad FROM cariGruplari WHERE cariGrup_id = '$cariGrubu'\";\r\n\r\n\t\t\t\t$cariGrubuE = $this->db->query($cariGrubuQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['cari_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['cari_ad'];\r\n\r\n\t\t\t\t$data['cari_kodu'] = $row['cari_kodu'];\r\n\r\n\t\t\t\t$data['cari_grubu'] = $cariGrubuE->cariGrup_ad;\r\n\r\n\t\t\t\t$data['cari_vergiDairesi'] = $row['cari_vergiDairesi'];\r\n\r\n\t\t\t\t$data['cari_vergiNumarasi'] = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\t$data['cari_adres'] = $row['cari_adres'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByCode()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m carileri gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows2($conditions, null); // Ana hesap null yapÄ±ldÄ±\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\t\t\t\t$cariGrubu = $row['cari_cariGrupKoduID'];\r\n\r\n\t\t\t\t$cariGrubuQ = \"SELECT cariGrup_ad FROM cariGruplari WHERE cariGrup_id = '$cariGrubu'\";\r\n\r\n\t\t\t\t$cariGrubuE = $this->db->query($cariGrubuQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['cari_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['cari_kodu'];\r\n\r\n\t\t\t\t$data['cari_ad'] = $row['cari_ad'];\r\n\r\n\t\t\t\t$data['cari_grubu'] = $cariGrubuE->cariGrup_ad;\r\n\r\n\t\t\t\t$data['cari_vergiDairesi'] = $row['cari_vergiDairesi'];\r\n\r\n\t\t\t\t$data['cari_vergiNumarasi'] = $row['cari_vergiNumarasi'];\r\n\r\n\t\t\t\t$data['cari_adres'] = $row['cari_adres'];\r\n\r\n\t\t\t\t$data['cari_firmaEPosta'] = $row['cari_firmaEPosta'];\r\n\r\n\t\t\t\t$data['cari_aliasPK'] = $row['cari_alias_pk'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByStockCode()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows3($conditions, $anaHesap);\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['stok_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['stok_kodu'];\r\n\r\n\t\t\t\t$data['stok_barkod'] = $row['stok_barkod'];\r\n\r\n\t\t\t\t$data['stok_ad'] = $row['stok_ad'];\r\n\r\n\t\t\t\t$data['stok_birimi'] = $row['stok_birimID'];\r\n\r\n\t\t\t\t$data['stok_satisFiyati'] = $row['stok_satisFiyati'];\r\n\r\n\t\t\t\t$data['stok_satisKDV'] = $row['stok_satisKDV'];\r\n\r\n\t\t\t\t$data['stok_alisFiyati'] = $row['stok_alisFiyati'];\r\n\r\n\t\t\t\t$data['stok_alisKDV'] = $row['stok_alisKDV'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByStockName()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± tamamen kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m stoklarÄ± gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows4($conditions, null, true); // Ana hesap null, admin true\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['stok_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['stok_ad'];\r\n\r\n\t\t\t\t$data['stok_barkod'] = $row['stok_barkod'];\r\n\r\n\t\t\t\t$data['stok_kodu'] = $row['stok_kodu'];\r\n\r\n\t\t\t\t$data['stok_birimi'] = $row['stok_birimID'];\r\n\r\n\t\t\t\t$data['stok_satisFiyati'] = $row['stok_satisFiyati'];\r\n\r\n\t\t\t\t$data['stok_satisKDV'] = $row['stok_satisKDV'];\r\n\r\n\t\t\t\t$data['stok_alisFiyati'] = $row['stok_alisFiyati'];\r\n\r\n\t\t\t\t$data['stok_alisKDV'] = $row['stok_alisKDV'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByEtiket()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRowsEtiket($conditions, $anaHesap);\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['etiket_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['etiket_adi'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satisFaturasiOlustur()\r\n\r\n\t{\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$ch_turu=2;\r\n\r\n\t\t$satis_InvoiceType = postval(\"satis_InvoiceType\");\r\n\r\n\r\n\r\n\t\t$satis_etiketID=postval(\"etiket_id\");\r\n\r\n\r\n\r\n\t\tif(empty($satis_etiketID))\r\n\r\n\t\t{\r\n\r\n\t\t\t$satis_faturaEtiketID=postval(\"satis_faturaEtiketID\");\r\n\r\n\t\t\tif(!empty($satis_faturaEtiketID))\r\n\r\n\t\t\t{\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_adi\"]=$satis_faturaEtiketID;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t$this->db->insert(\"etiketler\",$dataEtiket);\r\n\r\n\t\t\t\t$satis_etiketID=$this->db->insert_id();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"satis_faturaEtiketID\"]=$satis_etiketID;\r\n\r\n\r\n\r\n\t\tif($satis_InvoiceType==1)\r\n\r\n\t\t\t$ch_turu=12;//e-fatura\r\n\r\n\t\telse if($satis_InvoiceType==2)\r\n\r\n\t\t\t$ch_turu=13;//e-arÅŸiv\r\n\r\n\t\telse if($satis_InvoiceType==3)\r\n\r\n\t\t\t$ch_turu=14;//e-irsaliye\r\n\r\n\r\n\r\n\t\t$satis_irsaliyeTarihi = postval(\"satis_irsaliyeTarihi\");\r\n\r\n\t\t$satis_faturaTarihi = postval(\"satis_faturaTarihi\");\r\n\r\n\r\n\r\n\t\t$yeni_satis_irsaliyeTarihi = date(\"Y-m-d\", strtotime($satis_irsaliyeTarihi));\r\n\r\n\t\t$yeni_satis_faturaTarihi = date(\"Y-m-d\", strtotime($satis_faturaTarihi));\r\n\r\n\r\n\r\n\t\t$irsaliyeNo = postval(\"satis_irsaliyeNo\");\r\n\r\n\t\t$faturaNo = postval(\"satis_faturaNo\");\r\n\r\n\r\n\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\r\n\t\t$cariAdi = postval(\"cari_adi\");\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = postval(\"geneltopHidden\");\r\n\r\n\t\t$indirimToplamHidden = postval(\"indirimtopHidden\");\r\n\r\n\t\t$tevkifatToplamHidden = postval(\"tevkifattopHidden\");\r\n\r\n\t\t$vergidahilHidden = postval(\"vergidahilHidden\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$istisna_sebebi = postval(\"istisna_sebebi\");\r\n\r\n\t\t$vergiMuafiyet_sebep = postval(\"vergiMuafiyet_sebep\");\r\n\r\n\r\n\r\n\t\tif (postval(\"satis_paraBirimi\") == 1) {\r\n\r\n\t\t\t$guncelKur = NULL;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$guncelKur = postval(\"satis_guncelKur\");\r\n\r\n\t\t\t$dovizCevrilmis = $genelToplamHidden * $guncelKur;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t$data[\"satis_InvoiceType\"] = $satis_InvoiceType;\r\n\r\n\r\n\r\n\t\tif ($satis_InvoiceType == 2) {//arÅŸiv\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 1;\r\n\r\n\t\t\t$data[\"satis_earsivfaturaTip\"] = postval(\"satis_earsivfaturaTip\");\r\n\r\n\t\t\t$data[\"satis_earsivTipi\"] = postval(\"satis_earsivTipi\");\r\n\r\n\t\t\t$data[\"satis_earsivGonderimSekli\"] = postval(\"satis_earsivGonderimSekli\");\r\n\r\n\t\t} else if ($satis_InvoiceType == 1)//e-fatura\r\n\r\n\t\t{\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 1;\r\n\r\n\t\t\t$data[\"satis_faturaSenaryo\"] = postval(\"satis_faturaSenaryo\");\r\n\r\n\t\t\t$data[\"satis_earsivfaturaTip\"] = postval(\"satis_efaturaTip\");\r\n\r\n\r\n\r\n\t\t}else if ($satis_InvoiceType == 3)//e-fatura\r\n\r\n\t\t{\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 1;\r\n\r\n\r\n\r\n\t\t} else //SatÄ±ÅŸ SÃ¶zleÅŸmesi\r\n\r\n\t\t{\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 2;\r\n\r\n\t\t\t$data[\"satis_earsivfaturaTip\"] = postval(\"satis_faturaTip\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$paraBirimi=postval(\"satis_paraBirimi\");\r\n\r\n\r\n\r\n\t\t$data[\"satis_cariID\"] = postval(\"satis_cariID\");\r\n\r\n\t\t$data[\"satis_paraBirimi\"] = $paraBirimi;\r\n\r\n\t\t$data[\"satis_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"satis_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"satis_irsaliyeNo\"] = $irsaliyeNo != '' ? $irsaliyeNo : NULL;\r\n\r\n\t\t$data[\"satis_irsaliyeTarihi\"] = $satis_irsaliyeTarihi != '' ? $yeni_satis_irsaliyeTarihi : NULL;\r\n\r\n\t\t$data[\"satis_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"satis_faturaTarihi\"] = $yeni_satis_faturaTarihi;\r\n\r\n\t\t$data[\"satis_faturaSaati\"] = postval(\"satis_faturaSaati\");\r\n\r\n\t\t$data[\"satis_aciklama\"] = postval(\"satis_aciklama\");\r\n\r\n\t\t$data[\"satis_araToplam\"] = postval(\"aratopHidden\");\r\n\r\n\t\t$data[\"satis_kdvToplam\"] = postval(\"kdvtopHidden\");\r\n\r\n\t\t$data[\"satis_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"satis_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"satis_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"satis_netTutar\"] = postval(\"netTutarInput\");\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"satis_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"satis_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"satis_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"satis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"satis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"satis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"satis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$cariKontrolQ = \"SELECT * FROM cari WHERE (cari_kodu = '$cariKodu') AND cari_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t$cariKontrol = $this->db->query($cariKontrolQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$cariKontrol) {\r\n\r\n\t\t\t$this->session->set_flashdata('cari_hatali', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$faturaVarmiQ = \"SELECT * FROM satisFaturasi WHERE  (satis_irsaliyeNo = '$irsaliyeNo' OR satis_faturaNo = '$faturaNo') AND satis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$faturaVarmiExe = $this->db->query($faturaVarmiQ)->result();\r\n\r\n\r\n\r\n\t\tif ($faturaVarmiExe) {\r\n\r\n\t\t\t$this->session->set_flashdata('fatura_mukerrer', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"satisFaturasi\", $data);\r\n\r\n\t\t$satis_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\tif ($satis_InvoiceType == 3){ //eirsaliye ise gerekli kayÄ±t iÅŸlemleri yapmak\r\n\r\n\t\t\t$datairs[\"irs_faturaID\"] = $satis_id;\r\n\r\n\t\t\t$datairs[\"irs_eirsaliyeTip\"] = postval(\"satis_eirsaliyeTip\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeTarihi\"] = postval(\"satis_irsaliyeTarihi\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSaati\"] = postval(\"satis_irsaliyeSaati\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSevkTarihi\"] = postval(\"satis_irsaliyeSevkTarihi\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSevkSaati\"] = postval(\"satis_irsaliyeSevkSaati\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSiparisNo\"] = postval(\"satis_irsaliyeSiparisNo\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSoforAd\"] = postval(\"satis_irsaliyeSoforAd\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeDorsePlaka\"] = postval(\"satis_irsaliyeDorsePlaka\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSiparisTarihi\"] = postval(\"satis_irsaliyeSiparisTarihi\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeSoforTCKN\"] = postval(\"satis_irsaliyeSoforTCKN\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeTasiyiciUnvan\"] = postval(\"satis_irsaliyeTasiyiciUnvan\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyeTasiyiciVKNTCKN\"] = postval(\"satis_irsaliyeTasiyiciVKNTCKN\");\r\n\r\n\t\t\t$datairs[\"irs_irsaliyePlaka\"] = postval(\"satis_irsaliyePlaka\");\r\n\r\n\t\t\t$datairs[\"sb_ulke\"] = postval(\"sb_ulke\");\r\n\r\n\t\t\t$datairs[\"sb_sehir\"] = postval(\"sb_sehir\");\r\n\r\n\t\t\t$datairs[\"sb_ilce\"] = postval(\"sb_ilce\");\r\n\r\n\t\t\t$datairs[\"sb_pk\"] = postval(\"sb_pk\");\r\n\r\n\t\t\t$datairs[\"sb_adres\"] = postval(\"sb_adres\");\r\n\r\n\t\t\t$datairs[\"asb_vkntckn\"] = postval(\"asb_vkntckn\");\r\n\r\n\t\t\t$datairs[\"asb_unvan\"] = postval(\"asb_unvan\");\r\n\r\n\t\t\t$datairs[\"asb_mno\"] = postval(\"asb_mno\");\r\n\r\n\t\t\t$datairs[\"asb_tel\"] = postval(\"asb_tel\");\r\n\r\n\t\t\t$datairs[\"asb_eposta\"] = postval(\"asb_eposta\");\r\n\r\n\t\t\t$datairs[\"asb_ulke\"] = postval(\"asb_ulke\");\r\n\r\n\t\t\t$datairs[\"asb_il\"] = postval(\"asb_il\");\r\n\r\n\t\t\t$datairs[\"asb_ilce\"] = postval(\"asb_ilce\");\r\n\r\n\t\t\t$datairs[\"asb_adres\"] = postval(\"asb_adres\");\r\n\r\n\t\t\t$datairs[\"irs_olusturan\"] = $u_id;\r\n\r\n\t\t\t$datairs[\"irs_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$datairs[\"irs_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$datairs[\"irs_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"irsaliye_bilgileri\", $datairs);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$bankaCheck = postval(\"bankaCheck\");\r\n\r\n\t\tif ($bankaCheck == 1) {\r\n\r\n\t\t\t$bankaCount = postval(\"bankaCount\");\r\n\r\n\t\t\techo $bankaCount;\r\n\r\n\t\t\tif ($bankaCount != 0) {//banka bilgileri\r\n\r\n\t\t\t\t$ayarlarbanka_id = postval(\"ayarlarbanka_id\");\r\n\r\n\t\t\t\t$dataBanka[\"faturabanka_faturaID\"] = $satis_id;\r\n\r\n\t\t\t\tfor ($i = 0; $i < $bankaCount; $i++) {\r\n\r\n\t\t\t\t\t$dataBanka[\"faturabanka_ayarbankaID\"] = $ayarlarbanka_id[$i];\r\n\r\n\t\t\t\t\t$this->vt->insert(\"faturabanka_bilgileri\", $dataBanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$iade_count = postval(\"iade_count\");\r\n\r\n\t\tif ($iade_count != 0) {//arÅŸiv iade\r\n\r\n\r\n\r\n\t\t\t$iadenumara = postval(\"iadenumara\");\r\n\r\n\t\t\t$iadetarih = postval(\"iadetarih\");\r\n\r\n\t\t\t$dataIade[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t//iade_fatura_numaralari (e-arÅŸiv iade fatura numaralarÄ±)\r\n\r\n\t\t\tfor ($i = 0; $i < $iade_count; $i++) {\r\n\r\n\t\t\t\t$dataIade[\"fatura_numarasi\"] = $iadenumara[$i];\r\n\r\n\t\t\t\t$dataIade[\"tarih\"] = $iadetarih[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$indirim_count = postval(\"indirim_count\");\r\n\r\n\t\tif ($indirim_count != 0) {//genel iskonto\r\n\r\n\r\n\r\n\t\t\t$indirimsebep = postval(\"indirimsebep\");\r\n\r\n\t\t\t$indirimtutar = postval(\"indirimtutar\");\r\n\r\n\t\t\t$dataIndirim[\"iskonto_satis_id\"] = $satis_id;\r\n\r\n\t\t\t//genel_iskonto (faturaya yapÄ±lan genel indirimler)\r\n\r\n\t\t\tfor ($i = 0; $i < $indirim_count; $i++) {\r\n\r\n\t\t\t\tif ($indirimsebep[$i] == 0)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Ä°skonto\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 1)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Nakit Ä°skontosu\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 2)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"DiÄŸer\";\r\n\r\n\r\n\r\n\t\t\t\t$dataIndirim[\"iskonto_tutar\"] = $indirimtutar[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"genel_iskonto\", $dataIndirim);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$satis_earsivGonderimSekli = postval(\"satis_earsivGonderimSekli\");\r\n\r\n\t\t$satis_earsivTipi = postval(\"satis_earsivTipi\");\r\n\r\n\t\tif (($satis_earsivTipi == 1 && $satis_earsivGonderimSekli == 2) || postval(\"epostaCheck\") == \"1\") {\r\n\r\n\t\t\t$dataInternet[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t$dataInternet[\"earsiv_eposta\"] = postval(\"eposta_bilgi\");\r\n\r\n\t\t\t$this->vt->insert(\"earsiv_internet_bilgileri\", $dataInternet);\r\n\r\n\t\t} else if ($satis_earsivTipi == 2) {\r\n\r\n\t\t\t$dataInternet[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t$dataInternet[\"earsiv_eposta\"] = postval(\"eposta_bilgi\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_odemesekli\"] = postval(\"satis_odemesekli\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_odemearaci\"] = postval(\"satis_odemearaci\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_odemetarihi\"] = postval(\"satis_odemetarihi\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_internetsatisbilgisi\"] = postval(\"satis_internetsatisbilgisi\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyan\"] = postval(\"satis_tasiyan\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyanvkntckn\"] = postval(\"satis_tasiyanvkntckn\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyanunvan\"] = postval(\"satis_tasiyanunvan\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyantarih\"] = postval(\"satis_tasiyantarih\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_olusturma_tarih\"] = $tarihi;\r\n\r\n\t\t\t$dataInternet[\"earsiv_olusturma_saat\"] = $saati;\r\n\r\n\t\t\t$this->vt->insert(\"earsiv_internet_bilgileri\", $dataInternet);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\t\t$dataStok[\"satisStok_satisFaturasiID\"] = $satis_id;\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$stokadi=postval(\"stokadi\");\r\n\r\n\t\t$stokkodu=postval(\"stokkodu\");\r\n\r\n\t\t$barkod=postval(\"barkod\");\r\n\r\n\t\t$birim=postval(\"birim\");\r\n\r\n\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$toplam = postval(\"toplamHidden\");\r\n\r\n\r\n\r\n\t\t$indirimtutari = postval(\"indirimyuzde\");\r\n\r\n\t\t$tevkifatInput = postval(\"tevkifat\");\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\r\n\r\n\t\t\t$stokidsi=$stokid[$i];\r\n\r\n\t\t\tif($stokidsi == \"\"){\r\n\r\n\t\t\t\t$this->session->set_flashdata('fatura_stok_bos', 'OK');\r\n\r\n\t\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $toplam[$i] * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $toplam[$i] + $yeniKDVHesap;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$tevkifat = explode(\"|\", $tevkifatInput[$i]);\r\n\r\n\r\n\r\n\t\t\t$dataStok[\"satisStok_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$dataStok[\"satisStok_miktar\"] = $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_fiyatMiktar\"] = $birimfiyat[$i] * $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_indirimTutari\"] = $indirimtutari[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_satirIskonto\"] = $birimfiyat[$i] * $miktar[$i] * $indirimtutari[$i] / 100;\r\n\r\n\t\t\t$dataStok[\"satisStok_indirimlifiyat\"] = $toplam[$i];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif ($tevkifat[0] == 0)\r\n\r\n\t\t\t\t$dataStok[\"satisStok_tevkifat_id\"] = 0;\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$dataStok[\"satisStok_tevkifat_id\"] = $tevkifat[1];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"satisFaturasiStok\", $dataStok);\r\n\r\n\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t\t$data_sh[\"sh_turu\"] = 2;\r\n\r\n\t\t\t$data_sh[\"sh_cikis\"] = $miktar[$i];\r\n\r\n\t\t\t$data_sh[\"sh_cariID\"] = postval(\"satis_cariID\");\r\n\r\n\t\t\t$data_sh[\"sh_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$data_sh[\"sh_faturaID\"] = $satis_id;\r\n\r\n\t\t\t$data_sh[\"sh_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t\t$data_sh[\"sh_paraBirimi\"] = $paraBirimiTxt;\r\n\r\n\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$data_sh[\"sh_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$data_sh[\"sh_toplamKDV\"] = $yeniKDVHesap;\r\n\r\n\t\t\t$data_sh[\"sh_toplamFiyat\"] = $yeniKDVHesap2;\r\n\r\n\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\r\n\r\n\t\t//Cari Hareketleri Ekle :begin\r\n\r\n\t\t$data_ch[\"ch_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t$data_ch[\"ch_turu\"] = $ch_turu;\r\n\r\n\t\t$data_ch[\"ch_cariID\"] = postval(\"satis_cariID\");\r\n\r\n\t\t$data_ch[\"ch_faturaID\"] = $satis_id;\r\n\r\n\t\t$data_ch[\"ch_paraBirimi\"] = $paraBirimiTxt;\r\n\r\n\t\t/*if($dovizCevrilmis)\r\n\r\n\t\t\t$data_ch[\"ch_borc\"] =$dovizCevrilmis;\r\n\r\n\t\telse*/\r\n\r\n\t\t$data_ch[\"ch_borc\"] = postval(\"geneltopHidden\");\r\n\r\n\t\t$data_ch[\"ch_tarih\"] = $yeni_satis_faturaTarihi;\r\n\r\n\r\n\r\n\t\t$data_ch[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t$data_ch[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data_ch[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data_ch[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"cariHareketleri\", $data_ch);\r\n\r\n\t\t$ch_id = $this->db->insert_id();\r\n\r\n\t\t$datachu[\"satis_cariHareketiID\"] = $ch_id;\r\n\r\n\r\n\r\n\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $datachu);\r\n\r\n\t\t//Cari Hareketleri Ekle :end\r\n\r\n\r\n\r\n\t\t// Dosya yÃ¼kleme iÅŸlemi\r\n\r\n\t\tif (!empty($_FILES['fatura_dosya']['name'][0])) {\r\n\r\n\t\t\t$upload_path = './assets/uploads/faturalar/';\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Upload dizinini kontrol et ve yoksa oluÅŸtur\r\n\r\n\t\t\tif (!is_dir($upload_path)) {\r\n\r\n\t\t\t\tmkdir($upload_path, 0755, true);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t$uploaded_files = array();\r\n\r\n\t\t\t$upload_errors = array();\r\n\r\n\t\t\t\r\n\r\n\t\t\t$config['upload_path'] = $upload_path;\r\n\r\n\t\t\t$config['allowed_types'] = 'pdf|doc|docx|jpg|jpeg|png|gif|txt|xlsx|xls';\r\n\r\n\t\t\t$config['max_size'] = 10240; // 10MB\r\n\r\n\t\t\t$config['encrypt_name'] = TRUE;\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->load->library('upload', $config);\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Ã‡oklu dosya yÃ¼kleme\r\n\r\n\t\t\t$files_count = count($_FILES['fatura_dosya']['name']);\r\n\r\n\t\t\tfor ($i = 0; $i < $files_count; $i++) {\r\n\r\n\t\t\t\tif (!empty($_FILES['fatura_dosya']['name'][$i])) {\r\n\r\n\t\t\t\t\t$_FILES['single_file']['name'] = $_FILES['fatura_dosya']['name'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['type'] = $_FILES['fatura_dosya']['type'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['tmp_name'] = $_FILES['fatura_dosya']['tmp_name'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['error'] = $_FILES['fatura_dosya']['error'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['size'] = $_FILES['fatura_dosya']['size'][$i];\r\n\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\tif ($this->upload->do_upload('single_file')) {\r\n\r\n\t\t\t\t\t\t$upload_data = $this->upload->data();\r\n\r\n\t\t\t\t\t\t$uploaded_files[] = 'faturalar/' . $upload_data['file_name'];\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t$upload_errors[] = $this->upload->display_errors();\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif (!empty($uploaded_files)) {\r\n\r\n\t\t\t\t$data_update['satis_dosya'] = implode(',', $uploaded_files);\r\n\r\n\t\t\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $data_update);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Hata varsa flash mesaj olarak kaydet\r\n\r\n\t\t\tif (!empty($upload_errors)) {\r\n\r\n\t\t\t\t$this->session->set_flashdata('file_upload_error', implode('<br>', $upload_errors));\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_ok', 'OK');\r\n\r\n\t\tlogekle(11, 2);\r\n\r\n\t\t//redirect(\"fatura/satis-faturasi-duzenle/$satis_id\");\r\n\r\n\t\tif ($satis_InvoiceType == 2) {\r\n\r\n\t\t\tredirect(\"fatura/earsiv-faturalari\");\r\n\r\n\t\t} else if ($satis_InvoiceType == 1) {\r\n\r\n\t\t\tredirect(\"fatura/efaturaGiden\");\r\n\r\n\t\t} else if($satis_InvoiceType == 3){\r\n\r\n\t\t\tredirect(\"fatura/eirsaliyeGiden\");\r\n\r\n\t\t}else {\r\n\r\n\t\t\tredirect(\"fatura/satis-faturasi-listesi\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satisFaturasiDuzenle($id)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / SatÄ±ÅŸ SÃ¶zleÅŸmesi DÃ¼zenle\";\r\n\r\n\t\t\r\n\r\n\t\t// Dashboard'daki \"Son SatÄ±ÅŸlarÄ±m\" mantÄ±ÄŸÄ±: Kendisi + baÄŸlÄ± kullanÄ±cÄ±lar\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t$allowed_user_ids = array($u_id);\r\n\r\n\t\tif ($u_id > 0) {\r\n\r\n\t\t\t$baÄŸlÄ±_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\r\n\t\t\t$baÄŸlÄ±_kullanicilar = $this->db->query($baÄŸlÄ±_kullanicilarQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach ($baÄŸlÄ±_kullanicilar as $user) {\r\n\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\r\n\r\n\r\n\t\t$satisFaturasiQ = \"SELECT * FROM satisFaturasi WHERE satis_id = '$id' AND satis_olusturan IN ($allowed_user_ids_str)\";\r\n\r\n\t\t$satisFaturasiStokQ = \"SELECT * FROM satisFaturasiStok WHERE satisStok_satisFaturasiID = '$id'\";\r\n\r\n\r\n\r\n\t\t$data[\"satisFaturasi\"] = $this->db->query($satisFaturasiQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$data[\"satisFaturasi\"]) {\r\n\r\n\t\t\tredirect('hata');\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$cariID = $data[\"satisFaturasi\"]->satis_cariID;\r\n\r\n\r\n\r\n\t\t$cariBilgileriQ = \"SELECT * FROM cari WHERE cari_id = '$cariID' AND cari_olusturan IN ($allowed_user_ids_str)\";\r\n\r\n\r\n\r\n\t\t$data[\"cariBilgileri\"] = $this->db->query($cariBilgileriQ)->row();\r\n\r\n\r\n\r\n\t\tif ($data[\"cariBilgileri\"]) {\r\n\r\n\t\t\t$cariGrubuID = $data[\"cariBilgileri\"]->cari_cariGrupKoduID;\r\n\r\n\t\t\t$cariGrubuQ = \"SELECT * FROM cariGruplari WHERE cariGrup_id = '$cariGrubuID'\";\r\n\r\n\t\t\t$data[\"cariGrubuBilgileri\"] = $this->db->query($cariGrubuQ)->row();\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"satisFaturasiStok\"] = $this->db->query($satisFaturasiStokQ)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/satis-faturasi-duzenle\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satisFaturasiGuncelle()\r\n\r\n\t{\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$satis_InvoiceType = postval(\"satis_InvoiceType\");\r\n\r\n\r\n\r\n\t\t$satis_irsaliyeTarihi = postval(\"satis_irsaliyeTarihi\");\r\n\r\n\t\t$satis_faturaTarihi = postval(\"satis_faturaTarihi\");\r\n\r\n\r\n\r\n\t\t$yeni_satis_irsaliyeTarihi = date(\"Y-m-d\", strtotime($satis_irsaliyeTarihi));\r\n\r\n\t\t$yeni_satis_faturaTarihi = date(\"Y-m-d\", strtotime($satis_faturaTarihi));\r\n\r\n\r\n\r\n\t\t$satis_id = postval(\"satis_id\");\r\n\r\n\r\n\r\n\t\t$irsaliyeNo = postval(\"satis_irsaliyeNo\");\r\n\r\n\t\t$faturaNo = postval(\"satis_faturaNo\");\r\n\r\n\r\n\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\r\n\t\t$cariAdi = postval(\"cari_adi\");\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = postval(\"geneltopHidden\");\r\n\r\n\t\t$indirimToplamHidden = postval(\"indirimtopHidden\");\r\n\r\n\t\t$tevkifatToplamHidden = postval(\"tevkifattopHidden\");\r\n\r\n\t\t$vergidahilHidden = postval(\"vergidahilHidden\");\r\n\r\n\r\n\r\n\t\t$istisna_sebebi = postval(\"istisna_sebebi\");\r\n\r\n\t\t$vergiMuafiyet_sebep = postval(\"vergiMuafiyet_sebep\");\r\n\r\n\r\n\r\n\t\tif (postval(\"satis_paraBirimi\") == 1) {\r\n\r\n\t\t\t$guncelKur = NULL;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$guncelKur = postval(\"satis_guncelKur\");\r\n\r\n\t\t\t$dovizCevrilmis = $genelToplamHidden * $guncelKur;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$satis_etiketID=postval(\"etiket_id\");\r\n\r\n\t\tif (empty($satis_etiketID)) {\r\n\r\n\t\t\t$satis_faturaEtiketID = postval(\"satis_faturaEtiketID\");\r\n\r\n\t\t\tif (!empty($satis_faturaEtiketID)) {\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_adi\"] = $satis_faturaEtiketID;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t$this->db->insert(\"etiketler\", $dataEtiket);\r\n\r\n\t\t\t\t$satis_etiketID = $this->db->insert_id();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"satis_faturaEtiketID\"] = $satis_etiketID;\r\n\r\n\r\n\r\n\t\t$data[\"satis_InvoiceType\"] = $satis_InvoiceType;\r\n\r\n\r\n\r\n\t\tif ($satis_InvoiceType == 2) {//arÅŸiv\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 1;\r\n\r\n\t\t\t$data[\"satis_earsivfaturaTip\"] = postval(\"satis_earsivfaturaTip\");\r\n\r\n\t\t\t$data[\"satis_earsivTipi\"] = postval(\"satis_earsivTipi\");\r\n\r\n\t\t\t$data[\"satis_earsivGonderimSekli\"] = postval(\"satis_earsivGonderimSekli\");\r\n\r\n\t\t} else if ($satis_InvoiceType == 1)//e-fatura\r\n\r\n\t\t{\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 1;\r\n\r\n\t\t\t$data[\"satis_faturaSenaryo\"] = postval(\"satis_faturaSenaryo\");\r\n\r\n\t\t\t$data[\"satis_earsivfaturaTip\"] = postval(\"satis_efaturaTip\");\r\n\r\n\r\n\r\n\t\t} else //SatÄ±ÅŸ SÃ¶zleÅŸmesi\r\n\r\n\t\t{\r\n\r\n\t\t\t$data[\"satis_faturaDurum\"] = 2;\r\n\r\n\t\t\t$data[\"satis_earsivfaturaTip\"] = postval(\"satis_faturaTip\");\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$paraBirimi=postval(\"satis_paraBirimi\");\r\n\r\n\r\n\r\n\t\t$data[\"satis_cariID\"] = postval(\"satis_cariID\");\r\n\r\n\r\n\r\n\t\t$data[\"satis_paraBirimi\"] = $paraBirimi;\r\n\r\n\t\t$data[\"satis_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"satis_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"satis_irsaliyeNo\"] = $irsaliyeNo != '' ? $irsaliyeNo : NULL;\r\n\r\n\t\t$data[\"satis_irsaliyeTarihi\"] = $satis_irsaliyeTarihi != '' ? $yeni_satis_irsaliyeTarihi : NULL;\r\n\r\n\t\t$data[\"satis_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"satis_faturaTarihi\"] = $yeni_satis_faturaTarihi;\r\n\r\n\t\t$data[\"satis_faturaSaati\"] = postval(\"satis_faturaSaati\");\r\n\r\n\t\t$data[\"satis_aciklama\"] = postval(\"satis_aciklama\");\r\n\r\n\t\t$data[\"satis_araToplam\"] = postval(\"aratopHidden\");\r\n\r\n\t\t$data[\"satis_kdvToplam\"] = postval(\"kdvtopHidden\");\r\n\r\n\t\t$data[\"satis_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"satis_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"satis_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"satis_netTutar\"] = postval(\"netTutarInput\");\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"satis_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"satis_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"satis_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"satis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"satis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"satis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"satis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$cariKontrolQ = \"SELECT * FROM cari WHERE (cari_kodu = '$cariKodu') AND cari_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$cariKontrol = $this->db->query($cariKontrolQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$cariKontrol) {\r\n\r\n\t\t\t$this->session->set_flashdata('cari_hatali', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$faturaVarmiQ = \"SELECT * FROM satisFaturasi WHERE (satis_irsaliyeNo = '$irsaliyeNo' OR satis_faturaNo = '$faturaNo') AND satis_olusturanAnaHesap = '$anaHesap' AND satis_id = $satis_id\";\r\n\r\n\t\t$faturaVarmiExe = $this->db->query($faturaVarmiQ)->row();\r\n\r\n\r\n\r\n\r\n\r\n\t\t/*if ($faturaVarmiExe) {\r\n\r\n\t\t\t$this->session->set_flashdata('fatura_mukerrer', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n*/\r\n\r\n\t\t//if ($faturaVarmiExe)\r\n\r\n\t\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $data);\r\n\r\n\r\n\r\n\t\t//iade\r\n\r\n\t\t$iade_count = postval(\"iade_count\");\r\n\r\n\r\n\r\n\t\t$this->vt->del(\"iade_fatura_numaralari\", \"satis_id\", $satis_id);\r\n\r\n\t\tif ($iade_count != 0) {// iade\r\n\r\n\t\t\t$iadenumara = postval(\"iadenumara\");\r\n\r\n\t\t\t$iadetarih = postval(\"iadetarih\");\r\n\r\n\t\t\t$dataIade[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t//iade_fatura_numaralari (e-arÅŸiv iade fatura numaralarÄ±)\r\n\r\n\t\t\tfor ($i = 0; $i < $iade_count; $i++) {\r\n\r\n\t\t\t\t$dataIade[\"fatura_numarasi\"] = $iadenumara[$i];\r\n\r\n\t\t\t\t$dataIade[\"tarih\"] = $iadetarih[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t//indirim\r\n\r\n\t\t$indirim_count = postval(\"indirim_count\");\r\n\r\n\t\t$this->vt->del(\"genel_iskonto\", \"iskonto_satis_id\", $satis_id);\r\n\r\n\t\tif ($indirim_count != 0) {//genel iskonto\r\n\r\n\t\t\t$indirimsebep = postval(\"indirimsebep\");\r\n\r\n\t\t\t$indirimtutar = postval(\"indirimtutar\");\r\n\r\n\t\t\t$dataIndirim[\"iskonto_satis_id\"] = $satis_id;\r\n\r\n\t\t\t//genel_iskonto (faturaya yapÄ±lan genel indirimler)\r\n\r\n\t\t\tfor ($i = 0; $i < $indirim_count; $i++) {\r\n\r\n\t\t\t\tif ($indirimsebep[$i] == 0)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Ä°skonto\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 1)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Nakit Ä°skontosu\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 2)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"DiÄŸer\";\r\n\r\n\r\n\r\n\t\t\t\t$dataIndirim[\"iskonto_tutar\"] = $indirimtutar[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"genel_iskonto\", $dataIndirim);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$bankaCheck = postval(\"bankaCheck\");\r\n\r\n\t\t$this->vt->del(\"faturabanka_bilgileri\", \"faturabanka_faturaID\", $satis_id);\r\n\r\n\t\tif ($bankaCheck == 1) {\r\n\r\n\t\t\t$bankaCount = postval(\"bankaCount\");\r\n\r\n\t\t\techo $bankaCount;\r\n\r\n\t\t\tif ($bankaCount != 0) {//banka bilgileri\r\n\r\n\t\t\t\t$ayarlarbanka_id = postval(\"ayarlarbanka_id\");\r\n\r\n\t\t\t\t$dataBanka[\"faturabanka_faturaID\"] = $satis_id;\r\n\r\n\t\t\t\tfor ($i = 0; $i < $bankaCount; $i++) {\r\n\r\n\t\t\t\t\t$dataBanka[\"faturabanka_ayarbankaID\"] = $ayarlarbanka_id[$i];\r\n\r\n\t\t\t\t\tprint_r($dataBanka);\r\n\r\n\t\t\t\t\t$this->vt->insert(\"faturabanka_bilgileri\", $dataBanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t//earÅŸiv gÃ¶nderim ÅŸekli\r\n\r\n\t\t$satis_earsivGonderimSekli = postval(\"satis_earsivGonderimSekli\");\r\n\r\n\t\t$satis_earsivTipi = postval(\"satis_earsivTipi\");\r\n\r\n\t\t$earsiv_internet = postval(\"earsiv_internet\");\r\n\r\n\t\tprint_r($earsiv_internet);\r\n\r\n\r\n\r\n\t\tif ($earsiv_internet)\r\n\r\n\t\t\t$this->vt->del(\"earsiv_internet_bilgileri\", \"earsiv_id\", $earsiv_internet);\r\n\r\n\t\tif ($satis_earsivTipi == 1 && $satis_earsivGonderimSekli == 2) {\r\n\r\n\t\t\t$dataInternet[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t$dataInternet[\"earsiv_eposta\"] = postval(\"eposta_bilgi\");\r\n\r\n\t\t\t$this->vt->insert(\"earsiv_internet_bilgileri\", $dataInternet);\r\n\r\n\t\t} else if ($satis_earsivTipi == 2) {\r\n\r\n\t\t\t$dataInternet[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t$dataInternet[\"earsiv_eposta\"] = postval(\"eposta_bilgi\");\r\n\r\n\t\t\techo $dataInternet[\"earsiv_eposta\"];\r\n\r\n\t\t\t$dataInternet[\"earsiv_odemesekli\"] = postval(\"satis_odemesekli\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_odemearaci\"] = postval(\"satis_odemearaci\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_odemetarihi\"] = postval(\"satis_odemetarihi\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_internetsatisbilgisi\"] = postval(\"satis_internetsatisbilgisi\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyan\"] = postval(\"satis_tasiyan\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyanvkntckn\"] = postval(\"satis_tasiyanvkntckn\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyanunvan\"] = postval(\"satis_tasiyanunvan\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_tasiyantarih\"] = postval(\"satis_tasiyantarih\");\r\n\r\n\t\t\t$dataInternet[\"earsiv_olusturma_tarih\"] = $tarihi;\r\n\r\n\t\t\t$dataInternet[\"earsiv_olusturma_saat\"] = $saati;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"earsiv_internet_bilgileri\", $dataInternet);\r\n\r\n\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\t\t$dataStok[\"satisStok_satisFaturasiID\"] = $satis_id;\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\t\t$satisFaturasiStok_id = postval(\"satisFaturasiStok_id\");\r\n\r\n\r\n\r\n\t\t$stoklarQ = \"SELECT * FROM satisFaturasiStok WHERE satisStok_satisFaturasiID = '$satis_id'\";\r\n\r\n\t\t$stoklarExe = $this->db->query($stoklarQ)->result();\r\n\r\n\r\n\r\n\t\t$newArray = [];\r\n\r\n\t\tforeach ($stoklarExe as $sexe) {\r\n\r\n\t\t\t$newArray[] = $sexe->satisStok_id;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$diff = array_diff($newArray, $satisFaturasiStok_id);\r\n\r\n\r\n\r\n\t\tif (!empty($diff)) {\r\n\r\n\t\t\tforeach ($diff as $key => $value) {\r\n\r\n\t\t\t\t$this->vt->del(\"satisFaturasiStok\", \"satisStok_id\", $value);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$stokadi = postval(\"stokadi\");\r\n\r\n\t\t$stokkodu = postval(\"stokkodu\");\r\n\r\n\t\t$barkod= postval(\"barkod\");\r\n\r\n\t\t$birim= postval(\"birim\");\r\n\r\n\t\t$toplam = postval(\"toplamHidden\");\r\n\r\n\t\t$indirimtutari = postval(\"indirimyuzde\");\r\n\r\n\t\t$tevkifatInput = postval(\"tevkifat\");\r\n\r\n\r\n\r\n\t\t$this->vt->del(\"stokHareketleri\", \"sh_faturaID\", $satis_id);\r\n\r\n\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\t\t\t$stokidsi=$stokid[$i];\r\n\r\n\t\t\tif(empty($stokid[$i])) {\r\n\r\n\t\t\t\t$dataStokX[\"stok_kodu\"] = $stokkodu[$i];\r\n\r\n\t\t\t\t$stokQ = \"select * from stok where stok_kodu='\" . $dataStokX[\"stok_kodu\"] . \"'\";\r\n\r\n\t\t\t\t$stokExe = $this->db->query($stokQ)->row();\r\n\r\n\t\t\t\tif ($stokExe) {\r\n\r\n\t\t\t\t\t$stokidsi = $stokExe->stok_id;\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_ad\"] = $stokadi[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_barkod\"] = $barkod[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisFiyati\"] = $birimfiyat[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisFiyati\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisKDV\"] = $kdv[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisKDV\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_birimID\"] = $birim[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t$this->vt->insert(\"stok\", $dataStokX);\r\n\r\n\t\t\t\t\t$stokidsi = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $toplam[$i] * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $toplam[$i] + $yeniKDVHesap;\r\n\r\n\r\n\r\n\t\t\t$tevkifat = explode(\"|\", $tevkifatInput[$i]);\r\n\r\n\t\t\t$dataStok[\"satisStok_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$dataStok[\"satisStok_miktar\"] = $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_fiyatMiktar\"] = $birimfiyat[$i] * $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_indirimTutari\"] = $indirimtutari[$i];\r\n\r\n\t\t\t$dataStok[\"satisStok_satirIskonto\"] = $birimfiyat[$i] * $miktar[$i] * $indirimtutari[$i] / 100;\r\n\r\n\t\t\t$dataStok[\"satisStok_indirimlifiyat\"] = $toplam[$i];\r\n\r\n\r\n\r\n\t\t\tif ($tevkifat[0] == 0)\r\n\r\n\t\t\t\t$dataStok[\"satisStok_tevkifat_id\"] = 0;\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$dataStok[\"satisStok_tevkifat_id\"] = $tevkifat[1];\r\n\r\n\r\n\r\n\t\t\tif (!empty($satisFaturasiStok_id[$i])) {\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->update('satisFaturasiStok', array('satisStok_id' => $satisFaturasiStok_id[$i]), $dataStok);\r\n\r\n\t\t\t} else {\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"satisFaturasiStok\", $dataStok);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t\t//stok hareketleri gÃ¼ncelle\r\n\r\n\t\t\t$data_sh[\"sh_turu\"] = 2;\r\n\r\n\t\t\t$data_sh[\"sh_cikis\"] = $miktar[$i];\r\n\r\n\t\t\t$data_sh[\"sh_cariID\"] = postval(\"satis_cariID\");\r\n\r\n\t\t\t$data_sh[\"sh_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$data_sh[\"sh_faturaID\"] = $satis_id;\r\n\r\n\t\t\t$data_sh[\"sh_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t\t$data_sh[\"sh_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$data_sh[\"sh_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$data_sh[\"sh_toplamKDV\"] = $yeniKDVHesap;\r\n\r\n\t\t\t$data_sh[\"sh_toplamFiyat\"] = $yeniKDVHesap2;\r\n\r\n\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\t\t\t//stok hareketleri gÃ¼ncelle\r\n\r\n\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\r\n\r\n\t\t$kh_id = postval(\"kh_id\");\r\n\r\n\t\t$bh_id = postval(\"bh_id\");\r\n\r\n\r\n\r\n\t\t//Cari Hareketleri DÃ¼zenle :begin\r\n\r\n\t\t$ch_idsi = postval(\"ch_id\");\r\n\r\n\t\t$data_ch[\"ch_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t$data_ch[\"ch_cariID\"] = postval(\"satis_cariID\");\r\n\r\n\t\t$data_ch[\"ch_faturaID\"] = $satis_id;\r\n\r\n\t\t$data_ch[\"ch_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n\t\t/*if($dovizCevrilmis)\r\n\r\n\t\t\t$data_ch[\"ch_borc\"] =$dovizCevrilmis;\r\n\r\n\t\telse*/\r\n\r\n\t\t\t$data_ch[\"ch_borc\"] = postval(\"geneltopHidden\");\r\n\r\n\t\t$data_ch[\"ch_tarih\"] = $yeni_satis_faturaTarihi;\r\n\r\n\r\n\r\n\t\t$data_ch[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t$data_ch[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data_ch[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data_ch[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->vt->update('cariHareketleri', array('ch_id' => $ch_idsi), $data_ch);\r\n\r\n\t\t//Cari Hareketleri DÃ¼zenle :end\r\n\r\n\r\n\r\n\t\t// Dosya yÃ¼kleme iÅŸlemi\r\n\r\n\t\tif (!empty($_FILES['fatura_dosya']['name'][0])) {\r\n\r\n\t\t\t// Debug log\r\n\r\n\t\t\t$debug_log = \"=== DOSYA YÃœKLEME DEBUG ===\\n\";\r\n\r\n\t\t\t$debug_log .= \"Timestamp: \" . date('Y-m-d H:i:s') . \"\\n\";\r\n\r\n\t\t\t$debug_log .= \"Satis ID: \" . $satis_id . \"\\n\";\r\n\r\n\t\t\t$debug_log .= \"FILES: \" . print_r($_FILES['fatura_dosya'], true) . \"\\n\";\r\n\r\n\t\t\tfile_put_contents('./debug_file_upload.log', $debug_log, FILE_APPEND);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$upload_path = './assets/uploads/faturalar/';\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Upload dizinini kontrol et ve yoksa oluÅŸtur\r\n\r\n\t\t\tif (!is_dir($upload_path)) {\r\n\r\n\t\t\t\tmkdir($upload_path, 0755, true);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t$uploaded_files = array();\r\n\r\n\t\t\t$upload_errors = array();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Mevcut dosyalarÄ± al\r\n\r\n\t\t\t$existing_files = array();\r\n\r\n\t\t\t$current_satis = $this->db->query(\"SELECT satis_dosya FROM satisFaturasi WHERE satis_id = '$satis_id'\")->row();\r\n\r\n\t\t\tif ($current_satis && !empty($current_satis->satis_dosya)) {\r\n\r\n\t\t\t\t$existing_files = explode(',', $current_satis->satis_dosya);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t$config['upload_path'] = $upload_path;\r\n\r\n\t\t\t$config['allowed_types'] = 'pdf|doc|docx|jpg|jpeg|png|gif|txt|xlsx|xls';\r\n\r\n\t\t\t$config['max_size'] = 10240; // 10MB\r\n\r\n\t\t\t$config['encrypt_name'] = TRUE;\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->load->library('upload', $config);\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Ã‡oklu dosya yÃ¼kleme\r\n\r\n\t\t\t$files_count = count($_FILES['fatura_dosya']['name']);\r\n\r\n\t\t\tfor ($i = 0; $i < $files_count; $i++) {\r\n\r\n\t\t\t\tif (!empty($_FILES['fatura_dosya']['name'][$i])) {\r\n\r\n\t\t\t\t\t$_FILES['single_file']['name'] = $_FILES['fatura_dosya']['name'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['type'] = $_FILES['fatura_dosya']['type'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['tmp_name'] = $_FILES['fatura_dosya']['tmp_name'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['error'] = $_FILES['fatura_dosya']['error'][$i];\r\n\r\n\t\t\t\t\t$_FILES['single_file']['size'] = $_FILES['fatura_dosya']['size'][$i];\r\n\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\tif ($this->upload->do_upload('single_file')) {\r\n\r\n\t\t\t\t\t\t$upload_data = $this->upload->data();\r\n\r\n\t\t\t\t\t\t$uploaded_files[] = 'faturalar/' . $upload_data['file_name'];\r\n\r\n\t\t\t\t\t\tfile_put_contents('./debug_file_upload.log', \"Dosya yÃ¼klendi: \" . $upload_data['file_name'] . \"\\n\", FILE_APPEND);\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t$upload_errors[] = $this->upload->display_errors();\r\n\r\n\t\t\t\t\t\tfile_put_contents('./debug_file_upload.log', \"Upload hatasÄ±: \" . $this->upload->display_errors() . \"\\n\", FILE_APPEND);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Yeni dosyalarÄ± mevcut dosyalarla birleÅŸtir\r\n\r\n\t\t\t$all_files = array_merge($existing_files, $uploaded_files);\r\n\r\n\t\t\t$all_files = array_filter($all_files); // BoÅŸ deÄŸerleri temizle\r\n\r\n\t\t\t\r\n\r\n\t\t\tif (!empty($all_files)) {\r\n\r\n\t\t\t\t$data_update['satis_dosya'] = implode(',', $all_files);\r\n\r\n\t\t\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $data_update);\r\n\r\n\t\t\t\tfile_put_contents('./debug_file_upload.log', \"VeritabanÄ± gÃ¼ncellendi: \" . implode(',', $all_files) . \"\\n\", FILE_APPEND);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Hata varsa flash mesaj olarak kaydet\r\n\r\n\t\t\tif (!empty($upload_errors)) {\r\n\r\n\t\t\t\t$this->session->set_flashdata('file_upload_error', implode('<br>', $upload_errors));\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\tfile_put_contents('./debug_file_upload.log', \"HiÃ§ dosya seÃ§ilmemiÅŸ: \" . date('Y-m-d H:i:s') . \"\\n\", FILE_APPEND);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_updt_ok', 'OK');\r\n\r\n\t\tlogekle(11, 3);\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\tpublic function satisFaturasiListesi()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / SatÄ±ÅŸ SÃ¶zleÅŸmesi Listesi\";\r\n\r\n\r\n\r\n\t\t// Dashboard'daki \"Son SatÄ±ÅŸlarÄ±m\" mantÄ±ÄŸÄ±: Kendisi + baÄŸlÄ± kullanÄ±cÄ±lar\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t$allowed_user_ids = array($u_id);\r\n\r\n\t\tif ($u_id > 0) {\r\n\r\n\t\t\t$baÄŸlÄ±_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\r\n\t\t\t$baÄŸlÄ±_kullanicilar = $this->db->query($baÄŸlÄ±_kullanicilarQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach ($baÄŸlÄ±_kullanicilar as $user) {\r\n\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t//$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t//$cariAdi = $this->input->get('cariAdi');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\t\t$etiket = $this->input->get('etiket');\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n\t\t\r\n\r\n\t\t$ayArama = $this->input->get('ayArama');\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif ($sayfa) {\r\n\r\n\t\t\t$pagem = ($page - 1) * $limit;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$pagem = 0;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($etiket) && !empty($etiket)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama)) || (isset($ayArama) && !empty($ayArama))) {\r\n\r\n\r\n\r\n\t\t\t/*if(!empty($cariGrubu)){$sorgu1 = \"AND cari_cariGrupKoduID = '$cariGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}*/\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND satis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t/*if (!empty($irsaliyeNo)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND satis_irsaliyeNo LIKE '%$irsaliyeNo%'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}*/\r\n\r\n\t\t\tif (!empty($etiket)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND satis_faturaEtiketID = '$etiket'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($siralama)) {\r\n\r\n\t\t\t\tif ($siralama == 1) {//Tarih bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) DESC\";\r\n\r\n\t\t\t\t} else if ($siralama == 2) {//Tarih kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) ASC\";\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\t        if (!empty($ayArama)) {\r\n\r\n\t            $sorgu3 = \"AND month(satis_faturaTarihi) = '$ayArama'\";\r\n\r\n\t        }else $sorgu3=\"\";\r\n\r\n\t        \r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE satis_InvoiceType IS NULL AND satis_olusturan IN ($allowed_user_ids_str) AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \".$sorgu3.\" \";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_InvoiceType IS NULL AND satis_olusturan IN ($allowed_user_ids_str) AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 .\" \". $sorgu3 .\" \" . $sira . \" LIMIT $pagem,$limit\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE satis_InvoiceType IS NULL AND satis_olusturan IN ($allowed_user_ids_str)\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_InvoiceType IS NULL AND satis_olusturan IN ($allowed_user_ids_str) ORDER BY satis_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\t\t\r\n\r\n\t\t// DEBUG: Log sorgu bilgilerini\r\n\r\n\t\t$debug_file = FCPATH . 'debug_satis_fatura_listesi.log';\r\n\r\n\t\t$timestamp = date('Y-m-d H:i:s');\r\n\r\n\t\tfile_put_contents($debug_file, \"=== SATIÅ FATURA LÄ°STESÄ° DEBUG ===\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"Timestamp: $timestamp\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"User ID: $u_id\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"Allowed User IDs: \" . implode(', ', $allowed_user_ids) . \"\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"KÄ±sÄ±tlama: Dashboard mantÄ±ÄŸÄ± - Kendisi + baÄŸlÄ± kullanÄ±cÄ±lar (satis_olusturan IN ($allowed_user_ids_str))\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"Count Result: $count\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"Main Query: $sorgu\\n\", FILE_APPEND);\r\n\r\n\t\tfile_put_contents($debug_file, \"=== DEBUG END ===\\n\\n\", FILE_APPEND);\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/fatura/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t$data[\"satisFaturasi\"] = $this->db->query($sorgu)->result();\r\n\r\n\t// Her fatura iÃ§in stok bilgilerini al\r\n\t$faturaStoklar = array();\r\n\tforeach ($data[\"satisFaturasi\"] as $fatura) {\r\n\t\t$stokQ = \"SELECT s.stok_id, s.stok_ad, s.stok_kodu \r\n\t\t\t\t  FROM satisFaturasiStok sfs \r\n\t\t\t\t  INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id \r\n\t\t\t\t  WHERE sfs.satisStok_satisFaturasiID = '{$fatura->satis_id}'\r\n\t\t\t\t  LIMIT 1\"; // Ä°lk stoÄŸu al\r\n\t\t$stokBilgi = $this->db->query($stokQ)->row();\r\n\t\t$faturaStoklar[$fatura->satis_id] = $stokBilgi;\r\n\t}\r\n\t$data[\"faturaStoklar\"] = $faturaStoklar;\r\n\r\n\t$this->load->view(\"fatura/satis-faturasi-listesi\", $data);\t}\r\n\r\n\r\n\r\n\tpublic function eArsivFaturalari()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-ArÅŸiv Faturalari\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t//$cariAdi = $this->input->get('cariAdi');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif ($sayfa) {\r\n\r\n\t\t\t$pagem = ($page - 1) * $limit;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$pagem = 0;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($irsaliyeNo) && !empty($irsaliyeNo)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama))) {\r\n\r\n\r\n\r\n\t\t\t/*if(!empty($cariGrubu)){$sorgu1 = \"AND cari_cariGrupKoduID = '$cariGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}*/\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND satis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($irsaliyeNo)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND satis_irsaliyeNo LIKE '%$irsaliyeNo%'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($siralama)) {\r\n\r\n\t\t\t\tif ($siralama == 1) {//Tarih bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) DESC\";\r\n\r\n\t\t\t\t} else if ($siralama == 2) {//Tarih kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) ASC\";\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE satis_InvoiceType = 2 AND satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_InvoiceType = 2 AND satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \" . $sira . \" LIMIT $pagem,$limit\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE  satis_InvoiceType = 2 AND satis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE  satis_InvoiceType = 2 AND satis_olusturanAnaHesap = '$anaHesap' ORDER BY satis_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/fatura/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"satisFaturasi\"] = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/earsiv-faturalari\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function efaturaGiden()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-Fatura Giden Kutusu\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t//$cariAdi = $this->input->get('cariAdi');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif ($sayfa) {\r\n\r\n\t\t\t$pagem = ($page - 1) * $limit;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$pagem = 0;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($irsaliyeNo) && !empty($irsaliyeNo)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama))) {\r\n\r\n\r\n\r\n\t\t\t/*if(!empty($cariGrubu)){$sorgu1 = \"AND cari_cariGrupKoduID = '$cariGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}*/\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND satis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($irsaliyeNo)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND satis_irsaliyeNo LIKE '%$irsaliyeNo%'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($siralama)) {\r\n\r\n\t\t\t\tif ($siralama == 1) {//Tarih bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) DESC\";\r\n\r\n\t\t\t\t} else if ($siralama == 2) {//Tarih kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) ASC\";\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE satis_InvoiceType = 1 AND satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_InvoiceType = 2 AND satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \" . $sira . \" LIMIT $pagem,$limit\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE  satis_InvoiceType = 1 AND satis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE  satis_InvoiceType = 1 AND satis_olusturanAnaHesap = '$anaHesap' ORDER BY satis_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/fatura/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"satisFaturasi\"] = $this->db->query($sorgu)->result();\r\n\r\n\t\t//GidenKutusuSorgu(); //todo session-id hatasÄ±\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/efatura-giden\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function efaturaGelen()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-Fatura Gelen Kutusu\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t//$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$startDate = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$enDate = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/efatura-gelen\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eirsaliyeGiden()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-Ä°rsaliye Giden Kutusu\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t//$cariAdi = $this->input->get('cariAdi');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif ($sayfa) {\r\n\r\n\t\t\t$pagem = ($page - 1) * $limit;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$pagem = 0;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($irsaliyeNo) && !empty($irsaliyeNo)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama))) {\r\n\r\n\r\n\r\n\t\t\t/*if(!empty($cariGrubu)){$sorgu1 = \"AND cari_cariGrupKoduID = '$cariGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}*/\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND satis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($irsaliyeNo)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND satis_irsaliyeNo LIKE '%$irsaliyeNo%'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($siralama)) {\r\n\r\n\t\t\t\tif ($siralama == 1) {//Tarih bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) DESC\";\r\n\r\n\t\t\t\t} else if ($siralama == 2) {//Tarih kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(satis_faturaTarihi) ASC\";\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sira = \"ORDER BY satis_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE satis_InvoiceType = 3 AND satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_InvoiceType = 3 AND satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \" . $sira . \" LIMIT $pagem,$limit\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM satisFaturasi WHERE  satis_InvoiceType = 1 AND satis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE  satis_InvoiceType = 3 AND satis_olusturanAnaHesap = '$anaHesap' ORDER BY satis_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/fatura/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"satisFaturasi\"] = $this->db->query($sorgu)->result();\r\n\r\n\t\t//GidenKutusuSorgu(); //todo session-id hatasÄ±\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/eirsaliye-giden\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function eirsaliyeGelen()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / E-Ä°rsaliye Gelen Kutusu\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t//$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$startDate = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$enDate = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/eirsaliye-gelen\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasi($id = 0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / AlÄ±ÅŸ FaturasÄ± OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n//dÃ¼zenleme iÃ§in veritabanÄ±ndan verilerin Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Fatura / AlÄ±ÅŸ FaturasÄ± DÃ¼zenle\";\r\n\r\n\t\t\t$sql = \"select * from alisFaturasi where alis_id=\" . $id;\r\n\r\n\t\t\t$faturaDetay = $this->db->query($sql)->row();\r\n\r\n\t\t\t$data[\"faturaDetay\"]=$faturaDetay ;\r\n\r\n\r\n\r\n\t\t\t$sqlEtiket=\"select * from etiketler where etiket_id=\".$faturaDetay->alis_faturaEtiketID;\r\n\r\n\t\t\t$exeEtiket=$this->db->query($sqlEtiket)->row();\r\n\r\n\t\t\t$data[\"etiket\"]=$exeEtiket;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$sqlStok = \"select * from alisFaturasiStok inner join stok on alisStok_stokID=stok_id inner join stokBirimleri on stokBirim_id=stok_birimID where alisStok_alisFaturasiID=\" . $id;\r\n\r\n\t\t\t$data[\"stok\"] = $this->db->query($sqlStok)->result();\r\n\r\n\t\t\t$sqlGenelIskonto = \"select * from genel_iskonto inner join alisFaturasi on iskonto_satis_id=alis_id where alis_id=\" . $id;\r\n\r\n\t\t\t$data[\"genelIskonto\"] = $this->db->query($sqlGenelIskonto)->result();\r\n\r\n\t\t\t$sqlIade = \"select * from iade_fatura_numaralari inner join alisFaturasi on iade_fatura_numaralari.satis_id=alisFaturasi.alis_id where alisFaturasi.alis_id=\" . $id;\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $this->db->query($sqlIade)->result();\r\n\r\n\t\t\t$sqlCari = \"select * from alisFaturasi inner join cari on alis_cariID=cari_id where alis_cariID=\" . $data[\"faturaDetay\"]->alis_cariID;\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t\t$sqlBanka = \"select * from faturabanka_bilgileri inner join ayarlar_banka on faturabanka_ayarbankaID=ayarlarbanka_id where faturabanka_faturaID=\" . $id . \" \";\r\n\r\n\r\n\r\n\t\t\t$data[\"faturabankaDuzenle\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/alis-faturasi', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiCari($id = 0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / AlÄ±ÅŸ FaturasÄ± OluÅŸtur\";\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n//dÃ¼zenleme iÃ§in veritabanÄ±ndan verilerin Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$sqlCari = \"select * from cari where  cari_id=$id\";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view('fatura/alis-faturasi', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByStockCode2()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows3($conditions, $anaHesap);\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\t\t\t\t$stokBirimi = $row['stok_birimID'];\r\n\r\n\t\t\t\t$stokBirimiQ = \"SELECT stokBirim_ad FROM stokBirimleri WHERE stokBirim_id = '$stokBirimi'\";\r\n\r\n\t\t\t\t$stokBirimiE = $this->db->query($stokBirimiQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['stok_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['stok_kodu'];\r\n\r\n\t\t\t\t$data['stok_barkod'] = $row['stok_barkod'];\r\n\r\n\t\t\t\t$data['stok_ad'] = $row['stok_ad'];\r\n\r\n\t\t\t\t$data['stok_birimi'] = $stokBirimiE->stokBirim_ad;\r\n\r\n\t\t\t\t$data['stok_alisFiyati'] = $row['stok_alisFiyati'];\r\n\r\n\t\t\t\t$data['stok_alisKDV'] = $row['stok_alisKDV'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function autocompleteDataByStockName2()\r\n\r\n\t{\r\n\r\n\t\t// Ana hesap kÄ±sÄ±tlamasÄ± tamamen kaldÄ±rÄ±ldÄ± - tÃ¼m kullanÄ±cÄ±lar tÃ¼m stoklarÄ± gÃ¶rebilir\r\n\r\n\t\t$returnData = array();\r\n\r\n\t\t$conditions['searchTerm'] = $this->input->get('term');\r\n\r\n\t\t$getData = $this->vt->getRows4($conditions, null, true); // Ana hesap null, admin true\r\n\r\n\r\n\r\n\t\tif (!empty($getData)) {\r\n\r\n\t\t\tforeach ($getData as $row) {\r\n\r\n\t\t\t\t$stokBirimi = $row['stok_birimID'];\r\n\r\n\t\t\t\t$stokBirimiQ = \"SELECT stokBirim_ad FROM stokBirimleri WHERE stokBirim_id = '$stokBirimi'\";\r\n\r\n\t\t\t\t$stokBirimiE = $this->db->query($stokBirimiQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$data['id'] = $row['stok_id'];\r\n\r\n\t\t\t\t$data['value'] = $row['stok_ad'];\r\n\r\n\t\t\t\t$data['stok_barkod'] = $row['stok_barkod'];\r\n\r\n\t\t\t\t$data['stok_kodu'] = $row['stok_kodu'];\r\n\r\n\t\t\t\t$data['stok_birimi'] = $stokBirimiE->stokBirim_ad;\r\n\r\n\t\t\t\t$data['stok_alisFiyati'] = $row['stok_alisFiyati'];\r\n\r\n\t\t\t\t$data['stok_alisKDV'] = $row['stok_alisKDV'];\r\n\r\n\t\t\t\tarray_push($returnData, $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\techo json_encode($returnData);\r\n\r\n\t\tdie;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiOlustur()\r\n\r\n\t{\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$alis_irsaliyeTarihi = postval(\"alis_irsaliyeTarihi\");\r\n\r\n\t\t$alis_faturaTarihi = postval(\"alis_faturaTarihi\");\r\n\r\n\r\n\r\n\t\t$yeni_alis_irsaliyeTarihi = date(\"Y-m-d\", strtotime($alis_irsaliyeTarihi));\r\n\r\n\t\t$yeni_alis_faturaTarihi = date(\"Y-m-d\", strtotime($alis_faturaTarihi));\r\n\r\n\r\n\r\n\t\t$irsaliyeNo = postval(\"alis_irsaliyeNo\");\r\n\r\n\t\t$faturaNo = postval(\"alis_faturaNo\");\r\n\r\n\r\n\r\n\t\t$alis_etiketID=postval(\"etiket_id\");\r\n\r\n\r\n\r\n\t\tif(empty($alis_etiketID))\r\n\r\n\t\t{\r\n\r\n\t\t\t$alis_faturaEtiketID=postval(\"alis_faturaEtiketID\");\r\n\r\n\t\t\tif(!empty($alis_faturaEtiketID))\r\n\r\n\t\t\t{\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_adi\"]=$alis_faturaEtiketID;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t$this->db->insert(\"etiketler\",$dataEtiket);\r\n\r\n\t\t\t\t$alis_etiketID=$this->db->insert_id();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"alis_faturaEtiketID\"]=$alis_etiketID;\r\n\r\n\r\n\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\r\n\t\t$cariAdi = postval(\"cari_adi\");\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = postval(\"geneltopHidden\");\r\n\r\n\t\t$indirimToplamHidden = postval(\"indirimtopHidden\");\r\n\r\n\t\t$tevkifatToplamHidden = postval(\"tevkifattopHidden\");\r\n\r\n\t\t$vergidahilHidden = postval(\"vergidahilHidden\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$istisna_sebebi = postval(\"istisna_sebebi\");\r\n\r\n\t\t$vergiMuafiyet_sebep = postval(\"vergiMuafiyet_sebep\");\r\n\r\n\r\n\r\n\t\tif (postval(\"alis_paraBirimi\") == 1) {\r\n\r\n\t\t\t$guncelKur = NULL;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$guncelKur = postval(\"alis_guncelKur\");\r\n\r\n\t\t\t$dovizCevrilmis = $genelToplamHidden * $guncelKur;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$paraBirimi=postval(\"alis_paraBirimi\");\r\n\r\n\r\n\r\n\t\t$data[\"alis_faturaTipi\"] = postval(\"alis_faturaTip\");\r\n\r\n\t\t$data[\"alis_cariID\"] = postval(\"alis_cariID\");\r\n\r\n\t\t$data[\"alis_paraBirimi\"] = $paraBirimi;\r\n\r\n\t\t$data[\"alis_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"alis_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"alis_irsaliyeNo\"] = $irsaliyeNo != '' ? $irsaliyeNo : NULL;\r\n\r\n\t\t$data[\"alis_irsaliyeTarihi\"] = $yeni_alis_irsaliyeTarihi != '' ? $yeni_alis_irsaliyeTarihi : NULL;\r\n\r\n\t\t$data[\"alis_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"alis_faturaTarihi\"] = $yeni_alis_faturaTarihi;\r\n\r\n\t\t$data[\"alis_faturaSaati\"] = postval(\"alis_faturaSaati\");\r\n\r\n\t\t$data[\"alis_aciklama\"] = postval(\"alis_aciklama\");\r\n\r\n\t\t$data[\"alis_araToplam\"] = postval(\"aratopHidden\");\r\n\r\n\t\t$data[\"alis_kdvToplam\"] = postval(\"kdvtopHidden\");\r\n\r\n\t\t$data[\"alis_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"alis_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"alis_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"alis_netTutar\"] = postval(\"netTutarInput\");\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"alis_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"alis_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"alis_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"alis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"alis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"alis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"alis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$cariKontrolQ = \"SELECT * FROM cari WHERE (cari_kodu = '$cariKodu' ) AND cari_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t$cariKontrol = $this->db->query($cariKontrolQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$cariKontrol) {\r\n\r\n\t\t\t$this->session->set_flashdata('cari_hatali', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$faturaVarmiQ = \"SELECT * FROM alisFaturasi WHERE  (alis_irsaliyeNo = '$irsaliyeNo' OR alis_faturaNo = '$faturaNo') AND alis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$faturaVarmiExe = $this->db->query($faturaVarmiQ)->result();\r\n\r\n\r\n\r\n\r\n\r\n\t\tif ($faturaVarmiExe) {\r\n\r\n\t\t\t$this->session->set_flashdata('fatura_mukerrer', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"alisFaturasi\", $data);\r\n\r\n\t\t$alis_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t$iade_count = postval(\"iade_count\");\r\n\r\n\t\tif ($iade_count != 0) {// iade\r\n\r\n\r\n\r\n\t\t\t$iadenumara = postval(\"iadenumara\");\r\n\r\n\t\t\t$iadetarih = postval(\"iadetarih\");\r\n\r\n\t\t\t$dataIade[\"satis_id\"] = $alis_id;\r\n\r\n\t\t\t//iade_fatura_numaralari (e-arÅŸiv iade fatura numaralarÄ±)\r\n\r\n\t\t\tfor ($i = 0; $i < $iade_count; $i++) {\r\n\r\n\t\t\t\t$dataIade[\"fatura_numarasi\"] = $iadenumara[$i];\r\n\r\n\t\t\t\t$dataIade[\"tarih\"] = $iadetarih[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$indirim_count = postval(\"indirim_count\");\r\n\r\n\t\tif ($indirim_count != 0) {//genel iskonto\r\n\r\n\r\n\r\n\t\t\t$indirimsebep = postval(\"indirimsebep\");\r\n\r\n\t\t\t$indirimtutar = postval(\"indirimtutar\");\r\n\r\n\t\t\t$dataIndirim[\"iskonto_satis_id\"] = $alis_id;\r\n\r\n\t\t\t//genel_iskonto (faturaya yapÄ±lan genel indirimler)\r\n\r\n\t\t\tfor ($i = 0; $i < $indirim_count; $i++) {\r\n\r\n\t\t\t\tif ($indirimsebep[$i] == 0)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Ä°skonto\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 1)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Nakit Ä°skontosu\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 2)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"DiÄŸer\";\r\n\r\n\r\n\r\n\t\t\t\t$dataIndirim[\"iskonto_tutar\"] = $indirimtutar[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"genel_iskonto\", $dataIndirim);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$bankaCheck = postval(\"bankaCheck\");\r\n\r\n\t\t$this->vt->del(\"faturabanka_bilgileri\", \"faturabanka_faturaID\", $alis_id);\r\n\r\n\t\tif ($bankaCheck == 1) {\r\n\r\n\t\t\t$bankaCount = postval(\"bankaCount\");\r\n\r\n\t\t\techo $bankaCount;\r\n\r\n\t\t\tif ($bankaCount != 0) {//banka bilgileri\r\n\r\n\t\t\t\t$ayarlarbanka_id = postval(\"ayarlarbanka_id\");\r\n\r\n\t\t\t\t$dataBanka[\"faturabanka_faturaID\"] = $alis_id;\r\n\r\n\t\t\t\tfor ($i = 0; $i < $bankaCount; $i++) {\r\n\r\n\t\t\t\t\t$dataBanka[\"faturabanka_ayarbankaID\"] = $ayarlarbanka_id[$i];\r\n\r\n\t\t\t\t\tprint_r($dataBanka);\r\n\r\n\t\t\t\t\t$this->vt->insert(\"faturabanka_bilgileri\", $dataBanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//alÄ±ÅŸ faturasÄ± stok\r\n\r\n\t\t$dataStok[\"alisStok_alisFaturasiID\"] = $alis_id;\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$toplam = postval(\"toplamHidden\");\r\n\r\n\r\n\r\n\t\t$indirimtutari = postval(\"indirimyuzde\");\r\n\r\n\t\t$tevkifatInput = postval(\"tevkifat\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$stokadi=postval(\"stokadi\");\r\n\r\n\t\t$stokkodu=postval(\"stokkodu\");\r\n\r\n\t\t$barkod=postval(\"barkod\");\r\n\r\n\t\t$birim=postval(\"birim\");\r\n\r\n\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\t\t\t$stokidsi=$stokid[$i];\r\n\r\n\t\t\tif(empty($stokid[$i])) {\r\n\r\n\t\t\t\t$dataStokX[\"stok_kodu\"] = $stokkodu[$i];\r\n\r\n\t\t\t\t$stokQ=\"select * from stok where stok_kodu='\".$dataStokX[\"stok_kodu\"].\"'\";\r\n\r\n\t\t\t\t$stokExe=$this->db->query($stokQ)->row();\r\n\r\n\t\t\t\tif($stokExe)\r\n\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$stokidsi=$stokExe->stok_id;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_ad\"] = $stokadi[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_barkod\"] = $barkod[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisFiyati\"] = $birimfiyat[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisFiyati\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisKDV\"] = $kdv[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisKDV\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_birimID\"] = $birim[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t$this->vt->insert(\"stok\", $dataStokX);\r\n\r\n\t\t\t\t\t$stokidsi = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $toplam[$i] * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $toplam[$i] + $yeniKDVHesap;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$tevkifat = explode(\"|\", $tevkifatInput[$i]);\r\n\r\n\r\n\r\n\t\t\t$dataStok[\"alisStok_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$dataStok[\"alisStok_miktar\"] = $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_fiyatMiktar\"] = $birimfiyat[$i] * $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_indirimTutari\"] = $indirimtutari[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_satirIskonto\"] = $birimfiyat[$i] * $miktar[$i] * $indirimtutari[$i] / 100;\r\n\r\n\t\t\t$dataStok[\"alisStok_indirimlifiyat\"] = $toplam[$i];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif ($tevkifat[0] == 0)\r\n\r\n\t\t\t\t$dataStok[\"alisStok_tevkifat_id\"] = 0;\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$dataStok[\"alisStok_tevkifat_id\"] = $tevkifat[1];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"alisFaturasiStok\", $dataStok);\r\n\r\n\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t\t$data_sh[\"sh_turu\"] = 1;\r\n\r\n\t\t\t$data_sh[\"sh_giris\"] = $miktar[$i];\r\n\r\n\t\t\t$data_sh[\"sh_cariID\"] = postval(\"alis_cariID\");\r\n\r\n\t\t\t$data_sh[\"sh_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$data_sh[\"sh_faturaID\"] = $alis_id;\r\n\r\n\t\t\t$data_sh[\"sh_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t\t$data_sh[\"sh_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$data_sh[\"sh_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$data_sh[\"sh_toplamKDV\"] = $yeniKDVHesap;\r\n\r\n\t\t\t$data_sh[\"sh_toplamFiyat\"] = $yeniKDVHesap2;\r\n\r\n\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//alÄ±ÅŸ faturasÄ± stok\r\n\r\n\r\n\r\n\t\t//Cari Hareketleri Ekle :begin\r\n\r\n\t\t$data_ch[\"ch_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t$data_ch[\"ch_turu\"] = 1;\r\n\r\n\t\t$data_ch[\"ch_cariID\"] = postval(\"alis_cariID\");\r\n\r\n\t\t$data_ch[\"ch_faturaID\"] = $alis_id;\r\n\r\n\t\t$data_ch[\"ch_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n/*\r\n\r\n\t\tif($dovizCevrilmis)\r\n\r\n\t\t\t$data_ch[\"ch_alacak\"] =$dovizCevrilmis;\r\n\r\n\t\telse*/\r\n\r\n\t\t$data_ch[\"ch_alacak\"] = postval(\"geneltopHidden\");\r\n\r\n\t\t$data_ch[\"ch_tarih\"] = $yeni_alis_faturaTarihi;\r\n\r\n\r\n\r\n\t\t$data_ch[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t$data_ch[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data_ch[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data_ch[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"cariHareketleri\", $data_ch);\r\n\r\n\t\t$ch_id = $this->db->insert_id();\r\n\r\n\t\t$datachu[\"alis_cariHareketiID\"] = $ch_id;\r\n\r\n\r\n\r\n\t\t$this->vt->update('alisFaturasi', array('alis_id' => $alis_id), $datachu);\r\n\r\n\t\t//Cari Hareketleri Ekle :end\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_ok', 'OK');\r\n\r\n\t\tlogekle(11, 2);\r\n\r\n\t\t//redirect(\"fatura/satis-faturasi-duzenle/$satis_id\");\r\n\r\n\r\n\r\n\t\tredirect(\"fatura/alis-faturasi-listesi\");\r\n\r\n\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiGuncelle()\r\n\r\n\t{\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$alis_irsaliyeTarihi = postval(\"alis_irsaliyeTarihi\");\r\n\r\n\t\t$alis_faturaTarihi = postval(\"alis_faturaTarihi\");\r\n\r\n\r\n\r\n\t\t$yeni_alis_irsaliyeTarihi = date(\"Y-m-d\", strtotime($alis_irsaliyeTarihi));\r\n\r\n\t\t$yeni_alis_faturaTarihi = date(\"Y-m-d\", strtotime($alis_faturaTarihi));\r\n\r\n\r\n\r\n\t\t$alis_id = postval(\"alis_id\");\r\n\r\n\r\n\r\n\t\t$irsaliyeNo = postval(\"alis_irsaliyeNo\");\r\n\r\n\t\t$faturaNo = postval(\"alis_faturaNo\");\r\n\r\n\r\n\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\r\n\t\t$cariAdi = postval(\"cari_adi\");\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = postval(\"geneltopHidden\");\r\n\r\n\t\t$indirimToplamHidden = postval(\"indirimtopHidden\");\r\n\r\n\t\t$tevkifatToplamHidden = postval(\"tevkifattopHidden\");\r\n\r\n\t\t$vergidahilHidden = postval(\"vergidahilHidden\");\r\n\r\n\r\n\r\n\t\t$istisna_sebebi = postval(\"istisna_sebebi\");\r\n\r\n\t\t$vergiMuafiyet_sebep = postval(\"vergiMuafiyet_sebep\");\r\n\r\n\r\n\r\n\t\tif (postval(\"alis_paraBirimi\") == 1) {\r\n\r\n\t\t\t$guncelKur = NULL;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$guncelKur = postval(\"alis_guncelKur\");\r\n\r\n\t\t\t$dovizCevrilmis = $genelToplamHidden * $guncelKur;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$paraBirimi= postval(\"alis_paraBirimi\");\r\n\r\n\r\n\r\n\t\t$alis_etiketID=postval(\"etiket_id\");\r\n\r\n\t\tif (empty($alis_etiketID)) {\r\n\r\n\t\t\t$alis_faturaEtiketID = postval(\"alis_faturaEtiketID\");\r\n\r\n\t\t\tif (!empty($alis_faturaEtiketID)) {\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_adi\"] = $alis_faturaEtiketID;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t$this->db->insert(\"etiketler\", $dataEtiket);\r\n\r\n\t\t\t\t$alis_etiketID = $this->db->insert_id();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"alis_faturaEtiketID\"] = $alis_etiketID;\r\n\r\n\r\n\r\n\t\t$data[\"alis_faturaTipi\"] = postval(\"alis_faturaTip\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$data[\"alis_cariID\"] = postval(\"alis_cariID\");\r\n\r\n\t\t$data[\"alis_paraBirimi\"] =$paraBirimi;\r\n\r\n\t\t$data[\"alis_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"alis_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"alis_irsaliyeNo\"] = $irsaliyeNo != '' ? $irsaliyeNo : NULL;\r\n\r\n\t\t$data[\"alis_irsaliyeTarihi\"] = $alis_irsaliyeTarihi != '' ? $yeni_alis_irsaliyeTarihi : NULL;\r\n\r\n\t\t$data[\"alis_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"alis_faturaTarihi\"] = $yeni_alis_faturaTarihi;\r\n\r\n\t\t$data[\"alis_faturaSaati\"] = postval(\"alis_faturaSaati\");\r\n\r\n\t\t$data[\"alis_aciklama\"] = postval(\"alis_aciklama\");\r\n\r\n\t\t$data[\"alis_araToplam\"] = postval(\"aratopHidden\");\r\n\r\n\t\t$data[\"alis_kdvToplam\"] = postval(\"kdvtopHidden\");\r\n\r\n\t\t$data[\"alis_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"alis_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"alis_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"alis_netTutar\"] = postval(\"netTutarInput\");\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"alis_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"alis_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"alis_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"alis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"alis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"alis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"alis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$cariKontrolQ = \"SELECT * FROM cari WHERE (cari_kodu = '$cariKodu') AND cari_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$cariKontrol = $this->db->query($cariKontrolQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$cariKontrol) {\r\n\r\n\t\t\t$this->session->set_flashdata('cari_hatali', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$this->vt->update('alisFaturasi', array('alis_id' => $alis_id), $data);\r\n\r\n\r\n\r\n\t\t//iade\r\n\r\n\t\t$iade_count = postval(\"iade_count\");\r\n\r\n\r\n\r\n\t\t$this->vt->del(\"iade_fatura_numaralari\", \"satis_id\", $alis_id);\r\n\r\n\t\tif ($iade_count != 0) {// iade\r\n\r\n\t\t\t$iadenumara = postval(\"iadenumara\");\r\n\r\n\t\t\t$iadetarih = postval(\"iadetarih\");\r\n\r\n\t\t\t$dataIade[\"satis_id\"] = $alis_id;\r\n\r\n\t\t\t//iade_fatura_numaralari (e-arÅŸiv iade fatura numaralarÄ±)\r\n\r\n\t\t\tfor ($i = 0; $i < $iade_count; $i++) {\r\n\r\n\t\t\t\t$dataIade[\"fatura_numarasi\"] = $iadenumara[$i];\r\n\r\n\t\t\t\t$dataIade[\"tarih\"] = $iadetarih[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t//indirim\r\n\r\n\t\t$indirim_count = postval(\"indirim_count\");\r\n\r\n\t\t$this->vt->del(\"genel_iskonto\", \"iskonto_satis_id\", $alis_id);\r\n\r\n\t\tif ($indirim_count != 0) {//genel iskonto\r\n\r\n\t\t\t$indirimsebep = postval(\"indirimsebep\");\r\n\r\n\t\t\t$indirimtutar = postval(\"indirimtutar\");\r\n\r\n\t\t\t$dataIndirim[\"iskonto_satis_id\"] = $alis_id;\r\n\r\n\t\t\t//genel_iskonto (faturaya yapÄ±lan genel indirimler)\r\n\r\n\t\t\tfor ($i = 0; $i < $indirim_count; $i++) {\r\n\r\n\t\t\t\tif ($indirimsebep[$i] == 0)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Ä°skonto\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 1)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Nakit Ä°skontosu\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 2)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"DiÄŸer\";\r\n\r\n\r\n\r\n\t\t\t\t$dataIndirim[\"iskonto_tutar\"] = $indirimtutar[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"genel_iskonto\", $dataIndirim);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t$bankaCheck = postval(\"bankaCheck\");\r\n\r\n\t\t$this->vt->del(\"faturabanka_bilgileri\", \"faturabanka_faturaID\", $alis_id);\r\n\r\n\t\tif ($bankaCheck == 1) {\r\n\r\n\t\t\t$bankaCount = postval(\"bankaCount\");\r\n\r\n\t\t\techo $bankaCount;\r\n\r\n\t\t\tif ($bankaCount != 0) {//banka bilgileri\r\n\r\n\t\t\t\t$ayarlarbanka_id = postval(\"ayarlarbanka_id\");\r\n\r\n\t\t\t\t$dataBanka[\"faturabanka_faturaID\"] = $alis_id;\r\n\r\n\t\t\t\tfor ($i = 0; $i < $bankaCount; $i++) {\r\n\r\n\t\t\t\t\t$dataBanka[\"faturabanka_ayarbankaID\"] = $ayarlarbanka_id[$i];\r\n\r\n\t\t\t\t\tprint_r($dataBanka);\r\n\r\n\t\t\t\t\t$this->vt->insert(\"faturabanka_bilgileri\", $dataBanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//alis faturasÄ± stok\r\n\r\n\t\t$dataStok[\"alisStok_alisFaturasiID\"] = $alis_id;\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\t\t$alisFaturasiStok_id = postval(\"alisFaturasiStok_id\");\r\n\r\n\r\n\r\n\t\t$stoklarQ = \"SELECT * FROM alisFaturasiStok WHERE alisStok_alisFaturasiID = '$alis_id'\";\r\n\r\n\t\t$stoklarExe = $this->db->query($stoklarQ)->result();\r\n\r\n\r\n\r\n\t\t$newArray = [];\r\n\r\n\t\tforeach ($stoklarExe as $sexe) {\r\n\r\n\t\t\t$newArray[] = $sexe->alisStok_id;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$diff = array_diff($newArray, $alisFaturasiStok_id);\r\n\r\n\r\n\r\n\t\tif (!empty($diff)) {\r\n\r\n\t\t\tforeach ($diff as $key => $value) {\r\n\r\n\t\t\t\t$this->vt->del(\"alisFaturasiStok\", \"alisStok_id\", $value);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$toplam = postval(\"toplamHidden\");\r\n\r\n\t\t$indirimtutari = postval(\"indirimyuzde\");\r\n\r\n\t\t$tevkifatInput = postval(\"tevkifat\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$stokadi=postval(\"stokadi\");\r\n\r\n\t\t$stokkodu=postval(\"stokkodu\");\r\n\r\n\t\t$barkod=postval(\"barkod\");\r\n\r\n\t\t$birim=postval(\"birim\");\r\n\r\n\r\n\r\n\t\t$this->vt->del(\"stokHareketleri\", \"sh_faturaID\", $alis_id);\r\n\r\n\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\t\t\t$stokidsi=$stokid[$i];\r\n\r\n\t\t\tif(empty($stokid[$i])) {\r\n\r\n\t\t\t\t$dataStokX[\"stok_kodu\"] = $stokkodu[$i];\r\n\r\n\t\t\t\t$stokQ=\"select * from stok where stok_kodu='\".$dataStokX[\"stok_kodu\"].\"'\";\r\n\r\n\t\t\t\t$stokExe=$this->db->query($stokQ)->row();\r\n\r\n\t\t\t\tif($stokExe)\r\n\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$stokidsi=$stokExe->stok_id;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_ad\"] = $stokadi[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_barkod\"] = $barkod[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisFiyati\"] = $birimfiyat[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisFiyati\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisKDV\"] = $kdv[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisKDV\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_birimID\"] = $birim[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t$this->vt->insert(\"stok\", $dataStokX);\r\n\r\n\t\t\t\t\t$stokidsi = $this->db->insert_id();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $toplam[$i] * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $toplam[$i] + $yeniKDVHesap;\r\n\r\n\r\n\r\n\t\t\t$tevkifat = explode(\"|\", $tevkifatInput[$i]);\r\n\r\n\t\t\t$dataStok[\"alisStok_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$dataStok[\"alisStok_miktar\"] = $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_fiyatMiktar\"] = $birimfiyat[$i] * $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_indirimTutari\"] = $indirimtutari[$i];\r\n\r\n\t\t\t$dataStok[\"alisStok_satirIskonto\"] = $birimfiyat[$i] * $miktar[$i] * $indirimtutari[$i] / 100;\r\n\r\n\t\t\t$dataStok[\"alisStok_indirimlifiyat\"] = $toplam[$i];\r\n\r\n\r\n\r\n\t\t\tif ($tevkifat[0] == 0)\r\n\r\n\t\t\t\t$dataStok[\"alisStok_tevkifat_id\"] = 0;\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$dataStok[\"alisStok_tevkifat_id\"] = $tevkifat[1];\r\n\r\n\r\n\r\n\t\t\tif (!empty($alisFaturasiStok_id[$i])) {\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->update('alisFaturasiStok', array('alisStok_id' => $alisFaturasiStok_id[$i]), $dataStok);\r\n\r\n\t\t\t} else {\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"alisFaturasiStok\", $dataStok);\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t\t//stok hareketleri gÃ¼ncelle\r\n\r\n\t\t\t$data_sh[\"sh_turu\"] = 1;\r\n\r\n\t\t\t$data_sh[\"sh_giris\"] = $miktar[$i];\r\n\r\n\t\t\t$data_sh[\"sh_cariID\"] = postval(\"alis_cariID\");\r\n\r\n\t\t\t$data_sh[\"sh_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$data_sh[\"sh_faturaID\"] = $alis_id;\r\n\r\n\t\t\t$data_sh[\"sh_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t\t$data_sh[\"sh_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$data_sh[\"sh_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$data_sh[\"sh_toplamKDV\"] = $yeniKDVHesap;\r\n\r\n\t\t\t$data_sh[\"sh_toplamFiyat\"] = $yeniKDVHesap2;\r\n\r\n\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\t\t\t//stok hareketleri gÃ¼ncelle\r\n\r\n\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\r\n\r\n\r\n\r\n\t\t//Cari Hareketleri DÃ¼zenle :begin\r\n\r\n\t\t$ch_idsi = postval(\"ch_id\");\r\n\r\n\t\t$data_ch[\"ch_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t$data_ch[\"ch_cariID\"] = postval(\"alis_cariID\");\r\n\r\n\t\t$data_ch[\"ch_faturaID\"] = $alis_id;\r\n\r\n\t\t$data_ch[\"ch_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n/*\r\n\r\n\t\tif($dovizCevrilmis)\r\n\r\n\t\t\t$data_ch[\"ch_alacak\"] =$dovizCevrilmis;\r\n\r\n\t\telse*/\r\n\r\n\t\t$data_ch[\"ch_alacak\"] = postval(\"geneltopHidden\");\r\n\r\n\t\t$data_ch[\"ch_tarih\"] = $yeni_alis_faturaTarihi;\r\n\r\n\r\n\r\n\t\t$data_ch[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t$data_ch[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data_ch[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data_ch[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->vt->update('cariHareketleri', array('ch_id' => $ch_idsi), $data_ch);\r\n\r\n\t\t//Cari Hareketleri DÃ¼zenle :end\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_updt_ok', 'OK');\r\n\r\n\t\tlogekle(11, 3);\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiDuzenle($id)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / AlÄ±ÅŸ FaturasÄ± DÃ¼zenle\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$alisFaturasiQ = \"SELECT * FROM alisFaturasi WHERE alis_id = '$id' AND alis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$alisFaturasiStokQ = \"SELECT * FROM alisFaturasiStok WHERE alisStok_alisFaturasiID = '$id'\";\r\n\r\n\r\n\r\n\t\t$data[\"alisFaturasi\"] = $this->db->query($alisFaturasiQ)->row();\r\n\r\n\r\n\r\n\t\t$cariID = $data[\"alisFaturasi\"]->alis_cariID;\r\n\r\n\t\t$olusturanHesapKim = $data[\"alisFaturasi\"]->alis_olusturanAnaHesap;\r\n\r\n\r\n\r\n\t\t$cariBilgileriQ = \"SELECT * FROM cari WHERE cari_id = '$cariID' AND cari_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\r\n\r\n\t\t$data[\"cariBilgileri\"] = $this->db->query($cariBilgileriQ)->row();\r\n\r\n\r\n\r\n\t\t$cariGrubuID = $data[\"cariBilgileri\"]->cari_cariGrupKoduID;\r\n\r\n\r\n\r\n\t\t$cariGrubuQ = \"SELECT * FROM cariGruplari WHERE cariGrup_id = '$cariGrubuID' AND cariGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\r\n\r\n\t\t$data[\"cariGrubuBilgileri\"] = $this->db->query($cariGrubuQ)->row();\r\n\r\n\t\t$data[\"alisFaturasiStok\"] = $this->db->query($alisFaturasiStokQ)->result();\r\n\r\n\r\n\r\n\t\t$bankaQ = \"SELECT * FROM banka WHERE banka_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$data[\"banka\"] = $this->db->query($bankaQ)->result();\r\n\r\n\r\n\r\n\t\t$kasaQ = \"SELECT * FROM kasa WHERE kasa_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$data[\"kasa\"] = $this->db->query($kasaQ)->result();\r\n\r\n\r\n\r\n\t\tif ($anaHesap == $olusturanHesapKim) {\r\n\r\n\t\t\t$this->load->view(\"fatura/alis-faturasi-duzenle\", $data);\r\n\r\n\t\t} else {\r\n\r\n\t\t\tredirect('hata');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiListesi()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / AlÄ±ÅŸ FaturasÄ± Listesi\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$etiket = $this->input->get('etiket');\r\n\r\n\t\t//$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t//$cariAdi = $this->input->get('cariAdi');\r\n\r\n\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n        $ayArama= $this->input->get('ayArama');\r\n\r\n\t\t\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif ($sayfa) {\r\n\r\n\t\t\t$pagem = ($page - 1) * $limit;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$pagem = 0;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($etiket) && !empty($etiket)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama)) || (isset($ayArama) && !empty($ayArama))) {\r\n\r\n\r\n\r\n\t\t\t/*if(!empty($cariGrubu)){$sorgu1 = \"AND cari_cariGrupKoduID = '$cariGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}*/\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND alis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n/*\r\n\r\n\t\t\tif (!empty($irsaliyeNo)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND alis_irsaliyeNo LIKE '%$irsaliyeNo%'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}*/\r\n\r\n\t\t\tif (!empty($etiket)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND alis_faturaEtiketID = '$etiket'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($siralama)) {\r\n\r\n\t\t\t\tif ($siralama == 1) {//Tarih bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(alis_faturaTarihi) DESC\";\r\n\r\n\t\t\t\t} else if ($siralama == 2) {//Tarih kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(alis_faturaTarihi) ASC\";\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY alis_id DESC\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sira = \"ORDER BY alis_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t        if (!empty($ayArama)) {\r\n\r\n\t            $sorgu3 = \"AND month(alis_faturaTarihi) = '$ayArama'\";\r\n\r\n\t        }else $sorgu3=\"\";\r\n\r\n\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap' AND alis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 . \" \". $sorgu3. \" \";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap' AND alis_faturaNo LIKE '%$faturaNo%' \" . $sorgu2 . \" \" . $sorgu1 .\" \". $sorgu3 . \"  \" . $sira . \" LIMIT $pagem,$limit\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap' ORDER BY alis_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/fatura/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"alisFaturasi\"] = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/alis-faturasi-listesi\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satisFaturasiExcel()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($irsaliyeNo) && !empty($irsaliyeNo)) || (isset($tarihGet) && !empty($tarihGet))) {\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND satis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_olusturanAnaHesap = '$anaHesap' AND satis_faturaNo LIKE '%$faturaNo%' AND satis_irsaliyeNo LIKE '%$irsaliyeNo%' \" . $sorgu1 . \" ORDER BY satis_id DESC\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM satisFaturasi WHERE satis_olusturanAnaHesap = '$anaHesap' ORDER BY satis_id DESC\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$satisFaturasi = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$reader = \\PhpOffice\\PhpSpreadsheet\\IOFactory::createReader('Xlsx');\r\n\r\n\t\t$reader->setReadDataOnly(TRUE);\r\n\r\n\t\t$spreadsheet = new Spreadsheet();\r\n\r\n\r\n\r\n\t\t$sheet = $spreadsheet->getActiveSheet();\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('d.m.Y-His');\r\n\r\n\r\n\r\n\t\t$sheet->getStyle('A1:E1')->getFill()->setFillType(\\PhpOffice\\PhpSpreadsheet\\Style\\Fill::FILL_SOLID)->getStartColor()->setARGB('CCCCCC');\r\n\r\n\r\n\r\n\t\t$sheet->setCellValue('A1', 'Tarih');\r\n\r\n\t\t$sheet->setCellValue('B1', 'SÃ¶zleÅŸme No');\r\n\r\n\t\t$sheet->setCellValue('C1', 'Ä°rsaliye No');\r\n\r\n\t\t$sheet->setCellValue('D1', 'Cari AdÄ±');\r\n\r\n\t\t$sheet->setCellValue('E1', 'Genel Toplam');\r\n\r\n\r\n\r\n\t\t$rows = 2;\r\n\r\n\t\tforeach ($satisFaturasi as $sf) {\r\n\r\n\t\t\t$tarihYeni = date('d.m.Y', strtotime($sf->satis_faturaTarihi));\r\n\r\n\r\n\r\n\t\t\t$cariID = $sf->satis_cariID;\r\n\r\n\t\t\t$cariQ = \"SELECT cari_ad FROM cari WHERE cari_id = '$cariID'\";\r\n\r\n\t\t\t$carie = $this->db->query($cariQ)->row();\r\n\r\n\t\t\t$cariAd = $carie->cari_ad;\r\n\r\n\r\n\r\n\t\t\t$sheet->setCellValue('A' . $rows, $tarihYeni);\r\n\r\n\t\t\t$sheet->setCellValue('B' . $rows, $sf->satis_faturaNo);\r\n\r\n\t\t\t$sheet->setCellValue('C' . $rows, $sf->satis_irsaliyeNo);\r\n\r\n\t\t\t$sheet->setCellValue('D' . $rows, $cariAd);\r\n\r\n\t\t\t$sheet->setCellValue('E' . $rows, $sf->satis_genelToplam);\r\n\r\n\t\t\t$rows++;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$sheet->getColumnDimension('A')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('B')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('C')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('D')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('E')->setAutoSize(true);\r\n\r\n\r\n\r\n\t\t$writer = new Xlsx($spreadsheet);//instantiate Xlsx\r\n\r\n\r\n\r\n\t\t$filename = 'satis-faturalari-' . $tarih;//set filename for excel file to be exported\r\n\r\n\r\n\r\n\t\theader('Content-Type: application/vnd.ms-excel');// generate excel file\r\n\r\n\t\theader('Content-Disposition: attachment;filename=\"' . $filename . '.xlsx\"');\r\n\r\n\t\theader('Cache-Control: max-age=0');\r\n\r\n\r\n\r\n\t\t$writer->save('php://output');//download file\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiExcel()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$irsaliyeNo = $this->input->get('irsaliyeNo');\r\n\r\n\t\t//$cariAdi = $this->input->get('cariAdi');\r\n\r\n\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($irsaliyeNo) && !empty($irsaliyeNo)) || (isset($tarihGet) && !empty($tarihGet))) {\r\n\r\n\r\n\r\n\t\t\t/*if(!empty($cariGrubu)){$sorgu1 = \"AND cari_cariGrupKoduID = '$cariGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}*/\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND alis_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap' AND alis_faturaNo LIKE '%$faturaNo%' AND alis_irsaliyeNo LIKE '%$irsaliyeNo%' \" . $sorgu1 . \"  ORDER BY alis_id DESC\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM alisFaturasi WHERE alis_olusturanAnaHesap = '$anaHesap' ORDER BY alis_id DESC\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$alisFaturasi = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$reader = \\PhpOffice\\PhpSpreadsheet\\IOFactory::createReader('Xlsx');\r\n\r\n\t\t$reader->setReadDataOnly(TRUE);\r\n\r\n\t\t$spreadsheet = new Spreadsheet();\r\n\r\n\r\n\r\n\t\t$sheet = $spreadsheet->getActiveSheet();\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('d.m.Y-His');\r\n\r\n\r\n\r\n\t\t$sheet->getStyle('A1:E1')->getFill()->setFillType(\\PhpOffice\\PhpSpreadsheet\\Style\\Fill::FILL_SOLID)->getStartColor()->setARGB('CCCCCC');\r\n\r\n\r\n\r\n\t\t$sheet->setCellValue('A1', 'Tarih');\r\n\r\n\t\t$sheet->setCellValue('B1', 'SÃ¶zleÅŸme No');\r\n\r\n\t\t$sheet->setCellValue('C1', 'Ä°rsaliye No');\r\n\r\n\t\t$sheet->setCellValue('D1', 'Cari AdÄ±');\r\n\r\n\t\t$sheet->setCellValue('E1', 'Genel Toplam');\r\n\r\n\r\n\r\n\t\t$rows = 2;\r\n\r\n\t\tforeach ($alisFaturasi as $af) {\r\n\r\n\t\t\t$tarihYeni = date('d.m.Y', strtotime($af->alis_faturaTarihi));\r\n\r\n\r\n\r\n\t\t\t$cariID = $af->alis_cariID;\r\n\r\n\t\t\t$cariQ = \"SELECT cari_ad FROM cari WHERE cari_id = '$cariID'\";\r\n\r\n\t\t\t$carie = $this->db->query($cariQ)->row();\r\n\r\n\t\t\t$cariAd = $carie->cari_ad;\r\n\r\n\r\n\r\n\t\t\t$sheet->setCellValue('A' . $rows, $tarihYeni);\r\n\r\n\t\t\t$sheet->setCellValue('B' . $rows, $af->alis_faturaNo);\r\n\r\n\t\t\t$sheet->setCellValue('C' . $rows, $af->alis_irsaliyeNo);\r\n\r\n\t\t\t$sheet->setCellValue('D' . $rows, $cariAd);\r\n\r\n\t\t\t$sheet->setCellValue('E' . $rows, $af->alis_genelToplam);\r\n\r\n\t\t\t$rows++;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$sheet->getColumnDimension('A')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('B')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('C')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('D')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('E')->setAutoSize(true);\r\n\r\n\r\n\r\n\t\t$writer = new Xlsx($spreadsheet);//instantiate Xlsx\r\n\r\n\r\n\r\n\t\t$filename = 'alis-faturalari-' . $tarih;//set filename for excel file to be exported\r\n\r\n\r\n\r\n\t\theader('Content-Type: application/vnd.ms-excel');// generate excel file\r\n\r\n\t\theader('Content-Disposition: attachment;filename=\"' . $filename . '.xlsx\"');\r\n\r\n\t\theader('Cache-Control: max-age=0');\r\n\r\n\r\n\r\n\t\t$writer->save('php://output');//download file\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satisFaturasiStokKontrol()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data = $this->input->post();\r\n\r\n\r\n\r\n\t\t$stokID = $data[\"stokID\"];\r\n\r\n\t\t$stokMiktar = $data[\"stokMiktar\"];\r\n\r\n\r\n\r\n\t\tforeach ($stokID as $key => $value) {\r\n\r\n\t\t\t$toplamGirisQ = \"SELECT SUM(sh_giris) AS toplamGiris FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' AND sh_stokID = '$value'\";\r\n\r\n\t\t\t$toplamGirisExe = $this->db->query($toplamGirisQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamCikisQ = \"SELECT SUM(sh_cikis) AS toplamCikis FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' AND sh_stokID = '$value'\";\r\n\r\n\t\t\t$toplamCikisExe = $this->db->query($toplamCikisQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamGiris = $toplamGirisExe->toplamGiris;\r\n\r\n\t\t\t$toplamCikis = $toplamCikisExe->toplamCikis;\r\n\r\n\t\t\t$kalan = $toplamGiris - $toplamCikis;\r\n\r\n\r\n\r\n\t\t\t$sonuc = $kalan - $stokMiktar[$key];\r\n\r\n\r\n\r\n\t\t\tif ($sonuc < 0) {\r\n\r\n\t\t\t\techo \"1\";\r\n\r\n\t\t\t\tdie;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alisFaturasiStokKontrol()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data = $this->input->post();\r\n\r\n\r\n\r\n\t\t$stokID = $data[\"stokID\"];\r\n\r\n\t\t$stokMiktar = $data[\"stokMiktar\"];\r\n\r\n\r\n\r\n\t\tforeach ($stokID as $key => $value) {\r\n\r\n\t\t\t$toplamGirisQ = \"SELECT SUM(sh_giris) AS toplamGiris FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' AND sh_stokID = '$value'\";\r\n\r\n\t\t\t$toplamGirisExe = $this->db->query($toplamGirisQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamCikisQ = \"SELECT SUM(sh_cikis) AS toplamCikis FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' AND sh_stokID = '$value'\";\r\n\r\n\t\t\t$toplamCikisExe = $this->db->query($toplamCikisQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamGiris = $toplamGirisExe->toplamGiris;\r\n\r\n\t\t\t$toplamCikis = $toplamCikisExe->toplamCikis;\r\n\r\n\t\t\t$kalan = $toplamGiris - $toplamCikis;\r\n\r\n\r\n\r\n\t\t\t$sonuc = $kalan + $stokMiktar[$key];\r\n\r\n\r\n\r\n\t\t\tif ($sonuc < 0) {\r\n\r\n\t\t\t\techo \"1\";\r\n\r\n\t\t\t\tdie;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function goruntule()\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura GÃ¶rÃ¼ntÃ¼le\";\r\n\r\n\r\n\r\n\t\t$faturaTipi = $this->input->get(\"tipi\");\r\n\r\n\t\t$faturaID = $this->input->get(\"id\");\r\n\r\n\r\n\r\n\t\tif ($faturaTipi == \"satis\") {\r\n\r\n\t\t\t$faturaQ = \"SELECT * FROM satisFaturasi WHERE satis_id = '$faturaID' AND satis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$faturaExe = $this->db->query($faturaQ)->row();\r\n\r\n\t\t\t$data[\"fatura\"] = $faturaExe;\r\n\r\n\r\n\r\n\t\t\t$cariQ = \"SELECT * FROM cari WHERE cari_id = '$faturaExe->satis_cariID' AND cari_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($cariQ)->row();\r\n\r\n\r\n\r\n\t\t\tif ($faturaExe) {\r\n\r\n\t\t\t\t$this->load->view('fatura/fatura-goruntule', $data);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$this->load->view('hata');\r\n\r\n\t\t\t}\r\n\r\n\t\t} else if ($faturaTipi == \"alis\") {\r\n\r\n\t\t\t$faturaQ = \"SELECT * FROM alisFaturasi WHERE alis_id = '$faturaID' AND alis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$faturaExe = $this->db->query($faturaQ)->row();\r\n\r\n\t\t\t$data[\"fatura\"] = $faturaExe;\r\n\r\n\r\n\r\n\t\t\t$cariQ = \"SELECT * FROM cari WHERE cari_id = '$faturaExe->alis_cariID' AND cari_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($cariQ)->row();\r\n\r\n\r\n\r\n\t\t\tif ($faturaExe) {\r\n\r\n\t\t\t\t$this->load->view('fatura/fatura-goruntule', $data);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$this->load->view('hata');\r\n\r\n\t\t\t}\r\n\r\n\t\t} else if ($faturaTipi == \"proforma\") {\r\n\r\n\t\t\t$faturaQ = \"SELECT * FROM proformaFaturasi WHERE proforma_id = '$faturaID' AND proforma_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$faturaExe = $this->db->query($faturaQ)->row();\r\n\r\n\t\t\t$data[\"fatura\"] = $faturaExe;\r\n\r\n\r\n\r\n\t\t\t$cariQ = \"SELECT * FROM cari WHERE cari_id = '$faturaExe->proforma_cariID' AND cari_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($cariQ)->row();\r\n\r\n\r\n\r\n\t\t\tif ($faturaExe) {\r\n\r\n\t\t\t\t$this->load->view('fatura/fatura-goruntule', $data);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$this->load->view('hata');\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$this->load->view('hata');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function paraBirimiKontrol()\r\n\r\n\t{\r\n\r\n\t\t$data = $this->input->post();\r\n\r\n\r\n\r\n\t\t$paraBirimi = $data[\"paraBirimi\"];\r\n\r\n\t\t$paraBirimi_converted = getPriceOfCurrency_TCMB($paraBirimi);\r\n\r\n\r\n\r\n\t\techo $paraBirimi_converted;\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function seriYonetimi()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Seri YÃ¶netimi\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$sorgu1 = \"SELECT * FROM seriYonetimi WHERE seri_urun = 1 AND seri_olusturanAnaHesap = '$anaHesap' ORDER BY seri_id DESC\";\r\n\r\n\t\t$sorgu2 = \"SELECT * FROM seriYonetimi WHERE seri_urun = 2 AND seri_olusturanAnaHesap = '$anaHesap' ORDER BY seri_id DESC\";\r\n\r\n\t\t$sorgu3 = \"SELECT * FROM seriYonetimi WHERE seri_urun = 3 AND seri_olusturanAnaHesap = '$anaHesap' ORDER BY seri_id DESC\";\r\n\r\n\t\t$sorgu4 = \"SELECT * FROM seriYonetimi WHERE seri_urun = 4 AND seri_olusturanAnaHesap = '$anaHesap' ORDER BY seri_id DESC\";\r\n\r\n\t\t$data[\"eFaturaSeri\"] = $this->db->query($sorgu1)->result();\r\n\r\n\t\t$data[\"eArsivSeri\"] = $this->db->query($sorgu2)->result();\r\n\r\n\t\t$data[\"eirsaliyeSeri\"] = $this->db->query($sorgu3)->result();\r\n\r\n\t\t$data[\"eirsaliyeYanitSeri\"] = $this->db->query($sorgu4)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/seri-yonetimi\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function seriEkle(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$seri_urun = postval(\"seri_urun\");\r\n\r\n\t\t$seri_seriOnEki = postval(\"seri_seriOnEki\");\r\n\r\n\r\n\r\n\t\t$seriKontrol = $this->db->query(\"SELECT * FROM seriYonetimi WHERE seri_olusturanAnaHesap = '$anaHesap' AND seri_seriOnEki = '$seri_seriOnEki'\")->row();\r\n\r\n\r\n\r\n\t\tif($seriKontrol){\r\n\r\n\t\t\t$this->session->set_flashdata('seri_var', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif (!checkSpecialChars($seri_seriOnEki)) {\r\n\r\n\t\t\t$this->session->set_flashdata('seri_ozel_karakter', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif (strlen($seri_seriOnEki) != 3) {\r\n\r\n\t\t\t$this->session->set_flashdata('seri_karakter_siniri', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$seri_siraNo = postval(\"seri_siraNo\");\r\n\r\n\t\t$seri_seriYili = postval(\"seri_seriYili\");\r\n\r\n\t\t$seri_varsayilan = postval(\"seri_varsayilan\");\r\n\r\n\t\t$seri_eArsivTipi = postval(\"seri_eArsivTipi\");\r\n\r\n\r\n\r\n\t\tif ($seri_varsayilan == 1) {\r\n\r\n\r\n\r\n\t\t\tif ($seri_eArsivTipi) {\r\n\r\n\t\t\t\t\t$updateQ = \"UPDATE seriYonetimi SET seri_varsayilan = NULL WHERE seri_varsayilan = 1 AND seri_urun = '$seri_urun' AND seri_olusturanAnaHesap = '$anaHesap' AND seri_eArsivTipi = '$seri_eArsivTipi'\";\r\n\r\n\t\t\t\t$this->db->query($updateQ);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$updateQ = \"UPDATE seriYonetimi SET seri_varsayilan = NULL WHERE seri_varsayilan = 1 AND seri_urun = '$seri_urun' AND seri_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t\t$this->db->query($updateQ);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"seri_durum\"] = 1;\r\n\r\n\t\t$data[\"seri_urun\"] = $seri_urun;\r\n\r\n\t\t$data[\"seri_seriOnEki\"] = $seri_seriOnEki;\r\n\r\n\t\t$data[\"seri_siraNo\"] = $seri_siraNo;\r\n\r\n\t\t$data[\"seri_seriYili\"] = $seri_seriYili;\r\n\r\n\t\t$data[\"seri_aciklama\"] = postval(\"seri_aciklama\");\r\n\r\n\t\t$data[\"seri_varsayilan\"] = $seri_varsayilan;\r\n\r\n\t\t$data[\"seri_eArsivTipi\"] = $seri_eArsivTipi;\r\n\r\n\t\t$data[\"seri_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"seri_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"seri_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"seri_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('seri_fatura_basarili', 'OK');\r\n\r\n\t\t$this->vt->insert(\"seriYonetimi\", $data);\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function seriVarsayilan($id, $urun, $arsivTipi = NULL)\r\n\r\n\t{\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\tif ($arsivTipi) {\r\n\r\n\t\t\t$updateQ = \"UPDATE seriYonetimi SET seri_varsayilan = NULL WHERE seri_varsayilan = 1 AND seri_urun = '$urun' AND seri_olusturanAnaHesap = '$anaHesap' AND seri_eArsivTipi = '$arsivTipi' \";\r\n\r\n\t\t\t$this->db->query($updateQ);\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$updateQ = \"UPDATE seriYonetimi SET seri_varsayilan = NULL WHERE seri_varsayilan = 1 AND seri_urun = '$urun' AND seri_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$this->db->query($updateQ);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$updateQ2 = \"UPDATE seriYonetimi SET seri_varsayilan = 1 WHERE seri_id = '$id' AND seri_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$this->db->query($updateQ2);\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('varsayilan_ok', 'OK');\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function seriGuncelle(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$seri_urun = postval(\"seri_urun\");\r\n\r\n\r\n\r\n\t\t$seri_seriOnEki = postval(\"seri_seriOnEki\");\r\n\r\n\r\n\r\n\t\t$seri_id = postval(\"seri_id\");\r\n\r\n\r\n\r\n\t\t$seriKontrol = $this->db->query(\"SELECT * FROM seriYonetimi WHERE seri_olusturanAnaHesap = '$anaHesap' AND seri_seriOnEki = '$seri_seriOnEki' AND seri_id != '$seri_id'\")->row();\r\n\r\n\r\n\r\n\t\tif($seriKontrol){\r\n\r\n\t\t\t$this->session->set_flashdata('seri_var', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif (!checkSpecialChars($seri_seriOnEki)) {\r\n\r\n\t\t\t$this->session->set_flashdata('seri_ozel_karakter', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif (strlen($seri_seriOnEki) != 3) {\r\n\r\n\t\t\t$this->session->set_flashdata('seri_karakter_siniri', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$seri_siraNo = postval(\"seri_siraNo\");\r\n\r\n\t\t$seri_seriYili = postval(\"seri_seriYili\");\r\n\r\n\t\t$seri_varsayilan = postval(\"seri_varsayilan\");\r\n\r\n\t\t$seri_eArsivTipi = postval(\"seri_eArsivTipi\");\r\n\r\n\r\n\r\n\t\tif ($seri_varsayilan == 1) {\r\n\r\n\r\n\r\n\t\t\tif ($seri_eArsivTipi) {\r\n\r\n\t\t\t\t$updateQ = \"UPDATE seriYonetimi SET seri_varsayilan = NULL WHERE seri_varsayilan = 1 AND seri_urun = '$seri_urun' AND seri_olusturanAnaHesap = '$anaHesap' AND seri_eArsivTipi = '$seri_eArsivTipi'\";\r\n\r\n\t\t\t\t$this->db->query($updateQ);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$updateQ = \"UPDATE seriYonetimi SET seri_varsayilan = NULL WHERE seri_varsayilan = 1 AND seri_urun = '$seri_urun' AND seri_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t\t$this->db->query($updateQ);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$seri_id=postval(\"seri_id\");\r\n\r\n\t\t$data[\"seri_durum\"] = 1;\r\n\r\n\t\t$data[\"seri_urun\"] = $seri_urun;\r\n\r\n\t\t$data[\"seri_seriOnEki\"] = $seri_seriOnEki;\r\n\r\n\t\t$data[\"seri_siraNo\"] = $seri_siraNo;\r\n\r\n\t\t$data[\"seri_seriYili\"] = $seri_seriYili;\r\n\r\n\t\t$data[\"seri_aciklama\"] = postval(\"seri_aciklama\");\r\n\r\n\t\t$data[\"seri_varsayilan\"] = $seri_varsayilan;\r\n\r\n\t\t$data[\"seri_eArsivTipi\"] = $seri_eArsivTipi;\r\n\r\n\t\t$data[\"seri_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"seri_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"seri_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"seri_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('seri_arsiv_guncelle_basarili', 'OK');\r\n\r\n\t\t$this->vt->update(\"seriYonetimi\",array('seri_id' => $seri_id), $data);\r\n\r\n\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function satis_fatura_sil()\r\n\r\n\t{\r\n\r\n\t\t$id = $this->input->get('fatura_id');\r\n\r\n\t\t$del1 = \"DELETE FROM satisFaturasi WHERE satis_id=$id\";\r\n\r\n\t\t$del2 = \"DELETE FROM satisFaturasiStok WHERE satisStok_satisFaturasiID=$id\";\r\n\r\n\t\t$del3 = \"DELETE FROM stokHareketleri WHERE sh_faturaID=$id\";\r\n\r\n\t\t$del4 = \"DELETE FROM cariHareketleri WHERE ch_faturaID=$id\";\r\n\r\n\t\t$this->db->query($del1);\r\n\r\n\t\t$this->db->query($del2);\r\n\r\n\t\t$this->db->query($del3);\r\n\r\n\t\t$this->db->query($del4);\r\n\r\n\t\t$this->session->set_flashdata('fatura_sil_ok', 'OK');\r\n\r\n\t\tredirect(\"fatura/satisFaturasiListesi\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function alis_fatura_sil(){\r\n\r\n\t\t$id = $this->input->get('fatura_id');\r\n\r\n\t\t$del1 = \"DELETE FROM alisFaturasi WHERE alis_id=$id\";\r\n\r\n\t\t$del2 = \"DELETE FROM alisFaturasiStok WHERE alisStok_alisFaturasiID=$id\";\r\n\r\n\t\t$del3 = \"DELETE FROM stokHareketleri WHERE sh_faturaID=$id\";\r\n\r\n\t\t$del4 = \"DELETE FROM cariHareketleri WHERE ch_faturaID=$id\";\r\n\r\n\t\t$this->db->query($del1);\r\n\r\n\t\t$this->db->query($del2);\r\n\r\n\t\t$this->db->query($del3);\r\n\r\n\t\t$this->db->query($del4);\r\n\r\n\t\t$this->session->set_flashdata('fatura_sil_ok', 'OK');\r\n\r\n\t\tredirect(\"fatura/alisFaturasiListesi\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function efaturaIceAktar($faturano){\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t//faturayÄ± oku\r\n\r\n\t\t$ws_archive = env(EFATURA_URL);\r\n\r\n\r\n\r\n\t\t$SESSION_ID = getSessionID();\r\n\r\n\r\n\r\n\t\t$trace = true;\r\n\r\n\t\t$exceptions = false;\r\n\r\n\r\n\r\n\t\t$xml_array->REQUEST_HEADER->SESSION_ID = $SESSION_ID;\r\n\r\n\t\t$xml_array->REQUEST_HEADER->APPLICATION_NAME = env(APPLICATION_NAME);\r\n\r\n\t\t$xml_array->REQUEST_HEADER->COMPRESSED = 'N';\r\n\r\n\t\t$xml_array->INVOICE_SEARCH_KEY->READ_INCLUDED = 'true';\r\n\r\n\t\t$xml_array->INVOICE_SEARCH_KEY->DIRECTION = \"IN\";\r\n\r\n\t\t$xml_array->INVOICE_SEARCH_KEY->ID = $faturano; //Evrensel Tekil TanÄ±mlama NumarasÄ± (ETTN) ile fatura okumak iÃ§in kullanÄ±labilir. GUID formatÄ±nda//\tIN deÄŸeri gÃ¶nderilecek.\r\n\r\n\t\t$xml_array->INVOICE_SEARCH_KEY->TYPE = \"XML\"; //faturayÄ± almak istediÄŸini formattÄ±r. PDF, HTML, XML deÄŸeri alabilir. XML deÄŸeri gÃ¶nderilmezse faturanÄ±n imzalÄ± UBL-TR XML dosyasÄ± dÃ¶nÃ¼lecektir.\r\n\r\n\r\n\r\n\t\t$xml_array->HEADER_ONLY = 'N';\r\n\r\n\r\n\r\n\t\t$client = new SoapClient($ws_archive, array('trace' => $trace, 'exceptions' => $exceptions));\r\n\r\n\r\n\r\n\t\t$response = $client->GetInvoiceWithType($xml_array);\r\n\r\n\r\n\r\n\t\t$response = $response->INVOICE->CONTENT->_;\r\n\r\n\r\n\r\n\t\t//faturayÄ± oku\r\n\r\n\r\n\r\n\t\t$dosya = fopen(\"veri.xml\", \"w\");\r\n\r\n\t\t$yaz = fputs($dosya, $response);//faturayÄ± xml olarak kaydet\r\n\r\n\r\n\r\n\t\t$xml = simplexml_load_file('veri.xml');\r\n\r\n\r\n\r\n\t\t//xml dosyasÄ±nÄ± okuyup data array'e yaz\r\n\r\n\r\n\r\n\t\t$data[\"faturano\"] = $faturano;\r\n\r\n\t\t$cariID = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PartyIdentification/cbc:ID');\r\n\r\n\t\t$faturaTarih = $xml->xpath('//cbc:IssueDate');\r\n\r\n\t\t$data[\"faturaTarih\"] = $faturaTarih[0];\r\n\r\n\t\t$faturaSaat = $xml->xpath('//cbc:IssueTime');\r\n\r\n\t\t$data[\"faturaSaat\"] = $faturaSaat[0];\r\n\r\n\t\t$faturaTip = $xml->xpath('//cbc:InvoiceTypeCode');\r\n\r\n\t\t$data[\"faturaTip\"] = $faturaTip[0];\r\n\r\n\t\t$senaryo = $xml->xpath('//cbc:ProfileID');\r\n\r\n\t\t$data[\"faturaSenaryo\"] = $senaryo[0];\r\n\r\n\t\t$faturaParaBirimi = $xml->xpath('//cbc:DocumentCurrencyCode');\r\n\r\n\t\t$data[\"faturaParaBirimi\"] = $faturaParaBirimi[0];\r\n\r\n\r\n\r\n\t\t//dÃ¶viz\r\n\r\n\t\t$dovizKur = $xml->xpath('//cac:PricingExchangeRate/cbc:CalculationRate');\r\n\r\n\r\n\r\n\t\t//iade fatura bilgileri\r\n\r\n\t\t$iadeFatNo = $xml->xpath('//cac:BillingReference/cac:InvoiceDocumentReference/cbc:ID');\r\n\r\n\t\t$iadeFatTarih = $xml->xpath('//cac:BillingReference/cac:InvoiceDocumentReference/cbc:IssueDate');\r\n\r\n\r\n\r\n\t\t//ara toplam\r\n\r\n\t\t$araToplam = $xml->xpath('//cac:LegalMonetaryTotal/cbc:LineExtensionAmount');\r\n\r\n\t\t$data[\"araToplam\"] = $araToplam[0][0];\r\n\r\n\r\n\r\n\t\t//toplam indirim\r\n\r\n\t\t$indirimTutar = $xml->xpath('//cac:LegalMonetaryTotal/cbc:AllowanceTotalAmount');\r\n\r\n\t\t$data[\"indirim\"] = $indirimTutar[0];\r\n\r\n\r\n\r\n\t\t$netTutar = $xml->xpath('//cac:LegalMonetaryTotal/cbc:TaxExclusiveAmount');\r\n\r\n\t\t$data[\"netTutar\"] = $netTutar[0];\r\n\r\n\r\n\r\n\t\t$vergiDahil = $xml->xpath('//cac:LegalMonetaryTotal/cbc:TaxInclusiveAmount');\r\n\r\n\t\t$data[\"vergiDahil\"] = $vergiDahil[0];\r\n\r\n\r\n\r\n\t\t$genelToplam = $xml->xpath('//cac:LegalMonetaryTotal/cbc:PayableAmount');\r\n\r\n\t\t$data[\"genelToplam\"] = $genelToplam[0];\r\n\r\n\r\n\r\n\t\t//istisna\r\n\r\n\t\t$istisnaKod = $xml->xpath('//cac:TaxTotal/cac:TaxSubtotal/cac:TaxCategory/cbc:TaxExemptionReasonCode');\r\n\r\n\r\n\r\n\t\t//vergi muafiyet\r\n\r\n\t\t$vergiMuafiyet = $xml->xpath('//cac:TaxTotal/cac:TaxSubtotal/cac:TaxCategory/cbc:TaxExemptionReason');\r\n\r\n\t\t$data[\"vergiMuafiyet\"] = $vergiMuafiyet[0];//todo: test edilecek\r\n\r\n\r\n\r\n\t\t//cari\r\n\r\n\t\tif (count($cariID) > 0) {\r\n\r\n\t\t\t$cariID = $cariID[0];\r\n\r\n\t\t\tif (strlen($cariID) == 10)\r\n\r\n\t\t\t\t$cariQ = \"SELECT * FROM cari where cari_vergiNumarasi='$cariID' AND cari_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$cariQ = \"SELECT * FROM cari where cari_tckn='$cariID' AND cari_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($cariQ)->row();\r\n\r\n\r\n\r\n\t\t\tif (count($data[\"cari\"]) == 0) {\r\n\r\n\t\t\t\t$cariAd = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PartyName/cbc:Name');\r\n\r\n\t\t\t\t$cariAdresRoom = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:Room');\r\n\r\n\t\t\t\t$cariAdresStreet = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:StreetName');\r\n\r\n\t\t\t\t$cariAdresBuilding = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:BuildingName');\r\n\r\n\t\t\t\t$cariAdresBuildingNumber = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:BuildingNumber');\r\n\r\n\t\t\t\t$cariAdresPostal = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:PostalZone');\r\n\r\n\t\t\t\t$cariAdresCitySubdivisionName = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:CitySubdivisionName');\r\n\r\n\t\t\t\t$cariAdresCityName = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PostalAddress/cbc:CityName');\r\n\r\n\t\t\t\t$cariVergiDaire = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:PartyTaxScheme/cac:TaxScheme/cbc:Name');\r\n\r\n\t\t\t\t$cariEposta = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:Contact/cbc:ElectronicMail');\r\n\r\n\t\t\t\t$cariTelefon = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:Contact/cbc:Telephone');\r\n\r\n\r\n\r\n\t\t\t\t$data[\"cari\"]->cari_ad = $cariAd[0];\r\n\r\n\t\t\t\t$data[\"cari\"]->cari_adres = $cariAdresStreet[0] . \" \" . $cariAdresBuilding[0] . \" No:\" . $cariAdresBuildingNumber[0] . \" \" . $cariAdresPostal[0] . \" \" . $cariAdresCitySubdivisionName[0] . \" / \" . $cariAdresCityName[0];\r\n\r\n\t\t\t\t$data[\"cari\"]->cari_kodu = $cariID;\r\n\r\n\t\t\t\t$data[\"cari\"]->cari_vergiDairesi = $cariVergiDaire[0];\r\n\r\n\r\n\r\n\t\t\t\t$data[\"cari\"]->cari_firmaEPosta = $cariEposta[0];\r\n\r\n\t\t\t\t$data[\"cari\"]->cari_firmaTelefon = $cariTelefon[0];\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data[\"cari_value\"] = $cariID . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//iade faturalarÄ±\r\n\r\n\t\tif (count($iadeFatNo) > 0) {\r\n\r\n\t\t\t$i = 0;\r\n\r\n\t\t\tforeach ($iadeFatNo as $item) {\r\n\r\n\t\t\t\t$iade[$i][\"faturano\"] = strval($item);\r\n\r\n\t\t\t\t$iade[$i][\"faturatarih\"] = explode(\" \", $iadeFatTarih[$i])[0];\r\n\r\n\t\t\t\t$i++;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $iade;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//doviz kur\r\n\r\n\t\tif (count($dovizKur) > 0) {\r\n\r\n\t\t\t$data[\"doviz\"] = $dovizKur[0];\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//istisna\r\n\r\n\t\tif (count($istisnaKod) > 0) {\r\n\r\n\t\t\t$kod = strval($istisnaKod[0]);\r\n\r\n\t\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari where istisna_kodu='$kod'\";\r\n\r\n\t\t\t$istisnaExe = $this->db->query($istisnaQ)->row();\r\n\r\n\r\n\r\n\t\t\t$data[\"istisna\"] = \"<option value='$istisnaExe->istisna_id'>$istisnaExe->istisna_kodu $istisnaExe->istisna_adi</option>\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$invoiceLine = $xml->xpath(\"//cac:InvoiceLine\");\r\n\r\n\r\n\r\n\t\t$data[\"toplamTevkifatKdv\"] = 0;\r\n\r\n\r\n\r\n\t\tfor ($i = 0; $i < count($invoiceLine); $i++) {\r\n\r\n\t\t\t$j = $i + 1;\r\n\r\n\t\t\t$stokText = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:Item');\r\n\r\n\t\t\t$stokAd_orj = $stokText[0]->children(\"cbc\", true)->Name;\r\n\r\n\t\t\t$stokAd = str_replace('\\'', '', $stokAd_orj);\r\n\r\n\t\t\t$stokQ = \"select stok_id,stok_ad,stok_kodu from stok where stok_olusturanAnaHesap = '$anaHesap' AND stok_ad like '%$stokAd%'\";\r\n\r\n\t\t\t$stokExe = $this->db->query($stokQ)->row();\r\n\r\n\r\n\r\n\t\t\tif (count($stokExe) == 0) {\r\n\r\n\t\t\t\t$stokText = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:Item/cac:SellersItemIdentification');\r\n\r\n\t\t\t\tif ($stokText)\r\n\r\n\t\t\t\t\t$stokKod = $stokText[0]->children(\"cbc\", true)->ID;\r\n\r\n\t\t\t\t$stok[$i][\"kod\"] = $stokKod;\r\n\r\n\t\t\t\t$stok[$i][\"id\"] = -1;\r\n\r\n\t\t\t\t$stok[$i][\"ad\"] = $stokAd;\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$stok[$i][\"kod\"] = $stokExe->stok_kodu;\r\n\r\n\t\t\t\t$stok[$i][\"id\"] = $stokExe->stok_id;\r\n\r\n\t\t\t\t$stok[$i][\"ad\"] = $stokExe->stok_ad;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$miktar = $xml->xpath(\"//cac:InvoiceLine['.$j.']/cbc:InvoicedQuantity\");\r\n\r\n\t\t\t$stok[$i][\"miktar\"] = explode(\" \", $miktar[$i])[0];\r\n\r\n\r\n\r\n\t\t\t$birimFiyat = $xml->xpath(\"//cac:InvoiceLine['.$j.']/cac:Price/cbc:PriceAmount\");\r\n\r\n\t\t\t$stok[$i][\"birimFiyat\"] = $birimFiyat[$i][0];\r\n\r\n\r\n\r\n\t\t\t$birim = $miktar[$i][\"unitCode\"];\r\n\r\n\r\n\r\n\t\t\tif($birim==\"NIU\")\r\n\r\n\t\t\t\t$birim=\"C62\";\r\n\r\n\t\t\t$stokBirimQ = \"select * from stokBirimleri where stokBirim_kodu='$birim' \";\r\n\r\n\t\t\t$stokBirimExe = $this->db->query($stokBirimQ)->row();\r\n\r\n\t\t\t$data[\"stokBirim\"] = \"<option value='$stokBirimExe->stokBirim_id'>$stokBirimExe->stokBirim_ad </option>\";\r\n\r\n\r\n\r\n\t\t\t$kdvOran = $xml->xpath(\"//cac:InvoiceLine['.$j.']/cac:TaxTotal/cac:TaxSubtotal/cbc:Percent\");\r\n\r\n\t\t\t$stok[$i][\"stokKdvOran\"] = $kdvOran[$i][0];\r\n\r\n\r\n\r\n\t\t\t$stokToplamFiyat = $xml->xpath('//cac:InvoiceLine/cbc:LineExtensionAmount');\r\n\r\n\t\t\t$toplamFiyat = explode(\" \", $stokToplamFiyat[$i])[0];\r\n\r\n\t\t\t$stok[$i][\"toplamFiyat\"] = $toplamFiyat;\r\n\r\n\r\n\r\n\t\t\t$stokKdv = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:TaxTotal/cbc:TaxAmount');\r\n\r\n\t\t\t$kdv = explode(\" \", $stokKdv[$i])[0];\r\n\r\n\t\t\t$data[\"toplamKdv\"] += $kdv;\r\n\r\n\r\n\r\n\t\t\t$iskonto = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:AllowanceCharge');\r\n\r\n\t\t\tif ($iskonto)\r\n\r\n\t\t\t\t$stok[$i][\"satirIndirim\"] = explode(\" \", $iskonto[0]->children(\"cbc\", true)->MultiplierFactorNumeric)[0];\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$stok[$i][\"satirIndirim\"] = 0;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$tevkifat = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:WithholdingTaxTotal/cac:TaxSubtotal/cac:TaxCategory/cac:TaxScheme');\r\n\r\n\t\t\tif ($tevkifat) {\r\n\r\n\t\t\t\t$stok[$i][\"tevkifatAd\"] = $tevkifat[0]->children(\"cbc\", true)->Name;\r\n\r\n\t\t\t\t$stok[$i][\"tevkifatKod\"] = explode(\" \", $tevkifat[0]->children(\"cbc\", true)->TaxTypeCode)[0];\r\n\r\n\t\t\t\t$stok[$i][\"tevkifatOran\"] = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:WithholdingTaxTotal/cac:TaxSubtotal/cbc:Percent')[0];\r\n\r\n\r\n\r\n\t\t\t\t$fiyat = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:WithholdingTaxTotal/cac:TaxSubtotal/cbc:TaxAmount')[0];\r\n\r\n\r\n\r\n\t\t\t\t$data[\"toplamTevkifatKdv\"] += $fiyat;\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$stok[$i][\"tevkifatAd\"] = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"stok\"] = $stok;\r\n\r\n\t\t$data[\"baslik\"] = \"E-Fatura Ä°Ã§e Aktar\";\r\n\r\n\t\t$this->load->view(\"fatura/efaturaIceAktar\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function efaturaIceAktarKaydet()\r\n\r\n\t{\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$cari_id = postval(\"cari_id\");\r\n\r\n\t\t$faturano = postval(\"faturaNumara\");\r\n\r\n\t\t$paraBirimi=postval(\"paraBirimi\");\r\n\r\n\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\tif($paraBirimi==2)\r\n\r\n\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t//cari kayÄ±tlÄ± deÄŸil ise cari ekle\r\n\r\n\t\tif ($cari_id == \"\") {\r\n\r\n\t\t\t$cari_kod = postval(\"cari_kodu\");\r\n\r\n\t\t\t//alias pk Ã¶ÄŸrenme (checkUser)\r\n\r\n\t\t\t$ws = env('AUTH_URL');\r\n\r\n\r\n\r\n\t\t\t$trace = true;\r\n\r\n\t\t\t$exceptions = false;\r\n\r\n\r\n\r\n\t\t\t$xml_array->REQUEST_HEADER->SESSION_ID = getSessionID();\r\n\r\n\t\t\t$xml_array->REQUEST_HEADER->APPLICATION_NAME = env('APPLICATION_NAME');\r\n\r\n\t\t\t$xml_array->USER->IDENTIFIER = $cari_kod; //MÃ¼kellefiyeti sorgulanacak firmanÄ±n vergi kimlik numarasÄ±\r\n\r\n\t\t\t$xml_array->DOCUMENT_TYPE = \"INVOICE\"; //\tMÃ¼kelleffiyet kontrol edilecek Ã¼rÃ¼n tipi. E-Fatura iÃ§in INVOICE, E-Ä°rsaliye iÃ§in DESPATCHADVICE gÃ¶nderilmelidir.\r\n\r\n\r\n\r\n\t\t\t$client = new SoapClient($ws, array('trace' => $trace, 'exceptions' => $exceptions));\r\n\r\n\r\n\r\n\t\t\t$response = $client->CheckUser($xml_array);\r\n\r\n\r\n\r\n\t\t\t$error_short_des = $response->ERROR_TYPE->ERROR_SHORT_DES;\r\n\r\n\t\t\tif (isSessionKilled($error_short_des) == 1) {//session koptu anlamÄ±na gelir, yeni session Ã¼retilip yazÄ±lmalÄ± ve tekrar denenmelidir.\r\n\r\n\t\t\t\tgenerateNewSession();\r\n\r\n\t\t\t\t$this->efaturaIceAktarKaydet();\r\n\r\n\t\t\t} else {//session devam eder, normal prosedÃ¼r devam et.\r\n\r\n\t\t\t\t$dataf = (array)$response;\r\n\r\n\t\t\t\t$alias_pk = $dataf[\"USER\"][0]->ALIAS;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t//cari ekleme\r\n\r\n\t\t\t$dataCari[\"cari_kodu\"] = $cari_kod;\r\n\r\n\t\t\t$dataCari[\"cari_ad\"] = postval(\"cari_ad\");\r\n\r\n\t\t\t$dataCari[\"cari_vergiDairesi\"] = postval(\"cari_vergiDairesi\");\r\n\r\n\t\t\tif (strlen($cari_kod) == 10)\r\n\r\n\t\t\t\t$dataCari[\"cari_vergiNumarasi\"] = $cari_kod;\r\n\r\n\t\t\telse if (strlen($cari_kod) == 11)\r\n\r\n\t\t\t\t$dataCari[\"cari_tckn\"] = $cari_kod;\r\n\r\n\t\t\t$dataCari[\"cari_firmaEPosta\"] = postval(\"cari_firmaEPosta\");\r\n\r\n\t\t\t$dataCari[\"cari_firmaTelefon\"] = postval(\"cari_firmaTelefon\");\r\n\r\n\t\t\t$dataCari[\"cari_adres\"] = postval(\"cari_adres\");\r\n\r\n\t\t\t$dataCari[\"cari_olusturan\"] = $u_id;\r\n\r\n\t\t\t$dataCari[\"cari_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$dataCari[\"cari_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$dataCari[\"cari_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t$dataCari[\"cari_bireysel\"] = 0;\r\n\r\n\t\t\t$dataCari[\"cari_alias_pk\"] = $alias_pk;\r\n\r\n\t\t\t$this->db->insert(\"cari\", $dataCari);\r\n\r\n\t\t\t$cari_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//cari hareketi ekle\r\n\r\n\t\t$dataCariHareket[\"ch_belgeNumarasi\"] = $faturano;\r\n\r\n\t\t$dataCariHareket[\"ch_turu\"] = 1;\r\n\r\n\t\t$dataCariHareket[\"ch_cariID\"] = $cari_id;\r\n\r\n\t\t$dataCariHareket[\"ch_faturaID\"] = -1;\r\n\r\n\t\t$dataCariHareket[\"ch_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n/*\r\n\r\n\t\tif($dovizCevrilmis)\r\n\r\n\t\t\t$data_ch[\"ch_alacak\"] =$dovizCevrilmis;\r\n\r\n\t\telse*/\r\n\r\n\t\t$dataCariHareket[\"ch_alacak\"] = postval(\"geneltopHidden\");\r\n\r\n\t\t$dataCariHareket[\"ch_tarih\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t$dataCariHareket[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t$dataCariHareket[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$dataCariHareket[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$dataCariHareket[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"cariHareketleri\", $dataCariHareket);\r\n\r\n\r\n\r\n\t\t//stok ve stok hareketi ekle\r\n\r\n\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$indirimliFiyat = postval(\"toplamHidden\");\r\n\r\n\t\t$stokkodu = postval(\"stokkodu\");\r\n\r\n\t\t$stokadi = postval(\"stokadi\");\r\n\r\n\t\t$stokbirim = postval(\"stok_birimID\");\r\n\r\n\r\n\r\n\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\t\t\tif ($stokid[$i] == -1) {\r\n\r\n\t\t\t\t$dataStok[\"stok_kodu\"] = $stokkodu[$i];\r\n\r\n\t\t\t\t$dataStok[\"stok_ad\"] = $stokadi[$i];\r\n\r\n\t\t\t\t$dataStok[\"stok_birimID\"] = $stokbirim[$i];\r\n\r\n\t\t\t\t$dataStok[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataStok[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataStok[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataStok[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"stok\", $dataStok);\r\n\r\n\t\t\t\t$stokid[$i] = $this->db->insert_id();\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$toplamKDV = $indirimliFiyat[$i] * $kdv[$i] / 100;\r\n\r\n\t\t\t$toplamFiyat = $toplamKDV + $indirimliFiyat[$i];\r\n\r\n\r\n\r\n\t\t\t$data_sh[\"sh_turu\"] = 1;\r\n\r\n\t\t\t$data_sh[\"sh_giris\"] = $miktar[$i];\r\n\r\n\t\t\t$data_sh[\"sh_cariID\"] = $cari_id;\r\n\r\n\t\t\t$data_sh[\"sh_stokID\"] = $stokid[$i];\r\n\r\n\t\t\t$data_sh[\"sh_belgeNumarasi\"] = $faturano;\r\n\r\n\t\t\t$data_sh[\"sh_faturaID\"] = -1;\r\n\r\n\t\t\t$data_sh[\"sh_paraBirimi\"]=$paraBirimiTxt;\r\n\r\n\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$data_sh[\"sh_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$data_sh[\"sh_toplamKDV\"] = $toplamKDV;\r\n\r\n\t\t\t$data_sh[\"sh_toplamFiyat\"] = $toplamFiyat;\r\n\r\n\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\t\t}\r\n\r\n\t\t$this->session->set_flashdata('ice_aktar_ok', 'OK');\r\n\r\n\t\tredirect(\"fatura/efatura-gelen\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function taslakFaturaYukle()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"E-Fatura YÃ¼kle\";\r\n\r\n\t\t$this->load->view(\"fatura/taslakFaturaYukle\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function taslakFaturaKaydet()\r\n\r\n\t{\r\n\r\n\t\t$path = 'assets/bulut/';\r\n\r\n\t\tif (!empty($_FILES['file']['name'])) {\r\n\r\n\t\t\t$config['upload_path'] = $path;\r\n\r\n\t\t\t$config['allowed_types'] = 'xml';\r\n\r\n\t\t\t$config['file_name'] = $_FILES['file']['name'];\r\n\r\n\t\t\t$config['encrypt_name'] = TRUE;\r\n\r\n\t\t\t$config['max_width'] = 250;\r\n\r\n\t\t\t$config['max_height'] = 250;\r\n\r\n\r\n\r\n\t\t\t$this->load->library('upload', $config);\r\n\r\n\r\n\r\n\t\t\tif ($this->upload->do_upload('file')) {\r\n\r\n\t\t\t\t$fileName = $this->upload->data('file_name');\r\n\r\n\r\n\r\n\t\t\t\t$xml = simplexml_load_file($path . \"/\" . $fileName);\r\n\r\n\r\n\r\n\t\t\t\t//xml dosyasÄ±nÄ± okuyup data array'e yaz\r\n\r\n\t\t\t\t$ch_turu=2;\r\n\r\n\t\t\t\t$sh_turu=2;\r\n\r\n\r\n\r\n\t\t\t\t$faturaNo = $xml->xpath('//cbc:ID');\r\n\r\n\t\t\t\t$faturaNo = $faturaNo[0];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\t\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t\t\t//$dataSatis[\"satis_faturaNo\"]=$faturaNo;\r\n\r\n\r\n\r\n\t\t\t\t#region cariKontrol\r\n\r\n\r\n\r\n\t\t\t\t//faturanÄ±n gÃ¶nderileceÄŸi kiÅŸinin vkn sini veritabanÄ±nda ara. yok ise cari oluÅŸtur. cari id sini al\r\n\r\n\r\n\r\n\t\t\t\t$cariID = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PartyIdentification/cbc:ID');\r\n\r\n\t\t\t\t//cari\r\n\r\n\t\t\t\tif (count($cariID) > 0) {\r\n\r\n\t\t\t\t\t$cariID = $cariID[0];\r\n\r\n\t\t\t\t\tif (strlen($cariID) == 10)\r\n\r\n\t\t\t\t\t\t$cariQ = \"SELECT * FROM cari where cari_vergiNumarasi='$cariID'\";\r\n\r\n\t\t\t\t\telse\r\n\r\n\t\t\t\t\t\t$cariQ = \"SELECT * FROM cari where cari_tckn='$cariID'\";\r\n\r\n\t\t\t\t\t$cariExe = $this->db->query($cariQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t\tif (count($cariExe) == 0) {\r\n\r\n\t\t\t\t\t\t$cariSoyad=null;\r\n\r\n\t\t\t\t\t\t$cariAd = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PartyName/cbc:Name');\r\n\r\n\t\t\t\t\t\tif(count($cariAd)==0) {\r\n\r\n\t\t\t\t\t\t\t$cariAd = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:Person/cbc:FirstName');\r\n\r\n\t\t\t\t\t\t\t$cariSoyad = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:Person/cbc:FamilyName');\r\n\r\n\t\t\t\t\t\t\t$cariSoyad=$cariSoyad[0];\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t$cariAdresRoom = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:Room');\r\n\r\n\t\t\t\t\t\t$cariAdresStreet = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:StreetName');\r\n\r\n\t\t\t\t\t\t$cariAdresBuilding = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:BuildingName');\r\n\r\n\t\t\t\t\t\t$cariAdresBuildingNumber = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:BuildingNumber');\r\n\r\n\t\t\t\t\t\t$cariAdresPostal = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:PostalZone');\r\n\r\n\t\t\t\t\t\t$cariAdresCitySubdivisionName = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:CitySubdivisionName');\r\n\r\n\t\t\t\t\t\t$cariAdresCityName = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PostalAddress/cbc:CityName');\r\n\r\n\t\t\t\t\t\t$cariVergiDaire = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:PartyTaxScheme/cac:TaxScheme/cbc:Name');\r\n\r\n\t\t\t\t\t\t$cariEposta = $xml->xpath('//cac:AccountingCustomerParty/cac:Party/cac:Contact/cbc:ElectronicMail');\r\n\r\n\t\t\t\t\t\t$cariTelefon = $xml->xpath('//cac:AccountingSupplierParty/cac:Party/cac:Contact/cbc:Telephone');\r\n\r\n\r\n\r\n\t\t\t\t\t\t$ws = env('AUTH_URL');\r\n\r\n\r\n\r\n\t\t\t\t\t\t$trace = true;\r\n\r\n\t\t\t\t\t\t$exceptions = false;\r\n\r\n\r\n\r\n\t\t\t\t\t\t$xml_array->REQUEST_HEADER->SESSION_ID = getSessionID();\r\n\r\n\t\t\t\t\t\t$xml_array->REQUEST_HEADER->APPLICATION_NAME = env('APPLICATION_NAME');\r\n\r\n\t\t\t\t\t\t$xml_array->USER->IDENTIFIER = $cariID; //MÃ¼kellefiyeti sorgulanacak firmanÄ±n vergi kimlik numarasÄ±\r\n\r\n\t\t\t\t\t\t$xml_array->DOCUMENT_TYPE = \"INVOICE\"; //\tMÃ¼kelleffiyet kontrol edilecek Ã¼rÃ¼n tipi. E-Fatura iÃ§in INVOICE, E-Ä°rsaliye iÃ§in DESPATCHADVICE gÃ¶nderilmelidir.\r\n\r\n\r\n\r\n\t\t\t\t\t\t$client = new SoapClient($ws, array('trace' => $trace, 'exceptions' => $exceptions));\r\n\r\n\r\n\r\n\t\t\t\t\t\t$response = $client->CheckUser($xml_array);\r\n\r\n\r\n\r\n\t\t\t\t\t\t$error_short_des = $response->ERROR_TYPE->ERROR_SHORT_DES;\r\n\r\n\t\t\t\t\t\tif (isSessionKilled($error_short_des) == 1) {//session koptu anlamÄ±na gelir, yeni session Ã¼retilip yazÄ±lmalÄ± ve tekrar denenmelidir.\r\n\r\n\t\t\t\t\t\t\tgenerateNewSession();\r\n\r\n\t\t\t\t\t\t\t$this->efaturaIceAktarKaydet();\r\n\r\n\t\t\t\t\t\t} else {//session devam eder, normal prosedÃ¼r devam et.\r\n\r\n\t\t\t\t\t\t\t$dataf = (array)$response;\r\n\r\n\t\t\t\t\t\t\t$alias_pk = $dataf[\"USER\"][0]->ALIAS;\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_ad\"] = $cariAd[0];\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_soyad\"] = $cariSoyad;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_adres\"] = $cariAdresStreet[0] . \" \" . $cariAdresBuilding[0] . \" No:\" . $cariAdresBuildingNumber[0] . \" \" . $cariAdresPostal[0] . \" \" . $cariAdresCitySubdivisionName[0] . \" / \" . $cariAdresCityName[0];\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_kodu\"] = $cariID;\r\n\r\n\t\t\t\t\t\tif (strlen($cariID) == 10)\r\n\r\n\t\t\t\t\t\t\t$dataCari[\"cari_vergiNumarasi\"] = $cariID;\r\n\r\n\t\t\t\t\t\telse\r\n\r\n\t\t\t\t\t\t\t$dataCari[\"cari_tckn\"] = $cariID;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_vergiDairesi\"] = $cariVergiDaire[0];\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_firmaEPosta\"] = $cariEposta[0];\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_firmaTelefon\"] = $cariTelefon[0];\r\n\r\n\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_bireysel\"] = 0;\r\n\r\n\t\t\t\t\t\t$dataCari[\"cari_alias_pk\"] = $alias_pk;\r\n\r\n\r\n\r\n\t\t\t\t\t\t$this->db->insert(\"cari\", $dataCari);\r\n\r\n\t\t\t\t\t\t$cari_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t} else $cari_id = $cariExe->cari_id;\r\n\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t\t#endregion cariKontrol\r\n\r\n\r\n\r\n\t\t\t\t#region satisfaturasi\r\n\r\n\r\n\r\n\t\t\t\t$dataSatis[\"satis_cariID\"] = $cari_id;\r\n\r\n\r\n\r\n\t\t\t\t$faturaTarihXml = $xml->xpath('//cbc:IssueDate');\r\n\r\n\t\t\t\t$dataSatis[\"satis_faturaTarihi\"] = $faturaTarihXml[0];\r\n\r\n\r\n\r\n\t\t\t\t$faturaSaatXml = $xml->xpath('//cbc:IssueTime');\r\n\r\n\t\t\t\t$dataSatis[\"satis_faturaSaati\"] = $faturaSaatXml[0];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t//ara toplam\r\n\r\n\t\t\t\t$araToplamXml = $xml->xpath('//cac:LegalMonetaryTotal/cbc:LineExtensionAmount');\r\n\r\n\t\t\t\t$dataSatis[\"satis_araToplam\"] = $araToplamXml[0][0];\r\n\r\n\r\n\r\n\t\t\t\t//toplam indirim\r\n\r\n\t\t\t\t$indirimTutarXml = $xml->xpath('//cac:LegalMonetaryTotal/cbc:AllowanceTotalAmount');\r\n\r\n\t\t\t\t$dataSatis[\"satis_indirimToplam\"] = $indirimTutarXml[0];\r\n\r\n\r\n\r\n\t\t\t\t$netTutarXml = $xml->xpath('//cac:LegalMonetaryTotal/cbc:TaxExclusiveAmount');\r\n\r\n\t\t\t\t$dataSatis[\"satis_netTutar\"] = $netTutarXml[0];\r\n\r\n\r\n\r\n\t\t\t\t$vergiDahilXml = $xml->xpath('//cac:LegalMonetaryTotal/cbc:TaxInclusiveAmount');\r\n\r\n\t\t\t\t$dataSatis[\"satis_vergiDahilToplam\"] = $vergiDahilXml[0];\r\n\r\n\r\n\r\n\t\t\t\t$genelToplamXml = $xml->xpath('//cac:LegalMonetaryTotal/cbc:PayableAmount');\r\n\r\n\t\t\t\t$dataSatis[\"satis_genelToplam\"] = $genelToplamXml[0];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t//fatura tipi\r\n\r\n\t\t\t\t$faturaTipXml = $xml->xpath('//cbc:InvoiceTypeCode');\r\n\r\n\t\t\t\t$faturaTip = $faturaTipXml[0];\r\n\r\n\t\t\t\tif ($faturaTip == \"SATIS\")\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_earsivfaturaTip\"] = 1;\r\n\r\n\t\t\t\telse if ($faturaTip == \"IADE\")\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_earsivfaturaTip\"] = 2;\r\n\r\n\t\t\t\telse if ($faturaTip == \"TEVKIFAT\")\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_earsivfaturaTip\"] = 3;\r\n\r\n\t\t\t\telse if ($faturaTip == \"ISTISNA\")\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_earsivfaturaTip\"] = 4;\r\n\r\n\r\n\r\n\t\t\t\t//fatura senaryosu\r\n\r\n\t\t\t\t$senaryoXml = $xml->xpath('//cbc:ProfileID');\r\n\r\n\t\t\t\t$senaryo = $senaryoXml[0];\r\n\r\n\t\t\t\t$dataSatis[\"satis_InvoiceType\"] = 1;\r\n\r\n\t\t\t\tif ($senaryo == \"TEMELFATURA\") {\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_faturaSenaryo\"] = 1;\r\n\r\n\t\t\t\t\t$ch_turu = 12;//e-fatura\r\n\r\n\t\t\t\t\t$sh_turu=3;//efatura\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse if ($senaryo == \"TICARIFATURA\") {\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_faturaSenaryo\"] = 2;\r\n\r\n\t\t\t\t\t$ch_turu = 12;//e-fatura\r\n\r\n\t\t\t\t\t$sh_turu=3;//efatura\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse if ($senaryo == \"EARSIVFATURA\") {\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_InvoiceType\"] = 2;\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_faturaSenaryo\"] = Null;\r\n\r\n\t\t\t\t\t$ch_turu=13;//e-arÅŸiv\r\n\r\n\t\t\t\t\t$sh_turu=4;//earsiv\r\n\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t//fatura para birimi\r\n\r\n\t\t\t\t$faturaParaBirimiXml = $xml->xpath('//cbc:DocumentCurrencyCode');\r\n\r\n\t\t\t\t$faturaParaBirimi = $faturaParaBirimiXml[0];\r\n\r\n\t\t\t\tif ($faturaParaBirimi == \"TRY\")\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_paraBirimi\"] = 1;\r\n\r\n\t\t\t\telse {\r\n\r\n\t\t\t\t\tif ($faturaParaBirimi == \"USD\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_paraBirimi\"] = 2;\r\n\r\n\t\t\t\t\telse if ($faturaParaBirimi == \"EUR\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_paraBirimi\"] = 3;\r\n\r\n\t\t\t\t\telse if ($faturaParaBirimi == \"GBP\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_paraBirimi\"] = 4;\r\n\r\n\t\t\t\t\t$faturaKurXml = $xml->xpath('//cac:PricingExchangeRate/cbc:CalculationRate');\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_guncelKur\"] = $faturaKurXml[0];\r\n\r\n\t\t\t\t\t$dovizCevrilmis=$dataSatis[\"satis_genelToplam\"] * $dataSatis[\"satis_guncelKur\"];\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t\t$notXML = $xml->xpath(\"//cbc:Note\");\r\n\r\n\t\t\t\tif (count($notXML) != 0)\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_aciklama\"] = $notXML[0];\r\n\r\n\r\n\r\n\t\t\t\t//vergi muafiyet\r\n\r\n\t\t\t\t$vergiMuafiyetXml = $xml->xpath('//cac:TaxTotal/cac:TaxSubtotal/cac:TaxCategory/cbc:TaxExemptionReason');\r\n\r\n\t\t\t\tif (count($vergiMuafiyetXml) != 0)\r\n\r\n\t\t\t\t\t$dataSatis[\"satis_vergiMuafiyetSebep\"] = $vergiMuafiyetXml[0];\r\n\r\n\t\t\t\telse {\r\n\r\n\t\t\t\t\t//istisna\r\n\r\n\t\t\t\t\t$istisnaKodXml = $xml->xpath('//cac:TaxTotal/cac:TaxSubtotal/cac:TaxCategory/cbc:TaxExemptionReasonCode');\r\n\r\n\t\t\t\t\tif (count($istisnaKodXml) > 0) {\r\n\r\n\t\t\t\t\t\t$kod = strval($istisnaKodXml[0]);\r\n\r\n\t\t\t\t\t\t$istisnaQ = \"SELECT istisna_id FROM istisnaKodlari where istisna_kodu='$kod'\";\r\n\r\n\t\t\t\t\t\t$istisnaExe = $this->db->query($istisnaQ)->row();\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_istisna_id\"] = $istisnaExe->istisna_id;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//earsiv gonderim sekli(kaÄŸÄ±t/elektronik)\r\n\r\n\t\t\t\t$gonderimSekliXml = \"://cac:AdditionalDocumentReference/cbc:DocumentType\";\r\n\r\n\t\t\t\tif (count($gonderimSekliXml) != 0) {\r\n\r\n\t\t\t\t\tif ($gonderimSekliXml[0] == \"KAGIT\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_earsivGonderimSekli\"] = 1;\r\n\r\n\t\t\t\t\telse if ($gonderimSekliXml[0] == \"ELEKTRONIK\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_earsivGonderimSekli\"] = 2;\r\n\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t\t//earsiv tipi(normal/internet)\r\n\r\n\t\t\t\t$gonderimSekliXml = \"://cac:AdditionalDocumentReference/cbc:DocumentType\";\r\n\r\n\t\t\t\tif (count($gonderimSekliXml) != 0) {\r\n\r\n\t\t\t\t\tif ($gonderimSekliXml[0] == \"NORMAL\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_earsivTipi\"] = 1;\r\n\r\n\t\t\t\t\telse if ($gonderimSekliXml[0] == \"INTERNET\")\r\n\r\n\t\t\t\t\t\t$dataSatis[\"satis_earsivTipi\"] = 2;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$dataSatis[\"satis_faturaDurum\"] = 1;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t$dataSatis[\"satis_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataSatis[\"satis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataSatis[\"satis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataSatis[\"satis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t$this->db->insert(\"satisFaturasi\", $dataSatis);\r\n\r\n\t\t\t\t$satis_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t#endregion\r\n\r\n\r\n\r\n\t\t\t\t#region satisfaturasistok\r\n\r\n\r\n\r\n\t\t\t\t$data[\"satisStok_satisFaturasiID\"] = $satis_id;\r\n\r\n\t\t\t\t$invoiceLine = $xml->xpath(\"//cac:InvoiceLine\");\r\n\r\n\r\n\r\n\t\t\t\t$toplamTevkifatKdv = 0;\r\n\r\n\t\t\t\t$toplamKdv = 0;\r\n\r\n\t\t\t\t$toplamIskonto = 0;\r\n\r\n\t\t\t\tfor ($i = 0; $i < count($invoiceLine); $i++) {\r\n\r\n\t\t\t\t\t$j = $i + 1;\r\n\r\n\t\t\t\t\t$stokBirimText = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cbc:InvoicedQuantity ');\r\n\r\n\t\t\t\t\t$sqlbirim = \"select stokBirim_id from stokBirimleri where stokBirim_kodu='\" . $stokBirimText[0][\"unitCode\"] . \"'\";\r\n\r\n\t\t\t\t\t$sqlBirimExe = $this->db->query($sqlbirim)->row();\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t$stokText = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:Item');\r\n\r\n\t\t\t\t\t$stokAd = $stokText[0]->children(\"cbc\", true)->Name;\r\n\r\n\t\t\t\t\t$stokQ = \"select stok_id,stok_ad,stok_kodu from stok where stok_ad like '%$stokAd%'\";\r\n\r\n\t\t\t\t\t$stokExe = $this->db->query($stokQ)->row();\r\n\r\n\t\t\t\t\tif (count($stokExe) == 0) {\r\n\r\n\t\t\t\t\t\t$stokText = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:Item/cbc:Name');\r\n\r\n\t\t\t\t\t\t$dataStok[\"stok_ad\"] = $stokText[0];\r\n\r\n\r\n\r\n\t\t\t\t\t\t$stokText = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:Item/cac:SellersItemIdentification');\r\n\r\n\t\t\t\t\t\tif (count($stokText) != 0) {\r\n\r\n\t\t\t\t\t\t\t$stokKod = $stokText[0]->children(\"cbc\", true)->ID;\r\n\r\n\r\n\r\n\t\t\t\t\t\t\t$dataStok[\"stok_kodu\"] = $stokKod[0];\r\n\r\n\t\t\t\t\t\t} else\r\n\r\n\t\t\t\t\t\t\t$dataStok[\"stok_kodu\"] = $stokText[0];\r\n\r\n\r\n\r\n\t\t\t\t\t\t$dataStok[\"stok_birimID\"] = $sqlBirimExe->stokBirim_id;\r\n\r\n\t\t\t\t\t\t$dataStok[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t\t$dataStok[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t\t$dataStok[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t\t$dataStok[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t\t$this->vt->insert(\"stok\", $dataStok);\r\n\r\n\t\t\t\t\t\t$data[\"satisStok_stokID\"] = $this->db->insert_id();\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t$data[\"satisStok_stokID\"] = $stokExe->stok_id;\r\n\r\n\t\t\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t$data[\"satisStok_miktar\"] = explode(\" \", $stokBirimText[$i])[0];\r\n\r\n\r\n\r\n\t\t\t\t\t$birimFiyat = $xml->xpath(\"//cac:InvoiceLine['.$j.']/cac:Price/cbc:PriceAmount\");\r\n\r\n\t\t\t\t\t$data[\"satisStok_birimFiyat\"] = $birimFiyat[$i][0];\r\n\r\n\r\n\r\n\t\t\t\t\t$kdvOran = $xml->xpath(\"//cac:InvoiceLine['.$j.']/cac:TaxTotal/cac:TaxSubtotal/cbc:Percent\");\r\n\r\n\t\t\t\t\t$data[\"satisStok_kdv\"] = $kdvOran[$i][0];\r\n\r\n\r\n\r\n\t\t\t\t\t$stokIndirimliFiyat = $xml->xpath('//cac:InvoiceLine/cbc:LineExtensionAmount');\r\n\r\n\t\t\t\t\t$indirimliFiyat = explode(\" \", $stokIndirimliFiyat[$i])[0];\r\n\r\n\t\t\t\t\t$data[\"satisStok_indirimliFiyat\"] = $indirimliFiyat;\r\n\r\n\r\n\r\n\t\t\t\t\t$stokKdv = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:TaxTotal/cbc:TaxAmount');\r\n\r\n\t\t\t\t\t$kdv = explode(\" \", $stokKdv[$i])[0];\r\n\r\n\t\t\t\t\t$toplamKdv += $indirimliFiyat * $kdv / 100;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t$iskonto = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:AllowanceCharge');\r\n\r\n\t\t\t\t\tif ($iskonto) {\r\n\r\n\t\t\t\t\t\t$data[\"satisStok_satirIskonto\"] = explode(\" \", $iskonto[0]->children(\"cbc\", true)->MultiplierFactorNumeric)[0];\r\n\r\n\t\t\t\t\t\t$toplamIskonto = 0;\r\n\r\n\t\t\t\t\t} else\r\n\r\n\t\t\t\t\t\t$data[\"satisStok_satirIskonto\"] = 0;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t$tevkifat = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:WithholdingTaxTotal/cac:TaxSubtotal/cac:TaxCategory/cac:TaxScheme');\r\n\r\n\t\t\t\t\tif ($tevkifat) {\r\n\r\n\r\n\r\n\t\t\t\t\t\t$tevkifatKod = explode(\" \", $tevkifat[0]->children(\"cbc\", true)->TaxTypeCode)[0];\r\n\r\n\t\t\t\t\t\t$tevkifatsql = \"select tevkifat_id from tevkifatKodlari where tevkifat_kodu='\" . $tevkifatKod . \"'\";\r\n\r\n\t\t\t\t\t\t$tevkifatExe = $this->db->query($tevkifatsql)->row();\r\n\r\n\t\t\t\t\t\t$data[\"satisStok_tevkifat_id\"] = $tevkifatExe->tevkifat_id;\r\n\r\n\r\n\r\n\t\t\t\t\t\t$fiyat = $xml->xpath('//cac:InvoiceLine[' . $j . ']/cac:WithholdingTaxTotal/cac:TaxSubtotal/cbc:TaxAmount')[0];\r\n\r\n\r\n\r\n\t\t\t\t\t\t$toplamTevkifatKdv += $fiyat;\r\n\r\n\t\t\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t$this->db->insert(\"satisFaturasiStok\", $data);\r\n\r\n\t\t\t\t\t$satisStok_id=$this->db->insert_id();\r\n\r\n\r\n\r\n\t\t\t\t\tif($faturaParaBirimi==\"TRY\")\r\n\r\n\t\t\t\t\t\t$faturaParaBirimi=\"TL\";\r\n\r\n\r\n\r\n\t\t\t\t\t$shKdv=$data[\"satisStok_indirimliFiyat\"]*$kdv/100;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_turu\"] = $sh_turu;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_cikis\"] = $data[\"satisStok_miktar\"];\r\n\r\n\t\t\t\t\t$data_sh[\"sh_cariID\"] = $cari_id;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_stokID\"] = $data[\"satisStok_stokID\"];\r\n\r\n\t\t\t\t\t$data_sh[\"sh_belgeNumarasi\"] = null;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_paraBirimi\"]=$faturaParaBirimi;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_faturaID\"] = $satis_id;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_birimFiyat\"] = $data[\"satisStok_birimFiyat\"];\r\n\r\n\t\t\t\t\t$data_sh[\"sh_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t\t\t$data_sh[\"sh_toplamKDV\"] = $shKdv;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_toplamFiyat\"] = $shKdv+$data[\"satisStok_indirimliFiyat\"];\r\n\r\n\t\t\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t\t$toplamIskontoXML = $xml->xpath('//cac:AllowanceCharge/cbc:MultiplierFactorNumeric');\r\n\r\n\t\t\t\tforeach ($toplamIskontoXML as $x)\r\n\r\n\t\t\t\t\t$toplamIskonto += $x[0];\r\n\r\n\r\n\r\n\t\t\t\t$dataSatisToplam[\"satis_kdvToplam\"] = $toplamKdv;\r\n\r\n\t\t\t\t$dataSatisToplam[\"satis_indirimToplam\"] = $toplamIskonto;\r\n\r\n\t\t\t\t$dataSatisToplam[\"satis_tevkifatToplam\"] = $toplamTevkifatKdv;\r\n\r\n\t\t\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $dataSatisToplam);\r\n\r\n\r\n\r\n\t\t\t\t#endregion\r\n\r\n\r\n\r\n\t\t\t\t#region iadefaturabilgileri\r\n\r\n\t\t\t\t//iade fatura bilgileri\r\n\r\n\t\t\t\t$iadeFatNoXml = $xml->xpath('//cac:BillingReference/cac:InvoiceDocumentReference/cbc:ID');\r\n\r\n\t\t\t\t$iadeFatTarihXml = $xml->xpath('//cac:BillingReference/cac:InvoiceDocumentReference/cbc:IssueDate');\r\n\r\n\t\t\t\t$dataIade[\"satis_id\"] = $satis_id;\r\n\r\n\t\t\t\tif (count($iadeFatNoXml) > 0) {\r\n\r\n\t\t\t\t\t$i = 0;\r\n\r\n\t\t\t\t\tforeach ($iadeFatNoXml as $item) {\r\n\r\n\t\t\t\t\t\t$dataIade[\"fatura_numarasi\"] = strval($item);\r\n\r\n\t\t\t\t\t\t$dataIade[\"tarih\"] = explode(\" \", $iadeFatTarihXml[$i])[0];\r\n\r\n\t\t\t\t\t\t$i++;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$this->db->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t#endregion\r\n\r\n\r\n\r\n\t\t\t\t#region bankaBilgileri\r\n\r\n\t\t\t\t$bankaIbanXml = $xml->xpath('//cac:PaymentMeans/cac:PayeeFinancialAccount/cbc:ID');\r\n\r\n\t\t\t\tforeach ($bankaIbanXml as $iban) {\r\n\r\n\t\t\t\t\t$dataBanka[\"ayarlarbanka_ayarID\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$bankasql = \"select * from ayarlar_banka where ayarlarbanka_ayarID=$anaHesap and ayarlarbanka_iban='$iban'\";\r\n\r\n\t\t\t\t\t$bankaexe = $this->db->query($bankasql)->row();\r\n\r\n\t\t\t\t\tif (count($bankaexe) == 0) {\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_iban\"] = $iban;\r\n\r\n\t\t\t\t\t\t$bankaAdXml = $xml->xpath('//cac:PaymentMeans/cac:PayeeFinancialAccount/cac:FinancialInstitution/cbc:Name');\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_ad\"] = $bankaAdXml[0];\r\n\r\n\t\t\t\t\t\t$bankaSubeAdXml = $xml->xpath('//cac:PaymentMeans/cac:PayeeFinancialAccount/cbc:Name');\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_subeAd\"] = $bankaSubeAdXml[0];\r\n\r\n\t\t\t\t\t\t$bankaParaBirimXml = $xml->xpath('//cac:PaymentMeans/cbc:CurrencyCode');\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_paraBirim\"] = $bankaParaBirimXml[0];\r\n\r\n\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t\t$dataBanka[\"ayarlarbanka_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t\t\t$this->db->insert(\"ayarlar_banka\", $dataBanka);\r\n\r\n\t\t\t\t\t\t$ayarbankaID = $this->db->insert_id();\r\n\r\n\t\t\t\t\t} else\r\n\r\n\t\t\t\t\t\t$ayarbankaID = $bankaexe->ayarlarbanka_ayarID;\r\n\r\n\r\n\r\n\t\t\t\t\t$datafaturabanka[\"faturabanka_ayarbankaID\"] = $ayarbankaID;\r\n\r\n\t\t\t\t\t$datafaturabanka[\"faturabanka_faturaID\"] = $satis_id;\r\n\r\n\t\t\t\t\t$this->db->insert(\"faturabanka_bilgileri\", $datafaturabanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t#endregion\r\n\r\n\r\n\r\n\t\t\t\t#region earsivinternetbilgileri\r\n\r\n\t\t\t\t$deliveryXml = $xml->xpath('//cac:Delivery/cac:CarrierParty/cac:PartyIdentification/cbc:ID');\r\n\r\n\r\n\r\n\t\t\t\tif (count($deliveryXml) != 0) {\r\n\r\n\t\t\t\t\t$vkntckn = $deliveryXml[0];\r\n\r\n\t\t\t\t\tif (strlen($vkntckn) == 10)\r\n\r\n\t\t\t\t\t\t$dataInternet[\"earsiv_tasiyan\"] = 2;\r\n\r\n\t\t\t\t\telse if (strlen($vkntckn) == 11)\r\n\r\n\t\t\t\t\t\t$dataInternet[\"earsiv_tasiyan\"] = 1;\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_tasiyanvkntckn\"] = $vkntckn;\r\n\r\n\r\n\r\n\t\t\t\t\t$deliveryUnvanXml = $xml->xpath('//cac:Delivery/cac:CarrierParty/cac:PartyName/cbc:Name');\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_tasiyanunvan\"] = $deliveryUnvanXml[0];\r\n\r\n\r\n\r\n\t\t\t\t\t$deliveryTarihXml = $xml->xpath('//cac:Delivery/cac:Despatch/cbc:ActualDespatchDate');\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_tasiyantarih\"] = $deliveryTarihXml[0];\r\n\r\n\r\n\r\n\t\t\t\t\t$dataInternet[\"satis_id\"] = $satis_id;\r\n\r\n\r\n\r\n\t\t\t\t\t$deliveryOdemeSekliXml = $xml->xpath('//cac:PaymentMeans/cbc:PaymentMeansCode');\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_odemesekli\"] = $deliveryOdemeSekliXml[0];\r\n\r\n\r\n\r\n\t\t\t\t\t$deliveryOdemeAraciXml = $xml->xpath('//cac:PaymentMeans/cbc:InstructionNote');\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_odemearaci\"] = $deliveryOdemeAraciXml[0];\r\n\r\n\r\n\r\n\t\t\t\t\t$deliveryOdemeTarihXml = $xml->xpath('//cac:PaymentMeans/cbc:PaymentDueDate');\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_odemetarihi\"] = $deliveryOdemeTarihXml[0];\r\n\r\n\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_olusturma_tarih\"] = $tarihi;\r\n\r\n\t\t\t\t\t$dataInternet[\"earsiv_olusturma_saat\"] = $saati;\r\n\r\n\t\t\t\t\t//todo:test edilecek\r\n\r\n\t\t\t\t\t//$dataInternet[\"earsiv_internetsatisbilgisi\"]=\"\";\r\n\r\n\t\t\t\t\t//$dataInternet[\"earsiv_eposta\"]=\"\";\r\n\r\n\r\n\r\n\t\t\t\t\t$this->db->insert(\"earsiv_internet_bilgileri\", $dataInternet);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t#endregion\r\n\r\n\r\n\r\n\t\t\t\t#region genelIskonto\r\n\r\n\t\t\t\t$genelIskontoSebep = $xml->xpath('//cac:AllowanceCharge/cbc:AllowanceChargeReason');\r\n\r\n\t\t\t\tforeach ($genelIskontoSebep as $item) {\r\n\r\n\t\t\t\t\t$dataIskonto[\"iskonto_satis_id\"] = $satis_id;\r\n\r\n\t\t\t\t\t$dataIskonto[\"iskonto_sebep\"] = $item;\r\n\r\n\t\t\t\t\t$genelIskontoTutar = $xml->xpath('//cac:AllowanceCharge/cbc:MultiplierFactorNumeric');\r\n\r\n\t\t\t\t\t$dataIskonto[\"iskonto_tutar\"] = $genelIskontoTutar[0];\r\n\r\n\t\t\t\t\tif ($dataIskonto[\"iskonto_tutar\"] == null) {\r\n\r\n\t\t\t\t\t\t$this->session->set_flashdata('sablon-hata', 'OK');\r\n\r\n\t\t\t\t\t\tredirect(\"fatura/taslakFaturaYukle\");\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$this->db->insert(\"genel_iskonto\", $dataIskonto);\r\n\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t#endregion\r\n\r\n\r\n\r\n\t\t\t\t//Cari Hareketleri Ekle :begin\r\n\r\n\t\t\t\t$data_ch[\"ch_belgeNumarasi\"] = null;\r\n\r\n\t\t\t\t$data_ch[\"ch_turu\"] = $ch_turu;\r\n\r\n\t\t\t\t$data_ch[\"ch_cariID\"] = $cari_id;\r\n\r\n\t\t\t\t$data_ch[\"ch_faturaID\"] = $satis_id;\r\n\r\n\t\t\t\t$data_ch[\"ch_paraBirimi\"]=$faturaParaBirimi;\r\n\r\n/*\r\n\r\n\t\t\t\tif($dovizCevrilmis)\r\n\r\n\t\t\t\t\t$data_ch[\"ch_borc\"] =$dovizCevrilmis;\r\n\r\n\t\t\t\telse*/\r\n\r\n\t\t\t\t$data_ch[\"ch_borc\"] = $genelToplamXml[0];\r\n\r\n\t\t\t\t$data_ch[\"ch_tarih\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t\t\t$data_ch[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$data_ch[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$data_ch[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$data_ch[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"cariHareketleri\", $data_ch);\r\n\r\n\t\t\t\t$ch_id = $this->db->insert_id();\r\n\r\n\t\t\t\t$datachu[\"satis_cariHareketiID\"] = $ch_id;\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $datachu);\r\n\r\n\r\n\r\n\t\t\t\tunlink($path . \"/\" . $fileName);\r\n\r\n\r\n\r\n\t\t\t\t$this->session->set_flashdata('fatura-yuklendi', 'OK');\r\n\r\n\t\t\t\tif ($dataSatis[\"satis_InvoiceType\"] == 1)\r\n\r\n\t\t\t\t\tredirect(\"fatura/efatura-giden\");\r\n\r\n\t\t\t\telse if ($dataSatis[\"satis_InvoiceType\"] == 2)\r\n\r\n\t\t\t\t\tredirect(\"fatura/earsiv-faturalari\");\r\n\r\n\r\n\r\n\t\t\t} else\r\n\r\n\t\t\t\t$this->session->set_flashdata('dosya-yuklenemedi', 'OK');\r\n\r\n\r\n\r\n\t\t} else\r\n\r\n\t\t\t$this->session->set_flashdata('dosya-yok', 'OK');\r\n\r\n\r\n\r\n\t\tredirect(\"fatura/taslakFaturaYukle\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function efatura_donustur()\r\n\r\n\t{\r\n\r\n\t\t$faturaID = $this->input->get('efatura_fatura_id');\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"satis_InvoiceType\"]=1;\r\n\r\n\t\t$data[\"satis_faturaNo\"]=null;\r\n\r\n\t\t$data[\"satis_faturaDurum\"]=1;\r\n\r\n\t\t$data[\"satis_faturaSenaryo\"]=1;\r\n\r\n\t\t$data[\"satis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"satis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"satis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"satis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->db->update(\"satisFaturasi\", $data,array('satis_id' => $faturaID));\r\n\r\n\t\t$this->session->set_flashdata('fatura_donusturuldu', 'OK');\r\n\r\n\t\tredirect(\"fatura/efaturaGiden\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function earsiv_donustur()\r\n\r\n\t{\r\n\r\n\t\t$faturaID = $this->input->get('earsiv_fatura_id');\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"satis_InvoiceType\"]=2;\r\n\r\n\t\t$data[\"satis_faturaNo\"]=null;\r\n\r\n\t\t$data[\"satis_faturaDurum\"]=1;\r\n\r\n\t\t$data[\"satis_earsivTipi\"]=1;\r\n\r\n\t\t$data[\"satis_earsivGonderimSekli\"]=1;\r\n\r\n\t\t$data[\"satis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"satis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"satis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"satis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->db->update(\"satisFaturasi\", $data,array('satis_id' => $faturaID));\r\n\r\n\t\t$this->session->set_flashdata('fatura_donusturuldu', 'OK');\r\n\r\n\t\tredirect(\"fatura/earsiv-faturalari\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function efatura_sil()\r\n\r\n\t{\r\n\r\n\t\t$id = $this->input->get('fatura_id');\r\n\r\n\t\t$del1 = \"DELETE FROM satisFaturasi WHERE satis_id=$id\";\r\n\r\n\t\t$del2 = \"DELETE FROM satisFaturasiStok WHERE satisStok_satisFaturasiID=$id\";\r\n\r\n\t\t$del3 = \"DELETE FROM stokHareketleri WHERE sh_faturaID=$id\";\r\n\r\n\t\t$del4 = \"DELETE FROM cariHareketleri WHERE ch_faturaID=$id\";\r\n\r\n\t\t$del5 = \"DELETE FROM faturabanka_bilgileri WHERE faturabanka_faturaID=$id\";\r\n\r\n\t\t$del6 = \"DELETE FROM genel_iskonto WHERE iskonto_satis_id=$id\";\r\n\r\n\t\t$del7 = \"DELETE FROM iade_fatura_numaralari WHERE satis_id=$id\";\r\n\r\n\t\t$this->db->query($del1);\r\n\r\n\t\t$this->db->query($del2);\r\n\r\n\t\t$this->db->query($del3);\r\n\r\n\t\t$this->db->query($del4);\r\n\r\n\t\t$this->db->query($del5);\r\n\r\n\t\t$this->db->query($del6);\r\n\r\n\t\t$this->db->query($del7);\r\n\r\n\t\t$this->session->set_flashdata('fatura_sil_ok', 'OK');\r\n\r\n\t\tredirect(\"fatura/efaturaGiden\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function earsiv_sil()\r\n\r\n\t{\r\n\r\n\t\t$id = $this->input->get('fatura_id');\r\n\r\n\t\t$del1 = \"DELETE FROM satisFaturasi WHERE satis_id=$id\";\r\n\r\n\t\t$del2 = \"DELETE FROM satisFaturasiStok WHERE satisStok_satisFaturasiID=$id\";\r\n\r\n\t\t$del3 = \"DELETE FROM stokHareketleri WHERE sh_faturaID=$id\";\r\n\r\n\t\t$del4 = \"DELETE FROM cariHareketleri WHERE ch_faturaID=$id\";\r\n\r\n\t\t$del5 = \"DELETE FROM faturabanka_bilgileri WHERE faturabanka_faturaID=$id\";\r\n\r\n\t\t$del6 = \"DELETE FROM genel_iskonto WHERE iskonto_satis_id=$id\";\r\n\r\n\t\t$del7 = \"DELETE FROM iade_fatura_numaralari WHERE satis_id=$id\";\r\n\r\n\t\t$del8 = \"DELETE FROM earsiv_internet_bilgileri WHERE satis_id=$id\";\r\n\r\n\t\t$this->db->query($del1);\r\n\r\n\t\t$this->db->query($del2);\r\n\r\n\t\t$this->db->query($del3);\r\n\r\n\t\t$this->db->query($del4);\r\n\r\n\t\t$this->db->query($del5);\r\n\r\n\t\t$this->db->query($del6);\r\n\r\n\t\t$this->db->query($del7);\r\n\r\n\t\t$this->db->query($del8);\r\n\r\n\t\t$this->session->set_flashdata('fatura_sil_ok', 'OK');\r\n\r\n\t\tredirect(\"fatura/earsiv-faturalari\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function proformaFaturasi($id=0)\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / Proforma FaturasÄ± OluÅŸtur\";\r\n\r\n\r\n\r\n\t\t//logekle(11,1);\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$tevkifatQ = \"SELECT * FROM tevkifatKodlari\";\r\n\r\n\t\t$tevkifatExe = $this->db->query($tevkifatQ)->result();\r\n\r\n\t\t$tevkifat = \"\";\r\n\r\n\t\tforeach ($tevkifatExe as $item) {\r\n\r\n\t\t\t$tevkifat .= \"<option value='\" . $item->tevkifat_orani . \"|\" . $item->tevkifat_id . \"'>\" . $item->tevkifat_kodu . \"-\" . $item->tevkifat_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"tevkifat\"] = $tevkifat;\r\n\r\n\r\n\r\n\t\t$istisnaQ = \"SELECT * FROM istisnaKodlari\";\r\n\r\n\t\t$istisnaExe = $this->db->query($istisnaQ)->result();\r\n\r\n\t\t$istisna = \"\";\r\n\r\n\t\tforeach ($istisnaExe as $item) {\r\n\r\n\t\t\t$istisna .= \"<option value='\" . $item->istisna_id . \"'>\" . $item->istisna_kodu . \" \" . $item->istisna_adi . \"</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"istisna\"] = $istisna;\r\n\r\n\r\n\r\n\t\t$sqlBanka = \"select * from ayarlar_banka where ayarlarbanka_olusturanAnaHesap=\" . $anaHesap . \" \";\r\n\r\n\t\t$data[\"faturabanka\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\r\n\r\n\t\t//dÃ¼zenleme iÃ§in veritabanÄ±ndan verilerin Ã§ekilmesi\r\n\r\n\t\tif ($id != 0) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Fatura / Proforma Fatura DÃ¼zenle\";\r\n\r\n\t\t\t$sql = \"select * from proformaFaturasi where proforma_id=\" . $id;\r\n\r\n\t\t\t$faturaDetay = $this->db->query($sql)->row();\r\n\r\n\t\t\t$data[\"faturaDetay\"]=$faturaDetay ;\r\n\r\n\r\n\r\n\t\t\t$sqlEtiket=\"select * from etiketler where etiket_id=\".$faturaDetay->proforma_faturaEtiketID;\r\n\r\n\t\t\t$exeEtiket=$this->db->query($sqlEtiket)->row();\r\n\r\n\t\t\t$data[\"etiket\"]=$exeEtiket;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$sqlStok = \"select * from proformaFaturasiStok inner join stok on proformaStok_stokID=stok_id inner join stokBirimleri on stokBirim_id=stok_birimID where proformaStok_proformaFaturasiID=\" . $id;\r\n\r\n\t\t\t$data[\"stok\"] = $this->db->query($sqlStok)->result();\r\n\r\n\r\n\r\n\t\t\t$sqlGenelIskonto = \"select * from genel_iskonto inner join proformaFaturasi on iskonto_satis_id=proforma_id where proforma_id=\" . $id;\r\n\r\n\t\t\t$data[\"genelIskonto\"] = $this->db->query($sqlGenelIskonto)->result();\r\n\r\n\r\n\r\n\t\t\t$sqlIade = \"select * from iade_fatura_numaralari inner join proformaFaturasi on iade_fatura_numaralari.satis_id=proformaFaturasi.proforma_id where proformaFaturasi.proforma_id=\" . $id;\r\n\r\n\t\t\t$data[\"iadeFaturalari\"] = $this->db->query($sqlIade)->result();\r\n\r\n\r\n\r\n\t\t\t$sqlCari = \"select * from proformaFaturasi inner join cari on proforma_cariID=cari_id where proforma_cariID=\" . $data[\"faturaDetay\"]->proforma_cariID;\r\n\r\n\t\t\t$data[\"cari\"] = $this->db->query($sqlCari)->row();\r\n\r\n\t\t\tif ($data[\"cari\"]->cari_vergiNumarasi != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_vergiNumarasi;\r\n\r\n\t\t\telse if ($data[\"cari\"]->cari_tckn != null)\r\n\r\n\t\t\t\t$numara = $data[\"cari\"]->cari_tckn;\r\n\r\n\t\t\t$data[\"cari_value\"] = $numara . \" - \" . $data[\"cari\"]->cari_ad . \" \" . $data[\"cari\"]->cari_soyad;\r\n\r\n\r\n\r\n\t\t\t$sqlBanka = \"select * from faturabanka_bilgileri inner join ayarlar_banka on faturabanka_ayarbankaID=ayarlarbanka_id where faturabanka_faturaID=\" . $id . \" \";\r\n\r\n\t\t\t$data[\"faturabankaDuzenle\"] = $this->db->query($sqlBanka)->result();\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\t\t$iller = $this->db->get('iller');\r\n\r\n\r\n\r\n\t\tif ($iller->num_rows() > 0) {\r\n\r\n\t\t\t$data['_iller'] = $iller->result();\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$data['_iller'] = false;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$birimler = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$option =\"\";\r\n\r\n\t\tforeach ($birimler as $birim)\r\n\r\n\t\t{\r\n\r\n\t\t\t$option.=\"<option value='$birim->stokBirim_id'>$birim->stokBirim_ad</option>\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"birimler\"]=$option;\r\n\r\n\t\t$this->load->view(\"fatura/proforma-faturasi\",$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function proformaFaturasiOlustur(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = postval(\"geneltopHidden\");\r\n\r\n\t\t$indirimToplamHidden = postval(\"indirimtopHidden\");\r\n\r\n\t\t$tevkifatToplamHidden = postval(\"tevkifattopHidden\");\r\n\r\n\t\t$vergidahilHidden = postval(\"vergidahilHidden\");\r\n\r\n\r\n\r\n\t\t$istisna_sebebi = postval(\"istisna_sebebi\");\r\n\r\n\t\t$vergiMuafiyet_sebep = postval(\"vergiMuafiyet_sebep\");\r\n\r\n\r\n\r\n\t\tif (postval(\"proforma_paraBirimi\") == 1) {\r\n\r\n\t\t\t$guncelKur = NULL;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$guncelKur = postval(\"proforma_guncelKur\");\r\n\r\n\t\t\t$dovizCevrilmis = $genelToplamHidden * $guncelKur;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"proforma_durum\"] = 0;\r\n\r\n\t\t$data[\"proforma_faturaTipi\"] = postval(\"satis_faturaTip\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$proforma_etiketID=postval(\"etiket_id\");\r\n\r\n\r\n\r\n\t\tif(empty($proforma_etiketID))\r\n\r\n\t\t{\r\n\r\n\t\t\t$proforma_faturaEtiketID=postval(\"proforma_faturaEtiketID\");\r\n\r\n\t\t\tif(!empty($proforma_faturaEtiketID))\r\n\r\n\t\t\t{\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_adi\"]=$proforma_faturaEtiketID;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t$dataEtiket[\"etiket_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t\t$this->db->insert(\"etiketler\",$dataEtiket);\r\n\r\n\t\t\t\t$proforma_etiketID=$this->db->insert_id();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"proforma_faturaEtiketID\"]=$proforma_etiketID;\r\n\r\n\r\n\r\n\t\t$faturaNo=postval(\"proforma_faturaNo\");\r\n\r\n\t\t$faturaTarihi=postval(\"proforma_faturaTarihi\");\r\n\r\n\t\t$faturaSaati=postval(\"proforma_faturaSaati\");\r\n\r\n\t\t$paraBirimi=postval(\"proforma_paraBirimi\");\r\n\r\n\r\n\r\n\t\t$data[\"proforma_cariID\"] = postval(\"proforma_cariID\");\r\n\r\n\t\t$data[\"proforma_paraBirimi\"] = $paraBirimi;\r\n\r\n\t\t$data[\"proforma_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"proforma_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"proforma_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"proforma_faturaTarihi\"] = $faturaTarihi;\r\n\r\n\t\t$data[\"proforma_faturaSaati\"] = $faturaSaati;\r\n\r\n\t\t$data[\"proforma_aciklama\"] = postval(\"proforma_aciklama\");\r\n\r\n\t\t$data[\"proforma_araToplam\"] = postval(\"aratopHidden\");\r\n\r\n\t\t$data[\"proforma_kdvToplam\"] = postval(\"kdvtopHidden\");\r\n\r\n\t\t$data[\"proforma_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"proforma_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"proforma_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"proforma_netTutar\"] = postval(\"netTutarInput\");\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"proforma_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"proforma_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"proforma_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"proforma_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"proforma_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"proforma_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"proforma_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$cariKontrolQ = \"SELECT * FROM cari WHERE (cari_kodu = '$cariKodu') AND cari_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t$cariKontrol = $this->db->query($cariKontrolQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$cariKontrol) {\r\n\r\n\t\t\t$this->session->set_flashdata('cari_hatali', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$faturaVarmiQ = \"SELECT * FROM proformaFaturasi WHERE  proforma_faturaNo = '$faturaNo' AND proforma_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$faturaVarmiExe = $this->db->query($faturaVarmiQ)->result();\r\n\r\n\r\n\r\n\t\tif ($faturaVarmiExe) {\r\n\r\n\t\t\t$this->session->set_flashdata('fatura_mukerrer', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"proformaFaturasi\", $data);\r\n\r\n\t\t$proforma_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t$bankaCheck = postval(\"bankaCheck\");\r\n\r\n\t\tif ($bankaCheck == 1) {\r\n\r\n\t\t\t$bankaCount = postval(\"bankaCount\");\r\n\r\n\t\t\techo $bankaCount;\r\n\r\n\t\t\tif ($bankaCount != 0) {//banka bilgileri\r\n\r\n\t\t\t\t$ayarlarbanka_id = postval(\"ayarlarbanka_id\");\r\n\r\n\t\t\t\t$dataBanka[\"faturabanka_faturaID\"] = $proforma_id;\r\n\r\n\t\t\t\tfor ($i = 0; $i < $bankaCount; $i++) {\r\n\r\n\t\t\t\t\t$dataBanka[\"faturabanka_ayarbankaID\"] = $ayarlarbanka_id[$i];\r\n\r\n\t\t\t\t\t$this->vt->insert(\"faturabanka_bilgileri\", $dataBanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$iade_count = postval(\"iade_count\");\r\n\r\n\t\tif ($iade_count != 0) {//arÅŸiv iade\r\n\r\n\r\n\r\n\t\t\t$iadenumara = postval(\"iadenumara\");\r\n\r\n\t\t\t$iadetarih = postval(\"iadetarih\");\r\n\r\n\t\t\t$dataIade[\"satis_id\"] = $proforma_id;\r\n\r\n\t\t\t//iade_fatura_numaralari (e-arÅŸiv iade fatura numaralarÄ±)\r\n\r\n\t\t\tfor ($i = 0; $i < $iade_count; $i++) {\r\n\r\n\t\t\t\t$dataIade[\"fatura_numarasi\"] = $iadenumara[$i];\r\n\r\n\t\t\t\t$dataIade[\"tarih\"] = $iadetarih[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$indirim_count = postval(\"indirim_count\");\r\n\r\n\t\tif ($indirim_count != 0) {//genel iskonto\r\n\r\n\t\t\t$indirimsebep = postval(\"indirimsebep\");\r\n\r\n\t\t\t$indirimtutar = postval(\"indirimtutar\");\r\n\r\n\t\t\t$dataIndirim[\"iskonto_satis_id\"] = $proforma_id;\r\n\r\n\t\t\t//genel_iskonto (faturaya yapÄ±lan genel indirimler)\r\n\r\n\t\t\tfor ($i = 0; $i < $indirim_count; $i++) {\r\n\r\n\t\t\t\tif ($indirimsebep[$i] == 0)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Ä°skonto\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 1)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Nakit Ä°skontosu\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 2)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"DiÄŸer\";\r\n\r\n\r\n\r\n\t\t\t\t$dataIndirim[\"iskonto_tutar\"] = $indirimtutar[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"genel_iskonto\", $dataIndirim);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//proforma faturasÄ± stok\r\n\r\n\t\t$dataStok[\"proformaStok_proformaFaturasiID\"] = $proforma_id;\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$stokadi=postval(\"stokadi\");\r\n\r\n\t\t$stokkodu=postval(\"stokkodu\");\r\n\r\n\t\t$barkod=postval(\"barkod\");\r\n\r\n\t\t$birim=postval(\"birim\");\r\n\r\n\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$toplam = postval(\"toplamHidden\");\r\n\r\n\r\n\r\n\t\t$indirimtutari = postval(\"indirimyuzde\");\r\n\r\n\t\t$tevkifatInput = postval(\"tevkifat\");\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\t\t\t$stokidsi=$stokid[$i];\r\n\r\n\t\t\tif(empty($stokid[$i])) {\r\n\r\n\t\t\t\t$dataStokX[\"stok_kodu\"] = $stokkodu[$i];\r\n\r\n\t\t\t\t$stokQ=\"select * from stok where stok_kodu='\".$dataStokX[\"stok_kodu\"].\"' and stok_kodu!=''\";\r\n\r\n\t\t\t\t$stokExe=$this->db->query($stokQ)->row();\r\n\r\n\t\t\t\tif($stokExe)\r\n\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$stokidsi=$stokExe->stok_id;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_ad\"] = $stokadi[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_barkod\"] = $barkod[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisFiyati\"] = $birimfiyat[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisFiyati\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisKDV\"] = $kdv[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisKDV\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_birimID\"] = $birim[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t$this->vt->insert(\"stok\", $dataStokX);\r\n\r\n\t\t\t\t\t$stokidsi = $this->db->insert_id();\r\n\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $toplam[$i] * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $toplam[$i] + $yeniKDVHesap;\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$tevkifat = explode(\"|\", $tevkifatInput[$i]);\r\n\r\n\r\n\r\n\t\t\t$dataStok[\"proformaStok_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$dataStok[\"proformaStok_miktar\"] = $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_fiyatMiktar\"] = $birimfiyat[$i] * $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_indirimTutari\"] = $indirimtutari[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_satirIskonto\"] = $birimfiyat[$i] * $miktar[$i] * $indirimtutari[$i] / 100;\r\n\r\n\t\t\t$dataStok[\"proformaStok_indirimlifiyat\"] = $toplam[$i];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif ($tevkifat[0] == 0)\r\n\r\n\t\t\t\t$dataStok[\"proformaStok_tevkifat_id\"] = 0;\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$dataStok[\"proformaStok_tevkifat_id\"] = $tevkifat[1];\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"proformaFaturasiStok\", $dataStok);\r\n\r\n\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_ok', 'OK');\r\n\r\n\t\tlogekle(11, 2);\r\n\r\n\t\tredirect(\"fatura/proforma-listesi\");\r\n\r\n\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function proformaListesi()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"] = \"Fatura / Proforma Fatura Listesi\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$faturaNo = $this->input->get('faturaNo');\r\n\r\n\t\t$etiket = $this->input->get('etiket');\r\n\r\n\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //kÃ¼Ã§Ã¼k tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //bÃ¼yÃ¼k tarih\r\n\r\n\r\n\r\n\t\t$siralama = $this->input->get('siralama');\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif ($sayfa) {\r\n\r\n\t\t\t$pagem = ($page - 1) * $limit;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$pagem = 0;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif ((isset($faturaNo) && !empty($faturaNo)) || (isset($etiket) && !empty($etiket)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama))) {\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif (!empty($tarihGet)) {\r\n\r\n\t\t\t\t$sorgu1 = \"AND proforma_faturaTarihi BETWEEN '$tarih1' AND '$tarih2'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu1 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($etiket)) {\r\n\r\n\t\t\t\t$sorgu2 = \"AND proforma_faturaEtiketID = '$etiket'\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sorgu2 = \"\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\tif (!empty($siralama)) {\r\n\r\n\t\t\t\tif ($siralama == 1) {//Tarih bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(proforma_faturaTarihi) DESC\";\r\n\r\n\t\t\t\t} else if ($siralama == 2) {//Tarih kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY DATE(proforma_faturaTarihi) ASC\";\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$sira = \"ORDER BY proforma_id DESC\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$sira = \"ORDER BY proforma_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM proformaFaturasi WHERE proforma_olusturanAnaHesap = '$anaHesap' AND proforma_faturaNo LIKE '%$faturaNo%'  \" . $sorgu1 . \" \".$sorgu2;\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM proformaFaturasi WHERE proforma_olusturanAnaHesap = '$anaHesap' AND proforma_faturaNo LIKE '%$faturaNo%' \" . $sorgu1 . \" \".$sorgu2.\" \" . $sira . \" LIMIT $pagem,$limit\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM proformaFaturasi WHERE proforma_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM proformaFaturasi WHERE proforma_olusturanAnaHesap = '$anaHesap' ORDER BY proforma_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/fatura/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"proformaFaturasi\"] = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view(\"fatura/proforma-listesi\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic  function proformaFaturasiGuncelle()\r\n\r\n\t{\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\r\n\r\n\t\t$proforma_id = postval(\"proforma_id\");\r\n\r\n\r\n\r\n\t\t$faturaNo = postval(\"proforma_faturaNo\");\r\n\r\n\r\n\r\n\t\t$cariKodu = postval(\"cari_kodu\");\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = postval(\"geneltopHidden\");\r\n\r\n\t\t$indirimToplamHidden = postval(\"indirimtopHidden\");\r\n\r\n\t\t$tevkifatToplamHidden = postval(\"tevkifattopHidden\");\r\n\r\n\t\t$vergidahilHidden = postval(\"vergidahilHidden\");\r\n\r\n\r\n\r\n\t\t$istisna_sebebi = postval(\"istisna_sebebi\");\r\n\r\n\t\t$vergiMuafiyet_sebep = postval(\"vergiMuafiyet_sebep\");\r\n\r\n\r\n\r\n\t\tif (postval(\"proforma_paraBirimi\") == 1) {\r\n\r\n\t\t\t$guncelKur = NULL;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$guncelKur = postval(\"proforma_guncelKur\");\r\n\r\n\t\t\t$dovizCevrilmis = $genelToplamHidden * $guncelKur;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"proforma_faturaTipi\"] = postval(\"proforma_faturaTip\");\r\n\r\n\r\n\r\n\r\n\r\n\t\t$proforma_etiketID=postval(\"etiket_id\");\r\n\r\n\t\t$data[\"proforma_faturaEtiketID\"] = $proforma_etiketID;\r\n\r\n\r\n\r\n\t\t$paraBirimi=postval(\"proforma_paraBirimi\");\r\n\r\n\r\n\r\n\t\t$data[\"proforma_cariID\"] = postval(\"proforma_cariID\");\r\n\r\n\r\n\r\n\t\t$data[\"proforma_paraBirimi\"] = $paraBirimi;\r\n\r\n\t\t$data[\"proforma_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"proforma_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"proforma_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"proforma_faturaTarihi\"] = postval(\"proforma_faturaTarihi\");\r\n\r\n\t\t$data[\"proforma_faturaSaati\"] = postval(\"proforma_faturaSaati\");\r\n\r\n\t\t$data[\"proforma_aciklama\"] = postval(\"proforma_aciklama\");\r\n\r\n\t\t$data[\"proforma_araToplam\"] = postval(\"aratopHidden\");\r\n\r\n\t\t$data[\"proforma_kdvToplam\"] = postval(\"kdvtopHidden\");\r\n\r\n\t\t$data[\"proforma_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"proforma_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"proforma_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"proforma_netTutar\"] = postval(\"netTutarInput\");\r\n\r\n\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"proforma_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"proforma_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"proforma_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"proforma_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"proforma_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"proforma_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"proforma_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$cariKontrolQ = \"SELECT * FROM cari WHERE (cari_kodu = '$cariKodu') AND cari_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$cariKontrol = $this->db->query($cariKontrolQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$cariKontrol) {\r\n\r\n\t\t\t$this->session->set_flashdata('cari_hatali', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$faturaVarmiQ = \"SELECT * FROM proformaFaturasi WHERE proforma_faturaNo='$' and proforma_olusturanAnaHesap = '$anaHesap' \";\r\n\r\n\t\t$faturaVarmiExe = $this->db->query($faturaVarmiQ)->row();\r\n\r\n\r\n\r\n\t\t/*if ($faturaVarmiExe) {\r\n\r\n\t\t\t$this->session->set_flashdata('fatura_mukerrer', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n*/\r\n\r\n\t\t//if ($faturaVarmiExe)\r\n\r\n\t\t\t$this->vt->update('proformaFaturasi', array('proforma_id' => $proforma_id), $data);\r\n\r\n\r\n\r\n\t\t//iade\r\n\r\n\t\t$iade_count = postval(\"iade_count\");\r\n\r\n\r\n\r\n\t\t$this->vt->del(\"iade_fatura_numaralari\", \"satis_id\", $proforma_id);\r\n\r\n\t\tif ($iade_count != 0) {// iade\r\n\r\n\t\t\t$iadenumara = postval(\"iadenumara\");\r\n\r\n\t\t\t$iadetarih = postval(\"iadetarih\");\r\n\r\n\t\t\t$dataIade[\"satis_id\"] = $proforma_id;\r\n\r\n\t\t\t//iade_fatura_numaralari (e-arÅŸiv iade fatura numaralarÄ±)\r\n\r\n\t\t\tfor ($i = 0; $i < $iade_count; $i++) {\r\n\r\n\t\t\t\t$dataIade[\"fatura_numarasi\"] = $iadenumara[$i];\r\n\r\n\t\t\t\t$dataIade[\"tarih\"] = $iadetarih[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"iade_fatura_numaralari\", $dataIade);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t//indirim\r\n\r\n\t\t$indirim_count = postval(\"indirim_count\");\r\n\r\n\t\t$this->vt->del(\"genel_iskonto\", \"iskonto_satis_id\", $proforma_id);\r\n\r\n\t\tif ($indirim_count != 0) {//genel iskonto\r\n\r\n\t\t\t$indirimsebep = postval(\"indirimsebep\");\r\n\r\n\t\t\t$indirimtutar = postval(\"indirimtutar\");\r\n\r\n\t\t\t$dataIndirim[\"iskonto_satis_id\"] = $proforma_id;\r\n\r\n\t\t\t//genel_iskonto (faturaya yapÄ±lan genel indirimler)\r\n\r\n\t\t\tfor ($i = 0; $i < $indirim_count; $i++) {\r\n\r\n\t\t\t\tif ($indirimsebep[$i] == 0)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Ä°skonto\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 1)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"Nakit Ä°skontosu\";\r\n\r\n\t\t\t\telse if ($indirimsebep[$i] == 2)\r\n\r\n\t\t\t\t\t$dataIndirim[\"iskonto_sebep\"] = \"DiÄŸer\";\r\n\r\n\r\n\r\n\t\t\t\t$dataIndirim[\"iskonto_tutar\"] = $indirimtutar[$i];\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"genel_iskonto\", $dataIndirim);\r\n\r\n\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$bankaCheck = postval(\"bankaCheck\");\r\n\r\n\t\t$this->vt->del(\"faturabanka_bilgileri\", \"faturabanka_faturaID\", $proforma_id);\r\n\r\n\t\tif ($bankaCheck == 1) {\r\n\r\n\t\t\t$bankaCount = postval(\"bankaCount\");\r\n\r\n\t\t\techo $bankaCount;\r\n\r\n\t\t\tif ($bankaCount != 0) {//banka bilgileri\r\n\r\n\t\t\t\t$ayarlarbanka_id = postval(\"ayarlarbanka_id\");\r\n\r\n\t\t\t\t$dataBanka[\"faturabanka_faturaID\"] = $proforma_id;\r\n\r\n\t\t\t\tfor ($i = 0; $i < $bankaCount; $i++) {\r\n\r\n\t\t\t\t\t$dataBanka[\"faturabanka_ayarbankaID\"] = $ayarlarbanka_id[$i];\r\n\r\n\t\t\t\t\tprint_r($dataBanka);\r\n\r\n\t\t\t\t\t$this->vt->insert(\"faturabanka_bilgileri\", $dataBanka);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\t\t$dataStok[\"proformaStok_proformaFaturasiID\"] = $proforma_id;\r\n\r\n\t\t$stokid = postval(\"stokid\");\r\n\r\n\t\t$kacAdetStok = count($stokid);\r\n\r\n\r\n\r\n\t\t$proformaFaturasiStok_id = postval(\"proformaFaturasiStok_id\");\r\n\r\n\r\n\r\n\t\t$stoklarQ = \"SELECT * FROM proformaFaturasiStok WHERE proformaStok_proformaFaturasiID = '$proforma_id'\";\r\n\r\n\t\t$stoklarExe = $this->db->query($stoklarQ)->result();\r\n\r\n\r\n\r\n\t\t$newArray = [];\r\n\r\n\t\tforeach ($stoklarExe as $sexe) {\r\n\r\n\t\t\t$newArray[] = $sexe->proformaStok_id;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$diff = array_diff($newArray, $proformaFaturasiStok_id);\r\n\r\n\r\n\r\n\t\tif (!empty($diff)) {\r\n\r\n\t\t\tforeach ($diff as $key => $value) {\r\n\r\n\t\t\t\t$this->vt->del(\"proformaFaturasiStok\", \"proformaStok_id\", $value);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$miktar = postval(\"miktar\");\r\n\r\n\t\t$birimfiyat = postval(\"birimfiyat\");\r\n\r\n\t\t$kdv = postval(\"kdv\");\r\n\r\n\t\t$stokadi = postval(\"stokadi\");\r\n\r\n\t\t$stokkodu = postval(\"stokkodu\");\r\n\r\n\t\t$barkod= postval(\"barkod\");\r\n\r\n\t\t$birim= postval(\"birim\");\r\n\r\n\t\t$toplam = postval(\"toplamHidden\");\r\n\r\n\t\t$indirimtutari = postval(\"indirimyuzde\");\r\n\r\n\t\t$tevkifatInput = postval(\"tevkifat\");\r\n\r\n\r\n\r\n\r\n\r\n\t\tfor ($i = 0; $i < $kacAdetStok; $i++) {\r\n\r\n\t\t\t$stokidsi=$stokid[$i];\r\n\r\n\t\t\tif(empty($stokid[$i])) {\r\n\r\n\t\t\t\t$dataStokX[\"stok_kodu\"] = $stokkodu[$i];\r\n\r\n\t\t\t\t$stokQ = \"select * from stok where stok_kodu='\" . $dataStokX[\"stok_kodu\"] . \"'\";\r\n\r\n\t\t\t\t$stokExe = $this->db->query($stokQ)->row();\r\n\r\n\t\t\t\tif ($stokExe) {\r\n\r\n\t\t\t\t\t$stokidsi = $stokExe->stok_id;\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_ad\"] = $stokadi[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_barkod\"] = $barkod[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisFiyati\"] = $birimfiyat[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisFiyati\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_satisKDV\"] = $kdv[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_alisKDV\"] = 0;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_birimID\"] = $birim[$i];\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t\t\t$dataStokX[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t\t\t$this->vt->insert(\"stok\", $dataStokX);\r\n\r\n\t\t\t\t\t$stokidsi = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $toplam[$i] * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $toplam[$i] + $yeniKDVHesap;\r\n\r\n\r\n\r\n\t\t\t$tevkifat = explode(\"|\", $tevkifatInput[$i]);\r\n\r\n\t\t\t$dataStok[\"proformaStok_stokID\"] = $stokidsi;\r\n\r\n\t\t\t$dataStok[\"proformaStok_miktar\"] = $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_birimFiyat\"] = $birimfiyat[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_fiyatMiktar\"] = $birimfiyat[$i] * $miktar[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_kdv\"] = $kdv[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_indirimTutari\"] = $indirimtutari[$i];\r\n\r\n\t\t\t$dataStok[\"proformaStok_satirIskonto\"] = $birimfiyat[$i] * $miktar[$i] * $indirimtutari[$i] / 100;\r\n\r\n\t\t\t$dataStok[\"proformaStok_indirimlifiyat\"] = $toplam[$i];\r\n\r\n\r\n\r\n\t\t\tif ($tevkifat[0] == 0)\r\n\r\n\t\t\t\t$dataStok[\"proformaStok_tevkifat_id\"] = 0;\r\n\r\n\t\t\telse\r\n\r\n\t\t\t\t$dataStok[\"proformaStok_tevkifat_id\"] = $tevkifat[1];\r\n\r\n\r\n\r\n\t\t\tif (!empty($proformaFaturasiStok_id[$i])) {\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->update('proformaFaturasiStok', array('proformaStok_id' => $proformaFaturasiStok_id[$i]), $dataStok);\r\n\r\n\t\t\t} else {\r\n\r\n\r\n\r\n\t\t\t\t$this->vt->insert(\"proformaFaturasiStok\", $dataStok);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_updt_ok', 'OK');\r\n\r\n\t\tlogekle(11, 3);\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function proformaOnayRed()\r\n\r\n\t{\r\n\r\n\t\t$id = postval('fatura_onayRed_id');\r\n\r\n\t\t$secenek = postval('fatura_onayRed_secenek');\r\n\r\n\t\t$sql=\"update proformaFaturasi set proforma_durum=$secenek where proforma_id=$id\";\r\n\r\n\t\t$this->db->query($sql);\r\n\r\n\t\tredirect(\"fatura/proformaListesi\");\r\n\r\n\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function proforma_fatura_sil()\r\n\r\n\t{\r\n\r\n\t\t$id = $this->input->get('fatura_id');\r\n\r\n\t\t$del1 = \"DELETE FROM proformaFaturasi WHERE proforma_id=$id\";\r\n\r\n\t\t$del2 = \"DELETE FROM proformaFaturasiStok WHERE proformaStok_proformaFaturasiID=$id\";\r\n\r\n\t\t$this->db->query($del1);\r\n\r\n\t\t$this->db->query($del2);\r\n\r\n\t\t$this->session->set_flashdata('fatura_sil_ok', 'OK');\r\n\r\n\t\tredirect(\"fatura/proformaListesi\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function proformaFaturalastir()\r\n\r\n\t{\r\n\r\n\r\n\r\n\t\t$faturaID = $this->input->get('faturalastir_id');\r\n\r\n\r\n\r\n\t\t$sql=\"select * from proformaFaturasi where proforma_id=$faturaID\";\r\n\r\n\t\t$proformaDetay=$this->db->query($sql)->row();\r\n\r\n\r\n\r\n\t\t$sqlStok=\"select * from proformaFaturasiStok where proformaStok_proformaFaturasiID=$faturaID\";\r\n\r\n\t\t$proformaStok=$this->db->query($sqlStok)->result();\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$ch_turu=2;\r\n\r\n\r\n\r\n\t\t$satis_faturaTarihi = $proformaDetay->proforma_faturaTarihi;\r\n\r\n\t\t$faturaNo = $proformaDetay->proforma_faturaNo;\r\n\r\n\r\n\r\n\r\n\r\n\t\t$genelToplamHidden = $proformaDetay->proforma_genelToplam;\r\n\r\n\t\t$indirimToplamHidden =  $proformaDetay->proforma_indirimToplam;\r\n\r\n\t\t$tevkifatToplamHidden =  $proformaDetay->proforma_tevkifatToplam;\r\n\r\n\t\t$vergidahilHidden =  $proformaDetay->proforma_vergiDahilToplam;\r\n\r\n\r\n\r\n\r\n\r\n\t\t$istisna_sebebi =  $proformaDetay->proforma_istisna_id;\r\n\r\n\t\t$vergiMuafiyet_sebep =  $proformaDetay->proforma_vergiMuafiyetSebep;\r\n\r\n\r\n\r\n\r\n\r\n\t\t$guncelKur =  $proformaDetay->proforma_guncelKur;\r\n\r\n\t\t$dovizCevrilmis =  $proformaDetay->proforma_dovizCevrilmis;\r\n\r\n\r\n\r\n\t\t$data[\"satis_faturaDurum\"] = 2;\r\n\r\n\t\t$data[\"satis_earsivfaturaTip\"] =  $proformaDetay->proforma_faturaTipi;\r\n\r\n\r\n\r\n\t\t$paraBirimi= $proformaDetay->proforma_paraBirimi;\r\n\r\n\r\n\r\n\t\t$data[\"satis_cariID\"] = $proformaDetay->proforma_cariID;\r\n\r\n\t\t$data[\"satis_paraBirimi\"] = $paraBirimi;\r\n\r\n\t\t$data[\"satis_guncelKur\"] = $guncelKur;\r\n\r\n\t\t$data[\"satis_dovizCevrilmis\"] = $dovizCevrilmis;\r\n\r\n\t\t$data[\"satis_irsaliyeNo\"] =  NULL;\r\n\r\n\t\t$data[\"satis_irsaliyeTarihi\"] = NULL;\r\n\r\n\t\t$data[\"satis_faturaNo\"] = $faturaNo;\r\n\r\n\t\t$data[\"satis_faturaTarihi\"] = $satis_faturaTarihi;\r\n\r\n\t\t$data[\"satis_faturaSaati\"] =  $proformaDetay->proforma_faturaSaati;\r\n\r\n\t\t$data[\"satis_aciklama\"] = $proformaDetay->proforma_aciklama;\r\n\r\n\t\t$data[\"satis_araToplam\"] = $proformaDetay->proforma_araToplam;\r\n\r\n\t\t$data[\"satis_kdvToplam\"] = $proformaDetay->proforma_kdvToplam;\r\n\r\n\t\t$data[\"satis_genelToplam\"] = $genelToplamHidden;\r\n\r\n\t\t$data[\"satis_vergiDahilToplam\"] = $vergidahilHidden;\r\n\r\n\t\t$data[\"satis_indirimToplam\"] = $indirimToplamHidden;\r\n\r\n\t\t$data[\"satis_netTutar\"] =  $proformaDetay->proforma_netTutar;\r\n\r\n\r\n\r\n\t\tif ($tevkifatToplamHidden != null)\r\n\r\n\t\t\t$data[\"satis_tevkifatToplam\"] = $tevkifatToplamHidden;\r\n\r\n\t\tif ($istisna_sebebi != null)\r\n\r\n\t\t\t$data[\"satis_istisna_id\"] = $istisna_sebebi;\r\n\r\n\r\n\r\n\t\tif ($vergiMuafiyet_sebep != null)\r\n\r\n\t\t\t$data[\"satis_vergiMuafiyetSebep\"] = $vergiMuafiyet_sebep;\r\n\r\n\r\n\r\n\t\t$data[\"satis_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"satis_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"satis_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"satis_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$faturaVarmiQ = \"SELECT * FROM satisFat\r\n\r\n    urasi WHERE  (satis_faturaNo = '$faturaNo') AND satis_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$faturaVarmiExe = $this->db->query($faturaVarmiQ)->result();\r\n\r\n\r\n\r\n\t\tif ($faturaVarmiExe) {\r\n\r\n\t\t\t$this->session->set_flashdata('fatura_mukerrer', 'OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"satisFaturasi\", $data);\r\n\r\n\t\t$satis_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\t\t$sqlbanka=\"update faturabanka_bilgileri set faturabanka_faturaID=$satis_id where faturabanka_faturaID=$faturaID\";\r\n\r\n\t\t$this->db->query($sqlbanka);\r\n\r\n\r\n\r\n\t\t$sqliade=\"update iade_fatura_numaralari set satis_id=$satis_id where satis_id=$faturaID\";\r\n\r\n\t\t$this->db->query($sqliade);\r\n\r\n\r\n\r\n\t\t$sqlindirim=\"update genel_iskonto set iskonto_satis_id=$satis_id where iskonto_satis_id=$faturaID\";\r\n\r\n\t\t$this->db->query($sqlindirim);\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\t\t$dataStok[\"satisStok_satisFaturasiID\"] = $satis_id;\r\n\r\n\r\n\r\n\t\tforeach ($proformaStok as $item) {\r\n\r\n\r\n\r\n\t\t\tif ($kdv[$i] == 0) {\r\n\r\n\t\t\t\t$yeniKDV = 0;\r\n\r\n\t\t\t} else if ($kdv[$i] == 1) {\r\n\r\n\t\t\t\t$yeniKDV = 0.01;\r\n\r\n\t\t\t} else if ($kdv[$i] == 8) {\r\n\r\n\t\t\t\t$yeniKDV = 0.08;\r\n\r\n\t\t\t} else if ($kdv[$i] == 18) {\r\n\r\n\t\t\t\t$yeniKDV = 0.18;\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$yeniKDVHesap = $item->proformaStok_indirimliFiyat * $yeniKDV;\r\n\r\n\t\t\t$yeniKDVHesap2 = $item->proformaStok_indirimliFiyat + $yeniKDVHesap;\r\n\r\n\r\n\r\n\t\t\t$dataStok[\"satisStok_stokID\"] = $item->proformaStok_stokID;\r\n\r\n\t\t\t$dataStok[\"satisStok_miktar\"] = $item->proformaStok_miktar;\r\n\r\n\t\t\t$dataStok[\"satisStok_birimFiyat\"] = $item->proformaStok_birimFiyat;\r\n\r\n\t\t\t$dataStok[\"satisStok_fiyatMiktar\"] = $item->proformaStok_fiyatMiktar;\r\n\r\n\t\t\t$dataStok[\"satisStok_kdv\"] = $item->proformaStok_kdv;\r\n\r\n\t\t\t$dataStok[\"satisStok_indirimTutari\"] = $item->proformaStok_indirimTutari;\r\n\r\n\t\t\t$dataStok[\"satisStok_satirIskonto\"] = $item->proformaStok_satirIskonto;\r\n\r\n\t\t\t$dataStok[\"satisStok_indirimlifiyat\"] = $item->proformaStok_indirimliFiyat;\r\n\r\n\t\t\t$dataStok[\"satisStok_tevkifat_id\"] = $item->proformaStok_tevkifat_id;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"satisFaturasiStok\", $dataStok);\r\n\r\n\r\n\r\n\t\t\t$paraBirimiTxt=\"TL\";\r\n\r\n\t\t\tif($paraBirimi==2)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"USD\";\r\n\r\n\t\t\telse if($paraBirimi==3)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"EUR\";\r\n\r\n\t\t\telse if($paraBirimi==4)\r\n\r\n\t\t\t\t$paraBirimiTxt=\"GBP\";\r\n\r\n\r\n\r\n\t\t\t$data_sh[\"sh_turu\"] = 2;\r\n\r\n\t\t\t$data_sh[\"sh_cikis\"] = $item->proformaStok_miktar;\r\n\r\n\t\t\t$data_sh[\"sh_cariID\"] = $proformaDetay->proforma_cariID;\r\n\r\n\t\t\t$data_sh[\"sh_stokID\"] = $item->proformaStok_stokID;\r\n\r\n\t\t\t$data_sh[\"sh_faturaID\"] = $satis_id;\r\n\r\n\t\t\t$data_sh[\"sh_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t\t$data_sh[\"sh_paraBirimi\"] = $paraBirimiTxt;\r\n\r\n\t\t\t$data_sh[\"sh_tarih\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_birimFiyat\"] = $item->proformaStok_stokID;\r\n\r\n\t\t\t$data_sh[\"sh_kdv\"] = $item->proformaStok_stokID;\r\n\r\n\t\t\t$data_sh[\"sh_toplamKDV\"] = $yeniKDVHesap;\r\n\r\n\t\t\t$data_sh[\"sh_toplamFiyat\"] = $yeniKDVHesap2;\r\n\r\n\t\t\t$data_sh[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data_sh[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data_sh[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\", $data_sh);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t//SatÄ±ÅŸ SÃ¶zleÅŸmesi stok\r\n\r\n\r\n\r\n\t\t//Cari Hareketleri Ekle :begin\r\n\r\n\t\t$data_ch[\"ch_belgeNumarasi\"] = $faturaNo;\r\n\r\n\t\t$data_ch[\"ch_turu\"] = $ch_turu;\r\n\r\n\t\t$data_ch[\"ch_cariID\"] = $proformaDetay->proforma_cariID;\r\n\r\n\t\t$data_ch[\"ch_faturaID\"] = $satis_id;\r\n\r\n\t\t$data_ch[\"ch_paraBirimi\"] = $paraBirimiTxt;\r\n\r\n/*\r\n\r\n\t\tif($dovizCevrilmis)\r\n\r\n\t\t\t$data_ch[\"ch_borc\"] =$dovizCevrilmis;\r\n\r\n\t\telse*/\r\n\r\n\t\t$data_ch[\"ch_borc\"] = $proformaDetay->proforma_genelToplam;\r\n\r\n\t\t$data_ch[\"ch_tarih\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t$data_ch[\"ch_olusturan\"] = $u_id;\r\n\r\n\t\t$data_ch[\"ch_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data_ch[\"ch_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data_ch[\"ch_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"cariHareketleri\", $data_ch);\r\n\r\n\t\t$ch_id = $this->db->insert_id();\r\n\r\n\t\t$datachu[\"satis_cariHareketiID\"] = $ch_id;\r\n\r\n\r\n\r\n\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $datachu);\r\n\r\n\t\t//Cari Hareketleri Ekle :end\r\n\r\n\r\n\r\n\t\t$dataP[\"proforma_durum\"]=3;\r\n\r\n\t\t$this->vt->update('proformaFaturasi', array('proforma_id' => $faturaID), $dataP);\r\n\r\n\r\n\r\n\r\n\r\n\t\t$this->session->set_flashdata('fatura_ok', 'OK');\r\n\r\n\t\tlogekle(11, 2);\r\n\r\n\t\t//redirect(\"fatura/satis-faturasi-duzenle/$satis_id\");\r\n\r\n\r\n\r\n\t\t\tredirect(\"fatura/satis-faturasi-listesi\");\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\r\n\r\n\tpublic function etiketler()\r\n\r\n\t{\r\n\r\n\t\t$data[\"baslik\"]=\"Etiketler\";\r\n\r\n\t\t$anahesap=anaHesapBilgisi();\r\n\r\n\t\t$sql=\"select * from etiketler where etiket_olusturanAnaHesap=$anahesap\";\r\n\r\n\t\t$exe=$this->db->query($sql)->result();\r\n\r\n\t\t$data[\"etiketler\"]=$exe;\r\n\r\n\t\t$this->load->view(\"fatura/etiketler\",$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function etiketEkle()\r\n\r\n\t{\r\n\r\n\t\t$ad=postval(\"etiket_adi\");\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$sql=\"select * from etiketler where etiket_adi='$ad'\";\r\n\r\n\t\t$exe=$this->db->query($sql)->row();\r\n\r\n\t\tif($exe)\r\n\r\n\t\t\t$this->session->set_flashdata('etiket_mevcut', 'OK');\r\n\r\n\t\telse {\r\n\r\n\r\n\r\n\t\t\t$data[\"etiket_adi\"] = $ad;\r\n\r\n\t\t\t$data[\"etiket_olusturan\"] = $u_id;\r\n\r\n\t\t\t$data[\"etiket_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$data[\"etiket_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$data[\"etiket_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t$this->db->insert(\"etiketler\", $data);\r\n\r\n\t\t\t$this->session->set_flashdata('etiket_ekle_basarili', 'OK');\r\n\r\n\t\t}\r\n\r\n\t\tredirect(\"fatura/etiketler\");\r\n\r\n\t}\r\n\r\n\tpublic function etiketGuncelle()\r\n\r\n\t{\r\n\r\n\t\t$ad=postval(\"etiket_adi\");\r\n\r\n\t\t$id=postval(\"etiket_id\");\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"etiket_adi\"]=$ad;\r\n\r\n\t\t$data[\"etiket_olusturan\"]=$u_id;\r\n\r\n\t\t$data[\"etiket_olusturanAnaHesap\"]=$anaHesap;\r\n\r\n\t\t$data[\"etiket_olusturmaTarihi\"]=$tarihi;\r\n\r\n\t\t$data[\"etiket_olusturmaSaati\"]=$saati;\r\n\r\n\t\t$this->vt->update('etiketler', array('etiket_id' => $id), $data);\r\n\r\n\t\t$this->session->set_flashdata('etiket_guncelle_basarili', 'OK');\r\n\r\n\t\tredirect(\"fatura/etiketler\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function etiketSil()\r\n\r\n\t{\r\n\r\n\t\t$id=postval(\"etiket_id\");\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$dataSatis[\"satis_faturaEtiketID\"]=0;\r\n\r\n\t\t$this->vt->update('satisFaturasi', array('satis_faturaEtiketID' => $id,'satis_olusturanAnaHesap'=>$anaHesap), $dataSatis);\r\n\r\n\r\n\r\n\r\n\r\n\t\t$dataAlis[\"alis_faturaEtiketID\"]=0;\r\n\r\n\t\t$this->vt->update('alisFaturasi', array('alis_faturaEtiketID' => $id,'alis_olusturanAnaHesap'=>$anaHesap), $dataAlis);\r\n\r\n\r\n\r\n\t\t$dataProforma[\"proforma_faturaEtiketID\"]=0;\r\n\r\n\t\t$this->vt->update('proformaFaturasi', array('proforma_faturaEtiketID' => $id,'proforma_olusturanAnaHesap'=>$anaHesap), $dataProforma);\r\n\r\n\r\n\r\n\t\t$this->vt->del('etiketler', 'etiket_id' , $id);\r\n\r\n\t\t$this->session->set_flashdata('etiket_silme_basarili', 'OK');\r\n\r\n\t\tredirect(\"fatura/etiketler\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function deleteSalesContractFile()\r\n\r\n\t{\r\n\r\n\t\t// AJAX isteÄŸi kontrolÃ¼\r\n\r\n\t\tif (!$this->input->is_ajax_request()) {\r\n\r\n\t\t\tshow_404();\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t// POST verilerini al\r\n\r\n\t\t$file_name = $this->input->post('file_name');\r\n\r\n\t\t$satis_id = $this->input->post('satis_id');\r\n\r\n\r\n\r\n\t\t// GÃ¼venlik kontrolÃ¼ - kullanÄ±cÄ±nÄ±n bu faturayÄ± dÃ¼zenleme yetkisi var mÄ±?\r\n\r\n\t\t$allowed_user_ids = array($u_id);\r\n\r\n\t\tif ($u_id > 0) {\r\n\r\n\t\t\t$baÄŸlÄ±_kullanicilarQ = \"SELECT kullanici_id FROM kullanicilar WHERE kullanici_sorumluMudur = '$u_id'\";\r\n\r\n\t\t\t$baÄŸlÄ±_kullanicilar = $this->db->query($baÄŸlÄ±_kullanicilarQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach ($baÄŸlÄ±_kullanicilar as $user) {\r\n\r\n\t\t\t\t$allowed_user_ids[] = $user->kullanici_id;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$allowed_user_ids_str = implode(',', $allowed_user_ids);\r\n\r\n\r\n\r\n\t\t// FaturayÄ± kontrol et\r\n\r\n\t\t$satisFaturasiQ = \"SELECT * FROM satisFaturasi WHERE satis_id = '$satis_id' AND satis_olusturan IN ($allowed_user_ids_str)\";\r\n\r\n\t\t$satisFaturasi = $this->db->query($satisFaturasiQ)->row();\r\n\r\n\r\n\r\n\t\tif (!$satisFaturasi) {\r\n\r\n\t\t\techo json_encode(array('success' => false, 'message' => 'Bu iÅŸlem iÃ§in yetkiniz yok.'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Mevcut dosyalarÄ± al\r\n\r\n\t\t$existing_files = explode(',', $satisFaturasi->satis_dosya);\r\n\r\n\t\t$updated_files = array();\r\n\r\n\r\n\r\n\t\t// DosyayÄ± listeden Ã§Ä±kar ve fiziksel olarak sil\r\n\r\n\t\tforeach ($existing_files as $file_path) {\r\n\r\n\t\t\t$file_path = trim($file_path);\r\n\r\n\t\t\tif (!empty($file_path)) {\r\n\r\n\t\t\t\t$current_file_name = basename($file_path);\r\n\r\n\t\t\t\tif ($current_file_name !== $file_name) {\r\n\r\n\t\t\t\t\t$updated_files[] = $file_path;\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t// Fiziksel dosyayÄ± sil\r\n\r\n\t\t\t\t\t$full_path = './assets/uploads/' . $file_path;\r\n\r\n\t\t\t\t\tif (file_exists($full_path)) {\r\n\r\n\t\t\t\t\t\tunlink($full_path);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// VeritabanÄ±nÄ± gÃ¼ncelle\r\n\r\n\t\t$data_update['satis_dosya'] = implode(',', $updated_files);\r\n\r\n\t\t$this->vt->update('satisFaturasi', array('satis_id' => $satis_id), $data_update);\r\n\r\n\r\n\r\n\t\techo json_encode(array('success' => true, 'message' => 'Dosya başarıyla silindi.'));\r\n\r\n\t}\r\n\r\n\t// Stok bilgi düzenleme sayfası\r\n\tpublic function stokBilgiDuzenle($stok_id)\r\n\t{\r\n\t\t$data[\"baslik\"] = \"Stok Bilgi Düzenle\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t// Stok bilgilerini getir\r\n\t\t$stokQ = \"SELECT s.*, sb.stokBirim_ad, sb.stokBirim_kisaltma FROM stok s \r\n\t\t\tLEFT JOIN stokBirimleri sb ON s.stok_birimID = sb.stokBirim_id \r\n\t\t\tWHERE s.stok_id = '$stok_id' AND s.stok_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$stokBilgi = $this->db->query($stokQ)->row();\r\n\r\n\t\tif (!$stokBilgi) {\r\n\t\t\tredirect('fatura/satis-faturasi-listesi');\r\n\t\t}\r\n\r\n\t\t$data[\"stokBilgi\"] = $stokBilgi;\r\n\r\n\t\t// Stok birimleri listesi\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri ORDER BY stokBirim_ad\";\r\n\t\t$data[\"stokBirimleri\"] = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\t\t$this->load->view('fatura/stok-bilgi-duzenle', $data);\r\n\t}\r\n\r\n\t// Stok bilgi güncelleme işlemi\r\n\tpublic function stokBilgiGuncelle()\r\n\t{\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t$stok_id = postval(\"stok_id\");\r\n\r\n\t\t// Form verilerini al\r\n\t\t$data[\"stok_ad\"] = postval(\"stok_ad\");\r\n\t\t$data[\"stok_kodu\"] = postval(\"stok_kodu\");\r\n\t\t$data[\"stok_birimID\"] = postval(\"stok_birimID\");\r\n\t\t$data[\"stok_satisFiyati\"] = postval(\"stok_satisFiyati\");\r\n\t\t$data[\"stok_satisKDV\"] = postval(\"stok_satisKDV\");\r\n\r\n\t\t// Yetki kontrolü\r\n\t\t$yetkiKontrolQ = \"SELECT * FROM stok WHERE stok_id = '$stok_id' AND stok_olusturanAnaHesap = '$anaHesap'\";\r\n\t\t$yetkiKontrol = $this->db->query($yetkiKontrolQ)->row();\r\n\r\n\t\tif (!$yetkiKontrol) {\r\n\t\t\t$this->session->set_flashdata('stok_guncelle_yetki_hatasi', 'OK');\r\n\t\t\tredirect('fatura/satis-faturasi-listesi');\r\n\t\t}\r\n\r\n\t\t// Stok kodunun benzersiz olup olmadığını kontrol et\r\n\t\t$stokKoduKontrolQ = \"SELECT * FROM stok WHERE stok_kodu = '\".$data[\"stok_kodu\"].\"'\r\n\t\t\tAND stok_olusturanAnaHesap = '$anaHesap' AND stok_id != '$stok_id'\";\r\n\t\t$stokKoduKontrol = $this->db->query($stokKoduKontrolQ)->row();\r\n\t\t\r\n\t\tif ($stokKoduKontrol) {\r\n\t\t\t$this->session->set_flashdata('stok_kodu_mevcut', 'OK');\r\n\t\t\tredirect('fatura/stok-bilgi-duzenle/'.$stok_id);\r\n\t\t}\r\n\r\n\t\t// Güncelleme işlemi\r\n\t\t$this->vt->update('stok', array('stok_id' => $stok_id), $data);\r\n\r\n\t\t$this->session->set_flashdata('stok_guncelle_basarili', 'OK');\r\n\t\tredirect('fatura/stok-bilgi-duzenle/'.$stok_id);\r\n\t}\r\n}\r\n\r\n"
        }
    ]
}