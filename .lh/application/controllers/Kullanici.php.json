{
    "sourceFile": "application/controllers/Kullanici.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1756311206820,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1756366603935,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,10 @@\n \t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n \r\n \t\t$this->load->model('vt');\r\n \t\t$this->load->database();\r\n+\t\t$this->load->library('session');\r\n+\t\t$this->load->helper('url');\r\n \r\n \t\t\r\n \r\n \t\t$control = session(\"r\", \"login\");\r\n"
                }
            ],
            "date": 1756311206820,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Kullanici extends CI_Controller {\r\n\r\n\r\n\r\n  public function __construct(){\r\n\r\n\t\tparent::__construct();\r\n\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n\t\t$this->load->model('vt');\r\n\t\t$this->load->database();\r\n\r\n\t\t\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n\t\t\r\n\r\n\t\tif(!$control){\r\n\r\n\t\t\tredirect(\"check\");\r\n\r\n\t\t}\r\n\r\n\t  //sessionKontrolHelper();\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function sifreDegistir(){\r\n\r\n\t\t$data[\"baslik\"] = \"Kullanıcı / Şifre Değiştir\";\r\n\r\n\t\t$this->load->view(\"kullanici/sifre-degistir\",$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function mevcutSifremiDegistir(){\r\n\r\n\t\t$kullanici = postval(\"kullanici\");\r\n\r\n\r\n\r\n\t\t$kullaniciQ = \"SELECT * FROM kullanicilar WHERE kullanici_id = '$kullanici'\";\r\n\r\n\t\t$kullaniciExe = $this->db->query($kullaniciQ)->row();\r\n\r\n\t\t$kullaniciSifre = $kullaniciExe->kullanici_sifre;\r\n\r\n\r\n\r\n\t\t$mevcutSifre = postval(\"mevcutSifre\");\r\n\r\n\t\t$yeniSifre = postval(\"yeniSifre\");\r\n\r\n\t\t$yeniSifreTekrar = postval(\"yeniSifreTekrar\");\r\n\r\n\r\n\r\n\t\t$mevcutSifreMD5 = md5($mevcutSifre);\r\n\r\n\t\t$yeniSifreMD5 = md5($yeniSifre);\r\n\r\n\r\n\r\n\t\tif($yeniSifre == $yeniSifreTekrar){\r\n\r\n\t\t\tif($mevcutSifreMD5 == $kullaniciSifre){\r\n\r\n\t\t\t\t$data[\"kullanici_sifre\"] = $yeniSifreMD5;\r\n\r\n\t\t\t\t$this->vt->update('kullanicilar', array('kullanici_id'=>$kullanici), $data);\r\n\r\n\t\t\t\t$this->session->set_flashdata('sifre_ok','OK');\r\n\r\n    \t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t\t}else{\r\n\r\n\t\t\t\t$this->session->set_flashdata('mevcut_sifre_hatali','OK');\r\n\r\n    \t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t\t}\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$this->session->set_flashdata('sifreler_eslesmiyor','OK');\r\n\r\n    \t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t * Kullanıcı konum bilgisini güncelle\r\n\t */\r\n\tpublic function konum_guncelle()\r\n\t{\r\n\t\t// JSON veri al\r\n\t\t$json = file_get_contents('php://input');\r\n\t\t$data = json_decode($json, true);\r\n\t\t\r\n\t\tif (!$data) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Geçersiz veri']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Session kontrolü\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\tif (!$control) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Oturum bulunamadı']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$kullanici_id = $control->kullanici_id;\r\n\t\t\r\n\t\t// Konum verilerini validate et\r\n\t\t$latitude = isset($data['latitude']) ? floatval($data['latitude']) : null;\r\n\t\t$longitude = isset($data['longitude']) ? floatval($data['longitude']) : null;\r\n\t\t\r\n\t\tif (!$latitude || !$longitude) {\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Geçersiz konum verisi']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Konum geçmişine ekle\r\n\t\t$konum_data = [\r\n\t\t\t'kullanici_id' => $kullanici_id,\r\n\t\t\t'latitude' => $latitude,\r\n\t\t\t'longitude' => $longitude,\r\n\t\t\t'accuracy' => isset($data['accuracy']) ? floatval($data['accuracy']) : null,\r\n\t\t\t'address' => isset($data['address']) ? $data['address'] : null,\r\n\t\t\t'ip_address' => $this->input->ip_address(),\r\n\t\t\t'user_agent' => $this->input->user_agent(),\r\n\t\t\t'device_info' => isset($data['device_info']) ? $data['device_info'] : null,\r\n\t\t\t'created_at' => date('Y-m-d H:i:s')\r\n\t\t];\r\n\r\n\t\ttry {\r\n\t\t\t// Konum geçmişine kaydet\r\n\t\t\t$this->db->insert('kullanici_konum_takibi', $konum_data);\r\n\t\t\t\r\n\t\t\t// Son konum tablosunu güncelle\r\n\t\t\t$son_konum_data = [\r\n\t\t\t\t'kullanici_id' => $kullanici_id,\r\n\t\t\t\t'latitude' => $latitude,\r\n\t\t\t\t'longitude' => $longitude,\r\n\t\t\t\t'accuracy' => $konum_data['accuracy'],\r\n\t\t\t\t'address' => $konum_data['address'],\r\n\t\t\t\t'last_update' => date('Y-m-d H:i:s'),\r\n\t\t\t\t'is_online' => 1\r\n\t\t\t];\r\n\r\n\t\t\t// UPSERT (var ise güncelle, yok ise ekle)\r\n\t\t\t$existing = $this->db->get_where('kullanici_son_konum', ['kullanici_id' => $kullanici_id])->row();\r\n\t\t\tif ($existing) {\r\n\t\t\t\t$this->db->where('kullanici_id', $kullanici_id);\r\n\t\t\t\t$this->db->update('kullanici_son_konum', $son_konum_data);\r\n\t\t\t} else {\r\n\t\t\t\t$this->db->insert('kullanici_son_konum', $son_konum_data);\r\n\t\t\t}\r\n\r\n\t\t\techo json_encode([\r\n\t\t\t\t'status' => 'success', \r\n\t\t\t\t'message' => 'Konum başarıyla güncellendi',\r\n\t\t\t\t'data' => [\r\n\t\t\t\t\t'latitude' => $latitude,\r\n\t\t\t\t\t'longitude' => $longitude,\r\n\t\t\t\t\t'timestamp' => date('Y-m-d H:i:s')\r\n\t\t\t\t]\r\n\t\t\t]);\r\n\r\n\t\t} catch (Exception $e) {\r\n\t\t\terror_log('Konum güncelleme hatası: ' . $e->getMessage());\r\n\t\t\techo json_encode(['status' => 'error', 'message' => 'Veritabanı hatası']);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Konum hatalarını logla\r\n\t */\r\n\tpublic function konum_hata()\r\n\t{\r\n\t\t$json = file_get_contents('php://input');\r\n\t\t$data = json_decode($json, true);\r\n\t\t\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\tif (!$control) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$kullanici_id = $control->kullanici_id;\r\n\t\t\r\n\t\t// Hata logunu kaydet\r\n\t\t$error_log = sprintf(\r\n\t\t\t\"[%s] Kullanıcı ID: %d, Konum Hatası: %s (%d) - %s\",\r\n\t\t\tdate('Y-m-d H:i:s'),\r\n\t\t\t$kullanici_id,\r\n\t\t\tisset($data['error_message']) ? $data['error_message'] : 'Bilinmeyen hata',\r\n\t\t\tisset($data['error_code']) ? $data['error_code'] : 0,\r\n\t\t\t$this->input->ip_address()\r\n\t\t);\r\n\t\t\r\n\t\terror_log($error_log);\r\n\t\techo json_encode(['status' => 'logged']);\r\n\t}\r\n\r\n\t/**\r\n\t * Kullanıcının konum geçmişini getir\r\n\t */\r\n\tpublic function konum_gecmisi($limit = 50)\r\n\t{\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\tif (!$control) {\r\n\t\t\tredirect(\"check\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$kullanici_id = $control->kullanici_id;\r\n\t\t\r\n\t\t// Yetki kontrolü (sadece admin veya kendisi görebilir)\r\n\t\t$user_group_id = $control->grup_id;\r\n\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\t$is_admin = in_array($user_group_id, $admin_groups);\r\n\t\t\r\n\t\t// URL'den kullanici_id parametresi alınmışsa ve admin ise\r\n\t\t$target_user_id = $this->input->get('kullanici_id');\r\n\t\tif ($target_user_id && $is_admin) {\r\n\t\t\t$kullanici_id = $target_user_id;\r\n\t\t}\r\n\r\n\t\t$this->db->select('*');\r\n\t\t$this->db->from('kullanici_konum_takibi');\r\n\t\t$this->db->where('kullanici_id', $kullanici_id);\r\n\t\t$this->db->order_by('created_at', 'DESC');\r\n\t\t$this->db->limit($limit);\r\n\t\t\r\n\t\t$data['konum_gecmisi'] = $this->db->get()->result();\r\n\t\t$data['baslik'] = 'Konum Geçmişi';\r\n\t\t\r\n\t\t$this->load->view('kullanici/konum-gecmisi', $data);\r\n\t}\r\n\r\n\t/**\r\n\t * Tüm kullanıcıların son konumları (Admin only)\r\n\t */\r\n\tpublic function kullanici_konumlari()\r\n\t{\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\t\tif (!$control) {\r\n\t\t\tredirect(\"check\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Yetki kontrolü - sadece adminler\r\n\t\t$user_group_id = $control->grup_id;\r\n\t\t$admin_groups = [1, 2, 5, 7];\r\n\t\tif (!in_array($user_group_id, $admin_groups)) {\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Son konumları kullanıcı bilgileriyle birlikte getir\r\n\t\t$query = \"\r\n\t\t\tSELECT \r\n\t\t\t\tusk.*,\r\n\t\t\t\tk.kullanici_ad,\r\n\t\t\t\tk.kullanici_soyad,\r\n\t\t\t\tk.kullanici_eposta,\r\n\t\t\t\tk.kullanici_durum\r\n\t\t\tFROM kullanici_son_konum usk\r\n\t\t\tLEFT JOIN kullanicilar k ON usk.kullanici_id = k.kullanici_id\r\n\t\t\tWHERE usk.last_update >= DATE_SUB(NOW(), INTERVAL 24 HOUR)\r\n\t\t\tORDER BY usk.is_online DESC, usk.last_update DESC\r\n\t\t\";\r\n\t\t\r\n\t\t$data['kullanici_konumlari'] = $this->db->query($query)->result();\r\n\t\t$data['baslik'] = 'Kullanıcı Konumları';\r\n\t\t\r\n\t\t$this->load->view('kullanici/kullanici-konumlari', $data);\r\n\t}\r\n}\r\n\r\n"
        }
    ]
}