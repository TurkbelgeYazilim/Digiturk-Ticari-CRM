{
    "sourceFile": "application/controllers/Stok.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1755584922756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1756388902167,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1696,12 +1696,12 @@\n \t\t\t\tSELECT \r\n \t\t\t\t\tstok_id,\r\n \t\t\t\t\tstok_ad,\r\n \t\t\t\t\tstok_kodu,\r\n-\t\t\t\t\tstok_satisFiyat1,\r\n-\t\t\t\t\tstok_birim\r\n-\t\t\t\tFROM stoklar \r\n-\t\t\t\tWHERE stok_anaHesap = ? \r\n+\t\t\t\t\tstok_satisFiyati,\r\n+\t\t\t\t\tstok_satisKDV\r\n+\t\t\t\tFROM stok \r\n+\t\t\t\tWHERE stok_olusturanAnaHesap = ? \r\n \t\t\t\tAND stok_durum = 1\r\n \t\t\t\tAND (\r\n \t\t\t\t\tstok_ad LIKE ? \r\n \t\t\t\t\tOR stok_kodu LIKE ?\r\n@@ -1715,20 +1715,22 @@\n \t\t\t\r\n \t\t\t$data = [];\r\n \t\t\tforeach ($result as $row) {\r\n \t\t\t\t$data[] = [\r\n-\t\t\t\t\t'label' => $row->stok_ad . ' (' . $row->stok_kodu . ')',\r\n+\t\t\t\t\t'label' => $row->stok_ad . ' (' . ($row->stok_kodu ?: 'Kod Yok') . ')',\r\n \t\t\t\t\t'value' => $row->stok_ad,\r\n \t\t\t\t\t'stok_id' => $row->stok_id,\r\n \t\t\t\t\t'stok_kodu' => $row->stok_kodu,\r\n-\t\t\t\t\t'stok_satisFiyat1' => $row->stok_satisFiyat1,\r\n-\t\t\t\t\t'stok_birim' => $row->stok_birim\r\n+\t\t\t\t\t'stok_ad' => $row->stok_ad,\r\n+\t\t\t\t\t'stok_satisFiyati' => $row->stok_satisFiyati,\r\n+\t\t\t\t\t'stok_satisKDV' => $row->stok_satisKDV\r\n \t\t\t\t];\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\techo json_encode($data);\r\n \t\t\t\r\n \t\t} catch (Exception $e) {\r\n+\t\t\terror_log(\"Stok arama error: \" . $e->getMessage());\r\n \t\t\techo json_encode([]);\r\n \t\t}\r\n \t}\r\n \r\n"
                }
            ],
            "date": 1755584922756,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\Helper\\Sample;\r\n\r\nuse PhpOffice\\PhpSpreadsheet\\IOFactory;\r\n\r\n\r\n\r\nclass Stok extends CI_Controller {\r\n\r\n\r\n\r\n  public function __construct(){\r\n\r\n\t\tparent::__construct();\r\n\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n\t\t$this->load->model('vt');\r\n\r\n\t\t\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n\r\n\r\n\t  if(gibYetki()==1)\r\n\r\n\t\t  redirect(\"home/hata\");\r\n\r\n\t  //sessionKontrolHelper();\r\n\r\n\r\n\r\n\t  if(!$control){\r\n\r\n\t\t\tredirect(\"check\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokGruplari(){\r\n\r\n\t\t$data[\"baslik\"] = \"Stok / Stok Grupları\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokGruplariQ = \"SELECT * FROM stokGruplari WHERE stokGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$data[\"stokGruplari\"] = $this->db->query($stokGruplariQ)->result();\r\n\r\n\r\n\r\n\t\t$countq = \"SELECT COUNT(*) as total FROM stokGruplari WHERE stokGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t//logekle(8,1);\r\n\r\n\r\n\r\n\t\t$this->load->view(\"stok/stok-gruplari\",$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function yeniStokGrubuEkle(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokGrup_kodu = postval(\"stokGrup_kodu\");\r\n\r\n\r\n\r\n\t\t$data[\"stokGrup_kodu\"] = $stokGrup_kodu;\r\n\r\n\t\t$data[\"stokGrup_ad\"] = postval(\"stokGrup_ad\");\r\n\r\n\t\t$data[\"stokGrup_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"stokGrup_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"stokGrup_olusturmaTarihi\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t$stokGrupKoduVarmiQ = \"SELECT * FROM stokGruplari WHERE stokGrup_kodu = '$stokGrup_kodu' AND stokGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$stokGrupKoduVarmi = $this->db->query($stokGrupKoduVarmiQ)->row();\r\n\r\n\r\n\r\n\t\tif($stokGrupKoduVarmi){\r\n\r\n\t\t\t$this->session->set_flashdata('stok_grup_kodvar','OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$this->vt->insert(\"stokGruplari\",$data);\r\n\r\n\t\t\t$this->session->set_flashdata('stok_grup_ok','OK');\r\n\r\n\t\t\tlogekle(8,2);\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function mevcutStokGrubuDuzenle(){\r\n\r\n\t\t$id = postval(\"stokGrup_id\");\r\n\r\n\t\t$stokGrup_kodu = postval(\"stokGrup_kodu\");\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"stokGrup_kodu\"] = $stokGrup_kodu;\r\n\r\n\t\t$data[\"stokGrup_ad\"] = postval(\"stokGrup_ad\");\r\n\r\n\r\n\r\n\t\t$stokGrupKoduVarmiQ = \"SELECT * FROM stokGruplari WHERE stokGrup_kodu = '$stokGrup_kodu' AND stokGrup_olusturanAnaHesap = '$anaHesap' AND stokGrup_id != $id\";\r\n\r\n\t\t$stokGrupKoduVarmi = $this->db->query($stokGrupKoduVarmiQ)->row();\r\n\r\n\r\n\r\n\t\tif($stokGrupKoduVarmi){\r\n\r\n\t\t\t$this->session->set_flashdata('stok_grup_kodvar','OK');\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$this->vt->update('stokGruplari', array('stokGrup_id'=>$id), $data);\r\n\r\n\t\t\t$this->session->set_flashdata('stok_grup_updt_ok','OK');\r\n\r\n\t\t\tlogekle(8,3);\r\n\r\n\t\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokBirimleri(){\r\n\r\n\t\t$data[\"baslik\"] = \"Stok / Stok Birimleri\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$data[\"stokBirimleri\"] = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\r\n\r\n\t\t$countq = \"SELECT COUNT(*) as total FROM stokBirimleri\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t//logekle(9,1);\r\n\r\n\r\n\r\n\t\t$this->load->view(\"stok/stok-birimleri\",$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function yeniStokBirimiEkle(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"stokBirim_ad\"] = postval(\"stokBirim_ad\");\r\n\r\n\t\t$data[\"stokBirim_kisaltma\"] = postval(\"stokBirim_kisaltma\");\r\n\r\n\t\t$data[\"stokBirim_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"stokBirim_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"stokBirim_olusturmaTarihi\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"stokBirimleri\",$data);\r\n\r\n\t\t$this->session->set_flashdata('stok_birim_ok','OK');\r\n\r\n\t\tlogekle(9,2);\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function mevcutStokBirimiDuzenle(){\r\n\r\n\t\t$id = postval(\"stokBirim_id\");\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$data[\"stokBirim_ad\"] = postval(\"stokBirim_ad\");\r\n\r\n\t\t$data[\"stokBirim_kisaltma\"] = postval(\"stokBirim_kisaltma\");\r\n\r\n\r\n\r\n\t\t$this->vt->update('stokBirimleri', array('stokBirim_id'=>$id), $data);\r\n\r\n\t\t$this->session->set_flashdata('stok_birim_updt_ok','OK');\r\n\r\n\t\tlogekle(9,3);\r\n\r\n\t\tredirect($_SERVER['HTTP_REFERER']);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokKartiOlustur(){\r\n\r\n\t\t$data[\"baslik\"] = \"Stok / Stok Kartı Oluştur\";\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokGruplariQ = \"SELECT * FROM stokGruplari WHERE stokGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$data[\"stokGruplari\"] = $this->db->query($stokGruplariQ)->result();\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$data[\"stokBirimleri\"] = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\r\n\r\n\t\t//logekle(5,1);\r\n\r\n\t\t$this->load->view('stok/stok-karti-olustur',$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function yeniStokKartiOlustur(){\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d');\r\n\r\n\t\t$saati = (new DateTime('now'))->format('H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokKodu = postval(\"stok_kodu\");\r\n\r\n\r\n\r\n\t\t$kritikSeviye = postval(\"stok_kritikSeviyesi\");\r\n\r\n\r\n\r\n\t\tif($kritikSeviye){\r\n\r\n\t\t\t$stokKritikSeviye = $kritikSeviye;\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$stokKritikSeviye = NULL;\r\n\r\n\t\t}\r\n\r\n\t\t$baslangic=postval(\"stok_baslangic\");\r\n\r\n\r\n\r\n\t\t$data[\"stok_kodu\"] = $stokKodu;\r\n\r\n\t\t$data[\"stok_ad\"] = postval(\"stok_ad\");\r\n\r\n\t\t$data[\"stok_barkod\"] = postval(\"stok_barkod\");\r\n\r\n\t\t$data[\"stok_baslangic\"] =$baslangic;\r\n\r\n\t\t$data[\"stok_stokGrupKoduID\"] = postval(\"stok_stokGrupKoduID\");\r\n\r\n\t\t$data[\"stok_birimID\"] = postval(\"stok_birimID\");\r\n\r\n\t\t$data[\"stok_alisFiyati\"] = postval(\"stok_alisFiyati\");\r\n\r\n\t\t$data[\"stok_satisFiyati\"] = postval(\"stok_satisFiyati\");\r\n\r\n\t\t$data[\"stok_alisKDV\"] = postval(\"stok_alisKDV\");\r\n\r\n\t\t$data[\"stok_satisKDV\"] = postval(\"stok_satisKDV\");\r\n\r\n\t\t$data[\"stok_kritikSeviyesi\"] = $stokKritikSeviye;\r\n\r\n\t\t$data[\"stok_aciklama\"] = postval(\"stok_aciklama\");\r\n\r\n\t\t$data[\"stok_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"stok_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"stok_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t$data[\"stok_olusturmaSaati\"] = $saati;\r\n\r\n\r\n\r\n\t\t$stokKoduVarmiQ = \"SELECT * FROM stok WHERE stok_kodu = '$stokKodu' AND stok_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$stokKoduVarmi = $this->db->query($stokKoduVarmiQ)->row();\r\n\r\n\r\n\r\n\t\tif($stokKoduVarmi){\r\n\r\n\t\t\t$this->session->set_flashdata('stok_kodu_mevcut','OK');\r\n\r\n\t\t\tredirect(\"stok/stok-karti-olustur\");\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$this->vt->insert(\"stok\",$data);\r\n\r\n\t\t\t$stok_id = $this->db->insert_id();\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$datash[\"sh_turu\"] = 5;//baslangic\r\n\r\n\t\t\t$datash[\"sh_giris\"] = $baslangic;\r\n\r\n\t\t\t$datash[\"sh_stokID\"] = $stok_id;\r\n\r\n\t\t\t$datash[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t\t$datash[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t\t$datash[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\t\t\t$datash[\"sh_olusturmaSaati\"] = $saati;\r\n\r\n\t\t\t$this->vt->insert(\"stokHareketleri\",$datash);\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t$this->session->set_flashdata('stok_ok','OK');\r\n\r\n\t\t\tlogekle(5,2);\r\n\r\n\t\t\tredirect(\"stok/stok-karti-duzenle/$stok_id\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokKartiDuzenle($id){\r\n\r\n\t\t$data[\"baslik\"] = \"Stok / Stok Kartı Düzenle\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokGruplariQ = \"SELECT * FROM stokGruplari WHERE stokGrup_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t$data[\"stokGruplari\"] = $this->db->query($stokGruplariQ)->result();\r\n\r\n\r\n\r\n\t\t$stokBirimleriQ = \"SELECT * FROM stokBirimleri\";\r\n\r\n\t\t$data[\"stokBirimleri\"] = $this->db->query($stokBirimleriQ)->result();\r\n\r\n\r\n\r\n\t\t$stokQ = \"SELECT * FROM stok WHERE stok_id = '$id'\";\r\n\r\n\t\t$data[\"stok\"] = $this->db->query($stokQ)->row();\r\n\r\n\r\n\r\n\t\t$olusturanHesapKim = $data[\"stok\"]->stok_olusturanAnaHesap;\r\n\r\n\r\n\r\n\t\tif($anaHesap == $olusturanHesapKim){\r\n\r\n\t\t\t//logekle(5,1);\r\n\r\n\t\t\t$this->load->view('stok/stok-karti-duzenle',$data);\r\n\r\n\t\t}else{\r\n\r\n\t\t\tredirect('hata');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function mevcutStokKartiDuzenle(){\r\n\r\n\t\t$stok_id = postval(\"stok_id\");\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokKodu = postval(\"stok_kodu\");\r\n\r\n\r\n\r\n\t\t$kritikSeviye = postval(\"stok_kritikSeviyesi\");\r\n\r\n\r\n\r\n\t\tif($kritikSeviye){\r\n\r\n\t\t\t$stokKritikSeviye = $kritikSeviye;\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$stokKritikSeviye = NULL;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"stok_kodu\"] = $stokKodu;\r\n\r\n\t\t$data[\"stok_ad\"] = postval(\"stok_ad\");\r\n\r\n\t\t$data[\"stok_barkod\"] = postval(\"stok_barkod\");\r\n\r\n\t\t$data[\"stok_stokGrupKoduID\"] = postval(\"stok_stokGrupKoduID\");\r\n\r\n\t\t$data[\"stok_birimID\"] = postval(\"stok_birimID\");\r\n\r\n\t\t$data[\"stok_alisFiyati\"] = postval(\"stok_alisFiyati\");\r\n\r\n\t\t$data[\"stok_satisFiyati\"] = postval(\"stok_satisFiyati\");\r\n\r\n\t\t$data[\"stok_alisKDV\"] = postval(\"stok_alisKDV\");\r\n\r\n\t\t$data[\"stok_satisKDV\"] = postval(\"stok_satisKDV\");\r\n\r\n\t\t$data[\"stok_kritikSeviyesi\"] = $stokKritikSeviye;\r\n\r\n\t\t$data[\"stok_aciklama\"] = postval(\"stok_aciklama\");\r\n\r\n\r\n\r\n\t\t$stokKoduVarmiQ = \"SELECT * FROM stok WHERE stok_kodu = '$stokKodu' AND stok_olusturanAnaHesap = '$anaHesap' AND stok_id != $stok_id\";\r\n\r\n\t\t$stokKoduVarmi = $this->db->query($stokKoduVarmiQ)->row();\r\n\r\n\r\n\r\n\t\tif($stokKoduVarmi){\r\n\r\n\t\t\t$this->session->set_flashdata('stok_update_stokkoduvar','OK');\r\n\r\n\t\t\tredirect(\"stok/stok-karti-duzenle/$stok_id\");\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$this->vt->update('stok', array('stok_id'=>$stok_id), $data);\r\n\r\n\t\t\t$this->session->set_flashdata('stok_update_ok','OK');\r\n\r\n\t\t\tlogekle(5,3);\r\n\r\n\t\t\tredirect(\"stok/stok-karti-duzenle/$stok_id\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokListesi(){\r\n\r\n\t\t$data[\"baslik\"] = \"Stok / Stok Listesi\";\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokKodu = $this->input->get('stokKodu');\r\n\r\n\t\t$stokAdi = $this->input->get('stokAdi');\r\n\r\n\t\t$stokGrubu = $this->input->get('stokGrubu');\r\n\r\n\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //küçük tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //büyük tarih\r\n\r\n\r\n\r\n\t\t$urim = $this->uri->segment(2);\r\n\r\n\r\n\r\n\t\t$segment = 2;\r\n\r\n\t\t$sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n\t\t$page = $sayfa ? $sayfa : 0;\r\n\r\n\t\t$limit = 20;\r\n\r\n\r\n\r\n\t\tif($sayfa){$pagem = ($page-1)*$limit;}\r\n\r\n\t\telse{$pagem = 0;/*logekle(6,1);*/}\r\n\r\n\r\n\r\n\r\n\r\n\t\tif((isset($stokKodu) && !empty($stokKodu)) || (isset($stokAdi) && !empty($stokAdi)) || (isset($stokGrubu) && !empty($stokGrubu)) || (isset($tarihGet) && !empty($tarihGet)) ){\r\n\r\n\r\n\r\n\t\t\tif(!empty($stokGrubu)){$sorgu1 = \"AND stok_stokGrupKoduID = '$stokGrubu'\";}\r\n\r\n\t\t\telse{$sorgu1 = \"\";}\r\n\r\n\r\n\r\n\t\t\tif(!empty($tarihGet)){$sorgu2 = \"AND stok_olusturmaTarihi BETWEEN '$tarih1' AND '$tarih2'\";}\r\n\r\n\t\t\telse{$sorgu2 = \"\";}\r\n\r\n\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM stok WHERE stok_durum=1 and stok_olusturanAnaHesap = '$anaHesap' AND stok_kodu LIKE '%$stokKodu%' AND stok_ad LIKE '%$stokAdi%' \".$sorgu1.\" \".$sorgu2.\" \";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM stok WHERE stok_durum=1 and stok_olusturanAnaHesap = '$anaHesap' AND stok_kodu LIKE '%$stokKodu%' AND stok_ad LIKE '%$stokAdi%' \".$sorgu1.\" \".$sorgu2.\" ORDER BY stok_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$countq = \"SELECT COUNT(*) as total FROM stok WHERE stok_durum=1 and stok_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$countexe = $this->db->query($countq)->row();\r\n\r\n\t\t\t$count = $countexe->total;\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM stok WHERE stok_durum=1 and stok_olusturanAnaHesap = '$anaHesap' ORDER BY stok_id DESC LIMIT $pagem,$limit\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n\t\t$this->load->library(\"pagination\");\r\n\r\n\r\n\r\n\t\t$config = array();\r\n\r\n\t\t$config[\"base_url\"] = base_url() . \"/stok/$urim\";\r\n\r\n\t\t$config[\"total_rows\"] = $count;\r\n\r\n\t\t$config[\"per_page\"] = $limit;\r\n\r\n\t\t$config[\"uri_segment\"] = $segment;\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t$config['enable_query_strings'] = TRUE;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['reuse_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['num_links'] = 9;\r\n\r\n\r\n\r\n\t\t$config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n\t\t$config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['first_link'] = '&laquo;&laquo;';\r\n\r\n\t\t$config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['last_link'] = '&raquo;&raquo;';\r\n\r\n\t\t$config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\r\n\r\n\t\t$data[\"links\"] = $this->pagination->create_links();\r\n\r\n\t\t$data[\"stok\"] = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view('stok/stok-listesi',$data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokHareketleri(){\r\n\r\n\t$data[\"baslik\"] = \"Stok / Stok Hareketleri\";\r\n\r\n\t\t\r\n\r\n\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t$stokBilgisi = $this->input->get('stok');\r\n\r\n\r\n\r\n    $stokTuru = $this->input->get('stokTuru');\r\n\r\n\r\n\r\n\t$stokKodu = $this->input->get('stokKodu');\r\n\r\n\r\n\r\n    $tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //küçük tarih\r\n\r\n\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //büyük tarih\r\n\r\n\r\n\r\n\t$siralama = $this->input->get('siralama');\r\n\r\n\r\n\r\n    $urim = $this->uri->segment(2);\r\n\r\n    \r\n\r\n    $segment = 2;\r\n\r\n    $sayfa = $this->input->get(\"sayfa\");\r\n\r\n\r\n\r\n    $page = $sayfa ? $sayfa : 0;\r\n\r\n    $limit = 20;\r\n\r\n\r\n\r\n    if($sayfa){$pagem = ($page-1)*$limit;}\r\n\r\n    else{$pagem = 0;}\r\n\r\n\r\n\r\n    if((isset($stokTuru) && !empty($stokTuru)) || (isset($stokKodu) && !empty($stokKodu)) || (isset($tarihGet) && !empty($tarihGet)) || (isset($siralama) && !empty($siralama))  ){\r\n\r\n\r\n\r\n        if(!empty($stokTuru)){$sorgu1 = \"AND sh_turu = '$stokTuru'\";}\r\n\r\n        else{$sorgu1 = \"\";}\r\n\r\n\r\n\r\n\r\n\r\n\t\tif(!empty($stokKodu)){$sorgu3 = \"AND stok.stok_kodu = '$stokKodu'\";}\r\n\r\n\t\telse{$sorgu3 = \"\";}\r\n\r\n\r\n\r\n        if(!empty($stokBilgisi) && $stokBilgisi != \"tumu\"){\r\n\r\n    \t\t$kasaQuery = \"AND sh_stokID = '$stokBilgisi'\";\r\n\r\n    \t}\r\n\r\n\r\n\r\n    \tif(!empty($tarihGet)){$sorgu2 = \"AND sh_tarih BETWEEN '$tarih1' AND '$tarih2'\";}\r\n\r\n\t\telse{$sorgu2 = \"\";}\r\n\r\n\r\n\r\n\t\tif(!empty($siralama)){\r\n\r\n\t\t\tif($siralama == 1){//Tarih büyükten küçüğe\r\n\r\n\t\t\t\t$sira = \"ORDER BY DATE(sh_tarih) DESC\";\r\n\r\n\t\t\t}else if($siralama == 2){//Tarih küçükten büyüğe\r\n\r\n\t\t\t\t$sira = \"ORDER BY DATE(sh_tarih) ASC\";\r\n\r\n\t\t\t}else{\r\n\r\n\t\t\t\t$sira=\"ORDER BY sh_id DESC\";\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\telse{$sira=\"ORDER BY sh_id DESC\";}\r\n\r\n\r\n\r\n        $countq = \"SELECT COUNT(*) as total FROM stokHareketleri inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" \".$sorgu1.\" \".$sorgu2.\" \".$sorgu3.\" \";\r\n\r\n        $countexe = $this->db->query($countq)->row();\r\n\r\n        $count = $countexe->total;\r\n\r\n\r\n\r\n        $sorgu = \"SELECT * FROM stokHareketleri  inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" \".$sorgu1.\" \".$sorgu2.\" \".$sorgu3.\" \".$sira.\" LIMIT $pagem,$limit\";\r\n\r\n\r\n\r\n        $toplamGirisQ = \"SELECT SUM(sh_giris) AS toplamGiris FROM stokHareketleri  inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" \".$sorgu1.\" \".$sorgu2.\" \".$sorgu3.\" \";\r\n\r\n\t\t\t\t$toplamGirisExe = $this->db->query($toplamGirisQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$toplamCikisQ = \"SELECT SUM(sh_cikis) AS toplamCikis from stokHareketleri inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" \".$sorgu1.\" \".$sorgu2.\" \".$sorgu3.\" \";\r\n\r\n\t\t\t\t$toplamCikisExe = $this->db->query($toplamCikisQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$data[\"toplamGiris\"] = $toplamGirisExe->toplamGiris;\r\n\r\n\t\t\t\t$data[\"toplamCikis\"] = $toplamCikisExe->toplamCikis;\r\n\r\n\t\t\t\t$data[\"kalan\"] = $data[\"toplamGiris\"] - $data[\"toplamCikis\"];\r\n\r\n    }else{\r\n\r\n\r\n\r\n    \tif(!empty($stokBilgisi) && $stokBilgisi != \"tumu\"){\r\n\r\n    \t\t$kasaQuery = \"AND sh_stokID = '$stokBilgisi'\";\r\n\r\n    \t} \r\n\r\n\r\n\r\n        $countq = \"SELECT COUNT(*) as total FROM stokHareketleri  inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\"\";\r\n\r\n        $countexe = $this->db->query($countq)->row();\r\n\r\n        $count = $countexe->total;\r\n\r\n        $sorgu = \"SELECT * FROM stokHareketleri  inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" ORDER BY sh_id DESC LIMIT $pagem,$limit\";\r\n\r\n\r\n\r\n\t\t\t\t$toplamGirisQ = \"SELECT SUM(sh_giris) AS toplamGiris FROM stokHareketleri  inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" \";\r\n\r\n\t\t\t\t$toplamGirisExe = $this->db->query($toplamGirisQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$toplamCikisQ = \"SELECT SUM(sh_cikis) AS toplamCikis FROM stokHareketleri  inner join stok on stok_id=sh_stokID WHERE stok_durum=1 and sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\"\";\r\n\r\n\t\t\t\t$toplamCikisExe = $this->db->query($toplamCikisQ)->row();\r\n\r\n\r\n\r\n\t\t\t\t$data[\"toplamGiris\"] = $toplamGirisExe->toplamGiris;\r\n\r\n\t\t\t\t$data[\"toplamCikis\"] = $toplamCikisExe->toplamCikis;\r\n\r\n\t\t\t\t$data[\"kalan\"] = $data[\"toplamGiris\"] - $data[\"toplamCikis\"];\r\n\r\n    }\r\n\r\n    $data[\"count_of_list\"] = $count;\r\n\r\n\r\n\r\n    $this->load->library(\"pagination\");\r\n\r\n\r\n\r\n    $config = array();\r\n\r\n    $config[\"base_url\"] = base_url() . \"/stok/$urim\";\r\n\r\n    $config[\"total_rows\"] = $count;\r\n\r\n    $config[\"per_page\"] = $limit;\r\n\r\n    $config[\"uri_segment\"] = $segment;\r\n\r\n    $config['use_page_numbers'] = TRUE;\r\n\r\n    $config['enable_query_strings'] = TRUE;\r\n\r\n    $config['page_query_string'] = TRUE;\r\n\r\n    $config['reuse_query_string'] = TRUE;\r\n\r\n    $config['query_string_segment'] = 'sayfa';\r\n\r\n    $config['num_links'] = 9;\r\n\r\n\r\n\r\n    $config['full_tag_open'] = '<div class=\"d-flex justify-content-center\"><ul class=\"pagination\">';\r\n\r\n    $config['full_tag_close'] = '</ul></div>';\r\n\r\n\r\n\r\n    $config['num_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n    $config['num_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n    $config['cur_tag_open'] = '<span class=\"page-link\"><li class=\"page-item active\">';\r\n\r\n    $config['cur_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n    $config['first_link'] = '&laquo;&laquo;';\r\n\r\n    $config['first_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n    $config['first_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n    $config['last_link'] = '&raquo;&raquo;';\r\n\r\n    $config['last_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n    $config['last_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n    $config['prev_link'] = '&laquo;';\r\n\r\n    $config['prev_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n    $config['prev_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n    $config['next_link'] = '&raquo;';\r\n\r\n    $config['next_tag_open'] = '<span class=\"page-link\"><li class=\"page-item\">';\r\n\r\n    $config['next_tag_close'] = '</li></span>';\r\n\r\n\r\n\r\n    $this->pagination->initialize($config);\r\n\r\n\r\n\r\n    $data[\"links\"] = $this->pagination->create_links();\r\n\r\n    $data[\"stokHareketleri\"] = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$this->load->view('stok/stok-hareketleri', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokListesiExcel(){\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokKodu = $this->input->get('stokKodu');\r\n\r\n\t\t$stokAdi = $this->input->get('stokAdi');\r\n\r\n\t\t$stokGrubu = $this->input->get('stokGrubu');\r\n\r\n\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //küçük tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //büyük tarih\r\n\r\n\r\n\r\n\t\tif((isset($stokKodu) && !empty($stokKodu)) || (isset($stokAdi) && !empty($stokAdi)) || (isset($stokGrubu) && !empty($stokGrubu)) || (isset($tarihGet) && !empty($tarihGet)) ){\r\n\r\n\r\n\r\n\t\tif(!empty($stokGrubu)){$sorgu1 = \"AND stok_stokGrupKoduID = '$stokGrubu'\";}\r\n\r\n\t\telse{$sorgu1 = \"\";}\r\n\r\n\r\n\r\n\t\tif(!empty($tarihGet)){$sorgu2 = \"AND stok_olusturmaTarihi BETWEEN '$tarih1' AND '$tarih2'\";}\r\n\r\n\t\telse{$sorgu2 = \"\";}\r\n\r\n\r\n\r\n\t\t$sorgu = \"SELECT * FROM stok WHERE stok_olusturanAnaHesap = '$anaHesap' AND stok_kodu LIKE '%$stokKodu%' AND stok_ad LIKE '%$stokAdi%' \".$sorgu1.\" \".$sorgu2.\" ORDER BY stok_id DESC\";\r\n\r\n\t\t}else{\r\n\r\n\t\t\t$sorgu = \"SELECT * FROM stok WHERE stok_olusturanAnaHesap = '$anaHesap' ORDER BY stok_id DESC\";\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$stok = $this->db->query($sorgu)->result();\r\n\r\n$reader=PhpOffice\\PhpSpreadsheet\\IOFactory::createReader('Xlsx');\r\n\r\n\t\t$reader->setReadDataOnly(TRUE);\r\n\r\n\t\t$spreadsheet = new Spreadsheet();\r\n\r\n\t\t\r\n\r\n\t   \t$sheet = $spreadsheet->getActiveSheet();\r\n\r\n\r\n\r\n\t   \tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('d.m.Y-His');\r\n\r\n\r\n\r\n\t\t//$sheet->getStyle('A1:G1')->getFill()->setFillType(Fill::FILL_SOLID)->getStartColor()->setARGB('CCCCCC');\r\n\r\n\t\t\r\n\r\n\t\t$sheet->setCellValue('A1', 'STOK KODU');\r\n\r\n\t\t$sheet->setCellValue('B1', 'STOK ADI');\r\n\r\n\t\t$sheet->setCellValue('C1', 'BİRİM');\r\n\r\n\t\t$sheet->setCellValue('D1', 'GRUP ADI');\r\n\r\n\t\t$sheet->setCellValue('E1', 'DURUM');\r\n\r\n\t\t$sheet->setCellValue('F1', 'ALIŞ FİYATI');\r\n\r\n\t\t$sheet->setCellValue('G1', 'SATIŞ FİYATI');\r\n\r\n\r\n\r\n\t\t$rows = 2;\r\n\r\n\t\t$toplamDurum=0;$toplamAlis=0;$toplamSatis=0;\r\n\r\n\t\tforeach($stok as $st){\r\n\r\n\t\t\t$birimQ = \"SELECT * FROM stokBirimleri WHERE stokBirim_id = '$st->stok_birimID'\";\r\n\r\n\t\t\t$birimExe = $this->db->query($birimQ)->row();\r\n\r\n\r\n\r\n\t\t\t$grupQ = \"SELECT * FROM stokGruplari WHERE stokGrup_olusturanAnaHesap='$anaHesap' AND stokGrup_id = '$st->stok_stokGrupKoduID'\";\r\n\r\n\t\t\t$grupExe = $this->db->query($grupQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamGirisQ = \"SELECT SUM(sh_giris) AS toplamGiris FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' AND sh_stokID = '$st->stok_id'\";\r\n\r\n\t\t\t$toplamGirisExe = $this->db->query($toplamGirisQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamCikisQ = \"SELECT SUM(sh_cikis) AS toplamCikis FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' AND sh_stokID = '$st->stok_id'\";\r\n\r\n\t\t\t$toplamCikisExe = $this->db->query($toplamCikisQ)->row();\r\n\r\n\r\n\r\n\t\t\t$toplamGiris = $toplamGirisExe->toplamGiris;\r\n\r\n\t\t\t$toplamCikis = $toplamCikisExe->toplamCikis;\r\n\r\n\t\t\t$kalan = $toplamGiris - $toplamCikis;\r\n\r\n\r\n\r\n\t\t\t$sheet->setCellValue('A'.$rows, $st->stok_kodu);\r\n\r\n\t\t\t$sheet->setCellValue('B'.$rows, $st->stok_ad);\r\n\r\n\t\t\t$sheet->setCellValue('C'.$rows, $birimExe->stokBirim_ad);\r\n\r\n\t\t\t$sheet->setCellValue('D'.$rows, $grupExe->stokGrup_ad);\r\n\r\n\t\t\t$sheet->setCellValue('E'.$rows, $kalan);\r\n\r\n\t\t\t$sheet->setCellValue('F'.$rows, $st->stok_alisFiyati);\r\n\r\n\t\t\t$sheet->setCellValue('G'.$rows, $st->stok_satisFiyati);\r\n\r\n\r\n\r\n\t\t\t$toplamDurum += $kalan;\r\n\r\n\t\t\t$toplamSatis +=$st->stok_satisFiyati;\r\n\r\n\t\t\t$toplamAlis +=$st->stok_alisFiyati;\r\n\r\n\t\t\t$rows++;\r\n\r\n\t\t}\r\n\r\n\t\t$rows++;\r\n\r\n\r\n\r\n\r\n\r\n\t\t$sheet->setCellValue('D'.$rows, \"Toplam\");\r\n\r\n\t\t$sheet->setCellValue('E'.$rows, $toplamDurum);\r\n\r\n\t\t$sheet->setCellValue('F'.$rows, $toplamAlis);\r\n\r\n\t\t$sheet->setCellValue('G'.$rows, $toplamSatis);\r\n\r\n\r\n\r\n\t\t$satir=\"D\".$rows.\":G\".$rows;\r\n\r\n//\t\t$sheet->getStyle($satir)->getFill()->setFillType(Fill::FILL_SOLID)->getStartColor()->setARGB('CCCCCC');\r\n\r\n\r\n\r\n\r\n\r\n\t\t$sheet->getColumnDimension('A')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('B')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('C')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('D')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('E')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('F')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('G')->setAutoSize(true);\r\n\r\n\r\n\r\n\t\t$writer = new Xlsx($spreadsheet);//instantiate Xlsx\r\n\r\n\t\t\t\r\n\r\n\t    $filename = 'stok-listesi-'.$tarih;//set filename for excel file to be exported\r\n\r\n\r\n\r\n\t    header('Content-Type: application/vnd.ms-excel');// generate excel file\r\n\r\n\t    header('Content-Disposition: attachment;filename=\"'. $filename .'.xlsx\"'); \r\n\r\n\t    header('Cache-Control: max-age=0');\r\n\r\n\t    \r\n\r\n\t\t$writer->save('php://output');//download file \r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stokHareketleriExcel(){\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$stokBilgisi = $this->input->get('stok');\r\n\r\n\r\n\r\n\t\t$stokTuru = $this->input->get('stokTuru');\r\n\r\n\r\n\r\n\t\t$stokKodu = $this->input->get('stokKodu');\r\n\r\n\r\n\r\n\t\t$tarihGet = $this->input->get('tarihAraligi');\r\n\r\n\r\n\r\n\t\t$tarihAraligi = explode(' - ', $tarihGet);\r\n\r\n\r\n\r\n\t\t$tarih1 = date('Y-m-d', strtotime($tarihAraligi[0])); //küçük tarih\r\n\r\n\t\t$tarih2 = date('Y-m-d', strtotime($tarihAraligi[1])); //büyük tarih\r\n\r\n\r\n\r\n\t\tif( (isset($stokTuru) && !empty($stokTuru)) ||(isset($stokKodu) && !empty($stokKodu)) || (isset($tarihGet) && !empty($tarihGet))  || (isset($stokBilgisi) && !empty($stokBilgisi)) ){\r\n\r\n\r\n\r\n        if(!empty($stokTuru)){$sorgu1 = \"AND sh_turu = '$stokTuru'\";}\r\n\r\n        else{$sorgu1 = \"\";}\r\n\r\n\r\n\r\n\t\t\tif(!empty($stokKodu)){$sorgu3 = \"AND stok.stok_kodu = '$stokKodu'\";}\r\n\r\n\t\t\telse{$sorgu3 = \"\";}\r\n\r\n\r\n\r\n        if(!empty($stokBilgisi) && $stokBilgisi != \"tumu\"){\r\n\r\n    \t\t$kasaQuery = \"AND sh_stokID = '$stokBilgisi'\";\r\n\r\n    \t}\r\n\r\n\r\n\r\n    \tif(!empty($tarihGet)){$sorgu2 = \"AND sh_tarih BETWEEN '$tarih1' AND '$tarih2'\";}\r\n\r\n\t\telse{$sorgu2 = \"\";}\r\n\r\n\r\n\r\n        $sorgu = \"SELECT * FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' \".$kasaQuery.\" \".$sorgu1.\" \".$sorgu2.\" \".$sorgu3.\" ORDER BY sh_id DESC\";\r\n\r\n   \t \t}else{\r\n\r\n   \t \t\t$sorgu = \"SELECT * FROM stokHareketleri WHERE sh_olusturanAnaHesap = '$anaHesap' ORDER BY sh_id DESC\";\r\n\r\n   \t\t}\r\n\r\n\r\n\r\n   \t\t$stokHareketleri = $this->db->query($sorgu)->result();\r\n\r\n\r\n\r\n\t\t$reader = IOFactory::createReader('Xlsx');\r\n\r\n\t\t$reader->setReadDataOnly(TRUE);\r\n\r\n\t\t$spreadsheet = new Spreadsheet();\r\n\r\n\t\t\r\n\r\n\t   \t$sheet = $spreadsheet->getActiveSheet();\r\n\r\n\r\n\r\n\t   \tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarih = (new DateTime('now'))->format('d.m.Y-His');\r\n\r\n\r\n\r\n\t\t//$sheet->getStyle('A1:I1')->getFill()->setFillType(Fill::FILL_SOLID)->getStartColor()->setARGB('CCCCCC');\r\n\r\n\t\t\r\n\r\n\t\t$sheet->setCellValue('A1', 'TARİH');\r\n\r\n\t\t$sheet->setCellValue('B1', 'STOK ADI');\r\n\r\n\t\t$sheet->setCellValue('C1', 'TÜRÜ');\r\n\r\n\t\t$sheet->setCellValue('D1', 'GİRİŞ');\r\n\r\n\t\t$sheet->setCellValue('E1', 'ÇIKIŞ');\r\n\r\n\t\t$sheet->setCellValue('F1', 'BİRİM FİYAT');\r\n\r\n\t\t$sheet->setCellValue('G1', 'KDV YUZDE');\r\n\r\n\t\t$sheet->setCellValue('H1', 'KDV TL');\r\n\r\n\t\t$sheet->setCellValue('I1', 'TOPLAM FİYAT');\r\n\r\n\r\n\r\n\t\t$rows = 2;\r\n\r\n\t\tforeach($stokHareketleri as $sh){\r\n\r\n\t\t\t$tarihYeni = date('d.m.Y', strtotime($sh->sh_tarih));\r\n\r\n\r\n\r\n\t\t\t$stokID = $sh->sh_stokID;\r\n\r\n\t\t\t$stokQ = \"SELECT * FROM stok WHERE stok_id = '$stokID' AND stok_olusturanAnaHesap = '$anaHesap'\";\r\n\r\n\t\t\t$stokexe = $this->db->query($stokQ)->row();\r\n\r\n\r\n\r\n\t\t\t$turu = $sh->sh_turu;\r\n\r\n\t\t\tif($turu == 1){\r\n\r\n\t\t\t\t$turuTxt = 'Alış Faturası';\r\n\r\n\t\t\t\t$giris = number_format($sh->sh_giris,2);\r\n\r\n\t\t\t\t$cikis = '';\r\n\r\n\t\t\t}else if($turu == 2){\r\n\r\n\t\t\t\t$turuTxt = 'Satış Faturası';\r\n\r\n\t\t\t\t$giris = '';\r\n\r\n\t\t\t\t$cikis = number_format($sh->sh_cikis,2);\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t$sheet->setCellValue('A'.$rows, $tarihYeni);\r\n\r\n\t\t\t$sheet->setCellValue('B'.$rows, $stokexe->stok_ad);\r\n\r\n\t\t\t$sheet->setCellValue('C'.$rows, $turuTxt);\r\n\r\n\t\t\t$sheet->setCellValue('D'.$rows, $giris);\r\n\r\n\t\t\t$sheet->setCellValue('E'.$rows, $cikis);\r\n\r\n\t\t\t$sheet->setCellValue('F'.$rows, $sh->sh_birimFiyat);\r\n\r\n\t\t\t$sheet->setCellValue('G'.$rows, $sh->sh_kdv);\r\n\r\n\t\t\t$sheet->setCellValue('H'.$rows, $sh->sh_toplamKDV);\r\n\r\n\t\t\t$sheet->setCellValue('I'.$rows, $sh->sh_toplamFiyat);\r\n\r\n\t\t\t$rows++;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$sheet->getColumnDimension('A')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('B')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('C')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('D')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('E')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('F')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('G')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('H')->setAutoSize(true);\r\n\r\n\t\t$sheet->getColumnDimension('I')->setAutoSize(true);\r\n\r\n\r\n\r\n\t\t$writer = new Xlsx($spreadsheet);//instantiate Xlsx\r\n\r\n\t\t\t\r\n\r\n\t    $filename = 'stok-hareketleri-'.$tarih;//set filename for excel file to be exported\r\n\r\n\r\n\r\n\t    header('Content-Type: application/vnd.ms-excel');// generate excel file\r\n\r\n\t    header('Content-Disposition: attachment;filename=\"'. $filename .'.xlsx\"'); \r\n\r\n\t    header('Cache-Control: max-age=0');\r\n\r\n\t    \r\n\r\n\t\t$writer->save('php://output');//download file \r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function stok_sil()\r\n\r\n\t{\r\n\r\n\t\t$id= $this->input->get('stok_id');\r\n\r\n\t\t$data[\"stok_durum\"]=0;\r\n\r\n\t\t$this->vt->update('stok', array('stok_id'=>$id), $data);\r\n\r\n\t\t$this->session->set_flashdata('stok_sil_ok','OK');\r\n\r\n\t\tredirect(\"stok/stok-listesi\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function anonimKayit()\r\n\r\n\t{\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$cikis = postval(\"anonimMiktar\");\r\n\r\n\t\t$giris = postval(\"anonimMiktar2\");\r\n\r\n\r\n\r\n\r\n\r\n\t\tif($cikis == \"\" && $giris == \"\"){\r\n\r\n\t\t\t$this->session->set_flashdata('stok_hareket_hata','OK');\r\n\r\n\t\t\tredirect(\"stok/stokHareketleri\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"sh_turu\"]=6;\r\n\r\n\r\n\r\n\t\tif($cikis){\r\n\r\n\t\t\t$data[\"sh_cikis\"]=postval(\"anonimMiktar\");\r\n\r\n\t\t}else if($giris){\r\n\r\n\t\t\t$data[\"sh_giris\"]=postval(\"anonimMiktar2\");\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"sh_stokID\"]=postval(\"anonimStokID\");\r\n\r\n\t\t$data[\"sh_paraBirimi\"]=postval(\"anonimParaBirimi\");\r\n\r\n\t\t$data[\"sh_tarih\"]=$tarihi;\r\n\r\n\t\t$data[\"sh_birimFiyat\"]=postval(\"anonimBirimFiyat\");\r\n\r\n\t\t$data[\"sh_kdv\"]=postval(\"anonimKdv\");\r\n\r\n\t\t$data[\"sh_toplamKDV\"]=postval(\"anonimKdvHesap\");\r\n\r\n\t\t$data[\"sh_toplamFiyat\"]=postval(\"anonimToplam\");\r\n\r\n\t\t$data[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t$this->vt->insert(\"stokHareketleri\",$data);\r\n\r\n\t\t$this->session->set_flashdata('stok_hareket_kayit','OK');\r\n\r\n\t\tredirect(\"stok/stokHareketleri\");\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function anonimDuzenle()\r\n\r\n\t{\r\n\r\n\t\t$control2 = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control2->kullanici_id;\r\n\r\n\r\n\r\n\t\tdate_default_timezone_set('Europe/Istanbul');\r\n\r\n\t\t$tarihi = (new DateTime('now'))->format('Y.m.d H:i:s');\r\n\r\n\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\r\n\r\n\t\t$id=postval(\"anonimID\");\r\n\r\n\r\n\r\n\t\t$data[\"sh_turu\"]=6;\r\n\r\n\t\t$data[\"sh_cikis\"]=postval(\"anonimMiktar\");\r\n\r\n\t\t$data[\"sh_stokID\"]=postval(\"anonimStokID\");\r\n\r\n\t\t$data[\"sh_paraBirimi\"]=postval(\"anonimParaBirimi\");\r\n\r\n\t\t$data[\"sh_tarih\"]=$tarihi;\r\n\r\n\t\t$data[\"sh_birimFiyat\"]=postval(\"anonimBirimFiyat\");\r\n\r\n\t\t$data[\"sh_kdv\"]=postval(\"anonimKdv\");\r\n\r\n\t\t$data[\"sh_toplamKDV\"]=postval(\"anonimKdvHesap\");\r\n\r\n\t\t$data[\"sh_toplamFiyat\"]=postval(\"anonimToplam\");\r\n\r\n\t\t$data[\"sh_olusturan\"] = $u_id;\r\n\r\n\t\t$data[\"sh_olusturanAnaHesap\"] = $anaHesap;\r\n\r\n\t\t$data[\"sh_olusturmaTarihi\"] = $tarihi;\r\n\r\n\r\n\r\n\t\t$this->vt->update(\"stokHareketleri\",array(\"sh_id\"=>$id),$data);\r\n\r\n\t\t$this->session->set_flashdata('stok_hareket_duzenle','OK');\r\n\r\n\t\tredirect(\"stok/stokHareketleri\");\r\n\r\n\t}\r\n\t\r\n\t/**\r\n\t * Stok arama - jQuery UI Autocomplete için\r\n\t * AJAX endpoint\r\n\t */\r\n\tpublic function stokArama()\r\n\t{\r\n\t\t$term = $this->input->get('term');\r\n\t\t\r\n\t\tif (strlen($term) < 2) {\r\n\t\t\techo json_encode([]);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t$anaHesap = anaHesapBilgisi();\r\n\t\t\t\r\n\t\t\t$query = \"\r\n\t\t\t\tSELECT \r\n\t\t\t\t\tstok_id,\r\n\t\t\t\t\tstok_ad,\r\n\t\t\t\t\tstok_kodu,\r\n\t\t\t\t\tstok_satisFiyat1,\r\n\t\t\t\t\tstok_birim\r\n\t\t\t\tFROM stoklar \r\n\t\t\t\tWHERE stok_anaHesap = ? \r\n\t\t\t\tAND stok_durum = 1\r\n\t\t\t\tAND (\r\n\t\t\t\t\tstok_ad LIKE ? \r\n\t\t\t\t\tOR stok_kodu LIKE ?\r\n\t\t\t\t)\r\n\t\t\t\tORDER BY stok_ad ASC\r\n\t\t\t\tLIMIT 20\r\n\t\t\t\";\r\n\t\t\t\r\n\t\t\t$search_term = '%' . $term . '%';\r\n\t\t\t$result = $this->db->query($query, [$anaHesap, $search_term, $search_term])->result();\r\n\t\t\t\r\n\t\t\t$data = [];\r\n\t\t\tforeach ($result as $row) {\r\n\t\t\t\t$data[] = [\r\n\t\t\t\t\t'label' => $row->stok_ad . ' (' . $row->stok_kodu . ')',\r\n\t\t\t\t\t'value' => $row->stok_ad,\r\n\t\t\t\t\t'stok_id' => $row->stok_id,\r\n\t\t\t\t\t'stok_kodu' => $row->stok_kodu,\r\n\t\t\t\t\t'stok_satisFiyat1' => $row->stok_satisFiyat1,\r\n\t\t\t\t\t'stok_birim' => $row->stok_birim\r\n\t\t\t\t];\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\techo json_encode($data);\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\techo json_encode([]);\r\n\t\t}\r\n\t}\r\n\r\n\r\n\r\n}\r\n\r\n"
        }
    ]
}