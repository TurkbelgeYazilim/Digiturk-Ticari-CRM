{
    "sourceFile": "application/controllers/Voip.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 19,
            "patches": [
                {
                    "date": 1754724208108,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1754726954917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2002,39 +2002,21 @@\n \t\t}\r\n \r\n \t\t$data[\"baslik\"] = \"Voip & Hakediş / Hakediş Tanımlama\";\r\n \t\t\r\n-\t\t// Aktif numaraları getir (operator ile birlikte)\r\n-\t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n-\t\t$this->db->from('voip_numara');\r\n-\t\t$this->db->join('voip_operator', 'voip_numara.operator_id = voip_operator.operator_id', 'left');\r\n-\t\t$this->db->where('voip_numara.durum', 1); // Sadece aktif numaralar\r\n-\t\t$this->db->order_by('voip_operator.operator_adi, voip_numara.voip_numara');\r\n-\t\t$data[\"numaralar\"] = $this->db->get()->result();\r\n+\t\t// Kullanıcıları getir\r\n+\t\t$this->db->select('kullanici_id, kullanici_ad, kullanici_soyad');\r\n+\t\t$this->db->from('kullanicilar');\r\n+\t\t$this->db->where('kullanici_durum', 1); // Sadece aktif kullanıcılar\r\n+\t\t$this->db->order_by('kullanici_ad, kullanici_soyad');\r\n+\t\t$data[\"kullanicilar\"] = $this->db->get()->result();\r\n \t\t\r\n-\t\t// Günlük harcama kayıtlarını getir (son 30 gün)\r\n-\t\t$this->db->select('vgh.*, vn.voip_numara, vo.operator_adi, \r\n-\t\t\tCOALESCE(teslim_k.kullanici_ad, k.kullanici_ad) as kullanici_ad, \r\n-\t\t\tCOALESCE(teslim_k.kullanici_soyad, k.kullanici_soyad) as kullanici_soyad');\r\n-\t\t$this->db->from('voip_gunluk_harcama vgh');\r\n-\t\t$this->db->join('voip_numara vn', 'vgh.numara_id = vn.numara_id', 'left');\r\n-\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n-\t\t$this->db->join('kullanicilar k', 'vgh.kaydeden_kullanici_id = k.kullanici_id', 'left');\r\n-\t\t\r\n-\t\t// O tarihte numaranın teslim edildiği kullanıcıyı bul\r\n-\t\t$this->db->join('(SELECT vnt1.numara_id, vnt1.kullanici_id, vnt1.teslim_tarihi \r\n-\t\t\tFROM voip_numara_teslim vnt1 \r\n-\t\t\tWHERE vnt1.iade_tarihi IS NULL \r\n-\t\t\tAND vnt1.teslim_tarihi = (\r\n-\t\t\t\tSELECT MAX(vnt2.teslim_tarihi) \r\n-\t\t\t\tFROM voip_numara_teslim vnt2 \r\n-\t\t\t\tWHERE vnt2.numara_id = vnt1.numara_id \r\n-\t\t\t\tAND vnt2.iade_tarihi IS NULL\r\n-\t\t\t)) teslim_son', 'vgh.numara_id = teslim_son.numara_id AND DATE(teslim_son.teslim_tarihi) <= vgh.tarih', 'left');\r\n-\t\t$this->db->join('kullanicilar teslim_k', 'teslim_son.kullanici_id = teslim_k.kullanici_id', 'left');\r\n-\t\t$this->db->where('vgh.tarih >=', date('Y-m-d', strtotime('-30 days')));\r\n-\t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n-\t\t$data[\"harcamalar\"] = $this->db->get()->result();\r\n+\t\t// Hakediş ücret kayıtlarını getir\r\n+\t\t$this->db->select('vh.*, k.kullanici_ad, k.kullanici_soyad');\r\n+\t\t$this->db->from('voip_hakedis_ucretleri vh');\r\n+\t\t$this->db->join('kullanicilar k', 'vh.kullanici_id = k.kullanici_id', 'left');\r\n+\t\t$this->db->order_by('vh.baslangic_tarihi DESC');\r\n+\t\t$data[\"hakedis_ucretleri\"] = $this->db->get()->result();\r\n \r\n \t\t$this->load->view('voip/hakedis-tanimlama', $data);\r\n \t}\r\n \r\n@@ -2049,61 +2031,46 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$numara_id = $this->input->post('numara_id');\r\n-\t\t$tarih = $this->input->post('tarih');\r\n-\t\t$harcama_tutari = $this->input->post('harcama_tutari');\r\n+\t\t$kullanici_id = $this->input->post('kullanici_id');\r\n+\t\t$tek_neo = $this->input->post('tek_neo');\r\n+\t\t$tek_uydu = $this->input->post('tek_uydu');\r\n+\t\t$neolu_internet = $this->input->post('neolu_internet');\r\n+\t\t$uydulu_internet = $this->input->post('uydulu_internet');\r\n+\t\t$baslangic_tarihi = $this->input->post('baslangic_tarihi');\r\n+\t\t$bitis_tarihi = $this->input->post('bitis_tarihi');\r\n \t\t$aciklama = $this->input->post('aciklama');\r\n \r\n-\t\tif(empty($numara_id) || empty($tarih) || empty($harcama_tutari)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Numara, tarih ve harcama tutarı gereklidir']);\r\n+\t\tif(empty($kullanici_id) || empty($baslangic_tarihi)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Kullanıcı ve başlangıç tarihi gereklidir']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n \t\t// Tutar kontrolü\r\n-\t\tif(!is_numeric($harcama_tutari) || $harcama_tutari < 0) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Harcama tutarı geçerli bir sayı olmalıdır']);\r\n-\t\t\treturn;\r\n+\t\t$tutarlar = [$tek_neo, $tek_uydu, $neolu_internet, $uydulu_internet];\r\n+\t\tforeach($tutarlar as $tutar) {\r\n+\t\t\tif(!empty($tutar) && (!is_numeric($tutar) || $tutar < 0)) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Ücret tutarları geçerli sayı olmalıdır']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n \t\t}\r\n \r\n-\t\t// Session bilgisini güvenli şekilde al\r\n-\t\t$login_info = session(\"r\", \"login_info\");\r\n-\t\t$kullanici_id = null;\r\n-\t\tif(is_object($login_info) && isset($login_info->kullanici_id)) {\r\n-\t\t\t$kullanici_id = $login_info->kullanici_id;\r\n-\t\t} elseif(is_array($login_info) && isset($login_info['kullanici_id'])) {\r\n-\t\t\t$kullanici_id = $login_info['kullanici_id'];\r\n-\t\t}\r\n-\r\n-\t\t// Aynı numara ve tarih için kayıt var mı kontrol et\r\n-\t\t$existing = $this->db->get_where('voip_gunluk_harcama', [\r\n-\t\t\t'numara_id' => $numara_id,\r\n-\t\t\t'tarih' => $tarih\r\n-\t\t])->row();\r\n-\r\n \t\t$data = [\r\n-\t\t\t'numara_id' => $numara_id,\r\n-\t\t\t'tarih' => $tarih,\r\n-\t\t\t'harcama_tutari' => number_format($harcama_tutari, 2, '.', ''),\r\n-\t\t\t'aciklama' => trim($aciklama),\r\n-\t\t\t'kaydeden_kullanici_id' => $kullanici_id\r\n+\t\t\t'kullanici_id' => $kullanici_id,\r\n+\t\t\t'tek_neo' => !empty($tek_neo) ? number_format($tek_neo, 2, '.', '') : null,\r\n+\t\t\t'tek_uydu' => !empty($tek_uydu) ? number_format($tek_uydu, 2, '.', '') : null,\r\n+\t\t\t'neolu_internet' => !empty($neolu_internet) ? number_format($neolu_internet, 2, '.', '') : null,\r\n+\t\t\t'uydulu_internet' => !empty($uydulu_internet) ? number_format($uydulu_internet, 2, '.', '') : null,\r\n+\t\t\t'baslangic_tarihi' => $baslangic_tarihi,\r\n+\t\t\t'bitis_tarihi' => !empty($bitis_tarihi) ? $bitis_tarihi : null,\r\n+\t\t\t'aciklama' => trim($aciklama)\r\n \t\t];\r\n \r\n-\t\tif($existing) {\r\n-\t\t\t// Eğer kayıt varsa güncelle\r\n-\t\t\tif($this->db->update('voip_gunluk_harcama', $data, ['harcama_id' => $existing->harcama_id])) {\r\n-\t\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla güncellendi']);\r\n-\t\t\t} else {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n-\t\t\t}\r\n+\t\tif($this->db->insert('voip_hakedis_ucretleri', $data)) {\r\n+\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş ücreti başarıyla eklendi']);\r\n \t\t} else {\r\n-\t\t\t// Eğer kayıt yoksa yeni ekle\r\n-\t\t\tif($this->db->insert('voip_gunluk_harcama', $data)) {\r\n-\t\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla eklendi']);\r\n-\t\t\t} else {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n-\t\t\t}\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n \t\t}\r\n \t}\r\n \r\n \t/**\r\n@@ -2117,17 +2084,17 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$harcama_id = $this->input->post('harcama_id');\r\n+\t\t$id = $this->input->post('id');\r\n \r\n-\t\tif(empty($harcama_id)) {\r\n+\t\tif(empty($id)) {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ID gereklidir']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\tif($this->db->delete('voip_gunluk_harcama', ['harcama_id' => $harcama_id])) {\r\n-\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla silindi']);\r\n+\t\tif($this->db->delete('voip_hakedis_ucretleri', ['id' => $id])) {\r\n+\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş ücreti başarıyla silindi']);\r\n \t\t} else {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n \t\t}\r\n \t}\r\n@@ -2143,41 +2110,45 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$harcama_id = $this->input->post('harcama_id');\r\n-\t\t$numara_id = $this->input->post('numara_id');\r\n-\t\t$tarih = $this->input->post('tarih');\r\n-\t\t$harcama_tutari = $this->input->post('harcama_tutari');\r\n+\t\t$id = $this->input->post('id');\r\n+\t\t$kullanici_id = $this->input->post('kullanici_id');\r\n+\t\t$tek_neo = $this->input->post('tek_neo');\r\n+\t\t$tek_uydu = $this->input->post('tek_uydu');\r\n+\t\t$neolu_internet = $this->input->post('neolu_internet');\r\n+\t\t$uydulu_internet = $this->input->post('uydulu_internet');\r\n+\t\t$baslangic_tarihi = $this->input->post('baslangic_tarihi');\r\n+\t\t$bitis_tarihi = $this->input->post('bitis_tarihi');\r\n \t\t$aciklama = $this->input->post('aciklama');\r\n \r\n-\t\tif(empty($harcama_id) || empty($numara_id) || empty($tarih) || empty($harcama_tutari)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ID, numara, tarih ve harcama tutarı gereklidir']);\r\n+\t\tif(empty($id) || empty($kullanici_id) || empty($baslangic_tarihi)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'ID, kullanıcı ve başlangıç tarihi gereklidir']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n \t\t// Tutar kontrolü\r\n-\t\tif(!is_numeric($harcama_tutari) || $harcama_tutari < 0) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Harcama tutarı geçerli bir sayı olmalıdır']);\r\n-\t\t\treturn;\r\n+\t\t$tutarlar = [$tek_neo, $tek_uydu, $neolu_internet, $uydulu_internet];\r\n+\t\tforeach($tutarlar as $tutar) {\r\n+\t\t\tif(!empty($tutar) && (!is_numeric($tutar) || $tutar < 0)) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Ücret tutarları geçerli sayı olmalıdır']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n \t\t}\r\n \r\n-\t\t// Aynı numara ve tarih için başka kayıt var mı kontrol et\r\n-\t\t$existing = $this->db->query(\"SELECT * FROM voip_gunluk_harcama WHERE numara_id = ? AND tarih = ? AND harcama_id != ?\", [$numara_id, $tarih, $harcama_id])->row();\r\n-\t\tif($existing) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara için bu tarihte zaten başka hakediş kaydı var']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n \t\t$data = [\r\n-\t\t\t'numara_id' => $numara_id,\r\n-\t\t\t'tarih' => $tarih,\r\n-\t\t\t'harcama_tutari' => number_format($harcama_tutari, 2, '.', ''),\r\n+\t\t\t'kullanici_id' => $kullanici_id,\r\n+\t\t\t'tek_neo' => !empty($tek_neo) ? number_format($tek_neo, 2, '.', '') : null,\r\n+\t\t\t'tek_uydu' => !empty($tek_uydu) ? number_format($tek_uydu, 2, '.', '') : null,\r\n+\t\t\t'neolu_internet' => !empty($neolu_internet) ? number_format($neolu_internet, 2, '.', '') : null,\r\n+\t\t\t'uydulu_internet' => !empty($uydulu_internet) ? number_format($uydulu_internet, 2, '.', '') : null,\r\n+\t\t\t'baslangic_tarihi' => $baslangic_tarihi,\r\n+\t\t\t'bitis_tarihi' => !empty($bitis_tarihi) ? $bitis_tarihi : null,\r\n \t\t\t'aciklama' => trim($aciklama)\r\n \t\t];\r\n \r\n-\t\tif($this->db->update('voip_gunluk_harcama', $data, ['harcama_id' => $harcama_id])) {\r\n-\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla güncellendi']);\r\n+\t\tif($this->db->update('voip_hakedis_ucretleri', $data, ['id' => $id])) {\r\n+\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş ücreti başarıyla güncellendi']);\r\n \t\t} else {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n \t\t}\r\n \t}\r\n@@ -2193,26 +2164,26 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$harcama_id = $this->input->post('harcama_id');\r\n+\t\t$id = $this->input->post('id');\r\n \r\n-\t\tif(empty($harcama_id)) {\r\n+\t\tif(empty($id)) {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ID gereklidir']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$harcama = $this->db->get_where('voip_gunluk_harcama', ['harcama_id' => $harcama_id])->row();\r\n+\t\t$hakedis = $this->db->get_where('voip_hakedis_ucretleri', ['id' => $id])->row();\r\n \r\n-\t\tif($harcama) {\r\n-\t\t\techo json_encode(['success' => true, 'data' => $harcama]);\r\n+\t\tif($hakedis) {\r\n+\t\t\techo json_encode(['success' => true, 'data' => $hakedis]);\r\n \t\t} else {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş kaydı bulunamadı']);\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ücreti bulunamadı']);\r\n \t\t}\r\n \t}\r\n \r\n \t/**\r\n-\t * Hakediş Raporu (AJAX) - Tarih aralığına göre filtreleme\r\n+\t * Hakediş Raporu (AJAX) - Kullanıcı ve tarih aralığına göre filtreleme\r\n \t */\r\n \tpublic function hakedis_raporu(){\r\n \t\t// Content-Type header ayarla\r\n \t\theader('Content-Type: application/json');\r\n@@ -2221,57 +2192,35 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$baslangic_tarihi = $this->input->post('baslangic_tarihi');\r\n-\t\t$bitis_tarihi = $this->input->post('bitis_tarihi');\r\n-\t\t$numara_id = $this->input->post('numara_id'); // Opsiyonel, belirli numara filtresi\r\n+\t\t$kullanici_id = $this->input->post('kullanici_id'); // Opsiyonel\r\n+\t\t$baslangic_tarihi = $this->input->post('baslangic_tarihi'); // Opsiyonel\r\n+\t\t$bitis_tarihi = $this->input->post('bitis_tarihi'); // Opsiyonel\r\n \r\n-\t\tif(empty($baslangic_tarihi) || empty($bitis_tarihi)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Başlangıç ve bitiş tarihi gereklidir']);\r\n-\t\t\treturn;\r\n+\t\t$this->db->select('vh.*, k.kullanici_ad, k.kullanici_soyad');\r\n+\t\t$this->db->from('voip_hakedis_ucretleri vh');\r\n+\t\t$this->db->join('kullanicilar k', 'vh.kullanici_id = k.kullanici_id', 'left');\r\n+\t\t\r\n+\t\tif(!empty($kullanici_id)) {\r\n+\t\t\t$this->db->where('vh.kullanici_id', $kullanici_id);\r\n \t\t}\r\n-\r\n-\t\t$this->db->select('vgh.*, vn.voip_numara, vo.operator_adi, \r\n-\t\t\tCOALESCE(teslim_k.kullanici_ad, k.kullanici_ad) as kullanici_ad, \r\n-\t\t\tCOALESCE(teslim_k.kullanici_soyad, k.kullanici_soyad) as kullanici_soyad');\r\n-\t\t$this->db->from('voip_gunluk_harcama vgh');\r\n-\t\t$this->db->join('voip_numara vn', 'vgh.numara_id = vn.numara_id', 'left');\r\n-\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n-\t\t$this->db->join('kullanicilar k', 'vgh.kaydeden_kullanici_id = k.kullanici_id', 'left');\r\n \t\t\r\n-\t\t// O tarihte numaranın teslim edildiği kullanıcıyı bul\r\n-\t\t$this->db->join('(SELECT vnt1.numara_id, vnt1.kullanici_id, vnt1.teslim_tarihi \r\n-\t\t\tFROM voip_numara_teslim vnt1 \r\n-\t\t\tWHERE vnt1.iade_tarihi IS NULL \r\n-\t\t\tAND vnt1.teslim_tarihi = (\r\n-\t\t\t\tSELECT MAX(vnt2.teslim_tarihi) \r\n-\t\t\t\tFROM voip_numara_teslim vnt2 \r\n-\t\t\t\tWHERE vnt2.numara_id = vnt1.numara_id \r\n-\t\t\t\tAND vnt2.iade_tarihi IS NULL\r\n-\t\t\t)) teslim_son', 'vgh.numara_id = teslim_son.numara_id AND DATE(teslim_son.teslim_tarihi) <= vgh.tarih', 'left');\r\n-\t\t$this->db->join('kullanicilar teslim_k', 'teslim_son.kullanici_id = teslim_k.kullanici_id', 'left');\r\n-\t\t$this->db->where('vgh.tarih >=', $baslangic_tarihi);\r\n-\t\t$this->db->where('vgh.tarih <=', $bitis_tarihi);\r\n+\t\tif(!empty($baslangic_tarihi)) {\r\n+\t\t\t$this->db->where('vh.baslangic_tarihi >=', $baslangic_tarihi);\r\n+\t\t}\r\n \t\t\r\n-\t\tif(!empty($numara_id)) {\r\n-\t\t\t$this->db->where('vgh.numara_id', $numara_id);\r\n+\t\tif(!empty($bitis_tarihi)) {\r\n+\t\t\t$this->db->where('(vh.bitis_tarihi <= ? OR vh.bitis_tarihi IS NULL)', $bitis_tarihi);\r\n \t\t}\r\n \t\t\r\n-\t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n-\t\t$harcamalar = $this->db->get()->result();\r\n+\t\t$this->db->order_by('vh.baslangic_tarihi DESC');\r\n+\t\t$hakedis_ucretleri = $this->db->get()->result();\r\n \r\n-\t\t// Toplam harcama hesapla\r\n-\t\t$toplam = 0;\r\n-\t\tforeach($harcamalar as $harcama) {\r\n-\t\t\t$toplam += $harcama->harcama_tutari;\r\n-\t\t}\r\n-\r\n \t\techo json_encode([\r\n \t\t\t'success' => true, \r\n-\t\t\t'data' => $harcamalar,\r\n-\t\t\t'toplam' => number_format($toplam, 2, '.', ''),\r\n-\t\t\t'kayit_sayisi' => count($harcamalar)\r\n+\t\t\t'data' => $hakedis_ucretleri,\r\n+\t\t\t'kayit_sayisi' => count($hakedis_ucretleri)\r\n \t\t]);\r\n \t}\r\n \r\n }\r\n"
                },
                {
                    "date": 1754741006359,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2222,6 +2222,268 @@\n \t\t\t'kayit_sayisi' => count($hakedis_ucretleri)\r\n \t\t]);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Hakediş İris Rapor Sayfası (ID:1906)\r\n+\t * URL: https://crm.ilekasoft.com/voip/hakedis-iris-rapor\r\n+\t */\r\n+\tpublic function hakedis_iris_rapor(){\r\n+\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n+\t\tif(!grup_modul_yetkisi_var(1900)){\r\n+\t\t\t$this->session->set_flashdata('error', 'Bu modüle erişim yetkiniz bulunmamaktadır.');\r\n+\t\t\tredirect('home');\r\n+\t\t}\r\n+\r\n+\t\t// Hakediş İris Rapor (ID:1906) yetkisi kontrolü  \r\n+\t\tif(!grup_modul_yetkisi_var(1906)){\r\n+\t\t\t$this->session->set_flashdata('error', 'Bu sayfaya erişim yetkiniz bulunmamaktadır.');\r\n+\t\t\tredirect('voip/operator-tanimla');\r\n+\t\t}\r\n+\r\n+\t\t$data['title'] = 'Hakediş İris Rapor';\r\n+\t\t$data['h1'] = 'Hakediş İris Rapor';\r\n+\r\n+\t\t// Mevcut veriler için sayfa numarası ve limit\r\n+\t\t$page = (int) $this->input->get('page') ?: 1;\r\n+\t\t$limit = 50;\r\n+\t\t$offset = ($page - 1) * $limit;\r\n+\r\n+\t\t// Filtreleme parametreleri\r\n+\t\t$filters = [\r\n+\t\t\t'baslangic_tarihi' => $this->input->get('baslangic_tarihi'),\r\n+\t\t\t'bitis_tarihi' => $this->input->get('bitis_tarihi'),\r\n+\t\t\t'talep_id' => $this->input->get('talep_id'),\r\n+\t\t\t'memo_id' => $this->input->get('memo_id'),\r\n+\t\t\t'dt_musteri_no' => $this->input->get('dt_musteri_no'),\r\n+\t\t\t'satis_durumu' => $this->input->get('satis_durumu')\r\n+\t\t];\r\n+\r\n+\t\t// Toplam kayıt sayısını al\r\n+\t\t$this->db->from('voip_iris_rapor');\r\n+\t\t$this->apply_iris_filters($filters);\r\n+\t\t$total_records = $this->db->count_all_results();\r\n+\r\n+\t\t// Verileri al\r\n+\t\t$this->db->from('voip_iris_rapor');\r\n+\t\t$this->apply_iris_filters($filters);\r\n+\t\t$this->db->limit($limit, $offset);\r\n+\t\t$this->db->order_by('kayit_tarihi', 'DESC');\r\n+\t\t$data['rapor_verileri'] = $this->db->get()->result();\r\n+\r\n+\t\t// Pagination\r\n+\t\t$data['pagination'] = [\r\n+\t\t\t'current_page' => $page,\r\n+\t\t\t'total_pages' => ceil($total_records / $limit),\r\n+\t\t\t'total_records' => $total_records,\r\n+\t\t\t'per_page' => $limit\r\n+\t\t];\r\n+\r\n+\t\t$data['filters'] = $filters;\r\n+\r\n+\t\t$this->load->view('voip/hakedis-iris-rapor', $data);\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * İris Rapor CSV Yükleme İşlemi\r\n+\t */\r\n+\tpublic function iris_rapor_yukle(){\r\n+\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n+\t\tif(!grup_modul_yetkisi_var(1900)){\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Bu modüle erişim yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Hakediş İris Rapor (ID:1906) yetkisi kontrolü  \r\n+\t\tif(!grup_modul_yetkisi_var(1906)){\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Bu sayfaya erişim yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\tif (!isset($_FILES['csv_file']) || $_FILES['csv_file']['error'] !== UPLOAD_ERR_OK) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Dosya yüklenirken hata oluştu.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t$file_tmp = $_FILES['csv_file']['tmp_name'];\r\n+\t\t$file_name = $_FILES['csv_file']['name'];\r\n+\t\t$file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));\r\n+\r\n+\t\t// Dosya uzantısı kontrolü\r\n+\t\tif ($file_ext !== 'csv') {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Sadece CSV dosyaları kabul edilir.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// CSV dosyasını oku\r\n+\t\t$handle = fopen($file_tmp, 'r');\r\n+\t\tif (!$handle) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Dosya okunamadı.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t$header = fgetcsv($handle, 0, ';'); // İlk satır başlık\r\n+\t\t$inserted = 0;\r\n+\t\t$updated = 0;\r\n+\t\t$errors = [];\r\n+\r\n+\t\t// Transaction başlat\r\n+\t\t$this->db->trans_start();\r\n+\r\n+\t\twhile (($row = fgetcsv($handle, 0, ';')) !== FALSE) {\r\n+\t\t\tif (count($row) < count($header)) {\r\n+\t\t\t\tcontinue; // Eksik sütunlu satırları atla\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Satır verilerini başlıklarla eşleştir\r\n+\t\t\t$data = array_combine($header, $row);\r\n+\r\n+\t\t\t// Veri temizleme ve dönüştürme\r\n+\t\t\t$insert_data = [\r\n+\t\t\t\t'talep_id' => trim($data['TALEP_ID']),\r\n+\t\t\t\t'talep_turu' => trim($data['TALEP_TURU']),\r\n+\t\t\t\t'uydu_basvuru_potansiyel_no' => trim($data['UYDU_BASVURU_POTANSIYEL_NO']),\r\n+\t\t\t\t'uydu_basvuru_uye_no' => trim($data['UYDU_BASVURU_UYE_NO']),\r\n+\t\t\t\t'dt_musteri_no' => trim($data['DT_MUSTERI_NO']),\r\n+\t\t\t\t'memo_id' => trim($data['MEMO_ID']),\r\n+\t\t\t\t'memo_kayit_tipi' => trim($data['MEMO_KAYIT_TIPI']),\r\n+\t\t\t\t'memo_id_tip' => trim($data['MEMO_ID_TIP']),\r\n+\t\t\t\t'memo_kodu' => trim($data['MEMO_KODU']),\r\n+\t\t\t\t'memo_kapanis_tarihi' => $this->convert_date($data['MEMO_KAPANIS_TARIHI']),\r\n+\t\t\t\t'memo_yonlenen_bayi_kodu' => trim($data['MEMO_YONLENEN_BAYI_KODU']),\r\n+\t\t\t\t'memo_yonlenen_bayi_adi' => trim($data['MEMO_YONLENEN_BAYI_ADI']),\r\n+\t\t\t\t'memo_yonlenen_bayi_yoneticisi' => trim($data['MEMO_YONLENEN_BAYI_YONETICISI']),\r\n+\t\t\t\t'memo_yonlenen_bayi_bolge' => trim($data['MEMO_YONLENEN_BAYI_BOLGE']),\r\n+\t\t\t\t'memo_yonlenen_bayi_teknik_yntc' => trim($data['MEMO_YONLENEN_BAYI_TEKNIK_YNTC']),\r\n+\t\t\t\t'talep_giris_tarihi' => $this->convert_date($data['TALEP_GIRIS_TARIHI']),\r\n+\t\t\t\t'talebi_giren_bayi_kodu' => trim($data['TALEBI_GIREN_BAYI_KODU']),\r\n+\t\t\t\t'talebi_giren_bayi_adi' => trim($data['TALEBI_GIREN_BAYI_ADI']),\r\n+\t\t\t\t'talebi_giren_personel' => trim($data['TALEBI_GIREN_PERSONEL']),\r\n+\t\t\t\t'talebi_giren_personelno' => trim($data['TALEBI_GIREN_PERSONELNO']),\r\n+\t\t\t\t'talebi_giren_personelkodu' => trim($data['TALEBI_GIREN_PERSONELKODU']),\r\n+\t\t\t\t'talebi_giren_personel_altbayi' => trim($data['TALEBI_GIREN_PERSONEL_ALTBAYI']),\r\n+\t\t\t\t'talep_kaynak' => trim($data['TALEP_KAYNAK']),\r\n+\t\t\t\t'satis_durumu' => trim($data['SATIS_DURUMU']),\r\n+\t\t\t\t'internet_surec_durumu' => trim($data['INTERNET_SUREC_DURUMU']),\r\n+\t\t\t\t'aktive_edilen_uyeno' => trim($data['AKTIVE_EDILEN_UYENO']),\r\n+\t\t\t\t'aktive_edilen_outletno' => trim($data['AKTIVE_EDILEN_OUTLETNO']),\r\n+\t\t\t\t'aktive_edilen_sozlesmeno' => trim($data['AKTIVE_EDILEN_SOZLESMENO']),\r\n+\t\t\t\t'aktive_edilen_sozlesmekmp' => trim($data['AKTIVE_EDILEN_SOZLESMEKMP']),\r\n+\t\t\t\t'aktive_edilen_sozlesmedurum' => trim($data['AKTIVE_EDILEN_SOZLESMEDURUM']),\r\n+\t\t\t\t'talep_takip_notu' => trim($data['TALEP_TAKIP_NOTU']),\r\n+\t\t\t\t'guncel_outlet_durum' => trim($data['GUNCEL_OUTLET_DURUM']),\r\n+\t\t\t\t'teyit_durum' => trim($data['TEYIT_DURUM']),\r\n+\t\t\t\t'teyit_arama_durum' => trim($data['TEYIT_ARAMA_DURUM']),\r\n+\t\t\t\t'randevu_tarihi' => $this->convert_date($data['RANDEVU_TARIHI']),\r\n+\t\t\t\t'memo_son_durum' => trim($data['MEMO_SON_DURUM']),\r\n+\t\t\t\t'memo_son_cevap' => trim($data['MEMO_SON_CEVAP']),\r\n+\t\t\t\t'memo_son_aciklama' => trim($data['MEMO_SON_ACIKLAMA'])\r\n+\t\t\t];\r\n+\r\n+\t\t\t// Boş değerleri NULL yap\r\n+\t\t\tforeach ($insert_data as $key => $value) {\r\n+\t\t\t\tif ($value === '' || $value === null) {\r\n+\t\t\t\t\t$insert_data[$key] = null;\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\r\n+\t\t\ttry {\r\n+\t\t\t\t// Var olan kaydı kontrol et (talep_id ile)\r\n+\t\t\t\t$existing = $this->db->get_where('voip_iris_rapor', ['talep_id' => $insert_data['talep_id']])->row();\r\n+\t\t\t\t\r\n+\t\t\t\tif ($existing) {\r\n+\t\t\t\t\t// Güncelle\r\n+\t\t\t\t\t$this->db->where('talep_id', $insert_data['talep_id']);\r\n+\t\t\t\t\tif ($this->db->update('voip_iris_rapor', $insert_data)) {\r\n+\t\t\t\t\t\t$updated++;\r\n+\t\t\t\t\t}\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t// Yeni kayıt ekle\r\n+\t\t\t\t\tif ($this->db->insert('voip_iris_rapor', $insert_data)) {\r\n+\t\t\t\t\t\t$inserted++;\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t} catch (Exception $e) {\r\n+\t\t\t\t$errors[] = \"Satır işlenirken hata: \" . $e->getMessage();\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n+\t\tfclose($handle);\r\n+\r\n+\t\t// Transaction bitir\r\n+\t\t$this->db->trans_complete();\r\n+\r\n+\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false, \r\n+\t\t\t\t'message' => 'Veritabanı işlemi başarısız.',\r\n+\t\t\t\t'errors' => $errors\r\n+\t\t\t]);\r\n+\t\t} else {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true, \r\n+\t\t\t\t'message' => \"İşlem tamamlandı. $inserted yeni kayıt eklendi, $updated kayıt güncellendi.\",\r\n+\t\t\t\t'inserted' => $inserted,\r\n+\t\t\t\t'updated' => $updated,\r\n+\t\t\t\t'errors' => $errors\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * Tarih formatını dönüştür (d.m.Y H:i -> Y-m-d H:i:s)\r\n+\t */\r\n+\tprivate function convert_date($date_str) {\r\n+\t\tif (empty(trim($date_str))) {\r\n+\t\t\treturn null;\r\n+\t\t}\r\n+\r\n+\t\ttry {\r\n+\t\t\t// Türkçe tarih formatını MySQL formatına çevir\r\n+\t\t\t$date = DateTime::createFromFormat('d.m.Y H:i', trim($date_str));\r\n+\t\t\tif ($date) {\r\n+\t\t\t\treturn $date->format('Y-m-d H:i:s');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Alternatif format dene\r\n+\t\t\t$date = DateTime::createFromFormat('d.m.Y', trim($date_str));\r\n+\t\t\tif ($date) {\r\n+\t\t\t\treturn $date->format('Y-m-d H:i:s');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\treturn null;\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\treturn null;\r\n+\t\t}\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * İris rapor filtrelerini uygula\r\n+\t */\r\n+\tprivate function apply_iris_filters($filters) {\r\n+\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n+\t\t\t$this->db->where('DATE(kayit_tarihi) >=', $filters['baslangic_tarihi']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['bitis_tarihi'])) {\r\n+\t\t\t$this->db->where('DATE(kayit_tarihi) <=', $filters['bitis_tarihi']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['talep_id'])) {\r\n+\t\t\t$this->db->like('talep_id', $filters['talep_id']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['memo_id'])) {\r\n+\t\t\t$this->db->like('memo_id', $filters['memo_id']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['dt_musteri_no'])) {\r\n+\t\t\t$this->db->like('dt_musteri_no', $filters['dt_musteri_no']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['satis_durumu'])) {\r\n+\t\t\t$this->db->like('satis_durumu', $filters['satis_durumu']);\r\n+\t\t}\r\n+\t}\r\n+\r\n }\r\n \r\n"
                },
                {
                    "date": 1754741316993,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2222,268 +2222,6 @@\n \t\t\t'kayit_sayisi' => count($hakedis_ucretleri)\r\n \t\t]);\r\n \t}\r\n \r\n-\t/**\r\n-\t * Hakediş İris Rapor Sayfası (ID:1906)\r\n-\t * URL: https://crm.ilekasoft.com/voip/hakedis-iris-rapor\r\n-\t */\r\n-\tpublic function hakedis_iris_rapor(){\r\n-\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n-\t\tif(!grup_modul_yetkisi_var(1900)){\r\n-\t\t\t$this->session->set_flashdata('error', 'Bu modüle erişim yetkiniz bulunmamaktadır.');\r\n-\t\t\tredirect('home');\r\n-\t\t}\r\n-\r\n-\t\t// Hakediş İris Rapor (ID:1906) yetkisi kontrolü  \r\n-\t\tif(!grup_modul_yetkisi_var(1906)){\r\n-\t\t\t$this->session->set_flashdata('error', 'Bu sayfaya erişim yetkiniz bulunmamaktadır.');\r\n-\t\t\tredirect('voip/operator-tanimla');\r\n-\t\t}\r\n-\r\n-\t\t$data['title'] = 'Hakediş İris Rapor';\r\n-\t\t$data['h1'] = 'Hakediş İris Rapor';\r\n-\r\n-\t\t// Mevcut veriler için sayfa numarası ve limit\r\n-\t\t$page = (int) $this->input->get('page') ?: 1;\r\n-\t\t$limit = 50;\r\n-\t\t$offset = ($page - 1) * $limit;\r\n-\r\n-\t\t// Filtreleme parametreleri\r\n-\t\t$filters = [\r\n-\t\t\t'baslangic_tarihi' => $this->input->get('baslangic_tarihi'),\r\n-\t\t\t'bitis_tarihi' => $this->input->get('bitis_tarihi'),\r\n-\t\t\t'talep_id' => $this->input->get('talep_id'),\r\n-\t\t\t'memo_id' => $this->input->get('memo_id'),\r\n-\t\t\t'dt_musteri_no' => $this->input->get('dt_musteri_no'),\r\n-\t\t\t'satis_durumu' => $this->input->get('satis_durumu')\r\n-\t\t];\r\n-\r\n-\t\t// Toplam kayıt sayısını al\r\n-\t\t$this->db->from('voip_iris_rapor');\r\n-\t\t$this->apply_iris_filters($filters);\r\n-\t\t$total_records = $this->db->count_all_results();\r\n-\r\n-\t\t// Verileri al\r\n-\t\t$this->db->from('voip_iris_rapor');\r\n-\t\t$this->apply_iris_filters($filters);\r\n-\t\t$this->db->limit($limit, $offset);\r\n-\t\t$this->db->order_by('kayit_tarihi', 'DESC');\r\n-\t\t$data['rapor_verileri'] = $this->db->get()->result();\r\n-\r\n-\t\t// Pagination\r\n-\t\t$data['pagination'] = [\r\n-\t\t\t'current_page' => $page,\r\n-\t\t\t'total_pages' => ceil($total_records / $limit),\r\n-\t\t\t'total_records' => $total_records,\r\n-\t\t\t'per_page' => $limit\r\n-\t\t];\r\n-\r\n-\t\t$data['filters'] = $filters;\r\n-\r\n-\t\t$this->load->view('voip/hakedis-iris-rapor', $data);\r\n-\t}\r\n-\r\n-\t/**\r\n-\t * İris Rapor CSV Yükleme İşlemi\r\n-\t */\r\n-\tpublic function iris_rapor_yukle(){\r\n-\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n-\t\tif(!grup_modul_yetkisi_var(1900)){\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Bu modüle erişim yetkiniz bulunmamaktadır.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t// Hakediş İris Rapor (ID:1906) yetkisi kontrolü  \r\n-\t\tif(!grup_modul_yetkisi_var(1906)){\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Bu sayfaya erişim yetkiniz bulunmamaktadır.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\tif (!isset($_FILES['csv_file']) || $_FILES['csv_file']['error'] !== UPLOAD_ERR_OK) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Dosya yüklenirken hata oluştu.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t$file_tmp = $_FILES['csv_file']['tmp_name'];\r\n-\t\t$file_name = $_FILES['csv_file']['name'];\r\n-\t\t$file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));\r\n-\r\n-\t\t// Dosya uzantısı kontrolü\r\n-\t\tif ($file_ext !== 'csv') {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Sadece CSV dosyaları kabul edilir.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t// CSV dosyasını oku\r\n-\t\t$handle = fopen($file_tmp, 'r');\r\n-\t\tif (!$handle) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Dosya okunamadı.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t$header = fgetcsv($handle, 0, ';'); // İlk satır başlık\r\n-\t\t$inserted = 0;\r\n-\t\t$updated = 0;\r\n-\t\t$errors = [];\r\n-\r\n-\t\t// Transaction başlat\r\n-\t\t$this->db->trans_start();\r\n-\r\n-\t\twhile (($row = fgetcsv($handle, 0, ';')) !== FALSE) {\r\n-\t\t\tif (count($row) < count($header)) {\r\n-\t\t\t\tcontinue; // Eksik sütunlu satırları atla\r\n-\t\t\t}\r\n-\r\n-\t\t\t// Satır verilerini başlıklarla eşleştir\r\n-\t\t\t$data = array_combine($header, $row);\r\n-\r\n-\t\t\t// Veri temizleme ve dönüştürme\r\n-\t\t\t$insert_data = [\r\n-\t\t\t\t'talep_id' => trim($data['TALEP_ID']),\r\n-\t\t\t\t'talep_turu' => trim($data['TALEP_TURU']),\r\n-\t\t\t\t'uydu_basvuru_potansiyel_no' => trim($data['UYDU_BASVURU_POTANSIYEL_NO']),\r\n-\t\t\t\t'uydu_basvuru_uye_no' => trim($data['UYDU_BASVURU_UYE_NO']),\r\n-\t\t\t\t'dt_musteri_no' => trim($data['DT_MUSTERI_NO']),\r\n-\t\t\t\t'memo_id' => trim($data['MEMO_ID']),\r\n-\t\t\t\t'memo_kayit_tipi' => trim($data['MEMO_KAYIT_TIPI']),\r\n-\t\t\t\t'memo_id_tip' => trim($data['MEMO_ID_TIP']),\r\n-\t\t\t\t'memo_kodu' => trim($data['MEMO_KODU']),\r\n-\t\t\t\t'memo_kapanis_tarihi' => $this->convert_date($data['MEMO_KAPANIS_TARIHI']),\r\n-\t\t\t\t'memo_yonlenen_bayi_kodu' => trim($data['MEMO_YONLENEN_BAYI_KODU']),\r\n-\t\t\t\t'memo_yonlenen_bayi_adi' => trim($data['MEMO_YONLENEN_BAYI_ADI']),\r\n-\t\t\t\t'memo_yonlenen_bayi_yoneticisi' => trim($data['MEMO_YONLENEN_BAYI_YONETICISI']),\r\n-\t\t\t\t'memo_yonlenen_bayi_bolge' => trim($data['MEMO_YONLENEN_BAYI_BOLGE']),\r\n-\t\t\t\t'memo_yonlenen_bayi_teknik_yntc' => trim($data['MEMO_YONLENEN_BAYI_TEKNIK_YNTC']),\r\n-\t\t\t\t'talep_giris_tarihi' => $this->convert_date($data['TALEP_GIRIS_TARIHI']),\r\n-\t\t\t\t'talebi_giren_bayi_kodu' => trim($data['TALEBI_GIREN_BAYI_KODU']),\r\n-\t\t\t\t'talebi_giren_bayi_adi' => trim($data['TALEBI_GIREN_BAYI_ADI']),\r\n-\t\t\t\t'talebi_giren_personel' => trim($data['TALEBI_GIREN_PERSONEL']),\r\n-\t\t\t\t'talebi_giren_personelno' => trim($data['TALEBI_GIREN_PERSONELNO']),\r\n-\t\t\t\t'talebi_giren_personelkodu' => trim($data['TALEBI_GIREN_PERSONELKODU']),\r\n-\t\t\t\t'talebi_giren_personel_altbayi' => trim($data['TALEBI_GIREN_PERSONEL_ALTBAYI']),\r\n-\t\t\t\t'talep_kaynak' => trim($data['TALEP_KAYNAK']),\r\n-\t\t\t\t'satis_durumu' => trim($data['SATIS_DURUMU']),\r\n-\t\t\t\t'internet_surec_durumu' => trim($data['INTERNET_SUREC_DURUMU']),\r\n-\t\t\t\t'aktive_edilen_uyeno' => trim($data['AKTIVE_EDILEN_UYENO']),\r\n-\t\t\t\t'aktive_edilen_outletno' => trim($data['AKTIVE_EDILEN_OUTLETNO']),\r\n-\t\t\t\t'aktive_edilen_sozlesmeno' => trim($data['AKTIVE_EDILEN_SOZLESMENO']),\r\n-\t\t\t\t'aktive_edilen_sozlesmekmp' => trim($data['AKTIVE_EDILEN_SOZLESMEKMP']),\r\n-\t\t\t\t'aktive_edilen_sozlesmedurum' => trim($data['AKTIVE_EDILEN_SOZLESMEDURUM']),\r\n-\t\t\t\t'talep_takip_notu' => trim($data['TALEP_TAKIP_NOTU']),\r\n-\t\t\t\t'guncel_outlet_durum' => trim($data['GUNCEL_OUTLET_DURUM']),\r\n-\t\t\t\t'teyit_durum' => trim($data['TEYIT_DURUM']),\r\n-\t\t\t\t'teyit_arama_durum' => trim($data['TEYIT_ARAMA_DURUM']),\r\n-\t\t\t\t'randevu_tarihi' => $this->convert_date($data['RANDEVU_TARIHI']),\r\n-\t\t\t\t'memo_son_durum' => trim($data['MEMO_SON_DURUM']),\r\n-\t\t\t\t'memo_son_cevap' => trim($data['MEMO_SON_CEVAP']),\r\n-\t\t\t\t'memo_son_aciklama' => trim($data['MEMO_SON_ACIKLAMA'])\r\n-\t\t\t];\r\n-\r\n-\t\t\t// Boş değerleri NULL yap\r\n-\t\t\tforeach ($insert_data as $key => $value) {\r\n-\t\t\t\tif ($value === '' || $value === null) {\r\n-\t\t\t\t\t$insert_data[$key] = null;\r\n-\t\t\t\t}\r\n-\t\t\t}\r\n-\r\n-\t\t\ttry {\r\n-\t\t\t\t// Var olan kaydı kontrol et (talep_id ile)\r\n-\t\t\t\t$existing = $this->db->get_where('voip_iris_rapor', ['talep_id' => $insert_data['talep_id']])->row();\r\n-\t\t\t\t\r\n-\t\t\t\tif ($existing) {\r\n-\t\t\t\t\t// Güncelle\r\n-\t\t\t\t\t$this->db->where('talep_id', $insert_data['talep_id']);\r\n-\t\t\t\t\tif ($this->db->update('voip_iris_rapor', $insert_data)) {\r\n-\t\t\t\t\t\t$updated++;\r\n-\t\t\t\t\t}\r\n-\t\t\t\t} else {\r\n-\t\t\t\t\t// Yeni kayıt ekle\r\n-\t\t\t\t\tif ($this->db->insert('voip_iris_rapor', $insert_data)) {\r\n-\t\t\t\t\t\t$inserted++;\r\n-\t\t\t\t\t}\r\n-\t\t\t\t}\r\n-\t\t\t} catch (Exception $e) {\r\n-\t\t\t\t$errors[] = \"Satır işlenirken hata: \" . $e->getMessage();\r\n-\t\t\t}\r\n-\t\t}\r\n-\r\n-\t\tfclose($handle);\r\n-\r\n-\t\t// Transaction bitir\r\n-\t\t$this->db->trans_complete();\r\n-\r\n-\t\tif ($this->db->trans_status() === FALSE) {\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'success' => false, \r\n-\t\t\t\t'message' => 'Veritabanı işlemi başarısız.',\r\n-\t\t\t\t'errors' => $errors\r\n-\t\t\t]);\r\n-\t\t} else {\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'success' => true, \r\n-\t\t\t\t'message' => \"İşlem tamamlandı. $inserted yeni kayıt eklendi, $updated kayıt güncellendi.\",\r\n-\t\t\t\t'inserted' => $inserted,\r\n-\t\t\t\t'updated' => $updated,\r\n-\t\t\t\t'errors' => $errors\r\n-\t\t\t]);\r\n-\t\t}\r\n-\t}\r\n-\r\n-\t/**\r\n-\t * Tarih formatını dönüştür (d.m.Y H:i -> Y-m-d H:i:s)\r\n-\t */\r\n-\tprivate function convert_date($date_str) {\r\n-\t\tif (empty(trim($date_str))) {\r\n-\t\t\treturn null;\r\n-\t\t}\r\n-\r\n-\t\ttry {\r\n-\t\t\t// Türkçe tarih formatını MySQL formatına çevir\r\n-\t\t\t$date = DateTime::createFromFormat('d.m.Y H:i', trim($date_str));\r\n-\t\t\tif ($date) {\r\n-\t\t\t\treturn $date->format('Y-m-d H:i:s');\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Alternatif format dene\r\n-\t\t\t$date = DateTime::createFromFormat('d.m.Y', trim($date_str));\r\n-\t\t\tif ($date) {\r\n-\t\t\t\treturn $date->format('Y-m-d H:i:s');\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\treturn null;\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\treturn null;\r\n-\t\t}\r\n-\t}\r\n-\r\n-\t/**\r\n-\t * İris rapor filtrelerini uygula\r\n-\t */\r\n-\tprivate function apply_iris_filters($filters) {\r\n-\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n-\t\t\t$this->db->where('DATE(kayit_tarihi) >=', $filters['baslangic_tarihi']);\r\n-\t\t}\r\n-\t\t\r\n-\t\tif (!empty($filters['bitis_tarihi'])) {\r\n-\t\t\t$this->db->where('DATE(kayit_tarihi) <=', $filters['bitis_tarihi']);\r\n-\t\t}\r\n-\t\t\r\n-\t\tif (!empty($filters['talep_id'])) {\r\n-\t\t\t$this->db->like('talep_id', $filters['talep_id']);\r\n-\t\t}\r\n-\t\t\r\n-\t\tif (!empty($filters['memo_id'])) {\r\n-\t\t\t$this->db->like('memo_id', $filters['memo_id']);\r\n-\t\t}\r\n-\t\t\r\n-\t\tif (!empty($filters['dt_musteri_no'])) {\r\n-\t\t\t$this->db->like('dt_musteri_no', $filters['dt_musteri_no']);\r\n-\t\t}\r\n-\t\t\r\n-\t\tif (!empty($filters['satis_durumu'])) {\r\n-\t\t\t$this->db->like('satis_durumu', $filters['satis_durumu']);\r\n-\t\t}\r\n-\t}\r\n-\r\n }\r\n \r\n"
                },
                {
                    "date": 1754744269471,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2222,6 +2222,206 @@\n \t\t\t'kayit_sayisi' => count($hakedis_ucretleri)\r\n \t\t]);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Hakediş İris Rapor Sayfası (ID:1906)\r\n+\t * URL: https://crm.ilekasoft.com/voip/hakedis-iris-rapor\r\n+\t */\r\n+\tpublic function hakedis_iris_rapor(){\r\n+\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n+\t\tif(!grup_modul_yetkisi_var(1900)){\r\n+\t\t\t$this->session->set_flashdata('error', 'Bu modüle erişim yetkiniz bulunmamaktadır.');\r\n+\t\t\tredirect('home');\r\n+\t\t}\r\n+\r\n+\t\t// Hakediş İris Rapor (ID:1906) yetkisi kontrolü  \r\n+\t\tif(!grup_modul_yetkisi_var(1906)){\r\n+\t\t\t$this->session->set_flashdata('error', 'Bu sayfaya erişim yetkiniz bulunmamaktadır.');\r\n+\t\t\tredirect('voip/operator-tanimla');\r\n+\t\t}\r\n+\r\n+\t\t$data['title'] = 'Hakediş İris Rapor';\r\n+\t\t$data['h1'] = 'Hakediş İris Rapor';\r\n+\r\n+\t\t// Mevcut veriler için sayfa numarası ve limit\r\n+\t\t$page = (int) $this->input->get('page') ?: 1;\r\n+\t\t$limit = 50;\r\n+\t\t$offset = ($page - 1) * $limit;\r\n+\r\n+\t\t// Filtreleme parametreleri\r\n+\t\t$filters = [\r\n+\t\t\t'baslangic_tarihi' => $this->input->get('baslangic_tarihi'),\r\n+\t\t\t'bitis_tarihi' => $this->input->get('bitis_tarihi'),\r\n+\t\t\t'talep_id' => $this->input->get('talep_id'),\r\n+\t\t\t'memo_id' => $this->input->get('memo_id'),\r\n+\t\t\t'dt_musteri_no' => $this->input->get('dt_musteri_no'),\r\n+\t\t\t'satis_durumu' => $this->input->get('satis_durumu')\r\n+\t\t];\r\n+\r\n+\t\t// Toplam kayıt sayısını al\r\n+\t\t$this->db->from('voip_iris_rapor');\r\n+\t\t$this->apply_iris_filters($filters);\r\n+\t\t$total_records = $this->db->count_all_results();\r\n+\r\n+\t\t// Verileri al\r\n+\t\t$this->db->from('voip_iris_rapor');\r\n+\t\t$this->apply_iris_filters($filters);\r\n+\t\t$this->db->limit($limit, $offset);\r\n+\t\t$this->db->order_by('kayit_tarihi', 'DESC');\r\n+\t\t$data['rapor_verileri'] = $this->db->get()->result();\r\n+\r\n+\t\t// Pagination\r\n+\t\t$data['pagination'] = [\r\n+\t\t\t'current_page' => $page,\r\n+\t\t\t'total_pages' => ceil($total_records / $limit),\r\n+\t\t\t'total_records' => $total_records,\r\n+\t\t\t'per_page' => $limit\r\n+\t\t];\r\n+\r\n+\t\t$data['filters'] = $filters;\r\n+\r\n+\t\t$this->load->view('voip/hakedis-iris-rapor', $data);\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * İris Rapor Filtreleme Helper\r\n+\t */\r\n+\tprivate function apply_iris_filters($filters) {\r\n+\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n+\t\t\t$this->db->where('talep_giris_tarihi >=', $filters['baslangic_tarihi']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['bitis_tarihi'])) {\r\n+\t\t\t$this->db->where('talep_giris_tarihi <=', $filters['bitis_tarihi'] . ' 23:59:59');\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['talep_id'])) {\r\n+\t\t\t$this->db->like('talep_id', $filters['talep_id']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['memo_id'])) {\r\n+\t\t\t$this->db->like('memo_id', $filters['memo_id']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['dt_musteri_no'])) {\r\n+\t\t\t$this->db->like('dt_musteri_no', $filters['dt_musteri_no']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['satis_durumu'])) {\r\n+\t\t\t$this->db->like('satis_durumu', $filters['satis_durumu']);\r\n+\t\t}\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * İris Rapor CSV Yükleme İşlemi\r\n+\t */\r\n+\tpublic function iris_rapor_yukle(){\r\n+\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n+\t\tif(!grup_modul_yetkisi_var(1900)){\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Bu modüle erişim yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Hakediş İris Rapor (ID:1906) yetkisi kontrolü  \r\n+\t\tif(!grup_modul_yetkisi_var(1906)){\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Bu sayfaya erişim yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\tif (!isset($_FILES['csv_file']) || $_FILES['csv_file']['error'] !== UPLOAD_ERR_OK) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Dosya yüklenirken hata oluştu.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t$file_tmp = $_FILES['csv_file']['tmp_name'];\r\n+\t\t$file_name = $_FILES['csv_file']['name'];\r\n+\t\t$file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));\r\n+\r\n+\t\t// Dosya uzantısı kontrolü\r\n+\t\tif ($file_ext !== 'csv') {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Sadece CSV dosyaları kabul edilir.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// CSV dosyasını oku\r\n+\t\t$handle = fopen($file_tmp, 'r');\r\n+\t\tif (!$handle) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'CSV dosyası okunamadı.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// CSV başlığını oku\r\n+\t\t$header = fgetcsv($handle, 0, ',');\r\n+\t\tif (!$header) {\r\n+\t\t\tfclose($handle);\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'CSV dosyası boş veya hatalı format.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// İşlenen ve başarısız kayıt sayısı\r\n+\t\t$processed = 0;\r\n+\t\t$failed = 0;\r\n+\t\t$errors = [];\r\n+\r\n+\t\t// Transaction başlat\r\n+\t\t$this->db->trans_start();\r\n+\r\n+\t\twhile (($data = fgetcsv($handle, 0, ',')) !== FALSE) {\r\n+\t\t\tif (count($data) < count($header)) {\r\n+\t\t\t\t$failed++;\r\n+\t\t\t\tcontinue;\r\n+\t\t\t}\r\n+\r\n+\t\t\t// CSV verilerini array'e çevir\r\n+\t\t\t$csv_data = array_combine($header, $data);\r\n+\r\n+\t\t\t// Veritabanına insert edilecek veriyi hazırla\r\n+\t\t\t$insert_data = [\r\n+\t\t\t\t'talep_id' => $csv_data['TALEP_ID'] ?? '',\r\n+\t\t\t\t'talep_turu' => $csv_data['TALEP_TURU'] ?? '',\r\n+\t\t\t\t'uydu_basvuru_potansiyel_no' => $csv_data['UYDU_BASVURU_POTANSIYEL_NO'] ?? '',\r\n+\t\t\t\t'uydu_basvuru_uye_no' => $csv_data['UYDU_BASVURU_UYE_NO'] ?? '',\r\n+\t\t\t\t'dt_musteri_no' => $csv_data['DT_MUSTERI_NO'] ?? '',\r\n+\t\t\t\t'memo_id' => $csv_data['MEMO_ID'] ?? '',\r\n+\t\t\t\t'memo_kayit_tipi' => $csv_data['MEMO_KAYIT_TIPI'] ?? '',\r\n+\t\t\t\t'memo_id_tip' => $csv_data['MEMO_ID_TIP'] ?? '',\r\n+\t\t\t\t'memo_kodu' => $csv_data['MEMO_KODU'] ?? '',\r\n+\t\t\t\t'memo_kapanis_tarihi' => !empty($csv_data['MEMO_KAPANIS_TARIHI']) ? date('Y-m-d H:i:s', strtotime($csv_data['MEMO_KAPANIS_TARIHI'])) : null,\r\n+\t\t\t\t'memo_yonlenen_bayi_kodu' => $csv_data['MEMO_YONLENEN_BAYI_KODU'] ?? '',\r\n+\t\t\t\t'memo_yonlenen_bayi_adi' => $csv_data['MEMO_YONLENEN_BAYI_ADI'] ?? '',\r\n+\t\t\t\t'satis_durumu' => $csv_data['SATIS_DURUMU'] ?? '',\r\n+\t\t\t\t'talep_giris_tarihi' => !empty($csv_data['TALEP_GIRIS_TARIHI']) ? date('Y-m-d H:i:s', strtotime($csv_data['TALEP_GIRIS_TARIHI'])) : null,\r\n+\t\t\t\t'randevu_tarihi' => !empty($csv_data['RANDEVU_TARIHI']) ? date('Y-m-d H:i:s', strtotime($csv_data['RANDEVU_TARIHI'])) : null,\r\n+\t\t\t\t'memo_son_durum' => $csv_data['MEMO_SON_DURUM'] ?? '',\r\n+\t\t\t\t'kayit_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t];\r\n+\r\n+\t\t\t// Veritabanına kaydet\r\n+\t\t\tif ($this->db->insert('voip_iris_rapor', $insert_data)) {\r\n+\t\t\t\t$processed++;\r\n+\t\t\t} else {\r\n+\t\t\t\t$failed++;\r\n+\t\t\t\t$errors[] = \"Satır \" . ($processed + $failed + 1) . \": Veritabanı hatası\";\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n+\t\tfclose($handle);\r\n+\r\n+\t\t// Transaction tamamla\r\n+\t\t$this->db->trans_complete();\r\n+\r\n+\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı işlemi başarısız oldu.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t$message = \"CSV dosyası başarıyla işlendi. {$processed} kayıt eklendi.\";\r\n+\t\tif ($failed > 0) {\r\n+\t\t\t$message .= \" {$failed} kayıt başarısız oldu.\";\r\n+\t\t}\r\n+\r\n+\t\techo json_encode(['success' => true, 'message' => $message, 'processed' => $processed, 'failed' => $failed]);\r\n+\t}\r\n+\r\n }\r\n \r\n"
                },
                {
                    "date": 1754744762973,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2350,9 +2350,9 @@\n \t\t\treturn;\r\n \t\t}\r\n \r\n \t\t// CSV başlığını oku\r\n-\t\t$header = fgetcsv($handle, 0, ',');\r\n+\t\t$header = fgetcsv($handle, 0, ';');\r\n \t\tif (!$header) {\r\n \t\t\tfclose($handle);\r\n \t\t\techo json_encode(['success' => false, 'message' => 'CSV dosyası boş veya hatalı format.']);\r\n \t\t\treturn;\r\n@@ -2365,35 +2365,77 @@\n \r\n \t\t// Transaction başlat\r\n \t\t$this->db->trans_start();\r\n \r\n-\t\twhile (($data = fgetcsv($handle, 0, ',')) !== FALSE) {\r\n+\t\twhile (($data = fgetcsv($handle, 0, ';')) !== FALSE) {\r\n \t\t\tif (count($data) < count($header)) {\r\n \t\t\t\t$failed++;\r\n+\t\t\t\t$errors[] = \"Satır \" . ($processed + $failed + 1) . \": Eksik sütun\";\r\n \t\t\t\tcontinue;\r\n \t\t\t}\r\n \r\n \t\t\t// CSV verilerini array'e çevir\r\n \t\t\t$csv_data = array_combine($header, $data);\r\n \r\n+\t\t\t// Tarih formatlarını düzelt\r\n+\t\t\t$memo_kapanis_tarihi = null;\r\n+\t\t\tif (!empty($csv_data['MEMO_KAPANIS_TARIHI'])) {\r\n+\t\t\t\t// Tarihi parse et: \"4.06.2025 10:10\" formatı\r\n+\t\t\t\t$date_str = trim($csv_data['MEMO_KAPANIS_TARIHI']);\r\n+\t\t\t\tif (preg_match('/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})\\s+(\\d{1,2}):(\\d{2})/', $date_str, $matches)) {\r\n+\t\t\t\t\t$day = $matches[1];\r\n+\t\t\t\t\t$month = $matches[2];\r\n+\t\t\t\t\t$year = $matches[3];\r\n+\t\t\t\t\t$hour = $matches[4];\r\n+\t\t\t\t\t$minute = $matches[5];\r\n+\t\t\t\t\t$memo_kapanis_tarihi = \"$year-$month-$day $hour:$minute:00\";\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\r\n+\t\t\t$talep_giris_tarihi = null;\r\n+\t\t\tif (!empty($csv_data['TALEP_GIRIS_TARIHI'])) {\r\n+\t\t\t\t$date_str = trim($csv_data['TALEP_GIRIS_TARIHI']);\r\n+\t\t\t\tif (preg_match('/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})\\s+(\\d{1,2}):(\\d{2})/', $date_str, $matches)) {\r\n+\t\t\t\t\t$day = $matches[1];\r\n+\t\t\t\t\t$month = $matches[2];\r\n+\t\t\t\t\t$year = $matches[3];\r\n+\t\t\t\t\t$hour = $matches[4];\r\n+\t\t\t\t\t$minute = $matches[5];\r\n+\t\t\t\t\t$talep_giris_tarihi = \"$year-$month-$day $hour:$minute:00\";\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\r\n+\t\t\t$randevu_tarihi = null;\r\n+\t\t\tif (!empty($csv_data['RANDEVU_TARIHI'])) {\r\n+\t\t\t\t$date_str = trim($csv_data['RANDEVU_TARIHI']);\r\n+\t\t\t\tif (preg_match('/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})\\s+(\\d{1,2}):(\\d{2})/', $date_str, $matches)) {\r\n+\t\t\t\t\t$day = $matches[1];\r\n+\t\t\t\t\t$month = $matches[2];\r\n+\t\t\t\t\t$year = $matches[3];\r\n+\t\t\t\t\t$hour = $matches[4];\r\n+\t\t\t\t\t$minute = $matches[5];\r\n+\t\t\t\t\t$randevu_tarihi = \"$year-$month-$day $hour:$minute:00\";\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\r\n \t\t\t// Veritabanına insert edilecek veriyi hazırla\r\n \t\t\t$insert_data = [\r\n-\t\t\t\t'talep_id' => $csv_data['TALEP_ID'] ?? '',\r\n-\t\t\t\t'talep_turu' => $csv_data['TALEP_TURU'] ?? '',\r\n-\t\t\t\t'uydu_basvuru_potansiyel_no' => $csv_data['UYDU_BASVURU_POTANSIYEL_NO'] ?? '',\r\n-\t\t\t\t'uydu_basvuru_uye_no' => $csv_data['UYDU_BASVURU_UYE_NO'] ?? '',\r\n-\t\t\t\t'dt_musteri_no' => $csv_data['DT_MUSTERI_NO'] ?? '',\r\n-\t\t\t\t'memo_id' => $csv_data['MEMO_ID'] ?? '',\r\n-\t\t\t\t'memo_kayit_tipi' => $csv_data['MEMO_KAYIT_TIPI'] ?? '',\r\n-\t\t\t\t'memo_id_tip' => $csv_data['MEMO_ID_TIP'] ?? '',\r\n-\t\t\t\t'memo_kodu' => $csv_data['MEMO_KODU'] ?? '',\r\n-\t\t\t\t'memo_kapanis_tarihi' => !empty($csv_data['MEMO_KAPANIS_TARIHI']) ? date('Y-m-d H:i:s', strtotime($csv_data['MEMO_KAPANIS_TARIHI'])) : null,\r\n-\t\t\t\t'memo_yonlenen_bayi_kodu' => $csv_data['MEMO_YONLENEN_BAYI_KODU'] ?? '',\r\n-\t\t\t\t'memo_yonlenen_bayi_adi' => $csv_data['MEMO_YONLENEN_BAYI_ADI'] ?? '',\r\n-\t\t\t\t'satis_durumu' => $csv_data['SATIS_DURUMU'] ?? '',\r\n-\t\t\t\t'talep_giris_tarihi' => !empty($csv_data['TALEP_GIRIS_TARIHI']) ? date('Y-m-d H:i:s', strtotime($csv_data['TALEP_GIRIS_TARIHI'])) : null,\r\n-\t\t\t\t'randevu_tarihi' => !empty($csv_data['RANDEVU_TARIHI']) ? date('Y-m-d H:i:s', strtotime($csv_data['RANDEVU_TARIHI'])) : null,\r\n-\t\t\t\t'memo_son_durum' => $csv_data['MEMO_SON_DURUM'] ?? '',\r\n+\t\t\t\t'talep_id' => trim($csv_data['TALEP_ID'] ?? ''),\r\n+\t\t\t\t'talep_turu' => trim($csv_data['TALEP_TURU'] ?? ''),\r\n+\t\t\t\t'uydu_basvuru_potansiyel_no' => trim($csv_data['UYDU_BASVURU_POTANSIYEL_NO'] ?? ''),\r\n+\t\t\t\t'uydu_basvuru_uye_no' => trim($csv_data['UYDU_BASVURU_UYE_NO'] ?? ''),\r\n+\t\t\t\t'dt_musteri_no' => trim($csv_data['DT_MUSTERI_NO'] ?? ''),\r\n+\t\t\t\t'memo_id' => trim($csv_data['MEMO_ID'] ?? ''),\r\n+\t\t\t\t'memo_kayit_tipi' => trim($csv_data['MEMO_KAYIT_TIPI'] ?? ''),\r\n+\t\t\t\t'memo_id_tip' => trim($csv_data['MEMO_ID_TIP'] ?? ''),\r\n+\t\t\t\t'memo_kodu' => trim($csv_data['MEMO_KODU'] ?? ''),\r\n+\t\t\t\t'memo_kapanis_tarihi' => $memo_kapanis_tarihi,\r\n+\t\t\t\t'memo_yonlenen_bayi_kodu' => trim($csv_data['MEMO_YONLENEN_BAYI_KODU'] ?? ''),\r\n+\t\t\t\t'memo_yonlenen_bayi_adi' => trim($csv_data['MEMO_YONLENEN_BAYI_ADI'] ?? ''),\r\n+\t\t\t\t'satis_durumu' => trim($csv_data['SATIS_DURUMU'] ?? ''),\r\n+\t\t\t\t'talep_giris_tarihi' => $talep_giris_tarihi,\r\n+\t\t\t\t'randevu_tarihi' => $randevu_tarihi,\r\n+\t\t\t\t'memo_son_durum' => trim($csv_data['MEMO_SON_DURUM'] ?? ''),\r\n \t\t\t\t'kayit_tarihi' => date('Y-m-d H:i:s')\r\n \t\t\t];\r\n \r\n \t\t\t// Veritabanına kaydet\r\n"
                },
                {
                    "date": 1754746292718,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2430,12 +2430,34 @@\n \t\t\t\t'memo_kodu' => trim($csv_data['MEMO_KODU'] ?? ''),\r\n \t\t\t\t'memo_kapanis_tarihi' => $memo_kapanis_tarihi,\r\n \t\t\t\t'memo_yonlenen_bayi_kodu' => trim($csv_data['MEMO_YONLENEN_BAYI_KODU'] ?? ''),\r\n \t\t\t\t'memo_yonlenen_bayi_adi' => trim($csv_data['MEMO_YONLENEN_BAYI_ADI'] ?? ''),\r\n+\t\t\t\t'memo_yonlenen_bayi_yoneticisi' => trim($csv_data['MEMO_YONLENEN_BAYI_YONETICISI'] ?? ''),\r\n+\t\t\t\t'memo_yonlenen_bayi_bolge' => trim($csv_data['MEMO_YONLENEN_BAYI_BOLGE'] ?? ''),\r\n+\t\t\t\t'memo_yonlenen_bayi_teknik_yntc' => trim($csv_data['MEMO_YONLENEN_BAYI_TEKNIK_YNTC'] ?? ''),\r\n+\t\t\t\t'talep_giris_tarihi' => $talep_giris_tarihi,\r\n+\t\t\t\t'talebi_giren_bayi_kodu' => trim($csv_data['TALEBI_GIREN_BAYI_KODU'] ?? ''),\r\n+\t\t\t\t'talebi_giren_bayi_adi' => trim($csv_data['TALEBI_GIREN_BAYI_ADI'] ?? ''),\r\n+\t\t\t\t'talebi_giren_personel' => trim($csv_data['TALEBI_GIREN_PERSONEL'] ?? ''),\r\n+\t\t\t\t'talebi_giren_personelno' => trim($csv_data['TALEBI_GIREN_PERSONELNO'] ?? ''),\r\n+\t\t\t\t'talebi_giren_personelkodu' => trim($csv_data['TALEBI_GIREN_PERSONELKODU'] ?? ''),\r\n+\t\t\t\t'talebi_giren_personel_altbayi' => trim($csv_data['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? ''),\r\n+\t\t\t\t'talep_kaynak' => trim($csv_data['TALEP_KAYNAK'] ?? ''),\r\n \t\t\t\t'satis_durumu' => trim($csv_data['SATIS_DURUMU'] ?? ''),\r\n-\t\t\t\t'talep_giris_tarihi' => $talep_giris_tarihi,\r\n+\t\t\t\t'internet_surec_durumu' => trim($csv_data['INTERNET_SUREC_DURUMU'] ?? ''),\r\n+\t\t\t\t'aktive_edilen_uyeno' => trim($csv_data['AKTIVE_EDILEN_UYENO'] ?? ''),\r\n+\t\t\t\t'aktive_edilen_outletno' => trim($csv_data['AKTIVE_EDILEN_OUTLETNO'] ?? ''),\r\n+\t\t\t\t'aktive_edilen_sozlesmeno' => trim($csv_data['AKTIVE_EDILEN_SOZLESMENO'] ?? ''),\r\n+\t\t\t\t'aktive_edilen_sozlesmekmp' => trim($csv_data['AKTIVE_EDILEN_SOZLESMEKMP'] ?? ''),\r\n+\t\t\t\t'aktive_edilen_sozlesmedurum' => trim($csv_data['AKTIVE_EDILEN_SOZLESMEDURUM'] ?? ''),\r\n+\t\t\t\t'talep_takip_notu' => trim($csv_data['TALEP_TAKIP_NOTU'] ?? ''),\r\n+\t\t\t\t'guncel_outlet_durum' => trim($csv_data['GUNCEL_OUTLET_DURUM'] ?? ''),\r\n+\t\t\t\t'teyit_durum' => trim($csv_data['TEYIT_DURUM'] ?? ''),\r\n+\t\t\t\t'teyit_arama_durum' => trim($csv_data['TEYIT_ARAMA_DURUM'] ?? ''),\r\n \t\t\t\t'randevu_tarihi' => $randevu_tarihi,\r\n \t\t\t\t'memo_son_durum' => trim($csv_data['MEMO_SON_DURUM'] ?? ''),\r\n+\t\t\t\t'memo_son_cevap' => trim($csv_data['MEMO_SON_CEVAP'] ?? ''),\r\n+\t\t\t\t'memo_son_aciklama' => trim($csv_data['MEMO_SON_ACIKLAMA'] ?? ''),\r\n \t\t\t\t'kayit_tarihi' => date('Y-m-d H:i:s')\r\n \t\t\t];\r\n \r\n \t\t\t// Veritabanına kaydet\r\n"
                },
                {
                    "date": 1755004441798,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2315,8 +2315,16 @@\n \t/**\r\n \t * İris Rapor CSV Yükleme İşlemi\r\n \t */\r\n \tpublic function iris_rapor_yukle(){\r\n+\t\t// Performans ayarları\r\n+\t\tini_set('max_execution_time', 600); // 10 dakika\r\n+\t\tini_set('memory_limit', '1024M');\r\n+\t\t\r\n+\t\t// Türkçe karakter desteği\r\n+\t\t$this->db->query(\"SET NAMES utf8mb4\");\r\n+\t\t$this->db->query(\"SET CHARACTER SET utf8mb4\");\r\n+\t\t\r\n \t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n \t\tif(!grup_modul_yetkisi_var(1900)){\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Bu modüle erişim yetkiniz bulunmamaktadır.']);\r\n \t\t\treturn;\r\n@@ -2328,9 +2336,35 @@\n \t\t\treturn;\r\n \t\t}\r\n \r\n \t\tif (!isset($_FILES['csv_file']) || $_FILES['csv_file']['error'] !== UPLOAD_ERR_OK) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Dosya yüklenirken hata oluştu.']);\r\n+\t\t\t$error_message = 'Dosya yüklenirken hata oluştu.';\r\n+\t\t\tif (isset($_FILES['csv_file']['error'])) {\r\n+\t\t\t\tswitch ($_FILES['csv_file']['error']) {\r\n+\t\t\t\t\tcase UPLOAD_ERR_INI_SIZE:\r\n+\t\t\t\t\t\t$error_message = 'Dosya boyutu php.ini upload_max_filesize limitini aşıyor.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase UPLOAD_ERR_FORM_SIZE:\r\n+\t\t\t\t\t\t$error_message = 'Dosya boyutu HTML form MAX_FILE_SIZE limitini aşıyor.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase UPLOAD_ERR_PARTIAL:\r\n+\t\t\t\t\t\t$error_message = 'Dosya kısmen yüklendi.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase UPLOAD_ERR_NO_FILE:\r\n+\t\t\t\t\t\t$error_message = 'Hiçbir dosya yüklenmedi.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase UPLOAD_ERR_NO_TMP_DIR:\r\n+\t\t\t\t\t\t$error_message = 'Geçici dizin eksik.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase UPLOAD_ERR_CANT_WRITE:\r\n+\t\t\t\t\t\t$error_message = 'Disk yazma hatası.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase UPLOAD_ERR_EXTENSION:\r\n+\t\t\t\t\t\t$error_message = 'PHP uzantısı dosya yüklemeyi durdurdu.';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\techo json_encode(['success' => false, 'message' => $error_message]);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n \t\t$file_tmp = $_FILES['csv_file']['tmp_name'];\r\n@@ -2349,8 +2383,13 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'CSV dosyası okunamadı.']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n+\t\t// Encoding kontrolü\r\n+\t\t$first_line = fgets($handle);\r\n+\t\trewind($handle);\r\n+\t\t$encoding = mb_detect_encoding($first_line, ['UTF-8', 'UTF-16', 'Windows-1254', 'ISO-8859-9'], true);\r\n+\r\n \t\t// CSV başlığını oku\r\n \t\t$header = fgetcsv($handle, 0, ';');\r\n \t\tif (!$header) {\r\n \t\t\tfclose($handle);\r\n@@ -2359,10 +2398,14 @@\n \t\t}\r\n \r\n \t\t// İşlenen ve başarısız kayıt sayısı\r\n \t\t$processed = 0;\r\n+\t\t$updated = 0;\r\n \t\t$failed = 0;\r\n \t\t$errors = [];\r\n+\t\t$batch_size = 500; // Büyük dosyalar için daha küçük batch (500 kayıt)\r\n+\t\t$batch_data = [];\r\n+\t\t$update_data = [];\r\n \r\n \t\t// Transaction başlat\r\n \t\t$this->db->trans_start();\r\n \r\n@@ -2372,8 +2415,15 @@\n \t\t\t\t$errors[] = \"Satır \" . ($processed + $failed + 1) . \": Eksik sütun\";\r\n \t\t\t\tcontinue;\r\n \t\t\t}\r\n \r\n+\t\t\t// Encoding dönüşümü (Türkçe karakter desteği için)\r\n+\t\t\tif ($encoding !== 'UTF-8') {\r\n+\t\t\t\t$data = array_map(function($item) use ($encoding) {\r\n+\t\t\t\t\treturn mb_convert_encoding($item, 'UTF-8', $encoding);\r\n+\t\t\t\t}, $data);\r\n+\t\t\t}\r\n+\r\n \t\t\t// CSV verilerini array'e çevir\r\n \t\t\t$csv_data = array_combine($header, $data);\r\n \r\n \t\t\t// Tarih formatlarını düzelt\r\n@@ -2459,17 +2509,57 @@\n \t\t\t\t'memo_son_aciklama' => trim($csv_data['MEMO_SON_ACIKLAMA'] ?? ''),\r\n \t\t\t\t'kayit_tarihi' => date('Y-m-d H:i:s')\r\n \t\t\t];\r\n \r\n-\t\t\t// Veritabanına kaydet\r\n-\t\t\tif ($this->db->insert('voip_iris_rapor', $insert_data)) {\r\n-\t\t\t\t$processed++;\r\n+\t\t\t// memo_id boş değilse kontrol et\r\n+\t\t\t$memo_id = trim($csv_data['MEMO_ID'] ?? '');\r\n+\t\t\tif (!empty($memo_id)) {\r\n+\t\t\t\t// Mevcut kaydı kontrol et\r\n+\t\t\t\t$existing = $this->db->select('id')->where('memo_id', $memo_id)->get('voip_iris_rapor')->row();\r\n+\t\t\t\t\r\n+\t\t\t\tif ($existing) {\r\n+\t\t\t\t\t// Kayıt mevcut, güncelle\r\n+\t\t\t\t\t$update_data_single = $insert_data;\r\n+\t\t\t\t\tunset($update_data_single['kayit_tarihi']); // Kayit tarihi güncellenmesin\r\n+\t\t\t\t\t$update_data_single['guncelleme_tarihi'] = date('Y-m-d H:i:s');\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tif ($this->db->where('memo_id', $memo_id)->update('voip_iris_rapor', $update_data_single)) {\r\n+\t\t\t\t\t\t$updated++;\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t$failed++;\r\n+\t\t\t\t\t\t$errors[] = \"Memo ID: $memo_id - Güncelleme hatası\";\r\n+\t\t\t\t\t}\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t// Yeni kayıt ekle\r\n+\t\t\t\t\t$batch_data[] = $insert_data;\r\n+\t\t\t\t}\r\n \t\t\t} else {\r\n-\t\t\t\t$failed++;\r\n-\t\t\t\t$errors[] = \"Satır \" . ($processed + $failed + 1) . \": Veritabanı hatası\";\r\n+\t\t\t\t// memo_id boş ise direkt ekle\r\n+\t\t\t\t$batch_data[] = $insert_data;\r\n \t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Batch boyutuna ulaştığında işle (sadece yeni kayıtlar için)\r\n+\t\t\tif (count($batch_data) >= $batch_size) {\r\n+\t\t\t\tif ($this->db->insert_batch('voip_iris_rapor', $batch_data)) {\r\n+\t\t\t\t\t$processed += count($batch_data);\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t$failed += count($batch_data);\r\n+\t\t\t\t\t$errors[] = \"Batch insert hatası: \" . count($batch_data) . \" kayıt\";\r\n+\t\t\t\t}\r\n+\t\t\t\t$batch_data = []; // Batch'i temizle\r\n+\t\t\t}\r\n \t\t}\r\n \r\n+\t\t// Kalan kayıtları işle (sadece yeni kayıtlar için)\r\n+\t\tif (!empty($batch_data)) {\r\n+\t\t\tif ($this->db->insert_batch('voip_iris_rapor', $batch_data)) {\r\n+\t\t\t\t$processed += count($batch_data);\r\n+\t\t\t} else {\r\n+\t\t\t\t$failed += count($batch_data);\r\n+\t\t\t\t$errors[] = \"Son batch insert hatası: \" . count($batch_data) . \" kayıt\";\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n \t\tfclose($handle);\r\n \r\n \t\t// Transaction tamamla\r\n \t\t$this->db->trans_complete();\r\n@@ -2478,14 +2568,28 @@\n \t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı işlemi başarısız oldu.']);\r\n \t\t\treturn;\r\n \t\t}\r\n \r\n-\t\t$message = \"CSV dosyası başarıyla işlendi. {$processed} kayıt eklendi.\";\r\n+\t\t$total_successful = $processed + $updated;\r\n+\t\t$message = \"CSV dosyası başarıyla işlendi.\";\r\n+\t\tif ($processed > 0) {\r\n+\t\t\t$message .= \" {$processed} yeni kayıt eklendi.\";\r\n+\t\t}\r\n+\t\tif ($updated > 0) {\r\n+\t\t\t$message .= \" {$updated} mevcut kayıt güncellendi.\";\r\n+\t\t}\r\n \t\tif ($failed > 0) {\r\n \t\t\t$message .= \" {$failed} kayıt başarısız oldu.\";\r\n \t\t}\r\n \r\n-\t\techo json_encode(['success' => true, 'message' => $message, 'processed' => $processed, 'failed' => $failed]);\r\n+\t\techo json_encode([\r\n+\t\t\t'success' => true, \r\n+\t\t\t'message' => $message, \r\n+\t\t\t'processed' => $processed, \r\n+\t\t\t'updated' => $updated,\r\n+\t\t\t'failed' => $failed,\r\n+\t\t\t'total_successful' => $total_successful\r\n+\t\t]);\r\n \t}\r\n \r\n }\r\n \r\n"
                },
                {
                    "date": 1755012446842,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2590,6 +2590,81 @@\n \t\t\t'total_successful' => $total_successful\r\n \t\t]);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Hakediş Bayi Hesapla Sayfası (ID:1907)\r\n+\t * URL: https://crm.ilekasoft.com/voip/hakedis-bayi-hesapla\r\n+\t */\r\n+\tpublic function hakedis_bayi_hesapla(){\r\n+\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n+\t\tif(!grup_modul_yetkisi_var(1900)){\r\n+\t\t\tredirect('home/hata2/2');\r\n+\t\t}\r\n+\r\n+\t\t// Hakediş Bayi Hesapla (ID:1907) yetkisi kontrolü  \r\n+\t\tif(!grup_modul_yetkisi_var(1907)){\r\n+\t\t\tredirect('voip/operator-tanimla');\r\n+\t\t}\r\n+\r\n+\t\t$data['title'] = 'Hakediş Bayi Hesapla';\r\n+\t\t$data['h1'] = 'Hakediş Bayi Hesapla';\r\n+\r\n+\t\t// Filtreleme parametreleri\r\n+\t\t$filters = [\r\n+\t\t\t'baslangic_tarihi' => $this->input->get('baslangic_tarihi'),\r\n+\t\t\t'bitis_tarihi' => $this->input->get('bitis_tarihi'),\r\n+\t\t\t'talebi_giren_personel_altbayi' => $this->input->get('talebi_giren_personel_altbayi')\r\n+\t\t];\r\n+\r\n+\t\t// Sadece SATIS_DURUMU = 'Tamamlandı' olanları getir\r\n+\t\t$this->db->select('\r\n+\t\t\ttalebi_giren_personel_altbayi,\r\n+\t\t\tCOUNT(*) as toplam_talep,\r\n+\t\t\tCOUNT(CASE WHEN memo_kapanis_tarihi IS NOT NULL THEN 1 END) as kapanan_talep,\r\n+\t\t\tMIN(memo_kapanis_tarihi) as ilk_kapanis,\r\n+\t\t\tMAX(memo_kapanis_tarihi) as son_kapanis\r\n+\t\t');\r\n+\t\t$this->db->from('voip_iris_rapor');\r\n+\t\t$this->db->where('satis_durumu', 'Tamamlandı');\r\n+\t\t\r\n+\t\t// Filtreleri uygula\r\n+\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi >=', $filters['baslangic_tarihi']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['bitis_tarihi'])) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi <=', $filters['bitis_tarihi'] . ' 23:59:59');\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['talebi_giren_personel_altbayi'])) {\r\n+\t\t\t$this->db->like('talebi_giren_personel_altbayi', $filters['talebi_giren_personel_altbayi']);\r\n+\t\t}\r\n+\r\n+\t\t$this->db->group_by('talebi_giren_personel_altbayi');\r\n+\t\t$this->db->having('talebi_giren_personel_altbayi IS NOT NULL');\r\n+\t\t$this->db->having('talebi_giren_personel_altbayi !=', '');\r\n+\t\t$this->db->order_by('toplam_talep', 'DESC');\r\n+\r\n+\t\t$data['bayi_hesaplama'] = $this->db->get()->result();\r\n+\r\n+\t\t// Toplam istatistikler\r\n+\t\t$this->db->select('COUNT(*) as genel_toplam');\r\n+\t\t$this->db->from('voip_iris_rapor');\r\n+\t\t$this->db->where('satis_durumu', 'Tamamlandı');\r\n+\t\t\r\n+\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi >=', $filters['baslangic_tarihi']);\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (!empty($filters['bitis_tarihi'])) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi <=', $filters['bitis_tarihi'] . ' 23:59:59');\r\n+\t\t}\r\n+\r\n+\t\t$data['genel_toplam'] = $this->db->get()->row();\r\n+\t\t$data['filters'] = $filters;\r\n+\r\n+\t\t$this->load->view('voip/hakedis-bayi-hesapla', $data);\r\n+\t}\r\n+\r\n }\r\n \r\n"
                },
                {
                    "date": 1755012755240,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2607,8 +2607,9 @@\n \t\t}\r\n \r\n \t\t$data['title'] = 'Hakediş Bayi Hesapla';\r\n \t\t$data['h1'] = 'Hakediş Bayi Hesapla';\r\n+\t\t$data['baslik'] = 'Hakediş Bayi Hesapla';\r\n \r\n \t\t// Filtreleme parametreleri\r\n \t\t$filters = [\r\n \t\t\t'baslangic_tarihi' => $this->input->get('baslangic_tarihi'),\r\n@@ -2665,6 +2666,14 @@\n \r\n \t\t$this->load->view('voip/hakedis-bayi-hesapla', $data);\r\n \t}\r\n \r\n+\t/**\r\n+\t * Debug Test Sayfası - Geliştirme amaçlı\r\n+\t * URL: https://crm.ilekasoft.com/voip/debug-test\r\n+\t */\r\n+\tpublic function debug_test(){\r\n+\t\t$this->load->view('voip/debug-test');\r\n+\t}\r\n+\r\n }\r\n \r\n"
                },
                {
                    "date": 1755013005285,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2619,10 +2619,11 @@\n \r\n \t\t// Sadece SATIS_DURUMU = 'Tamamlandı' olanları getir\r\n \t\t$this->db->select('\r\n \t\t\ttalebi_giren_personel_altbayi,\r\n-\t\t\tCOUNT(*) as toplam_talep,\r\n-\t\t\tCOUNT(CASE WHEN memo_kapanis_tarihi IS NOT NULL THEN 1 END) as kapanan_talep,\r\n+\t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"ISP\" THEN 1 END) as isp,\r\n+\t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"NEO\" THEN 1 END) as neo,\r\n+\t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"UYDU\" THEN 1 END) as uydu,\r\n \t\t\tMIN(memo_kapanis_tarihi) as ilk_kapanis,\r\n \t\t\tMAX(memo_kapanis_tarihi) as son_kapanis\r\n \t\t');\r\n \t\t$this->db->from('voip_iris_rapor');\r\n@@ -2643,9 +2644,9 @@\n \r\n \t\t$this->db->group_by('talebi_giren_personel_altbayi');\r\n \t\t$this->db->having('talebi_giren_personel_altbayi IS NOT NULL');\r\n \t\t$this->db->having('talebi_giren_personel_altbayi !=', '');\r\n-\t\t$this->db->order_by('toplam_talep', 'DESC');\r\n+\t\t$this->db->order_by('(COUNT(CASE WHEN memo_kayit_tipi = \"ISP\" THEN 1 END) + COUNT(CASE WHEN memo_kayit_tipi = \"NEO\" THEN 1 END) + COUNT(CASE WHEN memo_kayit_tipi = \"UYDU\" THEN 1 END))', 'DESC');\r\n \r\n \t\t$data['bayi_hesaplama'] = $this->db->get()->result();\r\n \r\n \t\t// Toplam istatistikler\r\n"
                },
                {
                    "date": 1755013699558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2609,34 +2609,84 @@\n \t\t$data['title'] = 'Hakediş Bayi Hesapla';\r\n \t\t$data['h1'] = 'Hakediş Bayi Hesapla';\r\n \t\t$data['baslik'] = 'Hakediş Bayi Hesapla';\r\n \r\n+\t\t// Hakediş dönemlerini oluştur (son 12 ay)\r\n+\t\t$hakedis_donemleri = [];\r\n+\t\tfor ($i = 11; $i >= 0; $i--) {\r\n+\t\t\t$tarih = date('Y-m-01', strtotime(\"-$i months\"));\r\n+\t\t\t$yil = date('Y', strtotime($tarih));\r\n+\t\t\t$ay = date('n', strtotime($tarih));\r\n+\t\t\t$ay_adi = [\r\n+\t\t\t\t1 => 'Ocak', 2 => 'Şubat', 3 => 'Mart', 4 => 'Nisan',\r\n+\t\t\t\t5 => 'Mayıs', 6 => 'Haziran', 7 => 'Temmuz', 8 => 'Ağustos',\r\n+\t\t\t\t9 => 'Eylül', 10 => 'Ekim', 11 => 'Kasım', 12 => 'Aralık'\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\t// Hakediş başlangıç tarihi: ayın 4'ü\r\n+\t\t\t$baslangic = sprintf('%04d-%02d-04', $yil, $ay);\r\n+\t\t\t\r\n+\t\t\t// Hakediş bitiş tarihi: bir sonraki ayın 3'ü\r\n+\t\t\t$bitis_tarih = date('Y-m-03', strtotime($baslangic . ' +1 month'));\r\n+\t\t\t\r\n+\t\t\t$hakedis_donemleri[] = [\r\n+\t\t\t\t'key' => $yil . '-' . sprintf('%02d', $ay),\r\n+\t\t\t\t'label' => $ay_adi[$ay] . ' ' . $yil . ' Hakedişi (04.' . sprintf('%02d', $ay) . '.' . $yil . ' - ' . date('d.m.Y', strtotime($bitis_tarih)) . ')',\r\n+\t\t\t\t'baslangic' => $baslangic,\r\n+\t\t\t\t'bitis' => $bitis_tarih\r\n+\t\t\t];\r\n+\t\t}\r\n+\t\t$data['hakedis_donemleri'] = $hakedis_donemleri;\r\n+\r\n \t\t// Filtreleme parametreleri\r\n \t\t$filters = [\r\n-\t\t\t'baslangic_tarihi' => $this->input->get('baslangic_tarihi'),\r\n-\t\t\t'bitis_tarihi' => $this->input->get('bitis_tarihi'),\r\n+\t\t\t'hakedis_donemi' => $this->input->get('hakedis_donemi'),\r\n \t\t\t'talebi_giren_personel_altbayi' => $this->input->get('talebi_giren_personel_altbayi')\r\n \t\t];\r\n \r\n+\t\t// Seçili hakediş dönemine göre tarih aralığını belirle\r\n+\t\t$baslangic_tarihi = null;\r\n+\t\t$bitis_tarihi = null;\r\n+\t\t\r\n+\t\tif (!empty($filters['hakedis_donemi'])) {\r\n+\t\t\tforeach ($hakedis_donemleri as $donem) {\r\n+\t\t\t\tif ($donem['key'] == $filters['hakedis_donemi']) {\r\n+\t\t\t\t\t$baslangic_tarihi = $donem['baslangic'];\r\n+\t\t\t\t\t$bitis_tarihi = $donem['bitis'] . ' 23:59:59';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n \t\t// Sadece SATIS_DURUMU = 'Tamamlandı' olanları getir\r\n \t\t$this->db->select('\r\n \t\t\ttalebi_giren_personel_altbayi,\r\n \t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"ISP\" THEN 1 END) as isp,\r\n \t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"NEO\" THEN 1 END) as neo,\r\n \t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"UYDU\" THEN 1 END) as uydu,\r\n-\t\t\tMIN(memo_kapanis_tarihi) as ilk_kapanis,\r\n-\t\t\tMAX(memo_kapanis_tarihi) as son_kapanis\r\n+\t\t\tCASE \r\n+\t\t\t\tWHEN DAY(MIN(memo_kapanis_tarihi)) >= 4 THEN \r\n+\t\t\t\t\tCONCAT(YEAR(MIN(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(memo_kapanis_tarihi)), 2, \"0\"), \"-04\")\r\n+\t\t\t\tELSE \r\n+\t\t\t\t\tCONCAT(YEAR(MIN(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(memo_kapanis_tarihi))-1, 2, \"0\"), \"-04\")\r\n+\t\t\tEND as hakedis_baslangic,\r\n+\t\t\tCASE \r\n+\t\t\t\tWHEN DAY(MAX(memo_kapanis_tarihi)) >= 4 THEN \r\n+\t\t\t\t\tCONCAT(YEAR(MAX(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(memo_kapanis_tarihi))+1, 2, \"0\"), \"-03\")\r\n+\t\t\t\tELSE \r\n+\t\t\t\t\tCONCAT(YEAR(MAX(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(memo_kapanis_tarihi)), 2, \"0\"), \"-03\")\r\n+\t\t\tEND as hakedis_bitis\r\n \t\t');\r\n \t\t$this->db->from('voip_iris_rapor');\r\n \t\t$this->db->where('satis_durumu', 'Tamamlandı');\r\n \t\t\r\n \t\t// Filtreleri uygula\r\n-\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n-\t\t\t$this->db->where('memo_kapanis_tarihi >=', $filters['baslangic_tarihi']);\r\n+\t\tif (!empty($baslangic_tarihi)) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi >=', $baslangic_tarihi);\r\n \t\t}\r\n \t\t\r\n-\t\tif (!empty($filters['bitis_tarihi'])) {\r\n-\t\t\t$this->db->where('memo_kapanis_tarihi <=', $filters['bitis_tarihi'] . ' 23:59:59');\r\n+\t\tif (!empty($bitis_tarihi)) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi <=', $bitis_tarihi);\r\n \t\t}\r\n \t\t\r\n \t\tif (!empty($filters['talebi_giren_personel_altbayi'])) {\r\n \t\t\t$this->db->like('talebi_giren_personel_altbayi', $filters['talebi_giren_personel_altbayi']);\r\n@@ -2653,14 +2703,14 @@\n \t\t$this->db->select('COUNT(*) as genel_toplam');\r\n \t\t$this->db->from('voip_iris_rapor');\r\n \t\t$this->db->where('satis_durumu', 'Tamamlandı');\r\n \t\t\r\n-\t\tif (!empty($filters['baslangic_tarihi'])) {\r\n-\t\t\t$this->db->where('memo_kapanis_tarihi >=', $filters['baslangic_tarihi']);\r\n+\t\tif (!empty($baslangic_tarihi)) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi >=', $baslangic_tarihi);\r\n \t\t}\r\n \t\t\r\n-\t\tif (!empty($filters['bitis_tarihi'])) {\r\n-\t\t\t$this->db->where('memo_kapanis_tarihi <=', $filters['bitis_tarihi'] . ' 23:59:59');\r\n+\t\tif (!empty($bitis_tarihi)) {\r\n+\t\t\t$this->db->where('memo_kapanis_tarihi <=', $bitis_tarihi);\r\n \t\t}\r\n \r\n \t\t$data['genel_toplam'] = $this->db->get()->row();\r\n \t\t$data['filters'] = $filters;\r\n"
                },
                {
                    "date": 1755015407290,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2642,8 +2642,27 @@\n \t\t\t'hakedis_donemi' => $this->input->get('hakedis_donemi'),\r\n \t\t\t'talebi_giren_personel_altbayi' => $this->input->get('talebi_giren_personel_altbayi')\r\n \t\t];\r\n \r\n+\t\t// Eğer hakediş dönemi seçilmemişse, mevcut hakediş dönemini default olarak ayarla\r\n+\t\tif (empty($filters['hakedis_donemi']) && empty($this->input->get('talebi_giren_personel_altbayi'))) {\r\n+\t\t\t// Bugünün tarihine göre mevcut hakediş dönemini bul\r\n+\t\t\t$bugun = date('Y-m-d');\r\n+\t\t\t$bugun_gun = date('j'); // Ayın kaçıncı günü\r\n+\t\t\t\r\n+\t\t\t// Eğer bugün ayın 4'ü veya sonrasıysa, bu ayın hakedişindeyiz\r\n+\t\t\t// Eğer bugün ayın 3'ü veya öncesiyse, önceki ayın hakedişindeyiz\r\n+\t\t\tif ($bugun_gun >= 4) {\r\n+\t\t\t\t// Bu ayın hakediş dönemi\r\n+\t\t\t\t$default_key = date('Y-m');\r\n+\t\t\t} else {\r\n+\t\t\t\t// Önceki ayın hakediş dönemi\r\n+\t\t\t\t$default_key = date('Y-m', strtotime('-1 month'));\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$filters['hakedis_donemi'] = $default_key;\r\n+\t\t}\r\n+\r\n \t\t// Seçili hakediş dönemine göre tarih aralığını belirle\r\n \t\t$baslangic_tarihi = null;\r\n \t\t$bitis_tarihi = null;\r\n \t\t\r\n@@ -2658,45 +2677,52 @@\n \t\t}\r\n \r\n \t\t// Sadece SATIS_DURUMU = 'Tamamlandı' olanları getir\r\n \t\t$this->db->select('\r\n-\t\t\ttalebi_giren_personel_altbayi,\r\n-\t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"ISP\" THEN 1 END) as isp,\r\n-\t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"NEO\" THEN 1 END) as neo,\r\n-\t\t\tCOUNT(CASE WHEN memo_kayit_tipi = \"UYDU\" THEN 1 END) as uydu,\r\n+\t\t\tvir.talebi_giren_personel_altbayi,\r\n+\t\t\tk.kullanici_ad,\r\n+\t\t\tk.kullanici_id,\r\n+\t\t\tvhu.neolu_internet as isp_ucret,\r\n+\t\t\tvhu.tek_neo as neo_ucret,\r\n+\t\t\tvhu.tek_uydu as uydu_ucret,\r\n+\t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"ISP\" THEN 1 END) as isp,\r\n+\t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) as neo,\r\n+\t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END) as uydu,\r\n \t\t\tCASE \r\n-\t\t\t\tWHEN DAY(MIN(memo_kapanis_tarihi)) >= 4 THEN \r\n-\t\t\t\t\tCONCAT(YEAR(MIN(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(memo_kapanis_tarihi)), 2, \"0\"), \"-04\")\r\n+\t\t\t\tWHEN DAY(MIN(vir.memo_kapanis_tarihi)) >= 4 THEN \r\n+\t\t\t\t\tCONCAT(YEAR(MIN(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(vir.memo_kapanis_tarihi)), 2, \"0\"), \"-04\")\r\n \t\t\t\tELSE \r\n-\t\t\t\t\tCONCAT(YEAR(MIN(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(memo_kapanis_tarihi))-1, 2, \"0\"), \"-04\")\r\n+\t\t\t\t\tCONCAT(YEAR(MIN(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(vir.memo_kapanis_tarihi))-1, 2, \"0\"), \"-04\")\r\n \t\t\tEND as hakedis_baslangic,\r\n \t\t\tCASE \r\n-\t\t\t\tWHEN DAY(MAX(memo_kapanis_tarihi)) >= 4 THEN \r\n-\t\t\t\t\tCONCAT(YEAR(MAX(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(memo_kapanis_tarihi))+1, 2, \"0\"), \"-03\")\r\n+\t\t\t\tWHEN DAY(MAX(vir.memo_kapanis_tarihi)) >= 4 THEN \r\n+\t\t\t\t\tCONCAT(YEAR(MAX(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(vir.memo_kapanis_tarihi))+1, 2, \"0\"), \"-03\")\r\n \t\t\t\tELSE \r\n-\t\t\t\t\tCONCAT(YEAR(MAX(memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(memo_kapanis_tarihi)), 2, \"0\"), \"-03\")\r\n+\t\t\t\t\tCONCAT(YEAR(MAX(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(vir.memo_kapanis_tarihi)), 2, \"0\"), \"-03\")\r\n \t\t\tEND as hakedis_bitis\r\n \t\t');\r\n-\t\t$this->db->from('voip_iris_rapor');\r\n-\t\t$this->db->where('satis_durumu', 'Tamamlandı');\r\n+\t\t$this->db->from('voip_iris_rapor vir');\r\n+\t\t$this->db->join('kullanicilar k', 'k.kullanici_ad = vir.talebi_giren_personel_altbayi', 'left');\r\n+\t\t$this->db->join('voip_hakedis_ucretleri vhu', 'vhu.kullanici_id = k.kullanici_id', 'left');\r\n+\t\t$this->db->where('vir.satis_durumu', 'Tamamlandı');\r\n \t\t\r\n \t\t// Filtreleri uygula\r\n \t\tif (!empty($baslangic_tarihi)) {\r\n-\t\t\t$this->db->where('memo_kapanis_tarihi >=', $baslangic_tarihi);\r\n+\t\t\t$this->db->where('vir.memo_kapanis_tarihi >=', $baslangic_tarihi);\r\n \t\t}\r\n \t\t\r\n \t\tif (!empty($bitis_tarihi)) {\r\n-\t\t\t$this->db->where('memo_kapanis_tarihi <=', $bitis_tarihi);\r\n+\t\t\t$this->db->where('vir.memo_kapanis_tarihi <=', $bitis_tarihi);\r\n \t\t}\r\n \t\t\r\n \t\tif (!empty($filters['talebi_giren_personel_altbayi'])) {\r\n-\t\t\t$this->db->like('talebi_giren_personel_altbayi', $filters['talebi_giren_personel_altbayi']);\r\n+\t\t\t$this->db->like('vir.talebi_giren_personel_altbayi', $filters['talebi_giren_personel_altbayi']);\r\n \t\t}\r\n \r\n-\t\t$this->db->group_by('talebi_giren_personel_altbayi');\r\n-\t\t$this->db->having('talebi_giren_personel_altbayi IS NOT NULL');\r\n-\t\t$this->db->having('talebi_giren_personel_altbayi !=', '');\r\n-\t\t$this->db->order_by('(COUNT(CASE WHEN memo_kayit_tipi = \"ISP\" THEN 1 END) + COUNT(CASE WHEN memo_kayit_tipi = \"NEO\" THEN 1 END) + COUNT(CASE WHEN memo_kayit_tipi = \"UYDU\" THEN 1 END))', 'DESC');\r\n+\t\t$this->db->group_by('vir.talebi_giren_personel_altbayi, k.kullanici_id, vhu.neolu_internet, vhu.tek_neo, vhu.tek_uydu');\r\n+\t\t$this->db->having('vir.talebi_giren_personel_altbayi IS NOT NULL');\r\n+\t\t$this->db->having('vir.talebi_giren_personel_altbayi !=', '');\r\n+\t\t$this->db->order_by('(COUNT(CASE WHEN vir.memo_kayit_tipi = \"ISP\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END))', 'DESC');\r\n \r\n \t\t$data['bayi_hesaplama'] = $this->db->get()->result();\r\n \r\n \t\t// Toplam istatistikler\r\n"
                },
                {
                    "date": 1755016108212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2686,24 +2686,23 @@\n \t\t\tvhu.tek_uydu as uydu_ucret,\r\n \t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"ISP\" THEN 1 END) as isp,\r\n \t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) as neo,\r\n \t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END) as uydu,\r\n-\t\t\tCASE \r\n-\t\t\t\tWHEN DAY(MIN(vir.memo_kapanis_tarihi)) >= 4 THEN \r\n-\t\t\t\t\tCONCAT(YEAR(MIN(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(vir.memo_kapanis_tarihi)), 2, \"0\"), \"-04\")\r\n-\t\t\t\tELSE \r\n-\t\t\t\t\tCONCAT(YEAR(MIN(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MIN(vir.memo_kapanis_tarihi))-1, 2, \"0\"), \"-04\")\r\n-\t\t\tEND as hakedis_baslangic,\r\n-\t\t\tCASE \r\n-\t\t\t\tWHEN DAY(MAX(vir.memo_kapanis_tarihi)) >= 4 THEN \r\n-\t\t\t\t\tCONCAT(YEAR(MAX(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(vir.memo_kapanis_tarihi))+1, 2, \"0\"), \"-03\")\r\n-\t\t\t\tELSE \r\n-\t\t\t\t\tCONCAT(YEAR(MAX(vir.memo_kapanis_tarihi)), \"-\", LPAD(MONTH(MAX(vir.memo_kapanis_tarihi)), 2, \"0\"), \"-03\")\r\n-\t\t\tEND as hakedis_bitis\r\n+\t\t\tvhu.baslangic_tarihi as hakedis_baslangic,\r\n+\t\t\tvhu.bitis_tarihi as hakedis_bitis\r\n \t\t');\r\n \t\t$this->db->from('voip_iris_rapor vir');\r\n \t\t$this->db->join('kullanicilar k', 'k.kullanici_ad = vir.talebi_giren_personel_altbayi', 'left');\r\n-\t\t$this->db->join('voip_hakedis_ucretleri vhu', 'vhu.kullanici_id = k.kullanici_id', 'left');\r\n+\t\t\r\n+\t\t// Hakediş döneminin tarih aralığında olduğu fiyatlandırmaları getir\r\n+\t\tif (!empty($baslangic_tarihi)) {\r\n+\t\t\t$bitis_tarih_only = date('Y-m-d', strtotime($bitis_tarihi));\r\n+\t\t\t$join_condition = 'vhu.kullanici_id = k.kullanici_id AND \"' . $baslangic_tarihi . '\" >= vhu.baslangic_tarihi AND \"' . $bitis_tarih_only . '\" <= vhu.bitis_tarihi';\r\n+\t\t\t$this->db->join('voip_hakedis_ucretleri vhu', $join_condition, 'left');\r\n+\t\t} else {\r\n+\t\t\t$this->db->join('voip_hakedis_ucretleri vhu', 'vhu.kullanici_id = k.kullanici_id', 'left');\r\n+\t\t}\r\n+\t\t\r\n \t\t$this->db->where('vir.satis_durumu', 'Tamamlandı');\r\n \t\t\r\n \t\t// Filtreleri uygula\r\n \t\tif (!empty($baslangic_tarihi)) {\r\n@@ -2717,9 +2716,9 @@\n \t\tif (!empty($filters['talebi_giren_personel_altbayi'])) {\r\n \t\t\t$this->db->like('vir.talebi_giren_personel_altbayi', $filters['talebi_giren_personel_altbayi']);\r\n \t\t}\r\n \r\n-\t\t$this->db->group_by('vir.talebi_giren_personel_altbayi, k.kullanici_id, vhu.neolu_internet, vhu.tek_neo, vhu.tek_uydu');\r\n+\t\t$this->db->group_by('vir.talebi_giren_personel_altbayi, k.kullanici_id, vhu.neolu_internet, vhu.tek_neo, vhu.tek_uydu, vhu.baslangic_tarihi, vhu.bitis_tarihi');\r\n \t\t$this->db->having('vir.talebi_giren_personel_altbayi IS NOT NULL');\r\n \t\t$this->db->having('vir.talebi_giren_personel_altbayi !=', '');\r\n \t\t$this->db->order_by('(COUNT(CASE WHEN vir.memo_kayit_tipi = \"ISP\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END))', 'DESC');\r\n \r\n"
                },
                {
                    "date": 1755237805425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2683,9 +2683,10 @@\n \t\t\tk.kullanici_id,\r\n \t\t\tvhu.neolu_internet as isp_ucret,\r\n \t\t\tvhu.tek_neo as neo_ucret,\r\n \t\t\tvhu.tek_uydu as uydu_ucret,\r\n-\t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"ISP\" THEN 1 END) as isp,\r\n+\t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi LIKE \"%ISP%\" AND vir.talep_turu LIKE \"%ISP ve Neo Potansiyel Talep%\" THEN 1 END) as neolu_isp,\r\n+\t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi LIKE \"%ISP%\" AND vir.talep_turu LIKE \"%Uydu ve ISP Potansiyel Talep%\" THEN 1 END) as uydulu_isp,\r\n \t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) as neo,\r\n \t\t\tCOUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END) as uydu,\r\n \t\t\tvhu.baslangic_tarihi as hakedis_baslangic,\r\n \t\t\tvhu.bitis_tarihi as hakedis_bitis\r\n@@ -2719,9 +2720,9 @@\n \r\n \t\t$this->db->group_by('vir.talebi_giren_personel_altbayi, k.kullanici_id, vhu.neolu_internet, vhu.tek_neo, vhu.tek_uydu, vhu.baslangic_tarihi, vhu.bitis_tarihi');\r\n \t\t$this->db->having('vir.talebi_giren_personel_altbayi IS NOT NULL');\r\n \t\t$this->db->having('vir.talebi_giren_personel_altbayi !=', '');\r\n-\t\t$this->db->order_by('(COUNT(CASE WHEN vir.memo_kayit_tipi = \"ISP\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END))', 'DESC');\r\n+\t\t$this->db->order_by('(COUNT(CASE WHEN vir.memo_kayit_tipi LIKE \"%ISP%\" AND vir.talep_turu LIKE \"%ISP ve Neo Potansiyel Talep%\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi LIKE \"%ISP%\" AND vir.talep_turu LIKE \"%Uydu ve ISP Potansiyel Talep%\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"NEO\" THEN 1 END) + COUNT(CASE WHEN vir.memo_kayit_tipi = \"UYDU\" THEN 1 END))', 'DESC');\r\n \r\n \t\t$data['bayi_hesaplama'] = $this->db->get()->result();\r\n \r\n \t\t// Toplam istatistikler\r\n"
                },
                {
                    "date": 1755612789526,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2703,8 +2703,9 @@\n \t\t\t$this->db->join('voip_hakedis_ucretleri vhu', 'vhu.kullanici_id = k.kullanici_id', 'left');\r\n \t\t}\r\n \t\t\r\n \t\t$this->db->where('vir.satis_durumu', 'Tamamlandı');\r\n+\t\t$this->db->where('vir.guncel_outlet_durum', 'AKTIF');\r\n \t\t\r\n \t\t// Filtreleri uygula\r\n \t\tif (!empty($baslangic_tarihi)) {\r\n \t\t\t$this->db->where('vir.memo_kapanis_tarihi >=', $baslangic_tarihi);\r\n@@ -2728,8 +2729,9 @@\n \t\t// Toplam istatistikler\r\n \t\t$this->db->select('COUNT(*) as genel_toplam');\r\n \t\t$this->db->from('voip_iris_rapor');\r\n \t\t$this->db->where('satis_durumu', 'Tamamlandı');\r\n+\t\t$this->db->where('guncel_outlet_durum', 'AKTIF');\r\n \t\t\r\n \t\tif (!empty($baslangic_tarihi)) {\r\n \t\t\t$this->db->where('memo_kapanis_tarihi >=', $baslangic_tarihi);\r\n \t\t}\r\n"
                },
                {
                    "date": 1755614752051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2753,6 +2753,168 @@\n \tpublic function debug_test(){\r\n \t\t$this->load->view('voip/debug-test');\r\n \t}\r\n \r\n+\t/**\r\n+\t * Voip Hakediş Bayi Ödeme/Gider Sayfası (ID: 1908)\r\n+\t * URL: https://crm.ilekasoft.com/voip/bayi-odeme-gider\r\n+\t */\r\n+\tpublic function bayi_odeme_gider(){\r\n+\t\t// Modül yetkisi kontrolü (1908: Voip Hakediş Bayi Ödeme/Gider)\r\n+\t\tif (!grup_modul_yetkisi_var(1908)) {\r\n+\t\t\tredirect(\"home/hata2/1908\");\r\n+\t\t}\r\n+\r\n+\t\t$this->load->model('vt');\r\n+\t\t\r\n+\t\t// Sayfa verilerini hazırla\r\n+\t\t$data[\"baslik\"] = \"Voip / Hakediş Bayi Ödeme/Gider\";\r\n+\t\t\r\n+\t\t// Bayi (Cari) listesini getir - sadece aktif olanlar\r\n+\t\t$cariler = $this->vt->multiple('cari', array('cari_durum' => 1), 'cari_ad', 'ASC');\r\n+\t\t$data['cariler'] = $cariler;\r\n+\t\t\r\n+\t\t// Ödemeleri listele\r\n+\t\t$this->load->library('pagination');\r\n+\t\t\r\n+\t\t$config['base_url'] = base_url('voip/bayi-odeme-gider');\r\n+\t\t$config['total_rows'] = $this->db->count_all_results('voip_bayi_odemeler');\r\n+\t\t$config['per_page'] = 20;\r\n+\t\t$config['num_links'] = 3;\r\n+\t\t$config['page_query_string'] = TRUE;\r\n+\t\t$config['query_string_segment'] = 'sayfa';\r\n+\t\t\r\n+\t\t$this->pagination->initialize($config);\r\n+\t\t\r\n+\t\t$sayfa = $this->input->get('sayfa') ? $this->input->get('sayfa') : 0;\r\n+\t\t\r\n+\t\t// Ödemeleri bayi bilgisi ile birlikte getir\r\n+\t\t$this->db->select('bo.*, c.cari_ad, c.cari_soyad');\r\n+\t\t$this->db->from('voip_bayi_odemeler bo');\r\n+\t\t$this->db->join('cari c', 'c.cari_id = bo.bayi_id');\r\n+\t\t$this->db->order_by('bo.olusturma_tarihi', 'DESC');\r\n+\t\t$this->db->limit($config['per_page'], $sayfa);\r\n+\t\t$odemeler = $this->db->get()->result();\r\n+\t\t\r\n+\t\t$data['odemeler'] = $odemeler;\r\n+\t\t$data['pagination'] = $this->pagination->create_links();\r\n+\t\t\r\n+\t\t$this->load->view('voip/bayi-odeme-gider', $data);\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * Bayi Ödeme/Gider Kaydetme\r\n+\t */\r\n+\tpublic function bayi_odeme_kaydet(){\r\n+\t\t// Modül yetkisi kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(1908)) {\r\n+\t\t\tredirect(\"home/hata2/1908\");\r\n+\t\t}\r\n+\r\n+\t\t$this->load->model('vt');\r\n+\t\t\r\n+\t\tif ($this->input->post()) {\r\n+\t\t\t$bayi_id = $this->input->post('bayi_id');\r\n+\t\t\t$tur = $this->input->post('tur');\r\n+\t\t\t$tutar = $this->input->post('tutar');\r\n+\t\t\t$tarih = $this->input->post('tarih');\r\n+\t\t\t$aciklama = $this->input->post('aciklama');\r\n+\t\t\t\r\n+\t\t\t// Form validasyonu\r\n+\t\t\tif (empty($bayi_id) || empty($tur) || empty($tutar) || empty($tarih)) {\r\n+\t\t\t\t$this->session->set_flashdata('hata', 'Lütfen tüm zorunlu alanları doldurun.');\r\n+\t\t\t\tredirect('voip/bayi-odeme-gider');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Evrak yükleme işlemi\r\n+\t\t\t$evrak_dosyalar = array();\r\n+\t\t\tif (!empty($_FILES['evrak']['name'][0])) {\r\n+\t\t\t\t$config['upload_path'] = './assets/uploads/voip_bayi_odemeler/';\r\n+\t\t\t\t$config['allowed_types'] = 'pdf|doc|docx|jpg|jpeg|png|gif|txt|xlsx|xls';\r\n+\t\t\t\t$config['max_size'] = 10240; // 10MB\r\n+\t\t\t\t$config['encrypt_name'] = TRUE;\r\n+\t\t\t\t\r\n+\t\t\t\t// Klasör yoksa oluştur\r\n+\t\t\t\tif (!is_dir($config['upload_path'])) {\r\n+\t\t\t\t\tmkdir($config['upload_path'], 0755, true);\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t$this->load->library('upload', $config);\r\n+\t\t\t\t\r\n+\t\t\t\t$files_count = count($_FILES['evrak']['name']);\r\n+\t\t\t\tfor ($i = 0; $i < $files_count; $i++) {\r\n+\t\t\t\t\tif (!empty($_FILES['evrak']['name'][$i])) {\r\n+\t\t\t\t\t\t$_FILES['single_file']['name'] = $_FILES['evrak']['name'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['type'] = $_FILES['evrak']['type'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['tmp_name'] = $_FILES['evrak']['tmp_name'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['error'] = $_FILES['evrak']['error'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['size'] = $_FILES['evrak']['size'][$i];\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tif ($this->upload->do_upload('single_file')) {\r\n+\t\t\t\t\t\t\t$upload_data = $this->upload->data();\r\n+\t\t\t\t\t\t\t$evrak_dosyalar[] = 'voip_bayi_odemeler/' . $upload_data['file_name'];\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Veritabanına kaydet\r\n+\t\t\t$data_insert = array(\r\n+\t\t\t\t'bayi_id' => $bayi_id,\r\n+\t\t\t\t'tur' => $tur,\r\n+\t\t\t\t'tutar' => $tutar,\r\n+\t\t\t\t'tarih' => $tarih,\r\n+\t\t\t\t'aciklama' => $aciklama,\r\n+\t\t\t\t'evrak' => !empty($evrak_dosyalar) ? implode(',', $evrak_dosyalar) : null\r\n+\t\t\t);\r\n+\t\t\t\r\n+\t\t\tif ($this->vt->insert('voip_bayi_odemeler', $data_insert)) {\r\n+\t\t\t\t$this->session->set_flashdata('basarili', 'Ödeme/Gider başarıyla kaydedildi.');\r\n+\t\t\t} else {\r\n+\t\t\t\t$this->session->set_flashdata('hata', 'Kaydetme sırasında bir hata oluştu.');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tredirect('voip/bayi-odeme-gider');\r\n+\t\t}\r\n+\t}\r\n+\r\n+\t/**\r\n+\t * Bayi Ödeme/Gider Silme\r\n+\t */\r\n+\tpublic function bayi_odeme_sil($id){\r\n+\t\t// Modül yetkisi kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(1908)) {\r\n+\t\t\tredirect(\"home/hata2/1908\");\r\n+\t\t}\r\n+\r\n+\t\t$this->load->model('vt');\r\n+\t\t\r\n+\t\t// Önce kaydı getir (evrak dosyalarını silmek için)\r\n+\t\t$odeme = $this->vt->single('voip_bayi_odemeler', array('id' => $id));\r\n+\t\t\r\n+\t\tif ($odeme) {\r\n+\t\t\t// Evrak dosyalarını sil\r\n+\t\t\tif (!empty($odeme->evrak)) {\r\n+\t\t\t\t$dosyalar = explode(',', $odeme->evrak);\r\n+\t\t\t\tforeach ($dosyalar as $dosya) {\r\n+\t\t\t\t\t$dosya_yolu = './assets/uploads/' . $dosya;\r\n+\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n+\t\t\t\t\t\tunlink($dosya_yolu);\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Veritabanından sil\r\n+\t\t\tif ($this->vt->del('voip_bayi_odemeler', 'id', $id)) {\r\n+\t\t\t\t$this->session->set_flashdata('basarili', 'Kayıt başarıyla silindi.');\r\n+\t\t\t} else {\r\n+\t\t\t\t$this->session->set_flashdata('hata', 'Silme işlemi sırasında bir hata oluştu.');\r\n+\t\t\t}\r\n+\t\t} else {\r\n+\t\t\t$this->session->set_flashdata('hata', 'Kayıt bulunamadı.');\r\n+\t\t}\r\n+\t\t\r\n+\t\tredirect('voip/bayi-odeme-gider');\r\n+\t}\r\n+\r\n }\r\n \r\n"
                },
                {
                    "date": 1755616630080,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2768,11 +2768,15 @@\n \t\t\r\n \t\t// Sayfa verilerini hazırla\r\n \t\t$data[\"baslik\"] = \"Voip / Hakediş Bayi Ödeme/Gider\";\r\n \t\t\r\n-\t\t// Bayi (Cari) listesini getir - sadece aktif olanlar\r\n-\t\t$cariler = $this->vt->multiple('cari', array('cari_durum' => 1), 'cari_ad', 'ASC');\r\n-\t\t$data['cariler'] = $cariler;\r\n+\t\t// Kullanıcı (Bayi) listesini getir - sadece aktif olanlar\r\n+\t\t$this->db->select('kullanici_id, kullanici_ad, kullanici_soyad');\r\n+\t\t$this->db->from('kullanicilar');\r\n+\t\t$this->db->where('kullanici_durum', 1);\r\n+\t\t$this->db->order_by('kullanici_ad', 'ASC');\r\n+\t\t$kullanicilar = $this->db->get()->result();\r\n+\t\t$data['kullanicilar'] = $kullanicilar;\r\n \t\t\r\n \t\t// Ödemeleri listele\r\n \t\t$this->load->library('pagination');\r\n \t\t\r\n@@ -2786,12 +2790,12 @@\n \t\t$this->pagination->initialize($config);\r\n \t\t\r\n \t\t$sayfa = $this->input->get('sayfa') ? $this->input->get('sayfa') : 0;\r\n \t\t\r\n-\t\t// Ödemeleri bayi bilgisi ile birlikte getir\r\n-\t\t$this->db->select('bo.*, c.cari_ad, c.cari_soyad');\r\n+\t\t// Ödemeleri kullanıcı bilgisi ile birlikte getir\r\n+\t\t$this->db->select('bo.*, k.kullanici_ad, k.kullanici_soyad');\r\n \t\t$this->db->from('voip_bayi_odemeler bo');\r\n-\t\t$this->db->join('cari c', 'c.cari_id = bo.bayi_id');\r\n+\t\t$this->db->join('kullanicilar k', 'k.kullanici_id = bo.bayi_id');\r\n \t\t$this->db->order_by('bo.olusturma_tarihi', 'DESC');\r\n \t\t$this->db->limit($config['per_page'], $sayfa);\r\n \t\t$odemeler = $this->db->get()->result();\r\n \t\t\r\n"
                },
                {
                    "date": 1755867242975,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1889,10 +1889,12 @@\n \t\t$bitis_tarihi = $this->input->post('bitis_tarihi');\r\n \r\n \t\t$numara_id = $this->input->post('numara_id'); // Opsiyonel, belirli numara filtresi\r\n \r\n+\t\t$operator_id = $this->input->post('operator_id'); // Operatör filtresi\r\n \r\n \r\n+\r\n \t\tif(empty($baslangic_tarihi) || empty($bitis_tarihi)) {\r\n \r\n \t\t\techo json_encode(['success' => false, 'message' => 'Başlangıç ve bitiş tarihi gereklidir']);\r\n \r\n@@ -1950,10 +1952,14 @@\n \r\n \t\t\t$this->db->where('vgh.numara_id', $numara_id);\r\n \r\n \t\t}\r\n-\r\n \t\t\r\n+\t\t// Operatör filtresi eklendi\r\n+\t\tif(!empty($operator_id)) {\r\n+\t\t\t$this->db->where('vo.operator_adi', $operator_id);\r\n+\t\t}\r\n+\t\t\r\n \r\n \t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n \r\n \t\t$harcamalar = $this->db->get()->result();\r\n"
                },
                {
                    "date": 1755876597216,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -627,16 +627,70 @@\n \t\t$data[\"operatorler\"] = $this->db->get('voip_operator')->result();\r\n \r\n \t\t\r\n \r\n-\t\t// Numaraları getir\r\n+\t\t// Filtreleme parametrelerini al\r\n \r\n+\t\t$filtre_numara = $this->input->post('filtre_numara');\r\n+\r\n+\t\t$filtre_operator = $this->input->post('filtre_operator');\r\n+\r\n+\t\t$filtre_kullanici = $this->input->post('filtre_kullanici');\r\n+\r\n+\t\t$filtre_durum = $this->input->post('filtre_durum');\r\n+\r\n+\t\t\r\n+\r\n+\t\t// Filtreleri data'ya ekle\r\n+\r\n+\t\t$data[\"filtre_numara\"] = $filtre_numara;\r\n+\r\n+\t\t$data[\"filtre_operator\"] = $filtre_operator;\r\n+\r\n+\t\t$data[\"filtre_kullanici\"] = $filtre_kullanici;\r\n+\r\n+\t\t$data[\"filtre_durum\"] = $filtre_durum;\r\n+\r\n+\t\t\r\n+\r\n+\t\t// Numaraları getir - filtreleme ile\r\n+\r\n \t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n \r\n \t\t$this->db->from('voip_numara');\r\n \r\n \t\t$this->db->join('voip_operator', 'voip_numara.operator_id = voip_operator.operator_id', 'left');\r\n \r\n+\t\t\r\n+\r\n+\t\t// Filtreler\r\n+\r\n+\t\tif(!empty($filtre_numara)) {\r\n+\r\n+\t\t\t$this->db->like('voip_numara.voip_numara', $filtre_numara);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif(!empty($filtre_operator)) {\r\n+\r\n+\t\t\t$this->db->where('voip_numara.operator_id', $filtre_operator);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif(!empty($filtre_kullanici)) {\r\n+\r\n+\t\t\t$this->db->like('voip_numara.kullanici_adi', $filtre_kullanici);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif($filtre_durum !== '' && $filtre_durum !== null) {\r\n+\r\n+\t\t\t$this->db->where('voip_numara.durum', $filtre_durum);\r\n+\r\n+\t\t}\r\n+\r\n+\t\t\r\n+\r\n \t\t$this->db->order_by('voip_numara.numara_id', 'DESC');\r\n \r\n \t\t$data[\"numaralar\"] = $this->db->get()->result();\r\n \r\n@@ -987,8 +1041,40 @@\n \t\t$data[\"baslik\"] = \"Voip & Hakediş / Numara Teslim\";\r\n \r\n \t\t\r\n \r\n+\t\t// Filtreleme parametrelerini al\r\n+\r\n+\t\t$filtre_numara = $this->input->post('filtre_numara');\r\n+\r\n+\t\t$filtre_operator = $this->input->post('filtre_operator');\r\n+\r\n+\t\t$filtre_kullanici = $this->input->post('filtre_kullanici');\r\n+\r\n+\t\t$filtre_tarih_baslangic = $this->input->post('filtre_tarih_baslangic');\r\n+\r\n+\t\t$filtre_tarih_bitis = $this->input->post('filtre_tarih_bitis');\r\n+\r\n+\t\t$filtre_durum = $this->input->post('filtre_durum');\r\n+\r\n+\t\t\r\n+\r\n+\t\t// Filtreleri data'ya ekle\r\n+\r\n+\t\t$data[\"filtre_numara\"] = $filtre_numara;\r\n+\r\n+\t\t$data[\"filtre_operator\"] = $filtre_operator;\r\n+\r\n+\t\t$data[\"filtre_kullanici\"] = $filtre_kullanici;\r\n+\r\n+\t\t$data[\"filtre_tarih_baslangic\"] = $filtre_tarih_baslangic;\r\n+\r\n+\t\t$data[\"filtre_tarih_bitis\"] = $filtre_tarih_bitis;\r\n+\r\n+\t\t$data[\"filtre_durum\"] = $filtre_durum;\r\n+\r\n+\t\t\r\n+\r\n \t\t// Aktif numaraları getir (operator ile birlikte)\r\n \r\n \t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n \r\n@@ -1017,10 +1103,16 @@\n \t\t$data[\"kullanicilar\"] = $this->db->get()->result();\r\n \r\n \t\t\r\n \r\n-\t\t// Teslim kayıtlarını getir\r\n+\t\t// Operatörleri getir\r\n \r\n+\t\t$data[\"operatorler\"] = $this->db->get('voip_operator')->result();\r\n+\r\n+\t\t\r\n+\r\n+\t\t// Teslim kayıtlarını getir - filtreleme ile\r\n+\r\n \t\t$this->db->select('vnt.*, vn.voip_numara, vo.operator_adi, k.kullanici_ad, k.kullanici_soyad');\r\n \r\n \t\t$this->db->from('voip_numara_teslim vnt');\r\n \r\n@@ -1029,8 +1121,62 @@\n \t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n \r\n \t\t$this->db->join('kullanicilar k', 'vnt.kullanici_id = k.kullanici_id', 'left');\r\n \r\n+\t\t\r\n+\r\n+\t\t// Filtreler\r\n+\r\n+\t\tif(!empty($filtre_numara)) {\r\n+\r\n+\t\t\t$this->db->like('vn.voip_numara', $filtre_numara);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif(!empty($filtre_operator)) {\r\n+\r\n+\t\t\t$this->db->where('vn.operator_id', $filtre_operator);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif(!empty($filtre_kullanici)) {\r\n+\r\n+\t\t\t$this->db->where('vnt.kullanici_id', $filtre_kullanici);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif(!empty($filtre_tarih_baslangic)) {\r\n+\r\n+\t\t\t$this->db->where('DATE(vnt.teslim_tarihi) >=', $filtre_tarih_baslangic);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif(!empty($filtre_tarih_bitis)) {\r\n+\r\n+\t\t\t$this->db->where('DATE(vnt.teslim_tarihi) <=', $filtre_tarih_bitis);\r\n+\r\n+\t\t}\r\n+\r\n+\t\tif($filtre_durum !== '' && $filtre_durum !== null) {\r\n+\r\n+\t\t\tif($filtre_durum == '1') {\r\n+\r\n+\t\t\t\t// Aktif (İade edilmemiş)\r\n+\r\n+\t\t\t\t$this->db->where('vnt.iade_tarihi IS NULL', null, false);\r\n+\r\n+\t\t\t} elseif($filtre_durum == '0') {\r\n+\r\n+\t\t\t\t// İade edilmiş\r\n+\r\n+\t\t\t\t$this->db->where('vnt.iade_tarihi IS NOT NULL', null, false);\r\n+\r\n+\t\t\t}\r\n+\r\n+\t\t}\r\n+\r\n+\t\t\r\n+\r\n \t\t$this->db->order_by('vnt.teslim_tarihi', 'DESC');\r\n \r\n \t\t$data[\"teslimler\"] = $this->db->get()->result();\r\n \r\n"
                }
            ],
            "date": 1754724208108,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Voip extends CI_Controller {\r\n\r\n\r\n\r\n\tpublic function __construct(){\r\n\r\n\t\tparent::__construct();\r\n\r\n\r\n\r\n\t\t// Gerekli library ve helper'ları yükle\r\n\r\n\t\t$this->load->database();\r\n\r\n\t\t$this->load->helper(['url', 'general']);\r\n\r\n\t\t$this->load->library(['session', 'form_validation']);\r\n\r\n\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif(!$control){\r\n\r\n\t\t\tredirect(\"home/login\");\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Operatör Tanımlama Sayfası\r\n\r\n\t * URL: https://crm.ilekasoft.com/voip/operator-tanimla\r\n\r\n\t */\r\n\r\n\tpublic function operator_tanimla(){\r\n\r\n\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1900)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Voip Operatör Tanımla (ID:1901) alt modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1901)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Voip & Hakediş / Operatör Tanımla\";\r\n\r\n\t\t\r\n\r\n\t\t// Operatörleri getir\r\n\r\n\t\t$data[\"operatorler\"] = $this->db->get('voip_operator')->result();\r\n\r\n\t\t\r\n\r\n\t\t// Her operatör için panel bilgilerini getir\r\n\r\n\t\tforeach($data[\"operatorler\"] as $operator) {\r\n\r\n\t\t\t$operator->paneller = $this->db->get_where('voip_operator_panel', ['operator_id' => $operator->operator_id])->result();\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// View yükleme\r\n\r\n\t\t$this->load->view('voip/operator-tanimla', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Operatör Ekle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function operator_ekle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\t\t\r\n\r\n\t\t// Debug log\r\n\r\n\t\terror_log('VoIP operator_ekle çağrıldı - ' . date('Y-m-d H:i:s'));\r\n\r\n\t\terror_log('POST data: ' . print_r($_POST, true));\r\n\r\n\t\t\r\n\r\n\t\t// Yetki kontrolü\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$yetki_var = grup_modul_yetkisi_var(1901);\r\n\r\n\t\t\terror_log('Yetki kontrolü sonucu: ' . ($yetki_var ? 'var' : 'yok'));\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(!$yetki_var) {\r\n\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\t\treturn;\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log('Yetki kontrolü hatası: ' . $e->getMessage());\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki kontrolü hatası: ' . $e->getMessage()]);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// POST verilerini al\r\n\r\n\t\t$operator_adi = $this->input->post('operator_adi');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\t\t\r\n\r\n\t\terror_log('Operator adı: ' . $operator_adi);\r\n\r\n\t\terror_log('Açıklama: ' . $aciklama);\r\n\r\n\r\n\r\n\t\t// Validation\r\n\r\n\t\tif(empty($operator_adi)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Operatör adı gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı isimde operatör var mı kontrol et\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$existing = $this->db->get_where('voip_operator', ['operator_adi' => $operator_adi])->row();\r\n\r\n\t\t\tif($existing) {\r\n\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Bu operatör adı zaten kullanımda']);\r\n\r\n\t\t\t\treturn;\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log('Veritabanı kontrol hatası: ' . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Veri hazırla\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'operator_adi' => trim($operator_adi),\r\n\r\n\t\t\t'aciklama' => trim($aciklama)\r\n\r\n\t\t];\r\n\r\n\t\t\r\n\r\n\t\terror_log('Kaydedilecek data: ' . print_r($data, true));\r\n\r\n\r\n\r\n\t\t// Veritabanına kaydet\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$result = $this->db->insert('voip_operator', $data);\r\n\r\n\t\t\terror_log('Insert sonucu: ' . ($result ? 'başarılı' : 'başarısız'));\r\n\r\n\t\t\t\r\n\r\n\t\t\tif($result) {\r\n\r\n\t\t\t\t$insert_id = $this->db->insert_id();\r\n\r\n\t\t\t\terror_log('Insert ID: ' . $insert_id);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\techo json_encode([\r\n\r\n\t\t\t\t\t'success' => true, \r\n\r\n\t\t\t\t\t'message' => 'Operatör başarıyla eklendi',\r\n\r\n\t\t\t\t\t'operator_id' => $insert_id\r\n\r\n\t\t\t\t]);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t$db_error = $this->db->error();\r\n\r\n\t\t\t\terror_log('DB Error: ' . print_r($db_error, true));\r\n\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı kaydetme hatası']);\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log('Veritabanı insert hatası: ' . $e->getMessage());\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası: ' . $e->getMessage()]);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Operatör Sil (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function operator_sil(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1901)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$operator_id = $this->input->post('operator_id');\r\n\r\n\r\n\r\n\t\tif(empty($operator_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Operatör ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Operatörü sil\r\n\r\n\t\tif($this->db->delete('voip_operator', ['operator_id' => $operator_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Operatör başarıyla silindi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Operatör Güncelle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function operator_guncelle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1901)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$operator_id = $this->input->post('operator_id');\r\n\r\n\t\t$operator_adi = $this->input->post('operator_adi');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\tif(empty($operator_id) || empty($operator_adi)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Operatör ID ve adı gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı isimde başka operatör var mı kontrol et\r\n\r\n\t\t$existing = $this->db->query(\"SELECT * FROM voip_operator WHERE operator_adi = ? AND operator_id != ?\", [$operator_adi, $operator_id])->row();\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu operatör adı zaten kullanımda']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'operator_adi' => trim($operator_adi),\r\n\r\n\t\t\t'aciklama' => trim($aciklama)\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->update('voip_operator', $data, ['operator_id' => $operator_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Operatör başarıyla güncellendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Panel Ekle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function panel_ekle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1901)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$operator_id = $this->input->post('operator_id');\r\n\r\n\t\t$panel_link = $this->input->post('panel_link');\r\n\r\n\t\t$panel_kullanici_adi = $this->input->post('panel_kullanici_adi');\r\n\r\n\t\t$panel_sifre = $this->input->post('panel_sifre');\r\n\r\n\r\n\r\n\t\tif(empty($operator_id) || empty($panel_link)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Operatör ve panel linki gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'operator_id' => $operator_id,\r\n\r\n\t\t\t'panel_link' => trim($panel_link),\r\n\r\n\t\t\t'panel_kullanici_adi' => trim($panel_kullanici_adi),\r\n\r\n\t\t\t'panel_sifre' => trim($panel_sifre)\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->insert('voip_operator_panel', $data)) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Panel başarıyla eklendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Panel Sil (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function panel_sil(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1901)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$panel_id = $this->input->post('panel_id');\r\n\r\n\r\n\r\n\t\tif(empty($panel_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Panel ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif($this->db->delete('voip_operator_panel', ['panel_id' => $panel_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Panel başarıyla silindi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Panel Güncelle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function panel_guncelle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1901)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$panel_id = $this->input->post('panel_id');\r\n\r\n\t\t$panel_link = $this->input->post('panel_link');\r\n\r\n\t\t$panel_kullanici_adi = $this->input->post('panel_kullanici_adi');\r\n\r\n\t\t$panel_sifre = $this->input->post('panel_sifre');\r\n\r\n\r\n\r\n\t\tif(empty($panel_id) || empty($panel_link)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Panel ID ve linki gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'panel_link' => trim($panel_link),\r\n\r\n\t\t\t'panel_kullanici_adi' => trim($panel_kullanici_adi),\r\n\r\n\t\t\t'panel_sifre' => trim($panel_sifre)\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->update('voip_operator_panel', $data, ['panel_id' => $panel_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Panel başarıyla güncellendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Tanımlama Sayfası\r\n\r\n\t * URL: https://crm.ilekasoft.com/voip/numara-tanimla\r\n\r\n\t */\r\n\r\n\tpublic function numara_tanimla(){\r\n\r\n\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1900)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Voip Numara Tanımla (ID:1902) alt modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1902)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Voip & Hakediş / Numara Tanımla\";\r\n\r\n\t\t\r\n\r\n\t\t// Operatörleri getir\r\n\r\n\t\t$data[\"operatorler\"] = $this->db->get('voip_operator')->result();\r\n\r\n\t\t\r\n\r\n\t\t// Numaraları getir\r\n\r\n\t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n\r\n\t\t$this->db->from('voip_numara');\r\n\r\n\t\t$this->db->join('voip_operator', 'voip_numara.operator_id = voip_operator.operator_id', 'left');\r\n\r\n\t\t$this->db->order_by('voip_numara.numara_id', 'DESC');\r\n\r\n\t\t$data[\"numaralar\"] = $this->db->get()->result();\r\n\r\n\r\n\r\n\t\t$this->load->view('voip/numara-tanimla', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Ekle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function numara_ekle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1902)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$operator_id = $this->input->post('operator_id');\r\n\r\n\t\t$voip_numara = $this->input->post('voip_numara');\r\n\r\n\t\t$kullanici_adi = $this->input->post('kullanici_adi');\r\n\r\n\t\t$sifre = $this->input->post('sifre');\r\n\r\n\t\t$ip_adresi = $this->input->post('ip_adresi');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\t\t$durum = $this->input->post('durum') ? 1 : 0;\r\n\r\n\r\n\r\n\t\tif(empty($operator_id) || empty($voip_numara)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Operatör ve numara gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı numara var mı kontrol et\r\n\r\n\t\t$existing = $this->db->get_where('voip_numara', ['voip_numara' => $voip_numara])->row();\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara zaten kayıtlı']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'operator_id' => $operator_id,\r\n\r\n\t\t\t'voip_numara' => trim($voip_numara),\r\n\r\n\t\t\t'kullanici_adi' => trim($kullanici_adi),\r\n\r\n\t\t\t'sifre' => trim($sifre),\r\n\r\n\t\t\t'ip_adresi' => trim($ip_adresi),\r\n\r\n\t\t\t'aciklama' => trim($aciklama),\r\n\r\n\t\t\t'durum' => $durum\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->insert('voip_numara', $data)) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Numara başarıyla eklendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Sil (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function numara_sil(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1902)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\r\n\r\n\t\tif(empty($numara_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif($this->db->delete('voip_numara', ['numara_id' => $numara_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Numara başarıyla silindi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Güncelle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function numara_guncelle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1902)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\t\t$operator_id = $this->input->post('operator_id');\r\n\r\n\t\t$voip_numara = $this->input->post('voip_numara');\r\n\r\n\t\t$kullanici_adi = $this->input->post('kullanici_adi');\r\n\r\n\t\t$sifre = $this->input->post('sifre');\r\n\r\n\t\t$ip_adresi = $this->input->post('ip_adresi');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\t\t$durum = $this->input->post('durum') ? 1 : 0;\r\n\r\n\r\n\r\n\t\tif(empty($numara_id) || empty($operator_id) || empty($voip_numara)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara ID, operatör ve numara gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı numara başka kayıtta var mı kontrol et\r\n\r\n\t\t$existing = $this->db->query(\"SELECT * FROM voip_numara WHERE voip_numara = ? AND numara_id != ?\", [$voip_numara, $numara_id])->row();\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara zaten kayıtlı']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'operator_id' => $operator_id,\r\n\r\n\t\t\t'voip_numara' => trim($voip_numara),\r\n\r\n\t\t\t'kullanici_adi' => trim($kullanici_adi),\r\n\r\n\t\t\t'sifre' => trim($sifre),\r\n\r\n\t\t\t'ip_adresi' => trim($ip_adresi),\r\n\r\n\t\t\t'aciklama' => trim($aciklama),\r\n\r\n\t\t\t'durum' => $durum\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->update('voip_numara', $data, ['numara_id' => $numara_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Numara başarıyla güncellendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Getir (AJAX) - Düzenleme için\r\n\r\n\t */\r\n\r\n\tpublic function numara_getir(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1902)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\r\n\r\n\t\tif(empty($numara_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$numara = $this->db->get_where('voip_numara', ['numara_id' => $numara_id])->row();\r\n\r\n\r\n\r\n\t\tif($numara) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'data' => $numara]);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara bulunamadı']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Teslim Sayfası\r\n\r\n\t * URL: https://crm.ilekasoft.com/voip/numara-teslim\r\n\r\n\t */\r\n\r\n\tpublic function numara_teslim(){\r\n\r\n\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1900)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Voip Numara Teslim (ID:1903) alt modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1903)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Voip & Hakediş / Numara Teslim\";\r\n\r\n\t\t\r\n\r\n\t\t// Aktif numaraları getir (operator ile birlikte)\r\n\r\n\t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n\r\n\t\t$this->db->from('voip_numara');\r\n\r\n\t\t$this->db->join('voip_operator', 'voip_numara.operator_id = voip_operator.operator_id', 'left');\r\n\r\n\t\t$this->db->where('voip_numara.durum', 1); // Sadece aktif numaralar\r\n\r\n\t\t$this->db->order_by('voip_operator.operator_adi, voip_numara.voip_numara');\r\n\r\n\t\t$data[\"numaralar\"] = $this->db->get()->result();\r\n\r\n\t\t\r\n\r\n\t\t// Aktif kullanıcıları getir\r\n\r\n\t\t$this->db->select('kullanici_id, kullanici_ad, kullanici_soyad');\r\n\r\n\t\t$this->db->from('kullanicilar');\r\n\r\n\t\t$this->db->where('kullanici_durum', 1);\r\n\r\n\t\t$this->db->order_by('kullanici_ad, kullanici_soyad');\r\n\r\n\t\t$data[\"kullanicilar\"] = $this->db->get()->result();\r\n\r\n\t\t\r\n\r\n\t\t// Teslim kayıtlarını getir\r\n\r\n\t\t$this->db->select('vnt.*, vn.voip_numara, vo.operator_adi, k.kullanici_ad, k.kullanici_soyad');\r\n\r\n\t\t$this->db->from('voip_numara_teslim vnt');\r\n\r\n\t\t$this->db->join('voip_numara vn', 'vnt.numara_id = vn.numara_id', 'left');\r\n\r\n\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n\r\n\t\t$this->db->join('kullanicilar k', 'vnt.kullanici_id = k.kullanici_id', 'left');\r\n\r\n\t\t$this->db->order_by('vnt.teslim_tarihi', 'DESC');\r\n\r\n\t\t$data[\"teslimler\"] = $this->db->get()->result();\r\n\r\n\r\n\r\n\t\t$this->load->view('voip/numara-teslim', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Teslim Ekle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function teslim_ekle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1903)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\t\t$kullanici_id = $this->input->post('kullanici_id');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\tif(empty($numara_id) || empty($kullanici_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara ve kullanıcı seçimi gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı numara için aktif teslim var mı kontrol et (iade edilmemiş)\r\n\r\n\t\t$existing = $this->db->get_where('voip_numara_teslim', [\r\n\r\n\t\t\t'numara_id' => $numara_id,\r\n\r\n\t\t\t'iade_tarihi' => NULL\r\n\r\n\t\t])->row();\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara zaten teslim edilmiş ve henüz iade edilmemiş']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'numara_id' => $numara_id,\r\n\r\n\t\t\t'kullanici_id' => $kullanici_id,\r\n\r\n\t\t\t'aciklama' => trim($aciklama),\r\n\r\n\t\t\t'teslim_tarihi' => date('Y-m-d H:i:s')\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->insert('voip_numara_teslim', $data)) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Numara başarıyla teslim edildi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Teslim Sil (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function teslim_sil(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1903)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$teslim_id = $this->input->post('teslim_id');\r\n\r\n\r\n\r\n\t\tif(empty($teslim_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Teslim ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif($this->db->delete('voip_numara_teslim', ['teslim_id' => $teslim_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Teslim kaydı başarıyla silindi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Teslim Güncelle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function teslim_guncelle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1903)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$teslim_id = $this->input->post('teslim_id');\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\t\t$kullanici_id = $this->input->post('kullanici_id');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\tif(empty($teslim_id) || empty($numara_id) || empty($kullanici_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Teslim ID, numara ve kullanıcı seçimi gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı numara için başka aktif teslim var mı kontrol et\r\n\r\n\t\t$existing = $this->db->query(\"SELECT * FROM voip_numara_teslim WHERE numara_id = ? AND teslim_id != ?\", [$numara_id, $teslim_id])->row();\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara başka bir kullanıcıya teslim edilmiş']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'numara_id' => $numara_id,\r\n\r\n\t\t\t'kullanici_id' => $kullanici_id,\r\n\r\n\t\t\t'aciklama' => trim($aciklama)\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->update('voip_numara_teslim', $data, ['teslim_id' => $teslim_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Teslim kaydı başarıyla güncellendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara Teslim Getir (AJAX) - Düzenleme için\r\n\r\n\t */\r\n\r\n\tpublic function teslim_getir(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1903)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$teslim_id = $this->input->post('teslim_id');\r\n\r\n\r\n\r\n\t\tif(empty($teslim_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Teslim ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$teslim = $this->db->get_where('voip_numara_teslim', ['teslim_id' => $teslim_id])->row();\r\n\r\n\r\n\r\n\t\tif($teslim) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'data' => $teslim]);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Teslim kaydı bulunamadı']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Numara İade Et (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function numara_iade(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1903)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$teslim_id = $this->input->post('teslim_id');\r\n\r\n\r\n\r\n\t\tif(empty($teslim_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Teslim ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Teslim kaydını kontrol et\r\n\r\n\t\t$teslim = $this->db->get_where('voip_numara_teslim', ['teslim_id' => $teslim_id])->row();\r\n\r\n\t\tif(!$teslim) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Teslim kaydı bulunamadı']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Zaten iade edilmiş mi kontrol et\r\n\r\n\t\tif($teslim->iade_tarihi) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara zaten iade edilmiş']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// İade tarihini güncelle\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'iade_tarihi' => date('Y-m-d H:i:s')\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->update('voip_numara_teslim', $data, ['teslim_id' => $teslim_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Numara başarıyla iade edildi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Günlük Harcama Sayfası\r\n\r\n\t * URL: https://crm.ilekasoft.com/voip/gunluk-harcama\r\n\r\n\t */\r\n\r\n\tpublic function gunluk_harcama(){\r\n\r\n\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1900)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Voip Günlük Harcama (ID:1904) alt modül yetkisi kontrolü\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1904)) {\r\n\r\n\t\t\tredirect(\"home/hata\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data[\"baslik\"] = \"Voip & Hakediş / Günlük Harcama\";\r\n\r\n\t\t\r\n\r\n\t\t// Aktif numaraları getir (operator ile birlikte)\r\n\r\n\t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n\r\n\t\t$this->db->from('voip_numara');\r\n\r\n\t\t$this->db->join('voip_operator', 'voip_numara.operator_id = voip_operator.operator_id', 'left');\r\n\r\n\t\t$this->db->where('voip_numara.durum', 1); // Sadece aktif numaralar\r\n\r\n\t\t$this->db->order_by('voip_operator.operator_adi, voip_numara.voip_numara');\r\n\r\n\t\t$data[\"numaralar\"] = $this->db->get()->result();\r\n\r\n\t\t\r\n\r\n\t\t// Günlük harcama kayıtlarını getir (son 30 gün)\r\n\r\n\t\t$this->db->select('vgh.*, vn.voip_numara, vo.operator_adi, \r\n\r\n\t\t\tCOALESCE(teslim_k.kullanici_ad, k.kullanici_ad) as kullanici_ad, \r\n\r\n\t\t\tCOALESCE(teslim_k.kullanici_soyad, k.kullanici_soyad) as kullanici_soyad');\r\n\r\n\t\t$this->db->from('voip_gunluk_harcama vgh');\r\n\r\n\t\t$this->db->join('voip_numara vn', 'vgh.numara_id = vn.numara_id', 'left');\r\n\r\n\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n\r\n\t\t$this->db->join('kullanicilar k', 'vgh.kaydeden_kullanici_id = k.kullanici_id', 'left');\r\n\r\n\t\t\r\n\r\n\t\t// O tarihte numaranın teslim edildiği kullanıcıyı bul\r\n\r\n\t\t$this->db->join('(SELECT vnt1.numara_id, vnt1.kullanici_id, vnt1.teslim_tarihi \r\n\r\n\t\t\tFROM voip_numara_teslim vnt1 \r\n\r\n\t\t\tWHERE vnt1.iade_tarihi IS NULL \r\n\r\n\t\t\tAND vnt1.teslim_tarihi = (\r\n\r\n\t\t\t\tSELECT MAX(vnt2.teslim_tarihi) \r\n\r\n\t\t\t\tFROM voip_numara_teslim vnt2 \r\n\r\n\t\t\t\tWHERE vnt2.numara_id = vnt1.numara_id \r\n\r\n\t\t\t\tAND vnt2.iade_tarihi IS NULL\r\n\r\n\t\t\t)) teslim_son', 'vgh.numara_id = teslim_son.numara_id AND DATE(teslim_son.teslim_tarihi) <= vgh.tarih', 'left');\r\n\r\n\t\t$this->db->join('kullanicilar teslim_k', 'teslim_son.kullanici_id = teslim_k.kullanici_id', 'left');\r\n\r\n\t\t$this->db->where('vgh.tarih >=', date('Y-m-d', strtotime('-30 days')));\r\n\r\n\t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n\r\n\t\t$data[\"harcamalar\"] = $this->db->get()->result();\r\n\r\n\r\n\r\n\t\t$this->load->view('voip/gunluk-harcama', $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Günlük Harcama Ekle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function harcama_ekle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1904)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\t\t$tarih = $this->input->post('tarih');\r\n\r\n\t\t$harcama_tutari = $this->input->post('harcama_tutari');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\tif(empty($numara_id) || empty($tarih) || empty($harcama_tutari)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara, tarih ve harcama tutarı gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Tutar kontrolü\r\n\r\n\t\tif(!is_numeric($harcama_tutari) || $harcama_tutari < 0) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama tutarı geçerli bir sayı olmalıdır']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Session bilgisini güvenli şekilde al\r\n\r\n\t\t$login_info = session(\"r\", \"login_info\");\r\n\r\n\t\t$kullanici_id = null;\r\n\r\n\t\tif(is_object($login_info) && isset($login_info->kullanici_id)) {\r\n\r\n\t\t\t$kullanici_id = $login_info->kullanici_id;\r\n\r\n\t\t} elseif(is_array($login_info) && isset($login_info['kullanici_id'])) {\r\n\r\n\t\t\t$kullanici_id = $login_info['kullanici_id'];\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı numara ve tarih için kayıt var mı kontrol et\r\n\r\n\t\t$existing = $this->db->get_where('voip_gunluk_harcama', [\r\n\r\n\t\t\t'numara_id' => $numara_id,\r\n\r\n\t\t\t'tarih' => $tarih\r\n\r\n\t\t])->row();\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'numara_id' => $numara_id,\r\n\r\n\t\t\t'tarih' => $tarih,\r\n\r\n\t\t\t'harcama_tutari' => number_format($harcama_tutari, 2, '.', ''),\r\n\r\n\t\t\t'aciklama' => trim($aciklama),\r\n\r\n\t\t\t'kaydeden_kullanici_id' => $kullanici_id\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\t// Eğer kayıt varsa güncelle\r\n\r\n\t\t\tif($this->db->update('voip_gunluk_harcama', $data, ['harcama_id' => $existing->harcama_id])) {\r\n\r\n\t\t\t\techo json_encode(['success' => true, 'message' => 'Harcama kaydı başarıyla güncellendi']);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Eğer kayıt yoksa yeni ekle\r\n\r\n\t\t\tif($this->db->insert('voip_gunluk_harcama', $data)) {\r\n\r\n\t\t\t\techo json_encode(['success' => true, 'message' => 'Harcama kaydı başarıyla eklendi']);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Günlük Harcama Sil (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function harcama_sil(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1904)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$harcama_id = $this->input->post('harcama_id');\r\n\r\n\r\n\r\n\t\tif(empty($harcama_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif($this->db->delete('voip_gunluk_harcama', ['harcama_id' => $harcama_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Harcama kaydı başarıyla silindi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Günlük Harcama Güncelle (AJAX)\r\n\r\n\t */\r\n\r\n\tpublic function harcama_guncelle(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1904)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$harcama_id = $this->input->post('harcama_id');\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\r\n\t\t$tarih = $this->input->post('tarih');\r\n\r\n\t\t$harcama_tutari = $this->input->post('harcama_tutari');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\tif(empty($harcama_id) || empty($numara_id) || empty($tarih) || empty($harcama_tutari)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama ID, numara, tarih ve harcama tutarı gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Tutar kontrolü\r\n\r\n\t\tif(!is_numeric($harcama_tutari) || $harcama_tutari < 0) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama tutarı geçerli bir sayı olmalıdır']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Aynı numara ve tarih için başka kayıt var mı kontrol et\r\n\r\n\t\t$existing = $this->db->query(\"SELECT * FROM voip_gunluk_harcama WHERE numara_id = ? AND tarih = ? AND harcama_id != ?\", [$numara_id, $tarih, $harcama_id])->row();\r\n\r\n\t\tif($existing) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara için bu tarihte zaten başka harcama kaydı var']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$data = [\r\n\r\n\t\t\t'numara_id' => $numara_id,\r\n\r\n\t\t\t'tarih' => $tarih,\r\n\r\n\t\t\t'harcama_tutari' => number_format($harcama_tutari, 2, '.', ''),\r\n\r\n\t\t\t'aciklama' => trim($aciklama)\r\n\r\n\t\t];\r\n\r\n\r\n\r\n\t\tif($this->db->update('voip_gunluk_harcama', $data, ['harcama_id' => $harcama_id])) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Harcama kaydı başarıyla güncellendi']);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Günlük Harcama Getir (AJAX) - Düzenleme için\r\n\r\n\t */\r\n\r\n\tpublic function harcama_getir(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1904)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$harcama_id = $this->input->post('harcama_id');\r\n\r\n\r\n\r\n\t\tif(empty($harcama_id)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama ID gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$harcama = $this->db->get_where('voip_gunluk_harcama', ['harcama_id' => $harcama_id])->row();\r\n\r\n\r\n\r\n\t\tif($harcama) {\r\n\r\n\t\t\techo json_encode(['success' => true, 'data' => $harcama]);\r\n\r\n\t\t} else {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama kaydı bulunamadı']);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Harcama Raporu (AJAX) - Tarih aralığına göre filtreleme\r\n\r\n\t */\r\n\r\n\tpublic function harcama_raporu(){\r\n\r\n\t\t// Content-Type header ayarla\r\n\r\n\t\theader('Content-Type: application/json');\r\n\r\n\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1904)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$baslangic_tarihi = $this->input->post('baslangic_tarihi');\r\n\r\n\t\t$bitis_tarihi = $this->input->post('bitis_tarihi');\r\n\r\n\t\t$numara_id = $this->input->post('numara_id'); // Opsiyonel, belirli numara filtresi\r\n\r\n\r\n\r\n\t\tif(empty($baslangic_tarihi) || empty($bitis_tarihi)) {\r\n\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Başlangıç ve bitiş tarihi gereklidir']);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t$this->db->select('vgh.*, vn.voip_numara, vo.operator_adi, \r\n\r\n\t\t\tCOALESCE(teslim_k.kullanici_ad, k.kullanici_ad) as kullanici_ad, \r\n\r\n\t\t\tCOALESCE(teslim_k.kullanici_soyad, k.kullanici_soyad) as kullanici_soyad');\r\n\r\n\t\t$this->db->from('voip_gunluk_harcama vgh');\r\n\r\n\t\t$this->db->join('voip_numara vn', 'vgh.numara_id = vn.numara_id', 'left');\r\n\r\n\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n\r\n\t\t$this->db->join('kullanicilar k', 'vgh.kaydeden_kullanici_id = k.kullanici_id', 'left');\r\n\r\n\t\t\r\n\r\n\t\t// O tarihte numaranın teslim edildiği kullanıcıyı bul\r\n\r\n\t\t$this->db->join('(SELECT vnt1.numara_id, vnt1.kullanici_id, vnt1.teslim_tarihi \r\n\r\n\t\t\tFROM voip_numara_teslim vnt1 \r\n\r\n\t\t\tWHERE vnt1.iade_tarihi IS NULL \r\n\r\n\t\t\tAND vnt1.teslim_tarihi = (\r\n\r\n\t\t\t\tSELECT MAX(vnt2.teslim_tarihi) \r\n\r\n\t\t\t\tFROM voip_numara_teslim vnt2 \r\n\r\n\t\t\t\tWHERE vnt2.numara_id = vnt1.numara_id \r\n\r\n\t\t\t\tAND vnt2.iade_tarihi IS NULL\r\n\r\n\t\t\t)) teslim_son', 'vgh.numara_id = teslim_son.numara_id AND DATE(teslim_son.teslim_tarihi) <= vgh.tarih', 'left');\r\n\r\n\t\t$this->db->join('kullanicilar teslim_k', 'teslim_son.kullanici_id = teslim_k.kullanici_id', 'left');\r\n\r\n\t\t$this->db->where('vgh.tarih >=', $baslangic_tarihi);\r\n\r\n\t\t$this->db->where('vgh.tarih <=', $bitis_tarihi);\r\n\r\n\t\t\r\n\r\n\t\tif(!empty($numara_id)) {\r\n\r\n\t\t\t$this->db->where('vgh.numara_id', $numara_id);\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n\r\n\t\t$harcamalar = $this->db->get()->result();\r\n\r\n\r\n\r\n\t\t// Toplam harcama hesapla\r\n\r\n\t\t$toplam = 0;\r\n\r\n\t\tforeach($harcamalar as $harcama) {\r\n\r\n\t\t\t$toplam += $harcama->harcama_tutari;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\techo json_encode([\r\n\r\n\t\t\t'success' => true, \r\n\r\n\t\t\t'data' => $harcamalar,\r\n\r\n\t\t\t'toplam' => number_format($toplam, 2, '.', ''),\r\n\r\n\t\t\t'kayit_sayisi' => count($harcamalar)\r\n\r\n\t\t]);\r\n\r\n\t}\r\n\r\n\t/**\r\n\t * Hakediş Tanımlama Sayfası\r\n\t * URL: https://crm.ilekasoft.com/voip/hakedis-tanimlama\r\n\t */\r\n\tpublic function hakedis_tanimlama(){\r\n\t\t// Voip & Hakediş (ID:1900) ana modül yetkisi kontrolü\r\n\t\tif(!grup_modul_yetkisi_var(1900)) {\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t}\r\n\r\n\t\t// Hakediş Tanımlama (ID:1905) alt modül yetkisi kontrolü\r\n\t\tif(!grup_modul_yetkisi_var(1905)) {\r\n\t\t\tredirect(\"home/hata\");\r\n\t\t}\r\n\r\n\t\t$data[\"baslik\"] = \"Voip & Hakediş / Hakediş Tanımlama\";\r\n\t\t\r\n\t\t// Aktif numaraları getir (operator ile birlikte)\r\n\t\t$this->db->select('voip_numara.*, voip_operator.operator_adi');\r\n\t\t$this->db->from('voip_numara');\r\n\t\t$this->db->join('voip_operator', 'voip_numara.operator_id = voip_operator.operator_id', 'left');\r\n\t\t$this->db->where('voip_numara.durum', 1); // Sadece aktif numaralar\r\n\t\t$this->db->order_by('voip_operator.operator_adi, voip_numara.voip_numara');\r\n\t\t$data[\"numaralar\"] = $this->db->get()->result();\r\n\t\t\r\n\t\t// Günlük harcama kayıtlarını getir (son 30 gün)\r\n\t\t$this->db->select('vgh.*, vn.voip_numara, vo.operator_adi, \r\n\t\t\tCOALESCE(teslim_k.kullanici_ad, k.kullanici_ad) as kullanici_ad, \r\n\t\t\tCOALESCE(teslim_k.kullanici_soyad, k.kullanici_soyad) as kullanici_soyad');\r\n\t\t$this->db->from('voip_gunluk_harcama vgh');\r\n\t\t$this->db->join('voip_numara vn', 'vgh.numara_id = vn.numara_id', 'left');\r\n\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n\t\t$this->db->join('kullanicilar k', 'vgh.kaydeden_kullanici_id = k.kullanici_id', 'left');\r\n\t\t\r\n\t\t// O tarihte numaranın teslim edildiği kullanıcıyı bul\r\n\t\t$this->db->join('(SELECT vnt1.numara_id, vnt1.kullanici_id, vnt1.teslim_tarihi \r\n\t\t\tFROM voip_numara_teslim vnt1 \r\n\t\t\tWHERE vnt1.iade_tarihi IS NULL \r\n\t\t\tAND vnt1.teslim_tarihi = (\r\n\t\t\t\tSELECT MAX(vnt2.teslim_tarihi) \r\n\t\t\t\tFROM voip_numara_teslim vnt2 \r\n\t\t\t\tWHERE vnt2.numara_id = vnt1.numara_id \r\n\t\t\t\tAND vnt2.iade_tarihi IS NULL\r\n\t\t\t)) teslim_son', 'vgh.numara_id = teslim_son.numara_id AND DATE(teslim_son.teslim_tarihi) <= vgh.tarih', 'left');\r\n\t\t$this->db->join('kullanicilar teslim_k', 'teslim_son.kullanici_id = teslim_k.kullanici_id', 'left');\r\n\t\t$this->db->where('vgh.tarih >=', date('Y-m-d', strtotime('-30 days')));\r\n\t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n\t\t$data[\"harcamalar\"] = $this->db->get()->result();\r\n\r\n\t\t$this->load->view('voip/hakedis-tanimlama', $data);\r\n\t}\r\n\r\n\t/**\r\n\t * Hakediş Ekle (AJAX)\r\n\t */\r\n\tpublic function hakedis_ekle(){\r\n\t\t// Content-Type header ayarla\r\n\t\theader('Content-Type: application/json');\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1905)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\t\t$tarih = $this->input->post('tarih');\r\n\t\t$harcama_tutari = $this->input->post('harcama_tutari');\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\t\tif(empty($numara_id) || empty($tarih) || empty($harcama_tutari)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Numara, tarih ve harcama tutarı gereklidir']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Tutar kontrolü\r\n\t\tif(!is_numeric($harcama_tutari) || $harcama_tutari < 0) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama tutarı geçerli bir sayı olmalıdır']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Session bilgisini güvenli şekilde al\r\n\t\t$login_info = session(\"r\", \"login_info\");\r\n\t\t$kullanici_id = null;\r\n\t\tif(is_object($login_info) && isset($login_info->kullanici_id)) {\r\n\t\t\t$kullanici_id = $login_info->kullanici_id;\r\n\t\t} elseif(is_array($login_info) && isset($login_info['kullanici_id'])) {\r\n\t\t\t$kullanici_id = $login_info['kullanici_id'];\r\n\t\t}\r\n\r\n\t\t// Aynı numara ve tarih için kayıt var mı kontrol et\r\n\t\t$existing = $this->db->get_where('voip_gunluk_harcama', [\r\n\t\t\t'numara_id' => $numara_id,\r\n\t\t\t'tarih' => $tarih\r\n\t\t])->row();\r\n\r\n\t\t$data = [\r\n\t\t\t'numara_id' => $numara_id,\r\n\t\t\t'tarih' => $tarih,\r\n\t\t\t'harcama_tutari' => number_format($harcama_tutari, 2, '.', ''),\r\n\t\t\t'aciklama' => trim($aciklama),\r\n\t\t\t'kaydeden_kullanici_id' => $kullanici_id\r\n\t\t];\r\n\r\n\t\tif($existing) {\r\n\t\t\t// Eğer kayıt varsa güncelle\r\n\t\t\tif($this->db->update('voip_gunluk_harcama', $data, ['harcama_id' => $existing->harcama_id])) {\r\n\t\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla güncellendi']);\r\n\t\t\t} else {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Eğer kayıt yoksa yeni ekle\r\n\t\t\tif($this->db->insert('voip_gunluk_harcama', $data)) {\r\n\t\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla eklendi']);\r\n\t\t\t} else {\r\n\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Hakediş Sil (AJAX)\r\n\t */\r\n\tpublic function hakedis_sil(){\r\n\t\t// Content-Type header ayarla\r\n\t\theader('Content-Type: application/json');\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1905)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$harcama_id = $this->input->post('harcama_id');\r\n\r\n\t\tif(empty($harcama_id)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ID gereklidir']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif($this->db->delete('voip_gunluk_harcama', ['harcama_id' => $harcama_id])) {\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla silindi']);\r\n\t\t} else {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Hakediş Güncelle (AJAX)\r\n\t */\r\n\tpublic function hakedis_guncelle(){\r\n\t\t// Content-Type header ayarla\r\n\t\theader('Content-Type: application/json');\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1905)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$harcama_id = $this->input->post('harcama_id');\r\n\t\t$numara_id = $this->input->post('numara_id');\r\n\t\t$tarih = $this->input->post('tarih');\r\n\t\t$harcama_tutari = $this->input->post('harcama_tutari');\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\t\tif(empty($harcama_id) || empty($numara_id) || empty($tarih) || empty($harcama_tutari)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ID, numara, tarih ve harcama tutarı gereklidir']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Tutar kontrolü\r\n\t\tif(!is_numeric($harcama_tutari) || $harcama_tutari < 0) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Harcama tutarı geçerli bir sayı olmalıdır']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Aynı numara ve tarih için başka kayıt var mı kontrol et\r\n\t\t$existing = $this->db->query(\"SELECT * FROM voip_gunluk_harcama WHERE numara_id = ? AND tarih = ? AND harcama_id != ?\", [$numara_id, $tarih, $harcama_id])->row();\r\n\t\tif($existing) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Bu numara için bu tarihte zaten başka hakediş kaydı var']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$data = [\r\n\t\t\t'numara_id' => $numara_id,\r\n\t\t\t'tarih' => $tarih,\r\n\t\t\t'harcama_tutari' => number_format($harcama_tutari, 2, '.', ''),\r\n\t\t\t'aciklama' => trim($aciklama)\r\n\t\t];\r\n\r\n\t\tif($this->db->update('voip_gunluk_harcama', $data, ['harcama_id' => $harcama_id])) {\r\n\t\t\techo json_encode(['success' => true, 'message' => 'Hakediş kaydı başarıyla güncellendi']);\r\n\t\t} else {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası']);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Hakediş Getir (AJAX) - Düzenleme için\r\n\t */\r\n\tpublic function hakedis_getir(){\r\n\t\t// Content-Type header ayarla\r\n\t\theader('Content-Type: application/json');\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1905)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$harcama_id = $this->input->post('harcama_id');\r\n\r\n\t\tif(empty($harcama_id)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş ID gereklidir']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$harcama = $this->db->get_where('voip_gunluk_harcama', ['harcama_id' => $harcama_id])->row();\r\n\r\n\t\tif($harcama) {\r\n\t\t\techo json_encode(['success' => true, 'data' => $harcama]);\r\n\t\t} else {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Hakediş kaydı bulunamadı']);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Hakediş Raporu (AJAX) - Tarih aralığına göre filtreleme\r\n\t */\r\n\tpublic function hakedis_raporu(){\r\n\t\t// Content-Type header ayarla\r\n\t\theader('Content-Type: application/json');\r\n\r\n\t\tif(!grup_modul_yetkisi_var(1905)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Yetki yok']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$baslangic_tarihi = $this->input->post('baslangic_tarihi');\r\n\t\t$bitis_tarihi = $this->input->post('bitis_tarihi');\r\n\t\t$numara_id = $this->input->post('numara_id'); // Opsiyonel, belirli numara filtresi\r\n\r\n\t\tif(empty($baslangic_tarihi) || empty($bitis_tarihi)) {\r\n\t\t\techo json_encode(['success' => false, 'message' => 'Başlangıç ve bitiş tarihi gereklidir']);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$this->db->select('vgh.*, vn.voip_numara, vo.operator_adi, \r\n\t\t\tCOALESCE(teslim_k.kullanici_ad, k.kullanici_ad) as kullanici_ad, \r\n\t\t\tCOALESCE(teslim_k.kullanici_soyad, k.kullanici_soyad) as kullanici_soyad');\r\n\t\t$this->db->from('voip_gunluk_harcama vgh');\r\n\t\t$this->db->join('voip_numara vn', 'vgh.numara_id = vn.numara_id', 'left');\r\n\t\t$this->db->join('voip_operator vo', 'vn.operator_id = vo.operator_id', 'left');\r\n\t\t$this->db->join('kullanicilar k', 'vgh.kaydeden_kullanici_id = k.kullanici_id', 'left');\r\n\t\t\r\n\t\t// O tarihte numaranın teslim edildiği kullanıcıyı bul\r\n\t\t$this->db->join('(SELECT vnt1.numara_id, vnt1.kullanici_id, vnt1.teslim_tarihi \r\n\t\t\tFROM voip_numara_teslim vnt1 \r\n\t\t\tWHERE vnt1.iade_tarihi IS NULL \r\n\t\t\tAND vnt1.teslim_tarihi = (\r\n\t\t\t\tSELECT MAX(vnt2.teslim_tarihi) \r\n\t\t\t\tFROM voip_numara_teslim vnt2 \r\n\t\t\t\tWHERE vnt2.numara_id = vnt1.numara_id \r\n\t\t\t\tAND vnt2.iade_tarihi IS NULL\r\n\t\t\t)) teslim_son', 'vgh.numara_id = teslim_son.numara_id AND DATE(teslim_son.teslim_tarihi) <= vgh.tarih', 'left');\r\n\t\t$this->db->join('kullanicilar teslim_k', 'teslim_son.kullanici_id = teslim_k.kullanici_id', 'left');\r\n\t\t$this->db->where('vgh.tarih >=', $baslangic_tarihi);\r\n\t\t$this->db->where('vgh.tarih <=', $bitis_tarihi);\r\n\t\t\r\n\t\tif(!empty($numara_id)) {\r\n\t\t\t$this->db->where('vgh.numara_id', $numara_id);\r\n\t\t}\r\n\t\t\r\n\t\t$this->db->order_by('vgh.tarih DESC, vo.operator_adi, vn.voip_numara');\r\n\t\t$harcamalar = $this->db->get()->result();\r\n\r\n\t\t// Toplam harcama hesapla\r\n\t\t$toplam = 0;\r\n\t\tforeach($harcamalar as $harcama) {\r\n\t\t\t$toplam += $harcama->harcama_tutari;\r\n\t\t}\r\n\r\n\t\techo json_encode([\r\n\t\t\t'success' => true, \r\n\t\t\t'data' => $harcamalar,\r\n\t\t\t'toplam' => number_format($toplam, 2, '.', ''),\r\n\t\t\t'kayit_sayisi' => count($harcamalar)\r\n\t\t]);\r\n\t}\r\n\r\n}\r\n\r\n"
        }
    ]
}