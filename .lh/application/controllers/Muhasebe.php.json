{
    "sourceFile": "application/controllers/Muhasebe.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 61,
            "patches": [
                {
                    "date": 1755256998990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755258690687,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2257,11 +2257,11 @@\n \t\t\t\t\tTHEN c.cari_ad \r\n \t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n \t\t\t\tEND as cari_isletme,\r\n \t\t\t\t\r\n-\t\t\t\tNULL as satis_sozlesme_id,\r\n-\t\t\t\tNULL as satis_sozlesme_tutar,\r\n-\t\t\t\tNULL as satis_sozlesme_tutar_kdv_dahil,\r\n+\t\t\t\tsf.satis_id as satis_sozlesme_id,\r\n+\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar,\r\n+\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar_kdv_dahil,\r\n \t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n \t\t\t\t\r\n \t\t\t\tNULL as evrak_gorselleri,\r\n \t\t\t\tNULL as sozlesme_gorselleri,\r\n@@ -2310,17 +2310,18 @@\n \t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n \t\t\t\tINNER JOIN senet ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = senet.senet_id\r\n \t\t\t) mtd ON c.cari_id = mtd.cari_id\r\n \t\t\t\r\n+\t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n \t\t\tLEFT JOIN bankahareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n \t\t\tLEFT JOIN cek ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = cek.cek_id\r\n \t\t\tLEFT JOIN kasahareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n \t\t\tLEFT JOIN senet ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = senet.senet_id\r\n \t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n \t\t\tWHERE c.cari_durum = 1\r\n-\t\t\tGROUP BY c.cari_id, a.aktivasyon_id\r\n+\t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id\r\n \t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n \t\t\";\r\n \t\t\t\r\n \t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n@@ -2361,7 +2362,5 @@\n \t\t// View yukle\r\n \t\t$this->load->view(\"muhasebe/tam-ana-rapor\", $data);\r\n \t}\r\n \t\r\n-}\r\n-\u0000\r\n-\u0000\n\\ No newline at end of file\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1755266392610,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2262,8 +2262,22 @@\n \t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar,\r\n \t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar_kdv_dahil,\r\n \t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n \t\t\t\t\r\n+\t\t\t\t-- İşletme görsel sayısını hesapla (fotograf_dosya kolonundan)\r\n+\t\t\t\tCASE \r\n+\t\t\t\t\tWHEN c.fotograf_dosya IS NOT NULL AND c.fotograf_dosya != '' \r\n+\t\t\t\t\tTHEN (LENGTH(c.fotograf_dosya) - LENGTH(REPLACE(c.fotograf_dosya, ',', '')) + 1)\r\n+\t\t\t\t\tELSE 0\r\n+\t\t\t\tEND as isletme_gorsel_sayisi,\r\n+\t\t\t\t\r\n+\t\t\t\t-- Evrak sayısını hesapla  \r\n+\t\t\t\tCASE \r\n+\t\t\t\t\tWHEN c.evrak_dosya IS NOT NULL AND c.evrak_dosya != '' \r\n+\t\t\t\t\tTHEN (LENGTH(c.evrak_dosya) - LENGTH(REPLACE(c.evrak_dosya, ',', '')) + 1)\r\n+\t\t\t\t\tELSE 0\r\n+\t\t\t\tEND as evrak_sayisi,\r\n+\t\t\t\t\r\n \t\t\t\tNULL as evrak_gorselleri,\r\n \t\t\t\tNULL as sozlesme_gorselleri,\r\n \t\t\t\tNULL as tahsilat_gorselleri,\r\n \t\t\t\t\r\n"
                },
                {
                    "date": 1755268348321,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2276,8 +2276,15 @@\n \t\t\t\t\tTHEN (LENGTH(c.evrak_dosya) - LENGTH(REPLACE(c.evrak_dosya, ',', '')) + 1)\r\n \t\t\t\t\tELSE 0\r\n \t\t\t\tEND as evrak_sayisi,\r\n \t\t\t\t\r\n+\t\t\t\t-- Satış görsel sayısını hesapla (satisfaturasi.satis_dosya kolonundan)\r\n+\t\t\t\tCASE \r\n+\t\t\t\t\tWHEN sf.satis_dosya IS NOT NULL AND sf.satis_dosya != '' \r\n+\t\t\t\t\tTHEN (LENGTH(sf.satis_dosya) - LENGTH(REPLACE(sf.satis_dosya, ',', '')) + 1)\r\n+\t\t\t\t\tELSE 0\r\n+\t\t\t\tEND as satis_gorsel_sayisi,\r\n+\t\t\t\t\r\n \t\t\t\tNULL as evrak_gorselleri,\r\n \t\t\t\tNULL as sozlesme_gorselleri,\r\n \t\t\t\tNULL as tahsilat_gorselleri,\r\n \t\t\t\t\r\n"
                },
                {
                    "date": 1755269441619,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2287,62 +2287,38 @@\n \t\t\t\tNULL as evrak_gorselleri,\r\n \t\t\t\tNULL as sozlesme_gorselleri,\r\n \t\t\t\tNULL as tahsilat_gorselleri,\r\n \t\t\t\t\r\n-\t\t\t\tSUM(CASE \r\n-\t\t\t\t\tWHEN mtd.durum = 2 THEN \r\n-\t\t\t\t\t\tCASE \r\n-\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 1 THEN bh.bh_giris\r\n-\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 2 THEN cek.cek_tutar\r\n-\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 3 THEN kh.kh_giris\r\n-\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 4 THEN senet.senet_tutar\r\n-\t\t\t\t\t\t\tELSE 0\r\n-\t\t\t\t\t\tEND\r\n-\t\t\t\t\tELSE 0\r\n-\t\t\t\tEND) as tahsilat_tutar,\r\n+\t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n+\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\r\n+\t\t\t\t-- Tahsilat durumu (basit kontrol)\r\n \t\t\t\tCASE \r\n-\t\t\t\t\tWHEN COUNT(mtd.id) = 0 THEN 'Tahsilat Yok'\r\n-\t\t\t\t\tWHEN SUM(CASE WHEN mtd.durum = 1 THEN 1 ELSE 0 END) > 0 THEN 'Onay Bekliyor'\r\n-\t\t\t\t\tWHEN SUM(CASE WHEN mtd.durum = 2 THEN 1 ELSE 0 END) = COUNT(mtd.id) THEN 'Onaylandi'\r\n-\t\t\t\t\tWHEN SUM(CASE WHEN mtd.durum = 3 THEN 1 ELSE 0 END) > 0 THEN 'Reddedilen Var'\r\n-\t\t\t\t\tELSE 'Karisik'\r\n+\t\t\t\t\tWHEN COALESCE(ch_toplam.toplam_tahsilat, 0) = 0 THEN 'Tahsilat Yok'\r\n+\t\t\t\t\tWHEN COALESCE(ch_toplam.toplam_tahsilat, 0) > 0 THEN 'Tahsilat Var'\r\n+\t\t\t\t\tELSE 'Bilinmeyen'\r\n \t\t\t\tEND as tahsilat_durum,\r\n \t\t\t\t\r\n \t\t\t\ta.aktivasyon_tarihi,\r\n \t\t\t\t\r\n \t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n \t\t\t\t\r\n \t\t\tFROM cari c\r\n \t\t\t\r\n+\t\t\t-- Carihareketleri tablosundan tahsilat toplamını al\r\n \t\t\tLEFT JOIN (\r\n-\t\t\t\tSELECT DISTINCT bh.bh_cariID as cari_id, mtd.*\r\n-\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n-\t\t\t\tINNER JOIN bankahareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n-\t\t\t\tUNION\r\n-\t\t\t\tSELECT DISTINCT kh.kh_cariID as cari_id, mtd.*\r\n-\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n-\t\t\t\tINNER JOIN kasahareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n-\t\t\t\tUNION\r\n-\t\t\t\tSELECT DISTINCT cek.cek_cariID as cari_id, mtd.*\r\n-\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n-\t\t\t\tINNER JOIN cek ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = cek.cek_id\r\n-\t\t\t\tUNION\r\n-\t\t\t\tSELECT DISTINCT senet.senet_cariID as cari_id, mtd.*\r\n-\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n-\t\t\t\tINNER JOIN senet ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = senet.senet_id\r\n-\t\t\t) mtd ON c.cari_id = mtd.cari_id\r\n+\t\t\t\tSELECT ch_cariID, SUM(ch_alacak) as toplam_tahsilat \r\n+\t\t\t\tFROM carihareketleri \r\n+\t\t\t\tWHERE ch_alacak IS NOT NULL AND ch_alacak > 0\r\n+\t\t\t\tGROUP BY ch_cariID\r\n+\t\t\t) ch_toplam ON c.cari_id = ch_toplam.ch_cariID\r\n \t\t\t\r\n \t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n-\t\t\tLEFT JOIN bankahareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n-\t\t\tLEFT JOIN cek ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = cek.cek_id\r\n-\t\t\tLEFT JOIN kasahareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n-\t\t\tLEFT JOIN senet ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = senet.senet_id\r\n \t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n \t\t\tWHERE c.cari_durum = 1\r\n-\t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id\r\n+\t\t\tGROUP BY c.cari_id, sf.satis_id\r\n \t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n \t\t\";\r\n \t\t\t\r\n \t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n"
                },
                {
                    "date": 1755270675402,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2359,5 +2359,75 @@\n \t\t// View yukle\r\n \t\t$this->load->view(\"muhasebe/tam-ana-rapor\", $data);\r\n \t}\r\n \t\r\n+\t/**\r\n+\t * Tahsilat detaylarını getir - AJAX\r\n+\t */\r\n+\tpublic function getTahsilatDetay()\r\n+\t{\r\n+\t\t// AJAX isteği kontrolü\r\n+\t\tif (!$this->input->is_ajax_request()) {\r\n+\t\t\tshow_404();\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\r\n+\t\tif (!$cari_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Tahsilat detaylarını getir (carihareketleri tablosundan ch_alacak > 0 olanlar)\r\n+\t\t\t$query = \"\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tch.ch_tarih,\r\n+\t\t\t\t\tch.ch_belgeNumarasi,\r\n+\t\t\t\t\tch.ch_alacak,\r\n+\t\t\t\t\tch.ch_aciklama,\r\n+\t\t\t\t\tCASE \r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 1 THEN 'Açılış'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 2 THEN 'Satış Faturası'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 3 THEN 'Alış Faturası'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 4 THEN 'Kasa Giriş'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 5 THEN 'Kasa Çıkış'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 6 THEN 'Banka Giriş'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 7 THEN 'Banka Çıkış'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 8 THEN 'Çek Giriş'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 9 THEN 'Çek Çıkış'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 10 THEN 'Senet Giriş'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 11 THEN 'Senet Çıkış'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 12 THEN 'Kredi Kartı'\r\n+\t\t\t\t\t\tWHEN ch.ch_turu = 13 THEN 'Havale/EFT'\r\n+\t\t\t\t\t\tELSE CONCAT('Tür-', ch.ch_turu)\r\n+\t\t\t\t\tEND as tahsilat_tipi\r\n+\t\t\t\tFROM carihareketleri ch\r\n+\t\t\t\tWHERE ch.ch_cariID = ? \r\n+\t\t\t\t  AND ch.ch_alacak IS NOT NULL \r\n+\t\t\t\t  AND ch.ch_alacak > 0\r\n+\t\t\t\tORDER BY ch.ch_tarih DESC, ch.ch_id DESC\r\n+\t\t\t\";\r\n+\t\t\t\r\n+\t\t\t$result = $this->db->query($query, [$cari_id])->result();\r\n+\t\t\t\r\n+\t\t\t// Tarihleri formatla\r\n+\t\t\tforeach ($result as $row) {\r\n+\t\t\t\t$row->ch_tarih = date('d.m.Y', strtotime($row->ch_tarih));\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true,\r\n+\t\t\t\t'data' => $result,\r\n+\t\t\t\t'count' => count($result)\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Veri alınırken hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1755274331059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2283,8 +2283,20 @@\n \t\t\t\t\tTHEN (LENGTH(sf.satis_dosya) - LENGTH(REPLACE(sf.satis_dosya, ',', '')) + 1)\r\n \t\t\t\t\tELSE 0\r\n \t\t\t\tEND as satis_gorsel_sayisi,\r\n \t\t\t\t\r\n+\t\t\t\t-- Banka görsel sayısını hesapla\r\n+\t\t\t\tCOALESCE(banka_gorseller.banka_gorsel_sayisi, 0) as banka_gorsel_sayisi,\r\n+\t\t\t\t\r\n+\t\t\t\t-- Çek görsel sayısını hesapla\r\n+\t\t\t\tCOALESCE(cek_gorseller.cek_gorsel_sayisi, 0) as cek_gorsel_sayisi,\r\n+\t\t\t\t\r\n+\t\t\t\t-- Senet görsel sayısını hesapla\r\n+\t\t\t\tCOALESCE(senet_gorseller.senet_gorsel_sayisi, 0) as senet_gorsel_sayisi,\r\n+\t\t\t\t\r\n+\t\t\t\t-- Tahsilat görsel sayısını hesapla (carihareketleri ile bağlantılı tablolardan)\r\n+\t\t\t\tCOALESCE(tahsilat_gorseller.toplam_gorsel, 0) as tahsilat_gorsel_sayisi,\r\n+\t\t\t\t\r\n \t\t\t\tNULL as evrak_gorselleri,\r\n \t\t\t\tNULL as sozlesme_gorselleri,\r\n \t\t\t\tNULL as tahsilat_gorselleri,\r\n \t\t\t\t\r\n@@ -2311,8 +2323,61 @@\n \t\t\t\tWHERE ch_alacak IS NOT NULL AND ch_alacak > 0\r\n \t\t\t\tGROUP BY ch_cariID\r\n \t\t\t) ch_toplam ON c.cari_id = ch_toplam.ch_cariID\r\n \t\t\t\r\n+\t\t\t-- Banka görselleri sayısını al\r\n+\t\t\tLEFT JOIN (\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tbh_cariID,\r\n+\t\t\t\t\tCOUNT(CASE WHEN bh_gorsel IS NOT NULL AND bh_gorsel != '' THEN 1 END) as banka_gorsel_sayisi\r\n+\t\t\t\tFROM bankahareketleri \r\n+\t\t\t\tWHERE bh_cariID IS NOT NULL\r\n+\t\t\t\tGROUP BY bh_cariID\r\n+\t\t\t) banka_gorseller ON c.cari_id = banka_gorseller.bh_cariID\r\n+\t\t\t\r\n+\t\t\t-- Çek görselleri sayısını al\r\n+\t\t\tLEFT JOIN (\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tcek_cariID,\r\n+\t\t\t\t\tCOUNT(CASE WHEN cek_gorsel IS NOT NULL AND cek_gorsel != '' THEN 1 END) as cek_gorsel_sayisi\r\n+\t\t\t\tFROM cek \r\n+\t\t\t\tWHERE cek_cariID IS NOT NULL\r\n+\t\t\t\tGROUP BY cek_cariID\r\n+\t\t\t) cek_gorseller ON c.cari_id = cek_gorseller.cek_cariID\r\n+\t\t\t\r\n+\t\t\t-- Senet görselleri sayısını al\r\n+\t\t\tLEFT JOIN (\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tsenet_cariID,\r\n+\t\t\t\t\tCOUNT(CASE WHEN senet_gorsel IS NOT NULL AND senet_gorsel != '' THEN 1 END) as senet_gorsel_sayisi\r\n+\t\t\t\tFROM senet \r\n+\t\t\t\tWHERE senet_cariID IS NOT NULL\r\n+\t\t\t\tGROUP BY senet_cariID\r\n+\t\t\t) senet_gorseller ON c.cari_id = senet_gorseller.senet_cariID\r\n+\t\t\t\r\n+\t\t\t-- Tahsilat görsellerini say (bankahareketleri ve kasahareketleri)\r\n+\t\t\tLEFT JOIN (\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tch.ch_cariID,\r\n+\t\t\t\t\tSUM(\r\n+\t\t\t\t\t\tCASE \r\n+\t\t\t\t\t\t\tWHEN bh.bh_gorsel IS NOT NULL AND bh.bh_gorsel != '' \r\n+\t\t\t\t\t\t\tTHEN (LENGTH(bh.bh_gorsel) - LENGTH(REPLACE(bh.bh_gorsel, ',', '')) + 1)\r\n+\t\t\t\t\t\t\tELSE 0\r\n+\t\t\t\t\t\tEND +\r\n+\t\t\t\t\t\tCASE \r\n+\t\t\t\t\t\t\tWHEN kh.kh_gorsel IS NOT NULL AND kh.kh_gorsel != '' \r\n+\t\t\t\t\t\t\tTHEN (LENGTH(kh.kh_gorsel) - LENGTH(REPLACE(kh.kh_gorsel, ',', '')) + 1)\r\n+\t\t\t\t\t\t\tELSE 0\r\n+\t\t\t\t\t\tEND\r\n+\t\t\t\t\t) as toplam_gorsel\r\n+\t\t\t\tFROM carihareketleri ch\r\n+\t\t\t\tLEFT JOIN bankahareketleri bh ON ch.ch_bhID = bh.bh_id\r\n+\t\t\t\tLEFT JOIN kasahareketleri kh ON ch.ch_khID = kh.kh_id\r\n+\t\t\t\tWHERE ch.ch_alacak IS NOT NULL AND ch.ch_alacak > 0\r\n+\t\t\t\tGROUP BY ch.ch_cariID\r\n+\t\t\t) tahsilat_gorseller ON c.cari_id = tahsilat_gorseller.ch_cariID\r\n+\t\t\t\r\n \t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n \t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n"
                },
                {
                    "date": 1755275157152,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2302,14 +2302,11 @@\n \t\t\t\t\r\n \t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n \t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\r\n-\t\t\t\t-- Tahsilat durumu (basit kontrol)\r\n-\t\t\t\tCASE \r\n-\t\t\t\t\tWHEN COALESCE(ch_toplam.toplam_tahsilat, 0) = 0 THEN 'Tahsilat Yok'\r\n-\t\t\t\t\tWHEN COALESCE(ch_toplam.toplam_tahsilat, 0) > 0 THEN 'Tahsilat Var'\r\n-\t\t\t\t\tELSE 'Bilinmeyen'\r\n-\t\t\t\tEND as tahsilat_durum,\r\n+\t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan)\r\n+\t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Belirtilmemiş') as aktivasyon_durum,\r\n+\t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#999999') as aktivasyon_durum_renk,\r\n \t\t\t\t\r\n \t\t\t\ta.aktivasyon_tarihi,\r\n \t\t\t\t\r\n \t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n@@ -2378,12 +2375,13 @@\n \t\t\t) tahsilat_gorseller ON c.cari_id = tahsilat_gorseller.ch_cariID\r\n \t\t\t\r\n \t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n \t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n+\t\t\tLEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n \t\t\tWHERE c.cari_durum = 1\r\n-\t\t\tGROUP BY c.cari_id, sf.satis_id\r\n+\t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id, ad.aktivasyon_durum_id\r\n \t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n \t\t\";\r\n \t\t\t\r\n \t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n@@ -2402,12 +2400,13 @@\n \t\t\t\t}\r\n \t\t\t\tif($veri->tahsilat_tutar) {\r\n \t\t\t\t\t$toplam_tahsilat_tutar += $veri->tahsilat_tutar;\r\n \t\t\t\t}\r\n-\t\t\t\tif($veri->tahsilat_durum == 'Onaylandı') {\r\n+\t\t\t\t// Aktivasyon durumuna göre sayaçları güncelle\r\n+\t\t\t\tif($veri->aktivasyon_durum == 'Aktif' || $veri->aktivasyon_durum == 'Tamamlandı') {\r\n \t\t\t\t\t$onaylanan_sayisi++;\r\n \t\t\t\t}\r\n-\t\t\t\tif($veri->tahsilat_durum == 'Onay Bekliyor') {\r\n+\t\t\t\tif($veri->aktivasyon_durum == 'Beklemede' || $veri->aktivasyon_durum == 'İşlemde') {\r\n \t\t\t\t\t$onay_bekleyen_sayisi++;\r\n \t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n"
                },
                {
                    "date": 1755324928507,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2307,8 +2307,12 @@\n \t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Belirtilmemiş') as aktivasyon_durum,\r\n \t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#999999') as aktivasyon_durum_renk,\r\n \t\t\t\t\r\n \t\t\t\ta.aktivasyon_tarihi,\r\n+\t\t\t\ta.aktivasyon_uye_no,\r\n+\t\t\t\ta.aktivasyon_kutu_no,\r\n+\t\t\t\ta.aktivasyon_kart_no,\r\n+\t\t\t\ta.aktivasyon_aciklama,\r\n \t\t\t\t\r\n \t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n \t\t\t\t\r\n \t\t\tFROM cari c\r\n"
                },
                {
                    "date": 1755325437578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2302,11 +2302,11 @@\n \t\t\t\t\r\n \t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n \t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\r\n-\t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan)\r\n-\t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Belirtilmemiş') as aktivasyon_durum,\r\n-\t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#999999') as aktivasyon_durum_renk,\r\n+\t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan - sadece aktif durumlar)\r\n+\t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Tanımlanmamış') as aktivasyon_durum,\r\n+\t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#6c757d') as aktivasyon_durum_renk,\r\n \t\t\t\t\r\n \t\t\t\ta.aktivasyon_tarihi,\r\n \t\t\t\ta.aktivasyon_uye_no,\r\n \t\t\t\ta.aktivasyon_kutu_no,\r\n@@ -2379,9 +2379,9 @@\n \t\t\t) tahsilat_gorseller ON c.cari_id = tahsilat_gorseller.ch_cariID\r\n \t\t\t\r\n \t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n \t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n-\t\t\tLEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id\r\n+\t\t\tLEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id AND ad.durum = 1\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n \t\t\tWHERE c.cari_durum = 1\r\n \t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id, ad.aktivasyon_durum_id\r\n"
                },
                {
                    "date": 1755325801265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2305,14 +2305,18 @@\n \t\t\t\t\r\n \t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan - sadece aktif durumlar)\r\n \t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Tanımlanmamış') as aktivasyon_durum,\r\n \t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#6c757d') as aktivasyon_durum_renk,\r\n+\t\t\t\tad.aktivasyon_durum_id,\r\n+\t\t\t\tad.durum as aktivasyon_durum_aktif,\r\n \t\t\t\t\r\n+\t\t\t\ta.aktivasyon_id,\r\n \t\t\t\ta.aktivasyon_tarihi,\r\n \t\t\t\ta.aktivasyon_uye_no,\r\n \t\t\t\ta.aktivasyon_kutu_no,\r\n \t\t\t\ta.aktivasyon_kart_no,\r\n \t\t\t\ta.aktivasyon_aciklama,\r\n+\t\t\t\ta.aktivasyon_kampanya_kodu,\r\n \t\t\t\t\r\n \t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n \t\t\t\t\r\n \t\t\tFROM cari c\r\n"
                },
                {
                    "date": 1755336555993,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2310,8 +2310,9 @@\n \t\t\t\tad.durum as aktivasyon_durum_aktif,\r\n \t\t\t\t\r\n \t\t\t\ta.aktivasyon_id,\r\n \t\t\t\ta.aktivasyon_tarihi,\r\n+\t\t\t\ta.olusturma_tarihi,\r\n \t\t\t\ta.aktivasyon_uye_no,\r\n \t\t\t\ta.aktivasyon_kutu_no,\r\n \t\t\t\ta.aktivasyon_kart_no,\r\n \t\t\t\ta.aktivasyon_aciklama,\r\n"
                },
                {
                    "date": 1755337221477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2502,5 +2502,163 @@\n \t\t\t]);\r\n \t\t}\r\n \t}\r\n \t\r\n+\t/**\r\n+\t * Tam Ana Rapor Excel Export\r\n+\t */\r\n+\tpublic function tam_ana_rapor_excel()\r\n+\t{\r\n+\t\t// Yetki kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(531)) {\r\n+\t\t\tredirect(base_url(\"illegal\"));\r\n+\t\t}\r\n+\t\t\r\n+\t\t// Autoload PhpSpreadsheet\r\n+\t\trequire_once FCPATH . 'vendor/autoload.php';\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Memory limit artır\r\n+\t\t\tini_set('memory_limit', '512M');\r\n+\t\t\tini_set('max_execution_time', 600);\r\n+\t\t\t\r\n+\t\t\t// Aynı sorguyu kullan\r\n+\t\t\t$query = \"\r\n+\t\t\t\tSELECT DISTINCT\r\n+\t\t\t\t\tc.cari_id,\r\n+\t\t\t\t\tc.cari_ad,\r\n+\t\t\t\t\tc.cari_soyad,\r\n+\t\t\t\t\tCASE \r\n+\t\t\t\t\t\tWHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n+\t\t\t\t\t\tTHEN c.cari_ad \r\n+\t\t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n+\t\t\t\t\tEND as cari_isletme,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tsf.satis_id as satis_sozlesme_id,\r\n+\t\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar,\r\n+\t\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar_kdv_dahil,\r\n+\t\t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n+\t\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan - sadece aktif durumlar)\r\n+\t\t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Tanımlanmamış') as aktivasyon_durum,\r\n+\t\t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#6c757d') as aktivasyon_durum_renk,\r\n+\t\t\t\t\tad.aktivasyon_durum_id,\r\n+\t\t\t\t\tad.durum as aktivasyon_durum_aktif,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\ta.aktivasyon_id,\r\n+\t\t\t\t\ta.aktivasyon_tarihi,\r\n+\t\t\t\t\ta.olusturma_tarihi,\r\n+\t\t\t\t\ta.aktivasyon_uye_no,\r\n+\t\t\t\t\ta.aktivasyon_kutu_no,\r\n+\t\t\t\t\ta.aktivasyon_kart_no,\r\n+\t\t\t\t\ta.aktivasyon_aciklama,\r\n+\t\t\t\t\ta.aktivasyon_kampanya_kodu,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n+\t\t\t\t\t\r\n+\t\t\t\tFROM cari c\r\n+\t\t\t\t\r\n+\t\t\t\t-- Carihareketleri tablosundan tahsilat toplamını al\r\n+\t\t\t\tLEFT JOIN (\r\n+\t\t\t\t\tSELECT ch_cariID, SUM(ch_alacak) as toplam_tahsilat \r\n+\t\t\t\t\tFROM carihareketleri \r\n+\t\t\t\t\tWHERE ch_alacak IS NOT NULL AND ch_alacak > 0\r\n+\t\t\t\t\tGROUP BY ch_cariID\r\n+\t\t\t\t) ch_toplam ON c.cari_id = ch_toplam.ch_cariID\r\n+\t\t\t\t\r\n+\t\t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n+\t\t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n+\t\t\t\tLEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id AND ad.durum = 1\r\n+\t\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n+\t\t\t\t\r\n+\t\t\t\tWHERE c.cari_durum = 1\r\n+\t\t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id, ad.aktivasyon_durum_id\r\n+\t\t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n+\t\t\t\";\r\n+\t\t\t\t\r\n+\t\t\t$rapor_verileri = $this->db->query($query)->result();\r\n+\t\t\t\r\n+\t\t\t// PhpSpreadsheet ile Excel oluştur\r\n+\t\t\t$spreadsheet = new \\PhpOffice\\PhpSpreadsheet\\Spreadsheet();\r\n+\t\t\t$sheet = $spreadsheet->getActiveSheet();\r\n+\t\t\t$sheet->setTitle('Tam Ana Rapor');\r\n+\t\t\t\r\n+\t\t\t// Başlıkları ayarla\r\n+\t\t\t$headers = [\r\n+\t\t\t\t'A1' => 'İşletme',\r\n+\t\t\t\t'B1' => 'Satış Sözleşme Tutarı',\r\n+\t\t\t\t'C1' => 'Tahsilat Tutarı',\r\n+\t\t\t\t'D1' => 'Aktivasyon Durumu',\r\n+\t\t\t\t'E1' => 'Aktivasyon Tarihi',\r\n+\t\t\t\t'F1' => 'Üye No',\r\n+\t\t\t\t'G1' => 'Kutu No', \r\n+\t\t\t\t'H1' => 'Kart No',\r\n+\t\t\t\t'I1' => 'Kampanya Kodu',\r\n+\t\t\t\t'J1' => 'Personel'\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\tforeach ($headers as $cell => $value) {\r\n+\t\t\t\t$sheet->setCellValue($cell, $value);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Başlık stilini ayarla\r\n+\t\t\t$headerStyle = [\r\n+\t\t\t\t'font' => ['bold' => true, 'color' => ['rgb' => 'FFFFFF']],\r\n+\t\t\t\t'fill' => ['fillType' => \\PhpOffice\\PhpSpreadsheet\\Style\\Fill::FILL_SOLID, 'color' => ['rgb' => '4472C4']],\r\n+\t\t\t\t'alignment' => ['horizontal' => \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::HORIZONTAL_CENTER],\r\n+\t\t\t\t'borders' => ['allBorders' => ['borderStyle' => \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN]]\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\t$sheet->getStyle('A1:J1')->applyFromArray($headerStyle);\r\n+\t\t\t\r\n+\t\t\t// Veriları ekle\r\n+\t\t\t$row = 2;\r\n+\t\t\tforeach ($rapor_verileri as $veri) {\r\n+\t\t\t\t$display_date = $veri->aktivasyon_tarihi ?? $veri->olusturma_tarihi;\r\n+\t\t\t\t$formatted_date = $display_date ? date('d.m.Y H:i:s', strtotime($display_date)) : '-';\r\n+\t\t\t\t\r\n+\t\t\t\t$sheet->setCellValue('A' . $row, $veri->cari_isletme ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('B' . $row, $veri->satis_sozlesme_tutar ? number_format($veri->satis_sozlesme_tutar, 2, ',', '.') . ' ₺' : '-');\r\n+\t\t\t\t$sheet->setCellValue('C' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') . ' ₺' : '-');\r\n+\t\t\t\t$sheet->setCellValue('D' . $row, $veri->aktivasyon_durum ?? 'Tanımlanmamış');\r\n+\t\t\t\t$sheet->setCellValue('E' . $row, $formatted_date);\r\n+\t\t\t\t$sheet->setCellValue('F' . $row, $veri->aktivasyon_uye_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('G' . $row, $veri->aktivasyon_kutu_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_kart_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('I' . $row, $veri->aktivasyon_kampanya_kodu ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('J' . $row, $veri->personel ?? '-');\r\n+\t\t\t\t\r\n+\t\t\t\t$row++;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Sütun genişliklerini ayarla\r\n+\t\t\tforeach (range('A', 'J') as $column) {\r\n+\t\t\t\t$sheet->getColumnDimension($column)->setAutoSize(true);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Tüm veriler için border ekle\r\n+\t\t\t$dataStyle = [\r\n+\t\t\t\t'borders' => ['allBorders' => ['borderStyle' => \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN]]\r\n+\t\t\t];\r\n+\t\t\t$sheet->getStyle('A1:J' . ($row - 1))->applyFromArray($dataStyle);\r\n+\t\t\t\r\n+\t\t\t// Excel dosyasını oluştur ve indir\r\n+\t\t\t$filename = 'Tam_Ana_Rapor_' . date('Y_m_d_H_i_s') . '.xlsx';\r\n+\t\t\t\r\n+\t\t\theader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n+\t\t\theader('Content-Disposition: attachment;filename=\"' . $filename . '\"');\r\n+\t\t\theader('Cache-Control: max-age=0');\r\n+\t\t\t\r\n+\t\t\t$writer = new \\PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx($spreadsheet);\r\n+\t\t\t$writer->save('php://output');\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata durumunda kullanıcıyı bilgilendir\r\n+\t\t\t$this->session->set_flashdata('excel_hata', 'Excel dosyası oluşturulurken hata oluştu: ' . $e->getMessage());\r\n+\t\t\tredirect('muhasebe/tam-ana-rapor');\r\n+\t\t}\r\n+\t}\r\n+\t\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1755352268276,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2257,11 +2257,15 @@\n \t\t\t\t\tTHEN c.cari_ad \r\n \t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n \t\t\t\tEND as cari_isletme,\r\n \t\t\t\t\r\n-\t\t\t\tsf.satis_id as satis_sozlesme_id,\r\n-\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar,\r\n-\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar_kdv_dahil,\r\n+\t\t\t\t-- Kayıt tarihi (en yeni önce sıralama için)\r\n+\t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n+\t\t\t\t\r\n+\t\t\t\t-- Satış sözleşmesi bilgileri (en yeni satış)\r\n+\t\t\t\t(SELECT sf2.satis_id FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n+\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n+\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n \t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n \t\t\t\t\r\n \t\t\t\t-- İşletme görsel sayısını hesapla (fotograf_dosya kolonundan)\r\n \t\t\t\tCASE \r\n@@ -2276,14 +2280,14 @@\n \t\t\t\t\tTHEN (LENGTH(c.evrak_dosya) - LENGTH(REPLACE(c.evrak_dosya, ',', '')) + 1)\r\n \t\t\t\t\tELSE 0\r\n \t\t\t\tEND as evrak_sayisi,\r\n \t\t\t\t\r\n-\t\t\t\t-- Satış görsel sayısını hesapla (satisfaturasi.satis_dosya kolonundan)\r\n-\t\t\t\tCASE \r\n-\t\t\t\t\tWHEN sf.satis_dosya IS NOT NULL AND sf.satis_dosya != '' \r\n-\t\t\t\t\tTHEN (LENGTH(sf.satis_dosya) - LENGTH(REPLACE(sf.satis_dosya, ',', '')) + 1)\r\n+\t\t\t\t-- Satış görsel sayısını hesapla (en yeni satıştan)\r\n+\t\t\t\t(SELECT CASE \r\n+\t\t\t\t\tWHEN sf2.satis_dosya IS NOT NULL AND sf2.satis_dosya != '' \r\n+\t\t\t\t\tTHEN (LENGTH(sf2.satis_dosya) - LENGTH(REPLACE(sf2.satis_dosya, ',', '')) + 1)\r\n \t\t\t\t\tELSE 0\r\n-\t\t\t\tEND as satis_gorsel_sayisi,\r\n+\t\t\t\tEND FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_gorsel_sayisi,\r\n \t\t\t\t\r\n \t\t\t\t-- Banka görsel sayısını hesapla\r\n \t\t\t\tCOALESCE(banka_gorseller.banka_gorsel_sayisi, 0) as banka_gorsel_sayisi,\r\n \t\t\t\t\r\n@@ -2302,22 +2306,71 @@\n \t\t\t\t\r\n \t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n \t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\r\n-\t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan - sadece aktif durumlar)\r\n-\t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Tanımlanmamış') as aktivasyon_durum,\r\n-\t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#6c757d') as aktivasyon_durum_renk,\r\n-\t\t\t\tad.aktivasyon_durum_id,\r\n-\t\t\t\tad.durum as aktivasyon_durum_aktif,\r\n+\t\t\t\t-- Aktivasyon durumu (en yeni aktivasyondan)\r\n+\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_adi, 'Tanımlanmamış') \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_renk, '#6c757d') \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum_renk,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_durum_id \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum_id,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT ad2.durum \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum_aktif,\r\n \t\t\t\t\r\n-\t\t\t\ta.aktivasyon_id,\r\n-\t\t\t\ta.aktivasyon_tarihi,\r\n-\t\t\t\ta.olusturma_tarihi,\r\n-\t\t\t\ta.aktivasyon_uye_no,\r\n-\t\t\t\ta.aktivasyon_kutu_no,\r\n-\t\t\t\ta.aktivasyon_kart_no,\r\n-\t\t\t\ta.aktivasyon_aciklama,\r\n-\t\t\t\ta.aktivasyon_kampanya_kodu,\r\n+\t\t\t\t(SELECT a2.aktivasyon_id \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_id,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_tarihi \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_tarihi,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.olusturma_tarihi \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as olusturma_tarihi,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_uye_no \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_uye_no,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_kutu_no \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kutu_no,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_kart_no \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kart_no,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_aciklama \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_aciklama,\r\n+\t\t\t\t \r\n+\t\t\t\t(SELECT a2.aktivasyon_kampanya_kodu \r\n+\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kampanya_kodu,\r\n \t\t\t\t\r\n \t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n \t\t\t\t\r\n \t\t\tFROM cari c\r\n@@ -2382,16 +2435,16 @@\n \t\t\t\tWHERE ch.ch_alacak IS NOT NULL AND ch.ch_alacak > 0\r\n \t\t\t\tGROUP BY ch.ch_cariID\r\n \t\t\t) tahsilat_gorseller ON c.cari_id = tahsilat_gorseller.ch_cariID\r\n \t\t\t\r\n-\t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n-\t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n-\t\t\tLEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id AND ad.durum = 1\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n \t\t\tWHERE c.cari_durum = 1\r\n-\t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id, ad.aktivasyon_durum_id\r\n-\t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n+\t\t\tGROUP BY c.cari_id\r\n+\t\t\tORDER BY \r\n+\t\t\t\tCASE WHEN c.cari_olusturmaTarihi IS NULL THEN 1 ELSE 0 END,\r\n+\t\t\t\tc.cari_olusturmaTarihi DESC, \r\n+\t\t\t\tc.cari_ad, c.cari_soyad\r\n \t\t\";\r\n \t\t\t\r\n \t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n \t\t\t\r\n@@ -2520,11 +2573,11 @@\n \t\t\t// Memory limit artır\r\n \t\t\tini_set('memory_limit', '512M');\r\n \t\t\tini_set('max_execution_time', 600);\r\n \t\t\t\r\n-\t\t\t// Aynı sorguyu kullan\r\n+\t\t\t// Basitleştirilmiş sorgu kullan - sadece temel bilgiler\r\n \t\t\t$query = \"\r\n-\t\t\t\tSELECT DISTINCT\r\n+\t\t\t\tSELECT \r\n \t\t\t\t\tc.cari_id,\r\n \t\t\t\t\tc.cari_ad,\r\n \t\t\t\t\tc.cari_soyad,\r\n \t\t\t\t\tCASE \r\n@@ -2532,31 +2585,54 @@\n \t\t\t\t\t\tTHEN c.cari_ad \r\n \t\t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n \t\t\t\t\tEND as cari_isletme,\r\n \t\t\t\t\t\r\n-\t\t\t\t\tsf.satis_id as satis_sozlesme_id,\r\n-\t\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar,\r\n-\t\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutar_kdv_dahil,\r\n-\t\t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n+\t\t\t\t\t-- Kayıt tarihi\r\n+\t\t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n \t\t\t\t\t\r\n-\t\t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n+\t\t\t\t\t-- Satış sözleşmesi bilgileri (en yeni)\r\n+\t\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Tahsilat tutarı\r\n \t\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\t\r\n-\t\t\t\t\t-- Aktivasyon durumu (aktivasyon_durum tablosundan - sadece aktif durumlar)\r\n-\t\t\t\t\tCOALESCE(ad.aktivasyon_durum_adi, 'Tanımlanmamış') as aktivasyon_durum,\r\n-\t\t\t\t\tCOALESCE(ad.aktivasyon_durum_renk, '#6c757d') as aktivasyon_durum_renk,\r\n-\t\t\t\t\tad.aktivasyon_durum_id,\r\n-\t\t\t\t\tad.durum as aktivasyon_durum_aktif,\r\n+\t\t\t\t\t-- Aktivasyon durumu (en yeni aktivasyon)\r\n+\t\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_adi, 'Tanımlanmamış') \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.aktivasyon_tarihi \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_tarihi,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.olusturma_tarihi \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as olusturma_tarihi,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.aktivasyon_uye_no \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_uye_no,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.aktivasyon_kutu_no \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kutu_no,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.aktivasyon_kart_no \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kart_no,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.aktivasyon_kampanya_kodu \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kampanya_kodu,\r\n \t\t\t\t\t\r\n-\t\t\t\t\ta.aktivasyon_id,\r\n-\t\t\t\t\ta.aktivasyon_tarihi,\r\n-\t\t\t\t\ta.olusturma_tarihi,\r\n-\t\t\t\t\ta.aktivasyon_uye_no,\r\n-\t\t\t\t\ta.aktivasyon_kutu_no,\r\n-\t\t\t\t\ta.aktivasyon_kart_no,\r\n-\t\t\t\t\ta.aktivasyon_aciklama,\r\n-\t\t\t\t\ta.aktivasyon_kampanya_kodu,\r\n-\t\t\t\t\t\r\n \t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n \t\t\t\t\t\r\n \t\t\t\tFROM cari c\r\n \t\t\t\t\r\n@@ -2567,16 +2643,16 @@\n \t\t\t\t\tWHERE ch_alacak IS NOT NULL AND ch_alacak > 0\r\n \t\t\t\t\tGROUP BY ch_cariID\r\n \t\t\t\t) ch_toplam ON c.cari_id = ch_toplam.ch_cariID\r\n \t\t\t\t\r\n-\t\t\t\tLEFT JOIN satisfaturasi sf ON c.cari_id = sf.satis_cariID\r\n-\t\t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n-\t\t\t\tLEFT JOIN aktivasyon_durum ad ON a.aktivasyon_durum_id = ad.aktivasyon_durum_id AND ad.durum = 1\r\n \t\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\t\r\n \t\t\t\tWHERE c.cari_durum = 1\r\n-\t\t\t\tGROUP BY c.cari_id, sf.satis_id, a.aktivasyon_id, ad.aktivasyon_durum_id\r\n-\t\t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n+\t\t\t\tGROUP BY c.cari_id\r\n+\t\t\t\tORDER BY \r\n+\t\t\t\t\tCASE WHEN c.cari_olusturmaTarihi IS NULL THEN 1 ELSE 0 END,\r\n+\t\t\t\t\tc.cari_olusturmaTarihi DESC, \r\n+\t\t\t\t\tc.cari_ad, c.cari_soyad\r\n \t\t\t\";\r\n \t\t\t\t\r\n \t\t\t$rapor_verileri = $this->db->query($query)->result();\r\n \t\t\t\r\n@@ -2586,18 +2662,19 @@\n \t\t\t$sheet->setTitle('Tam Ana Rapor');\r\n \t\t\t\r\n \t\t\t// Başlıkları ayarla\r\n \t\t\t$headers = [\r\n-\t\t\t\t'A1' => 'İşletme',\r\n-\t\t\t\t'B1' => 'Satış Sözleşme Tutarı',\r\n-\t\t\t\t'C1' => 'Tahsilat Tutarı',\r\n-\t\t\t\t'D1' => 'Aktivasyon Durumu',\r\n-\t\t\t\t'E1' => 'Aktivasyon Tarihi',\r\n-\t\t\t\t'F1' => 'Üye No',\r\n-\t\t\t\t'G1' => 'Kutu No', \r\n-\t\t\t\t'H1' => 'Kart No',\r\n-\t\t\t\t'I1' => 'Kampanya Kodu',\r\n-\t\t\t\t'J1' => 'Personel'\r\n+\t\t\t\t'A1' => 'Tarih',\r\n+\t\t\t\t'B1' => 'İşletme',\r\n+\t\t\t\t'C1' => 'Satış Sözleşme Tutarı',\r\n+\t\t\t\t'D1' => 'Tahsilat Tutarı',\r\n+\t\t\t\t'E1' => 'Aktivasyon Durumu',\r\n+\t\t\t\t'F1' => 'Aktivasyon Tarihi',\r\n+\t\t\t\t'G1' => 'Üye No',\r\n+\t\t\t\t'H1' => 'Kutu No', \r\n+\t\t\t\t'I1' => 'Kart No',\r\n+\t\t\t\t'J1' => 'Kampanya Kodu',\r\n+\t\t\t\t'K1' => 'Personel'\r\n \t\t\t];\r\n \t\t\t\r\n \t\t\tforeach ($headers as $cell => $value) {\r\n \t\t\t\t$sheet->setCellValue($cell, $value);\r\n@@ -2610,32 +2687,34 @@\n \t\t\t\t'alignment' => ['horizontal' => \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::HORIZONTAL_CENTER],\r\n \t\t\t\t'borders' => ['allBorders' => ['borderStyle' => \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN]]\r\n \t\t\t];\r\n \t\t\t\r\n-\t\t\t$sheet->getStyle('A1:J1')->applyFromArray($headerStyle);\r\n+\t\t\t$sheet->getStyle('A1:K1')->applyFromArray($headerStyle);\r\n \t\t\t\r\n \t\t\t// Veriları ekle\r\n \t\t\t$row = 2;\r\n \t\t\tforeach ($rapor_verileri as $veri) {\r\n \t\t\t\t$display_date = $veri->aktivasyon_tarihi ?? $veri->olusturma_tarihi;\r\n \t\t\t\t$formatted_date = $display_date ? date('d.m.Y H:i:s', strtotime($display_date)) : '-';\r\n+\t\t\t\t$kayit_tarih_formatted = $veri->kayit_tarihi ? date('d.m.Y', strtotime($veri->kayit_tarihi)) : '-';\r\n \t\t\t\t\r\n-\t\t\t\t$sheet->setCellValue('A' . $row, $veri->cari_isletme ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('B' . $row, $veri->satis_sozlesme_tutar ? number_format($veri->satis_sozlesme_tutar, 2, ',', '.') . ' ₺' : '-');\r\n-\t\t\t\t$sheet->setCellValue('C' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') . ' ₺' : '-');\r\n-\t\t\t\t$sheet->setCellValue('D' . $row, $veri->aktivasyon_durum ?? 'Tanımlanmamış');\r\n-\t\t\t\t$sheet->setCellValue('E' . $row, $formatted_date);\r\n-\t\t\t\t$sheet->setCellValue('F' . $row, $veri->aktivasyon_uye_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('G' . $row, $veri->aktivasyon_kutu_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_kart_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('I' . $row, $veri->aktivasyon_kampanya_kodu ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('J' . $row, $veri->personel ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('A' . $row, $kayit_tarih_formatted);\r\n+\t\t\t\t$sheet->setCellValue('B' . $row, $veri->cari_isletme ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('C' . $row, $veri->satis_sozlesme_tutar ? number_format($veri->satis_sozlesme_tutar, 2, ',', '.') . ' ₺' : '-');\r\n+\t\t\t\t$sheet->setCellValue('D' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') . ' ₺' : '-');\r\n+\t\t\t\t$sheet->setCellValue('E' . $row, $veri->aktivasyon_durum ?? 'Tanımlanmamış');\r\n+\t\t\t\t$sheet->setCellValue('F' . $row, $formatted_date);\r\n+\t\t\t\t$sheet->setCellValue('G' . $row, $veri->aktivasyon_uye_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_kutu_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('I' . $row, $veri->aktivasyon_kart_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('J' . $row, $veri->aktivasyon_kampanya_kodu ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('K' . $row, $veri->personel ?? '-');\r\n \t\t\t\t\r\n \t\t\t\t$row++;\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t// Sütun genişliklerini ayarla\r\n-\t\t\tforeach (range('A', 'J') as $column) {\r\n+\t\t\tforeach (range('A', 'K') as $column) {\r\n \t\t\t\t$sheet->getColumnDimension($column)->setAutoSize(true);\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t// Tüm veriler için border ekle\r\n"
                },
                {
                    "date": 1755506192842,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2261,12 +2261,18 @@\n \t\t\t\t-- Kayıt tarihi (en yeni önce sıralama için)\r\n \t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n \t\t\t\t\r\n \t\t\t\t-- Satış sözleşmesi bilgileri (en yeni satış)\r\n-\t\t\t\t(SELECT sf2.satis_id FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n-\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n-\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n-\t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n+\t\t\t\t(SELECT sf2.satis_id FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n+\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n+\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n+\t\t\t\t-- Stok adı bilgisi (en yeni satıştan)\r\n+\t\t\t\t(SELECT s.stok_ad \r\n+\t\t\t\t FROM satisFaturasi sf2 \r\n+\t\t\t\t INNER JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf2.satis_id\r\n+\t\t\t\t INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n+\t\t\t\t WHERE sf2.satis_cariID = c.cari_id \r\n+\t\t\t\t ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_hizmeti,\r\n \t\t\t\t\r\n \t\t\t\t-- İşletme görsel sayısını hesapla (fotograf_dosya kolonundan)\r\n \t\t\t\tCASE \r\n \t\t\t\t\tWHEN c.fotograf_dosya IS NOT NULL AND c.fotograf_dosya != '' \r\n@@ -2285,9 +2291,9 @@\n \t\t\t\t(SELECT CASE \r\n \t\t\t\t\tWHEN sf2.satis_dosya IS NOT NULL AND sf2.satis_dosya != '' \r\n \t\t\t\t\tTHEN (LENGTH(sf2.satis_dosya) - LENGTH(REPLACE(sf2.satis_dosya, ',', '')) + 1)\r\n \t\t\t\t\tELSE 0\r\n-\t\t\t\tEND FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_gorsel_sayisi,\r\n+\t\t\t\tEND FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_gorsel_sayisi,\r\n \t\t\t\t\r\n \t\t\t\t-- Banka görsel sayısını hesapla\r\n \t\t\t\tCOALESCE(banka_gorseller.banka_gorsel_sayisi, 0) as banka_gorsel_sayisi,\r\n \t\t\t\t\r\n@@ -2589,10 +2595,18 @@\n \t\t\t\t\t-- Kayıt tarihi\r\n \t\t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n \t\t\t\t\t\r\n \t\t\t\t\t-- Satış sözleşmesi bilgileri (en yeni)\r\n-\t\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisfaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n+\t\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n \t\t\t\t\t\r\n+\t\t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - Excel için eklendi\r\n+\t\t\t\t\t(SELECT s.stok_ad \r\n+\t\t\t\t\t FROM satisFaturasi sf2 \r\n+\t\t\t\t\t INNER JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf2.satis_id\r\n+\t\t\t\t\t INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n+\t\t\t\t\t WHERE sf2.satis_cariID = c.cari_id \r\n+\t\t\t\t\t ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_hizmeti,\r\n+\t\t\t\t\t\r\n \t\t\t\t\t-- Tahsilat tutarı\r\n \t\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\t\r\n \t\t\t\t\t-- Aktivasyon durumu (en yeni aktivasyon)\r\n@@ -2665,16 +2679,17 @@\n \t\t\t$headers = [\r\n \t\t\t\t'A1' => 'Tarih',\r\n \t\t\t\t'B1' => 'İşletme',\r\n \t\t\t\t'C1' => 'Satış Sözleşme Tutarı',\r\n-\t\t\t\t'D1' => 'Tahsilat Tutarı',\r\n-\t\t\t\t'E1' => 'Aktivasyon Durumu',\r\n-\t\t\t\t'F1' => 'Aktivasyon Tarihi',\r\n-\t\t\t\t'G1' => 'Üye No',\r\n-\t\t\t\t'H1' => 'Kutu No', \r\n-\t\t\t\t'I1' => 'Kart No',\r\n-\t\t\t\t'J1' => 'Kampanya Kodu',\r\n-\t\t\t\t'K1' => 'Personel'\r\n+\t\t\t\t'D1' => 'Satış Sözleşme Hizmeti',\r\n+\t\t\t\t'E1' => 'Tahsilat Tutarı',\r\n+\t\t\t\t'F1' => 'Aktivasyon Durumu',\r\n+\t\t\t\t'G1' => 'Aktivasyon Tarihi',\r\n+\t\t\t\t'H1' => 'Üye No',\r\n+\t\t\t\t'I1' => 'Kutu No', \r\n+\t\t\t\t'J1' => 'Kart No',\r\n+\t\t\t\t'K1' => 'Kampanya Kodu',\r\n+\t\t\t\t'L1' => 'Personel'\r\n \t\t\t];\r\n \t\t\t\r\n \t\t\tforeach ($headers as $cell => $value) {\r\n \t\t\t\t$sheet->setCellValue($cell, $value);\r\n@@ -2687,9 +2702,9 @@\n \t\t\t\t'alignment' => ['horizontal' => \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::HORIZONTAL_CENTER],\r\n \t\t\t\t'borders' => ['allBorders' => ['borderStyle' => \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN]]\r\n \t\t\t];\r\n \t\t\t\r\n-\t\t\t$sheet->getStyle('A1:K1')->applyFromArray($headerStyle);\r\n+\t\t\t$sheet->getStyle('A1:L1')->applyFromArray($headerStyle);\r\n \t\t\t\r\n \t\t\t// Veriları ekle\r\n \t\t\t$row = 2;\r\n \t\t\tforeach ($rapor_verileri as $veri) {\r\n@@ -2699,16 +2714,17 @@\n \t\t\t\t\r\n \t\t\t\t$sheet->setCellValue('A' . $row, $kayit_tarih_formatted);\r\n \t\t\t\t$sheet->setCellValue('B' . $row, $veri->cari_isletme ?? '-');\r\n \t\t\t\t$sheet->setCellValue('C' . $row, $veri->satis_sozlesme_tutar ? number_format($veri->satis_sozlesme_tutar, 2, ',', '.') . ' ₺' : '-');\r\n-\t\t\t\t$sheet->setCellValue('D' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') . ' ₺' : '-');\r\n-\t\t\t\t$sheet->setCellValue('E' . $row, $veri->aktivasyon_durum ?? 'Tanımlanmamış');\r\n-\t\t\t\t$sheet->setCellValue('F' . $row, $formatted_date);\r\n-\t\t\t\t$sheet->setCellValue('G' . $row, $veri->aktivasyon_uye_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_kutu_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('I' . $row, $veri->aktivasyon_kart_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('J' . $row, $veri->aktivasyon_kampanya_kodu ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('K' . $row, $veri->personel ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('D' . $row, $veri->satis_sozlesme_hizmeti ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('E' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') . ' ₺' : '-');\r\n+\t\t\t\t$sheet->setCellValue('F' . $row, $veri->aktivasyon_durum ?? 'Tanımlanmamış');\r\n+\t\t\t\t$sheet->setCellValue('G' . $row, $formatted_date);\r\n+\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_uye_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('I' . $row, $veri->aktivasyon_kutu_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('J' . $row, $veri->aktivasyon_kart_no ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('K' . $row, $veri->aktivasyon_kampanya_kodu ?? '-');\r\n+\t\t\t\t$sheet->setCellValue('L' . $row, $veri->personel ?? '-');\r\n \t\t\t\t\r\n \t\t\t\t$row++;\r\n \t\t\t}\r\n \t\t\t\r\n"
                },
                {
                    "date": 1755584922838,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2755,5 +2755,235 @@\n \t\t\tredirect('muhasebe/tam-ana-rapor');\r\n \t\t}\r\n \t}\r\n \t\r\n+\t/**\r\n+\t * Satış faturasındaki stok bilgilerini getir (AJAX)\r\n+\t */\r\n+\tpublic function getStokBilgileri()\r\n+\t{\r\n+\t\t// JSON response header\r\n+\t\theader('Content-Type: application/json');\r\n+\t\t\r\n+\t\t// Geçici olarak session kontrolünü bypass et\r\n+\t\t$bypass_session = true;\r\n+\t\tif (!$bypass_session) {\r\n+\t\t\t$control = session(\"r\", \"login\");\r\n+\t\t\tif (!$control) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Session hatası']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\t\r\n+\t\t// Geçici olarak yetki kontrolünü bypass et\r\n+\t\t/*\r\n+\t\tif (!grup_modul_yetkisi_var(531)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Yetki hatası']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t*/\r\n+\t\t\r\n+\t\t// POST verilerini al - IIS uyumlu\r\n+\t\t$raw_post = file_get_contents('php://input');\r\n+\t\tparse_str($raw_post, $post_data);\r\n+\t\t\r\n+\t\t$satis_id = $this->input->post('satis_id') ?: (isset($_POST['satis_id']) ? $_POST['satis_id'] : (isset($post_data['satis_id']) ? $post_data['satis_id'] : null));\r\n+\t\t$cari_id = $this->input->post('cari_id') ?: (isset($_POST['cari_id']) ? $_POST['cari_id'] : (isset($post_data['cari_id']) ? $post_data['cari_id'] : null));\r\n+\t\t\r\n+\t\terror_log(\"DEBUG: getStokBilgileri called with satis_id: $satis_id, cari_id: $cari_id\");\r\n+\t\terror_log(\"DEBUG: POST data: \" . print_r($_POST, true));\r\n+\t\terror_log(\"DEBUG: Raw POST: \" . $raw_post);\r\n+\t\terror_log(\"DEBUG: Parsed POST: \" . print_r($post_data, true));\r\n+\t\terror_log(\"DEBUG: CodeIgniter input: \" . print_r($this->input->post(), true));\r\n+\t\t\r\n+\t\tif (!$satis_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Satış ID bilgisi eksik', 'debug' => [\r\n+\t\t\t\t'post' => $_POST,\r\n+\t\t\t\t'raw_post' => $raw_post,\r\n+\t\t\t\t'parsed_post' => $post_data,\r\n+\t\t\t\t'ci_input' => $this->input->post()\r\n+\t\t\t]]);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Stok bilgilerini çek\r\n+\t\t\t$query = \"\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tsfs.satisStok_id,\r\n+\t\t\t\t\tsfs.satisStok_satisFaturasiID,\r\n+\t\t\t\t\tsfs.satisStok_stokID as stok_id,\r\n+\t\t\t\t\tsfs.satisStok_stokAdi as stok_adi,\r\n+\t\t\t\t\tsfs.satisStok_miktar,\r\n+\t\t\t\t\tsfs.satisStok_birimFiyat,\r\n+\t\t\t\t\tsfs.satisStok_kdv,\r\n+\t\t\t\t\ts.stok_kodu,\r\n+\t\t\t\t\ts.stok_birim,\r\n+\t\t\t\t\ts.stok_satisFiyat1\r\n+\t\t\t\tFROM satisFaturasiStok sfs\r\n+\t\t\t\tLEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n+\t\t\t\tWHERE sfs.satisStok_satisFaturasiID = ?\r\n+\t\t\t\tORDER BY sfs.satisStok_id ASC\r\n+\t\t\t\";\r\n+\t\t\t\r\n+\t\t\terror_log(\"DEBUG: Query: $query with satis_id: $satis_id\");\r\n+\t\t\t$result = $this->db->query($query, [$satis_id])->result();\r\n+\t\t\terror_log(\"DEBUG: Query result count: \" . count($result));\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true,\r\n+\t\t\t\t'data' => $result,\r\n+\t\t\t\t'debug' => [\r\n+\t\t\t\t\t'satis_id' => $satis_id,\r\n+\t\t\t\t\t'cari_id' => $cari_id,\r\n+\t\t\t\t\t'count' => count($result)\r\n+\t\t\t\t]\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\terror_log(\"DEBUG: Exception in getStokBilgileri: \" . $e->getMessage());\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Veri alınırken hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Stok bilgilerini kaydet (AJAX)\r\n+\t */\r\n+\tpublic function stokBilgileriKaydet()\r\n+\t{\r\n+\t\t// Yetki kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(531)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Yetki hatası']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\t$satis_id = $this->input->post('satis_id');\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t$stok_bilgileri = $this->input->post('stok_bilgileri');\r\n+\t\t\r\n+\t\tif (!$satis_id || !$stok_bilgileri || !is_array($stok_bilgileri)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Gerekli veriler eksik']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\t$this->db->trans_start();\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$user_info = session(\"r\", \"login_info\");\r\n+\t\t\t$user_id = $user_info ? $user_info->kullanici_id : 0;\r\n+\t\t\t\r\n+\t\t\t// Mevcut stok kayıtlarını sil\r\n+\t\t\t$this->db->where('satisStok_satisFaturasiID', $satis_id);\r\n+\t\t\t$this->db->delete('satisFaturasiStok');\r\n+\t\t\t\r\n+\t\t\t$toplam_tutar = 0;\r\n+\t\t\t$toplam_kdv_dahil = 0;\r\n+\t\t\t\r\n+\t\t\t// Yeni stok kayıtlarını ekle\r\n+\t\t\tforeach ($stok_bilgileri as $stok) {\r\n+\t\t\t\tif (empty($stok['stok_adi']) || empty($stok['miktar']) || !isset($stok['birim_fiyat'])) {\r\n+\t\t\t\t\tcontinue;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t$miktar = floatval($stok['miktar']);\r\n+\t\t\t\t$birim_fiyat = floatval($stok['birim_fiyat']);\r\n+\t\t\t\t$kdv_orani = floatval($stok['kdv_orani']);\r\n+\t\t\t\t\r\n+\t\t\t\t$ara_toplam = $miktar * $birim_fiyat;\r\n+\t\t\t\t$kdv_tutari = $ara_toplam * ($kdv_orani / 100);\r\n+\t\t\t\t$toplam_satir = $ara_toplam + $kdv_tutari;\r\n+\t\t\t\t\r\n+\t\t\t\t$toplam_tutar += $ara_toplam;\r\n+\t\t\t\t$toplam_kdv_dahil += $toplam_satir;\r\n+\t\t\t\t\r\n+\t\t\t\t$insert_data = [\r\n+\t\t\t\t\t'satisStok_satisFaturasiID' => $satis_id,\r\n+\t\t\t\t\t'satisStok_stokID' => !empty($stok['stok_id']) ? $stok['stok_id'] : null,\r\n+\t\t\t\t\t'satisStok_stokAdi' => $stok['stok_adi'],\r\n+\t\t\t\t\t'satisStok_miktar' => $miktar,\r\n+\t\t\t\t\t'satisStok_birimFiyat' => $birim_fiyat,\r\n+\t\t\t\t\t'satisStok_kdv' => $kdv_orani,\r\n+\t\t\t\t\t'satisStok_kdvTutar' => $kdv_tutari,\r\n+\t\t\t\t\t'satisStok_toplam' => $toplam_satir,\r\n+\t\t\t\t\t'satisStok_olusturmaTarihi' => date('Y-m-d H:i:s'),\r\n+\t\t\t\t\t'satisStok_olusturan' => $user_id\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\t$this->db->insert('satisFaturasiStok', $insert_data);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Satış faturası toplamlarını güncelle\r\n+\t\t\t$update_data = [\r\n+\t\t\t\t'satis_araToplam' => $toplam_tutar,\r\n+\t\t\t\t'satis_kdvToplam' => $toplam_kdv_dahil - $toplam_tutar,\r\n+\t\t\t\t'satis_vergiDahilToplam' => $toplam_kdv_dahil,\r\n+\t\t\t\t'satis_genelToplam' => $toplam_kdv_dahil,\r\n+\t\t\t\t'satis_guncellemeTarihi' => date('Y-m-d H:i:s'),\r\n+\t\t\t\t'satis_guncelleyen' => $user_id\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\t$this->db->where('satis_id', $satis_id);\r\n+\t\t\t$this->db->update('satisFaturasi', $update_data);\r\n+\t\t\t\r\n+\t\t\t// Cari hareket güncellemesi\r\n+\t\t\t$this->updateCariHareketleri($satis_id, $cari_id, $toplam_kdv_dahil, $user_id);\r\n+\t\t\t\r\n+\t\t\t$this->db->trans_complete();\r\n+\t\t\t\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı işlemi başarısız']);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode(['success' => true, 'message' => 'Stok bilgileri başarıyla kaydedildi']);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t$this->db->trans_rollback();\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt sırasında hata oluştu: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Cari hareketlerini güncelle\r\n+\t */\r\n+\tprivate function updateCariHareketleri($satis_id, $cari_id, $tutar, $user_id)\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t// Mevcut cari hareket kaydını kontrol et\r\n+\t\t\t$ch_query = \"SELECT ch_id FROM carihareketleri WHERE ch_sfID = ? LIMIT 1\";\r\n+\t\t\t$ch_result = $this->db->query($ch_query, [$satis_id])->row();\r\n+\t\t\t\r\n+\t\t\tif ($ch_result) {\r\n+\t\t\t\t// Mevcut kaydı güncelle\r\n+\t\t\t\t$update_data = [\r\n+\t\t\t\t\t'ch_borc' => $tutar,\r\n+\t\t\t\t\t'ch_guncellemeTarihi' => date('Y-m-d H:i:s'),\r\n+\t\t\t\t\t'ch_guncelleyen' => $user_id\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\t$this->db->where('ch_id', $ch_result->ch_id);\r\n+\t\t\t\t$this->db->update('carihareketleri', $update_data);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Yeni kayıt oluştur\r\n+\t\t\t\t$insert_data = [\r\n+\t\t\t\t\t'ch_cariID' => $cari_id,\r\n+\t\t\t\t\t'ch_sfID' => $satis_id,\r\n+\t\t\t\t\t'ch_tip' => 'Satış Faturası',\r\n+\t\t\t\t\t'ch_borc' => $tutar,\r\n+\t\t\t\t\t'ch_tarih' => date('Y-m-d'),\r\n+\t\t\t\t\t'ch_olusturmaTarihi' => date('Y-m-d H:i:s'),\r\n+\t\t\t\t\t'ch_olusturan' => $user_id,\r\n+\t\t\t\t\t'ch_aciklama' => 'Stok bilgisi güncelleme işlemi'\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\t$this->db->insert('carihareketleri', $insert_data);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\tlog_message('error', 'updateCariHareketleri hatası: ' . $e->getMessage());\r\n+\t\t\tthrow $e;\r\n+\t\t}\r\n+\t}\r\n+\t\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1755672207188,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2376,9 +2376,11 @@\n \t\t\t\t FROM aktivasyon a2 \r\n \t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n \t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kampanya_kodu,\r\n \t\t\t\t\r\n-\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n+\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel,\r\n+\t\t\t\tk.kullanici_eposta,\r\n+\t\t\t\tk.kullanici_id\r\n \t\t\t\t\r\n \t\t\tFROM cari c\r\n \t\t\t\r\n \t\t\t-- Carihareketleri tablosundan tahsilat toplamını al\r\n"
                },
                {
                    "date": 1755782695460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2498,13 +2498,13 @@\n \t * Tahsilat detaylarını getir - AJAX\r\n \t */\r\n \tpublic function getTahsilatDetay()\r\n \t{\r\n-\t\t// AJAX isteği kontrolü\r\n-\t\tif (!$this->input->is_ajax_request()) {\r\n-\t\t\tshow_404();\r\n-\t\t\treturn;\r\n-\t\t}\r\n+\t\t// AJAX isteği kontrolü - Geçici olarak devre dışı\r\n+\t\t// if (!$this->input->is_ajax_request()) {\r\n+\t\t//\tshow_404();\r\n+\t\t//\treturn;\r\n+\t\t// }\r\n \t\t\r\n \t\t$cari_id = $this->input->post('cari_id');\r\n \t\t\r\n \t\tif (!$cari_id) {\r\n@@ -2513,14 +2513,21 @@\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n \t\t\t// Tahsilat detaylarını getir (carihareketleri tablosundan ch_alacak > 0 olanlar)\r\n+\t\t\t// muhasebe_tahsilat_durum tablosu ile JOIN yaparak durumu da al\r\n \t\t\t$query = \"\r\n \t\t\t\tSELECT \r\n+\t\t\t\t\tch.ch_id,\r\n \t\t\t\t\tch.ch_tarih,\r\n \t\t\t\t\tch.ch_belgeNumarasi,\r\n \t\t\t\t\tch.ch_alacak,\r\n \t\t\t\t\tch.ch_aciklama,\r\n+\t\t\t\t\tch.ch_turu,\r\n+\t\t\t\t\tch.ch_kasaID,\r\n+\t\t\t\t\tch.ch_cekID,\r\n+\t\t\t\t\tch.ch_senetID,\r\n+\t\t\t\t\tch.ch_bankaID,\r\n \t\t\t\t\tCASE \r\n \t\t\t\t\t\tWHEN ch.ch_turu = 1 THEN 'Açılış'\r\n \t\t\t\t\t\tWHEN ch.ch_turu = 2 THEN 'Satış Faturası'\r\n \t\t\t\t\t\tWHEN ch.ch_turu = 3 THEN 'Alış Faturası'\r\n@@ -2534,10 +2541,28 @@\n \t\t\t\t\t\tWHEN ch.ch_turu = 11 THEN 'Senet Çıkış'\r\n \t\t\t\t\t\tWHEN ch.ch_turu = 12 THEN 'Kredi Kartı'\r\n \t\t\t\t\t\tWHEN ch.ch_turu = 13 THEN 'Havale/EFT'\r\n \t\t\t\t\t\tELSE CONCAT('Tür-', ch.ch_turu)\r\n-\t\t\t\t\tEND as tahsilat_tipi\r\n+\t\t\t\t\tEND as tahsilat_tipi,\r\n+\t\t\t\t\tmtd.id as tahsilat_durum_id,\r\n+\t\t\t\t\tmtd.durum as durum_kodu,\r\n+\t\t\t\t\tmtd.tahsilat_tipi as muhasebe_tahsilat_tipi,\r\n+\t\t\t\t\tCASE \r\n+\t\t\t\t\t\tWHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n+\t\t\t\t\t\tWHEN mtd.durum = 2 THEN 'Onaylandı'\r\n+\t\t\t\t\t\tWHEN mtd.durum = 3 THEN 'Reddedildi'\r\n+\t\t\t\t\t\tWHEN mtd.durum IS NULL THEN NULL\r\n+\t\t\t\t\t\tELSE 'Bilinmiyor'\r\n+\t\t\t\t\tEND as tahsilat_durum,\r\n+\t\t\t\t\tmtd.aciklama as durum_aciklama,\r\n+\t\t\t\t\tmtd.olusturma_tarihi as durum_tarihi\r\n \t\t\t\tFROM carihareketleri ch\r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON (\r\n+\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND ch.ch_kasaID IS NOT NULL AND mtd.kayit_id = ch.ch_kasaID)\r\n+\t\t\t\t\tOR (mtd.tahsilat_tipi = 2 AND ch.ch_cekID IS NOT NULL AND mtd.kayit_id = ch.ch_cekID)  \r\n+\t\t\t\t\tOR (mtd.tahsilat_tipi = 3 AND ch.ch_senetID IS NOT NULL AND mtd.kayit_id = ch.ch_senetID)\r\n+\t\t\t\t\tOR (mtd.tahsilat_tipi = 4 AND ch.ch_bankaID IS NOT NULL AND mtd.kayit_id = ch.ch_bankaID)\r\n+\t\t\t\t)\r\n \t\t\t\tWHERE ch.ch_cariID = ? \r\n \t\t\t\t  AND ch.ch_alacak IS NOT NULL \r\n \t\t\t\t  AND ch.ch_alacak > 0\r\n \t\t\t\tORDER BY ch.ch_tarih DESC, ch.ch_id DESC\r\n@@ -2987,5 +3012,149 @@\n \t\t\tthrow $e;\r\n \t\t}\r\n \t}\r\n \t\r\n+\t/**\r\n+\t * Tahsilat kaydı sil - AJAX\r\n+\t * Cari hareketleri ile birlikte ilgili kasa, çek, senet, banka hareketlerini de siler\r\n+\t */\r\n+\tpublic function tahsilatSil()\r\n+\t{\r\n+\t\t// AJAX isteği kontrolü - Geçici olarak devre dışı\r\n+\t\t// if (!$this->input->is_ajax_request()) {\r\n+\t\t//\tshow_404();\r\n+\t\t//\treturn;\r\n+\t\t// }\r\n+\t\t\r\n+\t\t$ch_id = $this->input->post('ch_id');\r\n+\t\tif (!$ch_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Debug için log ekle\r\n+\t\t\terror_log(\"TAHSILAT SİL - CH_ID: \" . $ch_id);\r\n+\t\t\t\r\n+\t\t\t// Önce cari hareket kaydını al\r\n+\t\t\t$this->db->where('ch_id', $ch_id);\r\n+\t\t\t$cariHareket = $this->db->get('carihareketleri')->row();\r\n+\t\t\t\r\n+\t\t\tif (!$cariHareket) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat kaydı bulunamadı']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Debug için cari hareket bilgilerini logla\r\n+\t\t\terror_log(\"CARİ HAREKET: \" . json_encode($cariHareket));\r\n+\t\t\t\r\n+\t\t\t// Tahsilat türüne göre ilgili tablodan da sil\r\n+\t\t\t$deleted_related = false;\r\n+\t\t\t$related_info = '';\r\n+\t\t\t\r\n+\t\t\t// Kasa işlemleri (ch_turu = 4: Kasa Giriş, 5: Kasa Çıkış)\r\n+\t\t\tif (($cariHareket->ch_turu == 4 || $cariHareket->ch_turu == 5) && !empty($cariHareket->ch_kasaID)) {\r\n+\t\t\t\terror_log(\"KASA SİLME İŞLEMİ - Kasa ID: \" . $cariHareket->ch_kasaID . \", Cari ID: \" . $cariHareket->ch_cariID);\r\n+\t\t\t\t\r\n+\t\t\t\t// Alternatif 1: kh_id ile sil\r\n+\t\t\t\t$this->db->where('kh_id', $cariHareket->ch_kasaID);\r\n+\t\t\t\t$kasaHareket = $this->db->get('kasaHareketleri')->row();\r\n+\t\t\t\t\r\n+\t\t\t\tif ($kasaHareket) {\r\n+\t\t\t\t\terror_log(\"KASA HAREKET BULUNDU (kh_id ile): \" . json_encode($kasaHareket));\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t$this->db->where('kh_id', $cariHareket->ch_kasaID);\r\n+\t\t\t\t\t$kasa_deleted = $this->db->delete('kasaHareketleri');\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tif ($kasa_deleted) {\r\n+\t\t\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t\t\t$related_info .= \"Kasa hareketi silindi (kh_id: \" . $cariHareket->ch_kasaID . \"), \";\r\n+\t\t\t\t\t}\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t// Alternatif 2: cari ID ve tarih/tutar eşleşmesi ile sil\r\n+\t\t\t\t\terror_log(\"kh_id ile bulunamadı, cari ID ile deneniyor...\");\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t$this->db->where('kh_cariID', $cariHareket->ch_cariID);\r\n+\t\t\t\t\t$this->db->where('kh_tarih', $cariHareket->ch_tarih);\r\n+\t\t\t\t\t$this->db->where('kh_giris', $cariHareket->ch_alacak);\r\n+\t\t\t\t\t$kasaHareketCari = $this->db->get('kasaHareketleri')->row();\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tif ($kasaHareketCari) {\r\n+\t\t\t\t\t\terror_log(\"KASA HAREKET BULUNDU (cari ID ile): \" . json_encode($kasaHareketCari));\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t$this->db->where('kh_cariID', $cariHareket->ch_cariID);\r\n+\t\t\t\t\t\t$this->db->where('kh_tarih', $cariHareket->ch_tarih);\r\n+\t\t\t\t\t\t$this->db->where('kh_giris', $cariHareket->ch_alacak);\r\n+\t\t\t\t\t\t$kasa_deleted = $this->db->delete('kasaHareketleri');\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tif ($kasa_deleted) {\r\n+\t\t\t\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t\t\t\t$related_info .= \"Kasa hareketi silindi (cari eşleşmesi ile), \";\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\terror_log(\"KASA HAREKET HİÇBİR YÖNTEMLE BULUNAMADI\");\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Banka işlemleri (ch_turu = 6: Banka Giriş, 7: Banka Çıkış)\r\n+\t\t\telse if (($cariHareket->ch_turu == 6 || $cariHareket->ch_turu == 7) && !empty($cariHareket->ch_bankaID)) {\r\n+\t\t\t\terror_log(\"BANKA SİLME İŞLEMİ - Banka ID: \" . $cariHareket->ch_bankaID);\r\n+\t\t\t\t\r\n+\t\t\t\t// Banka hareketlerini sil\r\n+\t\t\t\t$this->db->where('bh_id', $cariHareket->ch_bankaID);\r\n+\t\t\t\t$banka_deleted = $this->db->delete('bankaHareketleri');\r\n+\t\t\t\t\r\n+\t\t\t\tif ($banka_deleted) {\r\n+\t\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t\t$related_info .= \"Banka hareketi silindi (ID: \" . $cariHareket->ch_bankaID . \"), \";\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Çek işlemleri (ch_turu = 8: Çek Giriş, 9: Çek Çıkış)\r\n+\t\t\telse if (($cariHareket->ch_turu == 8 || $cariHareket->ch_turu == 9) && !empty($cariHareket->ch_cekID)) {\r\n+\t\t\t\terror_log(\"ÇEK SİLME İŞLEMİ - Çek ID: \" . $cariHareket->ch_cekID);\r\n+\t\t\t\t\r\n+\t\t\t\t$this->db->where('cek_id', $cariHareket->ch_cekID);\r\n+\t\t\t\t$cek_deleted = $this->db->delete('cek');\r\n+\t\t\t\t\r\n+\t\t\t\tif ($cek_deleted) {\r\n+\t\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t\t$related_info .= \"Çek silindi (ID: \" . $cariHareket->ch_cekID . \"), \";\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Senet işlemleri (ch_turu = 10: Senet Giriş, 11: Senet Çıkış)\r\n+\t\t\telse if (($cariHareket->ch_turu == 10 || $cariHareket->ch_turu == 11) && !empty($cariHareket->ch_senetID)) {\r\n+\t\t\t\terror_log(\"SENET SİLME İŞLEMİ - Senet ID: \" . $cariHareket->ch_senetID);\r\n+\t\t\t\t\r\n+\t\t\t\t$this->db->where('senet_id', $cariHareket->ch_senetID);\r\n+\t\t\t\t$senet_deleted = $this->db->delete('senet');\r\n+\t\t\t\t\r\n+\t\t\t\tif ($senet_deleted) {\r\n+\t\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t\t$related_info .= \"Senet silindi (ID: \" . $cariHareket->ch_senetID . \"), \";\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Ana cari hareket kaydını sil\r\n+\t\t\t$this->db->where('ch_id', $ch_id);\r\n+\t\t\t$deleted = $this->db->delete('carihareketleri');\r\n+\t\t\t\r\n+\t\t\tif ($deleted && $this->db->affected_rows() > 0) {\r\n+\t\t\t\t$message = 'Tahsilat kaydı başarıyla silindi';\r\n+\t\t\t\tif ($deleted_related && !empty($related_info)) {\r\n+\t\t\t\t\t$message .= ' (' . rtrim($related_info, ', ') . ')';\r\n+\t\t\t\t}\r\n+\t\t\t\terror_log(\"BAŞARILI SİLME: \" . $message);\r\n+\t\t\t\techo json_encode(['success' => true, 'message' => $message]);\r\n+\t\t\t} else {\r\n+\t\t\t\terror_log(\"SİLME BAŞARISIZ: Kayıt bulunamadı veya silinemedi\");\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt bulunamadı veya silinemedi']);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1756197026956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2309,9 +2309,9 @@\n \t\t\t\tNULL as evrak_gorselleri,\r\n \t\t\t\tNULL as sozlesme_gorselleri,\r\n \t\t\t\tNULL as tahsilat_gorselleri,\r\n \t\t\t\t\r\n-\t\t\t\t-- Tahsilat tutarını carihareketleri tablosundan al (ch_alacak toplamı)\r\n+\t\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap (banka, çek, kasa, senet)\r\n \t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n \t\t\t\t\r\n \t\t\t\t-- Aktivasyon durumu (en yeni aktivasyondan)\r\n \t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_adi, 'Tanımlanmamış') \r\n@@ -2382,15 +2382,24 @@\n \t\t\t\tk.kullanici_id\r\n \t\t\t\t\r\n \t\t\tFROM cari c\r\n \t\t\t\r\n-\t\t\t-- Carihareketleri tablosundan tahsilat toplamını al\r\n+\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap\r\n \t\t\tLEFT JOIN (\r\n-\t\t\t\tSELECT ch_cariID, SUM(ch_alacak) as toplam_tahsilat \r\n-\t\t\t\tFROM carihareketleri \r\n-\t\t\t\tWHERE ch_alacak IS NOT NULL AND ch_alacak > 0\r\n-\t\t\t\tGROUP BY ch_cariID\r\n-\t\t\t) ch_toplam ON c.cari_id = ch_toplam.ch_cariID\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tc2.cari_id,\r\n+\t\t\t\t\t(\r\n+\t\t\t\t\t\t-- Banka/Pos tahsilatları\r\n+\t\t\t\t\t\tCOALESCE((SELECT SUM(bh.bh_giris) FROM bankahareketleri bh WHERE bh.bh_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t-- Çek tahsilatları  \r\n+\t\t\t\t\t\tCOALESCE((SELECT SUM(ck.cek_tutar) FROM cek ck WHERE ck.cek_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t-- Kasa/Nakit tahsilatları\r\n+\t\t\t\t\t\tCOALESCE((SELECT SUM(kh.kh_giris) FROM kasahareketleri kh WHERE kh.kh_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t-- Senet tahsilatları\r\n+\t\t\t\t\t\tCOALESCE((SELECT SUM(s.senet_tutar) FROM senet s WHERE s.senet_cariID = c2.cari_id), 0)\r\n+\t\t\t\t\t) as toplam_tahsilat\r\n+\t\t\t\tFROM cari c2\r\n+\t\t\t) ch_toplam ON c.cari_id = ch_toplam.cari_id\r\n \t\t\t\r\n \t\t\t-- Banka görselleri sayısını al\r\n \t\t\tLEFT JOIN (\r\n \t\t\t\tSELECT \r\n@@ -2512,68 +2521,82 @@\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n-\t\t\t// Tahsilat detaylarını getir (carihareketleri tablosundan ch_alacak > 0 olanlar)\r\n-\t\t\t// muhasebe_tahsilat_durum tablosu ile JOIN yaparak durumu da al\r\n+\t\t\t// Tahsilat detaylarını farklı tablolardan getir\r\n \t\t\t$query = \"\r\n+\t\t\t\t-- Banka/Pos tahsilatları\r\n \t\t\t\tSELECT \r\n-\t\t\t\t\tch.ch_id,\r\n-\t\t\t\t\tch.ch_tarih,\r\n-\t\t\t\t\tch.ch_belgeNumarasi,\r\n-\t\t\t\t\tch.ch_alacak,\r\n-\t\t\t\t\tch.ch_aciklama,\r\n-\t\t\t\t\tch.ch_turu,\r\n-\t\t\t\t\tch.ch_kasaID,\r\n-\t\t\t\t\tch.ch_cekID,\r\n-\t\t\t\t\tch.ch_senetID,\r\n-\t\t\t\t\tch.ch_bankaID,\r\n-\t\t\t\t\tCASE \r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 1 THEN 'Açılış'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 2 THEN 'Satış Faturası'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 3 THEN 'Alış Faturası'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 4 THEN 'Kasa Giriş'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 5 THEN 'Kasa Çıkış'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 6 THEN 'Banka Giriş'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 7 THEN 'Banka Çıkış'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 8 THEN 'Çek Giriş'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 9 THEN 'Çek Çıkış'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 10 THEN 'Senet Giriş'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 11 THEN 'Senet Çıkış'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 12 THEN 'Kredi Kartı'\r\n-\t\t\t\t\t\tWHEN ch.ch_turu = 13 THEN 'Havale/EFT'\r\n-\t\t\t\t\t\tELSE CONCAT('Tür-', ch.ch_turu)\r\n-\t\t\t\t\tEND as tahsilat_tipi,\r\n-\t\t\t\t\tmtd.id as tahsilat_durum_id,\r\n-\t\t\t\t\tmtd.durum as durum_kodu,\r\n-\t\t\t\t\tmtd.tahsilat_tipi as muhasebe_tahsilat_tipi,\r\n-\t\t\t\t\tCASE \r\n-\t\t\t\t\t\tWHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n-\t\t\t\t\t\tWHEN mtd.durum = 2 THEN 'Onaylandı'\r\n-\t\t\t\t\t\tWHEN mtd.durum = 3 THEN 'Reddedildi'\r\n-\t\t\t\t\t\tWHEN mtd.durum IS NULL THEN NULL\r\n-\t\t\t\t\t\tELSE 'Bilinmiyor'\r\n-\t\t\t\t\tEND as tahsilat_durum,\r\n-\t\t\t\t\tmtd.aciklama as durum_aciklama,\r\n-\t\t\t\t\tmtd.olusturma_tarihi as durum_tarihi\r\n-\t\t\t\tFROM carihareketleri ch\r\n-\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON (\r\n-\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND ch.ch_kasaID IS NOT NULL AND mtd.kayit_id = ch.ch_kasaID)\r\n-\t\t\t\t\tOR (mtd.tahsilat_tipi = 2 AND ch.ch_cekID IS NOT NULL AND mtd.kayit_id = ch.ch_cekID)  \r\n-\t\t\t\t\tOR (mtd.tahsilat_tipi = 3 AND ch.ch_senetID IS NOT NULL AND mtd.kayit_id = ch.ch_senetID)\r\n-\t\t\t\t\tOR (mtd.tahsilat_tipi = 4 AND ch.ch_bankaID IS NOT NULL AND mtd.kayit_id = ch.ch_bankaID)\r\n-\t\t\t\t)\r\n-\t\t\t\tWHERE ch.ch_cariID = ? \r\n-\t\t\t\t  AND ch.ch_alacak IS NOT NULL \r\n-\t\t\t\t  AND ch.ch_alacak > 0\r\n-\t\t\t\tORDER BY ch.ch_tarih DESC, ch.ch_id DESC\r\n+\t\t\t\t\tCONCAT('bh_', bh.bh_id) as unique_id,\r\n+\t\t\t\t\tbh.bh_id as source_id,\r\n+\t\t\t\t\t'Banka/Pos' as tahsilat_tipi,\r\n+\t\t\t\t\tbh.bh_tarih as tarih,\r\n+\t\t\t\t\tbh.bh_belgeNumarasi as belge_no,\r\n+\t\t\t\t\tbh.bh_giris as tutar,\r\n+\t\t\t\t\tbh.bh_aciklama as aciklama,\r\n+\t\t\t\t\tb.banka_adi as detay,\r\n+\t\t\t\t\t'1' as tip_kod\r\n+\t\t\t\tFROM bankahareketleri bh\r\n+\t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n+\t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n+\t\t\t\t\r\n+\t\t\t\tUNION ALL\r\n+\t\t\t\t\r\n+\t\t\t\t-- Çek tahsilatları  \r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tCONCAT('cek_', c.cek_id) as unique_id,\r\n+\t\t\t\t\tc.cek_id as source_id,\r\n+\t\t\t\t\t'Çek' as tahsilat_tipi,\r\n+\t\t\t\t\tc.cek_vade_tarihi as tarih,\r\n+\t\t\t\t\tc.cek_numara as belge_no,\r\n+\t\t\t\t\tc.cek_tutar as tutar,\r\n+\t\t\t\t\tc.cek_aciklama as aciklama,\r\n+\t\t\t\t\tCONCAT(c.cek_banka_adi, ' - ', c.cek_numara) as detay,\r\n+\t\t\t\t\t'2' as tip_kod\r\n+\t\t\t\tFROM cek c\r\n+\t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n+\t\t\t\t\r\n+\t\t\t\tUNION ALL\r\n+\t\t\t\t\r\n+\t\t\t\t-- Kasa/Nakit tahsilatları\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tCONCAT('kh_', kh.kh_id) as unique_id,\r\n+\t\t\t\t\tkh.kh_id as source_id,\r\n+\t\t\t\t\t'Kasa/Nakit' as tahsilat_tipi,\r\n+\t\t\t\t\tkh.kh_tarih as tarih,\r\n+\t\t\t\t\tkh.kh_belgeNumarasi as belge_no,\r\n+\t\t\t\t\tkh.kh_giris as tutar,\r\n+\t\t\t\t\tkh.kh_aciklama as aciklama,\r\n+\t\t\t\t\tk.kasa_adi as detay,\r\n+\t\t\t\t\t'3' as tip_kod\r\n+\t\t\t\tFROM kasahareketleri kh\r\n+\t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n+\t\t\t\tWHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n+\t\t\t\t\r\n+\t\t\t\tUNION ALL\r\n+\t\t\t\t\r\n+\t\t\t\t-- Senet tahsilatları\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tCONCAT('s_', s.senet_id) as unique_id,\r\n+\t\t\t\t\ts.senet_id as source_id,\r\n+\t\t\t\t\t'Senet' as tahsilat_tipi,\r\n+\t\t\t\t\ts.senet_vade_tarihi as tarih,\r\n+\t\t\t\t\ts.senet_numara as belge_no,\r\n+\t\t\t\t\ts.senet_tutar as tutar,\r\n+\t\t\t\t\ts.senet_aciklama as aciklama,\r\n+\t\t\t\t\tCONCAT('Senet No: ', s.senet_numara) as detay,\r\n+\t\t\t\t\t'4' as tip_kod\r\n+\t\t\t\tFROM senet s\r\n+\t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n+\t\t\t\t\r\n+\t\t\t\tORDER BY tarih DESC\r\n \t\t\t\";\r\n \t\t\t\r\n-\t\t\t$result = $this->db->query($query, [$cari_id])->result();\r\n+\t\t\t$result = $this->db->query($query, [$cari_id, $cari_id, $cari_id, $cari_id])->result();\r\n \t\t\t\r\n \t\t\t// Tarihleri formatla\r\n \t\t\tforeach ($result as $row) {\r\n-\t\t\t\t$row->ch_tarih = date('d.m.Y', strtotime($row->ch_tarih));\r\n+\t\t\t\t$row->tarih = date('d.m.Y', strtotime($row->tarih));\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\techo json_encode([\r\n \t\t\t\t'success' => true,\r\n@@ -2676,15 +2699,24 @@\n \t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n \t\t\t\t\t\r\n \t\t\t\tFROM cari c\r\n \t\t\t\t\r\n-\t\t\t\t-- Carihareketleri tablosundan tahsilat toplamını al\r\n+\t\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap\r\n \t\t\t\tLEFT JOIN (\r\n-\t\t\t\t\tSELECT ch_cariID, SUM(ch_alacak) as toplam_tahsilat \r\n-\t\t\t\t\tFROM carihareketleri \r\n-\t\t\t\t\tWHERE ch_alacak IS NOT NULL AND ch_alacak > 0\r\n-\t\t\t\t\tGROUP BY ch_cariID\r\n-\t\t\t\t) ch_toplam ON c.cari_id = ch_toplam.ch_cariID\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tc2.cari_id,\r\n+\t\t\t\t\t\t(\r\n+\t\t\t\t\t\t\t-- Banka/Pos tahsilatları\r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(bh.bh_giris) FROM bankahareketleri bh WHERE bh.bh_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t\t-- Çek tahsilatları  \r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(ck.cek_tutar) FROM cek ck WHERE ck.cek_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t\t-- Kasa/Nakit tahsilatları\r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(kh.kh_giris) FROM kasahareketleri kh WHERE kh.kh_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t\t-- Senet tahsilatları\r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(s.senet_tutar) FROM senet s WHERE s.senet_cariID = c2.cari_id), 0)\r\n+\t\t\t\t\t\t) as toplam_tahsilat\r\n+\t\t\t\t\tFROM cari c2\r\n+\t\t\t\t) ch_toplam ON c.cari_id = ch_toplam.cari_id\r\n \t\t\t\t\r\n \t\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\t\r\n \t\t\t\tWHERE c.cari_durum = 1\r\n"
                },
                {
                    "date": 1756198703367,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2532,9 +2532,9 @@\n \t\t\t\t\tbh.bh_tarih as tarih,\r\n \t\t\t\t\tbh.bh_belgeNumarasi as belge_no,\r\n \t\t\t\t\tbh.bh_giris as tutar,\r\n \t\t\t\t\tbh.bh_aciklama as aciklama,\r\n-\t\t\t\t\tb.banka_adi as detay,\r\n+\t\t\t\t\tb.banka_bankaAd as detay,\r\n \t\t\t\t\t'1' as tip_kod\r\n \t\t\t\tFROM bankahareketleri bh\r\n \t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n \t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n@@ -2545,13 +2545,13 @@\n \t\t\t\tSELECT \r\n \t\t\t\t\tCONCAT('cek_', c.cek_id) as unique_id,\r\n \t\t\t\t\tc.cek_id as source_id,\r\n \t\t\t\t\t'Çek' as tahsilat_tipi,\r\n-\t\t\t\t\tc.cek_vade_tarihi as tarih,\r\n-\t\t\t\t\tc.cek_numara as belge_no,\r\n+\t\t\t\t\tc.cek_vadeTarih as tarih,\r\n+\t\t\t\t\tc.cek_portfoyNo as belge_no,\r\n \t\t\t\t\tc.cek_tutar as tutar,\r\n-\t\t\t\t\tc.cek_aciklama as aciklama,\r\n-\t\t\t\t\tCONCAT(c.cek_banka_adi, ' - ', c.cek_numara) as detay,\r\n+\t\t\t\t\tc.cek_notAciklama as aciklama,\r\n+\t\t\t\t\tCONCAT('Çek No: ', c.cek_portfoyNo) as detay,\r\n \t\t\t\t\t'2' as tip_kod\r\n \t\t\t\tFROM cek c\r\n \t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n \t\t\t\t\r\n@@ -2578,13 +2578,13 @@\n \t\t\t\tSELECT \r\n \t\t\t\t\tCONCAT('s_', s.senet_id) as unique_id,\r\n \t\t\t\t\ts.senet_id as source_id,\r\n \t\t\t\t\t'Senet' as tahsilat_tipi,\r\n-\t\t\t\t\ts.senet_vade_tarihi as tarih,\r\n-\t\t\t\t\ts.senet_numara as belge_no,\r\n+\t\t\t\t\ts.senet_vadeTarih as tarih,\r\n+\t\t\t\t\ts.senet_portfoyNo as belge_no,\r\n \t\t\t\t\ts.senet_tutar as tutar,\r\n-\t\t\t\t\ts.senet_aciklama as aciklama,\r\n-\t\t\t\t\tCONCAT('Senet No: ', s.senet_numara) as detay,\r\n+\t\t\t\t\ts.senet_notAciklama as aciklama,\r\n+\t\t\t\t\tCONCAT('Senet No: ', s.senet_portfoyNo) as detay,\r\n \t\t\t\t\t'4' as tip_kod\r\n \t\t\t\tFROM senet s\r\n \t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n \t\t\t\t\r\n"
                },
                {
                    "date": 1756204617157,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -833,9 +833,9 @@\n \t\t\t\t   kh.kh_aciklama as kasa_aciklama,\r\n \r\n \t\t\t\t   k.kasa_adi as kasa_adi,\r\n \r\n-\t\t\t\t   k.kasa_kodu as kasa_kodu,\r\n+\t\t\t\t   $kasa_kodu as kasa_kodu,\r\n \r\n \t\t\t\t   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n \r\n \t\t\t\t   CASE \r\n@@ -2521,9 +2521,9 @@\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n-\t\t\t// Tahsilat detaylarını farklı tablolardan getir\r\n+\t\t\t// Tahsilat detaylarını farklı tablolardan getir - cari hareket ID'si ile birlikte\r\n \t\t\t$query = \"\r\n \t\t\t\t-- Banka/Pos tahsilatları\r\n \t\t\t\tSELECT \r\n \t\t\t\t\tCONCAT('bh_', bh.bh_id) as unique_id,\r\n@@ -2533,11 +2533,13 @@\n \t\t\t\t\tbh.bh_belgeNumarasi as belge_no,\r\n \t\t\t\t\tbh.bh_giris as tutar,\r\n \t\t\t\t\tbh.bh_aciklama as aciklama,\r\n \t\t\t\t\tb.banka_bankaAd as detay,\r\n-\t\t\t\t\t'1' as tip_kod\r\n+\t\t\t\t\t'1' as tip_kod,\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id\r\n \t\t\t\tFROM bankahareketleri bh\r\n \t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n+\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_bankaID = bh.bh_id AND ch.ch_cariID = bh.bh_cariID\r\n \t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n \t\t\t\t\r\n \t\t\t\tUNION ALL\r\n \t\t\t\t\r\n@@ -2550,10 +2552,12 @@\n \t\t\t\t\tc.cek_portfoyNo as belge_no,\r\n \t\t\t\t\tc.cek_tutar as tutar,\r\n \t\t\t\t\tc.cek_notAciklama as aciklama,\r\n \t\t\t\t\tCONCAT('Çek No: ', c.cek_portfoyNo) as detay,\r\n-\t\t\t\t\t'2' as tip_kod\r\n+\t\t\t\t\t'2' as tip_kod,\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id\r\n \t\t\t\tFROM cek c\r\n+\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_cekID = c.cek_id AND ch.ch_cariID = c.cek_cariID\r\n \t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n \t\t\t\t\r\n \t\t\t\tUNION ALL\r\n \t\t\t\t\r\n@@ -2566,11 +2570,13 @@\n \t\t\t\t\tkh.kh_belgeNumarasi as belge_no,\r\n \t\t\t\t\tkh.kh_giris as tutar,\r\n \t\t\t\t\tkh.kh_aciklama as aciklama,\r\n \t\t\t\t\tk.kasa_adi as detay,\r\n-\t\t\t\t\t'3' as tip_kod\r\n+\t\t\t\t\t'3' as tip_kod,\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id\r\n \t\t\t\tFROM kasahareketleri kh\r\n \t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n+\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_kasaID = kh.kh_id AND ch.ch_cariID = kh.kh_cariID\r\n \t\t\t\tWHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n \t\t\t\t\r\n \t\t\t\tUNION ALL\r\n \t\t\t\t\r\n@@ -2583,10 +2589,12 @@\n \t\t\t\t\ts.senet_portfoyNo as belge_no,\r\n \t\t\t\t\ts.senet_tutar as tutar,\r\n \t\t\t\t\ts.senet_notAciklama as aciklama,\r\n \t\t\t\t\tCONCAT('Senet No: ', s.senet_portfoyNo) as detay,\r\n-\t\t\t\t\t'4' as tip_kod\r\n+\t\t\t\t\t'4' as tip_kod,\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id\r\n \t\t\t\tFROM senet s\r\n+\t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_senetID = s.senet_id AND ch.ch_cariID = s.senet_cariID\r\n \t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n \t\t\t\t\r\n \t\t\t\tORDER BY tarih DESC\r\n \t\t\t\";\r\n@@ -3045,148 +3053,251 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n-\t * Tahsilat kaydı sil - AJAX\r\n-\t * Cari hareketleri ile birlikte ilgili kasa, çek, senet, banka hareketlerini de siler\r\n+\t * Tahsilat kaydını sil \r\n+\t * Hem eski sistem (ch_id) hem yeni sistem (unique_id, tip_kod, source_id) parametrelerini destekler\r\n \t */\r\n \tpublic function tahsilatSil()\r\n \t{\r\n-\t\t// AJAX isteği kontrolü - Geçici olarak devre dışı\r\n-\t\t// if (!$this->input->is_ajax_request()) {\r\n-\t\t//\tshow_404();\r\n-\t\t//\treturn;\r\n-\t\t// }\r\n+\t\t// Yeni sistem parametrelerini kontrol et\r\n+\t\t$unique_id = $this->input->post('unique_id');\r\n+\t\t$tip_kod = $this->input->post('tip_kod');\r\n+\t\t$source_id = $this->input->post('source_id');\r\n+\t\t$tahsilat_tipi = $this->input->post('tahsilat_tipi');\r\n \t\t\r\n+\t\t// Eski sistem parametresi\r\n \t\t$ch_id = $this->input->post('ch_id');\r\n-\t\tif (!$ch_id) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat ID gerekli']);\r\n+\t\t\r\n+\t\t// Yeni sistem kullanılıyorsa\r\n+\t\tif ($unique_id && $tip_kod && $source_id) {\r\n+\t\t\t$this->yeniTahsilatSil($unique_id, $tip_kod, $source_id, $tahsilat_tipi);\r\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n+\t\t// Eski sistem kullanılıyorsa\r\n+\t\tif ($ch_id) {\r\n+\t\t\t$this->eskiTahsilatSil($ch_id);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\techo json_encode(['success' => false, 'message' => 'Gerekli parametreler eksik']);\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Yeni tahsilat silme sistemi\r\n+\t */\r\n+\tprivate function yeniTahsilatSil($unique_id, $tip_kod, $source_id, $tahsilat_tipi)\r\n+\t{\r\n \t\ttry {\r\n-\t\t\t// Debug için log ekle\r\n-\t\t\terror_log(\"TAHSILAT SİL - CH_ID: \" . $ch_id);\r\n+\t\t\terror_log(\"YENİ TAHSILAT SİL - unique_id: $unique_id, tip_kod: $tip_kod, source_id: $source_id\");\r\n \t\t\t\r\n+\t\t\t$deleted = false;\r\n+\t\t\t$message = '';\r\n+\t\t\t\r\n+\t\t\tswitch($tip_kod) {\r\n+\t\t\t\tcase '1': // Banka/Pos\r\n+\t\t\t\t\t$this->db->where('bh_id', $source_id);\r\n+\t\t\t\t\t$deleted = $this->db->delete('bankahareketleri');\r\n+\t\t\t\t\t$message = 'Banka/Pos tahsilat kaydı silindi';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '2': // Çek\r\n+\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n+\t\t\t\t\t$deleted = $this->db->delete('cek');\r\n+\t\t\t\t\t$message = 'Çek tahsilat kaydı silindi';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '3': // Kasa/Nakit\r\n+\t\t\t\t\t$this->db->where('kh_id', $source_id);\r\n+\t\t\t\t\t$deleted = $this->db->delete('kasahareketleri');\r\n+\t\t\t\t\t$message = 'Kasa/Nakit tahsilat kaydı silindi';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '4': // Senet\r\n+\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n+\t\t\t\t\t$deleted = $this->db->delete('senet');\r\n+\t\t\t\t\t$message = 'Senet tahsilat kaydı silindi';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Bilinmeyen tahsilat tipi: ' . $tip_kod]);\r\n+\t\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif ($deleted) {\r\n+\t\t\t\terror_log(\"BAŞARILI SİLME: \" . $message);\r\n+\t\t\t\techo json_encode(['success' => true, 'message' => $message]);\r\n+\t\t\t} else {\r\n+\t\t\t\terror_log(\"SİLME BAŞARISIZ: Kayıt bulunamadı veya silinemedi\");\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt bulunamadı veya silinemedi']);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\terror_log(\"TAHSILAT SİLME HATASI: \" . $e->getMessage());\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Eski tahsilat silme sistemi  \r\n+\t */\r\n+\t/**\r\n+\t * Eski tahsilat silme sistemi (ch_id parametresi ile)\r\n+\t */\r\n+\tprivate function eskiTahsilatSil($ch_id)\r\n+\t{\r\n+\t\tif (!$ch_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Cari hareket ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\ttry {\r\n \t\t\t// Önce cari hareket kaydını al\r\n \t\t\t$this->db->where('ch_id', $ch_id);\r\n \t\t\t$cariHareket = $this->db->get('carihareketleri')->row();\r\n-\t\t\t\r\n+\r\n \t\t\tif (!$cariHareket) {\r\n \t\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat kaydı bulunamadı']);\r\n \t\t\t\treturn;\r\n \t\t\t}\r\n+\r\n+\t\t\terror_log(\"ESKİ TAHSILAT SİL - CH_ID: \" . $ch_id . \" Turu: \" . $cariHareket->ch_turu);\r\n \t\t\t\r\n-\t\t\t// Debug için cari hareket bilgilerini logla\r\n-\t\t\terror_log(\"CARİ HAREKET: \" . json_encode($cariHareket));\r\n-\t\t\t\r\n-\t\t\t// Tahsilat türüne göre ilgili tablodan da sil\r\n \t\t\t$deleted_related = false;\r\n-\t\t\t$related_info = '';\r\n-\t\t\t\r\n-\t\t\t// Kasa işlemleri (ch_turu = 4: Kasa Giriş, 5: Kasa Çıkış)\r\n+\t\t\t$message = 'Tahsilat kaydı silindi';\r\n+\r\n+\t\t\t// İlgili tablodan da kayıtları sil\r\n \t\t\tif (($cariHareket->ch_turu == 4 || $cariHareket->ch_turu == 5) && !empty($cariHareket->ch_kasaID)) {\r\n-\t\t\t\terror_log(\"KASA SİLME İŞLEMİ - Kasa ID: \" . $cariHareket->ch_kasaID . \", Cari ID: \" . $cariHareket->ch_cariID);\r\n-\t\t\t\t\r\n-\t\t\t\t// Alternatif 1: kh_id ile sil\r\n+\t\t\t\t// Kasa hareketi sil\r\n \t\t\t\t$this->db->where('kh_id', $cariHareket->ch_kasaID);\r\n-\t\t\t\t$kasaHareket = $this->db->get('kasaHareketleri')->row();\r\n-\t\t\t\t\r\n-\t\t\t\tif ($kasaHareket) {\r\n-\t\t\t\t\terror_log(\"KASA HAREKET BULUNDU (kh_id ile): \" . json_encode($kasaHareket));\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t$this->db->where('kh_id', $cariHareket->ch_kasaID);\r\n-\t\t\t\t\t$kasa_deleted = $this->db->delete('kasaHareketleri');\r\n-\t\t\t\t\t\r\n-\t\t\t\t\tif ($kasa_deleted) {\r\n-\t\t\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t\t\t$related_info .= \"Kasa hareketi silindi (kh_id: \" . $cariHareket->ch_kasaID . \"), \";\r\n-\t\t\t\t\t}\r\n-\t\t\t\t} else {\r\n-\t\t\t\t\t// Alternatif 2: cari ID ve tarih/tutar eşleşmesi ile sil\r\n-\t\t\t\t\terror_log(\"kh_id ile bulunamadı, cari ID ile deneniyor...\");\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t$this->db->where('kh_cariID', $cariHareket->ch_cariID);\r\n-\t\t\t\t\t$this->db->where('kh_tarih', $cariHareket->ch_tarih);\r\n-\t\t\t\t\t$this->db->where('kh_giris', $cariHareket->ch_alacak);\r\n-\t\t\t\t\t$kasaHareketCari = $this->db->get('kasaHareketleri')->row();\r\n-\t\t\t\t\t\r\n-\t\t\t\t\tif ($kasaHareketCari) {\r\n-\t\t\t\t\t\terror_log(\"KASA HAREKET BULUNDU (cari ID ile): \" . json_encode($kasaHareketCari));\r\n-\t\t\t\t\t\t\r\n-\t\t\t\t\t\t$this->db->where('kh_cariID', $cariHareket->ch_cariID);\r\n-\t\t\t\t\t\t$this->db->where('kh_tarih', $cariHareket->ch_tarih);\r\n-\t\t\t\t\t\t$this->db->where('kh_giris', $cariHareket->ch_alacak);\r\n-\t\t\t\t\t\t$kasa_deleted = $this->db->delete('kasaHareketleri');\r\n-\t\t\t\t\t\t\r\n-\t\t\t\t\t\tif ($kasa_deleted) {\r\n-\t\t\t\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t\t\t\t$related_info .= \"Kasa hareketi silindi (cari eşleşmesi ile), \";\r\n-\t\t\t\t\t\t}\r\n-\t\t\t\t\t} else {\r\n-\t\t\t\t\t\terror_log(\"KASA HAREKET HİÇBİR YÖNTEMLE BULUNAMADI\");\r\n-\t\t\t\t\t}\r\n-\t\t\t\t}\r\n+\t\t\t\t$this->db->delete('kasaHareketleri');\r\n+\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t$message = 'Kasa tahsilat kaydı silindi';\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Banka işlemleri (ch_turu = 6: Banka Giriş, 7: Banka Çıkış)\r\n \t\t\telse if (($cariHareket->ch_turu == 6 || $cariHareket->ch_turu == 7) && !empty($cariHareket->ch_bankaID)) {\r\n-\t\t\t\terror_log(\"BANKA SİLME İŞLEMİ - Banka ID: \" . $cariHareket->ch_bankaID);\r\n-\t\t\t\t\r\n-\t\t\t\t// Banka hareketlerini sil\r\n+\t\t\t\t// Banka hareketi sil\r\n \t\t\t\t$this->db->where('bh_id', $cariHareket->ch_bankaID);\r\n-\t\t\t\t$banka_deleted = $this->db->delete('bankaHareketleri');\r\n-\t\t\t\t\r\n-\t\t\t\tif ($banka_deleted) {\r\n-\t\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t\t$related_info .= \"Banka hareketi silindi (ID: \" . $cariHareket->ch_bankaID . \"), \";\r\n-\t\t\t\t}\r\n+\t\t\t\t$this->db->delete('bankaHareketleri');\r\n+\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t$message = 'Banka tahsilat kaydı silindi';\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Çek işlemleri (ch_turu = 8: Çek Giriş, 9: Çek Çıkış)\r\n \t\t\telse if (($cariHareket->ch_turu == 8 || $cariHareket->ch_turu == 9) && !empty($cariHareket->ch_cekID)) {\r\n-\t\t\t\terror_log(\"ÇEK SİLME İŞLEMİ - Çek ID: \" . $cariHareket->ch_cekID);\r\n-\t\t\t\t\r\n+\t\t\t\t// Çek sil\r\n \t\t\t\t$this->db->where('cek_id', $cariHareket->ch_cekID);\r\n-\t\t\t\t$cek_deleted = $this->db->delete('cek');\r\n-\t\t\t\t\r\n-\t\t\t\tif ($cek_deleted) {\r\n-\t\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t\t$related_info .= \"Çek silindi (ID: \" . $cariHareket->ch_cekID . \"), \";\r\n-\t\t\t\t}\r\n+\t\t\t\t$this->db->delete('cek');\r\n+\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t$message = 'Çek tahsilat kaydı silindi';\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Senet işlemleri (ch_turu = 10: Senet Giriş, 11: Senet Çıkış)\r\n \t\t\telse if (($cariHareket->ch_turu == 10 || $cariHareket->ch_turu == 11) && !empty($cariHareket->ch_senetID)) {\r\n-\t\t\t\terror_log(\"SENET SİLME İŞLEMİ - Senet ID: \" . $cariHareket->ch_senetID);\r\n-\t\t\t\t\r\n+\t\t\t\t// Senet sil\r\n \t\t\t\t$this->db->where('senet_id', $cariHareket->ch_senetID);\r\n-\t\t\t\t$senet_deleted = $this->db->delete('senet');\r\n-\t\t\t\t\r\n-\t\t\t\tif ($senet_deleted) {\r\n-\t\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t\t$related_info .= \"Senet silindi (ID: \" . $cariHareket->ch_senetID . \"), \";\r\n-\t\t\t\t}\r\n+\t\t\t\t$this->db->delete('senet');\r\n+\t\t\t\t$deleted_related = true;\r\n+\t\t\t\t$message = 'Senet tahsilat kaydı silindi';\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Ana cari hareket kaydını sil\r\n+\r\n+\t\t\t// Cari hareket kaydını sil\r\n \t\t\t$this->db->where('ch_id', $ch_id);\r\n \t\t\t$deleted = $this->db->delete('carihareketleri');\r\n-\t\t\t\r\n-\t\t\tif ($deleted && $this->db->affected_rows() > 0) {\r\n-\t\t\t\t$message = 'Tahsilat kaydı başarıyla silindi';\r\n-\t\t\t\tif ($deleted_related && !empty($related_info)) {\r\n-\t\t\t\t\t$message .= ' (' . rtrim($related_info, ', ') . ')';\r\n-\t\t\t\t}\r\n+\r\n+\t\t\tif ($deleted) {\r\n \t\t\t\terror_log(\"BAŞARILI SİLME: \" . $message);\r\n \t\t\t\techo json_encode(['success' => true, 'message' => $message]);\r\n \t\t\t} else {\r\n-\t\t\t\terror_log(\"SİLME BAŞARISIZ: Kayıt bulunamadı veya silinemedi\");\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt bulunamadı veya silinemedi']);\r\n+\t\t\t\terror_log(\"CARİ HAREKET SİLEMEDİ\");\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Cari hareket kaydı silinemedi']);\r\n \t\t\t}\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\terror_log(\"ESKİ TAHSILAT SİLME HATASI: \" . $e->getMessage());\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Tahsilat tutarlarını güncelle\r\n+\t */\r\n+\tpublic function tahsilatTutarGuncelle()\r\n+\t{\r\n+\t\t$degisiklikler = $this->input->post('degisiklikler');\r\n+\t\t\r\n+\t\tif (!$degisiklikler || !is_array($degisiklikler)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Değişiklik verisi gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$this->db->trans_start();\r\n+\t\t\t$guncellenen_sayisi = 0;\r\n \t\t\t\r\n+\t\t\tforeach ($degisiklikler as $degisiklik) {\r\n+\t\t\t\t$tip_kod = $degisiklik['tip_kod'];\r\n+\t\t\t\t$source_id = $degisiklik['source_id'];\r\n+\t\t\t\t$yeni_tutar = $degisiklik['yeni_tutar'];\r\n+\t\t\t\t$ch_id = isset($degisiklik['ch_id']) ? $degisiklik['ch_id'] : null;\r\n+\t\t\t\t\r\n+\t\t\t\terror_log(\"TUTAR GÜNCELLE - Tip: $tip_kod, ID: $source_id, Yeni Tutar: $yeni_tutar\");\r\n+\t\t\t\t\r\n+\t\t\t\t$updated = false;\r\n+\t\t\t\t\r\n+\t\t\t\t// İlgili tabloda tutarı güncelle\r\n+\t\t\t\tswitch($tip_kod) {\r\n+\t\t\t\t\tcase '1': // Banka/Pos\r\n+\t\t\t\t\t\t$this->db->where('bh_id', $source_id);\r\n+\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_giris' => $yeni_tutar]);\r\n+\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tcase '2': // Çek\r\n+\t\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n+\t\t\t\t\t\t$this->db->update('cek', ['cek_tutar' => $yeni_tutar]);\r\n+\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tcase '3': // Kasa/Nakit\r\n+\t\t\t\t\t\t$this->db->where('kh_id', $source_id);\r\n+\t\t\t\t\t\t$this->db->update('kasahareketleri', ['kh_giris' => $yeni_tutar]);\r\n+\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tcase '4': // Senet\r\n+\t\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n+\t\t\t\t\t\t$this->db->update('senet', ['senet_tutar' => $yeni_tutar]);\r\n+\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t// Cari hareketleri tablosunu da güncelle\r\n+\t\t\t\tif ($updated && $ch_id) {\r\n+\t\t\t\t\t$this->db->where('ch_id', $ch_id);\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Cari hareketleri için doğru alanı güncelle\r\n+\t\t\t\t\tif ($tip_kod == '1' || $tip_kod == '3') { // Banka ve Kasa giriş\r\n+\t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n+\t\t\t\t\t} else if ($tip_kod == '2' || $tip_kod == '4') { // Çek ve Senet\r\n+\t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\tif ($updated) {\r\n+\t\t\t\t\t$guncellenen_sayisi++;\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$this->db->trans_complete();\r\n+\t\t\t\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı işlemi başarısız oldu']);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => true, \r\n+\t\t\t\t\t'message' => \"$guncellenen_sayisi adet tahsilat tutarı başarıyla güncellendi\"\r\n+\t\t\t\t]);\r\n+\t\t\t}\r\n+\t\t\t\r\n \t\t} catch (Exception $e) {\r\n+\t\t\terror_log(\"TUTAR GÜNCELLEME HATASI: \" . $e->getMessage());\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n-\t\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1756204807094,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -833,9 +833,9 @@\n \t\t\t\t   kh.kh_aciklama as kasa_aciklama,\r\n \r\n \t\t\t\t   k.kasa_adi as kasa_adi,\r\n \r\n-\t\t\t\t   $kasa_kodu as kasa_kodu,\r\n+\t\t\t\t   k.kasa_kodu as kasa_kodu,\r\n \r\n \t\t\t\t   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n \r\n \t\t\t\t   CASE \r\n"
                },
                {
                    "date": 1756207318832,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3278,9 +3278,42 @@\n \t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n \t\t\t\t\t}\r\n \t\t\t\t}\r\n \t\t\t\t\r\n+\t\t\t\t// Muhasebe tahsilat durum tablosunu da güncelle\r\n \t\t\t\tif ($updated) {\r\n+\t\t\t\t\t// muhasebe_tahsilat_durum tablosunda ilgili kayıt var mı kontrol et\r\n+\t\t\t\t\t$this->db->where('tahsilat_tipi', $tip_kod);\r\n+\t\t\t\t\t$this->db->where('kayit_id', $source_id);\r\n+\t\t\t\t\t$muhasebe_kayit = $this->db->get('muhasebe_tahsilat_durum')->row();\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tif ($muhasebe_kayit) {\r\n+\t\t\t\t\t\t// Kayıt mevcutsa, tutar değişikliği için açıklama alanını güncelle\r\n+\t\t\t\t\t\t$tarih = date('Y-m-d H:i:s');\r\n+\t\t\t\t\t\t$aciklama = \"Tutar güncellendi ($tarih)\";\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t$this->db->where('id', $muhasebe_kayit->id);\r\n+\t\t\t\t\t\t$this->db->update('muhasebe_tahsilat_durum', [\r\n+\t\t\t\t\t\t\t'aciklama' => $aciklama\r\n+\t\t\t\t\t\t]);\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\terror_log(\"MUHASEBE TAHSILAT DURUM güncellendi - ID: {$muhasebe_kayit->id}, Tip: $tip_kod, Source ID: $source_id\");\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t// Kayıt yoksa yeni kayıt oluştur\r\n+\t\t\t\t\t\t$data = array(\r\n+\t\t\t\t\t\t\t'tahsilat_tipi' => $tip_kod,\r\n+\t\t\t\t\t\t\t'kayit_id' => $source_id,\r\n+\t\t\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n+\t\t\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n+\t\t\t\t\t\t\t'aciklama' => 'Tam Ana Rapor tahsilat modal güncelleme ile oluşturuldu'\r\n+\t\t\t\t\t\t);\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n+\t\t\t\t\t\terror_log(\"MUHASEBE TAHSILAT DURUM yeni kayıt oluşturuldu - Tip: $tip_kod, Source ID: $source_id\");\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\tif ($updated) {\r\n \t\t\t\t\t$guncellenen_sayisi++;\r\n \t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n"
                },
                {
                    "date": 1756220427280,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2228,8 +2228,288 @@\n \r\n \t}\r\n \t\r\n \t/**\r\n+\t * Cari Silme Kontrolü ve Silme İşlemi\r\n+\t */\r\n+\tpublic function cari_sil_kontrol()\r\n+\t{\r\n+\t\t// Yetki kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(530)) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Kütüphaneleri yükle\r\n+\t\t$this->load->database();\r\n+\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\r\n+\t\tif (!$cari_id) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari ID belirtilmemiş.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Cari bilgilerini getir\r\n+\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n+\t\tif (!$cari) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari bulunamadı.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// İlişkili verileri kontrol et\r\n+\t\t$bagimli_veriler = [];\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Cari hareketleri kontrolü\r\n+\t\t\t$cari_hareketleri = $this->db->where('ch_cariID', $cari_id)->count_all_results('carihareketleri');\r\n+\t\t\tif ($cari_hareketleri > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Cari Hareketleri',\r\n+\t\t\t\t\t'adet' => $cari_hareketleri,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait mali hareketler mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Satış faturaları kontrolü\r\n+\t\t\t$satis_faturalari = $this->db->where('satis_cariID', $cari_id)->count_all_results('satisfaturasi');\r\n+\t\t\tif ($satis_faturalari > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Satış Faturaları',\r\n+\t\t\t\t\t'adet' => $satis_faturalari,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait satış faturaları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Alış faturaları kontrolü\r\n+\t\t\t$alis_faturalari = $this->db->where('alis_cariID', $cari_id)->count_all_results('alisfaturasi');\r\n+\t\t\tif ($alis_faturalari > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Alış Faturaları',\r\n+\t\t\t\t\t'adet' => $alis_faturalari,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait alış faturaları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Proforma faturaları kontrolü\r\n+\t\t\t$proforma_faturalari = $this->db->where('proforma_cariID', $cari_id)->count_all_results('proformafaturasi');\r\n+\t\t\tif ($proforma_faturalari > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Proforma Faturaları',\r\n+\t\t\t\t\t'adet' => $proforma_faturalari,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait proforma faturaları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Banka hareketleri kontrolü (giriş/çıkış)\r\n+\t\t\t$banka_giris = $this->db->where('bh_cariID', $cari_id)->count_all_results('bankahareketleri');\r\n+\t\t\tif ($banka_giris > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Banka Hareketleri',\r\n+\t\t\t\t\t'adet' => $banka_giris,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait banka hareketleri mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Kasa hareketleri kontrolü\r\n+\t\t\t$kasa_hareketleri = $this->db->where('kh_cariID', $cari_id)->count_all_results('kasahareketleri');\r\n+\t\t\tif ($kasa_hareketleri > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Kasa Hareketleri',\r\n+\t\t\t\t\t'adet' => $kasa_hareketleri,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait kasa hareketleri mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Çek kontrolü\r\n+\t\t\t$cekler = $this->db->where('cek_cariID', $cari_id)->count_all_results('cek');\r\n+\t\t\tif ($cekler > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Çekler',\r\n+\t\t\t\t\t'adet' => $cekler,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait çek kayıtları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Senet kontrolü\r\n+\t\t\t$senetler = $this->db->where('senet_cariID', $cari_id)->count_all_results('senet');\r\n+\t\t\tif ($senetler > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Senetler',\r\n+\t\t\t\t\t'adet' => $senetler,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait senet kayıtları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Aktivasyon kontrolü\r\n+\t\t\t$aktivasyonlar = $this->db->where('aktivasyon_cari_id', $cari_id)->count_all_results('aktivasyon');\r\n+\t\t\tif ($aktivasyonlar > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Aktivasyonlar',\r\n+\t\t\t\t\t'adet' => $aktivasyonlar,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait aktivasyon kayıtları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Potansiyel satış kontrolü\r\n+\t\t\t$potansiyel_satislar = $this->db->where('potansiyel_cari_id', $cari_id)->count_all_results('potansiyel_satis');\r\n+\t\t\tif ($potansiyel_satislar > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Potansiyel Satışlar',\r\n+\t\t\t\t\t'adet' => $potansiyel_satislar,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait potansiyel satış kayıtları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Eğer bağımlı veri varsa uyarı göster\r\n+\t\t\tif (!empty($bagimli_veriler)) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'warning',\r\n+\t\t\t\t\t'message' => 'Bu cari kaydının silinmesi durumunda aşağıdaki veriler de silinecektir:',\r\n+\t\t\t\t\t'data' => $bagimli_veriler,\r\n+\t\t\t\t\t'cari_bilgi' => [\r\n+\t\t\t\t\t\t'id' => $cari->cari_id,\r\n+\t\t\t\t\t\t'ad' => $cari->cari_ad . ($cari->cari_soyad ? ' ' . $cari->cari_soyad : ''),\r\n+\t\t\t\t\t\t'telefon' => $cari->cari_firmaTelefon\r\n+\t\t\t\t\t]\r\n+\t\t\t\t]);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Bağımlı veri yoksa doğrudan silme onayı iste\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'confirm',\r\n+\t\t\t\t\t'message' => 'Bu cari kaydı silinecektir. Devam etmek istiyor musunuz?',\r\n+\t\t\t\t\t'cari_bilgi' => [\r\n+\t\t\t\t\t\t'id' => $cari->cari_id,\r\n+\t\t\t\t\t\t'ad' => $cari->cari_ad . ($cari->cari_soyad ? ' ' . $cari->cari_soyad : ''),\r\n+\t\t\t\t\t\t'telefon' => $cari->cari_firmaTelefon\r\n+\t\t\t\t\t]\r\n+\t\t\t\t]);\r\n+\t\t\t}\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Kontrol sırasında hata oluştu: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Cari Silme İşlemi\r\n+\t */\r\n+\tpublic function cari_sil()\r\n+\t{\r\n+\t\t// Yetki kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(530)) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Kütüphaneleri yükle\r\n+\t\t$this->load->database();\r\n+\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t$onay = $this->input->post('onay');\r\n+\t\t\r\n+\t\tif (!$cari_id) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari ID belirtilmemiş.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\tif ($onay != 'evet') {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi onaylanmamış.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Cari bilgilerini getir\r\n+\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n+\t\tif (!$cari) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari bulunamadı.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\ttry {\r\n+\t\t\t$this->db->trans_start();\r\n+\r\n+\t\t\t// Bağımlı verileri sil\r\n+\t\t\t$this->db->where('ch_cariID', $cari_id)->delete('carihareketleri');\r\n+\t\t\t$this->db->where('satis_cariID', $cari_id)->delete('satisfaturasi');\r\n+\t\t\t$this->db->where('alis_cariID', $cari_id)->delete('alisfaturasi');\r\n+\t\t\t$this->db->where('proforma_cariID', $cari_id)->delete('proformafaturasi');\r\n+\t\t\t$this->db->where('bh_cariID', $cari_id)->delete('bankahareketleri');\r\n+\t\t\t$this->db->where('kh_cariID', $cari_id)->delete('kasahareketleri');\r\n+\t\t\t$this->db->where('cek_cariID', $cari_id)->delete('cek');\r\n+\t\t\t$this->db->where('senet_cariID', $cari_id)->delete('senet');\r\n+\t\t\t$this->db->where('aktivasyon_cari_id', $cari_id)->delete('aktivasyon');\r\n+\t\t\t$this->db->where('potansiyel_cari_id', $cari_id)->delete('potansiyel_satis');\r\n+\t\t\t\r\n+\t\t\t// Satış fatura stok kayıtlarını sil\r\n+\t\t\t$this->db->query(\"DELETE sfs FROM satisfaturasistok sfs \r\n+                             INNER JOIN satisfaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n+                             WHERE sf.satis_cariID = ?\", array($cari_id));\r\n+\t\t\t\r\n+\t\t\t// Alış fatura stok kayıtlarını sil\r\n+\t\t\t$this->db->query(\"DELETE als FROM alisfaturasistok als \r\n+                             INNER JOIN alisfaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n+                             WHERE af.alis_cariID = ?\", array($cari_id));\r\n+\t\t\t\r\n+\t\t\t// Proforma fatura stok kayıtlarını sil\r\n+\t\t\t$this->db->query(\"DELETE pfs FROM proformafaturasistok pfs \r\n+                             INNER JOIN proformafaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n+                             WHERE pf.proforma_cariID = ?\", array($cari_id));\r\n+\r\n+\t\t\t// Dosya silme işlemleri\r\n+\t\t\tif (!empty($cari->evrak_dosya)) {\r\n+\t\t\t\t$evrak_dosyalari = explode(',', $cari->evrak_dosya);\r\n+\t\t\t\tforeach ($evrak_dosyalari as $dosya) {\r\n+\t\t\t\t\t$dosya_yolu = FCPATH . 'assets/uploads/' . trim($dosya);\r\n+\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n+\t\t\t\t\t\tunlink($dosya_yolu);\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif (!empty($cari->fotograf_dosya)) {\r\n+\t\t\t\t$foto_dosyalari = explode(',', $cari->fotograf_dosya);\r\n+\t\t\t\tforeach ($foto_dosyalari as $dosya) {\r\n+\t\t\t\t\t$dosya_yolu = FCPATH . 'assets/uploads/' . trim($dosya);\r\n+\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n+\t\t\t\t\t\tunlink($dosya_yolu);\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Cari detay tablolarını sil\r\n+\t\t\t$this->db->where('cari_id', $cari_id)->delete('caridetaylibanka');\r\n+\t\t\t$this->db->where('cari_id', $cari_id)->delete('caridetayliiletisim');\r\n+\t\t\t\r\n+\t\t\t// Son olarak cariyi sil\r\n+\t\t\t$this->db->where('cari_id', $cari_id)->delete('cari');\r\n+\r\n+\t\t\t$this->db->trans_complete();\r\n+\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi sırasında hata oluştu.']);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Log kaydet\r\n+\t\t\t\t$log_data = [\r\n+\t\t\t\t\t'kullanici_id' => session(\"kullanici\")->kullanici_id,\r\n+\t\t\t\t\t'islem' => 'Cari Silme',\r\n+\t\t\t\t\t'aciklama' => 'Cari silindi: ' . $cari->cari_ad . ($cari->cari_soyad ? ' ' . $cari->cari_soyad : '') . ' (ID: ' . $cari_id . ')',\r\n+\t\t\t\t\t'ip_adresi' => $this->input->ip_address(),\r\n+\t\t\t\t\t'tarih' => date('Y-m-d H:i:s')\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'success', \r\n+\t\t\t\t\t'message' => 'Cari kaydı ve bağlı tüm veriler başarıyla silindi.'\r\n+\t\t\t\t]);\r\n+\t\t\t}\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t$this->db->trans_rollback();\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi sırasında hata: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n \t * Tam Ana Rapor - ID: 531\r\n \t */\r\n \tpublic function tam_ana_rapor()\r\n \t{\r\n"
                },
                {
                    "date": 1756223747547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2359,8 +2359,27 @@\n \t\t\t\t\t'aciklama' => 'Bu cariye ait potansiyel satış kayıtları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n+\t\t\t// Muhasebe tahsilat durum kontrolü (indirekt bağlantı)\r\n+\t\t\t$muhasebe_tahsilat = $this->db->query(\"\r\n+\t\t\t\tSELECT COUNT(*) as toplam FROM muhasebe_tahsilat_durum mtd\r\n+\t\t\t\tWHERE (\r\n+\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND mtd.kayit_id IN (SELECT bh_id FROM bankahareketleri WHERE bh_cariID = ?)) OR\r\n+\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND mtd.kayit_id IN (SELECT cek_id FROM cek WHERE cek_cariID = ?)) OR\r\n+\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND mtd.kayit_id IN (SELECT kh_id FROM kasahareketleri WHERE kh_cariID = ?)) OR\r\n+\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND mtd.kayit_id IN (SELECT senet_id FROM senet WHERE senet_cariID = ?))\r\n+\t\t\t\t)\r\n+\t\t\t\", [$cari_id, $cari_id, $cari_id, $cari_id])->row()->toplam;\r\n+\t\t\t\r\n+\t\t\tif ($muhasebe_tahsilat > 0) {\r\n+\t\t\t\t$bagimli_veriler[] = [\r\n+\t\t\t\t\t'tablo' => 'Muhasebe Tahsilat Durum',\r\n+\t\t\t\t\t'adet' => $muhasebe_tahsilat,\r\n+\t\t\t\t\t'aciklama' => 'Bu cariye ait muhasebe tahsilat durum kayıtları mevcut'\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n \t\t\t// Eğer bağımlı veri varsa uyarı göster\r\n \t\t\tif (!empty($bagimli_veriler)) {\r\n \t\t\t\techo json_encode([\r\n \t\t\t\t\t'status' => 'warning',\r\n@@ -2426,8 +2445,19 @@\n \r\n \t\ttry {\r\n \t\t\t$this->db->trans_start();\r\n \r\n+\t\t\t// Muhasebe tahsilat durum kayıtlarını sil (indirekt bağlantılar)\r\n+\t\t\t$this->db->query(\"\r\n+\t\t\t\tDELETE FROM muhasebe_tahsilat_durum \r\n+\t\t\t\tWHERE (\r\n+\t\t\t\t\t(tahsilat_tipi = 1 AND kayit_id IN (SELECT bh_id FROM bankahareketleri WHERE bh_cariID = ?)) OR\r\n+\t\t\t\t\t(tahsilat_tipi = 2 AND kayit_id IN (SELECT cek_id FROM cek WHERE cek_cariID = ?)) OR\r\n+\t\t\t\t\t(tahsilat_tipi = 3 AND kayit_id IN (SELECT kh_id FROM kasahareketleri WHERE kh_cariID = ?)) OR\r\n+\t\t\t\t\t(tahsilat_tipi = 4 AND kayit_id IN (SELECT senet_id FROM senet WHERE senet_cariID = ?))\r\n+\t\t\t\t)\r\n+\t\t\t\", [$cari_id, $cari_id, $cari_id, $cari_id]);\r\n+\r\n \t\t\t// Bağımlı verileri sil\r\n \t\t\t$this->db->where('ch_cariID', $cari_id)->delete('carihareketleri');\r\n \t\t\t$this->db->where('satis_cariID', $cari_id)->delete('satisfaturasi');\r\n \t\t\t$this->db->where('alis_cariID', $cari_id)->delete('alisfaturasi');\r\n"
                },
                {
                    "date": 1756224475278,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2409,44 +2409,108 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n-\t * Cari Silme İşlemi\r\n+\t * Cari Silme İşlemi - GÜVENLİK İÇİN GEÇİCİ OLARAK DEVRE DIŞI\r\n \t */\r\n \tpublic function cari_sil()\r\n \t{\r\n-\t\t// Yetki kontrolü\r\n-\t\tif (!grup_modul_yetkisi_var(530)) {\r\n-\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t// Kütüphaneleri yükle\r\n-\t\t$this->load->database();\r\n-\r\n+\t\t// GÜVENLİK İÇİN GEÇİCİ OLARAK DEVRE DIŞI\r\n+\t\t// Bu function büyük veri kaybına neden olduğu için devre dışı bırakıldı\r\n+\t\t\r\n \t\t$cari_id = $this->input->post('cari_id');\r\n \t\t$onay = $this->input->post('onay');\r\n \t\t\r\n-\t\tif (!$cari_id) {\r\n-\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari ID belirtilmemiş.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n+\t\t// Detaylı log kaydı\r\n+\t\terror_log(\"=== CARI SİLME DENEMESİ ===\");\r\n+\t\terror_log(\"Cari ID: \" . var_export($cari_id, true));\r\n+\t\terror_log(\"Onay: \" . var_export($onay, true));\r\n+\t\terror_log(\"POST Data: \" . print_r($_POST, true));\r\n+\t\terror_log(\"Kullanıcı: \" . (session(\"kullanici\") ? session(\"kullanici\")->kullanici_id : 'Bilinmiyor'));\r\n+\t\terror_log(\"IP: \" . $this->input->ip_address());\r\n+\t\terror_log(\"Tarih: \" . date('Y-m-d H:i:s'));\r\n+\t\terror_log(\"=== END ===\");\r\n+\t\t\r\n+\t\techo json_encode([\r\n+\t\t\t'status' => 'error', \r\n+\t\t\t'message' => 'GÜVENLİK NEDENİYLE CARI SİLME İŞLEMİ GEÇİCİ OLARAK DEVRE DIŞI BIRAKILDI. Sistem yöneticinizle iletişime geçin.'\r\n+\t\t]);\r\n+\t\treturn;\r\n+\t\t\r\n+\t\t/* ESKI KOD GÜVENLİK İÇİN KALDIRILD\r\n+\t\t// Hata raporlamayı geçici olarak aç\r\n+\t\terror_reporting(E_ALL);\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Yetki kontrolü\r\n+\t\t\tif (!grup_modul_yetkisi_var(530)) {\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n \r\n-\t\tif ($onay != 'evet') {\r\n-\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi onaylanmamış.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n+\t\t\t// Kütüphaneleri yükle\r\n+\t\t\t$this->load->database();\r\n \r\n-\t\t// Cari bilgilerini getir\r\n-\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n-\t\tif (!$cari) {\r\n-\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari bulunamadı.']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n+\t\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\t$onay = $this->input->post('onay');\r\n+\t\t\t\r\n+\t\t\t// Debug log\r\n+\t\t\terror_log(\"Cari silme işlemi - Cari ID: \" . $cari_id . \", Onay: \" . $onay);\r\n+\t\t\t\r\n+\t\t\tif (!$cari_id || empty($cari_id) || $cari_id === '0') {\r\n+\t\t\t\terror_log(\"Cari silme hatası: Geçersiz cari_id - \" . $cari_id);\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari ID belirtilmemiş veya geçersiz.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n \r\n-\t\ttry {\r\n+\t\t\tif ($onay != 'evet') {\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi onaylanmamış.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Güvenlik kontrolü - sadece numeric ID kabul et\r\n+\t\t\tif (!is_numeric($cari_id) || intval($cari_id) <= 0) {\r\n+\t\t\t\terror_log(\"Cari silme hatası: Numeric olmayan cari_id - \" . $cari_id);\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Geçersiz Cari ID formatı.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$cari_id = intval($cari_id); // Integer'a çevir\r\n+\r\n+\t\t\t// Cari bilgilerini getir\r\n+\t\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n+\t\t\tif (!$cari) {\r\n+\t\t\t\terror_log(\"Cari silme hatası: Cari bulunamadı - ID: \" . $cari_id);\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari bulunamadı.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\r\n+\t\t\terror_log(\"Cari siliniyor - ID: \" . $cari_id . \", Ad: \" . $cari->cari_ad);\r\n+\r\n \t\t\t$this->db->trans_start();\r\n \r\n+\t\t\t// Her silme işleminde affected rows kontrol et\r\n+\t\t\t$total_deleted = 0;\r\n+\r\n+\t\t\t// Önce bağımlı stok kayıtlarını sil (foreign key constraints için)\r\n+\t\t\t$affected = $this->db->query(\"DELETE sfs FROM satisFaturasiStok sfs \r\n+                             INNER JOIN satisFaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n+                             WHERE sf.satis_cariID = ?\", array($cari_id));\r\n+\t\t\t$satisStok_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $satisStok_deleted;\r\n+\t\t\t\r\n+\t\t\t$this->db->query(\"DELETE als FROM alisFaturasiStok als \r\n+                             INNER JOIN alisFaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n+                             WHERE af.alis_cariID = ?\", array($cari_id));\r\n+\t\t\t$alisStok_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $alisStok_deleted;\r\n+\t\t\t\r\n+\t\t\t$this->db->query(\"DELETE pfs FROM proformaFaturasiStok pfs \r\n+                             INNER JOIN proformaFaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n+                             WHERE pf.proforma_cariID = ?\", array($cari_id));\r\n+\t\t\t$proformaStok_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $proformaStok_deleted;\r\n+\r\n \t\t\t// Muhasebe tahsilat durum kayıtlarını sil (indirekt bağlantılar)\r\n \t\t\t$this->db->query(\"\r\n \t\t\t\tDELETE FROM muhasebe_tahsilat_durum \r\n \t\t\t\tWHERE (\r\n@@ -2455,88 +2519,55 @@\n \t\t\t\t\t(tahsilat_tipi = 3 AND kayit_id IN (SELECT kh_id FROM kasahareketleri WHERE kh_cariID = ?)) OR\r\n \t\t\t\t\t(tahsilat_tipi = 4 AND kayit_id IN (SELECT senet_id FROM senet WHERE senet_cariID = ?))\r\n \t\t\t\t)\r\n \t\t\t\", [$cari_id, $cari_id, $cari_id, $cari_id]);\r\n+\t\t\t$tahsilat_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $tahsilat_deleted;\r\n \r\n-\t\t\t// Bağımlı verileri sil\r\n+\t\t\t// Diğer bağımlı verileri sil - her birini ayrı ayrı kontrol et\r\n \t\t\t$this->db->where('ch_cariID', $cari_id)->delete('carihareketleri');\r\n-\t\t\t$this->db->where('satis_cariID', $cari_id)->delete('satisfaturasi');\r\n-\t\t\t$this->db->where('alis_cariID', $cari_id)->delete('alisfaturasi');\r\n-\t\t\t$this->db->where('proforma_cariID', $cari_id)->delete('proformafaturasi');\r\n+\t\t\t$cari_hareketleri_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $cari_hareketleri_deleted;\r\n+\t\t\t\r\n+\t\t\t$this->db->where('satis_cariID', $cari_id)->delete('satisFaturasi');\r\n+\t\t\t$satis_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $satis_deleted;\r\n+\t\t\t\r\n+\t\t\t$this->db->where('alis_cariID', $cari_id)->delete('alisFaturasi');\r\n+\t\t\t$alis_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $alis_deleted;\r\n+\t\t\t\r\n+\t\t\t$this->db->where('proforma_cariID', $cari_id)->delete('proformaFaturasi');\r\n+\t\t\t$proforma_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $proforma_deleted;\r\n+\t\t\t\r\n \t\t\t$this->db->where('bh_cariID', $cari_id)->delete('bankahareketleri');\r\n+\t\t\t$banka_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $banka_deleted;\r\n+\t\t\t\r\n \t\t\t$this->db->where('kh_cariID', $cari_id)->delete('kasahareketleri');\r\n+\t\t\t$kasa_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $kasa_deleted;\r\n+\t\t\t\r\n \t\t\t$this->db->where('cek_cariID', $cari_id)->delete('cek');\r\n+\t\t\t$cek_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $cek_deleted;\r\n+\t\t\t\r\n \t\t\t$this->db->where('senet_cariID', $cari_id)->delete('senet');\r\n+\t\t\t$senet_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $senet_deleted;\r\n+\t\t\t\r\n \t\t\t$this->db->where('aktivasyon_cari_id', $cari_id)->delete('aktivasyon');\r\n+\t\t\t$aktivasyon_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $aktivasyon_deleted;\r\n+\t\t\t\r\n \t\t\t$this->db->where('potansiyel_cari_id', $cari_id)->delete('potansiyel_satis');\r\n-\t\t\t\r\n-\t\t\t// Satış fatura stok kayıtlarını sil\r\n-\t\t\t$this->db->query(\"DELETE sfs FROM satisfaturasistok sfs \r\n-                             INNER JOIN satisfaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n-                             WHERE sf.satis_cariID = ?\", array($cari_id));\r\n-\t\t\t\r\n-\t\t\t// Alış fatura stok kayıtlarını sil\r\n-\t\t\t$this->db->query(\"DELETE als FROM alisfaturasistok als \r\n-                             INNER JOIN alisfaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n-                             WHERE af.alis_cariID = ?\", array($cari_id));\r\n-\t\t\t\r\n-\t\t\t// Proforma fatura stok kayıtlarını sil\r\n-\t\t\t$this->db->query(\"DELETE pfs FROM proformafaturasistok pfs \r\n-                             INNER JOIN proformafaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n-                             WHERE pf.proforma_cariID = ?\", array($cari_id));\r\n+\t\t\t$potansiyel_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $potansiyel_deleted;\r\n \r\n-\t\t\t// Dosya silme işlemleri\r\n-\t\t\tif (!empty($cari->evrak_dosya)) {\r\n-\t\t\t\t$evrak_dosyalari = explode(',', $cari->evrak_dosya);\r\n-\t\t\t\tforeach ($evrak_dosyalari as $dosya) {\r\n-\t\t\t\t\t$dosya_yolu = FCPATH . 'assets/uploads/' . trim($dosya);\r\n-\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n-\t\t\t\t\t\tunlink($dosya_yolu);\r\n-\t\t\t\t\t}\r\n-\t\t\t\t}\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (!empty($cari->fotograf_dosya)) {\r\n-\t\t\t\t$foto_dosyalari = explode(',', $cari->fotograf_dosya);\r\n-\t\t\t\tforeach ($foto_dosyalari as $dosya) {\r\n-\t\t\t\t\t$dosya_yolu = FCPATH . 'assets/uploads/' . trim($dosya);\r\n-\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n-\t\t\t\t\t\tunlink($dosya_yolu);\r\n-\t\t\t\t\t}\r\n-\t\t\t\t}\r\n-\t\t\t}\r\n-\r\n-\t\t\t// Cari detay tablolarını sil\r\n-\t\t\t$this->db->where('cari_id', $cari_id)->delete('caridetaylibanka');\r\n-\t\t\t$this->db->where('cari_id', $cari_id)->delete('caridetayliiletisim');\r\n-\t\t\t\r\n-\t\t\t// Son olarak cariyi sil\r\n-\t\t\t$this->db->where('cari_id', $cari_id)->delete('cari');\r\n-\r\n-\t\t\t$this->db->trans_complete();\r\n-\r\n-\t\t\tif ($this->db->trans_status() === FALSE) {\r\n-\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi sırasında hata oluştu.']);\r\n-\t\t\t} else {\r\n-\t\t\t\t// Log kaydet\r\n-\t\t\t\t$log_data = [\r\n-\t\t\t\t\t'kullanici_id' => session(\"kullanici\")->kullanici_id,\r\n-\t\t\t\t\t'islem' => 'Cari Silme',\r\n-\t\t\t\t\t'aciklama' => 'Cari silindi: ' . $cari->cari_ad . ($cari->cari_soyad ? ' ' . $cari->cari_soyad : '') . ' (ID: ' . $cari_id . ')',\r\n-\t\t\t\t\t'ip_adresi' => $this->input->ip_address(),\r\n-\t\t\t\t\t'tarih' => date('Y-m-d H:i:s')\r\n-\t\t\t\t];\r\n-\t\t\t\t\r\n-\t\t\t\techo json_encode([\r\n-\t\t\t\t\t'status' => 'success', \r\n-\t\t\t\t\t'message' => 'Cari kaydı ve bağlı tüm veriler başarıyla silindi.'\r\n-\t\t\t\t]);\r\n-\t\t\t}\r\n-\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\t$this->db->trans_rollback();\r\n-\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi sırasında hata: ' . $e->getMessage()]);\r\n-\t\t}\r\n+\t\t\t// Log detaylı silme bilgileri\r\n+\t\t\terror_log(\"Cari silme detayları - ID: $cari_id, Stok Satış: $satisStok_deleted, Stok Alış: $alisStok_deleted, Stok Proforma: $proformaStok_deleted, Tahsilat: $tahsilat_deleted, Cari Har.: $cari_hareketleri_deleted, Satış: $satis_deleted, Alış: $alis_deleted, Proforma: $proforma_deleted, Banka: $banka_deleted, Kasa: $kasa_deleted, Çek: $cek_deleted, Senet: $senet_deleted, Aktivasyon: $aktivasyon_deleted, Potansiyel: $potansiyel_deleted\");\r\n+\t\t*/\r\n \t}\r\n \t\r\n \t/**\r\n \t * Tam Ana Rapor - ID: 531\r\n"
                },
                {
                    "date": 1756278129769,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,8 +17,10 @@\n \t\t$this->load->model('vt');\r\n \r\n \t\t$this->load->database();\r\n \r\n+\t\t$this->load->library('session');\r\n+\r\n \t\t$this->load->helper('general');\r\n \r\n \r\n \r\n@@ -2260,9 +2262,10 @@\n \t\t$bagimli_veriler = [];\r\n \t\t\r\n \t\ttry {\r\n \t\t\t// Cari hareketleri kontrolü\r\n-\t\t\t$cari_hareketleri = $this->db->where('ch_cariID', $cari_id)->count_all_results('carihareketleri');\r\n+\t\t\t$this->db->where('ch_cariID', $cari_id);\r\n+\t\t\t$cari_hareketleri = $this->db->count_all_results('carihareketleri');\r\n \t\t\tif ($cari_hareketleri > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Cari Hareketleri',\r\n \t\t\t\t\t'adet' => $cari_hareketleri,\r\n@@ -2270,9 +2273,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Satış faturaları kontrolü\r\n-\t\t\t$satis_faturalari = $this->db->where('satis_cariID', $cari_id)->count_all_results('satisfaturasi');\r\n+\t\t\t$this->db->where('satis_cariID', $cari_id);\r\n+\t\t\t$satis_faturalari = $this->db->count_all_results('satisFaturasi');\r\n \t\t\tif ($satis_faturalari > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Satış Faturaları',\r\n \t\t\t\t\t'adet' => $satis_faturalari,\r\n@@ -2280,9 +2284,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Alış faturaları kontrolü\r\n-\t\t\t$alis_faturalari = $this->db->where('alis_cariID', $cari_id)->count_all_results('alisfaturasi');\r\n+\t\t\t$this->db->where('alis_cariID', $cari_id);\r\n+\t\t\t$alis_faturalari = $this->db->count_all_results('alisFaturasi');\r\n \t\t\tif ($alis_faturalari > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Alış Faturaları',\r\n \t\t\t\t\t'adet' => $alis_faturalari,\r\n@@ -2290,9 +2295,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Proforma faturaları kontrolü\r\n-\t\t\t$proforma_faturalari = $this->db->where('proforma_cariID', $cari_id)->count_all_results('proformafaturasi');\r\n+\t\t\t$this->db->where('proforma_cariID', $cari_id);\r\n+\t\t\t$proforma_faturalari = $this->db->count_all_results('proformaFaturasi');\r\n \t\t\tif ($proforma_faturalari > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Proforma Faturaları',\r\n \t\t\t\t\t'adet' => $proforma_faturalari,\r\n@@ -2300,9 +2306,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Banka hareketleri kontrolü (giriş/çıkış)\r\n-\t\t\t$banka_giris = $this->db->where('bh_cariID', $cari_id)->count_all_results('bankahareketleri');\r\n+\t\t\t$this->db->where('bh_cariID', $cari_id);\r\n+\t\t\t$banka_giris = $this->db->count_all_results('bankahareketleri');\r\n \t\t\tif ($banka_giris > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Banka Hareketleri',\r\n \t\t\t\t\t'adet' => $banka_giris,\r\n@@ -2310,9 +2317,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Kasa hareketleri kontrolü\r\n-\t\t\t$kasa_hareketleri = $this->db->where('kh_cariID', $cari_id)->count_all_results('kasahareketleri');\r\n+\t\t\t$this->db->where('kh_cariID', $cari_id);\r\n+\t\t\t$kasa_hareketleri = $this->db->count_all_results('kasahareketleri');\r\n \t\t\tif ($kasa_hareketleri > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Kasa Hareketleri',\r\n \t\t\t\t\t'adet' => $kasa_hareketleri,\r\n@@ -2320,9 +2328,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Çek kontrolü\r\n-\t\t\t$cekler = $this->db->where('cek_cariID', $cari_id)->count_all_results('cek');\r\n+\t\t\t$this->db->where('cek_cariID', $cari_id);\r\n+\t\t\t$cekler = $this->db->count_all_results('cek');\r\n \t\t\tif ($cekler > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Çekler',\r\n \t\t\t\t\t'adet' => $cekler,\r\n@@ -2330,9 +2339,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Senet kontrolü\r\n-\t\t\t$senetler = $this->db->where('senet_cariID', $cari_id)->count_all_results('senet');\r\n+\t\t\t$this->db->where('senet_cariID', $cari_id);\r\n+\t\t\t$senetler = $this->db->count_all_results('senet');\r\n \t\t\tif ($senetler > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Senetler',\r\n \t\t\t\t\t'adet' => $senetler,\r\n@@ -2340,9 +2350,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Aktivasyon kontrolü\r\n-\t\t\t$aktivasyonlar = $this->db->where('aktivasyon_cari_id', $cari_id)->count_all_results('aktivasyon');\r\n+\t\t\t$this->db->where('aktivasyon_cari_id', $cari_id);\r\n+\t\t\t$aktivasyonlar = $this->db->count_all_results('aktivasyon');\r\n \t\t\tif ($aktivasyonlar > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Aktivasyonlar',\r\n \t\t\t\t\t'adet' => $aktivasyonlar,\r\n@@ -2350,9 +2361,10 @@\n \t\t\t\t];\r\n \t\t\t}\r\n \r\n \t\t\t// Potansiyel satış kontrolü\r\n-\t\t\t$potansiyel_satislar = $this->db->where('potansiyel_cari_id', $cari_id)->count_all_results('potansiyel_satis');\r\n+\t\t\t$this->db->where('potansiyel_cari_id', $cari_id);\r\n+\t\t\t$potansiyel_satislar = $this->db->count_all_results('potansiyel_satis');\r\n \t\t\tif ($potansiyel_satislar > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Potansiyel Satışlar',\r\n \t\t\t\t\t'adet' => $potansiyel_satislar,\r\n@@ -2409,165 +2421,145 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n-\t * Cari Silme İşlemi - GÜVENLİK İÇİN GEÇİCİ OLARAK DEVRE DIŞI\r\n+\t * Cari Silme İşlemi - GÜVENLİ VERSİYON\r\n \t */\r\n \tpublic function cari_sil()\r\n \t{\r\n-\t\t// GÜVENLİK İÇİN GEÇİCİ OLARAK DEVRE DIŞI\r\n-\t\t// Bu function büyük veri kaybına neden olduğu için devre dışı bırakıldı\r\n+\t\t// JSON header ayarla\r\n+\t\theader('Content-Type: application/json');\r\n \t\t\r\n-\t\t$cari_id = $this->input->post('cari_id');\r\n-\t\t$onay = $this->input->post('onay');\r\n-\t\t\r\n-\t\t// Detaylı log kaydı\r\n-\t\terror_log(\"=== CARI SİLME DENEMESİ ===\");\r\n-\t\terror_log(\"Cari ID: \" . var_export($cari_id, true));\r\n-\t\terror_log(\"Onay: \" . var_export($onay, true));\r\n-\t\terror_log(\"POST Data: \" . print_r($_POST, true));\r\n-\t\terror_log(\"Kullanıcı: \" . (session(\"kullanici\") ? session(\"kullanici\")->kullanici_id : 'Bilinmiyor'));\r\n-\t\terror_log(\"IP: \" . $this->input->ip_address());\r\n-\t\terror_log(\"Tarih: \" . date('Y-m-d H:i:s'));\r\n-\t\terror_log(\"=== END ===\");\r\n-\t\t\r\n-\t\techo json_encode([\r\n-\t\t\t'status' => 'error', \r\n-\t\t\t'message' => 'GÜVENLİK NEDENİYLE CARI SİLME İŞLEMİ GEÇİCİ OLARAK DEVRE DIŞI BIRAKILDI. Sistem yöneticinizle iletişime geçin.'\r\n-\t\t]);\r\n-\t\treturn;\r\n-\t\t\r\n-\t\t/* ESKI KOD GÜVENLİK İÇİN KALDIRILD\r\n-\t\t// Hata raporlamayı geçici olarak aç\r\n-\t\terror_reporting(E_ALL);\r\n-\t\t\r\n \t\ttry {\r\n-\t\t\t// Yetki kontrolü\r\n-\t\t\tif (!grup_modul_yetkisi_var(530)) {\r\n-\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\t$cari_id = isset($_POST['cari_id']) ? $_POST['cari_id'] : null;\r\n+\t\t\t$onay = isset($_POST['onay']) ? $_POST['onay'] : null;\r\n+\t\t\t\r\n+\t\t\t// Temel validasyon\r\n+\t\t\tif (!$cari_id || $onay !== 'evet') {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'error',\r\n+\t\t\t\t\t'message' => 'Geçersiz parametreler'\r\n+\t\t\t\t]);\r\n \t\t\t\treturn;\r\n \t\t\t}\r\n-\r\n-\t\t\t// Kütüphaneleri yükle\r\n-\t\t\t$this->load->database();\r\n-\r\n-\t\t\t$cari_id = $this->input->post('cari_id');\r\n-\t\t\t$onay = $this->input->post('onay');\r\n \t\t\t\r\n-\t\t\t// Debug log\r\n-\t\t\terror_log(\"Cari silme işlemi - Cari ID: \" . $cari_id . \", Onay: \" . $onay);\r\n-\t\t\t\r\n-\t\t\tif (!$cari_id || empty($cari_id) || $cari_id === '0') {\r\n-\t\t\t\terror_log(\"Cari silme hatası: Geçersiz cari_id - \" . $cari_id);\r\n-\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari ID belirtilmemiş veya geçersiz.']);\r\n+\t\t\t// Numeric kontrolü\r\n+\t\t\tif (!is_numeric($cari_id) || intval($cari_id) <= 0) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'error',\r\n+\t\t\t\t\t'message' => 'Geçersiz Cari ID formatı'\r\n+\t\t\t\t]);\r\n \t\t\t\treturn;\r\n \t\t\t}\r\n-\r\n-\t\t\tif ($onay != 'evet') {\r\n-\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Silme işlemi onaylanmamış.']);\r\n+\t\t\t\r\n+\t\t\t$cari_id = intval($cari_id);\r\n+\t\t\t\r\n+\t\t\t// Yetki kontrolü - grup_modul_yetkisi_var fonksiyonu varsa kullan\r\n+\t\t\tif (function_exists('grup_modul_yetkisi_var') && !grup_modul_yetkisi_var(530)) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'error',\r\n+\t\t\t\t\t'message' => 'Bu işlem için yetkiniz bulunmamaktadır'\r\n+\t\t\t\t]);\r\n \t\t\t\treturn;\r\n \t\t\t}\r\n-\r\n-\t\t\t// Güvenlik kontrolü - sadece numeric ID kabul et\r\n-\t\t\tif (!is_numeric($cari_id) || intval($cari_id) <= 0) {\r\n-\t\t\t\terror_log(\"Cari silme hatası: Numeric olmayan cari_id - \" . $cari_id);\r\n-\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Geçersiz Cari ID formatı.']);\r\n-\t\t\t\treturn;\r\n+\t\t\t\r\n+\t\t\t// Database ve model yükle\r\n+\t\t\tif (!isset($this->db)) {\r\n+\t\t\t\t$this->load->database();\r\n \t\t\t}\r\n+\t\t\tif (!isset($this->vt)) {\r\n+\t\t\t\t$this->load->model('vt');\r\n+\t\t\t}\r\n \t\t\t\r\n-\t\t\t$cari_id = intval($cari_id); // Integer'a çevir\r\n-\r\n-\t\t\t// Cari bilgilerini getir\r\n+\t\t\t// Cari var mı kontrol et\r\n \t\t\t$cari = $this->vt->single(\"cari\", [\"cari_id\" => $cari_id]);\r\n \t\t\tif (!$cari) {\r\n-\t\t\t\terror_log(\"Cari silme hatası: Cari bulunamadı - ID: \" . $cari_id);\r\n-\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Cari bulunamadı.']);\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'error',\r\n+\t\t\t\t\t'message' => 'Cari bulunamadı'\r\n+\t\t\t\t]);\r\n \t\t\t\treturn;\r\n \t\t\t}\r\n-\r\n-\t\t\terror_log(\"Cari siliniyor - ID: \" . $cari_id . \", Ad: \" . $cari->cari_ad);\r\n-\r\n+\t\t\t\r\n+\t\t\t// Transaction başlat\r\n \t\t\t$this->db->trans_start();\r\n-\r\n-\t\t\t// Her silme işleminde affected rows kontrol et\r\n+\t\t\t\r\n \t\t\t$total_deleted = 0;\r\n-\r\n-\t\t\t// Önce bağımlı stok kayıtlarını sil (foreign key constraints için)\r\n-\t\t\t$affected = $this->db->query(\"DELETE sfs FROM satisFaturasiStok sfs \r\n-                             INNER JOIN satisFaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n-                             WHERE sf.satis_cariID = ?\", array($cari_id));\r\n-\t\t\t$satisStok_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $satisStok_deleted;\r\n \t\t\t\r\n-\t\t\t$this->db->query(\"DELETE als FROM alisFaturasiStok als \r\n-                             INNER JOIN alisFaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n-                             WHERE af.alis_cariID = ?\", array($cari_id));\r\n-\t\t\t$alisStok_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $alisStok_deleted;\r\n+\t\t\t// 1. İlişkili stok kayıtlarını sil\r\n+\t\t\t$stok_queries = [\r\n+\t\t\t\t\"DELETE sfs FROM satisFaturasiStok sfs \r\n+\t\t\t\t INNER JOIN satisFaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n+\t\t\t\t WHERE sf.satis_cariID = ?\",\r\n+\t\t\t\t\"DELETE als FROM alisFaturasiStok als \r\n+\t\t\t\t INNER JOIN alisFaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n+\t\t\t\t WHERE af.alis_cariID = ?\",\r\n+\t\t\t\t\"DELETE pfs FROM proformaFaturasiStok pfs \r\n+\t\t\t\t INNER JOIN proformaFaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n+\t\t\t\t WHERE pf.proforma_cariID = ?\"\r\n+\t\t\t];\r\n \t\t\t\r\n-\t\t\t$this->db->query(\"DELETE pfs FROM proformaFaturasiStok pfs \r\n-                             INNER JOIN proformaFaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n-                             WHERE pf.proforma_cariID = ?\", array($cari_id));\r\n-\t\t\t$proformaStok_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $proformaStok_deleted;\r\n-\r\n-\t\t\t// Muhasebe tahsilat durum kayıtlarını sil (indirekt bağlantılar)\r\n-\t\t\t$this->db->query(\"\r\n-\t\t\t\tDELETE FROM muhasebe_tahsilat_durum \r\n-\t\t\t\tWHERE (\r\n-\t\t\t\t\t(tahsilat_tipi = 1 AND kayit_id IN (SELECT bh_id FROM bankahareketleri WHERE bh_cariID = ?)) OR\r\n-\t\t\t\t\t(tahsilat_tipi = 2 AND kayit_id IN (SELECT cek_id FROM cek WHERE cek_cariID = ?)) OR\r\n-\t\t\t\t\t(tahsilat_tipi = 3 AND kayit_id IN (SELECT kh_id FROM kasahareketleri WHERE kh_cariID = ?)) OR\r\n-\t\t\t\t\t(tahsilat_tipi = 4 AND kayit_id IN (SELECT senet_id FROM senet WHERE senet_cariID = ?))\r\n-\t\t\t\t)\r\n-\t\t\t\", [$cari_id, $cari_id, $cari_id, $cari_id]);\r\n-\t\t\t$tahsilat_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $tahsilat_deleted;\r\n-\r\n-\t\t\t// Diğer bağımlı verileri sil - her birini ayrı ayrı kontrol et\r\n-\t\t\t$this->db->where('ch_cariID', $cari_id)->delete('carihareketleri');\r\n-\t\t\t$cari_hareketleri_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $cari_hareketleri_deleted;\r\n+\t\t\tforeach ($stok_queries as $query) {\r\n+\t\t\t\t$this->db->query($query, [$cari_id]);\r\n+\t\t\t\t$total_deleted += $this->db->affected_rows();\r\n+\t\t\t}\r\n \t\t\t\r\n-\t\t\t$this->db->where('satis_cariID', $cari_id)->delete('satisFaturasi');\r\n-\t\t\t$satis_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $satis_deleted;\r\n+\t\t\t// 2. Ana tabloları sil\r\n+\t\t\t$tables_to_delete = [\r\n+\t\t\t\t['table' => 'carihareketleri', 'where' => 'ch_cariID'],\r\n+\t\t\t\t['table' => 'satisFaturasi', 'where' => 'satis_cariID'],\r\n+\t\t\t\t['table' => 'alisFaturasi', 'where' => 'alis_cariID'],\r\n+\t\t\t\t['table' => 'proformaFaturasi', 'where' => 'proforma_cariID'],\r\n+\t\t\t\t['table' => 'bankahareketleri', 'where' => 'bh_cariID'],\r\n+\t\t\t\t['table' => 'kasahareketleri', 'where' => 'kh_cariID'],\r\n+\t\t\t\t['table' => 'cek', 'where' => 'cek_cariID'],\r\n+\t\t\t\t['table' => 'senet', 'where' => 'senet_cariID'],\r\n+\t\t\t\t['table' => 'aktivasyon', 'where' => 'aktivasyon_cari_id'],\r\n+\t\t\t\t['table' => 'potansiyel_satis', 'where' => 'potansiyel_cari_id'],\r\n+\t\t\t\t['table' => 'caridetaylibanka', 'where' => 'cari_id'],\r\n+\t\t\t\t['table' => 'caridetayliiletisim', 'where' => 'cari_id']\r\n+\t\t\t];\r\n \t\t\t\r\n-\t\t\t$this->db->where('alis_cariID', $cari_id)->delete('alisFaturasi');\r\n-\t\t\t$alis_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $alis_deleted;\r\n+\t\t\tforeach ($tables_to_delete as $table_info) {\r\n+\t\t\t\t$this->db->where($table_info['where'], $cari_id);\r\n+\t\t\t\t$this->db->delete($table_info['table']);\r\n+\t\t\t\t$total_deleted += $this->db->affected_rows();\r\n+\t\t\t}\r\n \t\t\t\r\n-\t\t\t$this->db->where('proforma_cariID', $cari_id)->delete('proformaFaturasi');\r\n-\t\t\t$proforma_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $proforma_deleted;\r\n+\t\t\t// 3. Son olarak cari kaydını sil\r\n+\t\t\t$this->db->where('cari_id', $cari_id);\r\n+\t\t\t$this->db->delete('cari');\r\n+\t\t\t$cari_deleted = $this->db->affected_rows();\r\n+\t\t\t$total_deleted += $cari_deleted;\r\n \t\t\t\r\n-\t\t\t$this->db->where('bh_cariID', $cari_id)->delete('bankahareketleri');\r\n-\t\t\t$banka_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $banka_deleted;\r\n+\t\t\tif ($cari_deleted === 0) {\r\n+\t\t\t\tthrow new Exception(\"Cari kaydı silinemedi\");\r\n+\t\t\t}\r\n \t\t\t\r\n-\t\t\t$this->db->where('kh_cariID', $cari_id)->delete('kasahareketleri');\r\n-\t\t\t$kasa_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $kasa_deleted;\r\n+\t\t\t// Transaction'ı tamamla\r\n+\t\t\t$this->db->trans_complete();\r\n \t\t\t\r\n-\t\t\t$this->db->where('cek_cariID', $cari_id)->delete('cek');\r\n-\t\t\t$cek_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $cek_deleted;\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'error',\r\n+\t\t\t\t\t'message' => 'Silme işlemi sırasında veritabanı hatası oluştu'\r\n+\t\t\t\t]);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'success',\r\n+\t\t\t\t\t'message' => $cari->cari_ad . ' adlı cari ve bağlı tüm veriler başarıyla silindi. (Toplam ' . $total_deleted . ' kayıt)'\r\n+\t\t\t\t]);\r\n+\t\t\t}\r\n \t\t\t\r\n-\t\t\t$this->db->where('senet_cariID', $cari_id)->delete('senet');\r\n-\t\t\t$senet_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $senet_deleted;\r\n-\t\t\t\r\n-\t\t\t$this->db->where('aktivasyon_cari_id', $cari_id)->delete('aktivasyon');\r\n-\t\t\t$aktivasyon_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $aktivasyon_deleted;\r\n-\t\t\t\r\n-\t\t\t$this->db->where('potansiyel_cari_id', $cari_id)->delete('potansiyel_satis');\r\n-\t\t\t$potansiyel_deleted = $this->db->affected_rows();\r\n-\t\t\t$total_deleted += $potansiyel_deleted;\r\n-\r\n-\t\t\t// Log detaylı silme bilgileri\r\n-\t\t\terror_log(\"Cari silme detayları - ID: $cari_id, Stok Satış: $satisStok_deleted, Stok Alış: $alisStok_deleted, Stok Proforma: $proformaStok_deleted, Tahsilat: $tahsilat_deleted, Cari Har.: $cari_hareketleri_deleted, Satış: $satis_deleted, Alış: $alis_deleted, Proforma: $proforma_deleted, Banka: $banka_deleted, Kasa: $kasa_deleted, Çek: $cek_deleted, Senet: $senet_deleted, Aktivasyon: $aktivasyon_deleted, Potansiyel: $potansiyel_deleted\");\r\n-\t\t*/\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\tif (isset($this->db)) {\r\n+\t\t\t\t$this->db->trans_rollback();\r\n+\t\t\t}\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'error',\r\n+\t\t\t\t'message' => 'Silme işlemi sırasında hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n \t}\r\n \t\r\n \t/**\r\n \t * Tam Ana Rapor - ID: 531\r\n"
                },
                {
                    "date": 1756281179986,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2514,10 +2514,10 @@\n \t\t\t\t['table' => 'cek', 'where' => 'cek_cariID'],\r\n \t\t\t\t['table' => 'senet', 'where' => 'senet_cariID'],\r\n \t\t\t\t['table' => 'aktivasyon', 'where' => 'aktivasyon_cari_id'],\r\n \t\t\t\t['table' => 'potansiyel_satis', 'where' => 'potansiyel_cari_id'],\r\n-\t\t\t\t['table' => 'caridetaylibanka', 'where' => 'cari_id'],\r\n-\t\t\t\t['table' => 'caridetayliiletisim', 'where' => 'cari_id']\r\n+\t\t\t\t['table' => 'caridetaylibanka', 'where' => 'cdetayBanka_cariID'],\r\n+\t\t\t\t['table' => 'caridetayliiletisim', 'where' => 'cdetay_cariID']\r\n \t\t\t];\r\n \t\t\t\r\n \t\t\tforeach ($tables_to_delete as $table_info) {\r\n \t\t\t\t$this->db->where($table_info['where'], $cari_id);\r\n"
                },
                {
                    "date": 1756367338219,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2577,9 +2577,37 @@\n \t\t}\r\n \t\t\r\n \t\t$data = [];\r\n \t\t\r\n+\t\t// Arama parametrelerini al\r\n+\t\t$cari_search = $this->input->get('cari_search');\r\n+\t\t$aktivasyon_durum = $this->input->get('aktivasyon_durum');\r\n+\t\t\r\n \t\ttry {\r\n+\t\t// WHERE koşulları için dizi\r\n+\t\t$where_conditions = ['c.cari_durum = 1'];\r\n+\t\t\r\n+\t\t// Cari arama koşulu ekleme\r\n+\t\tif (!empty($cari_search)) {\r\n+\t\t\t$search_term = $this->db->escape_like_str($cari_search);\r\n+\t\t\t$where_conditions[] = \"(\r\n+\t\t\t\tc.cari_ad LIKE '%{$search_term}%' OR \r\n+\t\t\t\tc.cari_soyad LIKE '%{$search_term}%' OR \r\n+\t\t\t\tc.cari_vergiNumarasi LIKE '%{$search_term}%' OR \r\n+\t\t\t\tc.cari_firmaTelefon LIKE '%{$search_term}%' OR \r\n+\t\t\t\tc.cari_tckn LIKE '%{$search_term}%'\r\n+\t\t\t)\";\r\n+\t\t}\r\n+\t\t\r\n+\t\t// WHERE koşullarını birleştir\r\n+\t\t$where_clause = 'WHERE ' . implode(' AND ', $where_conditions);\r\n+\t\t\r\n+\t\t// Aktivasyon durum filtresi için HAVING koşulu\r\n+\t\t$having_clause = '';\r\n+\t\tif (!empty($aktivasyon_durum)) {\r\n+\t\t\t$having_clause = \"HAVING aktivasyon_durum = '\" . $this->db->escape_str($aktivasyon_durum) . \"'\";\r\n+\t\t}\r\n+\t\t\r\n \t\t// Tam Ana Rapor sorgusu\r\n \t\t$query = \"\r\n \t\t\tSELECT DISTINCT\r\n \t\t\t\tc.cari_id,\r\n@@ -2787,10 +2815,11 @@\n \t\t\t) tahsilat_gorseller ON c.cari_id = tahsilat_gorseller.ch_cariID\r\n \t\t\t\r\n \t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n \t\t\t\r\n-\t\t\tWHERE c.cari_durum = 1\r\n+\t\t\t{$where_clause}\r\n \t\t\tGROUP BY c.cari_id\r\n+\t\t\t{$having_clause}\r\n \t\t\tORDER BY \r\n \t\t\t\tCASE WHEN c.cari_olusturmaTarihi IS NULL THEN 1 ELSE 0 END,\r\n \t\t\t\tc.cari_olusturmaTarihi DESC, \r\n \t\t\t\tc.cari_ad, c.cari_soyad\r\n"
                },
                {
                    "date": 1756376046097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2883,9 +2883,9 @@\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n-\t\t\t// Tahsilat detaylarını farklı tablolardan getir - cari hareket ID'si ile birlikte\r\n+\t\t\t// Tahsilat detaylarını farklı tablolardan getir - cari hareket ID'si ve görsel alanları ile birlikte\r\n \t\t\t$query = \"\r\n \t\t\t\t-- Banka/Pos tahsilatları\r\n \t\t\t\tSELECT \r\n \t\t\t\t\tCONCAT('bh_', bh.bh_id) as unique_id,\r\n@@ -2896,9 +2896,11 @@\n \t\t\t\t\tbh.bh_giris as tutar,\r\n \t\t\t\t\tbh.bh_aciklama as aciklama,\r\n \t\t\t\t\tb.banka_bankaAd as detay,\r\n \t\t\t\t\t'1' as tip_kod,\r\n-\t\t\t\t\tch.ch_id as cari_hareket_id\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n+\t\t\t\t\tbh.bh_gorsel as gorsel_dosya,\r\n+\t\t\t\t\t'dekontlar' as gorsel_klasor\r\n \t\t\t\tFROM bankahareketleri bh\r\n \t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_bankaID = bh.bh_id AND ch.ch_cariID = bh.bh_cariID\r\n \t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n@@ -2915,9 +2917,11 @@\n \t\t\t\t\tc.cek_tutar as tutar,\r\n \t\t\t\t\tc.cek_notAciklama as aciklama,\r\n \t\t\t\t\tCONCAT('Çek No: ', c.cek_portfoyNo) as detay,\r\n \t\t\t\t\t'2' as tip_kod,\r\n-\t\t\t\t\tch.ch_id as cari_hareket_id\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n+\t\t\t\t\tc.cek_gorsel as gorsel_dosya,\r\n+\t\t\t\t\t'cekler' as gorsel_klasor\r\n \t\t\t\tFROM cek c\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_cekID = c.cek_id AND ch.ch_cariID = c.cek_cariID\r\n \t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n \t\t\t\t\r\n@@ -2933,9 +2937,11 @@\n \t\t\t\t\tkh.kh_giris as tutar,\r\n \t\t\t\t\tkh.kh_aciklama as aciklama,\r\n \t\t\t\t\tk.kasa_adi as detay,\r\n \t\t\t\t\t'3' as tip_kod,\r\n-\t\t\t\t\tch.ch_id as cari_hareket_id\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n+\t\t\t\t\tNULL as gorsel_dosya,\r\n+\t\t\t\t\tNULL as gorsel_klasor\r\n \t\t\t\tFROM kasahareketleri kh\r\n \t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_kasaID = kh.kh_id AND ch.ch_cariID = kh.kh_cariID\r\n \t\t\t\tWHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n@@ -2952,9 +2958,11 @@\n \t\t\t\t\ts.senet_tutar as tutar,\r\n \t\t\t\t\ts.senet_notAciklama as aciklama,\r\n \t\t\t\t\tCONCAT('Senet No: ', s.senet_portfoyNo) as detay,\r\n \t\t\t\t\t'4' as tip_kod,\r\n-\t\t\t\t\tch.ch_id as cari_hareket_id\r\n+\t\t\t\t\tch.ch_id as cari_hareket_id,\r\n+\t\t\t\t\ts.senet_gorsel as gorsel_dosya,\r\n+\t\t\t\t\t'senetler' as gorsel_klasor\r\n \t\t\t\tFROM senet s\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_senetID = s.senet_id AND ch.ch_cariID = s.senet_cariID\r\n \t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n \t\t\t\t\r\n@@ -2982,8 +2990,168 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n+\t * Tahsilat görsel yükleme\r\n+\t */\r\n+\tpublic function uploadTahsilatGorsel()\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t$tip = $this->input->post('tip'); // 'bh', 'cek', 'senet'\r\n+\t\t\t$id = $this->input->post('id');\r\n+\t\t\t\r\n+\t\t\tif (!$tip || !$id) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Tip ve ID gerekli']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Dosya yükleme konfigürasyonu\r\n+\t\t\t$config['upload_path'] = './assets/uploads/';\r\n+\t\t\t$config['allowed_types'] = 'gif|jpg|png|jpeg|pdf';\r\n+\t\t\t$config['max_size'] = 10240; // 10MB\r\n+\t\t\t$config['encrypt_name'] = TRUE;\r\n+\t\t\t\r\n+\t\t\t// Tip'e göre klasör belirleme\r\n+\t\t\tswitch($tip) {\r\n+\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t$config['upload_path'] .= 'dekontlar/';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t$config['upload_path'] .= 'cekler/';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'senet':\r\n+\t\t\t\t\t$config['upload_path'] .= 'senetler/';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tip']);\r\n+\t\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Klasör yoksa oluştur\r\n+\t\t\tif (!is_dir($config['upload_path'])) {\r\n+\t\t\t\tmkdir($config['upload_path'], 0777, true);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$this->load->library('upload', $config);\r\n+\t\t\t\r\n+\t\t\tif ($this->upload->do_upload('gorsel')) {\r\n+\t\t\t\t$upload_data = $this->upload->data();\r\n+\t\t\t\t$file_name = $upload_data['file_name'];\r\n+\t\t\t\t\r\n+\t\t\t\t// Veritabanını güncelle\r\n+\t\t\t\tswitch($tip) {\r\n+\t\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t\t$this->db->where('bh_id', $id);\r\n+\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_gorsel' => $file_name]);\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t\t$this->db->where('cek_id', $id);\r\n+\t\t\t\t\t\t$this->db->update('cek', ['cek_gorsel' => $file_name]);\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 'senet':\r\n+\t\t\t\t\t\t$this->db->where('senet_id', $id);\r\n+\t\t\t\t\t\t$this->db->update('senet', ['senet_gorsel' => $file_name]);\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\theader('Content-Type: application/json');\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => true,\r\n+\t\t\t\t\t'message' => 'Görsel başarıyla yüklendi',\r\n+\t\t\t\t\t'file_name' => $file_name\r\n+\t\t\t\t]);\r\n+\t\t\t} else {\r\n+\t\t\t\theader('Content-Type: application/json');\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => false,\r\n+\t\t\t\t\t'message' => 'Yükleme hatası: ' . $this->upload->display_errors('', '')\r\n+\t\t\t\t]);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Hata: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Tahsilat görsel silme\r\n+\t */\r\n+\tpublic function deleteTahsilatGorsel()\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t$tip = $this->input->post('tip');\r\n+\t\t\t$id = $this->input->post('id');\r\n+\t\t\t\r\n+\t\t\tif (!$tip || !$id) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Tip ve ID gerekli']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Mevcut dosyayı al\r\n+\t\t\t$dosya_adi = null;\r\n+\t\t\tswitch($tip) {\r\n+\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t$record = $this->db->select('bh_gorsel')->where('bh_id', $id)->get('bankahareketleri')->row();\r\n+\t\t\t\t\t$dosya_adi = $record ? $record->bh_gorsel : null;\r\n+\t\t\t\t\t$klasor = 'dekontlar';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t$record = $this->db->select('cek_gorsel')->where('cek_id', $id)->get('cek')->row();\r\n+\t\t\t\t\t$dosya_adi = $record ? $record->cek_gorsel : null;\r\n+\t\t\t\t\t$klasor = 'cekler';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'senet':\r\n+\t\t\t\t\t$record = $this->db->select('senet_gorsel')->where('senet_id', $id)->get('senet')->row();\r\n+\t\t\t\t\t$dosya_adi = $record ? $record->senet_gorsel : null;\r\n+\t\t\t\t\t$klasor = 'senetler';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tip']);\r\n+\t\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Dosyayı sil\r\n+\t\t\tif ($dosya_adi) {\r\n+\t\t\t\t$dosya_yolu = './assets/uploads/' . $klasor . '/' . $dosya_adi;\r\n+\t\t\t\tif (file_exists($dosya_yolu)) {\r\n+\t\t\t\t\tunlink($dosya_yolu);\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Veritabanını güncelle\r\n+\t\t\tswitch($tip) {\r\n+\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t$this->db->where('bh_id', $id);\r\n+\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_gorsel' => null]);\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t$this->db->where('cek_id', $id);\r\n+\t\t\t\t\t$this->db->update('cek', ['cek_gorsel' => null]);\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'senet':\r\n+\t\t\t\t\t$this->db->where('senet_id', $id);\r\n+\t\t\t\t\t$this->db->update('senet', ['senet_gorsel' => null]);\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true,\r\n+\t\t\t\t'message' => 'Görsel başarıyla silindi'\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\theader('Content-Type: application/json');\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Hata: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n \t * Tam Ana Rapor Excel Export\r\n \t */\r\n \tpublic function tam_ana_rapor_excel()\r\n \t{\r\n"
                },
                {
                    "date": 1756378349074,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2970,8 +2970,13 @@\n \t\t\t\";\r\n \t\t\t\r\n \t\t\t$result = $this->db->query($query, [$cari_id, $cari_id, $cari_id, $cari_id])->result();\r\n \t\t\t\r\n+\t\t\t// Her kayıt için çoklu görsel bilgilerini al\r\n+\t\t\tforeach ($result as $row) {\r\n+\t\t\t\t$row->gorseller = $this->getTahsilatGorselleri($row->tip_kod, $row->source_id);\r\n+\t\t\t}\r\n+\t\t\t\r\n \t\t\t// Tarihleri formatla\r\n \t\t\tforeach ($result as $row) {\r\n \t\t\t\t$row->tarih = date('d.m.Y', strtotime($row->tarih));\r\n \t\t\t}\r\n@@ -2990,10 +2995,85 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n-\t * Tahsilat görsel yükleme\r\n+\t * Tahsilat görsel listesini getir (çoklu)\r\n \t */\r\n+\tprivate function getTahsilatGorselleri($tipKod, $sourceId)\r\n+\t{\r\n+\t\t$gorseller = [];\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\tswitch($tipKod) {\r\n+\t\t\t\tcase '1': // Banka\r\n+\t\t\t\t\t$record = $this->db->select('bh_gorsel')->where('bh_id', $sourceId)->get('bankahareketleri')->row();\r\n+\t\t\t\t\tif ($record && $record->bh_gorsel) {\r\n+\t\t\t\t\t\t$dosya_listesi = explode(',', $record->bh_gorsel);\r\n+\t\t\t\t\t\t$dosya_listesi = array_filter($dosya_listesi); // Boş elemanları temizle\r\n+\t\t\t\t\t\tforeach ($dosya_listesi as $index => $dosya) {\r\n+\t\t\t\t\t\t\t$gorseller[] = [\r\n+\t\t\t\t\t\t\t\t'id' => 'bh_' . $sourceId . '_' . $index,\r\n+\t\t\t\t\t\t\t\t'dosya_adi' => $dosya,\r\n+\t\t\t\t\t\t\t\t'klasor' => 'dekontlar',\r\n+\t\t\t\t\t\t\t\t'url' => base_url('assets/uploads/dekontlar/' . $dosya),\r\n+\t\t\t\t\t\t\t\t'tip' => $index === 0 ? 'ana' : 'ek'\r\n+\t\t\t\t\t\t\t];\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '2': // Çek\r\n+\t\t\t\t\t$record = $this->db->select('cek_gorsel')->where('cek_id', $sourceId)->get('cek')->row();\r\n+\t\t\t\t\tif ($record && $record->cek_gorsel) {\r\n+\t\t\t\t\t\t$dosya_listesi = explode(',', $record->cek_gorsel);\r\n+\t\t\t\t\t\t$dosya_listesi = array_filter($dosya_listesi);\r\n+\t\t\t\t\t\tforeach ($dosya_listesi as $index => $dosya) {\r\n+\t\t\t\t\t\t\t$gorseller[] = [\r\n+\t\t\t\t\t\t\t\t'id' => 'cek_' . $sourceId . '_' . $index,\r\n+\t\t\t\t\t\t\t\t'dosya_adi' => $dosya,\r\n+\t\t\t\t\t\t\t\t'klasor' => 'cekler',\r\n+\t\t\t\t\t\t\t\t'url' => base_url('assets/uploads/cekler/' . $dosya),\r\n+\t\t\t\t\t\t\t\t'tip' => $index === 0 ? 'ana' : 'ek'\r\n+\t\t\t\t\t\t\t];\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '4': // Senet\r\n+\t\t\t\t\t$record = $this->db->select('senet_gorsel')->where('senet_id', $sourceId)->get('senet')->row();\r\n+\t\t\t\t\tif ($record && $record->senet_gorsel) {\r\n+\t\t\t\t\t\t$dosya_listesi = explode(',', $record->senet_gorsel);\r\n+\t\t\t\t\t\t$dosya_listesi = array_filter($dosya_listesi);\r\n+\t\t\t\t\t\tforeach ($dosya_listesi as $index => $dosya) {\r\n+\t\t\t\t\t\t\t$gorseller[] = [\r\n+\t\t\t\t\t\t\t\t'id' => 's_' . $sourceId . '_' . $index,\r\n+\t\t\t\t\t\t\t\t'dosya_adi' => $dosya,\r\n+\t\t\t\t\t\t\t\t'klasor' => 'senetler',\r\n+\t\t\t\t\t\t\t\t'url' => base_url('assets/uploads/senetler/' . $dosya),\r\n+\t\t\t\t\t\t\t\t'tip' => $index === 0 ? 'ana' : 'ek'\r\n+\t\t\t\t\t\t\t];\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '3': // Kasa - görsel yok\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// İleride ek görsel tablosu eklenirse burada sorgulanabilir\r\n+\t\t\t// Örnek: tahsilat_gorselleri tablosu\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata durumunda boş array dön\r\n+\t\t}\r\n+\t\t\r\n+\t\treturn $gorseller;\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Tahsilat görsel yükleme (çoklu dosya)\r\n+\t */\r\n \tpublic function uploadTahsilatGorsel()\r\n \t{\r\n \t\ttry {\r\n \t\t\t$tip = $this->input->post('tip'); // 'bh', 'cek', 'senet'\r\n@@ -3032,39 +3112,104 @@\n \t\t\t}\r\n \t\t\t\r\n \t\t\t$this->load->library('upload', $config);\r\n \t\t\t\r\n-\t\t\tif ($this->upload->do_upload('gorsel')) {\r\n-\t\t\t\t$upload_data = $this->upload->data();\r\n-\t\t\t\t$file_name = $upload_data['file_name'];\r\n+\t\t\t$uploaded_files = [];\r\n+\t\t\t$upload_errors = [];\r\n+\t\t\t\r\n+\t\t\t// Çoklu dosya kontrolü\r\n+\t\t\tif (isset($_FILES['gorseller']) && is_array($_FILES['gorseller']['name'])) {\r\n+\t\t\t\t// Çoklu dosya yükleme\r\n+\t\t\t\t$file_count = count($_FILES['gorseller']['name']);\r\n \t\t\t\t\r\n+\t\t\t\tfor ($i = 0; $i < $file_count; $i++) {\r\n+\t\t\t\t\tif ($_FILES['gorseller']['error'][$i] == 0) {\r\n+\t\t\t\t\t\t// Dosya bilgilerini tek dosya formatına çevir\r\n+\t\t\t\t\t\t$_FILES['single_file']['name'] = $_FILES['gorseller']['name'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['type'] = $_FILES['gorseller']['type'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['tmp_name'] = $_FILES['gorseller']['tmp_name'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['error'] = $_FILES['gorseller']['error'][$i];\r\n+\t\t\t\t\t\t$_FILES['single_file']['size'] = $_FILES['gorseller']['size'][$i];\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tif ($this->upload->do_upload('single_file')) {\r\n+\t\t\t\t\t\t\t$upload_data = $this->upload->data();\r\n+\t\t\t\t\t\t\t$uploaded_files[] = $upload_data['file_name'];\r\n+\t\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t\t$upload_errors[] = $this->upload->display_errors('', '');\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t} else {\r\n+\t\t\t\t// Tek dosya yükleme (mevcut sistem)\r\n+\t\t\t\tif ($this->upload->do_upload('gorsel')) {\r\n+\t\t\t\t\t$upload_data = $this->upload->data();\r\n+\t\t\t\t\t$uploaded_files[] = $upload_data['file_name'];\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t$upload_errors[] = $this->upload->display_errors('', '');\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif (!empty($uploaded_files)) {\r\n+\t\t\t\t// Mevcut dosyaları al\r\n+\t\t\t\t$existing_files = [];\r\n+\t\t\t\tswitch($tip) {\r\n+\t\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t\t$record = $this->db->select('bh_gorsel')->where('bh_id', $id)->get('bankahareketleri')->row();\r\n+\t\t\t\t\t\tif ($record && $record->bh_gorsel) {\r\n+\t\t\t\t\t\t\t// Virgülle ayrılmış string formatından array'e çevir\r\n+\t\t\t\t\t\t\t$existing_files = explode(',', $record->bh_gorsel);\r\n+\t\t\t\t\t\t\t$existing_files = array_filter($existing_files); // Boş elemanları temizle\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t\t$record = $this->db->select('cek_gorsel')->where('cek_id', $id)->get('cek')->row();\r\n+\t\t\t\t\t\tif ($record && $record->cek_gorsel) {\r\n+\t\t\t\t\t\t\t$existing_files = explode(',', $record->cek_gorsel);\r\n+\t\t\t\t\t\t\t$existing_files = array_filter($existing_files);\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 'senet':\r\n+\t\t\t\t\t\t$record = $this->db->select('senet_gorsel')->where('senet_id', $id)->get('senet')->row();\r\n+\t\t\t\t\t\tif ($record && $record->senet_gorsel) {\r\n+\t\t\t\t\t\t\t$existing_files = explode(',', $record->senet_gorsel);\r\n+\t\t\t\t\t\t\t$existing_files = array_filter($existing_files);\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t// Yeni dosyaları mevcut dosyalarla birleştir\r\n+\t\t\t\t$all_files = array_merge($existing_files, $uploaded_files);\r\n+\t\t\t\t$files_string = implode(',', $all_files);\r\n+\t\t\t\t\r\n \t\t\t\t// Veritabanını güncelle\r\n \t\t\t\tswitch($tip) {\r\n \t\t\t\t\tcase 'bh':\r\n \t\t\t\t\t\t$this->db->where('bh_id', $id);\r\n-\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_gorsel' => $file_name]);\r\n+\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_gorsel' => $files_string]);\r\n \t\t\t\t\t\tbreak;\r\n \t\t\t\t\tcase 'cek':\r\n \t\t\t\t\t\t$this->db->where('cek_id', $id);\r\n-\t\t\t\t\t\t$this->db->update('cek', ['cek_gorsel' => $file_name]);\r\n+\t\t\t\t\t\t$this->db->update('cek', ['cek_gorsel' => $files_string]);\r\n \t\t\t\t\t\tbreak;\r\n \t\t\t\t\tcase 'senet':\r\n \t\t\t\t\t\t$this->db->where('senet_id', $id);\r\n-\t\t\t\t\t\t$this->db->update('senet', ['senet_gorsel' => $file_name]);\r\n+\t\t\t\t\t\t$this->db->update('senet', ['senet_gorsel' => $files_string]);\r\n \t\t\t\t\t\tbreak;\r\n \t\t\t\t}\r\n \t\t\t\t\r\n \t\t\t\theader('Content-Type: application/json');\r\n \t\t\t\techo json_encode([\r\n \t\t\t\t\t'success' => true,\r\n-\t\t\t\t\t'message' => 'Görsel başarıyla yüklendi',\r\n-\t\t\t\t\t'file_name' => $file_name\r\n+\t\t\t\t\t'message' => count($uploaded_files) . ' görsel başarıyla yüklendi',\r\n+\t\t\t\t\t'files' => $uploaded_files,\r\n+\t\t\t\t\t'total_files' => count($all_files),\r\n+\t\t\t\t\t'errors' => $upload_errors\r\n \t\t\t\t]);\r\n \t\t\t} else {\r\n \t\t\t\theader('Content-Type: application/json');\r\n \t\t\t\techo json_encode([\r\n \t\t\t\t\t'success' => false,\r\n-\t\t\t\t\t'message' => 'Yükleme hatası: ' . $this->upload->display_errors('', '')\r\n+\t\t\t\t\t'message' => 'Yükleme hatası: ' . implode(', ', $upload_errors)\r\n \t\t\t\t]);\r\n \t\t\t}\r\n \t\t\t\r\n \t\t} catch (Exception $e) {\r\n@@ -3111,13 +3256,19 @@\n \t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tip']);\r\n \t\t\t\t\treturn;\r\n \t\t\t}\r\n \t\t\t\r\n-\t\t\t// Dosyayı sil\r\n+\t\t\t// JSON array kontrolü ve dosya silme\r\n \t\t\tif ($dosya_adi) {\r\n-\t\t\t\t$dosya_yolu = './assets/uploads/' . $klasor . '/' . $dosya_adi;\r\n-\t\t\t\tif (file_exists($dosya_yolu)) {\r\n-\t\t\t\t\tunlink($dosya_yolu);\r\n+\t\t\t\t$dosya_listesi = explode(',', $dosya_adi);\r\n+\t\t\t\t$dosya_listesi = array_filter($dosya_listesi); // Boş elemanları temizle\r\n+\t\t\t\t\r\n+\t\t\t\t// Tüm dosyaları sil\r\n+\t\t\t\tforeach ($dosya_listesi as $dosya) {\r\n+\t\t\t\t\t$dosya_yolu = './assets/uploads/' . $klasor . '/' . $dosya;\r\n+\t\t\t\t\tif (file_exists($dosya_yolu)) {\r\n+\t\t\t\t\t\tunlink($dosya_yolu);\r\n+\t\t\t\t\t}\r\n \t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t// Veritabanını güncelle\r\n"
                },
                {
                    "date": 1756394699374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2625,15 +2625,25 @@\n \t\t\t\t-- Satış sözleşmesi bilgileri (en yeni satış)\r\n \t\t\t\t(SELECT sf2.satis_id FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n \t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n \t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n-\t\t\t\t-- Stok adı bilgisi (en yeni satıştan)\r\n-\t\t\t\t(SELECT s.stok_ad \r\n+\t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - birden fazla stok göstermek için GROUP_CONCAT kullan\r\n+\t\t\t\t(SELECT GROUP_CONCAT(\r\n+\t\t\t\t\tCASE \r\n+\t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 1 THEN 'DIGITURK'\r\n+\t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 279 THEN 'S SPORT'\r\n+\t\t\t\t\t\tELSE s.stok_ad\r\n+\t\t\t\t\tEND\r\n+\t\t\t\t\tSEPARATOR ', '\r\n+\t\t\t\t )\r\n \t\t\t\t FROM satisFaturasi sf2 \r\n \t\t\t\t INNER JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf2.satis_id\r\n \t\t\t\t INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n-\t\t\t\t WHERE sf2.satis_cariID = c.cari_id \r\n-\t\t\t\t ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_hizmeti,\r\n+\t\t\t\t WHERE sf2.satis_cariID = c.cari_id AND sf2.satis_id = (\r\n+\t\t\t\t\t SELECT sf3.satis_id FROM satisFaturasi sf3 WHERE sf3.satis_cariID = c.cari_id ORDER BY sf3.satis_id DESC LIMIT 1\r\n+\t\t\t\t )\r\n+\t\t\t\t GROUP BY sf2.satis_id\r\n+\t\t\t\t) as satis_sozlesme_hizmeti,\r\n \t\t\t\t\r\n \t\t\t\t-- İşletme görsel sayısını hesapla (fotograf_dosya kolonundan)\r\n \t\t\t\tCASE \r\n \t\t\t\t\tWHEN c.fotograf_dosya IS NOT NULL AND c.fotograf_dosya != '' \r\n"
                },
                {
                    "date": 1756449570180,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4023,5 +4023,292 @@\n \t\t\terror_log(\"TUTAR GÜNCELLEME HATASI: \" . $e->getMessage());\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n+\t\r\n+\t/**\r\n+\t * Yeni tahsilat ekleme fonksiyonu\r\n+\t */\r\n+\tpublic function yeniTahsilatEkle()\r\n+\t{\r\n+\t\t$tip_kod = $this->input->post('tip_kod');\r\n+\t\t$tutar = $this->input->post('tutar');\r\n+\t\t$tarih = $this->input->post('tarih');\r\n+\t\t$belge_no = $this->input->post('belge_no');\r\n+\t\t$aciklama = $this->input->post('aciklama');\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\r\n+\t\tif (!$tip_kod || !$tutar || !$tarih || !$cari_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Gerekli alanlar eksik']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$this->db->trans_start();\r\n+\t\t\t\r\n+\t\t\t$olusturan = $this->session->userdata('kullanici_id') ?? 1;\r\n+\t\t\t$olusturanAnaHesap = $this->session->userdata('anaHesap_id') ?? 1;\r\n+\t\t\t$bugun = date('Y-m-d');\r\n+\t\t\t$suan = date('H:i:s');\r\n+\t\t\t\r\n+\t\t\t// Tip koduna göre ilgili tabloya kayıt ekle\r\n+\t\t\tswitch($tip_kod) {\r\n+\t\t\t\tcase '1': // Banka\r\n+\t\t\t\t\t$banka_data = [\r\n+\t\t\t\t\t\t'bh_belgeNumarasi' => $belge_no,\r\n+\t\t\t\t\t\t'bh_turu' => 1, // Giriş\r\n+\t\t\t\t\t\t'bh_giris' => $tutar,\r\n+\t\t\t\t\t\t'bh_cikis' => 0,\r\n+\t\t\t\t\t\t'bh_cariID' => $cari_id,\r\n+\t\t\t\t\t\t'bh_bankaID' => 1, // Varsayılan banka\r\n+\t\t\t\t\t\t'bh_tarih' => $tarih,\r\n+\t\t\t\t\t\t'bh_aciklama' => $aciklama,\r\n+\t\t\t\t\t\t'bh_olusturan' => $olusturan,\r\n+\t\t\t\t\t\t'bh_olusturanAnaHesap' => $olusturanAnaHesap,\r\n+\t\t\t\t\t\t'bh_olusturmaTarihi' => $bugun,\r\n+\t\t\t\t\t\t'bh_olusturmaSaati' => $suan,\r\n+\t\t\t\t\t\t'tahsilat_durum_id' => 2\r\n+\t\t\t\t\t];\r\n+\t\t\t\t\t$this->db->insert('bankahareketleri', $banka_data);\r\n+\t\t\t\t\t$source_id = $this->db->insert_id();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '2': // Çek\r\n+\t\t\t\t\t$cek_data = [\r\n+\t\t\t\t\t\t'cek_cariID' => $cari_id,\r\n+\t\t\t\t\t\t'cek_hareketTipi' => 1,\r\n+\t\t\t\t\t\t'cek_kayitTarihi' => $tarih,\r\n+\t\t\t\t\t\t'cek_notAciklama' => $aciklama,\r\n+\t\t\t\t\t\t'cek_portfoyNo' => $belge_no,\r\n+\t\t\t\t\t\t'cek_vadeTarih' => $tarih,\r\n+\t\t\t\t\t\t'cek_tutar' => $tutar,\r\n+\t\t\t\t\t\t'cek_durum' => 1,\r\n+\t\t\t\t\t\t'cek_kullaniciID' => $olusturan,\r\n+\t\t\t\t\t\t'cek_olusturanAnaHesap' => $olusturanAnaHesap,\r\n+\t\t\t\t\t\t'cek_sistemKayitTarihi' => $bugun,\r\n+\t\t\t\t\t\t'cek_sistemKayitSaati' => $suan\r\n+\t\t\t\t\t];\r\n+\t\t\t\t\t$this->db->insert('cek', $cek_data);\r\n+\t\t\t\t\t$source_id = $this->db->insert_id();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '3': // Kasa\r\n+\t\t\t\t\t$kasa_data = [\r\n+\t\t\t\t\t\t'kh_belgeNumarasi' => $belge_no,\r\n+\t\t\t\t\t\t'kh_turu' => 1,\r\n+\t\t\t\t\t\t'kh_giris' => $tutar,\r\n+\t\t\t\t\t\t'kh_cikis' => 0,\r\n+\t\t\t\t\t\t'kh_cariID' => $cari_id,\r\n+\t\t\t\t\t\t'kh_tarih' => $tarih,\r\n+\t\t\t\t\t\t'kh_aciklama' => $aciklama,\r\n+\t\t\t\t\t\t'kh_kasaID' => 1, // Varsayılan kasa\r\n+\t\t\t\t\t\t'kh_olusturan' => $olusturan,\r\n+\t\t\t\t\t\t'kh_olusturanAnaHesap' => $olusturanAnaHesap,\r\n+\t\t\t\t\t\t'kh_olusturmaTarihi' => $bugun,\r\n+\t\t\t\t\t\t'kh_olusturmaSaati' => $suan\r\n+\t\t\t\t\t];\r\n+\t\t\t\t\t$this->db->insert('kasahareketleri', $kasa_data);\r\n+\t\t\t\t\t$source_id = $this->db->insert_id();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase '4': // Senet\r\n+\t\t\t\t\t$senet_data = [\r\n+\t\t\t\t\t\t'senet_cariID' => $cari_id,\r\n+\t\t\t\t\t\t'senet_hareketTipi' => 1,\r\n+\t\t\t\t\t\t'senet_kayitTarihi' => $tarih,\r\n+\t\t\t\t\t\t'senet_notAciklama' => $aciklama,\r\n+\t\t\t\t\t\t'senet_portfoyNo' => $belge_no,\r\n+\t\t\t\t\t\t'senet_vadeTarih' => $tarih,\r\n+\t\t\t\t\t\t'senet_tutar' => $tutar,\r\n+\t\t\t\t\t\t'senet_durum' => 1,\r\n+\t\t\t\t\t\t'senet_kullaniciID' => $olusturan,\r\n+\t\t\t\t\t\t'senet_olusturanAnaHesap' => $olusturanAnaHesap,\r\n+\t\t\t\t\t\t'senet_sistemKayitTarihi' => $bugun,\r\n+\t\t\t\t\t\t'senet_sistemKayitSaati' => $suan\r\n+\t\t\t\t\t];\r\n+\t\t\t\t\t$this->db->insert('senet', $senet_data);\r\n+\t\t\t\t\t$source_id = $this->db->insert_id();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\tthrow new Exception('Geçersiz tahsilat tipi');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Cari hareket kaydı ekle\r\n+\t\t\t$cari_hareket_data = [\r\n+\t\t\t\t'ch_cariID' => $cari_id,\r\n+\t\t\t\t'ch_islemTarihi' => $tarih,\r\n+\t\t\t\t'ch_borc' => 0,\r\n+\t\t\t\t'ch_alacak' => $tutar,\r\n+\t\t\t\t'ch_aciklama' => $aciklama,\r\n+\t\t\t\t'ch_olusturan' => $olusturan,\r\n+\t\t\t\t'ch_olusturanAnaHesap' => $olusturanAnaHesap,\r\n+\t\t\t\t'ch_olusturmaTarihi' => $bugun,\r\n+\t\t\t\t'ch_olusturmaSaati' => $suan\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\t// İlgili ID'yi ayarla\r\n+\t\t\tswitch($tip_kod) {\r\n+\t\t\t\tcase '1': $cari_hareket_data['ch_bankaID'] = $source_id; break;\r\n+\t\t\t\tcase '2': $cari_hareket_data['ch_cekID'] = $source_id; break;\r\n+\t\t\t\tcase '3': $cari_hareket_data['ch_kasaID'] = $source_id; break;\r\n+\t\t\t\tcase '4': $cari_hareket_data['ch_senetID'] = $source_id; break;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$this->db->insert('carihareketleri', $cari_hareket_data);\r\n+\t\t\t\r\n+\t\t\t$this->db->trans_complete();\r\n+\t\t\t\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\tthrow new Exception('Veritabanı işlemi başarısız');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode(['success' => true, 'message' => 'Yeni tahsilat başarıyla eklendi']);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat eklenirken hata oluştu: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Stok görsel yükleme fonksiyonu\r\n+\t */\r\n+\tpublic function stokGorselYukle()\r\n+\t{\r\n+\t\t$satisStok_id = $this->input->post('satisStok_id');\r\n+\t\t$stok_adi = $this->input->post('stok_adi');\r\n+\t\t\r\n+\t\tif (!$satisStok_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Stok ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\tif (empty($_FILES['stok_gorseller']) || !isset($_FILES['stok_gorseller']['tmp_name'])) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Dosya seçilmedi']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$upload_path = FCPATH . 'assets/uploads/stok_gorselleri/';\r\n+\t\t\tif (!is_dir($upload_path)) {\r\n+\t\t\t\tmkdir($upload_path, 0777, true);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$uploaded_files = [];\r\n+\t\t\t$files = $_FILES['stok_gorseller'];\r\n+\t\t\t\r\n+\t\t\t// Çoklu dosya yükleme işlemi\r\n+\t\t\tfor ($i = 0; $i < count($files['tmp_name']); $i++) {\r\n+\t\t\t\tif ($files['error'][$i] == UPLOAD_ERR_OK) {\r\n+\t\t\t\t\t$tmp_name = $files['tmp_name'][$i];\r\n+\t\t\t\t\t$original_name = $files['name'][$i];\r\n+\t\t\t\t\t$size = $files['size'][$i];\r\n+\t\t\t\t\t$type = $files['type'][$i];\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Dosya boyutu kontrolü (max 10MB)\r\n+\t\t\t\t\tif ($size > 10 * 1024 * 1024) {\r\n+\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Dosya tipi kontrolü\r\n+\t\t\t\t\t$allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];\r\n+\t\t\t\t\tif (!in_array($type, $allowed_types)) {\r\n+\t\t\t\t\t\tthrow new Exception($original_name . ' dosya tipi desteklenmiyor');\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Dosya adını oluştur\r\n+\t\t\t\t\t$ext = pathinfo($original_name, PATHINFO_EXTENSION);\r\n+\t\t\t\t\t$filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n+\t\t\t\t\t$filepath = $upload_path . $filename;\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Dosyayı yükle\r\n+\t\t\t\t\tif (move_uploaded_file($tmp_name, $filepath)) {\r\n+\t\t\t\t\t\t$uploaded_files[] = $filename;\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası yüklenemedi');\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif (empty($uploaded_files)) {\r\n+\t\t\t\tthrow new Exception('Hiçbir dosya yüklenemedi');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Mevcut görsel listesini al\r\n+\t\t\t$current_record = $this->db->select('satisStok_gorsel')->where('satisStok_id', $satisStok_id)->get('satisstok')->row();\r\n+\t\t\t$current_images = [];\r\n+\t\t\t\r\n+\t\t\tif ($current_record && $current_record->satisStok_gorsel) {\r\n+\t\t\t\t$current_images = explode(',', $current_record->satisStok_gorsel);\r\n+\t\t\t\t$current_images = array_filter($current_images);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Yeni dosyaları ekle\r\n+\t\t\t$all_images = array_merge($current_images, $uploaded_files);\r\n+\t\t\t$image_string = implode(',', $all_images);\r\n+\t\t\t\r\n+\t\t\t// Veritabanını güncelle\r\n+\t\t\t$this->db->where('satisStok_id', $satisStok_id);\r\n+\t\t\t$this->db->update('satisstok', ['satisStok_gorsel' => $image_string]);\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true, \r\n+\t\t\t\t'message' => count($uploaded_files) . ' dosya başarıyla yüklendi',\r\n+\t\t\t\t'uploaded_files' => $uploaded_files\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Stok görsel silme fonksiyonu\r\n+\t */\r\n+\tpublic function stokGorselSil()\r\n+\t{\r\n+\t\t$gorsel_id = $this->input->post('gorsel_id');\r\n+\t\t$satisStok_id = $this->input->post('satisStok_id');\r\n+\t\t\r\n+\t\tif (!$gorsel_id || !$satisStok_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Gerekli parametreler eksik']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Dosya adını görsel ID'den çıkar\r\n+\t\t\t$filename_parts = explode('_', $gorsel_id);\r\n+\t\t\t$filename = end($filename_parts);\r\n+\t\t\t\r\n+\t\t\t// Mevcut görsel listesini al\r\n+\t\t\t$current_record = $this->db->select('satisStok_gorsel')->where('satisStok_id', $satisStok_id)->get('satisstok')->row();\r\n+\t\t\t\r\n+\t\t\tif (!$current_record || !$current_record->satisStok_gorsel) {\r\n+\t\t\t\tthrow new Exception('Görsel bulunamadı');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$current_images = explode(',', $current_record->satisStok_gorsel);\r\n+\t\t\t$current_images = array_filter($current_images);\r\n+\t\t\t\r\n+\t\t\t// Silinecek dosyayı listeden çıkar\r\n+\t\t\t$updated_images = array_filter($current_images, function($img) use ($filename) {\r\n+\t\t\t\treturn $img !== $filename;\r\n+\t\t\t});\r\n+\t\t\t\r\n+\t\t\t// Veritabanını güncelle\r\n+\t\t\t$image_string = implode(',', $updated_images);\r\n+\t\t\t$this->db->where('satisStok_id', $satisStok_id);\r\n+\t\t\t$this->db->update('satisstok', ['satisStok_gorsel' => $image_string]);\r\n+\t\t\t\r\n+\t\t\t// Dosyayı fiziksel olarak sil\r\n+\t\t\t$file_path = FCPATH . 'assets/uploads/stok_gorselleri/' . $filename;\r\n+\t\t\tif (file_exists($file_path)) {\r\n+\t\t\t\tunlink($file_path);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode(['success' => true, 'message' => 'Görsel başarıyla silindi']);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1756560711407,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3645,27 +3645,31 @@\n \t\t\t\t\tcontinue;\r\n \t\t\t\t}\r\n \t\t\t\t\r\n \t\t\t\t$miktar = floatval($stok['miktar']);\r\n-\t\t\t\t$birim_fiyat = floatval($stok['birim_fiyat']);\r\n+\t\t\t\t$birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']); // Frontend'den KDV dahil fiyat geliyor\r\n \t\t\t\t$kdv_orani = floatval($stok['kdv_orani']);\r\n \t\t\t\t\r\n-\t\t\t\t$ara_toplam = $miktar * $birim_fiyat;\r\n-\t\t\t\t$kdv_tutari = $ara_toplam * ($kdv_orani / 100);\r\n-\t\t\t\t$toplam_satir = $ara_toplam + $kdv_tutari;\r\n+\t\t\t\t// KDV dahil fiyattan KDV hariç fiyatı hesapla\r\n+\t\t\t\t$birim_fiyat_kdv_haric = $birim_fiyat_kdv_dahil / (1 + ($kdv_orani / 100));\r\n \t\t\t\t\r\n-\t\t\t\t$toplam_tutar += $ara_toplam;\r\n-\t\t\t\t$toplam_kdv_dahil += $toplam_satir;\r\n+\t\t\t\t// Satır toplamları (KDV dahil fiyat kullanarak)\r\n+\t\t\t\t$toplam_satir_kdv_dahil = $miktar * $birim_fiyat_kdv_dahil;\r\n+\t\t\t\t$toplam_satir_kdv_haric = $miktar * $birim_fiyat_kdv_haric;\r\n+\t\t\t\t$kdv_tutari = $toplam_satir_kdv_dahil - $toplam_satir_kdv_haric;\r\n \t\t\t\t\r\n+\t\t\t\t$toplam_tutar += $toplam_satir_kdv_haric;\r\n+\t\t\t\t$toplam_kdv_dahil += $toplam_satir_kdv_dahil;\r\n+\t\t\t\t\r\n \t\t\t\t$insert_data = [\r\n \t\t\t\t\t'satisStok_satisFaturasiID' => $satis_id,\r\n \t\t\t\t\t'satisStok_stokID' => !empty($stok['stok_id']) ? $stok['stok_id'] : null,\r\n \t\t\t\t\t'satisStok_stokAdi' => $stok['stok_adi'],\r\n \t\t\t\t\t'satisStok_miktar' => $miktar,\r\n-\t\t\t\t\t'satisStok_birimFiyat' => $birim_fiyat,\r\n+\t\t\t\t\t'satisStok_birimFiyat' => $birim_fiyat_kdv_dahil, // KDV dahil birim fiyat\r\n \t\t\t\t\t'satisStok_kdv' => $kdv_orani,\r\n \t\t\t\t\t'satisStok_kdvTutar' => $kdv_tutari,\r\n-\t\t\t\t\t'satisStok_toplam' => $toplam_satir,\r\n+\t\t\t\t\t'satisStok_toplam' => $toplam_satir_kdv_dahil, // Toplam KDV dahil\r\n \t\t\t\t\t'satisStok_olusturmaTarihi' => date('Y-m-d H:i:s'),\r\n \t\t\t\t\t'satisStok_olusturan' => $user_id\r\n \t\t\t\t];\r\n \t\t\t\t\r\n"
                },
                {
                    "date": 1756721246097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2625,8 +2625,10 @@\n \t\t\t\t-- Satış sözleşmesi bilgileri (en yeni satış)\r\n \t\t\t\t(SELECT sf2.satis_id FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n \t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n \t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n+\t\t\t\t-- Toplam satış sayısı\r\n+\t\t\t\t(SELECT COUNT(*) FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id) as toplam_satis_sayisi,\r\n \t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - birden fazla stok göstermek için GROUP_CONCAT kullan\r\n \t\t\t\t(SELECT GROUP_CONCAT(\r\n \t\t\t\t\tCASE \r\n \t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 1 THEN 'DIGITURK'\r\n@@ -4314,5 +4316,41 @@\n \t\t} catch (Exception $e) {\r\n \t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Satış listesi getir - AJAX test\r\n+\t */\r\n+\tpublic function testSatisList()\r\n+\t{\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\r\n+\t\tif (!$cari_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\t// Çok basit test - sadece mock data\r\n+\t\t$satislar = [\r\n+\t\t\t[\r\n+\t\t\t\t'satis_id' => 1,\r\n+\t\t\t\t'satis_sozlesme_tutari' => '1,500.00',\r\n+\t\t\t\t'tarih' => '15.08.2025',\r\n+\t\t\t\t'satis_sozlesme_hizmet' => 'DIGITURK',\r\n+\t\t\t\t'gorsel_sayisi' => 2\r\n+\t\t\t],\r\n+\t\t\t[\r\n+\t\t\t\t'satis_id' => 2,\r\n+\t\t\t\t'satis_sozlesme_tutari' => '2,300.00',\r\n+\t\t\t\t'tarih' => '20.08.2025',\r\n+\t\t\t\t'satis_sozlesme_hizmet' => 'S SPORT',\r\n+\t\t\t\t'gorsel_sayisi' => 0\r\n+\t\t\t]\r\n+\t\t];\r\n+\r\n+\t\techo json_encode([\r\n+\t\t\t'success' => true,\r\n+\t\t\t'satislar' => $satislar\r\n+\t\t]);\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1756809248145,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4352,5 +4352,124 @@\n \t\t\t'success' => true,\r\n \t\t\t'satislar' => $satislar\r\n \t\t]);\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Stok dropdown için JSON endpoint\r\n+\t */\r\n+\tpublic function stok_dropdown()\r\n+\t{\r\n+\t\t// JSON header\r\n+\t\theader('Content-Type: application/json; charset=utf-8');\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Arama terimi al\r\n+\t\t\t$search_term = $this->input->get('q') ? trim($this->input->get('q')) : '';\r\n+\t\t\tif (empty($search_term)) {\r\n+\t\t\t\t$search_term = $this->input->post('q') ? trim($this->input->post('q')) : '';\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Basit stok sorgusu - tüm aktif stokları getir\r\n+\t\t\t$this->db->select('stok_id, stok_ad, stok_kodu, stok_satisFiyati, stok_satisKDV');\r\n+\t\t\t$this->db->from('stok');\r\n+\t\t\t$this->db->where('stok_durum', 1);\r\n+\t\t\t$this->db->where('stok_ad IS NOT NULL');\r\n+\t\t\t$this->db->where('stok_ad !=', '');\r\n+\r\n+\t\t\t// Arama terimi varsa ekle\r\n+\t\t\tif (!empty($search_term)) {\r\n+\t\t\t\t$this->db->group_start();\r\n+\t\t\t\t$this->db->like('stok_ad', $search_term);\r\n+\t\t\t\t$this->db->or_like('stok_kodu', $search_term);\r\n+\t\t\t\t$this->db->group_end();\r\n+\t\t\t}\r\n+\r\n+\t\t\t$this->db->order_by('stok_ad', 'ASC');\r\n+\t\t\t$this->db->limit(50);\r\n+\r\n+\t\t\t$query = $this->db->get();\r\n+\t\t\t$results = $query->result();\r\n+\r\n+\t\t\t// Select2 formatına uygun sonuçları hazırla\r\n+\t\t\t$formatted_results = [];\r\n+\t\t\t\r\n+\t\t\t// Boş seçenek ekle (sadece arama terimi yoksa)\r\n+\t\t\tif (empty($search_term)) {\r\n+\t\t\t\t$formatted_results[] = [\r\n+\t\t\t\t\t'id' => '',\r\n+\t\t\t\t\t'text' => 'Stok seçiniz...',\r\n+\t\t\t\t\t'stok_data' => null\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\tforeach ($results as $row) {\r\n+\t\t\t\t// Stok adı boşsa atla\r\n+\t\t\t\tif (empty($row->stok_ad)) {\r\n+\t\t\t\t\tcontinue;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t$display_text = $row->stok_ad;\r\n+\t\t\t\tif (!empty($row->stok_kodu)) {\r\n+\t\t\t\t\t$display_text .= \" (Kod: {$row->stok_kodu})\";\r\n+\t\t\t\t}\r\n+\t\t\t\tif (!empty($row->stok_satisFiyati) && $row->stok_satisFiyati > 0) {\r\n+\t\t\t\t\t$display_text .= \" - \" . number_format($row->stok_satisFiyati, 2) . \" ₺\";\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t$formatted_results[] = [\r\n+\t\t\t\t\t'id' => $row->stok_id,\r\n+\t\t\t\t\t'text' => $display_text,\r\n+\t\t\t\t\t'stok_data' => [\r\n+\t\t\t\t\t\t'stok_id' => $row->stok_id,\r\n+\t\t\t\t\t\t'stok_kodu' => $row->stok_kodu ?? '',\r\n+\t\t\t\t\t\t'stok_ad' => $row->stok_ad,\r\n+\t\t\t\t\t\t'stok_satisFiyati' => floatval($row->stok_satisFiyati ?? 0),\r\n+\t\t\t\t\t\t'stok_satisKDV' => floatval($row->stok_satisKDV ?? 20)\r\n+\t\t\t\t\t]\r\n+\t\t\t\t];\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Hiç sonuç yoksa mesaj göster\r\n+\t\t\tif (count($formatted_results) <= 1) { // 1 çünkü boş seçenek var\r\n+\t\t\t\tif (!empty($search_term)) {\r\n+\t\t\t\t\t$formatted_results = [\r\n+\t\t\t\t\t\t[\r\n+\t\t\t\t\t\t\t'id' => '',\r\n+\t\t\t\t\t\t\t'text' => \"'{$search_term}' için sonuç bulunamadı\",\r\n+\t\t\t\t\t\t\t'disabled' => true\r\n+\t\t\t\t\t\t]\r\n+\t\t\t\t\t];\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t$formatted_results = [\r\n+\t\t\t\t\t\t[\r\n+\t\t\t\t\t\t\t'id' => '',\r\n+\t\t\t\t\t\t\t'text' => 'Aktif stok bulunamadı',\r\n+\t\t\t\t\t\t\t'disabled' => true\r\n+\t\t\t\t\t\t]\r\n+\t\t\t\t\t];\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Select2 yanıt formatı\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'results' => $formatted_results,\r\n+\t\t\t\t'pagination' => [\r\n+\t\t\t\t\t'more' => count($results) >= 50\r\n+\t\t\t\t]\r\n+\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata işleme\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'results' => [\r\n+\t\t\t\t\t[\r\n+\t\t\t\t\t\t'id' => '',\r\n+\t\t\t\t\t\t'text' => 'Hata: ' . $e->getMessage(),\r\n+\t\t\t\t\t\t'disabled' => true\r\n+\t\t\t\t\t]\r\n+\t\t\t\t],\r\n+\t\t\t\t'error' => $e->getMessage()\r\n+\t\t\t], JSON_UNESCAPED_UNICODE);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757070299238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1433,9 +1433,9 @@\n \t\t// Konum tipleri - Veritabanından doğru tablo adını kullanarak getir\r\n \r\n \t\ttry {\r\n \r\n-\t\t\t$data['konum_tipleri'] = $this->db->query(\"SELECT skt_id as kt_id, skt_adi as kt_ad, skt_renk as kt_renk, skt_ikon as kt_ikon, skt_sira_no as kt_sira FROM senet_konum_tipleri WHERE skt_aktif = '1' ORDER BY skt_sira_no ASC\")->result();\r\n+\t\t\t$data['konum_tipleri'] = $this->db->query(\"SELECT skt_id as kt_id, skt_adi as kt_ad, skt_renk as kt_ikon, skt_sira_no as kt_sira FROM senet_konum_tipleri WHERE skt_aktif = '1' ORDER BY skt_sira_no ASC\")->result();\r\n \r\n \t\t} catch (Exception $e) {\r\n \r\n \t\t\t// Eğer tablo hata verirse fallback data kullan\r\n@@ -2782,9 +2782,9 @@\n \t\t\t\tWHERE bh_cariID IS NOT NULL\r\n \t\t\t\tGROUP BY bh_cariID\r\n \t\t\t) banka_gorseller ON c.cari_id = banka_gorseller.bh_cariID\r\n \t\t\t\r\n-\t\t\t-- Çek görselleri sayısını al\r\n+\t\t\t-- Çek görsel sayısını al\r\n \t\t\tLEFT JOIN (\r\n \t\t\t\tSELECT \r\n \t\t\t\t\tcek_cariID,\r\n \t\t\t\t\tCOUNT(CASE WHEN cek_gorsel IS NOT NULL AND cek_gorsel != '' THEN 1 END) as cek_gorsel_sayisi\r\n@@ -2792,9 +2792,9 @@\n \t\t\t\tWHERE cek_cariID IS NOT NULL\r\n \t\t\t\tGROUP BY cek_cariID\r\n \t\t\t) cek_gorseller ON c.cari_id = cek_gorseller.cek_cariID\r\n \t\t\t\r\n-\t\t\t-- Senet görselleri sayısını al\r\n+\t\t\t-- Senet görsel sayısını al\r\n \t\t\tLEFT JOIN (\r\n \t\t\t\tSELECT \r\n \t\t\t\t\tsenet_cariID,\r\n \t\t\t\t\tCOUNT(CASE WHEN senet_gorsel IS NOT NULL AND senet_gorsel != '' THEN 1 END) as senet_gorsel_sayisi\r\n@@ -2910,9 +2910,10 @@\n \t\t\t\t\tb.banka_bankaAd as detay,\r\n \t\t\t\t\t'1' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\tbh.bh_gorsel as gorsel_dosya,\r\n-\t\t\t\t\t'dekontlar' as gorsel_klasor\r\n+\t\t\t\t\t'dekontlar' as gorsel_klasor,\r\n+\t\t\t\t\tNULL as vade_tarih\r\n \t\t\t\tFROM bankahareketleri bh\r\n \t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_bankaID = bh.bh_id AND ch.ch_cariID = bh.bh_cariID\r\n \t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n@@ -2931,9 +2932,10 @@\n \t\t\t\t\tCONCAT('Çek No: ', c.cek_portfoyNo) as detay,\r\n \t\t\t\t\t'2' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\tc.cek_gorsel as gorsel_dosya,\r\n-\t\t\t\t\t'cekler' as gorsel_klasor\r\n+\t\t\t\t\t'cekler' as gorsel_klasor,\r\n+\t\t\t\t\tc.cek_vadeTarih as vade_tarih\r\n \t\t\t\tFROM cek c\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_cekID = c.cek_id AND ch.ch_cariID = c.cek_cariID\r\n \t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n \t\t\t\t\r\n@@ -2951,9 +2953,10 @@\n \t\t\t\t\tk.kasa_adi as detay,\r\n \t\t\t\t\t'3' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\tNULL as gorsel_dosya,\r\n-\t\t\t\t\tNULL as gorsel_klasor\r\n+\t\t\t\t\tNULL as gorsel_klasor,\r\n+\t\t\t\t\tNULL as vade_tarih\r\n \t\t\t\tFROM kasahareketleri kh\r\n \t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_kasaID = kh.kh_id AND ch.ch_cariID = kh.kh_cariID\r\n \t\t\t\tWHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n@@ -2972,9 +2975,10 @@\n \t\t\t\t\tCONCAT('Senet No: ', s.senet_portfoyNo) as detay,\r\n \t\t\t\t\t'4' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\ts.senet_gorsel as gorsel_dosya,\r\n-\t\t\t\t\t'senetler' as gorsel_klasor\r\n+\t\t\t\t\t'senetler' as gorsel_klasor,\r\n+\t\t\t\t\ts.senet_vadeTarih as vade_tarih\r\n \t\t\t\tFROM senet s\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_senetID = s.senet_id AND ch.ch_cariID = s.senet_cariID\r\n \t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n \t\t\t\t\r\n@@ -2990,8 +2994,14 @@\n \t\t\t\r\n \t\t\t// Tarihleri formatla\r\n \t\t\tforeach ($result as $row) {\r\n \t\t\t\t$row->tarih = date('d.m.Y', strtotime($row->tarih));\r\n+\t\t\t\t// Vade tarihini formatla (sadece çek ve senet için)\r\n+\t\t\t\tif ($row->vade_tarih) {\r\n+\t\t\t\t\t$row->vade_tarih_formatted = date('d.m.Y', strtotime($row->vade_tarih));\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t$row->vade_tarih_formatted = '-';\r\n+\t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\techo json_encode([\r\n \t\t\t\t'success' => true,\r\n@@ -3304,734 +3314,113 @@\n \t\t\t\t'message' => 'Görsel başarıyla silindi'\r\n \t\t\t]);\r\n \t\t\t\r\n \t\t} catch (Exception $e) {\r\n-\t\t\theader('Content-Type: application/json');\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'success' => false,\r\n-\t\t\t\t'message' => 'Hata: ' . $e->getMessage()\r\n-\t\t\t]);\r\n+\t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n-\t * Tam Ana Rapor Excel Export\r\n+\t * Tahsilat güncelleme (tutar ve vade tarihi)\r\n \t */\r\n-\tpublic function tam_ana_rapor_excel()\r\n+\tpublic function tahsilatGuncelle()\r\n \t{\r\n-\t\t// Yetki kontrolü\r\n-\t\tif (!grup_modul_yetkisi_var(531)) {\r\n-\t\t\tredirect(base_url(\"illegal\"));\r\n-\t\t}\r\n-\t\t\r\n-\t\t// Autoload PhpSpreadsheet\r\n-\t\trequire_once FCPATH . 'vendor/autoload.php';\r\n-\t\t\r\n-\t\ttry {\r\n-\t\t\t// Memory limit artır\r\n-\t\t\tini_set('memory_limit', '512M');\r\n-\t\t\tini_set('max_execution_time', 600);\r\n-\t\t\t\r\n-\t\t\t// Basitleştirilmiş sorgu kullan - sadece temel bilgiler\r\n-\t\t\t$query = \"\r\n-\t\t\t\tSELECT \r\n-\t\t\t\t\tc.cari_id,\r\n-\t\t\t\t\tc.cari_ad,\r\n-\t\t\t\t\tc.cari_soyad,\r\n-\t\t\t\t\tCASE \r\n-\t\t\t\t\t\tWHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n-\t\t\t\t\t\tTHEN c.cari_ad \r\n-\t\t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n-\t\t\t\t\tEND as cari_isletme,\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t-- Kayıt tarihi\r\n-\t\t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t-- Satış sözleşmesi bilgileri (en yeni)\r\n-\t\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - Excel için eklendi\r\n-\t\t\t\t\t(SELECT s.stok_ad \r\n-\t\t\t\t\t FROM satisFaturasi sf2 \r\n-\t\t\t\t\t INNER JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf2.satis_id\r\n-\t\t\t\t\t INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n-\t\t\t\t\t WHERE sf2.satis_cariID = c.cari_id \r\n-\t\t\t\t\t ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_hizmeti,\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t-- Tahsilat tutarı\r\n-\t\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t-- Aktivasyon durumu (en yeni aktivasyon)\r\n-\t\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_adi, 'Tanımlanmamış') \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum,\r\n-\t\t\t\t\t \r\n-\t\t\t\t\t(SELECT a2.aktivasyon_tarihi \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_tarihi,\r\n-\t\t\t\t\t \r\n-\t\t\t\t\t(SELECT a2.olusturma_tarihi \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as olusturma_tarihi,\r\n-\t\t\t\t\t \r\n-\t\t\t\t\t(SELECT a2.aktivasyon_uye_no \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_uye_no,\r\n-\t\t\t\t\t \r\n-\t\t\t\t\t(SELECT a2.aktivasyon_kutu_no \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kutu_no,\r\n-\t\t\t\t\t \r\n-\t\t\t\t\t(SELECT a2.aktivasyon_kart_no \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kart_no,\r\n-\t\t\t\t\t \r\n-\t\t\t\t\t(SELECT a2.aktivasyon_kampanya_kodu \r\n-\t\t\t\t\t FROM aktivasyon a2 \r\n-\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n-\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_kampanya_kodu,\r\n-\t\t\t\t\t\r\n-\t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n-\t\t\t\t\t\r\n-\t\t\t\tFROM cari c\r\n-\t\t\t\t\r\n-\t\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap\r\n-\t\t\t\tLEFT JOIN (\r\n-\t\t\t\t\tSELECT \r\n-\t\t\t\t\t\tc2.cari_id,\r\n-\t\t\t\t\t\t(\r\n-\t\t\t\t\t\t\t-- Banka/Pos tahsilatları\r\n-\t\t\t\t\t\t\tCOALESCE((SELECT SUM(bh.bh_giris) FROM bankahareketleri bh WHERE bh.bh_cariID = c2.cari_id), 0) +\r\n-\t\t\t\t\t\t\t-- Çek tahsilatları  \r\n-\t\t\t\t\t\t\tCOALESCE((SELECT SUM(ck.cek_tutar) FROM cek ck WHERE ck.cek_cariID = c2.cari_id), 0) +\r\n-\t\t\t\t\t\t\t-- Kasa/Nakit tahsilatları\r\n-\t\t\t\t\t\t\tCOALESCE((SELECT SUM(kh.kh_giris) FROM kasahareketleri kh WHERE kh.kh_cariID = c2.cari_id), 0) +\r\n-\t\t\t\t\t\t\t-- Senet tahsilatları\r\n-\t\t\t\t\t\t\tCOALESCE((SELECT SUM(s.senet_tutar) FROM senet s WHERE s.senet_cariID = c2.cari_id), 0)\r\n-\t\t\t\t\t\t) as toplam_tahsilat\r\n-\t\t\t\t\tFROM cari c2\r\n-\t\t\t\t) ch_toplam ON c.cari_id = ch_toplam.cari_id\r\n-\t\t\t\t\r\n-\t\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n-\t\t\t\t\r\n-\t\t\t\tWHERE c.cari_durum = 1\r\n-\t\t\t\tGROUP BY c.cari_id\r\n-\t\t\t\tORDER BY \r\n-\t\t\t\t\tCASE WHEN c.cari_olusturmaTarihi IS NULL THEN 1 ELSE 0 END,\r\n-\t\t\t\t\tc.cari_olusturmaTarihi DESC, \r\n-\t\t\t\t\tc.cari_ad, c.cari_soyad\r\n-\t\t\t\";\r\n-\t\t\t\t\r\n-\t\t\t$rapor_verileri = $this->db->query($query)->result();\r\n-\t\t\t\r\n-\t\t\t// PhpSpreadsheet ile Excel oluştur\r\n-\t\t\t$spreadsheet = new \\PhpOffice\\PhpSpreadsheet\\Spreadsheet();\r\n-\t\t\t$sheet = $spreadsheet->getActiveSheet();\r\n-\t\t\t$sheet->setTitle('Tam Ana Rapor');\r\n-\t\t\t\r\n-\t\t\t// Başlıkları ayarla\r\n-\t\t\t$headers = [\r\n-\t\t\t\t'A1' => 'Tarih',\r\n-\t\t\t\t'B1' => 'İşletme',\r\n-\t\t\t\t'C1' => 'Satış Sözleşme Tutarı',\r\n-\t\t\t\t'D1' => 'Satış Sözleşme Hizmeti',\r\n-\t\t\t\t'E1' => 'Tahsilat Tutarı',\r\n-\t\t\t\t'F1' => 'Aktivasyon Durumu',\r\n-\t\t\t\t'G1' => 'Aktivasyon Tarihi',\r\n-\t\t\t\t'H1' => 'Üye No',\r\n-\t\t\t\t'I1' => 'Kutu No', \r\n-\t\t\t\t'J1' => 'Kart No',\r\n-\t\t\t\t'K1' => 'Kampanya Kodu',\r\n-\t\t\t\t'L1' => 'Personel'\r\n-\t\t\t];\r\n-\t\t\t\r\n-\t\t\tforeach ($headers as $cell => $value) {\r\n-\t\t\t\t$sheet->setCellValue($cell, $value);\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Başlık stilini ayarla\r\n-\t\t\t$headerStyle = [\r\n-\t\t\t\t'font' => ['bold' => true, 'color' => ['rgb' => 'FFFFFF']],\r\n-\t\t\t\t'fill' => ['fillType' => \\PhpOffice\\PhpSpreadsheet\\Style\\Fill::FILL_SOLID, 'color' => ['rgb' => '4472C4']],\r\n-\t\t\t\t'alignment' => ['horizontal' => \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::HORIZONTAL_CENTER],\r\n-\t\t\t\t'borders' => ['allBorders' => ['borderStyle' => \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN]]\r\n-\t\t\t];\r\n-\t\t\t\r\n-\t\t\t$sheet->getStyle('A1:L1')->applyFromArray($headerStyle);\r\n-\t\t\t\r\n-\t\t\t// Veriları ekle\r\n-\t\t\t$row = 2;\r\n-\t\t\tforeach ($rapor_verileri as $veri) {\r\n-\t\t\t\t$display_date = $veri->aktivasyon_tarihi ?? $veri->olusturma_tarihi;\r\n-\t\t\t\t$formatted_date = $display_date ? date('d.m.Y H:i:s', strtotime($display_date)) : '-';\r\n-\t\t\t\t$kayit_tarih_formatted = $veri->kayit_tarihi ? date('d.m.Y', strtotime($veri->kayit_tarihi)) : '-';\r\n-\t\t\t\t\r\n-\t\t\t\t$sheet->setCellValue('A' . $row, $kayit_tarih_formatted);\r\n-\t\t\t\t$sheet->setCellValue('B' . $row, $veri->cari_isletme ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('C' . $row, $veri->satis_sozlesme_tutar ? number_format($veri->satis_sozlesme_tutar, 2, ',', '.') . ' ₺' : '-');\r\n-\t\t\t\t$sheet->setCellValue('D' . $row, $veri->satis_sozlesme_hizmeti ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('E' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') . ' ₺' : '-');\r\n-\t\t\t\t$sheet->setCellValue('F' . $row, $veri->aktivasyon_durum ?? 'Tanımlanmamış');\r\n-\t\t\t\t$sheet->setCellValue('G' . $row, $formatted_date);\r\n-\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_uye_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('I' . $row, $veri->aktivasyon_kutu_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('J' . $row, $veri->aktivasyon_kart_no ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('K' . $row, $veri->aktivasyon_kampanya_kodu ?? '-');\r\n-\t\t\t\t$sheet->setCellValue('L' . $row, $veri->personel ?? '-');\r\n-\t\t\t\t\r\n-\t\t\t\t$row++;\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Sütun genişliklerini ayarla\r\n-\t\t\tforeach (range('A', 'K') as $column) {\r\n-\t\t\t\t$sheet->getColumnDimension($column)->setAutoSize(true);\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Tüm veriler için border ekle\r\n-\t\t\t$dataStyle = [\r\n-\t\t\t\t'borders' => ['allBorders' => ['borderStyle' => \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN]]\r\n-\t\t\t];\r\n-\t\t\t$sheet->getStyle('A1:J' . ($row - 1))->applyFromArray($dataStyle);\r\n-\t\t\t\r\n-\t\t\t// Excel dosyasını oluştur ve indir\r\n-\t\t\t$filename = 'Tam_Ana_Rapor_' . date('Y_m_d_H_i_s') . '.xlsx';\r\n-\t\t\t\r\n-\t\t\theader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n-\t\t\theader('Content-Disposition: attachment;filename=\"' . $filename . '\"');\r\n-\t\t\theader('Cache-Control: max-age=0');\r\n-\t\t\t\r\n-\t\t\t$writer = new \\PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx($spreadsheet);\r\n-\t\t\t$writer->save('php://output');\r\n-\t\t\t\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\t// Hata durumunda kullanıcıyı bilgilendir\r\n-\t\t\t$this->session->set_flashdata('excel_hata', 'Excel dosyası oluşturulurken hata oluştu: ' . $e->getMessage());\r\n-\t\t\tredirect('muhasebe/tam-ana-rapor');\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Satış faturasındaki stok bilgilerini getir (AJAX)\r\n-\t */\r\n-\tpublic function getStokBilgileri()\r\n-\t{\r\n-\t\t// JSON response header\r\n \t\theader('Content-Type: application/json');\r\n \t\t\r\n-\t\t// Geçici olarak session kontrolünü bypass et\r\n-\t\t$bypass_session = true;\r\n-\t\tif (!$bypass_session) {\r\n-\t\t\t$control = session(\"r\", \"login\");\r\n-\t\t\tif (!$control) {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Session hatası']);\r\n-\t\t\t\treturn;\r\n-\t\t\t}\r\n-\t\t}\r\n-\t\t\r\n-\t\t// Geçici olarak yetki kontrolünü bypass et\r\n-\t\t/*\r\n-\t\tif (!grup_modul_yetkisi_var(531)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Yetki hatası']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t*/\r\n-\t\t\r\n-\t\t// POST verilerini al - IIS uyumlu\r\n-\t\t$raw_post = file_get_contents('php://input');\r\n-\t\tparse_str($raw_post, $post_data);\r\n-\t\t\r\n-\t\t$satis_id = $this->input->post('satis_id') ?: (isset($_POST['satis_id']) ? $_POST['satis_id'] : (isset($post_data['satis_id']) ? $post_data['satis_id'] : null));\r\n-\t\t$cari_id = $this->input->post('cari_id') ?: (isset($_POST['cari_id']) ? $_POST['cari_id'] : (isset($post_data['cari_id']) ? $post_data['cari_id'] : null));\r\n-\t\t\r\n-\t\terror_log(\"DEBUG: getStokBilgileri called with satis_id: $satis_id, cari_id: $cari_id\");\r\n-\t\terror_log(\"DEBUG: POST data: \" . print_r($_POST, true));\r\n-\t\terror_log(\"DEBUG: Raw POST: \" . $raw_post);\r\n-\t\terror_log(\"DEBUG: Parsed POST: \" . print_r($post_data, true));\r\n-\t\terror_log(\"DEBUG: CodeIgniter input: \" . print_r($this->input->post(), true));\r\n-\t\t\r\n-\t\tif (!$satis_id) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Satış ID bilgisi eksik', 'debug' => [\r\n-\t\t\t\t'post' => $_POST,\r\n-\t\t\t\t'raw_post' => $raw_post,\r\n-\t\t\t\t'parsed_post' => $post_data,\r\n-\t\t\t\t'ci_input' => $this->input->post()\r\n-\t\t\t]]);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n \t\ttry {\r\n-\t\t\t// Stok bilgilerini çek\r\n-\t\t\t$query = \"\r\n-\t\t\t\tSELECT \r\n-\t\t\t\t\tsfs.satisStok_id,\r\n-\t\t\t\t\tsfs.satisStok_satisFaturasiID,\r\n-\t\t\t\t\tsfs.satisStok_stokID as stok_id,\r\n-\t\t\t\t\tsfs.satisStok_stokAdi as stok_adi,\r\n-\t\t\t\t\tsfs.satisStok_miktar,\r\n-\t\t\t\t\tsfs.satisStok_birimFiyat,\r\n-\t\t\t\t\tsfs.satisStok_kdv,\r\n-\t\t\t\t\ts.stok_kodu,\r\n-\t\t\t\t\ts.stok_birim,\r\n-\t\t\t\t\ts.stok_satisFiyat1\r\n-\t\t\t\tFROM satisFaturasiStok sfs\r\n-\t\t\t\tLEFT JOIN stok s ON s.stok_id = sfs.satisStok_stokID\r\n-\t\t\t\tWHERE sfs.satisStok_satisFaturasiID = ?\r\n-\t\t\t\tORDER BY sfs.satisStok_id ASC\r\n-\t\t\t\";\r\n+\t\t\t$degisiklikler = $this->input->post('degisiklikler');\r\n \t\t\t\r\n-\t\t\terror_log(\"DEBUG: Query: $query with satis_id: $satis_id\");\r\n-\t\t\t$result = $this->db->query($query, [$satis_id])->result();\r\n-\t\t\terror_log(\"DEBUG: Query result count: \" . count($result));\r\n-\t\t\t\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'success' => true,\r\n-\t\t\t\t'data' => $result,\r\n-\t\t\t\t'debug' => [\r\n-\t\t\t\t\t'satis_id' => $satis_id,\r\n-\t\t\t\t\t'cari_id' => $cari_id,\r\n-\t\t\t\t\t'count' => count($result)\r\n-\t\t\t\t]\r\n-\t\t\t]);\r\n-\t\t\t\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\terror_log(\"DEBUG: Exception in getStokBilgileri: \" . $e->getMessage());\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'success' => false,\r\n-\t\t\t\t'message' => 'Veri alınırken hata oluştu: ' . $e->getMessage()\r\n-\t\t\t]);\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Stok bilgilerini kaydet (AJAX)\r\n-\t */\r\n-\tpublic function stokBilgileriKaydet()\r\n-\t{\r\n-\t\t// Yetki kontrolü\r\n-\t\tif (!grup_modul_yetkisi_var(531)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Yetki hatası']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\t$satis_id = $this->input->post('satis_id');\r\n-\t\t$cari_id = $this->input->post('cari_id');\r\n-\t\t$stok_bilgileri = $this->input->post('stok_bilgileri');\r\n-\t\t\r\n-\t\tif (!$satis_id || !$stok_bilgileri || !is_array($stok_bilgileri)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Gerekli veriler eksik']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\t$this->db->trans_start();\r\n-\t\t\r\n-\t\ttry {\r\n-\t\t\t$user_info = session(\"r\", \"login_info\");\r\n-\t\t\t$user_id = $user_info ? $user_info->kullanici_id : 0;\r\n-\t\t\t\r\n-\t\t\t// Mevcut stok kayıtlarını sil\r\n-\t\t\t$this->db->where('satisStok_satisFaturasiID', $satis_id);\r\n-\t\t\t$this->db->delete('satisFaturasiStok');\r\n-\t\t\t\r\n-\t\t\t$toplam_tutar = 0;\r\n-\t\t\t$toplam_kdv_dahil = 0;\r\n-\t\t\t\r\n-\t\t\t// Yeni stok kayıtlarını ekle\r\n-\t\t\tforeach ($stok_bilgileri as $stok) {\r\n-\t\t\t\tif (empty($stok['stok_adi']) || empty($stok['miktar']) || !isset($stok['birim_fiyat'])) {\r\n-\t\t\t\t\tcontinue;\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t$miktar = floatval($stok['miktar']);\r\n-\t\t\t\t$birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']); // Frontend'den KDV dahil fiyat geliyor\r\n-\t\t\t\t$kdv_orani = floatval($stok['kdv_orani']);\r\n-\t\t\t\t\r\n-\t\t\t\t// KDV dahil fiyattan KDV hariç fiyatı hesapla\r\n-\t\t\t\t$birim_fiyat_kdv_haric = $birim_fiyat_kdv_dahil / (1 + ($kdv_orani / 100));\r\n-\t\t\t\t\r\n-\t\t\t\t// Satır toplamları (KDV dahil fiyat kullanarak)\r\n-\t\t\t\t$toplam_satir_kdv_dahil = $miktar * $birim_fiyat_kdv_dahil;\r\n-\t\t\t\t$toplam_satir_kdv_haric = $miktar * $birim_fiyat_kdv_haric;\r\n-\t\t\t\t$kdv_tutari = $toplam_satir_kdv_dahil - $toplam_satir_kdv_haric;\r\n-\t\t\t\t\r\n-\t\t\t\t$toplam_tutar += $toplam_satir_kdv_haric;\r\n-\t\t\t\t$toplam_kdv_dahil += $toplam_satir_kdv_dahil;\r\n-\t\t\t\t\r\n-\t\t\t\t$insert_data = [\r\n-\t\t\t\t\t'satisStok_satisFaturasiID' => $satis_id,\r\n-\t\t\t\t\t'satisStok_stokID' => !empty($stok['stok_id']) ? $stok['stok_id'] : null,\r\n-\t\t\t\t\t'satisStok_stokAdi' => $stok['stok_adi'],\r\n-\t\t\t\t\t'satisStok_miktar' => $miktar,\r\n-\t\t\t\t\t'satisStok_birimFiyat' => $birim_fiyat_kdv_dahil, // KDV dahil birim fiyat\r\n-\t\t\t\t\t'satisStok_kdv' => $kdv_orani,\r\n-\t\t\t\t\t'satisStok_kdvTutar' => $kdv_tutari,\r\n-\t\t\t\t\t'satisStok_toplam' => $toplam_satir_kdv_dahil, // Toplam KDV dahil\r\n-\t\t\t\t\t'satisStok_olusturmaTarihi' => date('Y-m-d H:i:s'),\r\n-\t\t\t\t\t'satisStok_olusturan' => $user_id\r\n-\t\t\t\t];\r\n-\t\t\t\t\r\n-\t\t\t\t$this->db->insert('satisFaturasiStok', $insert_data);\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t// Satış faturası toplamlarını güncelle\r\n-\t\t\t$update_data = [\r\n-\t\t\t\t'satis_araToplam' => $toplam_tutar,\r\n-\t\t\t\t'satis_kdvToplam' => $toplam_kdv_dahil - $toplam_tutar,\r\n-\t\t\t\t'satis_vergiDahilToplam' => $toplam_kdv_dahil,\r\n-\t\t\t\t'satis_genelToplam' => $toplam_kdv_dahil,\r\n-\t\t\t\t'satis_guncellemeTarihi' => date('Y-m-d H:i:s'),\r\n-\t\t\t\t'satis_guncelleyen' => $user_id\r\n-\t\t\t];\r\n-\t\t\t\r\n-\t\t\t$this->db->where('satis_id', $satis_id);\r\n-\t\t\t$this->db->update('satisFaturasi', $update_data);\r\n-\t\t\t\r\n-\t\t\t// Cari hareket güncellemesi\r\n-\t\t\t$this->updateCariHareketleri($satis_id, $cari_id, $toplam_kdv_dahil, $user_id);\r\n-\t\t\t\r\n-\t\t\t$this->db->trans_complete();\r\n-\t\t\t\r\n-\t\t\tif ($this->db->trans_status() === FALSE) {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı işlemi başarısız']);\r\n-\t\t\t} else {\r\n-\t\t\t\techo json_encode(['success' => true, 'message' => 'Stok bilgileri başarıyla kaydedildi']);\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\t$this->db->trans_rollback();\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt sırasında hata oluştu: ' . $e->getMessage()]);\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Cari hareketlerini güncelle\r\n-\t */\r\n-\tprivate function updateCariHareketleri($satis_id, $cari_id, $tutar, $user_id)\r\n-\t{\r\n-\t\ttry {\r\n-\t\t\t// Mevcut cari hareket kaydını kontrol et\r\n-\t\t\t$ch_query = \"SELECT ch_id FROM carihareketleri WHERE ch_sfID = ? LIMIT 1\";\r\n-\t\t\t$ch_result = $this->db->query($ch_query, [$satis_id])->row();\r\n-\t\t\t\r\n-\t\t\tif ($ch_result) {\r\n-\t\t\t\t// Mevcut kaydı güncelle\r\n-\t\t\t\t$update_data = [\r\n-\t\t\t\t\t'ch_borc' => $tutar,\r\n-\t\t\t\t\t'ch_guncellemeTarihi' => date('Y-m-d H:i:s'),\r\n-\t\t\t\t\t'ch_guncelleyen' => $user_id\r\n-\t\t\t\t];\r\n-\t\t\t\t\r\n-\t\t\t\t$this->db->where('ch_id', $ch_result->ch_id);\r\n-\t\t\t\t$this->db->update('carihareketleri', $update_data);\r\n-\t\t\t} else {\r\n-\t\t\t\t// Yeni kayıt oluştur\r\n-\t\t\t\t$insert_data = [\r\n-\t\t\t\t\t'ch_cariID' => $cari_id,\r\n-\t\t\t\t\t'ch_sfID' => $satis_id,\r\n-\t\t\t\t\t'ch_tip' => 'Satış Faturası',\r\n-\t\t\t\t\t'ch_borc' => $tutar,\r\n-\t\t\t\t\t'ch_tarih' => date('Y-m-d'),\r\n-\t\t\t\t\t'ch_olusturmaTarihi' => date('Y-m-d H:i:s'),\r\n-\t\t\t\t\t'ch_olusturan' => $user_id,\r\n-\t\t\t\t\t'ch_aciklama' => 'Stok bilgisi güncelleme işlemi'\r\n-\t\t\t\t];\r\n-\t\t\t\t\r\n-\t\t\t\t$this->db->insert('carihareketleri', $insert_data);\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\tlog_message('error', 'updateCariHareketleri hatası: ' . $e->getMessage());\r\n-\t\t\tthrow $e;\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Tahsilat kaydını sil \r\n-\t * Hem eski sistem (ch_id) hem yeni sistem (unique_id, tip_kod, source_id) parametrelerini destekler\r\n-\t */\r\n-\tpublic function tahsilatSil()\r\n-\t{\r\n-\t\t// Yeni sistem parametrelerini kontrol et\r\n-\t\t$unique_id = $this->input->post('unique_id');\r\n-\t\t$tip_kod = $this->input->post('tip_kod');\r\n-\t\t$source_id = $this->input->post('source_id');\r\n-\t\t$tahsilat_tipi = $this->input->post('tahsilat_tipi');\r\n-\t\t\r\n-\t\t// Eski sistem parametresi\r\n-\t\t$ch_id = $this->input->post('ch_id');\r\n-\t\t\r\n-\t\t// Yeni sistem kullanılıyorsa\r\n-\t\tif ($unique_id && $tip_kod && $source_id) {\r\n-\t\t\t$this->yeniTahsilatSil($unique_id, $tip_kod, $source_id, $tahsilat_tipi);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\t// Eski sistem kullanılıyorsa\r\n-\t\tif ($ch_id) {\r\n-\t\t\t$this->eskiTahsilatSil($ch_id);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\techo json_encode(['success' => false, 'message' => 'Gerekli parametreler eksik']);\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Yeni tahsilat silme sistemi\r\n-\t */\r\n-\tprivate function yeniTahsilatSil($unique_id, $tip_kod, $source_id, $tahsilat_tipi)\r\n-\t{\r\n-\t\ttry {\r\n-\t\t\terror_log(\"YENİ TAHSILAT SİL - unique_id: $unique_id, tip_kod: $tip_kod, source_id: $source_id\");\r\n-\t\t\t\r\n-\t\t\t$deleted = false;\r\n-\t\t\t$message = '';\r\n-\t\t\t\r\n-\t\t\tswitch($tip_kod) {\r\n-\t\t\t\tcase '1': // Banka/Pos\r\n-\t\t\t\t\t$this->db->where('bh_id', $source_id);\r\n-\t\t\t\t\t$deleted = $this->db->delete('bankahareketleri');\r\n-\t\t\t\t\t$message = 'Banka/Pos tahsilat kaydı silindi';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\t\t\r\n-\t\t\t\tcase '2': // Çek\r\n-\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n-\t\t\t\t\t$deleted = $this->db->delete('cek');\r\n-\t\t\t\t\t$message = 'Çek tahsilat kaydı silindi';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\t\t\r\n-\t\t\t\tcase '3': // Kasa/Nakit\r\n-\t\t\t\t\t$this->db->where('kh_id', $source_id);\r\n-\t\t\t\t\t$deleted = $this->db->delete('kasahareketleri');\r\n-\t\t\t\t\t$message = 'Kasa/Nakit tahsilat kaydı silindi';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\t\t\r\n-\t\t\t\tcase '4': // Senet\r\n-\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n-\t\t\t\t\t$deleted = $this->db->delete('senet');\r\n-\t\t\t\t\t$message = 'Senet tahsilat kaydı silindi';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\t\t\r\n-\t\t\t\tdefault:\r\n-\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Bilinmeyen tahsilat tipi: ' . $tip_kod]);\r\n-\t\t\t\t\treturn;\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\tif ($deleted) {\r\n-\t\t\t\terror_log(\"BAŞARILI SİLME: \" . $message);\r\n-\t\t\t\techo json_encode(['success' => true, 'message' => $message]);\r\n-\t\t\t} else {\r\n-\t\t\t\terror_log(\"SİLME BAŞARISIZ: Kayıt bulunamadı veya silinemedi\");\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Kayıt bulunamadı veya silinemedi']);\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\terror_log(\"TAHSILAT SİLME HATASI: \" . $e->getMessage());\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Eski tahsilat silme sistemi  \r\n-\t */\r\n-\t/**\r\n-\t * Eski tahsilat silme sistemi (ch_id parametresi ile)\r\n-\t */\r\n-\tprivate function eskiTahsilatSil($ch_id)\r\n-\t{\r\n-\t\tif (!$ch_id) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Cari hareket ID gerekli']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\ttry {\r\n-\t\t\t// Önce cari hareket kaydını al\r\n-\t\t\t$this->db->where('ch_id', $ch_id);\r\n-\t\t\t$cariHareket = $this->db->get('carihareketleri')->row();\r\n-\r\n-\t\t\tif (!$cariHareket) {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat kaydı bulunamadı']);\r\n+\t\t\tif (!$degisiklikler || !is_array($degisiklikler)) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Değişiklik verileri bulunamadı']);\r\n \t\t\t\treturn;\r\n \t\t\t}\r\n-\r\n-\t\t\terror_log(\"ESKİ TAHSILAT SİL - CH_ID: \" . $ch_id . \" Turu: \" . $cariHareket->ch_turu);\r\n \t\t\t\r\n-\t\t\t$deleted_related = false;\r\n-\t\t\t$message = 'Tahsilat kaydı silindi';\r\n-\r\n-\t\t\t// İlgili tablodan da kayıtları sil\r\n-\t\t\tif (($cariHareket->ch_turu == 4 || $cariHareket->ch_turu == 5) && !empty($cariHareket->ch_kasaID)) {\r\n-\t\t\t\t// Kasa hareketi sil\r\n-\t\t\t\t$this->db->where('kh_id', $cariHareket->ch_kasaID);\r\n-\t\t\t\t$this->db->delete('kasaHareketleri');\r\n-\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t$message = 'Kasa tahsilat kaydı silindi';\r\n-\t\t\t}\r\n-\t\t\telse if (($cariHareket->ch_turu == 6 || $cariHareket->ch_turu == 7) && !empty($cariHareket->ch_bankaID)) {\r\n-\t\t\t\t// Banka hareketi sil\r\n-\t\t\t\t$this->db->where('bh_id', $cariHareket->ch_bankaID);\r\n-\t\t\t\t$this->db->delete('bankaHareketleri');\r\n-\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t$message = 'Banka tahsilat kaydı silindi';\r\n-\t\t\t}\r\n-\t\t\telse if (($cariHareket->ch_turu == 8 || $cariHareket->ch_turu == 9) && !empty($cariHareket->ch_cekID)) {\r\n-\t\t\t\t// Çek sil\r\n-\t\t\t\t$this->db->where('cek_id', $cariHareket->ch_cekID);\r\n-\t\t\t\t$this->db->delete('cek');\r\n-\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t$message = 'Çek tahsilat kaydı silindi';\r\n-\t\t\t}\r\n-\t\t\telse if (($cariHareket->ch_turu == 10 || $cariHareket->ch_turu == 11) && !empty($cariHareket->ch_senetID)) {\r\n-\t\t\t\t// Senet sil\r\n-\t\t\t\t$this->db->where('senet_id', $cariHareket->ch_senetID);\r\n-\t\t\t\t$this->db->delete('senet');\r\n-\t\t\t\t$deleted_related = true;\r\n-\t\t\t\t$message = 'Senet tahsilat kaydı silindi';\r\n-\t\t\t}\r\n-\r\n-\t\t\t// Cari hareket kaydını sil\r\n-\t\t\t$this->db->where('ch_id', $ch_id);\r\n-\t\t\t$deleted = $this->db->delete('carihareketleri');\r\n-\r\n-\t\t\tif ($deleted) {\r\n-\t\t\t\terror_log(\"BAŞARILI SİLME: \" . $message);\r\n-\t\t\t\techo json_encode(['success' => true, 'message' => $message]);\r\n-\t\t\t} else {\r\n-\t\t\t\terror_log(\"CARİ HAREKET SİLEMEDİ\");\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Cari hareket kaydı silinemedi']);\r\n-\t\t\t}\r\n-\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\terror_log(\"ESKİ TAHSILAT SİLME HATASI: \" . $e->getMessage());\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n-\t * Tahsilat tutarlarını güncelle\r\n-\t */\r\n-\tpublic function tahsilatTutarGuncelle()\r\n-\t{\r\n-\t\t$degisiklikler = $this->input->post('degisiklikler');\r\n-\t\t\r\n-\t\tif (!$degisiklikler || !is_array($degisiklikler)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Değişiklik verisi gerekli']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\ttry {\r\n \t\t\t$this->db->trans_start();\r\n-\t\t\t$guncellenen_sayisi = 0;\r\n+\t\t\t$basarili_guncelleme = 0;\r\n+\t\t\t$hata_mesajlari = [];\r\n \t\t\t\r\n \t\t\tforeach ($degisiklikler as $degisiklik) {\r\n \t\t\t\t$tip_kod = $degisiklik['tip_kod'];\r\n \t\t\t\t$source_id = $degisiklik['source_id'];\r\n-\t\t\t\t$yeni_tutar = $degisiklik['yeni_tutar'];\r\n-\t\t\t\t$ch_id = isset($degisiklik['ch_id']) ? $degisiklik['ch_id'] : null;\r\n+\t\t\t\t$degisiklik_tipi = $degisiklik['degisiklik_tipi'];\r\n \t\t\t\t\r\n-\t\t\t\terror_log(\"TUTAR GÜNCELLE - Tip: $tip_kod, ID: $source_id, Yeni Tutar: $yeni_tutar\");\r\n-\t\t\t\t\r\n-\t\t\t\t$updated = false;\r\n-\t\t\t\t\r\n-\t\t\t\t// İlgili tabloda tutarı güncelle\r\n-\t\t\t\tswitch($tip_kod) {\r\n-\t\t\t\t\tcase '1': // Banka/Pos\r\n-\t\t\t\t\t\t$this->db->where('bh_id', $source_id);\r\n-\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_giris' => $yeni_tutar]);\r\n-\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n-\t\t\t\t\t\tbreak;\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tif ($degisiklik_tipi == 'tutar') {\r\n+\t\t\t\t\t\t// Tutar güncelleme\r\n+\t\t\t\t\t\t$yeni_tutar = floatval($degisiklik['yeni_tutar']);\r\n \t\t\t\t\t\t\r\n-\t\t\t\t\tcase '2': // Çek\r\n-\t\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n-\t\t\t\t\t\t$this->db->update('cek', ['cek_tutar' => $yeni_tutar]);\r\n-\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n-\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\tswitch($tip_kod) {\r\n+\t\t\t\t\t\t\tcase '1': // Banka\r\n+\t\t\t\t\t\t\t\t$this->db->where('bh_id', $source_id);\r\n+\t\t\t\t\t\t\t\t$this->db->update('bankahareketleri', ['bh_giris' => $yeni_tutar]);\r\n+\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\tcase '2': // Çek\r\n+\t\t\t\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n+\t\t\t\t\t\t\t\t$this->db->update('cek', ['cek_tutar' => $yeni_tutar]);\r\n+\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\tcase '3': // Kasa\r\n+\t\t\t\t\t\t\t\t$this->db->where('kh_id', $source_id);\r\n+\t\t\t\t\t\t\t\t$this->db->update('kasahareketleri', ['kh_giris' => $yeni_tutar]);\r\n+\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\tcase '4': // Senet\r\n+\t\t\t\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n+\t\t\t\t\t\t\t\t$this->db->update('senet', ['senet_tutar' => $yeni_tutar]);\r\n+\t\t\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t}\r\n \t\t\t\t\t\t\r\n-\t\t\t\t\tcase '3': // Kasa/Nakit\r\n-\t\t\t\t\t\t$this->db->where('kh_id', $source_id);\r\n-\t\t\t\t\t\t$this->db->update('kasahareketleri', ['kh_giris' => $yeni_tutar]);\r\n-\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n-\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t// Cari hareketi de güncelle\r\n+\t\t\t\t\t\tif (isset($degisiklik['ch_id']) && $degisiklik['ch_id']) {\r\n+\t\t\t\t\t\t\t$this->db->where('ch_id', $degisiklik['ch_id']);\r\n+\t\t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n+\t\t\t\t\t\t}\r\n \t\t\t\t\t\t\r\n-\t\t\t\t\tcase '4': // Senet\r\n-\t\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n-\t\t\t\t\t\t$this->db->update('senet', ['senet_tutar' => $yeni_tutar]);\r\n-\t\t\t\t\t\t$updated = $this->db->affected_rows() > 0;\r\n-\t\t\t\t\t\tbreak;\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t// Cari hareketleri tablosunu da güncelle\r\n-\t\t\t\tif ($updated && $ch_id) {\r\n-\t\t\t\t\t$this->db->where('ch_id', $ch_id);\r\n-\t\t\t\t\t\r\n-\t\t\t\t\t// Cari hareketleri için doğru alanı güncelle\r\n-\t\t\t\t\tif ($tip_kod == '1' || $tip_kod == '3') { // Banka ve Kasa giriş\r\n-\t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n-\t\t\t\t\t} else if ($tip_kod == '2' || $tip_kod == '4') { // Çek ve Senet\r\n-\t\t\t\t\t\t$this->db->update('carihareketleri', ['ch_alacak' => $yeni_tutar]);\r\n+\t\t\t\t\t} elseif ($degisiklik_tipi == 'vade_tarihi') {\r\n+\t\t\t\t\t\t// Vade tarihi güncelleme (sadece çek ve senet için)\r\n+\t\t\t\t\t\t$yeni_vade_tarihi = $degisiklik['yeni_vade_tarihi'];\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tif ($tip_kod == '2') { // Çek\r\n+\t\t\t\t\t\t\t$this->db->where('cek_id', $source_id);\r\n+\t\t\t\t\t\t\t$this->db->update('cek', ['cek_vadeTarih' => $yeni_vade_tarihi]);\r\n+\t\t\t\t\t\t} elseif ($tip_kod == '4') { // Senet\r\n+\t\t\t\t\t\t\t$this->db->where('senet_id', $source_id);\r\n+\t\t\t\t\t\t\t$this->db->update('senet', ['senet_vadeTarih' => $yeni_vade_tarihi]);\r\n+\t\t\t\t\t\t}\r\n \t\t\t\t\t}\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t// Muhasebe tahsilat durum tablosunu da güncelle\r\n-\t\t\t\tif ($updated) {\r\n-\t\t\t\t\t// muhasebe_tahsilat_durum tablosunda ilgili kayıt var mı kontrol et\r\n-\t\t\t\t\t$this->db->where('tahsilat_tipi', $tip_kod);\r\n-\t\t\t\t\t$this->db->where('kayit_id', $source_id);\r\n-\t\t\t\t\t$muhasebe_kayit = $this->db->get('muhasebe_tahsilat_durum')->row();\r\n \t\t\t\t\t\r\n-\t\t\t\t\tif ($muhasebe_kayit) {\r\n-\t\t\t\t\t\t// Kayıt mevcutsa, tutar değişikliği için açıklama alanını güncelle\r\n-\t\t\t\t\t\t$tarih = date('Y-m-d H:i:s');\r\n-\t\t\t\t\t\t$aciklama = \"Tutar güncellendi ($tarih)\";\r\n-\t\t\t\t\t\t\r\n-\t\t\t\t\t\t$this->db->where('id', $muhasebe_kayit->id);\r\n-\t\t\t\t\t\t$this->db->update('muhasebe_tahsilat_durum', [\r\n-\t\t\t\t\t\t\t'aciklama' => $aciklama\r\n-\t\t\t\t\t\t]);\r\n-\t\t\t\t\t\t\r\n-\t\t\t\t\t\terror_log(\"MUHASEBE TAHSILAT DURUM güncellendi - ID: {$muhasebe_kayit->id}, Tip: $tip_kod, Source ID: $source_id\");\r\n-\t\t\t\t\t} else {\r\n-\t\t\t\t\t\t// Kayıt yoksa yeni kayıt oluştur\r\n-\t\t\t\t\t\t$data = array(\r\n-\t\t\t\t\t\t\t'tahsilat_tipi' => $tip_kod,\r\n-\t\t\t\t\t\t\t'kayit_id' => $source_id,\r\n-\t\t\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n-\t\t\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n-\t\t\t\t\t\t\t'aciklama' => 'Tam Ana Rapor tahsilat modal güncelleme ile oluşturuldu'\r\n-\t\t\t\t\t\t);\r\n-\t\t\t\t\t\t\r\n-\t\t\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n-\t\t\t\t\t\terror_log(\"MUHASEBE TAHSILAT DURUM yeni kayıt oluşturuldu - Tip: $tip_kod, Source ID: $source_id\");\r\n-\t\t\t\t\t}\r\n+\t\t\t\t\t$basarili_guncelleme++;\r\n+\t\t\t\t\t\r\n+\t\t\t\t} catch (Exception $e) {\r\n+\t\t\t\t\t$hata_mesajlari[] = \"ID {$source_id} güncellenirken hata: \" . $e->getMessage();\r\n \t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\tif ($updated) {\r\n-\t\t\t\t\t$guncellenen_sayisi++;\r\n-\t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t$this->db->trans_complete();\r\n \t\t\t\r\n \t\t\tif ($this->db->trans_status() === FALSE) {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı işlemi başarısız oldu']);\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => false,\r\n+\t\t\t\t\t'message' => 'Veritabanı işlemi başarısız: ' . implode(', ', $hata_mesajlari)\r\n+\t\t\t\t]);\r\n \t\t\t} else {\r\n \t\t\t\techo json_encode([\r\n-\t\t\t\t\t'success' => true, \r\n-\t\t\t\t\t'message' => \"$guncellenen_sayisi adet tahsilat tutarı başarıyla güncellendi\"\r\n+\t\t\t\t\t'success' => true,\r\n+\t\t\t\t\t'message' => \"{$basarili_guncelleme} adet kayıt başarıyla güncellendi.\",\r\n+\t\t\t\t\t'basarili_guncelleme' => $basarili_guncelleme,\r\n+\t\t\t\t\t'hata_sayisi' => count($hata_mesajlari)\r\n \t\t\t\t]);\r\n \t\t\t}\r\n \t\t\t\r\n \t\t} catch (Exception $e) {\r\n-\t\t\terror_log(\"TUTAR GÜNCELLEME HATASI: \" . $e->getMessage());\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Güncelleme sırasında hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n \t\t}\r\n \t}\r\n-\t\r\n+\r\n \t/**\r\n \t * Yeni tahsilat ekleme fonksiyonu\r\n \t */\r\n \tpublic function yeniTahsilatEkle()\r\n@@ -4141,9 +3530,10 @@\n \t\t\t\r\n \t\t\t// Cari hareket kaydı ekle\r\n \t\t\t$cari_hareket_data = [\r\n \t\t\t\t'ch_cariID' => $cari_id,\r\n-\t\t\t\t'ch_islemTarihi' => $tarih,\r\n+\t\t\t\t'ch_sfID' => $satis_id,\r\n+\t\t\t\t'ch_tip' => 'Satış Faturası',\r\n \t\t\t\t'ch_borc' => 0,\r\n \t\t\t\t'ch_alacak' => $tutar,\r\n \t\t\t\t'ch_aciklama' => $aciklama,\r\n \t\t\t\t'ch_olusturan' => $olusturan,\r\n@@ -4244,9 +3634,9 @@\n \t\t\t$current_images = [];\r\n \t\t\t\r\n \t\t\tif ($current_record && $current_record->satisStok_gorsel) {\r\n \t\t\t\t$current_images = explode(',', $current_record->satisStok_gorsel);\r\n-\t\t\t\t$current_images = array_filter($current_images);\r\n+\t\t\t\t$current_images = array_filter($current_images); // Boş elemanları temizle\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t// Yeni dosyaları ekle\r\n \t\t\t$all_images = array_merge($current_images, $uploaded_files);\r\n@@ -4316,160 +3706,5 @@\n \t\t} catch (Exception $e) {\r\n \t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n-\r\n-\t/**\r\n-\t * Satış listesi getir - AJAX test\r\n-\t */\r\n-\tpublic function testSatisList()\r\n-\t{\r\n-\t\t$cari_id = $this->input->post('cari_id');\r\n-\t\t\r\n-\t\tif (!$cari_id) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\t\t\r\n-\t\t// Çok basit test - sadece mock data\r\n-\t\t$satislar = [\r\n-\t\t\t[\r\n-\t\t\t\t'satis_id' => 1,\r\n-\t\t\t\t'satis_sozlesme_tutari' => '1,500.00',\r\n-\t\t\t\t'tarih' => '15.08.2025',\r\n-\t\t\t\t'satis_sozlesme_hizmet' => 'DIGITURK',\r\n-\t\t\t\t'gorsel_sayisi' => 2\r\n-\t\t\t],\r\n-\t\t\t[\r\n-\t\t\t\t'satis_id' => 2,\r\n-\t\t\t\t'satis_sozlesme_tutari' => '2,300.00',\r\n-\t\t\t\t'tarih' => '20.08.2025',\r\n-\t\t\t\t'satis_sozlesme_hizmet' => 'S SPORT',\r\n-\t\t\t\t'gorsel_sayisi' => 0\r\n-\t\t\t]\r\n-\t\t];\r\n-\r\n-\t\techo json_encode([\r\n-\t\t\t'success' => true,\r\n-\t\t\t'satislar' => $satislar\r\n-\t\t]);\r\n-\t}\r\n-\r\n-\t/**\r\n-\t * Stok dropdown için JSON endpoint\r\n-\t */\r\n-\tpublic function stok_dropdown()\r\n-\t{\r\n-\t\t// JSON header\r\n-\t\theader('Content-Type: application/json; charset=utf-8');\r\n-\t\t\r\n-\t\ttry {\r\n-\t\t\t// Arama terimi al\r\n-\t\t\t$search_term = $this->input->get('q') ? trim($this->input->get('q')) : '';\r\n-\t\t\tif (empty($search_term)) {\r\n-\t\t\t\t$search_term = $this->input->post('q') ? trim($this->input->post('q')) : '';\r\n-\t\t\t}\r\n-\r\n-\t\t\t// Basit stok sorgusu - tüm aktif stokları getir\r\n-\t\t\t$this->db->select('stok_id, stok_ad, stok_kodu, stok_satisFiyati, stok_satisKDV');\r\n-\t\t\t$this->db->from('stok');\r\n-\t\t\t$this->db->where('stok_durum', 1);\r\n-\t\t\t$this->db->where('stok_ad IS NOT NULL');\r\n-\t\t\t$this->db->where('stok_ad !=', '');\r\n-\r\n-\t\t\t// Arama terimi varsa ekle\r\n-\t\t\tif (!empty($search_term)) {\r\n-\t\t\t\t$this->db->group_start();\r\n-\t\t\t\t$this->db->like('stok_ad', $search_term);\r\n-\t\t\t\t$this->db->or_like('stok_kodu', $search_term);\r\n-\t\t\t\t$this->db->group_end();\r\n-\t\t\t}\r\n-\r\n-\t\t\t$this->db->order_by('stok_ad', 'ASC');\r\n-\t\t\t$this->db->limit(50);\r\n-\r\n-\t\t\t$query = $this->db->get();\r\n-\t\t\t$results = $query->result();\r\n-\r\n-\t\t\t// Select2 formatına uygun sonuçları hazırla\r\n-\t\t\t$formatted_results = [];\r\n-\t\t\t\r\n-\t\t\t// Boş seçenek ekle (sadece arama terimi yoksa)\r\n-\t\t\tif (empty($search_term)) {\r\n-\t\t\t\t$formatted_results[] = [\r\n-\t\t\t\t\t'id' => '',\r\n-\t\t\t\t\t'text' => 'Stok seçiniz...',\r\n-\t\t\t\t\t'stok_data' => null\r\n-\t\t\t\t];\r\n-\t\t\t}\r\n-\r\n-\t\t\tforeach ($results as $row) {\r\n-\t\t\t\t// Stok adı boşsa atla\r\n-\t\t\t\tif (empty($row->stok_ad)) {\r\n-\t\t\t\t\tcontinue;\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t$display_text = $row->stok_ad;\r\n-\t\t\t\tif (!empty($row->stok_kodu)) {\r\n-\t\t\t\t\t$display_text .= \" (Kod: {$row->stok_kodu})\";\r\n-\t\t\t\t}\r\n-\t\t\t\tif (!empty($row->stok_satisFiyati) && $row->stok_satisFiyati > 0) {\r\n-\t\t\t\t\t$display_text .= \" - \" . number_format($row->stok_satisFiyati, 2) . \" ₺\";\r\n-\t\t\t\t}\r\n-\t\t\t\t\r\n-\t\t\t\t$formatted_results[] = [\r\n-\t\t\t\t\t'id' => $row->stok_id,\r\n-\t\t\t\t\t'text' => $display_text,\r\n-\t\t\t\t\t'stok_data' => [\r\n-\t\t\t\t\t\t'stok_id' => $row->stok_id,\r\n-\t\t\t\t\t\t'stok_kodu' => $row->stok_kodu ?? '',\r\n-\t\t\t\t\t\t'stok_ad' => $row->stok_ad,\r\n-\t\t\t\t\t\t'stok_satisFiyati' => floatval($row->stok_satisFiyati ?? 0),\r\n-\t\t\t\t\t\t'stok_satisKDV' => floatval($row->stok_satisKDV ?? 20)\r\n-\t\t\t\t\t]\r\n-\t\t\t\t];\r\n-\t\t\t}\r\n-\r\n-\t\t\t// Hiç sonuç yoksa mesaj göster\r\n-\t\t\tif (count($formatted_results) <= 1) { // 1 çünkü boş seçenek var\r\n-\t\t\t\tif (!empty($search_term)) {\r\n-\t\t\t\t\t$formatted_results = [\r\n-\t\t\t\t\t\t[\r\n-\t\t\t\t\t\t\t'id' => '',\r\n-\t\t\t\t\t\t\t'text' => \"'{$search_term}' için sonuç bulunamadı\",\r\n-\t\t\t\t\t\t\t'disabled' => true\r\n-\t\t\t\t\t\t]\r\n-\t\t\t\t\t];\r\n-\t\t\t\t} else {\r\n-\t\t\t\t\t$formatted_results = [\r\n-\t\t\t\t\t\t[\r\n-\t\t\t\t\t\t\t'id' => '',\r\n-\t\t\t\t\t\t\t'text' => 'Aktif stok bulunamadı',\r\n-\t\t\t\t\t\t\t'disabled' => true\r\n-\t\t\t\t\t\t]\r\n-\t\t\t\t\t];\r\n-\t\t\t\t}\r\n-\t\t\t}\r\n-\r\n-\t\t\t// Select2 yanıt formatı\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'results' => $formatted_results,\r\n-\t\t\t\t'pagination' => [\r\n-\t\t\t\t\t'more' => count($results) >= 50\r\n-\t\t\t\t]\r\n-\t\t\t], JSON_UNESCAPED_UNICODE);\r\n-\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\t// Hata işleme\r\n-\t\t\techo json_encode([\r\n-\t\t\t\t'results' => [\r\n-\t\t\t\t\t[\r\n-\t\t\t\t\t\t'id' => '',\r\n-\t\t\t\t\t\t'text' => 'Hata: ' . $e->getMessage(),\r\n-\t\t\t\t\t\t'disabled' => true\r\n-\t\t\t\t\t]\r\n-\t\t\t\t],\r\n-\t\t\t\t'error' => $e->getMessage()\r\n-\t\t\t], JSON_UNESCAPED_UNICODE);\r\n-\t\t}\r\n-\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757074993950,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3706,5 +3706,142 @@\n \t\t} catch (Exception $e) {\r\n \t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Tahsilat silme fonksiyonu\r\n+\t */\r\n+\tpublic function tahsilatSil()\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t// POST verilerini al\r\n+\t\t\t$unique_id = $this->input->post('unique_id');\r\n+\t\t\t$tip_kod = $this->input->post('tip_kod');\r\n+\t\t\t$source_id = $this->input->post('source_id');\r\n+\t\t\t$ch_id = $this->input->post('ch_id'); // Eski sistem için\r\n+\t\t\t\r\n+\t\t\t// Debug log\r\n+\t\t\terror_log(\"Tahsilat Silme İsteği: unique_id=$unique_id, tip_kod=$tip_kod, source_id=$source_id, ch_id=$ch_id\");\r\n+\t\t\t\r\n+\t\t\t// Parametre kontrolü\r\n+\t\t\tif (empty($ch_id) && (empty($unique_id) || empty($tip_kod) || empty($source_id))) {\r\n+\t\t\t\tthrow new Exception('Gerekli parametreler eksik');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$this->db->trans_start();\r\n+\t\t\t\r\n+\t\t\t// Eski sistem ile uyumluluk (ch_id varsa)\r\n+\t\t\tif (!empty($ch_id)) {\r\n+\t\t\t\t// Cari hareket ID'si ile silme\r\n+\t\t\t\t$cari_hareket = $this->db->where('ch_id', $ch_id)->get('cariHareketleri')->row();\r\n+\t\t\t\tif (!$cari_hareket) {\r\n+\t\t\t\t\tthrow new Exception('Cari hareket kaydı bulunamadı');\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t// Cari hareket kaydını sil\r\n+\t\t\t\t$this->db->where('ch_id', $ch_id)->delete('cariHareketleri');\r\n+\t\t\t\t\r\n+\t\t\t\tif ($this->db->affected_rows() == 0) {\r\n+\t\t\t\t\tthrow new Exception('Cari hareket kaydı silinemedi');\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\terror_log(\"Cari hareket silindi: ch_id=$ch_id\");\r\n+\t\t\t\t\r\n+\t\t\t} else {\r\n+\t\t\t\t// Yeni sistem ile silme (unique_id, tip_kod, source_id)\r\n+\t\t\t\t$deleted = false;\r\n+\t\t\t\t\r\n+\t\t\t\tswitch ($tip_kod) {\r\n+\t\t\t\t\tcase '1': // Banka Hareketleri\r\n+\t\t\t\t\t\t$record = $this->db->where('bh_id', $source_id)->get('bankaHareketleri')->row();\r\n+\t\t\t\t\t\tif ($record) {\r\n+\t\t\t\t\t\t\t// Görsel dosyasını sil\r\n+\t\t\t\t\t\t\tif (!empty($record->bh_gorsel)) {\r\n+\t\t\t\t\t\t\t\t$file_path = FCPATH . 'assets/uploads/dekontlar/' . $record->bh_gorsel;\r\n+\t\t\t\t\t\t\t\tif (file_exists($file_path)) {\r\n+\t\t\t\t\t\t\t\t\tunlink($file_path);\r\n+\t\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\t// Banka hareket kaydını sil\r\n+\t\t\t\t\t\t\t$this->db->where('bh_id', $source_id)->delete('bankaHareketleri');\r\n+\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tcase '2': // Çekler\r\n+\t\t\t\t\t\t$record = $this->db->where('cek_id', $source_id)->get('cek')->row();\r\n+\t\t\t\t\t\tif ($record) {\r\n+\t\t\t\t\t\t\t// Görsel dosyasını sil\r\n+\t\t\t\t\t\t\tif (!empty($record->cek_gorsel)) {\r\n+\t\t\t\t\t\t\t\t$file_path = FCPATH . 'assets/uploads/cekler/' . $record->cek_gorsel;\r\n+\t\t\t\t\t\t\t\tif (file_exists($file_path)) {\r\n+\t\t\t\t\t\t\t\t\tunlink($file_path);\r\n+\t\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\t// Çek kaydını sil\r\n+\t\t\t\t\t\t\t$this->db->where('cek_id', $source_id)->delete('cek');\r\n+\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tcase '3': // Kasa Hareketleri\r\n+\t\t\t\t\t\t$record = $this->db->where('kh_id', $source_id)->get('kasaHareketleri')->row();\r\n+\t\t\t\t\t\tif ($record) {\r\n+\t\t\t\t\t\t\t// Kasa hareket kaydını sil\r\n+\t\t\t\t\t\t\t$this->db->where('kh_id', $source_id)->delete('kasaHareketleri');\r\n+\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tcase '4': // Senetler\r\n+\t\t\t\t\t\t$record = $this->db->where('senet_id', $source_id)->get('senet')->row();\r\n+\t\t\t\t\t\tif ($record) {\r\n+\t\t\t\t\t\t\t// Görsel dosyasını sil\r\n+\t\t\t\t\t\t\tif (!empty($record->senet_gorsel)) {\r\n+\t\t\t\t\t\t\t\t$file_path = FCPATH . 'assets/uploads/senetler/' . $record->senet_gorsel;\r\n+\t\t\t\t\t\t\t\tif (file_exists($file_path)) {\r\n+\t\t\t\t\t\t\t\t\tunlink($file_path);\r\n+\t\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\t// Senet kaydını sil\r\n+\t\t\t\t\t\t\t$this->db->where('senet_id', $source_id)->delete('senet');\r\n+\t\t\t\t\t\t\t$deleted = $this->db->affected_rows() > 0;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\tdefault:\r\n+\t\t\t\t\t\tthrow new Exception('Bilinmeyen tahsilat tipi: ' . $tip_kod);\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\tif (!$deleted) {\r\n+\t\t\t\t\tthrow new Exception('Tahsilat kaydı silinemedi veya bulunamadı');\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\terror_log(\"Tahsilat silindi: tip_kod=$tip_kod, source_id=$source_id\");\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$this->db->trans_complete();\r\n+\t\t\t\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\tthrow new Exception('Veritabanı işlemi başarısız');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true,\r\n+\t\t\t\t'message' => 'Tahsilat kaydı başarıyla silindi'\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t$this->db->trans_rollback();\r\n+\t\t\terror_log(\"Tahsilat Silme Hatası: \" . $e->getMessage());\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false,\r\n+\t\t\t\t'message' => 'Tahsilat silinirken beklenmeyen bir hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1757160318925,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3569,51 +3569,108 @@\n \t * Stok görsel yükleme fonksiyonu\r\n \t */\r\n \tpublic function stokGorselYukle()\r\n \t{\r\n+\t\t// Debug: Method called\r\n+\t\tlog_message('debug', 'stokGorselYukle method called');\r\n+\t\tlog_message('debug', 'POST data: ' . print_r($_POST, true));\r\n+\t\tlog_message('debug', 'FILES data: ' . print_r($_FILES, true));\r\n+\t\t\r\n \t\t$satisStok_id = $this->input->post('satisStok_id');\r\n \t\t$stok_adi = $this->input->post('stok_adi');\r\n \t\t\r\n \t\tif (!$satisStok_id) {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Stok ID gerekli']);\r\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n+\t\t// $_FILES kontrolü - array syntax ile gelen dosyalar\r\n \t\tif (empty($_FILES['stok_gorseller']) || !isset($_FILES['stok_gorseller']['tmp_name'])) {\r\n \t\t\techo json_encode(['success' => false, 'message' => 'Dosya seçilmedi']);\r\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n-\t\t\t$upload_path = FCPATH . 'assets/uploads/stok_gorselleri/';\r\n+\t\t\t// Upload path - relative path kullan\r\n+\t\t\t$upload_path = './assets/uploads/stok_gorselleri/';\r\n \t\t\tif (!is_dir($upload_path)) {\r\n-\t\t\t\tmkdir($upload_path, 0777, true);\r\n+\t\t\t\tif (!mkdir($upload_path, 0777, true)) {\r\n+\t\t\t\t\tthrow new Exception('Upload klasörü oluşturulamadı: ' . $upload_path);\r\n+\t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t$uploaded_files = [];\r\n \t\t\t$files = $_FILES['stok_gorseller'];\r\n \t\t\t\r\n-\t\t\t// Çoklu dosya yükleme işlemi\r\n-\t\t\tfor ($i = 0; $i < count($files['tmp_name']); $i++) {\r\n-\t\t\t\tif ($files['error'][$i] == UPLOAD_ERR_OK) {\r\n-\t\t\t\t\t$tmp_name = $files['tmp_name'][$i];\r\n-\t\t\t\t\t$original_name = $files['name'][$i];\r\n-\t\t\t\t\t$size = $files['size'][$i];\r\n-\t\t\t\t\t$type = $files['type'][$i];\r\n+\t\t\t// Debug: File structure\r\n+\t\t\tlog_message('debug', 'File structure: ' . print_r($files, true));\r\n+\t\t\t\r\n+\t\t\t// Tek dosya mı yoksa çoklu dosya mı kontrolü\r\n+\t\t\tif (is_array($files['tmp_name'])) {\r\n+\t\t\t\t// Çoklu dosya yükleme işlemi\r\n+\t\t\t\t$file_count = count($files['tmp_name']);\r\n+\t\t\t\tlog_message('debug', 'Multiple files detected: ' . $file_count);\r\n+\t\t\t\t\r\n+\t\t\t\tfor ($i = 0; $i < $file_count; $i++) {\r\n+\t\t\t\t\tif (isset($files['error'][$i]) && $files['error'][$i] == UPLOAD_ERR_OK) {\r\n+\t\t\t\t\t\t$tmp_name = $files['tmp_name'][$i];\r\n+\t\t\t\t\t\t$original_name = $files['name'][$i];\r\n+\t\t\t\t\t\t$size = $files['size'][$i];\r\n+\t\t\t\t\t\t$type = isset($files['type'][$i]) ? $files['type'][$i] : '';\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t// Dosya boyutu kontrolü (max 10MB)\r\n+\t\t\t\t\t\tif ($size > 10 * 1024 * 1024) {\r\n+\t\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t// Dosya tipi kontrolü - daha geniş format desteği\r\n+\t\t\t\t\t\t$ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));\r\n+\t\t\t\t\t\t$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n+\t\t\t\t\t\tif (!in_array($ext, $allowed_extensions)) {\r\n+\t\t\t\t\t\t\tthrow new Exception($original_name . ' dosya tipi desteklenmiyor. İzin verilen: ' . implode(', ', $allowed_extensions));\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t// Dosya adını oluştur\r\n+\t\t\t\t\t\t$filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n+\t\t\t\t\t\t$filepath = $upload_path . $filename;\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t// Debug: File upload attempt\r\n+\t\t\t\t\t\tlog_message('debug', 'Attempting to upload: ' . $tmp_name . ' to ' . $filepath);\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\t// Dosyayı yükle\r\n+\t\t\t\t\t\tif (move_uploaded_file($tmp_name, $filepath)) {\r\n+\t\t\t\t\t\t\t$uploaded_files[] = $filename;\r\n+\t\t\t\t\t\t\tlog_message('debug', 'File uploaded successfully: ' . $filename);\r\n+\t\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t\tlog_message('error', 'Failed to upload file: ' . $original_name);\r\n+\t\t\t\t\t\t\tthrow new Exception($original_name . ' dosyası yüklenemedi');\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t$error_code = isset($files['error'][$i]) ? $files['error'][$i] : 'Unknown';\r\n+\t\t\t\t\t\tlog_message('error', 'File upload error for file ' . $i . ': ' . $error_code);\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t} else {\r\n+\t\t\t\t// Tek dosya yükleme\r\n+\t\t\t\tif ($files['error'] == UPLOAD_ERR_OK) {\r\n+\t\t\t\t\t$tmp_name = $files['tmp_name'];\r\n+\t\t\t\t\t$original_name = $files['name'];\r\n+\t\t\t\t\t$size = $files['size'];\r\n+\t\t\t\t\t$type = $files['type'];\r\n \t\t\t\t\t\r\n \t\t\t\t\t// Dosya boyutu kontrolü (max 10MB)\r\n \t\t\t\t\tif ($size > 10 * 1024 * 1024) {\r\n \t\t\t\t\t\tthrow new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n \t\t\t\t\t}\r\n \t\t\t\t\t\r\n \t\t\t\t\t// Dosya tipi kontrolü\r\n-\t\t\t\t\t$allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];\r\n-\t\t\t\t\tif (!in_array($type, $allowed_types)) {\r\n+\t\t\t\t\t$ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));\r\n+\t\t\t\t\t$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n+\t\t\t\t\tif (!in_array($ext, $allowed_extensions)) {\r\n \t\t\t\t\t\tthrow new Exception($original_name . ' dosya tipi desteklenmiyor');\r\n \t\t\t\t\t}\r\n \t\t\t\t\t\r\n \t\t\t\t\t// Dosya adını oluştur\r\n-\t\t\t\t\t$ext = pathinfo($original_name, PATHINFO_EXTENSION);\r\n \t\t\t\t\t$filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n \t\t\t\t\t$filepath = $upload_path . $filename;\r\n \t\t\t\t\t\r\n \t\t\t\t\t// Dosyayı yükle\r\n@@ -3628,8 +3685,11 @@\n \t\t\tif (empty($uploaded_files)) {\r\n \t\t\t\tthrow new Exception('Hiçbir dosya yüklenemedi');\r\n \t\t\t}\r\n \t\t\t\r\n+\t\t\t// Debug: Uploaded files\r\n+\t\t\tlog_message('debug', 'Uploaded files: ' . print_r($uploaded_files, true));\r\n+\t\t\t\r\n \t\t\t// Mevcut görsel listesini al\r\n \t\t\t$current_record = $this->db->select('satisStok_gorsel')->where('satisStok_id', $satisStok_id)->get('satisstok')->row();\r\n \t\t\t$current_images = [];\r\n \t\t\t\r\n@@ -3641,19 +3701,30 @@\n \t\t\t// Yeni dosyaları ekle\r\n \t\t\t$all_images = array_merge($current_images, $uploaded_files);\r\n \t\t\t$image_string = implode(',', $all_images);\r\n \t\t\t\r\n+\t\t\t// Debug: Database update\r\n+\t\t\tlog_message('debug', 'Updating database for satisStok_id: ' . $satisStok_id . ' with images: ' . $image_string);\r\n+\t\t\t\r\n \t\t\t// Veritabanını güncelle\r\n \t\t\t$this->db->where('satisStok_id', $satisStok_id);\r\n-\t\t\t$this->db->update('satisstok', ['satisStok_gorsel' => $image_string]);\r\n+\t\t\t$update_result = $this->db->update('satisstok', ['satisStok_gorsel' => $image_string]);\r\n \t\t\t\r\n+\t\t\tif (!$update_result) {\r\n+\t\t\t\tlog_message('error', 'Database update failed: ' . $this->db->error());\r\n+\t\t\t\tthrow new Exception('Veritabanı güncellenemedi');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tlog_message('debug', 'Database updated successfully');\r\n+\t\t\t\r\n \t\t\techo json_encode([\r\n \t\t\t\t'success' => true, \r\n \t\t\t\t'message' => count($uploaded_files) . ' dosya başarıyla yüklendi',\r\n \t\t\t\t'uploaded_files' => $uploaded_files\r\n \t\t\t]);\r\n \t\t\t\r\n \t\t} catch (Exception $e) {\r\n+\t\t\tlog_message('error', 'stokGorselYukle error: ' . $e->getMessage());\r\n \t\t\techo json_encode(['success' => false, 'message' => $e->getMessage()]);\r\n \t\t}\r\n \t}\r\n \t\r\n"
                },
                {
                    "date": 1757344975061,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -367,8 +367,50 @@\n \t\t\r\n \r\n \t\tif ($tahsilat && $tahsilat->durum == 1) { // Sadece onay bekleyen durumda olanlar\r\n \r\n+\t\t\t// Görsel yükleme işlemi\r\n+\r\n+\t\t\t$gorsel_path = null;\r\n+\r\n+\t\t\tif (!empty($_FILES['tahsilat_gorsel']['name'])) {\r\n+\r\n+\t\t\t\t$upload_path = FCPATH . 'assets/uploads/';\r\n+\r\n+\t\t\t\tif (!is_dir($upload_path)) {\r\n+\r\n+\t\t\t\t\tmkdir($upload_path, 0777, true);\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t$config['upload_path'] = $upload_path;\r\n+\r\n+\t\t\t\t$config['allowed_types'] = 'jpg|jpeg|png|gif';\r\n+\r\n+\t\t\t\t$config['max_size'] = 5120; // 5MB\r\n+\r\n+\t\t\t\t$config['file_name'] = 'tahsilat_' . $tahsilat_id . '_' . time();\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t$this->load->library('upload', $config);\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\tif ($this->upload->do_upload('tahsilat_gorsel')) {\r\n+\r\n+\t\t\t\t\t$upload_data = $this->upload->data();\r\n+\r\n+\t\t\t\t\t$gorsel_path = 'assets/uploads/' . $upload_data['file_name'];\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t}\r\n+\r\n+\t\t\t\r\n+\r\n \t\t\t// Onay işlemi\r\n \r\n \t\t\t$data = array(\r\n \r\n@@ -381,8 +423,30 @@\n \t\t\t);\r\n \r\n \t\t\t\r\n \r\n+\t\t\t// Görsel varsa ekle\r\n+\r\n+\t\t\tif ($gorsel_path) {\r\n+\r\n+\t\t\t\t$data['gorsel'] = $gorsel_path;\r\n+\r\n+\t\t\t}\r\n+\r\n+\t\t\t\r\n+\r\n+\t\t\t// Açıklama varsa ekle\r\n+\r\n+\t\t\t$aciklama = $this->input->post('aciklama');\r\n+\r\n+\t\t\tif (!empty($aciklama)) {\r\n+\r\n+\t\t\t\t$data['aciklama'] = $aciklama;\r\n+\r\n+\t\t\t}\r\n+\r\n+\t\t\t\r\n+\r\n \t\t\t$this->db->where('id', $tahsilat_id);\r\n \r\n \t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n \r\n@@ -391,15 +455,17 @@\n \t\t\t$this->session->set_flashdata('tahsilat_onay_ok', 'OK');\r\n \r\n \t\t\tlogekle(1, 3); // Log ekle\r\n \r\n-\t\t} else {\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'OK');\r\n+\t\t} else {\r\n \r\n+\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'OK');\r\n+\r\n \t\t}\r\n \r\n \t\t\r\n \r\n-\t\tredirect(\"muhasebe/onay-bekleyen-tahsilatlar\");\r\n+\t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n \r\n \t}\r\n \r\n \t\r\n@@ -463,9 +529,9 @@\n \t\t}\r\n \r\n \t\t\r\n \r\n-\t\tredirect(\"muhasebe/onay-bekleyen-tahsilatlar\");\r\n+\t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n \r\n \t}\r\n \r\n \t\r\n"
                },
                {
                    "date": 1757347830873,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -371,8 +371,12 @@\n \t\t\t// Görsel yükleme işlemi\r\n \r\n \t\t\t$gorsel_path = null;\r\n \r\n+\t\t\t$upload_error = null;\r\n+\r\n+\t\t\t\r\n+\r\n \t\t\tif (!empty($_FILES['tahsilat_gorsel']['name'])) {\r\n \r\n \t\t\t\t$upload_path = FCPATH . 'assets/uploads/';\r\n \r\n@@ -383,28 +387,50 @@\n \t\t\t\t}\r\n \r\n \t\t\t\t\r\n \r\n-\t\t\t\t$config['upload_path'] = $upload_path;\r\n+\t\t\t\t// Dosya uzantısını kontrol et\r\n \r\n-\t\t\t\t$config['allowed_types'] = 'jpg|jpeg|png|gif';\r\n+\t\t\t\t$file_extension = strtolower(pathinfo($_FILES['tahsilat_gorsel']['name'], PATHINFO_EXTENSION));\r\n \r\n-\t\t\t\t$config['max_size'] = 5120; // 5MB\r\n+\t\t\t\t$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif'];\r\n \r\n-\t\t\t\t$config['file_name'] = 'tahsilat_' . $tahsilat_id . '_' . time();\r\n-\r\n \t\t\t\t\r\n \r\n-\t\t\t\t$this->load->library('upload', $config);\r\n+\t\t\t\tif (in_array($file_extension, $allowed_extensions)) {\r\n \r\n-\t\t\t\t\r\n+\t\t\t\t\t// Dosya adını oluştur\r\n \r\n-\t\t\t\tif ($this->upload->do_upload('tahsilat_gorsel')) {\r\n+\t\t\t\t\t$file_name = 'tahsilat_' . $tahsilat_id . '_' . time() . '.' . $file_extension;\r\n \r\n-\t\t\t\t\t$upload_data = $this->upload->data();\r\n+\t\t\t\t\t$full_path = $upload_path . $file_name;\r\n \r\n-\t\t\t\t\t$gorsel_path = 'assets/uploads/' . $upload_data['file_name'];\r\n+\t\t\t\t\t\r\n \r\n+\t\t\t\t\t// Dosya boyutunu kontrol et (5MB = 5242880 bytes)\r\n+\r\n+\t\t\t\t\tif ($_FILES['tahsilat_gorsel']['size'] <= 5242880) {\r\n+\r\n+\t\t\t\t\t\tif (move_uploaded_file($_FILES['tahsilat_gorsel']['tmp_name'], $full_path)) {\r\n+\r\n+\t\t\t\t\t\t\t$gorsel_path = $file_name; // Sadece dosya adını saklıyoruz\r\n+\r\n+\t\t\t\t\t\t} else {\r\n+\r\n+\t\t\t\t\t\t\t$upload_error = \"Dosya yükleme sırasında hata oluştu.\";\r\n+\r\n+\t\t\t\t\t\t}\r\n+\r\n+\t\t\t\t\t} else {\r\n+\r\n+\t\t\t\t\t\t$upload_error = \"Dosya boyutu 5MB'dan büyük olamaz.\";\r\n+\r\n+\t\t\t\t\t}\r\n+\r\n+\t\t\t\t} else {\r\n+\r\n+\t\t\t\t\t$upload_error = \"Sadece JPG, JPEG, PNG ve GIF formatları desteklenmektedir.\";\r\n+\r\n \t\t\t\t}\r\n \r\n \t\t\t}\r\n \r\n@@ -433,16 +459,20 @@\n \t\t\t}\r\n \r\n \t\t\t\r\n \r\n-\t\t\t// Açıklama varsa ekle\r\n+\t\t\t// Açıklama varsa ekle veya mevcut açıklamayı koru\r\n \r\n \t\t\t$aciklama = $this->input->post('aciklama');\r\n \r\n \t\t\tif (!empty($aciklama)) {\r\n \r\n-\t\t\t\t$data['aciklama'] = $aciklama;\r\n+\t\t\t\t// Mevcut açıklama varsa ona ekle, yoksa yeni açıklama yap\r\n \r\n+\t\t\t\t$mevcut_aciklama = $tahsilat->aciklama ? $tahsilat->aciklama . \"\\n\\n\" : \"\";\r\n+\r\n+\t\t\t\t$data['aciklama'] = $mevcut_aciklama . \"Onay Açıklaması: \" . $aciklama;\r\n+\r\n \t\t\t}\r\n \r\n \t\t\t\r\n \r\n@@ -451,15 +481,39 @@\n \t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n \r\n \t\t\t\r\n \r\n-\t\t\t$this->session->set_flashdata('tahsilat_onay_ok', 'OK');\r\n+\t\t\tif ($this->db->affected_rows() > 0) {\r\n \r\n+\t\t\t\t$success_message = 'Tahsilat başarıyla onaylandı.';\r\n+\r\n+\t\t\t\tif ($gorsel_path) {\r\n+\r\n+\t\t\t\t\t$success_message .= ' Görsel yüklendi.';\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\tif ($upload_error) {\r\n+\r\n+\t\t\t\t\t$success_message .= ' Ancak: ' . $upload_error;\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t$this->session->set_flashdata('tahsilat_onay_ok', $success_message);\r\n+\r\n+\t\t\t} else {\r\n+\r\n+\t\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'Tahsilat onaylama işlemi sırasında hata oluştu.');\r\n+\r\n+\t\t\t}\r\n+\r\n+\t\t\t\r\n+\r\n \t\t\tlogekle(1, 3); // Log ekle\r\n \r\n \t\t} else {\r\n \r\n-\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'OK');\r\n+\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'Geçersiz tahsilat veya tahsilat zaten işlenmiş.');\r\n \r\n \t\t}\r\n \r\n \t\t\r\n@@ -843,11 +897,13 @@\n \t\t\t\t   END as durum_adi,\r\n \r\n \t\t\t\t   mtd.durum,\r\n \r\n+\t\t\t\t   mtd.gorsel as onay_gorsel,\r\n+\r\n \t\t\t\t   COALESCE(bh_cari.cari_ad, c_cari.cari_ad, kh_cari.cari_ad, s_cari.cari_ad) as musteri_adi,\r\n \r\n-\t\t\t\t   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as gorsel,\r\n+\t\t\t\t   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as tahsilat_gorsel,\r\n \r\n \t\t\t\t   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n \r\n \t\t\t\t   -- Çek ek bilgileri\r\n"
                },
                {
                    "date": 1757348956507,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -587,9 +587,55 @@\n \t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n \r\n \t}\r\n \r\n-\t\r\n+\tpublic function tahsilatGeriAl($tahsilat_id)\r\n+\t{\r\n+\t\t// Memory limit artır (performans için)\r\n+\t\tini_set('memory_limit', '256M');\r\n+\t\tini_set('max_execution_time', 300);\r\n+\t\t\r\n+\t\t$anaHesap = anaHesapBilgisi();\r\n+\t\t$control = session(\"r\", \"login_info\");\r\n+\t\tif (!$control || !isset($control->kullanici_id)) {\r\n+\t\t\tredirect(base_url('check'));\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t$u_id = $control->kullanici_id;\r\n+\t\t\r\n+\t\t// Muhasebe tahsilat durum tablosundan bilgiyi kontrol et\r\n+\t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n+\t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n+\t\t\r\n+\t\tif ($tahsilat && $tahsilat->durum == 2) { // Sadece onaylanmış durumda olanlar geri alınabilir\r\n+\t\t\t// Geri alma işlemi - durumu onay bekliyor'a çevir\r\n+\t\t\t$data = array(\r\n+\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n+\t\t\t\t'islem_tarihi' => null, // İşlem tarihini sıfırla\r\n+\t\t\t\t'islemi_yapan' => null, // Onay yapan kişiyi sıfırla\r\n+\t\t\t\t'gorsel' => null, // Onay görselini temizle\r\n+\t\t\t);\r\n+\t\t\t\r\n+\t\t\t// Mevcut açıklama varsa geri alma notunu ekle\r\n+\t\t\t$mevcut_aciklama = $tahsilat->aciklama ? $tahsilat->aciklama . \"\\n\\n\" : \"\";\r\n+\t\t\t$data['aciklama'] = $mevcut_aciklama . \"Geri Alma İşlemi: \" . date('d.m.Y H:i:s') . \" tarihinde \" . $control->kullanici_ad . \" \" . $control->kullanici_soyad . \" tarafından geri alındı.\";\r\n+\t\t\t\r\n+\t\t\t$this->db->where('id', $tahsilat_id);\r\n+\t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n+\t\t\t\r\n+\t\t\tif ($this->db->affected_rows() > 0) {\r\n+\t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_ok', 'Tahsilat başarıyla geri alındı ve onay bekleyen duruma getirildi.');\r\n+\t\t\t} else {\r\n+\t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_hata', 'Tahsilat geri alma işlemi sırasında hata oluştu.');\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tlogekle(1, 3); // Log ekle\r\n+\t\t} else {\r\n+\t\t\t$this->session->set_flashdata('tahsilat_geri_al_hata', 'Geçersiz tahsilat veya tahsilat zaten onaylanmamış durumda.');\r\n+\t\t}\r\n+\t\t\r\n+\t\tredirect(\"muhasebe/tahsilat-listesi\");\r\n+\t}\r\n \r\n \tpublic function tahsilatDetay($tahsilat_id)\r\n \r\n \t{\r\n"
                },
                {
                    "date": 1757416302971,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1246,10 +1246,13 @@\n \r\n \t\t\r\n \r\n \t\t$data['durum_filter'] = $durum_filter;\r\n-\r\n \t\t\r\n+\t\t// Arama parametresi\r\n+\t\t$search_param = $this->input->get('search');\r\n+\t\t$data['search_param'] = $search_param;\r\n+\t\t\t\t\r\n \r\n \t\t// Debug - Durum filtresi\r\n \r\n \t\tif ($control->kullanici_id == 187) {\r\n@@ -1409,8 +1412,35 @@\n \t\t}\r\n \r\n \t\t\r\n \r\n+\t\t// Arama koşulunu tüm durumlara uygula\r\n+\t\tif (!empty($search_param)) {\r\n+\t\t\t$search_escaped = $this->db->escape_like_str($search_param);\r\n+\t\t\t$search_condition = \" AND (\r\n+\t\t\t\tc.cari_tckn LIKE '%$search_escaped%' OR \r\n+\t\t\t\tc.cari_vergiNumarasi LIKE '%$search_escaped%' OR\r\n+\t\t\t\tCONCAT(c.cari_ad, ' ', c.cari_soyad) LIKE '%$search_escaped%' OR\r\n+\t\t\t\tc.cari_ad LIKE '%$search_escaped%' OR\r\n+\t\t\t\tc.cari_firmaTelefon LIKE '%$search_escaped%'\r\n+\t\t\t)\";\r\n+\t\t\t\r\n+\t\t\t// WHERE koşulundan sonra arama koşulunu ekle\r\n+\t\t\tif ($durum_filter == 'vadesi-gecen') {\r\n+\t\t\t\t$senetlerQ = str_replace(\r\n+\t\t\t\t\t\"WHERE s.senet_vadeTarih < CURDATE()\",\r\n+\t\t\t\t\t\"WHERE s.senet_vadeTarih < CURDATE() $search_condition\",\r\n+\t\t\t\t\t$senetlerQ\r\n+\t\t\t\t);\r\n+\t\t\t} else {\r\n+\t\t\t\t$senetlerQ = str_replace(\r\n+\t\t\t\t\t\"WHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\",\r\n+\t\t\t\t\t\"WHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1')) $search_condition\",\r\n+\t\t\t\t\t$senetlerQ\r\n+\t\t\t\t);\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\t\r\n \t\t// Sorguyu çalıştır ve hata kontrolü yap\r\n \r\n \t\ttry {\r\n \r\n@@ -1535,9 +1565,13 @@\n \t\t// Sayfalama\r\n \r\n \t\t$this->load->library('pagination');\r\n \r\n-\t\t$config['base_url'] = base_url(\"muhasebe/senet-yonetim?durum=$durum_filter\");\r\n+\t\t$pagination_url = \"muhasebe/senet-yonetim?durum=$durum_filter\";\r\n+\t\tif (!empty($search_param)) {\r\n+\t\t\t$pagination_url .= \"&search=\" . urlencode($search_param);\r\n+\t\t}\r\n+\t\t$config['base_url'] = base_url($pagination_url);\r\n \r\n \t\t$config['total_rows'] = $data['total_count'];\r\n \r\n \t\t$config['per_page'] = $limit;\r\n"
                },
                {
                    "date": 1757417874384,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -606,25 +606,23 @@\n \t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n \t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n \t\t\r\n \t\tif ($tahsilat && $tahsilat->durum == 2) { // Sadece onaylanmış durumda olanlar geri alınabilir\r\n-\t\t\t// Geri alma işlemi - durumu onay bekliyor'a çevir\r\n+\t\t\t// Geri alma işlemi - sadece durumu onay bekliyor'a çevir\r\n+\t\t\t$tarih = date('Y-m-d H:i:s');\r\n+\t\t\t$mevcut_aciklama = $tahsilat->aciklama ? $tahsilat->aciklama : '';\r\n+\t\t\t$yeni_aciklama = $mevcut_aciklama . \"\\n\\n[GERI ALMA] \" . $tarih . \" tarihinde kullanıcı tarafından geri alındı.\";\r\n+\t\t\t\r\n \t\t\t$data = array(\r\n \t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n-\t\t\t\t'islem_tarihi' => null, // İşlem tarihini sıfırla\r\n-\t\t\t\t'islemi_yapan' => null, // Onay yapan kişiyi sıfırla\r\n-\t\t\t\t'gorsel' => null, // Onay görselini temizle\r\n+\t\t\t\t'aciklama' => $yeni_aciklama\r\n \t\t\t);\r\n \t\t\t\r\n-\t\t\t// Mevcut açıklama varsa geri alma notunu ekle\r\n-\t\t\t$mevcut_aciklama = $tahsilat->aciklama ? $tahsilat->aciklama . \"\\n\\n\" : \"\";\r\n-\t\t\t$data['aciklama'] = $mevcut_aciklama . \"Geri Alma İşlemi: \" . date('d.m.Y H:i:s') . \" tarihinde \" . $control->kullanici_ad . \" \" . $control->kullanici_soyad . \" tarafından geri alındı.\";\r\n-\t\t\t\r\n \t\t\t$this->db->where('id', $tahsilat_id);\r\n \t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n \t\t\t\r\n \t\t\tif ($this->db->affected_rows() > 0) {\r\n-\t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_ok', 'Tahsilat başarıyla geri alındı ve onay bekleyen duruma getirildi.');\r\n+\t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_ok', 'Tahsilat başarıyla geri alındı.');\r\n \t\t\t} else {\r\n \t\t\t\t$this->session->set_flashdata('tahsilat_geri_al_hata', 'Tahsilat geri alma işlemi sırasında hata oluştu.');\r\n \t\t\t}\r\n \t\t\t\r\n"
                },
                {
                    "date": 1757432845005,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2831,9 +2831,10 @@\n \t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - birden fazla stok göstermek için GROUP_CONCAT kullan\r\n \t\t\t\t(SELECT GROUP_CONCAT(\r\n \t\t\t\t\tCASE \r\n \t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 1 THEN 'DIGITURK'\r\n-\t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 279 THEN 'S SPORT'\r\n+\t\t\t\t\t\tWHEN s.stok_id = 16 THEN 'S SPORT'\r\n+\t\t\t\t\t\tWHEN s.stok_id = 13 THEN 'TABII'\r\n \t\t\t\t\t\tELSE s.stok_ad\r\n \t\t\t\t\tEND\r\n \t\t\t\t\tSEPARATOR ', '\r\n \t\t\t\t )\r\n"
                },
                {
                    "date": 1757927116042,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1340,10 +1340,14 @@\n \t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n \r\n \t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n \r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n+\r\n \t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n \r\n+\t\t\t\tAND (mtd.durum IS NULL OR mtd.durum != 2)\r\n+\r\n \t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n \r\n \t\t\t\tLIMIT $offset, $limit\r\n \r\n@@ -1424,10 +1428,10 @@\n \t\t\t\r\n \t\t\t// WHERE koşulundan sonra arama koşulunu ekle\r\n \t\t\tif ($durum_filter == 'vadesi-gecen') {\r\n \t\t\t\t$senetlerQ = str_replace(\r\n-\t\t\t\t\t\"WHERE s.senet_vadeTarih < CURDATE()\",\r\n-\t\t\t\t\t\"WHERE s.senet_vadeTarih < CURDATE() $search_condition\",\r\n+\t\t\t\t\t\"AND (mtd.durum IS NULL OR mtd.durum != 2)\",\r\n+\t\t\t\t\t\"AND (mtd.durum IS NULL OR mtd.durum != 2) $search_condition\",\r\n \t\t\t\t\t$senetlerQ\r\n \t\t\t\t);\r\n \t\t\t} else {\r\n \t\t\t\t$senetlerQ = str_replace(\r\n@@ -1501,10 +1505,14 @@\n \t\t\t\tSELECT COUNT(*) as total\r\n \r\n \t\t\t\tFROM senet s\r\n \r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n+\r\n \t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n \r\n+\t\t\t\tAND (mtd.durum IS NULL OR mtd.durum != 2)\r\n+\r\n \t\t\t\";\r\n \r\n \t\t} else {\r\n \r\n@@ -1533,8 +1541,41 @@\n \t\t}\r\n \r\n \t\t\r\n \r\n+\t\t// Arama koşulunu count sorgusuna da uygula\r\n+\t\tif (!empty($search_param)) {\r\n+\t\t\t$search_escaped = $this->db->escape_like_str($search_param);\r\n+\t\t\t$search_condition = \" AND (\r\n+\t\t\t\tc.cari_tckn LIKE '%$search_escaped%' OR \r\n+\t\t\t\tc.cari_vergiNumarasi LIKE '%$search_escaped%' OR\r\n+\t\t\t\tCONCAT(c.cari_ad, ' ', c.cari_soyad) LIKE '%$search_escaped%' OR\r\n+\t\t\t\tc.cari_ad LIKE '%$search_escaped%' OR\r\n+\t\t\t\tc.cari_firmaTelefon LIKE '%$search_escaped%'\r\n+\t\t\t)\";\r\n+\t\t\t\r\n+\t\t\tif ($durum_filter == 'vadesi-gecen') {\r\n+\t\t\t\t// Vadesi geçen count sorgusu için cari tablosunu da join etmeli\r\n+\t\t\t\t$countQ = \"\r\n+\t\t\t\t\tSELECT COUNT(*) as total\r\n+\t\t\t\t\tFROM senet s\r\n+\t\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n+\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n+\t\t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n+\t\t\t\t\tAND (mtd.durum IS NULL OR mtd.durum != 2)\r\n+\t\t\t\t\t$search_condition\r\n+\t\t\t\t\";\r\n+\t\t\t} else {\r\n+\t\t\t\t$countQ = str_replace(\r\n+\t\t\t\t\t\"WHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\",\r\n+\t\t\t\t\t\"WHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1')) $search_condition\",\r\n+\t\t\t\t\t$countQ\r\n+\t\t\t\t);\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n+\t\t\r\n+\r\n \t\ttry {\r\n \r\n \t\t\t$countResult = $this->db->query($countQ);\r\n \r\n"
                },
                {
                    "date": 1758007149525,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1418,9 +1418,8 @@\n \t\t// Arama koşulunu tüm durumlara uygula\r\n \t\tif (!empty($search_param)) {\r\n \t\t\t$search_escaped = $this->db->escape_like_str($search_param);\r\n \t\t\t$search_condition = \" AND (\r\n-\t\t\t\tc.cari_tckn LIKE '%$search_escaped%' OR \r\n \t\t\t\tc.cari_vergiNumarasi LIKE '%$search_escaped%' OR\r\n \t\t\t\tCONCAT(c.cari_ad, ' ', c.cari_soyad) LIKE '%$search_escaped%' OR\r\n \t\t\t\tc.cari_ad LIKE '%$search_escaped%' OR\r\n \t\t\t\tc.cari_firmaTelefon LIKE '%$search_escaped%'\r\n@@ -1521,8 +1520,10 @@\n \t\t\t\tSELECT COUNT(*) as total\r\n \r\n \t\t\t\tFROM senet s\r\n \r\n+\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n+\r\n \t\t\t\tLEFT JOIN (\r\n \r\n \t\t\t\t\tSELECT sh1.sh_senet_id, MAX(sh1.sh_id) as max_id\r\n \r\n@@ -1545,9 +1546,8 @@\n \t\t// Arama koşulunu count sorgusuna da uygula\r\n \t\tif (!empty($search_param)) {\r\n \t\t\t$search_escaped = $this->db->escape_like_str($search_param);\r\n \t\t\t$search_condition = \" AND (\r\n-\t\t\t\tc.cari_tckn LIKE '%$search_escaped%' OR \r\n \t\t\t\tc.cari_vergiNumarasi LIKE '%$search_escaped%' OR\r\n \t\t\t\tCONCAT(c.cari_ad, ' ', c.cari_soyad) LIKE '%$search_escaped%' OR\r\n \t\t\t\tc.cari_ad LIKE '%$search_escaped%' OR\r\n \t\t\t\tc.cari_firmaTelefon LIKE '%$search_escaped%'\r\n@@ -2833,10 +2833,9 @@\n \t\t\t$where_conditions[] = \"(\r\n \t\t\t\tc.cari_ad LIKE '%{$search_term}%' OR \r\n \t\t\t\tc.cari_soyad LIKE '%{$search_term}%' OR \r\n \t\t\t\tc.cari_vergiNumarasi LIKE '%{$search_term}%' OR \r\n-\t\t\t\tc.cari_firmaTelefon LIKE '%{$search_term}%' OR \r\n-\t\t\t\tc.cari_tckn LIKE '%{$search_term}%'\r\n+\t\t\t\tc.cari_firmaTelefon LIKE '%{$search_term}%'\r\n \t\t\t)\";\r\n \t\t}\r\n \t\t\r\n \t\t// WHERE koşullarını birleştir\r\n"
                },
                {
                    "date": 1758628430447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2508,8 +2508,9 @@\n \t\t\t$cari_hareketleri = $this->db->count_all_results('carihareketleri');\r\n \t\t\tif ($cari_hareketleri > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Cari Hareketleri',\r\n+\t\t\t\t\t'tablo_kodu' => 'cari_hareketleri',\r\n \t\t\t\t\t'adet' => $cari_hareketleri,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait mali hareketler mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2519,8 +2520,9 @@\n \t\t\t$satis_faturalari = $this->db->count_all_results('satisFaturasi');\r\n \t\t\tif ($satis_faturalari > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Satış Faturaları',\r\n+\t\t\t\t\t'tablo_kodu' => 'satis_faturalari',\r\n \t\t\t\t\t'adet' => $satis_faturalari,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait satış faturaları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2530,8 +2532,9 @@\n \t\t\t$alis_faturalari = $this->db->count_all_results('alisFaturasi');\r\n \t\t\tif ($alis_faturalari > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Alış Faturaları',\r\n+\t\t\t\t\t'tablo_kodu' => 'alis_faturalari',\r\n \t\t\t\t\t'adet' => $alis_faturalari,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait alış faturaları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2541,8 +2544,9 @@\n \t\t\t$proforma_faturalari = $this->db->count_all_results('proformaFaturasi');\r\n \t\t\tif ($proforma_faturalari > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Proforma Faturaları',\r\n+\t\t\t\t\t'tablo_kodu' => 'proforma_faturalari',\r\n \t\t\t\t\t'adet' => $proforma_faturalari,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait proforma faturaları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2552,8 +2556,9 @@\n \t\t\t$banka_giris = $this->db->count_all_results('bankahareketleri');\r\n \t\t\tif ($banka_giris > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Banka Hareketleri',\r\n+\t\t\t\t\t'tablo_kodu' => 'banka_hareketleri',\r\n \t\t\t\t\t'adet' => $banka_giris,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait banka hareketleri mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2563,8 +2568,9 @@\n \t\t\t$kasa_hareketleri = $this->db->count_all_results('kasahareketleri');\r\n \t\t\tif ($kasa_hareketleri > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Kasa Hareketleri',\r\n+\t\t\t\t\t'tablo_kodu' => 'kasa_hareketleri',\r\n \t\t\t\t\t'adet' => $kasa_hareketleri,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait kasa hareketleri mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2574,8 +2580,9 @@\n \t\t\t$cekler = $this->db->count_all_results('cek');\r\n \t\t\tif ($cekler > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Çekler',\r\n+\t\t\t\t\t'tablo_kodu' => 'cekler',\r\n \t\t\t\t\t'adet' => $cekler,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait çek kayıtları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2585,8 +2592,9 @@\n \t\t\t$senetler = $this->db->count_all_results('senet');\r\n \t\t\tif ($senetler > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Senetler',\r\n+\t\t\t\t\t'tablo_kodu' => 'senetler',\r\n \t\t\t\t\t'adet' => $senetler,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait senet kayıtları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2596,8 +2604,9 @@\n \t\t\t$aktivasyonlar = $this->db->count_all_results('aktivasyon');\r\n \t\t\tif ($aktivasyonlar > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Aktivasyonlar',\r\n+\t\t\t\t\t'tablo_kodu' => 'aktivasyonlar',\r\n \t\t\t\t\t'adet' => $aktivasyonlar,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait aktivasyon kayıtları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2607,8 +2616,9 @@\n \t\t\t$potansiyel_satislar = $this->db->count_all_results('potansiyel_satis');\r\n \t\t\tif ($potansiyel_satislar > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Potansiyel Satışlar',\r\n+\t\t\t\t\t'tablo_kodu' => 'potansiyel_satislar',\r\n \t\t\t\t\t'adet' => $potansiyel_satislar,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait potansiyel satış kayıtları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -2626,8 +2636,9 @@\n \t\t\t\r\n \t\t\tif ($muhasebe_tahsilat > 0) {\r\n \t\t\t\t$bagimli_veriler[] = [\r\n \t\t\t\t\t'tablo' => 'Muhasebe Tahsilat Durum',\r\n+\t\t\t\t\t'tablo_kodu' => 'muhasebe_tahsilat_durum',\r\n \t\t\t\t\t'adet' => $muhasebe_tahsilat,\r\n \t\t\t\t\t'aciklama' => 'Bu cariye ait muhasebe tahsilat durum kayıtları mevcut'\r\n \t\t\t\t];\r\n \t\t\t}\r\n@@ -4155,5 +4166,421 @@\n \t\t\t\t'message' => 'Tahsilat silinirken beklenmeyen bir hata oluştu: ' . $e->getMessage()\r\n \t\t\t]);\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Tek Veri Türü Silme İşlemi\r\n+\t */\r\n+\tpublic function tek_veri_sil()\r\n+\t{\r\n+\t\theader('Content-Type: application/json');\r\n+\t\t\r\n+\t\t// Yetki kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(530)) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Kütüphaneleri yükle\r\n+\t\tif (!isset($this->db)) {\r\n+\t\t\t$this->load->database();\r\n+\t\t}\r\n+\r\n+\t\t$cari_id = $_POST['cari_id'] ?? null;\r\n+\t\t$tablo_kodu = $_POST['tablo_kodu'] ?? null;\r\n+\t\t$tablo_adi = $_POST['tablo_adi'] ?? null;\r\n+\t\t\r\n+\t\tif (!$cari_id || !$tablo_kodu || !$tablo_adi) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Gerekli parametreler eksik.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Transaction başlat\r\n+\t\t$this->db->trans_begin();\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$silinen_kayit_sayisi = 0;\r\n+\t\t\t\r\n+\t\t\tswitch ($tablo_kodu) {\r\n+\t\t\t\tcase 'satis_faturalari':\r\n+\t\t\t\t\t// İlgili stok kayıtlarını sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE sfs FROM satisfaturasistok sfs \r\n+\t\t\t\t\t\t\t\t\t INNER JOIN satisfaturasi sf ON sfs.satisStok_satisFaturasiID = sf.satis_id \r\n+\t\t\t\t\t\t\t\t\t WHERE sf.satis_cariID = ?\", [$cari_id]);\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Satış faturalarını sil\r\n+\t\t\t\t\t$this->db->where('satis_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('satisfaturasi');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'alis_faturalari':\r\n+\t\t\t\t\t// İlgili stok kayıtlarını sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE als FROM alisfaturasistok als \r\n+\t\t\t\t\t\t\t\t\t INNER JOIN alisfaturasi af ON als.alisStok_alisFaturasiID = af.alis_id \r\n+\t\t\t\t\t\t\t\t\t WHERE af.alis_cariID = ?\", [$cari_id]);\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Alış faturalarını sil\r\n+\t\t\t\t\t$this->db->where('alis_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('alisfaturasi');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'proforma_faturalari':\r\n+\t\t\t\t\t// İlgili stok kayıtlarını sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE pfs FROM proformafaturasistok pfs \r\n+\t\t\t\t\t\t\t\t\t INNER JOIN proformafaturasi pf ON pfs.proformaStok_proformaFaturasiID = pf.proforma_id \r\n+\t\t\t\t\t\t\t\t\t WHERE pf.proforma_cariID = ?\", [$cari_id]);\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Proforma faturalarını sil\r\n+\t\t\t\t\t$this->db->where('proforma_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('proformafaturasi');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'cari_hareketleri':\r\n+\t\t\t\t\t// Cari hareketlerini sil\r\n+\t\t\t\t\t$this->db->where('ch_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('carihareketleri');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'banka_hareketleri':\r\n+\t\t\t\t\t// Banka hareketlerini sil\r\n+\t\t\t\t\t$this->db->where('bh_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('bankahareketleri');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'kasa_hareketleri':\r\n+\t\t\t\t\t// Kasa hareketlerini sil\r\n+\t\t\t\t\t$this->db->where('kh_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('kasahareketleri');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'cekler':\r\n+\t\t\t\t\t// İlgili muhasebe tahsilat durumunu sil\r\n+\t\t\t\t\t$id_list = $this->db->select('cek_id')->where('cek_cariID', $cari_id)->get('cek')->result_array();\r\n+\t\t\t\t\t$id_list = array_column($id_list, 'cek_id');\r\n+\t\t\t\t\tif (!empty($id_list)) {\r\n+\t\t\t\t\t\t$id_list = implode(',', $id_list);\r\n+\t\t\t\t\t\t$this->db->query(\"DELETE FROM muhasebe_tahsilat_durum \r\n+\t\t\t\t\t\t\t\t\t\t WHERE tahsilat_tipi = 2 AND kayit_id IN ($id_list)\");\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Çekleri sil\r\n+\t\t\t\t\t$this->db->where('cek_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('cek');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'senetler':\r\n+\t\t\t\t\t// İlgili muhasebe tahsilat durumunu sil\r\n+\t\t\t\t\t$id_list = $this->db->select('senet_id')->where('senet_cariID', $cari_id)->get('senet')->result_array();\r\n+\t\t\t\t\t$id_list = array_column($id_list, 'senet_id');\r\n+\t\t\t\t\tif (!empty($id_list)) {\r\n+\t\t\t\t\t\t$id_list = implode(',', $id_list);\r\n+\t\t\t\t\t\t$this->db->query(\"DELETE FROM muhasebe_tahsilat_durum \r\n+\t\t\t\t\t\t\t\t\t\t WHERE tahsilat_tipi = 4 AND kayit_id IN ($id_list)\");\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Senetleri sil\r\n+\t\t\t\t\t$this->db->where('senet_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->delete('senet');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\tthrow new Exception('Bilinmeyen tablo kodu: ' . $tablo_kodu);\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Transaction'ı tamamla\r\n+\t\t\t$this->db->trans_commit();\r\n+\t\t\t\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\tthrow new Exception('Veritabanı işlemi başarısız');\r\n+\t\t\t}\r\n+\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'success',\r\n+\t\t\t\t'message' => $tablo_adi . ' başarıyla silindi. (' . $silinen_kayit_sayisi . ' kayıt silindi)'\r\n+\t\t\t]);\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t$this->db->trans_rollback();\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'error',\r\n+\t\t\t\t'message' => 'Silme işlemi sırasında hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Veri Listesi Getir - Seçmeli Silme İçin\r\n+\t */\r\n+\tpublic function veri_listesi_getir()\r\n+\t{\r\n+\t\t// JSON header ayarla\r\n+\t\theader('Content-Type: application/json');\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Yetki kontrolü\r\n+\t\t\tif (!grup_modul_yetkisi_var(530)) {\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\r\n+\t\t\t$cari_id = $_POST['cari_id'] ?? null;\r\n+\t\t\t$tablo_kodu = $_POST['tablo_kodu'] ?? null;\r\n+\t\t\t$tablo_adi = $_POST['tablo_adi'] ?? null;\r\n+\t\t\t\r\n+\t\t\tif (!$cari_id || !$tablo_kodu || !$tablo_adi) {\r\n+\t\t\t\techo json_encode(['status' => 'error', 'message' => 'Gerekli parametreler eksik.']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif (!isset($this->db)) {\r\n+\t\t\t\t$this->load->database();\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$data = [];\r\n+\t\t\t$columns = [];\r\n+\t\t\t\r\n+\t\t\tswitch ($tablo_kodu) {\r\n+\t\t\t\tcase 'satis_faturalari':\r\n+\t\t\t\t\t$query = $this->db->select('satis_id as id, satis_faturaNo, satis_faturaTarihi, satis_genelToplam, satis_aciklama')\r\n+\t\t\t\t\t\t\t\t\t  ->where('satis_cariID', $cari_id)\r\n+\t\t\t\t\t\t\t\t\t  ->get('satisfaturasi');\r\n+\t\t\t\t\t$data = $query->result_array();\r\n+\t\t\t\t\t$columns = ['Fatura No', 'Fatura Tarihi', 'Genel Toplam', 'Açıklama'];\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'alis_faturalari':\r\n+\t\t\t\t\t$query = $this->db->select('alis_id as id, alis_faturaNo, alis_faturaTarihi, alis_genelToplam, alis_aciklama')\r\n+\t\t\t\t\t\t\t\t\t  ->where('alis_cariID', $cari_id)\r\n+\t\t\t\t\t\t\t\t\t  ->get('alisfaturasi');\r\n+\t\t\t\t\t$data = $query->result_array();\r\n+\t\t\t\t\t$columns = ['Fatura No', 'Fatura Tarihi', 'Genel Toplam', 'Açıklama'];\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'proforma_faturalari':\r\n+\t\t\t\t\t$query = $this->db->select('proforma_id as id, proforma_faturaNo, proforma_faturaTarihi, proforma_genelToplam, proforma_aciklama')\r\n+\t\t\t\t\t\t\t\t\t  ->where('proforma_cariID', $cari_id)\r\n+\t\t\t\t\t\t\t\t\t  ->get('proformafaturasi');\r\n+\t\t\t\t\t$data = $query->result_array();\r\n+\t\t\t\t\t$columns = ['Fatura No', 'Fatura Tarihi', 'Genel Toplam', 'Açıklama'];\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'cari_hareketleri':\r\n+\t\t\t\t\t$query = $this->db->select('ch_id as id, ch_tarih, ch_aciklama, ch_borc, ch_alacak')\r\n+\t\t\t\t\t\t\t\t\t  ->where('ch_cariID', $cari_id)\r\n+\t\t\t\t\t\t\t\t\t  ->get('carihareketleri');\r\n+\t\t\t\t\t$data = $query->result_array();\r\n+\t\t\t\t\t$columns = ['Tarih', 'Açıklama', 'Borç', 'Alacak'];\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'cekler':\r\n+\t\t\t\t\t$query = $this->db->select('cek_id as id, cek_no, cek_vade, cek_tutar, cek_aciklama')\r\n+\t\t\t\t\t\t\t\t\t  ->where('cek_cariID', $cari_id)\r\n+\t\t\t\t\t\t\t\t\t  ->get('cek');\r\n+\t\t\t\t\t$data = $query->result_array();\r\n+\t\t\t\t\t$columns = ['Çek No', 'Vade', 'Tutar', 'Açıklama'];\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'senetler':\r\n+\t\t\t\t\t$query = $this->db->select('senet_id as id, senet_no, senet_vade, senet_tutar, senet_aciklama')\r\n+\t\t\t\t\t\t\t\t\t  ->where('senet_cariID', $cari_id)\r\n+\t\t\t\t\t\t\t\t\t  ->get('senet');\r\n+\t\t\t\t\t$data = $query->result_array();\r\n+\t\t\t\t\t$columns = ['Senet No', 'Vade', 'Tutar', 'Açıklama'];\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\tthrow new Exception('Bilinmeyen tablo kodu: ' . $tablo_kodu);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif (empty($data)) {\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'status' => 'info',\r\n+\t\t\t\t\t'message' => $tablo_adi . ' tablosunda kayıt bulunamadı.'\r\n+\t\t\t\t]);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'success',\r\n+\t\t\t\t'data' => $data,\r\n+\t\t\t\t'columns' => $columns,\r\n+\t\t\t\t'message' => count($data) . ' kayıt bulundu.'\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\terror_log(\"Veri listesi getir hatası: \" . $e->getMessage() . \" - Trace: \" . $e->getTraceAsString());\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'error',\r\n+\t\t\t\t'message' => 'Veri listesi getirilirken hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t} catch (Error $e) {\r\n+\t\t\terror_log(\"Veri listesi getir fatal hatası: \" . $e->getMessage() . \" - Trace: \" . $e->getTraceAsString());\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'error',\r\n+\t\t\t\t'message' => 'Fatal hata: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n+\t * Seçili Kayıtları Sil\r\n+\t */\r\n+\tpublic function secili_kayitlari_sil()\r\n+\t{\r\n+\t\theader('Content-Type: application/json');\r\n+\t\t\r\n+\t\t// Yetki kontrolü\r\n+\t\tif (!grup_modul_yetkisi_var(530)) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Bu işlem için yetkiniz bulunmamaktadır.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Kütüphaneleri yükle\r\n+\t\tif (!isset($this->db)) {\r\n+\t\t\t$this->load->database();\r\n+\t\t}\r\n+\r\n+\t\t$cari_id = $_POST['cari_id'] ?? null;\r\n+\t\t$tablo_kodu = $_POST['tablo_kodu'] ?? null;\r\n+\t\t$tablo_adi = $_POST['tablo_adi'] ?? null;\r\n+\t\t$secilen_idler = $_POST['secilen_idler'] ?? null;\r\n+\t\t\r\n+\t\tif (!$cari_id || !$tablo_kodu || !$tablo_adi || !$secilen_idler || !is_array($secilen_idler)) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Gerekli parametreler eksik veya hatalı.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// ID'leri güvenlik için temizle\r\n+\t\t$temiz_idler = array_map('intval', $secilen_idler);\r\n+\t\t$temiz_idler = array_filter($temiz_idler, function($id) { return $id > 0; });\r\n+\t\t\r\n+\t\tif (empty($temiz_idler)) {\r\n+\t\t\techo json_encode(['status' => 'error', 'message' => 'Geçerli ID bulunamadı.']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Transaction başlat\r\n+\t\t$this->db->trans_begin();\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$silinen_kayit_sayisi = 0;\r\n+\t\t\t$id_list = implode(',', $temiz_idler);\r\n+\t\t\t\r\n+\t\t\tswitch ($tablo_kodu) {\r\n+\t\t\t\tcase 'satis_faturalari':\r\n+\t\t\t\t\t// İlgili stok kayıtlarını sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE FROM satisfaturasistok \r\n+\t\t\t\t\t\t\t\t\t WHERE satisStok_satisFaturasiID IN ($id_list)\");\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Satış faturalarını sil\r\n+\t\t\t\t\t$this->db->where('satis_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('satis_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('satisfaturasi');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'alis_faturalari':\r\n+\t\t\t\t\t// İlgili stok kayıtlarını sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE FROM alisfaturasistok \r\n+\t\t\t\t\t\t\t\t\t WHERE alisStok_alisFaturasiID IN ($id_list)\");\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Alış faturalarını sil\r\n+\t\t\t\t\t$this->db->where('alis_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('alis_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('alisfaturasi');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'proforma_faturalari':\r\n+\t\t\t\t\t// İlgili stok kayıtlarını sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE FROM proformafaturasistok \r\n+\t\t\t\t\t\t\t\t\t WHERE proformaStok_proformaFaturasiID IN ($id_list)\");\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Proforma faturalarını sil\r\n+\t\t\t\t\t$this->db->where('proforma_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('proforma_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('proformafaturasi');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'cari_hareketleri':\r\n+\t\t\t\t\t// Cari hareketlerini sil\r\n+\t\t\t\t\t$this->db->where('ch_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('ch_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('carihareketleri');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'banka_hareketleri':\r\n+\t\t\t\t\t// Banka hareketlerini sil\r\n+\t\t\t\t\t$this->db->where('bh_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('bh_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('bankahareketleri');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'kasa_hareketleri':\r\n+\t\t\t\t\t// Kasa hareketlerini sil\r\n+\t\t\t\t\t$this->db->where('kh_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('kh_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('kasahareketleri');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'cekler':\r\n+\t\t\t\t\t// İlgili muhasebe tahsilat durumunu sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE FROM muhasebe_tahsilat_durum \r\n+\t\t\t\t\t\t\t\t\t WHERE tahsilat_tipi = 2 AND kayit_id IN ($id_list)\");\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Çekleri sil\r\n+\t\t\t\t\t$this->db->where('cek_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('cek_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('cek');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tcase 'senetler':\r\n+\t\t\t\t\t// İlgili muhasebe tahsilat durumunu sil\r\n+\t\t\t\t\t$this->db->query(\"DELETE FROM muhasebe_tahsilat_durum \r\n+\t\t\t\t\t\t\t\t\t WHERE tahsilat_tipi = 4 AND kayit_id IN ($id_list)\");\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Senetleri sil\r\n+\t\t\t\t\t$this->db->where('senet_cariID', $cari_id);\r\n+\t\t\t\t\t$this->db->where_in('senet_id', $temiz_idler);\r\n+\t\t\t\t\t$this->db->delete('senet');\r\n+\t\t\t\t\t$silinen_kayit_sayisi = $this->db->affected_rows();\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\t\t\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\tthrow new Exception('Bilinmeyen tablo kodu: ' . $tablo_kodu);\r\n+\t\t\t}\r\n+\r\n+\t\t\t// Transaction'ı tamamla\r\n+\t\t\t$this->db->trans_commit();\r\n+\t\t\t\r\n+\t\t\tif ($this->db->trans_status() === FALSE) {\r\n+\t\t\t\tthrow new Exception('Veritabanı işlemi başarısız');\r\n+\t\t\t}\r\n+\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'success',\r\n+\t\t\t\t'message' => count($temiz_idler) . ' adet ' . $tablo_adi . ' kaydı başarıyla silindi.'\r\n+\t\t\t]);\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t$this->db->trans_rollback();\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'status' => 'error',\r\n+\t\t\t\t'message' => 'Silme işlemi sırasında hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1758629240878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4348,13 +4348,13 @@\n \t\t\t$columns = [];\r\n \t\t\t\r\n \t\t\tswitch ($tablo_kodu) {\r\n \t\t\t\tcase 'satis_faturalari':\r\n-\t\t\t\t\t$query = $this->db->select('satis_id as id, satis_faturaNo, satis_faturaTarihi, satis_genelToplam, satis_aciklama')\r\n+\t\t\t\t\t$query = $this->db->select('satis_id as id, satis_id as fatura_no, satis_faturaTarihi as fatura_tarihi, satis_aciklama as aciklama')\r\n \t\t\t\t\t\t\t\t\t  ->where('satis_cariID', $cari_id)\r\n \t\t\t\t\t\t\t\t\t  ->get('satisfaturasi');\r\n \t\t\t\t\t$data = $query->result_array();\r\n-\t\t\t\t\t$columns = ['Fatura No', 'Fatura Tarihi', 'Genel Toplam', 'Açıklama'];\r\n+\t\t\t\t\t$columns = ['Fatura No', 'Fatura Tarihi', 'Açıklama'];\r\n \t\t\t\t\tbreak;\r\n \t\t\t\t\t\r\n \t\t\t\tcase 'alis_faturalari':\r\n \t\t\t\t\t$query = $this->db->select('alis_id as id, alis_faturaNo, alis_faturaTarihi, alis_genelToplam, alis_aciklama')\r\n"
                },
                {
                    "date": 1758636537108,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4582,5 +4582,76 @@\n \t\t\t\t'message' => 'Silme işlemi sırasında hata oluştu: ' . $e->getMessage()\r\n \t\t\t]);\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Cariye ait satış detaylarını getir - AJAX\r\n+\t */\r\n+\tpublic function testSatisList()\r\n+\t{\r\n+\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\r\n+\t\tif (!$cari_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// Satış faturası bilgilerini getir (stok bilgileri ile birlikte)\r\n+\t\t\t$query = \"\r\n+\t\t\t\tSELECT \r\n+\t\t\t\t\tsf.satis_id as satis_sozlesme_id,\r\n+\t\t\t\t\tsf.satis_vergiDahilToplam as satis_sozlesme_tutari,\r\n+\t\t\t\t\t-- Stok adı bilgisi\r\n+\t\t\t\t\tGROUP_CONCAT(\r\n+\t\t\t\t\t\tCASE \r\n+\t\t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 1 THEN 'DİGİTÜRK'\r\n+\t\t\t\t\t\t\tWHEN s.stok_id = 16 THEN 'S SPORT'\r\n+\t\t\t\t\t\t\tWHEN s.stok_id = 13 THEN 'TABİİ'\r\n+\t\t\t\t\t\t\tELSE COALESCE(s.stok_ad, 'Bilinmeyen Stok')\r\n+\t\t\t\t\t\tEND\r\n+\t\t\t\t\t\tSEPARATOR ', '\r\n+\t\t\t\t\t) as satis_sozlesme_hizmet,\r\n+\t\t\t\t\t-- Görsel sayısını hesapla\r\n+\t\t\t\t\tCASE \r\n+\t\t\t\t\t\tWHEN sf.satis_dosya IS NOT NULL AND sf.satis_dosya != '' \r\n+\t\t\t\t\t\tTHEN (LENGTH(sf.satis_dosya) - LENGTH(REPLACE(sf.satis_dosya, ',', '')) + 1)\r\n+\t\t\t\t\t\tELSE 0\r\n+\t\t\t\t\tEND as gorsel_sayisi\r\n+\t\t\t\tFROM satisFaturasi sf\r\n+\t\t\t\tLEFT JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf.satis_id\r\n+\t\t\t\tLEFT JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n+\t\t\t\tWHERE sf.satis_cariID = ? \r\n+\t\t\t\tGROUP BY sf.satis_id\r\n+\t\t\t\tORDER BY sf.satis_id DESC\r\n+\t\t\t\";\r\n+\t\t\t\r\n+\t\t\t$satislar = $this->db->query($query, [$cari_id])->result();\r\n+\t\t\t\r\n+\t\t\t// Verileri formatla\r\n+\t\t\tforeach($satislar as $satis) {\r\n+\t\t\t\t// Tutarı formatla\r\n+\t\t\t\tif($satis->satis_sozlesme_tutari) {\r\n+\t\t\t\t\t$satis->satis_sozlesme_tutari = number_format($satis->satis_sozlesme_tutari, 2, ',', '.') . ' TL';\r\n+\t\t\t\t}\r\n+\t\t\t\t// Tarih bilgisini satış ID'sine göre ayarla\r\n+\t\t\t\t$satis->tarih = 'Satış #' . $satis->satis_sozlesme_id;\r\n+\t\t\t\t// Eğer hizmet bilgisi boş ise varsayılan değer ver\r\n+\t\t\t\tif(empty($satis->satis_sozlesme_hizmet)) {\r\n+\t\t\t\t\t$satis->satis_sozlesme_hizmet = 'Hizmet Bilgisi Yok';\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => true, \r\n+\t\t\t\t'satislar' => $satislar\r\n+\t\t\t]);\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode([\r\n+\t\t\t\t'success' => false, \r\n+\t\t\t\t'message' => 'Satış bilgileri yüklenirken hata oluştu: ' . $e->getMessage()\r\n+\t\t\t]);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759161938854,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2821,13 +2821,13 @@\n \t\t// Memory limit artır (performans için)\r\n \t\tini_set('memory_limit', '512M');\r\n \t\tini_set('max_execution_time', 600);\r\n \t\t\r\n-\t\t// Yetki kontrolü\r\n+\t\t// Yetki kontrolü kaldırıldı - herkes erişebilir\r\n \t\t$control2 = session(\"r\", \"login\");\r\n-\t\tif (!grup_modul_yetkisi_var(531)) {\r\n-\t\t\tredirect(base_url(\"illegal\"));\r\n-\t\t}\r\n+\t\t// if (!grup_modul_yetkisi_var(531)) {\r\n+\t\t//\tredirect(base_url(\"illegal\"));\r\n+\t\t// }\r\n \t\t\r\n \t\t$data = [];\r\n \t\t\r\n \t\t// Arama parametrelerini al\r\n@@ -4653,5 +4653,205 @@\n \t\t\t\t'message' => 'Satış bilgileri yüklenirken hata oluştu: ' . $e->getMessage()\r\n \t\t\t]);\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Tam Ana Rapor Excel Export - Yetki kontrolsüz\r\n+\t */\r\n+\tpublic function tam_ana_rapor_excel()\r\n+\t{\r\n+\t\t// Memory limit artır (performans için)\r\n+\t\tini_set('memory_limit', '512M');\r\n+\t\tini_set('max_execution_time', 600);\r\n+\t\t\r\n+\t\t// Yetki kontrolü kaldırıldı - herkes erişebilir\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// PhpSpreadsheet kütüphanelerini yükle\r\n+\t\t\trequire_once FCPATH . 'vendor/autoload.php';\r\n+\t\t\t\r\n+\t\t\t// Arama parametrelerini al (tam_ana_rapor ile aynı)\r\n+\t\t\t$cari_search = $this->input->get('cari_search');\r\n+\t\t\t$aktivasyon_durum = $this->input->get('aktivasyon_durum');\r\n+\t\t\t\r\n+\t\t\t// WHERE koşulları için dizi\r\n+\t\t\t$where_conditions = ['c.cari_durum = 1'];\r\n+\t\t\t\r\n+\t\t\t// Cari arama koşulu ekleme\r\n+\t\t\tif (!empty($cari_search)) {\r\n+\t\t\t\t$search_term = $this->db->escape_like_str($cari_search);\r\n+\t\t\t\t$where_conditions[] = \"(\r\n+\t\t\t\t\tc.cari_ad LIKE '%{$search_term}%' OR \r\n+\t\t\t\t\tc.cari_soyad LIKE '%{$search_term}%' OR \r\n+\t\t\t\t\tc.cari_vergiNumarasi LIKE '%{$search_term}%' OR \r\n+\t\t\t\t\tc.cari_firmaTelefon LIKE '%{$search_term}%'\r\n+\t\t\t\t)\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// WHERE koşullarını birleştir\r\n+\t\t\t$where_clause = 'WHERE ' . implode(' AND ', $where_conditions);\r\n+\t\t\t\r\n+\t\t\t// Aktivasyon durum filtresi için HAVING koşulu\r\n+\t\t\t$having_clause = '';\r\n+\t\t\tif (!empty($aktivasyon_durum)) {\r\n+\t\t\t\t$having_clause = \"HAVING aktivasyon_durum = '\" . $this->db->escape_str($aktivasyon_durum) . \"'\";\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Tam Ana Rapor sorgusu (tam_ana_rapor metodundan kopyalandı)\r\n+\t\t\t$query = \"\r\n+\t\t\t\tSELECT DISTINCT\r\n+\t\t\t\t\tc.cari_id,\r\n+\t\t\t\t\tc.cari_ad,\r\n+\t\t\t\t\tc.cari_soyad,\r\n+\t\t\t\t\tCASE \r\n+\t\t\t\t\t\tWHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n+\t\t\t\t\t\tTHEN c.cari_ad \r\n+\t\t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n+\t\t\t\t\tEND as cari_isletme,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Kayıt tarihi (en yeni önce sıralama için)\r\n+\t\t\t\t\tCOALESCE(c.cari_olusturmaTarihi, '2000-01-01') as kayit_tarihi,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Satış sözleşmesi bilgileri (en yeni satış)\r\n+\t\t\t\t\t(SELECT sf2.satis_id FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_id,\r\n+\t\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar,\r\n+\t\t\t\t\t(SELECT sf2.satis_vergiDahilToplam FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id ORDER BY sf2.satis_id DESC LIMIT 1) as satis_sozlesme_tutar_kdv_dahil,\r\n+\t\t\t\t\t-- Toplam satış sayısı\r\n+\t\t\t\t\t(SELECT COUNT(*) FROM satisFaturasi sf2 WHERE sf2.satis_cariID = c.cari_id) as toplam_satis_sayisi,\r\n+\t\t\t\t\t-- Stok adı bilgisi (en yeni satıştan) - birden fazla stok göstermek için GROUP_CONCAT kullan\r\n+\t\t\t\t\t(SELECT GROUP_CONCAT(\r\n+\t\t\t\t\t\tCASE \r\n+\t\t\t\t\t\t\tWHEN s.stok_stokGrupKoduID = 1 THEN 'DIGITURK'\r\n+\t\t\t\t\t\t\tWHEN s.stok_id = 16 THEN 'S SPORT'\r\n+\t\t\t\t\t\t\tWHEN s.stok_id = 13 THEN 'TABII'\r\n+\t\t\t\t\t\t\tELSE s.stok_ad\r\n+\t\t\t\t\t\tEND\r\n+\t\t\t\t\t\tSEPARATOR ', '\r\n+\t\t\t\t\t )\r\n+\t\t\t\t\t FROM satisFaturasi sf2 \r\n+\t\t\t\t\t INNER JOIN satisFaturasiStok sfs ON sfs.satisStok_satisFaturasiID = sf2.satis_id\r\n+\t\t\t\t\t INNER JOIN stok s ON sfs.satisStok_stokID = s.stok_id\r\n+\t\t\t\t\t WHERE sf2.satis_cariID = c.cari_id AND sf2.satis_id = (\r\n+\t\t\t\t\t\t SELECT sf3.satis_id FROM satisFaturasi sf3 WHERE sf3.satis_cariID = c.cari_id ORDER BY sf3.satis_id DESC LIMIT 1\r\n+\t\t\t\t\t )\r\n+\t\t\t\t\t GROUP BY sf2.satis_id\r\n+\t\t\t\t\t) as satis_sozlesme_hizmeti,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap (banka, çek, kasa, senet)\r\n+\t\t\t\t\tCOALESCE(ch_toplam.toplam_tahsilat, 0) as tahsilat_tutar,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t-- Aktivasyon durumu (en yeni aktivasyondan)\r\n+\t\t\t\t\t(SELECT COALESCE(ad2.aktivasyon_durum_adi, 'Tanımlanmamış') \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t LEFT JOIN aktivasyon_durum ad2 ON a2.aktivasyon_durum_id = ad2.aktivasyon_durum_id AND ad2.durum = 1\r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_durum,\r\n+\t\t\t\t\t \r\n+\t\t\t\t\t(SELECT a2.aktivasyon_tarihi \r\n+\t\t\t\t\t FROM aktivasyon a2 \r\n+\t\t\t\t\t WHERE a2.aktivasyon_cari_id = c.cari_id \r\n+\t\t\t\t\t ORDER BY a2.aktivasyon_id DESC LIMIT 1) as aktivasyon_tarihi,\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n+\t\t\t\t\t\r\n+\t\t\t\tFROM cari c\r\n+\t\t\t\t\r\n+\t\t\t\t-- Tahsilat tutarını farklı tablolardan toplama yap\r\n+\t\t\t\tLEFT JOIN (\r\n+\t\t\t\t\tSELECT \r\n+\t\t\t\t\t\tc2.cari_id,\r\n+\t\t\t\t\t\t(\r\n+\t\t\t\t\t\t\t-- Banka/Pos tahsilatları\r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(bh.bh_giris) FROM bankahareketleri bh WHERE bh.bh_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t\t-- Çek tahsilatları  \r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(ck.cek_tutar) FROM cek ck WHERE ck.cek_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t\t-- Kasa/Nakit tahsilatları\r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(kh.kh_giris) FROM kasahareketleri kh WHERE kh.kh_cariID = c2.cari_id), 0) +\r\n+\t\t\t\t\t\t\t-- Senet tahsilatları\r\n+\t\t\t\t\t\t\tCOALESCE((SELECT SUM(s.senet_tutar) FROM senet s WHERE s.senet_cariID = c2.cari_id), 0)\r\n+\t\t\t\t\t\t) as toplam_tahsilat\r\n+\t\t\t\t\tFROM cari c2\r\n+\t\t\t\t) ch_toplam ON c.cari_id = ch_toplam.cari_id\r\n+\t\t\t\t\r\n+\t\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n+\t\t\t\t\r\n+\t\t\t\t{$where_clause}\r\n+\t\t\t\tGROUP BY c.cari_id\r\n+\t\t\t\t{$having_clause}\r\n+\t\t\t\tORDER BY \r\n+\t\t\t\t\tCASE WHEN c.cari_olusturmaTarihi IS NULL THEN 1 ELSE 0 END,\r\n+\t\t\t\t\tc.cari_olusturmaTarihi DESC, \r\n+\t\t\t\t\tc.cari_ad, c.cari_soyad\r\n+\t\t\t\";\r\n+\t\t\t\r\n+\t\t\t$rapor_verileri = $this->db->query($query)->result();\r\n+\t\t\t\r\n+\t\t\t// Excel dosyası oluştur\r\n+\t\t\t$spreadsheet = new \\PhpOffice\\PhpSpreadsheet\\Spreadsheet();\r\n+\t\t\t$sheet = $spreadsheet->getActiveSheet();\r\n+\t\t\t\r\n+\t\t\t// Başlık satırı\r\n+\t\t\t$headers = [\r\n+\t\t\t\t'A1' => 'Cari Ad',\r\n+\t\t\t\t'B1' => 'İşletme',\r\n+\t\t\t\t'C1' => 'Satış Sözleşme Tutarı',\r\n+\t\t\t\t'D1' => 'Satış Sözleşme Hizmeti',\r\n+\t\t\t\t'E1' => 'Satış Sözleşme Tutarı (KDV Dahil)',\r\n+\t\t\t\t'F1' => 'Tahsilat Tutar',\r\n+\t\t\t\t'G1' => 'Aktivasyon Durum',\r\n+\t\t\t\t'H1' => 'Aktivasyon Tarihi',\r\n+\t\t\t\t'I1' => 'Personel'\r\n+\t\t\t];\r\n+\t\t\t\r\n+\t\t\t// Başlıkları yaz\r\n+\t\t\tforeach ($headers as $cell => $header) {\r\n+\t\t\t\t$sheet->setCellValue($cell, $header);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Başlık satırını formatla\r\n+\t\t\t$sheet->getStyle('A1:I1')->getFont()->setBold(true);\r\n+\t\t\t$sheet->getStyle('A1:I1')->getFill()\r\n+\t\t\t\t->setFillType(\\PhpOffice\\PhpSpreadsheet\\Style\\Fill::FILL_SOLID)\r\n+\t\t\t\t->getStartColor()->setARGB('CCCCCC');\r\n+\t\t\t\r\n+\t\t\t// Verileri yaz\r\n+\t\t\t$row = 2;\r\n+\t\t\tforeach ($rapor_verileri as $veri) {\r\n+\t\t\t\t$sheet->setCellValue('A' . $row, $veri->cari_ad . ' ' . $veri->cari_soyad);\r\n+\t\t\t\t$sheet->setCellValue('B' . $row, $veri->cari_isletme);\r\n+\t\t\t\t$sheet->setCellValue('C' . $row, $veri->satis_sozlesme_tutar ? number_format($veri->satis_sozlesme_tutar, 2, ',', '.') : '0');\r\n+\t\t\t\t$sheet->setCellValue('D' . $row, $veri->satis_sozlesme_hizmeti ?: '-');\r\n+\t\t\t\t$sheet->setCellValue('E' . $row, $veri->satis_sozlesme_tutar_kdv_dahil ? number_format($veri->satis_sozlesme_tutar_kdv_dahil, 2, ',', '.') : '0');\r\n+\t\t\t\t$sheet->setCellValue('F' . $row, $veri->tahsilat_tutar ? number_format($veri->tahsilat_tutar, 2, ',', '.') : '0');\r\n+\t\t\t\t$sheet->setCellValue('G' . $row, $veri->aktivasyon_durum ?: 'Tanımlanmamış');\r\n+\t\t\t\t$sheet->setCellValue('H' . $row, $veri->aktivasyon_tarihi ? date('d.m.Y', strtotime($veri->aktivasyon_tarihi)) : '-');\r\n+\t\t\t\t$sheet->setCellValue('I' . $row, $veri->personel ?: '-');\r\n+\t\t\t\t$row++;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Sütun genişliklerini ayarla\r\n+\t\t\tforeach (range('A', 'I') as $column) {\r\n+\t\t\t\t$sheet->getColumnDimension($column)->setAutoSize(true);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// Dosya adı ve tarih\r\n+\t\t\tdate_default_timezone_set('Europe/Istanbul');\r\n+\t\t\t$tarih = date('d-m-Y_H-i-s');\r\n+\t\t\t$filename = 'tam-ana-rapor-' . $tarih;\r\n+\t\t\t\r\n+\t\t\t// Excel dosyasını oluştur ve indir\r\n+\t\t\t$writer = new \\PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx($spreadsheet);\r\n+\t\t\t\r\n+\t\t\theader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n+\t\t\theader('Content-Disposition: attachment;filename=\"' . $filename . '.xlsx\"');\r\n+\t\t\theader('Cache-Control: max-age=0');\r\n+\t\t\t\r\n+\t\t\t$writer->save('php://output');\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata durumunda kullanıcıyı bilgilendir\r\n+\t\t\t$this->session->set_flashdata('excel_hata', 'Excel export sırasında hata oluştu: ' . $e->getMessage());\r\n+\t\t\tredirect('muhasebe/tam-ana-rapor');\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759502614710,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4853,5 +4853,96 @@\n \t\t\t$this->session->set_flashdata('excel_hata', 'Excel export sırasında hata oluştu: ' . $e->getMessage());\r\n \t\t\tredirect('muhasebe/tam-ana-rapor');\r\n \t\t}\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Cari detaylarını getir (AJAX endpoint)\r\n+\t */\r\n+\tpublic function getCariDetaylar()\r\n+\t{\r\n+\t\t// AJAX isteği kontrolü\r\n+\t\tif (!$this->input->is_ajax_request()) {\r\n+\t\t\tshow_404();\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// Session kontrolü\r\n+\t\t$control = session(\"r\", \"login_info\");\r\n+\t\tif (!$control || !isset($control->kullanici_id)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Oturum süresi dolmuş']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\t// POST verilerini al\r\n+\t\t$cari_id = $this->input->post('cari_id', true);\r\n+\r\n+\t\tif (empty($cari_id)) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\r\n+\t\ttry {\r\n+\t\t\t// Önce cari ID'yi değişken olarak tanımla ve sorguyu çalıştır\r\n+\t\t\t$this->db->query(\"SET @CariID := ?\", array($cari_id));\r\n+\t\t\t\r\n+\t\t\t$query = \"\r\n+\t\t\t\tSELECT 'Çek' AS Kalem,\r\n+\t\t\t\t       COALESCE((\r\n+\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(c.cek_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(c.cek_tutar, 0))\r\n+\t\t\t\t                              ORDER BY c.cek_vadeTarih SEPARATOR ' | ')\r\n+\t\t\t\t         FROM cek c\r\n+\t\t\t\t         WHERE c.cek_cariID = @CariID\r\n+\t\t\t\t       ), '—') AS Detay\r\n+\t\t\t\tUNION ALL\r\n+\t\t\t\tSELECT 'Banka & Pos' AS Kalem,\r\n+\t\t\t\t       COALESCE((\r\n+\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(b.bh_tarih, '%Y-%m-%d'), ' / ', FORMAT(b.bh_giris, 0))\r\n+\t\t\t\t                              ORDER BY b.bh_tarih SEPARATOR ' | ')\r\n+\t\t\t\t         FROM bankahareketleri b\r\n+\t\t\t\t         WHERE b.bh_cariID = @CariID\r\n+\t\t\t\t       ), '—') AS Detay\r\n+\t\t\t\tUNION ALL\r\n+\t\t\t\tSELECT 'Senet' AS Kalem,\r\n+\t\t\t\t       COALESCE((\r\n+\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(s.senet_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(s.senet_tutar, 0))\r\n+\t\t\t\t                              ORDER BY s.senet_vadeTarih SEPARATOR ' | ')\r\n+\t\t\t\t         FROM senet s\r\n+\t\t\t\t         WHERE s.senet_cariID = @CariID\r\n+\t\t\t\t       ), '—') AS Detay\r\n+\t\t\t\tUNION ALL\r\n+\t\t\t\tSELECT 'Nakit (Kasa)' AS Kalem,\r\n+\t\t\t\t       COALESCE((\r\n+\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(k.kh_tarih, '%Y-%m-%d'), ' / ', FORMAT(k.kh_giris, 0))\r\n+\t\t\t\t                              ORDER BY k.kh_tarih SEPARATOR ' | ')\r\n+\t\t\t\t         FROM kasahareketleri k\r\n+\t\t\t\t         WHERE k.kh_cariID = @CariID\r\n+\t\t\t\t       ), '—') AS Detay\r\n+\t\t\t\";\r\n+\r\n+\t\t\t$result = $this->db->query($query);\r\n+\t\t\t\r\n+\t\t\tif ($result && $result->num_rows() > 0) {\r\n+\t\t\t\t$data = $result->result();\r\n+\t\t\t\t\r\n+\t\t\t\t// Boş kayıtları filtrele (sadece \"—\" olanları çıkar)\r\n+\t\t\t\t$filteredData = array_filter($data, function($item) {\r\n+\t\t\t\t\treturn $item->Detay !== '—';\r\n+\t\t\t\t});\r\n+\t\t\t\t\r\n+\t\t\t\techo json_encode([\r\n+\t\t\t\t\t'success' => true, \r\n+\t\t\t\t\t'data' => array_values($filteredData), // array_values ile indexleri sıfırla\r\n+\t\t\t\t\t'total_count' => count($data),\r\n+\t\t\t\t\t'filtered_count' => count($filteredData)\r\n+\t\t\t\t]);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Veri bulunamadı']);\r\n+\t\t\t}\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata logla\r\n+\t\t\tlog_message('error', 'getCariDetaylar hatası: ' . $e->getMessage());\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası: ' . $e->getMessage()]);\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759581215672,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4854,95 +4854,6 @@\n \t\t\tredirect('muhasebe/tam-ana-rapor');\r\n \t\t}\r\n \t}\r\n \r\n-\t/**\r\n-\t * Cari detaylarını getir (AJAX endpoint)\r\n-\t */\r\n-\tpublic function getCariDetaylar()\r\n-\t{\r\n-\t\t// AJAX isteği kontrolü\r\n-\t\tif (!$this->input->is_ajax_request()) {\r\n-\t\t\tshow_404();\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t// Session kontrolü\r\n-\t\t$control = session(\"r\", \"login_info\");\r\n-\t\tif (!$control || !isset($control->kullanici_id)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Oturum süresi dolmuş']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\t// POST verilerini al\r\n-\t\t$cari_id = $this->input->post('cari_id', true);\r\n-\r\n-\t\tif (empty($cari_id)) {\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n-\t\t\treturn;\r\n-\t\t}\r\n-\r\n-\t\ttry {\r\n-\t\t\t// Önce cari ID'yi değişken olarak tanımla ve sorguyu çalıştır\r\n-\t\t\t$this->db->query(\"SET @CariID := ?\", array($cari_id));\r\n-\t\t\t\r\n-\t\t\t$query = \"\r\n-\t\t\t\tSELECT 'Çek' AS Kalem,\r\n-\t\t\t\t       COALESCE((\r\n-\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(c.cek_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(c.cek_tutar, 0))\r\n-\t\t\t\t                              ORDER BY c.cek_vadeTarih SEPARATOR ' | ')\r\n-\t\t\t\t         FROM cek c\r\n-\t\t\t\t         WHERE c.cek_cariID = @CariID\r\n-\t\t\t\t       ), '—') AS Detay\r\n-\t\t\t\tUNION ALL\r\n-\t\t\t\tSELECT 'Banka & Pos' AS Kalem,\r\n-\t\t\t\t       COALESCE((\r\n-\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(b.bh_tarih, '%Y-%m-%d'), ' / ', FORMAT(b.bh_giris, 0))\r\n-\t\t\t\t                              ORDER BY b.bh_tarih SEPARATOR ' | ')\r\n-\t\t\t\t         FROM bankahareketleri b\r\n-\t\t\t\t         WHERE b.bh_cariID = @CariID\r\n-\t\t\t\t       ), '—') AS Detay\r\n-\t\t\t\tUNION ALL\r\n-\t\t\t\tSELECT 'Senet' AS Kalem,\r\n-\t\t\t\t       COALESCE((\r\n-\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(s.senet_vadeTarih, '%Y-%m-%d'), ' / ', FORMAT(s.senet_tutar, 0))\r\n-\t\t\t\t                              ORDER BY s.senet_vadeTarih SEPARATOR ' | ')\r\n-\t\t\t\t         FROM senet s\r\n-\t\t\t\t         WHERE s.senet_cariID = @CariID\r\n-\t\t\t\t       ), '—') AS Detay\r\n-\t\t\t\tUNION ALL\r\n-\t\t\t\tSELECT 'Nakit (Kasa)' AS Kalem,\r\n-\t\t\t\t       COALESCE((\r\n-\t\t\t\t         SELECT GROUP_CONCAT(CONCAT(DATE_FORMAT(k.kh_tarih, '%Y-%m-%d'), ' / ', FORMAT(k.kh_giris, 0))\r\n-\t\t\t\t                              ORDER BY k.kh_tarih SEPARATOR ' | ')\r\n-\t\t\t\t         FROM kasahareketleri k\r\n-\t\t\t\t         WHERE k.kh_cariID = @CariID\r\n-\t\t\t\t       ), '—') AS Detay\r\n-\t\t\t\";\r\n-\r\n-\t\t\t$result = $this->db->query($query);\r\n-\t\t\t\r\n-\t\t\tif ($result && $result->num_rows() > 0) {\r\n-\t\t\t\t$data = $result->result();\r\n-\t\t\t\t\r\n-\t\t\t\t// Boş kayıtları filtrele (sadece \"—\" olanları çıkar)\r\n-\t\t\t\t$filteredData = array_filter($data, function($item) {\r\n-\t\t\t\t\treturn $item->Detay !== '—';\r\n-\t\t\t\t});\r\n-\t\t\t\t\r\n-\t\t\t\techo json_encode([\r\n-\t\t\t\t\t'success' => true, \r\n-\t\t\t\t\t'data' => array_values($filteredData), // array_values ile indexleri sıfırla\r\n-\t\t\t\t\t'total_count' => count($data),\r\n-\t\t\t\t\t'filtered_count' => count($filteredData)\r\n-\t\t\t\t]);\r\n-\t\t\t} else {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Veri bulunamadı']);\r\n-\t\t\t}\r\n-\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\t// Hata logla\r\n-\t\t\tlog_message('error', 'getCariDetaylar hatası: ' . $e->getMessage());\r\n-\t\t\techo json_encode(['success' => false, 'message' => 'Veritabanı hatası: ' . $e->getMessage()]);\r\n-\t\t}\r\n-\t}\r\n+\t// getCariDetaylar method removed - payment details no longer shown in Stok Bilgileri modal\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759838247746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,15 @@\n <?php\r\n \r\n defined('BASEPATH') OR exit('No direct script access allowed');\r\n \r\n+require_once APPPATH . '../vendor/autoload.php';\r\n \r\n+use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\r\n+use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\r\n+use PhpOffice\\PhpSpreadsheet\\Style\\Alignment;\r\n+use PhpOffice\\PhpSpreadsheet\\Style\\Border;\r\n+use PhpOffice\\PhpSpreadsheet\\Style\\Fill;\r\n \r\n class Muhasebe extends CI_Controller {\r\n \r\n \t\tpublic function __construct()\r\n@@ -1848,10 +1854,246 @@\n \t\treturn $this->db->query($istatistikQ)->row();\r\n \r\n \t}\r\n \r\n+\t/**\r\n+\t * Senet Yönetimi Excel İndir\r\n+\t */\r\n+\tpublic function senet_yonetim_excel()\r\n+\t{\r\n+\t\t// Yetki kontrolü - Senet Yönetimi (ID: 522)\r\n+\t\tif (!grup_modul_yetkisi_var(522)) {\r\n+\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Senet Yönetimi (ID: 522)', 403);\r\n+\t\t\treturn;\r\n+\t\t}\r\n \r\n+\t\t// Session kontrolü\r\n+\t\t$control = session(\"r\", \"login_info\");\r\n+\t\tif (!$control || !isset($control->kullanici_id)) {\r\n+\t\t\tredirect(base_url('check'));\r\n+\t\t\treturn;\r\n+\t\t}\r\n \r\n+\t\t// Durum filtresi\r\n+\t\t$durum_filter = $this->input->get('durum');\r\n+\t\t$valid_durumlar = ['eldeki', 'bankaya-verilen', 'tahsil-edilen', 'protesto', 'vadesi-gecen'];\r\n+\t\t\r\n+\t\tif (!$durum_filter || !in_array($durum_filter, $valid_durumlar)) {\r\n+\t\t\t$durum_filter = 'eldeki'; // Default\r\n+\t\t}\r\n+\r\n+\t\t// Arama parametresi\r\n+\t\t$search_param = $this->input->get('search');\r\n+\r\n+\t\t// Durum ID'lerini map et\r\n+\t\t$durum_map = [\r\n+\t\t\t'eldeki' => 1,           // Eldeki Bekleyen Senetler\r\n+\t\t\t'bankaya-verilen' => 2,  // Bankaya Verilen Senetler  \r\n+\t\t\t'tahsil-edilen' => 3,    // Bankadan Tahsil Edilen Senetler\r\n+\t\t\t'protesto' => 4,         // Protesto Olan Senetler\r\n+\t\t\t'vadesi-gecen' => 5      // Vadesi Geçen Tahsilatlar\r\n+\t\t];\r\n+\r\n+\t\t$durum_id = $durum_map[$durum_filter];\r\n+\r\n+\t\t// Ana sorgu - Vadesi geçen durumu için özel sorgu\r\n+\t\tif ($durum_filter == 'vadesi-gecen') {\r\n+\t\t\t$senetlerQ = \"\r\n+\t\t\t\tSELECT s.*, \r\n+\t\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n+\t\t\t\t\t   c.cari_firmaTelefon as cari_telefon,\r\n+\t\t\t\t\t   CONCAT_WS(' ', k.kullanici_ad, k.kullanici_soyad) as personel_adi,\r\n+\t\t\t\t\t   'Vadesi Geçen' as son_durum,\r\n+\t\t\t\t\t   NULL as banka_hesap_adi,\r\n+\t\t\t\t\t   DATEDIFF(s.senet_vadeTarih, CURDATE()) as vade_gun_kalan\r\n+\t\t\t\tFROM senet s\r\n+\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n+\t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n+\t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n+\t\t\t\tAND (mtd.durum IS NULL OR mtd.durum != 2)\r\n+\t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n+\t\t\t\";\r\n+\t\t} else {\r\n+\t\t\t// Ana sorgu - Senet tablosu için doğru sütun adlarını kullan\r\n+\t\t\t$senetlerQ = \"\r\n+\t\t\t\tSELECT s.*, \r\n+\t\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n+\t\t\t\t\t   c.cari_firmaTelefon as cari_telefon,\r\n+\t\t\t\t\t   CONCAT_WS(' ', k.kullanici_ad, k.kullanici_soyad) as personel_adi,\r\n+\t\t\t\t\t   skt.skt_adi as son_durum,\r\n+\t\t\t\t\t   b.banka_bankaAd as banka_hesap_adi,\r\n+\t\t\t\t\t   DATEDIFF(s.senet_vadeTarih, CURDATE()) as vade_gun_kalan\r\n+\t\t\t\tFROM senet s\r\n+\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n+\t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n+\t\t\t\tLEFT JOIN (\r\n+\t\t\t\t\tSELECT sh1.sh_senet_id, MAX(sh1.sh_id) as max_id\r\n+\t\t\t\t\tFROM senet_hareketleri sh1\r\n+\t\t\t\t\tGROUP BY sh1.sh_senet_id\r\n+\t\t\t\t) son_hareket ON s.senet_id = son_hareket.sh_senet_id\r\n+\t\t\t\tLEFT JOIN senet_hareketleri sh_son ON son_hareket.max_id = sh_son.sh_id\r\n+\t\t\t\tLEFT JOIN senet_konum_tipleri skt ON sh_son.sh_konum_tip_id = skt.skt_id\r\n+\t\t\t\tLEFT JOIN banka b ON sh_son.sh_banka_id = b.banka_id\r\n+\t\t\t\tWHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\r\n+\t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n+\t\t\t\";\r\n+\t\t}\r\n+\r\n+\t\t// Arama koşulunu ekle\r\n+\t\tif (!empty($search_param)) {\r\n+\t\t\t$search_escaped = $this->db->escape_like_str($search_param);\r\n+\t\t\t$search_condition = \" AND (\r\n+\t\t\t\tc.cari_vergiNumarasi LIKE '%$search_escaped%' OR\r\n+\t\t\t\tCONCAT(c.cari_ad, ' ', c.cari_soyad) LIKE '%$search_escaped%' OR\r\n+\t\t\t\tc.cari_ad LIKE '%$search_escaped%' OR\r\n+\t\t\t\tc.cari_firmaTelefon LIKE '%$search_escaped%'\r\n+\t\t\t)\";\r\n+\t\t\t\r\n+\t\t\tif ($durum_filter == 'vadesi-gecen') {\r\n+\t\t\t\t$senetlerQ = str_replace(\r\n+\t\t\t\t\t\"AND (mtd.durum IS NULL OR mtd.durum != 2)\",\r\n+\t\t\t\t\t\"AND (mtd.durum IS NULL OR mtd.durum != 2) $search_condition\",\r\n+\t\t\t\t\t$senetlerQ\r\n+\t\t\t\t);\r\n+\t\t\t} else {\r\n+\t\t\t\t$senetlerQ = str_replace(\r\n+\t\t\t\t\t\"WHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\",\r\n+\t\t\t\t\t\"WHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1')) $search_condition\",\r\n+\t\t\t\t\t$senetlerQ\r\n+\t\t\t\t);\r\n+\t\t\t}\r\n+\t\t}\r\n+\r\n+\t\t// Verileri getir\r\n+\t\t$senetler = $this->db->query($senetlerQ)->result();\r\n+\r\n+\t\t// Excel oluştur\r\n+\t\t$spreadsheet = new Spreadsheet();\r\n+\t\t$sheet = $spreadsheet->getActiveSheet();\r\n+\r\n+\t\t// Başlık metni\r\n+\t\t$durum_basliklar = [\r\n+\t\t\t'eldeki' => 'Eldeki Bekleyen Senetler',\r\n+\t\t\t'bankaya-verilen' => 'Bankaya Verilen Senetler',\r\n+\t\t\t'tahsil-edilen' => 'Bankadan Tahsil Edilen Senetler',\r\n+\t\t\t'protesto' => 'Protesto Olan Senetler',\r\n+\t\t\t'vadesi-gecen' => 'Vadesi Geçen Tahsilatlar'\r\n+\t\t];\r\n+\r\n+\t\t$sheet->setTitle('Senet Listesi');\r\n+\r\n+\t\t// Başlık satırı\r\n+\t\t$sheet->setCellValue('A1', $durum_basliklar[$durum_filter]);\r\n+\t\t$sheet->mergeCells('A1:I1');\r\n+\t\t$sheet->getStyle('A1')->getFont()->setBold(true)->setSize(14);\r\n+\t\t$sheet->getStyle('A1')->getAlignment()->setHorizontal(Alignment::HORIZONTAL_CENTER);\r\n+\r\n+\t\t// Tarih bilgisi\r\n+\t\t$sheet->setCellValue('A2', 'Rapor Tarihi: ' . date('d.m.Y H:i'));\r\n+\t\t$sheet->mergeCells('A2:I2');\r\n+\t\t$sheet->getStyle('A2')->getAlignment()->setHorizontal(Alignment::HORIZONTAL_CENTER);\r\n+\r\n+\t\t// Kolon başlıkları\r\n+\t\t$headers = [\r\n+\t\t\t'A3' => 'Sıra No',\r\n+\t\t\t'B3' => 'Cari Adı',\r\n+\t\t\t'C3' => 'Cari Telefon', \r\n+\t\t\t'D3' => 'Senet Tutarı (₺)',\r\n+\t\t\t'E3' => 'Vade Tarihi',\r\n+\t\t\t'F3' => 'Durum',\r\n+\t\t\t'G3' => 'Kalan Gün',\r\n+\t\t\t'H3' => 'Personel',\r\n+\t\t\t'I3' => 'Banka'\r\n+\t\t];\r\n+\r\n+\t\tforeach ($headers as $cell => $header) {\r\n+\t\t\t$sheet->setCellValue($cell, $header);\r\n+\t\t}\r\n+\r\n+\t\t// Başlık stilini ayarla\r\n+\t\t$headerStyle = [\r\n+\t\t\t'font' => ['bold' => true],\r\n+\t\t\t'alignment' => ['horizontal' => Alignment::HORIZONTAL_CENTER],\r\n+\t\t\t'fill' => [\r\n+\t\t\t\t'fillType' => Fill::FILL_SOLID,\r\n+\t\t\t\t'startColor' => ['rgb' => 'E2E8F0']\r\n+\t\t\t],\r\n+\t\t\t'borders' => [\r\n+\t\t\t\t'allBorders' => ['borderStyle' => Border::BORDER_THIN]\r\n+\t\t\t]\r\n+\t\t];\r\n+\t\t$sheet->getStyle('A3:I3')->applyFromArray($headerStyle);\r\n+\r\n+\t\t// Verileri doldur\r\n+\t\t$row = 4;\r\n+\t\t$sira = 1;\r\n+\t\tforeach ($senetler as $senet) {\r\n+\t\t\t$sheet->setCellValue('A' . $row, $sira);\r\n+\t\t\t$sheet->setCellValue('B' . $row, $senet->cari_ad ?: 'Bilinmiyor');\r\n+\t\t\t$sheet->setCellValue('C' . $row, $senet->cari_telefon ?: '-');\r\n+\t\t\t$sheet->setCellValue('D' . $row, number_format($senet->senet_tutar, 2));\r\n+\t\t\t$sheet->setCellValue('E' . $row, date('d.m.Y', strtotime($senet->senet_vadeTarih)));\r\n+\t\t\t$sheet->setCellValue('F' . $row, $senet->son_durum ?: 'Personel\\'in Kendisinde');\r\n+\r\n+\t\t\t// Kalan gün hesapla\r\n+\t\t\tif ($senet->vade_gun_kalan > 0) {\r\n+\t\t\t\t$kalan_gun_text = $senet->vade_gun_kalan . ' gün';\r\n+\t\t\t} elseif ($senet->vade_gun_kalan == 0) {\r\n+\t\t\t\t$kalan_gun_text = 'Bugün';\r\n+\t\t\t} else {\r\n+\t\t\t\t$kalan_gun_text = abs($senet->vade_gun_kalan) . ' gün geçmiş';\r\n+\t\t\t}\r\n+\t\t\t$sheet->setCellValue('G' . $row, $kalan_gun_text);\r\n+\r\n+\t\t\t$sheet->setCellValue('H' . $row, $senet->personel_adi ?: '-');\r\n+\t\t\t$sheet->setCellValue('I' . $row, $senet->banka_hesap_adi ?: '-');\r\n+\r\n+\t\t\t$row++;\r\n+\t\t\t$sira++;\r\n+\t\t}\r\n+\r\n+\t\t// Kolon genişliklerini ayarla\r\n+\t\t$sheet->getColumnDimension('A')->setWidth(8);\r\n+\t\t$sheet->getColumnDimension('B')->setWidth(25);\r\n+\t\t$sheet->getColumnDimension('C')->setWidth(15);\r\n+\t\t$sheet->getColumnDimension('D')->setWidth(15);\r\n+\t\t$sheet->getColumnDimension('E')->setWidth(12);\r\n+\t\t$sheet->getColumnDimension('F')->setWidth(20);\r\n+\t\t$sheet->getColumnDimension('G')->setWidth(12);\r\n+\t\t$sheet->getColumnDimension('H')->setWidth(20);\r\n+\t\t$sheet->getColumnDimension('I')->setWidth(20);\r\n+\r\n+\t\t// Veri alanına border ekle\r\n+\t\tif ($row > 4) {\r\n+\t\t\t$dataStyle = [\r\n+\t\t\t\t'borders' => [\r\n+\t\t\t\t\t'allBorders' => ['borderStyle' => Border::BORDER_THIN]\r\n+\t\t\t\t],\r\n+\t\t\t\t'alignment' => ['horizontal' => Alignment::HORIZONTAL_CENTER]\r\n+\t\t\t];\r\n+\t\t\t$sheet->getStyle('A4:I' . ($row - 1))->applyFromArray($dataStyle);\r\n+\r\n+\t\t\t// Tutar sütununu sağa hizala\r\n+\t\t\t$sheet->getStyle('D4:D' . ($row - 1))->getAlignment()->setHorizontal(Alignment::HORIZONTAL_RIGHT);\r\n+\t\t}\r\n+\r\n+\t\t// Dosya adını oluştur\r\n+\t\t$filename = 'senet_listesi_' . $durum_filter . '.xlsx';\r\n+\r\n+\t\t// Header'ları ayarla\r\n+\t\theader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n+\t\theader('Content-Disposition: attachment;filename=\"' . $filename . '\"');\r\n+\t\theader('Cache-Control: max-age=0');\r\n+\r\n+\t\t// Excel dosyasını çıktı ver\r\n+\t\t$writer = new Xlsx($spreadsheet);\r\n+\t\t$writer->save('php://output');\r\n+\t\texit;\r\n+\t}\r\n+\r\n+\r\n+\r\n \tpublic function senet_detay($id)\r\n \r\n \t{\r\n \r\n"
                },
                {
                    "date": 1759839514431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3389,9 +3389,9 @@\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n-\t\t\t// Tahsilat detaylarını farklı tablolardan getir - cari hareket ID'si ve görsel alanları ile birlikte\r\n+\t\t\t// Tahsilat detaylarını farklı tablolardan getir - cari hareket ID'si, görsel alanları ve onay durumu ile birlikte\r\n \t\t\t$query = \"\r\n \t\t\t\t-- Banka/Pos tahsilatları\r\n \t\t\t\tSELECT \r\n \t\t\t\t\tCONCAT('bh_', bh.bh_id) as unique_id,\r\n@@ -3405,12 +3405,14 @@\n \t\t\t\t\t'1' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\tbh.bh_gorsel as gorsel_dosya,\r\n \t\t\t\t\t'dekontlar' as gorsel_klasor,\r\n-\t\t\t\t\tNULL as vade_tarih\r\n+\t\t\t\t\tNULL as vade_tarih,\r\n+\t\t\t\t\tCOALESCE(mtd.onay_durumu, 0) as onay_durumu\r\n \t\t\t\tFROM bankahareketleri bh\r\n \t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_bankaID = bh.bh_id AND ch.ch_cariID = bh.bh_cariID\r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n \t\t\t\tWHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n \t\t\t\t\r\n \t\t\t\tUNION ALL\r\n \t\t\t\t\r\n@@ -3427,11 +3429,13 @@\n \t\t\t\t\t'2' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\tc.cek_gorsel as gorsel_dosya,\r\n \t\t\t\t\t'cekler' as gorsel_klasor,\r\n-\t\t\t\t\tc.cek_vadeTarih as vade_tarih\r\n+\t\t\t\t\tc.cek_vadeTarih as vade_tarih,\r\n+\t\t\t\t\tCOALESCE(mtd.onay_durumu, 0) as onay_durumu\r\n \t\t\t\tFROM cek c\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_cekID = c.cek_id AND ch.ch_cariID = c.cek_cariID\r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n \t\t\t\tWHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n \t\t\t\t\r\n \t\t\t\tUNION ALL\r\n \t\t\t\t\r\n@@ -3448,12 +3452,14 @@\n \t\t\t\t\t'3' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\tNULL as gorsel_dosya,\r\n \t\t\t\t\tNULL as gorsel_klasor,\r\n-\t\t\t\t\tNULL as vade_tarih\r\n+\t\t\t\t\tNULL as vade_tarih,\r\n+\t\t\t\t\tCOALESCE(mtd.onay_durumu, 0) as onay_durumu\r\n \t\t\t\tFROM kasahareketleri kh\r\n \t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_kasaID = kh.kh_id AND ch.ch_cariID = kh.kh_cariID\r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n \t\t\t\tWHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n \t\t\t\t\r\n \t\t\t\tUNION ALL\r\n \t\t\t\t\r\n@@ -3470,11 +3476,13 @@\n \t\t\t\t\t'4' as tip_kod,\r\n \t\t\t\t\tch.ch_id as cari_hareket_id,\r\n \t\t\t\t\ts.senet_gorsel as gorsel_dosya,\r\n \t\t\t\t\t'senetler' as gorsel_klasor,\r\n-\t\t\t\t\ts.senet_vadeTarih as vade_tarih\r\n+\t\t\t\t\ts.senet_vadeTarih as vade_tarih,\r\n+\t\t\t\t\tCOALESCE(mtd.onay_durumu, 0) as onay_durumu\r\n \t\t\t\tFROM senet s\r\n \t\t\t\tLEFT JOIN carihareketleri ch ON ch.ch_senetID = s.senet_id AND ch.ch_cariID = s.senet_cariID\r\n+\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n \t\t\t\tWHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n \t\t\t\t\r\n \t\t\t\tORDER BY tarih DESC\r\n \t\t\t\";\r\n@@ -5097,5 +5105,93 @@\n \t\t}\r\n \t}\r\n \r\n \t// getCariDetaylar method removed - payment details no longer shown in Stok Bilgileri modal\r\n+\t\r\n+\t/**\r\n+\t * Tahsilat onay durumunu güncelle\r\n+\t */\r\n+\tpublic function updateTahsilatOnay()\r\n+\t{\r\n+\t\t// AJAX isteği kontrolü\r\n+\t\tif (!$this->input->is_ajax_request()) {\r\n+\t\t\tshow_404();\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\t$tahsilat_id = $this->input->post('tahsilat_id');\r\n+\t\t$onay_durumu = $this->input->post('onay_durumu');\r\n+\t\t\r\n+\t\tif (!$tahsilat_id) {\r\n+\t\t\techo json_encode(['success' => false, 'message' => 'Tahsilat ID gerekli']);\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t// İlk önce unique_id'yi parse et (örn: 'bh_123', 'cek_456')\r\n+\t\t\t$parts = explode('_', $tahsilat_id);\r\n+\t\t\tif (count($parts) < 2) {\r\n+\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tahsilat ID formatı']);\r\n+\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t$tip_prefix = $parts[0];\r\n+\t\t\t$source_id = $parts[1];\r\n+\t\t\t\r\n+\t\t\t// Tip kodunu belirle\r\n+\t\t\t$tip_kod = '';\r\n+\t\t\tswitch($tip_prefix) {\r\n+\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t$tip_kod = '1';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t$tip_kod = '2';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 'kh':\r\n+\t\t\t\t\t$tip_kod = '3';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tcase 's':\r\n+\t\t\t\t\t$tip_kod = '4';\r\n+\t\t\t\t\tbreak;\r\n+\t\t\t\tdefault:\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tahsilat tipi']);\r\n+\t\t\t\t\treturn;\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\t// muhasebe_tahsilat_durum tablosunda ilgili kaydı bul ve güncelle\r\n+\t\t\t$this->db->where('tahsilat_tipi', $tip_kod);\r\n+\t\t\t$this->db->where('kayit_id', $source_id);\r\n+\t\t\t\r\n+\t\t\t// Eğer kayıt yoksa ekle, varsa güncelle\r\n+\t\t\t$existing = $this->db->get('muhasebe_tahsilat_durum')->row();\r\n+\t\t\t\r\n+\t\t\tif ($existing) {\r\n+\t\t\t\t// Güncelle\r\n+\t\t\t\t$this->db->where('id', $existing->id);\r\n+\t\t\t\t$update_data = array(\r\n+\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n+\t\t\t\t\t'guncelleme_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t\t);\r\n+\t\t\t\t$this->db->update('muhasebe_tahsilat_durum', $update_data);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Yeni kayıt ekle\r\n+\t\t\t\t$insert_data = array(\r\n+\t\t\t\t\t'tahsilat_tipi' => $tip_kod,\r\n+\t\t\t\t\t'kayit_id' => $source_id,\r\n+\t\t\t\t\t'durum' => 1, // Varsayılan durum\r\n+\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n+\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t\t);\r\n+\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $insert_data);\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t\tif ($this->db->affected_rows() > 0) {\r\n+\t\t\t\techo json_encode(array('success' => true, 'message' => 'Onay durumu başarıyla güncellendi'));\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode(array('success' => false, 'message' => 'Güncelleme işlemi gerçekleşmedi'));\r\n+\t\t\t}\r\n+\t\t\t\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\techo json_encode(array('success' => false, 'message' => 'Veritabanı hatası: ' . $e->getMessage()));\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759843133661,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5126,71 +5126,172 @@\n \t\t\treturn;\r\n \t\t}\r\n \t\t\r\n \t\ttry {\r\n-\t\t\t// İlk önce unique_id'yi parse et (örn: 'bh_123', 'cek_456')\r\n-\t\t\t$parts = explode('_', $tahsilat_id);\r\n-\t\t\tif (count($parts) < 2) {\r\n-\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tahsilat ID formatı']);\r\n-\t\t\t\treturn;\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t$tip_prefix = $parts[0];\r\n-\t\t\t$source_id = $parts[1];\r\n-\t\t\t\r\n-\t\t\t// Tip kodunu belirle\r\n-\t\t\t$tip_kod = '';\r\n-\t\t\tswitch($tip_prefix) {\r\n-\t\t\t\tcase 'bh':\r\n-\t\t\t\t\t$tip_kod = '1';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\tcase 'cek':\r\n-\t\t\t\t\t$tip_kod = '2';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\tcase 'kh':\r\n-\t\t\t\t\t$tip_kod = '3';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\tcase 's':\r\n-\t\t\t\t\t$tip_kod = '4';\r\n-\t\t\t\t\tbreak;\r\n-\t\t\t\tdefault:\r\n-\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tahsilat tipi']);\r\n+\t\t\t// Grup tabanlı güncelleme için özel kontrol\r\n+\t\t\tif (strpos($tahsilat_id, '_group') !== false) {\r\n+\t\t\t\t// Grup güncelleme - cari_id gerekli\r\n+\t\t\t\t$cari_id = $this->input->post('cari_id');\r\n+\t\t\t\tif (!$cari_id) {\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Cari ID gerekli']);\r\n \t\t\t\t\treturn;\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t\t// muhasebe_tahsilat_durum tablosunda ilgili kaydı bul ve güncelle\r\n-\t\t\t$this->db->where('tahsilat_tipi', $tip_kod);\r\n-\t\t\t$this->db->where('kayit_id', $source_id);\r\n-\t\t\t\r\n-\t\t\t// Eğer kayıt yoksa ekle, varsa güncelle\r\n-\t\t\t$existing = $this->db->get('muhasebe_tahsilat_durum')->row();\r\n-\t\t\t\r\n-\t\t\tif ($existing) {\r\n-\t\t\t\t// Güncelle\r\n-\t\t\t\t$this->db->where('id', $existing->id);\r\n-\t\t\t\t$update_data = array(\r\n-\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n-\t\t\t\t\t'guncelleme_tarihi' => date('Y-m-d H:i:s')\r\n-\t\t\t\t);\r\n-\t\t\t\t$this->db->update('muhasebe_tahsilat_durum', $update_data);\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t// Tip kodunu belirle\r\n+\t\t\t\t$tip_kod = '';\r\n+\t\t\t\tif ($tahsilat_id === 'bh_group') {\r\n+\t\t\t\t\t$tip_kod = '1'; // Banka\r\n+\t\t\t\t} elseif ($tahsilat_id === 'cek_group') {\r\n+\t\t\t\t\t$tip_kod = '2'; // Çek\r\n+\t\t\t\t} elseif ($tahsilat_id === 'kh_group') {\r\n+\t\t\t\t\t$tip_kod = '3'; // Kasa\r\n+\t\t\t\t} elseif ($tahsilat_id === 's_group') {\r\n+\t\t\t\t\t$tip_kod = '4'; // Senet\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz grup tahsilat tipi']);\r\n+\t\t\t\t\treturn;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t// Bu cari için bu tip tahsilatın tüm kayıtlarını güncelle\r\n+\t\t\t\t$table_map = [\r\n+\t\t\t\t\t'1' => 'bankahareketleri',\r\n+\t\t\t\t\t'2' => 'cek',\r\n+\t\t\t\t\t'3' => 'kasahareketleri',\r\n+\t\t\t\t\t'4' => 'senet'\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\t$id_field_map = [\r\n+\t\t\t\t\t'1' => 'bh_id',\r\n+\t\t\t\t\t'2' => 'cek_id',\r\n+\t\t\t\t\t'3' => 'kh_id',\r\n+\t\t\t\t\t'4' => 'senet_id'\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\t$cari_field_map = [\r\n+\t\t\t\t\t'1' => 'bh_cariID',\r\n+\t\t\t\t\t'2' => 'cek_cariID',\r\n+\t\t\t\t\t'3' => 'kh_cariID',\r\n+\t\t\t\t\t'4' => 'senet_cariID'\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n+\t\t\t\t$table = $table_map[$tip_kod];\r\n+\t\t\t\t$id_field = $id_field_map[$tip_kod];\r\n+\t\t\t\t$cari_field = $cari_field_map[$tip_kod];\r\n+\t\t\t\t\r\n+\t\t\t\t// Bu cari için bu tip tahsilatın kayıt ID'lerini al\r\n+\t\t\t\t$source_ids_query = \"SELECT {$id_field} FROM {$table} WHERE {$cari_field} = ?\";\r\n+\t\t\t\t$result = $this->db->query($source_ids_query, [$cari_id]);\r\n+\t\t\t\t$source_ids = $result->result_array();\r\n+\t\t\t\t\r\n+\t\t\t\t$updated_count = 0;\r\n+\t\t\t\tforeach ($source_ids as $row) {\r\n+\t\t\t\t\t$source_id = $row[$id_field];\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// muhasebe_tahsilat_durum tablosunda ilgili kaydı bul ve güncelle\r\n+\t\t\t\t\t$this->db->where('tahsilat_tipi', $tip_kod);\r\n+\t\t\t\t\t$this->db->where('kayit_id', $source_id);\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Eğer kayıt yoksa ekle, varsa güncelle\r\n+\t\t\t\t\t$existing = $this->db->get('muhasebe_tahsilat_durum')->row();\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tif ($existing) {\r\n+\t\t\t\t\t\t// Güncelle\r\n+\t\t\t\t\t\t$this->db->where('id', $existing->id);\r\n+\t\t\t\t\t\t$update_data = array(\r\n+\t\t\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n+\t\t\t\t\t\t\t'guncelleme_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t\t\t\t);\r\n+\t\t\t\t\t\t$this->db->update('muhasebe_tahsilat_durum', $update_data);\r\n+\t\t\t\t\t\tif ($this->db->affected_rows() > 0) {\r\n+\t\t\t\t\t\t\t$updated_count++;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t// Yeni kayıt ekle\r\n+\t\t\t\t\t\t$insert_data = array(\r\n+\t\t\t\t\t\t\t'tahsilat_tipi' => $tip_kod,\r\n+\t\t\t\t\t\t\t'kayit_id' => $source_id,\r\n+\t\t\t\t\t\t\t'durum' => 1, // Varsayılan durum\r\n+\t\t\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n+\t\t\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t\t\t\t);\r\n+\t\t\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $insert_data);\r\n+\t\t\t\t\t\tif ($this->db->affected_rows() > 0) {\r\n+\t\t\t\t\t\t\t$updated_count++;\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\tif ($updated_count > 0) {\r\n+\t\t\t\t\techo json_encode(array('success' => true, 'message' => \"$updated_count kayıt güncellendi\"));\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\techo json_encode(array('success' => false, 'message' => 'Güncelleme işlemi gerçekleşmedi'));\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n \t\t\t} else {\r\n-\t\t\t\t// Yeni kayıt ekle\r\n-\t\t\t\t$insert_data = array(\r\n-\t\t\t\t\t'tahsilat_tipi' => $tip_kod,\r\n-\t\t\t\t\t'kayit_id' => $source_id,\r\n-\t\t\t\t\t'durum' => 1, // Varsayılan durum\r\n-\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n-\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s')\r\n-\t\t\t\t);\r\n-\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $insert_data);\r\n+\t\t\t\t// Tekil güncelleme - mevcut mantık\r\n+\t\t\t\t$parts = explode('_', $tahsilat_id);\r\n+\t\t\t\tif (count($parts) < 2) {\r\n+\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tahsilat ID formatı']);\r\n+\t\t\t\t\treturn;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t$tip_prefix = $parts[0];\r\n+\t\t\t\t$source_id = $parts[1];\r\n+\t\t\t\t\r\n+\t\t\t\t// Tip kodunu belirle\r\n+\t\t\t\t$tip_kod = '';\r\n+\t\t\t\tswitch($tip_prefix) {\r\n+\t\t\t\t\tcase 'bh':\r\n+\t\t\t\t\t\t$tip_kod = '1';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 'cek':\r\n+\t\t\t\t\t\t$tip_kod = '2';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 'kh':\r\n+\t\t\t\t\t\t$tip_kod = '3';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tcase 's':\r\n+\t\t\t\t\t\t$tip_kod = '4';\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\tdefault:\r\n+\t\t\t\t\t\techo json_encode(['success' => false, 'message' => 'Geçersiz tahsilat tipi']);\r\n+\t\t\t\t\t\treturn;\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t// muhasebe_tahsilat_durum tablosunda ilgili kaydı bul ve güncelle\r\n+\t\t\t\t$this->db->where('tahsilat_tipi', $tip_kod);\r\n+\t\t\t\t$this->db->where('kayit_id', $source_id);\r\n+\t\t\t\t\r\n+\t\t\t\t// Eğer kayıt yoksa ekle, varsa güncelle\r\n+\t\t\t\t$existing = $this->db->get('muhasebe_tahsilat_durum')->row();\r\n+\t\t\t\t\r\n+\t\t\t\tif ($existing) {\r\n+\t\t\t\t\t// Güncelle\r\n+\t\t\t\t\t$this->db->where('id', $existing->id);\r\n+\t\t\t\t\t$update_data = array(\r\n+\t\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n+\t\t\t\t\t\t'guncelleme_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t\t\t);\r\n+\t\t\t\t\t$this->db->update('muhasebe_tahsilat_durum', $update_data);\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\t// Yeni kayıt ekle\r\n+\t\t\t\t\t$insert_data = array(\r\n+\t\t\t\t\t\t'tahsilat_tipi' => $tip_kod,\r\n+\t\t\t\t\t\t'kayit_id' => $source_id,\r\n+\t\t\t\t\t\t'durum' => 1, // Varsayılan durum\r\n+\t\t\t\t\t\t'onay_durumu' => $onay_durumu ? 1 : 0,\r\n+\t\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s')\r\n+\t\t\t\t\t);\r\n+\t\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $insert_data);\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\tif ($this->db->affected_rows() > 0) {\r\n+\t\t\t\t\techo json_encode(array('success' => true, 'message' => 'Onay durumu başarıyla güncellendi'));\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\techo json_encode(array('success' => false, 'message' => 'Güncelleme işlemi gerçekleşmedi'));\r\n+\t\t\t\t}\r\n \t\t\t}\r\n \t\t\t\r\n-\t\t\tif ($this->db->affected_rows() > 0) {\r\n-\t\t\t\techo json_encode(array('success' => true, 'message' => 'Onay durumu başarıyla güncellendi'));\r\n-\t\t\t} else {\r\n-\t\t\t\techo json_encode(array('success' => false, 'message' => 'Güncelleme işlemi gerçekleşmedi'));\r\n-\t\t\t}\r\n-\t\t\t\r\n \t\t} catch (Exception $e) {\r\n \t\t\techo json_encode(array('success' => false, 'message' => 'Veritabanı hatası: ' . $e->getMessage()));\r\n \t\t}\r\n \t}\r\n"
                },
                {
                    "date": 1759912331302,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3074,8 +3074,9 @@\n \t\t\r\n \t\t// Arama parametrelerini al\r\n \t\t$cari_search = $this->input->get('cari_search');\r\n \t\t$aktivasyon_durum = $this->input->get('aktivasyon_durum');\r\n+\t\t$hizmet_onay_durumu = $this->input->get('hizmet_onay_durumu');\r\n \t\t\r\n \t\ttry {\r\n \t\t// WHERE koşulları için dizi\r\n \t\t$where_conditions = ['c.cari_durum = 1'];\r\n@@ -3090,10 +3091,36 @@\n \t\t\t\tc.cari_firmaTelefon LIKE '%{$search_term}%'\r\n \t\t\t)\";\r\n \t\t}\r\n \t\t\r\n+\t\t// Hizmet onay durumu filtresi için ek WHERE koşulu\r\n+\t\t// Bu filtre şimdilik devre dışı bırakılıyor, muhasebe_tahsilat_durum tablosu gerekliliği var\r\n+\t\t$hizmet_onay_where = '';\r\n+\t\t/*\r\n+\t\tif (!empty($hizmet_onay_durumu)) {\r\n+\t\t\tif ($hizmet_onay_durumu == 'onaylanan') {\r\n+\t\t\t\t// En az bir tahsilat onaylanmış olanlar (muhasebe_tahsilat_durum tablosunda onay_durumu = 1 olanlar)\r\n+\t\t\t\t$hizmet_onay_where = \" AND EXISTS (\r\n+\t\t\t\t\tSELECT 1 FROM muhasebe_tahsilat_durum mtd2 \r\n+\t\t\t\t\tWHERE mtd2.cari_id = c.cari_id AND mtd2.onay_durumu = 1\r\n+\t\t\t\t)\";\r\n+\t\t\t} elseif ($hizmet_onay_durumu == 'onaylanmayan') {\r\n+\t\t\t\t// Hiç onaylanmış tahsilat olmayan veya hiç tahsilat kaydı olmayan\r\n+\t\t\t\t$hizmet_onay_where = \" AND (\r\n+\t\t\t\t\tNOT EXISTS (\r\n+\t\t\t\t\t\tSELECT 1 FROM muhasebe_tahsilat_durum mtd2 \r\n+\t\t\t\t\t\tWHERE mtd2.cari_id = c.cari_id AND mtd2.onay_durumu = 1\r\n+\t\t\t\t\t) OR NOT EXISTS (\r\n+\t\t\t\t\t\tSELECT 1 FROM muhasebe_tahsilat_durum mtd2 \r\n+\t\t\t\t\t\tWHERE mtd2.cari_id = c.cari_id\r\n+\t\t\t\t\t)\r\n+\t\t\t\t)\";\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\t*/\r\n+\t\t\r\n \t\t// WHERE koşullarını birleştir\r\n-\t\t$where_clause = 'WHERE ' . implode(' AND ', $where_conditions);\r\n+\t\t$where_clause = 'WHERE ' . implode(' AND ', $where_conditions) . $hizmet_onay_where;\r\n \t\t\r\n \t\t// Aktivasyon durum filtresi için HAVING koşulu\r\n \t\t$having_clause = '';\r\n \t\tif (!empty($aktivasyon_durum)) {\r\n@@ -3332,8 +3359,29 @@\n \t\t\";\r\n \t\t\t\r\n \t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n \t\t\t\r\n+\t\t\t// Hizmet onay durumu filtresini backend'de uygula\r\n+\t\t\t// Şimdilik basit tahsilat varlığı kontrolü kullanılıyor\r\n+\t\t\tif (!empty($hizmet_onay_durumu) && !empty($data[\"rapor_verileri\"])) {\r\n+\t\t\t\t$filtered_data = [];\r\n+\t\t\t\t\r\n+\t\t\t\tforeach($data[\"rapor_verileri\"] as $veri) {\r\n+\t\t\t\t\t$cari_id = $veri->cari_id;\r\n+\t\t\t\t\t\r\n+\t\t\t\t\t// Bu cari için tahsilat onay durumunu basit kontrol et\r\n+\t\t\t\t\t$onayliTahsilat = $this->checkBasicTahsilatDurumu($cari_id);\r\n+\t\t\t\t\t\r\n+\t\t\t\t\tif ($hizmet_onay_durumu == 'onaylanan' && $onayliTahsilat) {\r\n+\t\t\t\t\t\t$filtered_data[] = $veri;\r\n+\t\t\t\t\t} elseif ($hizmet_onay_durumu == 'onaylanmayan' && !$onayliTahsilat) {\r\n+\t\t\t\t\t\t$filtered_data[] = $veri;\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\t\r\n+\t\t\t\t$data[\"rapor_verileri\"] = $filtered_data;\r\n+\t\t\t}\r\n+\t\t\t\r\n \t\t\t// İstatistikler\r\n \t\t\t$data[\"toplam_kayit\"] = count($data[\"rapor_verileri\"]);\r\n \t\t\t\r\n \t\t\t$toplam_satis_tutar = 0;\r\n@@ -3371,8 +3419,62 @@\n \t\t$this->load->view(\"muhasebe/tam-ana-rapor\", $data);\r\n \t}\r\n \t\r\n \t/**\r\n+\t * Cari için tahsilat onay durumunu kontrol et\r\n+\t */\r\n+\tprivate function checkTahsilatOnayDurumu($cari_id)\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t// Muhasebe tahsilat durum tablosunun varlığını kontrol et\r\n+\t\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n+\t\t\t\r\n+\t\t\tif ($tableExists > 0) {\r\n+\t\t\t\t// Tablo varsa, onaylanmış tahsilat var mı kontrol et (cari ile bağlantılı olarak)\r\n+\t\t\t\t$query = \"\r\n+\t\t\t\t\tSELECT COUNT(*) as onayli_count \r\n+\t\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n+\t\t\t\t\tLEFT JOIN bankaHareketleri bh ON (mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id)\r\n+\t\t\t\t\tLEFT JOIN cek ck ON (mtd.tahsilat_tipi = 2 AND mtd.kayit_id = ck.cek_id)\r\n+\t\t\t\t\tLEFT JOIN kasaHareketleri kh ON (mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id)\r\n+\t\t\t\t\tLEFT JOIN senet s ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n+\t\t\t\t\tWHERE mtd.onay_durumu = 1 \r\n+\t\t\t\t\tAND (\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND bh.bh_cariID = ?) OR\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND ck.cek_cariID = ?) OR\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND kh.kh_cariID = ?) OR\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND s.senet_cariID = ?)\r\n+\t\t\t\t\t)\r\n+\t\t\t\t\";\r\n+\t\t\t\t$result = $this->db->query($query, [$cari_id, $cari_id, $cari_id, $cari_id])->row();\r\n+\t\t\t\treturn ($result && $result->onayli_count > 0);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Tablo yoksa, herhangi bir tahsilat var mı basit kontrol\r\n+\t\t\t\t// Banka hareketleri kontrol et\r\n+\t\t\t\t$banka_count = $this->db->where('bh_cariID', $cari_id)->where('bh_giris >', 0)->count_all_results('bankahareketleri');\r\n+\t\t\t\tif ($banka_count > 0) return true;\r\n+\t\t\t\t\r\n+\t\t\t\t// Çek kontrol et\r\n+\t\t\t\t$cek_count = $this->db->where('cek_cariID', $cari_id)->where('cek_tutar >', 0)->count_all_results('cek');\r\n+\t\t\t\tif ($cek_count > 0) return true;\r\n+\t\t\t\t\r\n+\t\t\t\t// Kasa hareketleri kontrol et\r\n+\t\t\t\t$kasa_count = $this->db->where('kh_cariID', $cari_id)->where('kh_giris >', 0)->count_all_results('kasahareketleri');\r\n+\t\t\t\tif ($kasa_count > 0) return true;\r\n+\t\t\t\t\r\n+\t\t\t\t// Senet kontrol et\r\n+\t\t\t\t$senet_count = $this->db->where('senet_cariID', $cari_id)->where('senet_tutar >', 0)->count_all_results('senet');\r\n+\t\t\t\tif ($senet_count > 0) return true;\r\n+\t\t\t\t\r\n+\t\t\t\treturn false;\r\n+\t\t\t}\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata durumunda false döndür\r\n+\t\t\treturn false;\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n \t * Tahsilat detaylarını getir - AJAX\r\n \t */\r\n \tpublic function getTahsilatDetay()\r\n \t{\r\n"
                },
                {
                    "date": 1759913463290,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3360,25 +3360,41 @@\n \t\t\t\r\n \t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n \t\t\t\r\n \t\t\t// Hizmet onay durumu filtresini backend'de uygula\r\n-\t\t\t// Şimdilik basit tahsilat varlığı kontrolü kullanılıyor\r\n+\t\t\t// Gerçek muhasebe_tahsilat_durum tablosunu kullanarak\r\n \t\t\tif (!empty($hizmet_onay_durumu) && !empty($data[\"rapor_verileri\"])) {\r\n \t\t\t\t$filtered_data = [];\r\n+\t\t\t\t$debug_count = ['onaylanan' => 0, 'onaylanmayan' => 0];\r\n \t\t\t\t\r\n \t\t\t\tforeach($data[\"rapor_verileri\"] as $veri) {\r\n \t\t\t\t\t$cari_id = $veri->cari_id;\r\n \t\t\t\t\t\r\n-\t\t\t\t\t// Bu cari için tahsilat onay durumunu basit kontrol et\r\n+\t\t\t\t\t// Bu cari için tahsilat onay durumunu gerçek tablodan kontrol et\r\n \t\t\t\t\t$onayliTahsilat = $this->checkBasicTahsilatDurumu($cari_id);\r\n \t\t\t\t\t\r\n+\t\t\t\t\tif ($onayliTahsilat) {\r\n+\t\t\t\t\t\t$debug_count['onaylanan']++;\r\n+\t\t\t\t\t} else {\r\n+\t\t\t\t\t\t$debug_count['onaylanmayan']++;\r\n+\t\t\t\t\t}\r\n+\t\t\t\t\t\r\n \t\t\t\t\tif ($hizmet_onay_durumu == 'onaylanan' && $onayliTahsilat) {\r\n \t\t\t\t\t\t$filtered_data[] = $veri;\r\n \t\t\t\t\t} elseif ($hizmet_onay_durumu == 'onaylanmayan' && !$onayliTahsilat) {\r\n \t\t\t\t\t\t$filtered_data[] = $veri;\r\n \t\t\t\t\t}\r\n \t\t\t\t}\r\n \t\t\t\t\r\n+\t\t\t\t// Debug için sayıları view'e gönder\r\n+\t\t\t\t$data[\"debug_filtreleme\"] = [\r\n+\t\t\t\t\t'toplam_kayit' => count($data[\"rapor_verileri\"]),\r\n+\t\t\t\t\t'onaylanan_sayisi' => $debug_count['onaylanan'],\r\n+\t\t\t\t\t'onaylanmayan_sayisi' => $debug_count['onaylanmayan'],\r\n+\t\t\t\t\t'filtrelenmis_sayisi' => count($filtered_data),\r\n+\t\t\t\t\t'filtre_tipi' => $hizmet_onay_durumu\r\n+\t\t\t\t];\r\n+\t\t\t\t\r\n \t\t\t\t$data[\"rapor_verileri\"] = $filtered_data;\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t// İstatistikler\r\n@@ -3473,8 +3489,46 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n+\t * Basit tahsilat durumu kontrolü (muhasebe_tahsilat_durum tablosunu kullanmadan)\r\n+\t */\r\n+\tprivate function checkBasicTahsilatDurumu($cari_id)\r\n+\t{\r\n+\t\ttry {\r\n+\t\t\t// Gerçek muhasebe_tahsilat_durum tablosunu kullan\r\n+\t\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n+\t\t\t\r\n+\t\t\tif ($tableExists > 0) {\r\n+\t\t\t\t// Tablo varsa, bu cari için onaylanmış tahsilat var mı kontrol et\r\n+\t\t\t\t$query = \"\r\n+\t\t\t\t\tSELECT COUNT(*) as onayli_count \r\n+\t\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n+\t\t\t\t\tLEFT JOIN bankaHareketleri bh ON (mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id)\r\n+\t\t\t\t\tLEFT JOIN cek ck ON (mtd.tahsilat_tipi = 2 AND mtd.kayit_id = ck.cek_id)\r\n+\t\t\t\t\tLEFT JOIN kasaHareketleri kh ON (mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id)\r\n+\t\t\t\t\tLEFT JOIN senet s ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n+\t\t\t\t\tWHERE mtd.onay_durumu = 1 \r\n+\t\t\t\t\tAND (\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND bh.bh_cariID = ?) OR\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND ck.cek_cariID = ?) OR\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND kh.kh_cariID = ?) OR\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND s.senet_cariID = ?)\r\n+\t\t\t\t\t)\r\n+\t\t\t\t\";\r\n+\t\t\t\t$result = $this->db->query($query, [$cari_id, $cari_id, $cari_id, $cari_id])->row();\r\n+\t\t\t\treturn ($result && $result->onayli_count > 0);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Tablo yoksa false döndür\r\n+\t\t\t\treturn false;\r\n+\t\t\t}\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata durumunda false döndür\r\n+\t\t\treturn false;\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\t/**\r\n \t * Tahsilat detaylarını getir - AJAX\r\n \t */\r\n \tpublic function getTahsilatDetay()\r\n \t{\r\n"
                },
                {
                    "date": 1759913731538,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3363,38 +3363,22 @@\n \t\t\t// Hizmet onay durumu filtresini backend'de uygula\r\n \t\t\t// Gerçek muhasebe_tahsilat_durum tablosunu kullanarak\r\n \t\t\tif (!empty($hizmet_onay_durumu) && !empty($data[\"rapor_verileri\"])) {\r\n \t\t\t\t$filtered_data = [];\r\n-\t\t\t\t$debug_count = ['onaylanan' => 0, 'onaylanmayan' => 0];\r\n \t\t\t\t\r\n \t\t\t\tforeach($data[\"rapor_verileri\"] as $veri) {\r\n \t\t\t\t\t$cari_id = $veri->cari_id;\r\n \t\t\t\t\t\r\n \t\t\t\t\t// Bu cari için tahsilat onay durumunu gerçek tablodan kontrol et\r\n-\t\t\t\t\t$onayliTahsilat = $this->checkBasicTahsilatDurumu($cari_id);\r\n+\t\t\t\t\t$onayliTahsilat = $this->checkTahsilatOnayDurumu($cari_id);\r\n \t\t\t\t\t\r\n-\t\t\t\t\tif ($onayliTahsilat) {\r\n-\t\t\t\t\t\t$debug_count['onaylanan']++;\r\n-\t\t\t\t\t} else {\r\n-\t\t\t\t\t\t$debug_count['onaylanmayan']++;\r\n-\t\t\t\t\t}\r\n-\t\t\t\t\t\r\n \t\t\t\t\tif ($hizmet_onay_durumu == 'onaylanan' && $onayliTahsilat) {\r\n \t\t\t\t\t\t$filtered_data[] = $veri;\r\n \t\t\t\t\t} elseif ($hizmet_onay_durumu == 'onaylanmayan' && !$onayliTahsilat) {\r\n \t\t\t\t\t\t$filtered_data[] = $veri;\r\n \t\t\t\t\t}\r\n \t\t\t\t}\r\n \t\t\t\t\r\n-\t\t\t\t// Debug için sayıları view'e gönder\r\n-\t\t\t\t$data[\"debug_filtreleme\"] = [\r\n-\t\t\t\t\t'toplam_kayit' => count($data[\"rapor_verileri\"]),\r\n-\t\t\t\t\t'onaylanan_sayisi' => $debug_count['onaylanan'],\r\n-\t\t\t\t\t'onaylanmayan_sayisi' => $debug_count['onaylanmayan'],\r\n-\t\t\t\t\t'filtrelenmis_sayisi' => count($filtered_data),\r\n-\t\t\t\t\t'filtre_tipi' => $hizmet_onay_durumu\r\n-\t\t\t\t];\r\n-\t\t\t\t\r\n \t\t\t\t$data[\"rapor_verileri\"] = $filtered_data;\r\n \t\t\t}\r\n \t\t\t\r\n \t\t\t// İstatistikler\r\n@@ -3489,46 +3473,8 @@\n \t\t}\r\n \t}\r\n \t\r\n \t/**\r\n-\t * Basit tahsilat durumu kontrolü (muhasebe_tahsilat_durum tablosunu kullanmadan)\r\n-\t */\r\n-\tprivate function checkBasicTahsilatDurumu($cari_id)\r\n-\t{\r\n-\t\ttry {\r\n-\t\t\t// Gerçek muhasebe_tahsilat_durum tablosunu kullan\r\n-\t\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n-\t\t\t\r\n-\t\t\tif ($tableExists > 0) {\r\n-\t\t\t\t// Tablo varsa, bu cari için onaylanmış tahsilat var mı kontrol et\r\n-\t\t\t\t$query = \"\r\n-\t\t\t\t\tSELECT COUNT(*) as onayli_count \r\n-\t\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n-\t\t\t\t\tLEFT JOIN bankaHareketleri bh ON (mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id)\r\n-\t\t\t\t\tLEFT JOIN cek ck ON (mtd.tahsilat_tipi = 2 AND mtd.kayit_id = ck.cek_id)\r\n-\t\t\t\t\tLEFT JOIN kasaHareketleri kh ON (mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id)\r\n-\t\t\t\t\tLEFT JOIN senet s ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n-\t\t\t\t\tWHERE mtd.onay_durumu = 1 \r\n-\t\t\t\t\tAND (\r\n-\t\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND bh.bh_cariID = ?) OR\r\n-\t\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND ck.cek_cariID = ?) OR\r\n-\t\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND kh.kh_cariID = ?) OR\r\n-\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND s.senet_cariID = ?)\r\n-\t\t\t\t\t)\r\n-\t\t\t\t\";\r\n-\t\t\t\t$result = $this->db->query($query, [$cari_id, $cari_id, $cari_id, $cari_id])->row();\r\n-\t\t\t\treturn ($result && $result->onayli_count > 0);\r\n-\t\t\t} else {\r\n-\t\t\t\t// Tablo yoksa false döndür\r\n-\t\t\t\treturn false;\r\n-\t\t\t}\r\n-\t\t} catch (Exception $e) {\r\n-\t\t\t// Hata durumunda false döndür\r\n-\t\t\treturn false;\r\n-\t\t}\r\n-\t}\r\n-\t\r\n-\t/**\r\n \t * Tahsilat detaylarını getir - AJAX\r\n \t */\r\n \tpublic function getTahsilatDetay()\r\n \t{\r\n"
                },
                {
                    "date": 1759917164685,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -831,8 +831,32 @@\n \t\t$u_id = $control->kullanici_id;\r\n \r\n \t\t\r\n \r\n+\t\t// Filtre parametrelerini al\r\n+\r\n+\t\t$filtre_tahsilat_tipi = $this->input->get('tahsilat_tipi');\r\n+\r\n+\t\t$filtre_durum = $this->input->get('durum');\r\n+\r\n+\t\t$filtre_personel = $this->input->get('personel');\r\n+\r\n+\t\t$filtre_tahsilat_ayi = $this->input->get('tahsilat_ayi');\r\n+\r\n+\t\t\r\n+\r\n+\t\t// Filtreleri data'ya aktar\r\n+\r\n+\t\t$data['filtre_tahsilat_tipi'] = $filtre_tahsilat_tipi;\r\n+\r\n+\t\t$data['filtre_durum'] = $filtre_durum;\r\n+\r\n+\t\t$data['filtre_personel'] = $filtre_personel;\r\n+\r\n+\t\t$data['filtre_tahsilat_ayi'] = $filtre_tahsilat_ayi;\r\n+\r\n+\t\t\r\n+\r\n \t\t// Çek senkronizasyonu - çek tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n \r\n \t\t$this->senkronizeCekler();\r\n \r\n@@ -1089,8 +1113,100 @@\n \t\t\t\tORDER BY mtd.olusturma_tarihi DESC\";\r\n \r\n \t\t\t\t\r\n \r\n+\t\t\t\t// Filtre koşullarını WHERE clause'a ekle\r\n+\r\n+\t\t\t\t$where_conditions = array();\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t// Tahsilat tipi filtresi\r\n+\r\n+\t\t\t\tif (!empty($filtre_tahsilat_tipi)) {\r\n+\r\n+\t\t\t\t\t$where_conditions[] = \"mtd.tahsilat_tipi = \" . intval($filtre_tahsilat_tipi);\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t// Durum filtresi\r\n+\r\n+\t\t\t\tif (!empty($filtre_durum)) {\r\n+\r\n+\t\t\t\t\t$where_conditions[] = \"mtd.durum = \" . intval($filtre_durum);\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t// Personel filtresi (İşlemi yapan personel)\r\n+\r\n+\t\t\t\tif (!empty($filtre_personel)) {\r\n+\r\n+\t\t\t\t\t$where_conditions[] = \"(\r\n+\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND bh.bh_olusturan = \" . intval($filtre_personel) . \") OR\r\n+\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND c.cek_kullaniciID = \" . intval($filtre_personel) . \") OR\r\n+\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND kh.kh_olusturan = \" . intval($filtre_personel) . \") OR\r\n+\r\n+\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND s.senet_kullaniciID = \" . intval($filtre_personel) . \")\r\n+\r\n+\t\t\t\t\t)\";\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t// Tahsilat ayı filtresi (Çek vadeTarih ve Senet vadeTarih)\r\n+\r\n+\t\t\t\tif (!empty($filtre_tahsilat_ayi)) {\r\n+\r\n+\t\t\t\t\t$aySplit = explode('-', $filtre_tahsilat_ayi); // Format: YYYY-MM\r\n+\r\n+\t\t\t\t\tif (count($aySplit) == 2) {\r\n+\r\n+\t\t\t\t\t\t$yil = intval($aySplit[0]);\r\n+\r\n+\t\t\t\t\t\t$ay = intval($aySplit[1]);\r\n+\r\n+\t\t\t\t\t\t$where_conditions[] = \"(\r\n+\r\n+\t\t\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND YEAR(c.cek_vadeTarih) = $yil AND MONTH(c.cek_vadeTarih) = $ay) OR\r\n+\r\n+\t\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND YEAR(s.senet_vadeTarih) = $yil AND MONTH(s.senet_vadeTarih) = $ay) OR\r\n+\r\n+\t\t\t\t\t\t\t(mtd.tahsilat_tipi IN (1,3) AND YEAR(mtd.olusturma_tarihi) = $yil AND MONTH(mtd.olusturma_tarihi) = $ay)\r\n+\r\n+\t\t\t\t\t\t)\";\r\n+\r\n+\t\t\t\t\t}\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t// WHERE koşullarını sorguya ekle\r\n+\r\n+\t\t\t\tif (!empty($where_conditions)) {\r\n+\r\n+\t\t\t\t\t$tahsilatlarQ = str_replace(\r\n+\r\n+\t\t\t\t\t\t\"WHERE mtd.tahsilat_tipi IN (1, 2, 3, 4)\",\r\n+\r\n+\t\t\t\t\t\t\"WHERE mtd.tahsilat_tipi IN (1, 2, 3, 4) AND (\" . implode(' AND ', $where_conditions) . \")\",\r\n+\r\n+\t\t\t\t\t\t$tahsilatlarQ\r\n+\r\n+\t\t\t\t\t);\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n \t\t\t\t$data[\"tahsilatlar\"] = $this->db->query($tahsilatlarQ)->result();\r\n \r\n \t\t\t\t\r\n \r\n@@ -1155,8 +1271,48 @@\n \t\t}\r\n \r\n \t\t\r\n \r\n+\t\t// Filtre için gerekli veriler\r\n+\r\n+\t\t// Personel listesi (Kullanıcılar)\r\n+\r\n+\t\ttry {\r\n+\r\n+\t\t\t$data['personel_listesi'] = $this->db->query(\"SELECT kullanici_id, kullanici_ad, kullanici_soyad FROM kullanicilar WHERE kullanici_durum = 1 ORDER BY kullanici_ad ASC\")->result();\r\n+\r\n+\t\t} catch (Exception $e) {\r\n+\r\n+\t\t\t$data['personel_listesi'] = array();\r\n+\r\n+\t\t}\r\n+\r\n+\t\t\r\n+\r\n+\t\t// Tahsilat ayları için son 24 ayı oluştur\r\n+\r\n+\t\t$data['tahsilat_aylari'] = array();\r\n+\r\n+\t\tfor ($i = 0; $i < 24; $i++) {\r\n+\r\n+\t\t\t$tarih = date('Y-m', strtotime(\"-$i months\"));\r\n+\r\n+\t\t\t$ay_adi = $this->getTurkceAyAdi(date('n', strtotime(\"-$i months\")));\r\n+\r\n+\t\t\t$yil = date('Y', strtotime(\"-$i months\"));\r\n+\r\n+\t\t\t$data['tahsilat_aylari'][] = (object) array(\r\n+\r\n+\t\t\t\t'deger' => $tarih,\r\n+\r\n+\t\t\t\t'adi' => $ay_adi . ' ' . $yil\r\n+\r\n+\t\t\t);\r\n+\r\n+\t\t}\r\n+\r\n+\t\t\r\n+\r\n \t\t// Sayfa yükle\r\n \r\n \t\t$this->load->view(\"muhasebe/tahsilat-listesi\", $data);\r\n \r\n@@ -5396,5 +5552,27 @@\n \t\t} catch (Exception $e) {\r\n \t\t\techo json_encode(array('success' => false, 'message' => 'Veritabanı hatası: ' . $e->getMessage()));\r\n \t\t}\r\n \t}\r\n+\t\r\n+\t/**\r\n+\t * Türkçe ay adlarını döndürür\r\n+\t */\r\n+\tprivate function getTurkceAyAdi($ay_num) {\r\n+\t\t$aylar = array(\r\n+\t\t\t1 => 'Ocak',\r\n+\t\t\t2 => 'Şubat', \r\n+\t\t\t3 => 'Mart',\r\n+\t\t\t4 => 'Nisan',\r\n+\t\t\t5 => 'Mayıs',\r\n+\t\t\t6 => 'Haziran',\r\n+\t\t\t7 => 'Temmuz',\r\n+\t\t\t8 => 'Ağustos',\r\n+\t\t\t9 => 'Eylül',\r\n+\t\t\t10 => 'Ekim',\r\n+\t\t\t11 => 'Kasım',\r\n+\t\t\t12 => 'Aralık'\r\n+\t\t);\r\n+\t\t\r\n+\t\treturn isset($aylar[$ay_num]) ? $aylar[$ay_num] : 'Bilinmiyor';\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759920963439,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -843,8 +843,16 @@\n \t\t$filtre_tahsilat_ayi = $this->input->get('tahsilat_ayi');\r\n \r\n \t\t\r\n \r\n+\t\t// Debug log ekle\r\n+\r\n+\t\t$debug_msg = date('Y-m-d H:i:s') . \" - Tahsilat Listesi Debug - Incoming Parameters: tahsilat_tipi=$filtre_tahsilat_tipi, durum=$filtre_durum, personel=$filtre_personel, tahsilat_ayi=$filtre_tahsilat_ayi\" . PHP_EOL;\r\n+\r\n+\t\tfile_put_contents(FCPATH . 'debug_tahsilat_listesi.log', $debug_msg, FILE_APPEND | LOCK_EX);\r\n+\r\n+\t\t\r\n+\r\n \t\t// Filtreleri data'ya aktar\r\n \r\n \t\t$data['filtre_tahsilat_tipi'] = $filtre_tahsilat_tipi;\r\n \r\n@@ -1159,9 +1167,9 @@\n \t\t\t\t}\r\n \r\n \t\t\t\t\r\n \r\n-\t\t\t\t// Tahsilat ayı filtresi (Çek vadeTarih ve Senet vadeTarih)\r\n+\t\t\t\t// Tahsilat ayı filtresi (sadece Çek vadeTarih ve Senet vadeTarih)\r\n \r\n \t\t\t\tif (!empty($filtre_tahsilat_ayi)) {\r\n \r\n \t\t\t\t\t$aySplit = explode('-', $filtre_tahsilat_ayi); // Format: YYYY-MM\r\n@@ -1171,16 +1179,28 @@\n \t\t\t\t\t\t$yil = intval($aySplit[0]);\r\n \r\n \t\t\t\t\t\t$ay = intval($aySplit[1]);\r\n \r\n+\t\t\t\t\t\t\r\n+\r\n+\t\t\t\t\t\t// Debug log ekle\r\n+\r\n+\t\t\t\t\t\t$debug_msg_filter = date('Y-m-d H:i:s') . \" - Tahsilat Listesi Debug - Filter applied: $filtre_tahsilat_ayi (Yıl: $yil, Ay: $ay)\" . PHP_EOL;\r\n+\r\n+\t\t\t\t\t\tfile_put_contents(FCPATH . 'debug_tahsilat_listesi.log', $debug_msg_filter, FILE_APPEND | LOCK_EX);\r\n+\r\n+\t\t\t\t\t\t\r\n+\r\n+\t\t\t\t\t\t// Sadece çek ve senet için vade tarihi filtresi uygula\r\n+\r\n+\t\t\t\t\t\t// Banka ve kasa hareketlerini bu filtreden çıkar\r\n+\r\n \t\t\t\t\t\t$where_conditions[] = \"(\r\n \r\n \t\t\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND YEAR(c.cek_vadeTarih) = $yil AND MONTH(c.cek_vadeTarih) = $ay) OR\r\n \r\n-\t\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND YEAR(s.senet_vadeTarih) = $yil AND MONTH(s.senet_vadeTarih) = $ay) OR\r\n+\t\t\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND YEAR(s.senet_vadeTarih) = $yil AND MONTH(s.senet_vadeTarih) = $ay)\r\n \r\n-\t\t\t\t\t\t\t(mtd.tahsilat_tipi IN (1,3) AND YEAR(mtd.olusturma_tarihi) = $yil AND MONTH(mtd.olusturma_tarihi) = $ay)\r\n-\r\n \t\t\t\t\t\t)\";\r\n \r\n \t\t\t\t\t}\r\n \r\n@@ -1205,12 +1225,34 @@\n \t\t\t\t}\r\n \r\n \t\t\t\t\r\n \r\n+\t\t\t\t// Debug log ekle\r\n+\r\n+\t\t\t\tif (!empty($filtre_tahsilat_ayi)) {\r\n+\r\n+\t\t\t\t\t$debug_msg2 = date('Y-m-d H:i:s') . \" - Tahsilat Listesi Debug - Filter: $filtre_tahsilat_ayi\" . PHP_EOL;\r\n+\r\n+\t\t\t\t\t$debug_msg2 .= date('Y-m-d H:i:s') . \" - Final Query: \" . substr($tahsilatlarQ, 0, 1000) . \"...\" . PHP_EOL;\r\n+\r\n+\t\t\t\t\tfile_put_contents(FCPATH . 'debug_tahsilat_listesi.log', $debug_msg2, FILE_APPEND | LOCK_EX);\r\n+\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\t\r\n+\r\n \t\t\t\t$data[\"tahsilatlar\"] = $this->db->query($tahsilatlarQ)->result();\r\n \r\n \t\t\t\t\r\n \r\n+\t\t\t\t// Debug log - sonuç sayısı\r\n+\r\n+\t\t\t\t$debug_msg3 = date('Y-m-d H:i:s') . \" - Tahsilat Listesi Debug - Sonuç sayısı: \" . count($data[\"tahsilatlar\"]) . PHP_EOL;\r\n+\r\n+\t\t\t\tfile_put_contents(FCPATH . 'debug_tahsilat_listesi.log', $debug_msg3, FILE_APPEND | LOCK_EX);\r\n+\r\n+\t\t\t\t\r\n+\r\n \t\t\t\t// İstatistikler\r\n \r\n \t\t\t\t$data[\"toplam_adet\"] = count($data[\"tahsilatlar\"]);\r\n \r\n@@ -1287,28 +1329,53 @@\n \t\t}\r\n \r\n \t\t\r\n \r\n-\t\t// Tahsilat ayları için son 24 ayı oluştur\r\n-\r\n+\t\t// Tahsilat ayları için gerçek verilere dayalı ay listesi oluştur\r\n \t\t$data['tahsilat_aylari'] = array();\r\n-\r\n-\t\tfor ($i = 0; $i < 24; $i++) {\r\n-\r\n-\t\t\t$tarih = date('Y-m', strtotime(\"-$i months\"));\r\n-\r\n-\t\t\t$ay_adi = $this->getTurkceAyAdi(date('n', strtotime(\"-$i months\")));\r\n-\r\n-\t\t\t$yil = date('Y', strtotime(\"-$i months\"));\r\n-\r\n-\t\t\t$data['tahsilat_aylari'][] = (object) array(\r\n-\r\n-\t\t\t\t'deger' => $tarih,\r\n-\r\n-\t\t\t\t'adi' => $ay_adi . ' ' . $yil\r\n-\r\n-\t\t\t);\r\n-\r\n+\t\t\r\n+\t\t// Önce veritabanından mevcut ayları çek\r\n+\t\t$aylar_query = \"\r\n+\t\tSELECT DISTINCT DATE_FORMAT(vade_ay, '%Y-%m') AS ay_deger,\r\n+\t\t\t   YEAR(vade_ay) AS yil,\r\n+\t\t\t   MONTH(vade_ay) AS ay_num\r\n+\t\tFROM (\r\n+\t\t\tSELECT cek_vadeTarih AS vade_ay FROM cek WHERE cek_vadeTarih IS NOT NULL\r\n+\t\t\tUNION ALL\r\n+\t\t\tSELECT senet_vadeTarih AS vade_ay FROM senet WHERE senet_vadeTarih IS NOT NULL\r\n+\t\t\tUNION ALL\r\n+\t\t\tSELECT bh_tarih AS vade_ay FROM bankaHareketleri WHERE bh_tarih IS NOT NULL\r\n+\t\t\tUNION ALL\r\n+\t\t\tSELECT kh_tarih AS vade_ay FROM kasaHareketleri WHERE kh_tarih IS NOT NULL\r\n+\t\t) AS birlesik\r\n+\t\tWHERE vade_ay != '0000-00-00' AND vade_ay IS NOT NULL\r\n+\t\tORDER BY vade_ay DESC\";\r\n+\t\t\r\n+\t\ttry {\r\n+\t\t\t$mevcut_aylar = $this->db->query($aylar_query)->result();\r\n+\t\t\t$eklenen_aylar = array();\r\n+\t\t\t\r\n+\t\t\tforeach($mevcut_aylar as $ay) {\r\n+\t\t\t\tif ($ay->ay_deger && !in_array($ay->ay_deger, $eklenen_aylar)) {\r\n+\t\t\t\t\t$ay_adi = $this->getTurkceAyAdi($ay->ay_num);\r\n+\t\t\t\t\t$data['tahsilat_aylari'][] = (object) array(\r\n+\t\t\t\t\t\t'deger' => $ay->ay_deger,\r\n+\t\t\t\t\t\t'adi' => $ay_adi . ' ' . $ay->yil\r\n+\t\t\t\t\t);\r\n+\t\t\t\t\t$eklenen_aylar[] = $ay->ay_deger;\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\t// Hata durumunda varsayılan olarak son 24 ayı ekle\r\n+\t\t\tfor ($i = 0; $i < 24; $i++) {\r\n+\t\t\t\t$tarih = date('Y-m', strtotime(\"-$i months\"));\r\n+\t\t\t\t$ay_adi = $this->getTurkceAyAdi(date('n', strtotime(\"-$i months\")));\r\n+\t\t\t\t$yil = date('Y', strtotime(\"-$i months\"));\r\n+\t\t\t\t$data['tahsilat_aylari'][] = (object) array(\r\n+\t\t\t\t\t'deger' => $tarih,\r\n+\t\t\t\t\t'adi' => $ay_adi . ' ' . $yil\r\n+\t\t\t\t);\r\n+\t\t\t}\r\n \t\t}\r\n \r\n \t\t\r\n \r\n@@ -5574,5 +5641,133 @@\n \t\t);\r\n \t\t\r\n \t\treturn isset($aylar[$ay_num]) ? $aylar[$ay_num] : 'Bilinmiyor';\r\n \t}\r\n+\r\n+\t/**\r\n+\t * Debug method for testing month data\r\n+\t */\r\n+\tpublic function debugMonths()\r\n+\t{\r\n+\t\t// Session kontrolü atla, sadece debug için\r\n+\t\techo \"<h2>Testing Month Generation for Tahsilat Listesi</h2>\";\r\n+\t\techo \"<p>Current Date: \" . date('Y-m-d') . \"</p>\";\r\n+\t\t\r\n+\t\t// Test query from controller\r\n+\t\t$aylar_query = \"\r\n+\t\tSELECT DISTINCT DATE_FORMAT(vade_ay, '%Y-%m') AS ay_deger,\r\n+\t\t\t   YEAR(vade_ay) AS yil,\r\n+\t\t\t   MONTH(vade_ay) AS ay_num\r\n+\t\tFROM (\r\n+\t\t\tSELECT cek_vadeTarih AS vade_ay FROM cek WHERE cek_vadeTarih IS NOT NULL\r\n+\t\t\tUNION ALL\r\n+\t\t\tSELECT senet_vadeTarih AS vade_ay FROM senet WHERE senet_vadeTarih IS NOT NULL\r\n+\t\t\tUNION ALL\r\n+\t\t\tSELECT bh_tarih AS vade_ay FROM bankaHareketleri WHERE bh_tarih IS NOT NULL\r\n+\t\t\tUNION ALL\r\n+\t\t\tSELECT kh_tarih AS vade_ay FROM kasaHareketleri WHERE kh_tarih IS NOT NULL\r\n+\t\t) AS birlesik\r\n+\t\tWHERE vade_ay != '0000-00-00' AND vade_ay IS NOT NULL\r\n+\t\tORDER BY vade_ay DESC\";\r\n+\t\t\r\n+\t\t$mevcut_aylar = $this->db->query($aylar_query)->result();\r\n+\t\t\r\n+\t\techo \"<h3>Months Found in Database:</h3>\";\r\n+\t\techo \"<table border='1' style='border-collapse: collapse;'>\";\r\n+\t\techo \"<tr><th>Month Value</th><th>Year</th><th>Month Number</th><th>Display Name</th></tr>\";\r\n+\t\t\r\n+\t\t$eklenen_aylar = array();\r\n+\t\tforeach($mevcut_aylar as $ay) {\r\n+\t\t\tif ($ay->ay_deger && !in_array($ay->ay_deger, $eklenen_aylar)) {\r\n+\t\t\t\t$ay_adi = $this->getTurkceAyAdi($ay->ay_num);\r\n+\t\t\t\techo \"<tr>\";\r\n+\t\t\t\techo \"<td>{$ay->ay_deger}</td>\";\r\n+\t\t\t\techo \"<td>{$ay->yil}</td>\";\r\n+\t\t\t\techo \"<td>{$ay->ay_num}</td>\";\r\n+\t\t\t\techo \"<td>{$ay_adi} {$ay->yil}</td>\";\r\n+\t\t\t\techo \"</tr>\";\r\n+\t\t\t\t$eklenen_aylar[] = $ay->ay_deger;\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\techo \"</table>\";\r\n+\t\t\r\n+\t\techo \"<h3>Test URLs:</h3>\";\r\n+\t\techo \"<ul>\";\r\n+\t\tforeach($eklenen_aylar as $ay_deger) {\r\n+\t\t\techo \"<li><a href='/muhasebe/tahsilat-listesi?tahsilat_ayi={$ay_deger}' target='_blank'>Tahsilat Listesi - {$ay_deger}</a></li>\";\r\n+\t\t}\r\n+\t\techo \"</ul>\";\r\n+\t\t\r\n+\t\t// Test specific October 2025\r\n+\t\techo \"<h3>Testing October 2025 Data Details:</h3>\";\r\n+\t\t$test_query = \"\r\n+\t\tSELECT 'cek' as tip, cek_id as id, cek_vadeTarih as tarih, cek_tutar as tutar \r\n+\t\tFROM cek \r\n+\t\tWHERE YEAR(cek_vadeTarih) = 2025 AND MONTH(cek_vadeTarih) = 10\r\n+\t\tUNION ALL\r\n+\t\tSELECT 'senet' as tip, senet_id as id, senet_vadeTarih as tarih, senet_tutar as tutar \r\n+\t\tFROM senet \r\n+\t\tWHERE YEAR(senet_vadeTarih) = 2025 AND MONTH(senet_vadeTarih) = 10\r\n+\t\tORDER BY tarih DESC\";\r\n+\t\t\r\n+\t\t$ekim_data = $this->db->query($test_query)->result();\r\n+\t\t\r\n+\t\tif (count($ekim_data) > 0) {\r\n+\t\t\techo \"<p><strong>Found \" . count($ekim_data) . \" records for October 2025:</strong></p>\";\r\n+\t\t\techo \"<table border='1' style='border-collapse: collapse;'>\";\r\n+\t\t\techo \"<tr><th>Type</th><th>ID</th><th>Date</th><th>Amount</th></tr>\";\r\n+\t\t\tforeach($ekim_data as $record) {\r\n+\t\t\t\techo \"<tr>\";\r\n+\t\t\t\techo \"<td>{$record->tip}</td>\";\r\n+\t\t\t\techo \"<td>{$record->id}</td>\";\r\n+\t\t\t\techo \"<td>{$record->tarih}</td>\";\r\n+\t\t\t\techo \"<td>\" . number_format($record->tutar, 2) . \"</td>\";\r\n+\t\t\t\techo \"</tr>\";\r\n+\t\t\t}\r\n+\t\t\techo \"</table>\";\r\n+\t\t} else {\r\n+\t\t\techo \"<p>No records found for October 2025</p>\";\r\n+\t\t}\r\n+\t\t\r\n+\t\t// Test muhasebe_tahsilat_durum table for October 2025\r\n+\t\techo \"<h3>Testing muhasebe_tahsilat_durum for October 2025:</h3>\";\r\n+\t\t$mtd_query = \"\r\n+\t\tSELECT COUNT(*) as toplam, tahsilat_tipi,\r\n+\t\t\t   CASE \r\n+\t\t\t\t   WHEN tahsilat_tipi = 1 THEN 'Banka'\r\n+\t\t\t\t   WHEN tahsilat_tipi = 2 THEN 'Çek'\r\n+\t\t\t\t   WHEN tahsilat_tipi = 3 THEN 'Kasa'\r\n+\t\t\t\t   WHEN tahsilat_tipi = 4 THEN 'Senet'\r\n+\t\t\t   END as tip_adi\r\n+\t\tFROM muhasebe_tahsilat_durum mtd\r\n+\t\tLEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n+\t\tLEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n+\t\tWHERE (\r\n+\t\t\t(mtd.tahsilat_tipi = 2 AND YEAR(c.cek_vadeTarih) = 2025 AND MONTH(c.cek_vadeTarih) = 10) OR\r\n+\t\t\t(mtd.tahsilat_tipi = 4 AND YEAR(s.senet_vadeTarih) = 2025 AND MONTH(s.senet_vadeTarih) = 10) OR\r\n+\t\t\t(mtd.tahsilat_tipi IN (1,3) AND YEAR(mtd.olusturma_tarihi) = 2025 AND MONTH(mtd.olusturma_tarihi) = 10)\r\n+\t\t)\r\n+\t\tGROUP BY tahsilat_tipi\r\n+\t\tORDER BY tahsilat_tipi\";\r\n+\t\t\r\n+\t\t$mtd_data = $this->db->query($mtd_query)->result();\r\n+\t\t\r\n+\t\tif (count($mtd_data) > 0) {\r\n+\t\t\techo \"<table border='1' style='border-collapse: collapse;'>\";\r\n+\t\t\techo \"<tr><th>Tahsilat Tipi</th><th>Tip Adı</th><th>Kayıt Sayısı</th></tr>\";\r\n+\t\t\t$total_mtd = 0;\r\n+\t\t\tforeach($mtd_data as $mtd_record) {\r\n+\t\t\t\techo \"<tr>\";\r\n+\t\t\t\techo \"<td>{$mtd_record->tahsilat_tipi}</td>\";\r\n+\t\t\t\techo \"<td>{$mtd_record->tip_adi}</td>\";\r\n+\t\t\t\techo \"<td>{$mtd_record->toplam}</td>\";\r\n+\t\t\t\techo \"</tr>\";\r\n+\t\t\t\t$total_mtd += $mtd_record->toplam;\r\n+\t\t\t}\r\n+\t\t\techo \"<tr style='background-color: #f0f0f0; font-weight: bold;'>\";\r\n+\t\t\techo \"<td colspan='2'>TOPLAM</td>\";\r\n+\t\t\techo \"<td>{$total_mtd}</td>\";\r\n+\t\t\techo \"</tr>\";\r\n+\t\t\techo \"</table>\";\r\n+\t\t}\r\n+\t}\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1759925234599,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1275,40 +1275,146 @@\n \t\t\t\t$data[\"toplam_tutar\"] = $toplam_tutar;\r\n \r\n \t\t\t\t\r\n \r\n-\t\t\t\t// Durum bazında istatistikler\r\n+\t\t\t\t// Detaylı istatistikler\r\n \r\n-\t\t\t\t$onay_bekleyen = 0;\r\n+\t\t\t\t$durum_stats = [\r\n \r\n-\t\t\t\t$onaylanan = 0;\r\n+\t\t\t\t\t'bekleyen' => 0,\r\n \r\n-\t\t\t\t$reddedilen = 0;\r\n+\t\t\t\t\t'tamamlanan' => 0,\r\n \r\n+\t\t\t\t\t'reddedilen' => 0\r\n+\r\n+\t\t\t\t];\r\n+\r\n \t\t\t\t\r\n \r\n+\t\t\t\t$tip_stats = [\r\n+\r\n+\t\t\t\t\t'senet' => ['adet' => 0, 'tutar' => 0],\r\n+\r\n+\t\t\t\t\t'cek' => ['adet' => 0, 'tutar' => 0],\r\n+\r\n+\t\t\t\t\t'banka' => ['adet' => 0, 'tutar' => 0],\r\n+\r\n+\t\t\t\t\t'kasa' => ['adet' => 0, 'tutar' => 0]\r\n+\r\n+\t\t\t\t];\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t$vadesi_gecen = ['adet' => 0, 'tutar' => 0];\r\n+\r\n+\t\t\t\t$bugun = date('Y-m-d');\r\n+\r\n+\t\t\t\t\r\n+\r\n \t\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n \r\n+\t\t\t\t\t// Durum bazında sayım\r\n+\r\n \t\t\t\t\tswitch($tahsilat->durum) {\r\n \r\n-\t\t\t\t\t\tcase 1: $onay_bekleyen++; break;\r\n+\t\t\t\t\t\tcase 1: $durum_stats['bekleyen']++; break;\r\n \r\n-\t\t\t\t\t\tcase 2: $onaylanan++; break;\r\n+\t\t\t\t\t\tcase 2: $durum_stats['tamamlanan']++; break;\r\n \r\n-\t\t\t\t\t\tcase 3: $reddedilen++; break;\r\n+\t\t\t\t\t\tcase 3: $durum_stats['reddedilen']++; break;\r\n \r\n \t\t\t\t\t}\r\n \r\n+\t\t\t\t\t\r\n+\r\n+\t\t\t\t\t// Tip bazında sayım ve tutar\r\n+\r\n+\t\t\t\t\t$tutar = (float)$tahsilat->tutar ?: 0;\r\n+\r\n+\t\t\t\t\t\r\n+\r\n+\t\t\t\t\tswitch($tahsilat->tahsilat_tipi) {\r\n+\r\n+\t\t\t\t\t\tcase 1: // Banka\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['banka']['adet']++;\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['banka']['tutar'] += $tutar;\r\n+\r\n+\t\t\t\t\t\t\tbreak;\r\n+\r\n+\t\t\t\t\t\tcase 2: // Çek\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['cek']['adet']++;\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['cek']['tutar'] += $tutar;\r\n+\r\n+\t\t\t\t\t\t\t\r\n+\r\n+\t\t\t\t\t\t\t// Vadesi geçen çekler\r\n+\r\n+\t\t\t\t\t\t\tif(isset($tahsilat->cek_vade_tarih) && $tahsilat->cek_vade_tarih && $tahsilat->cek_vade_tarih < $bugun && $tahsilat->durum != 2) {\r\n+\r\n+\t\t\t\t\t\t\t\t$vadesi_gecen['adet']++;\r\n+\r\n+\t\t\t\t\t\t\t\t$vadesi_gecen['tutar'] += $tutar;\r\n+\r\n+\t\t\t\t\t\t\t}\r\n+\r\n+\t\t\t\t\t\t\tbreak;\r\n+\r\n+\t\t\t\t\t\tcase 3: // Kasa\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['kasa']['adet']++;\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['kasa']['tutar'] += $tutar;\r\n+\r\n+\t\t\t\t\t\t\tbreak;\r\n+\r\n+\t\t\t\t\t\tcase 4: // Senet\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['senet']['adet']++;\r\n+\r\n+\t\t\t\t\t\t\t$tip_stats['senet']['tutar'] += $tutar;\r\n+\r\n+\t\t\t\t\t\t\t\r\n+\r\n+\t\t\t\t\t\t\t// Vadesi geçen senetler\r\n+\r\n+\t\t\t\t\t\t\tif(isset($tahsilat->senet_vade_tarih) && $tahsilat->senet_vade_tarih && $tahsilat->senet_vade_tarih < $bugun && $tahsilat->durum != 2) {\r\n+\r\n+\t\t\t\t\t\t\t\t$vadesi_gecen['adet']++;\r\n+\r\n+\t\t\t\t\t\t\t\t$vadesi_gecen['tutar'] += $tutar;\r\n+\r\n+\t\t\t\t\t\t\t}\r\n+\r\n+\t\t\t\t\t\t\tbreak;\r\n+\r\n+\t\t\t\t\t}\r\n+\r\n \t\t\t\t}\r\n \r\n \t\t\t\t\r\n \r\n-\t\t\t\t$data[\"onay_bekleyen_adet\"] = $onay_bekleyen;\r\n+\t\t\t\t// İstatistikleri data'ya ekle\r\n \r\n-\t\t\t\t$data[\"onaylanan_adet\"] = $onaylanan;\r\n+\t\t\t\t$data[\"durum_stats\"] = $durum_stats;\r\n \r\n-\t\t\t\t$data[\"reddedilen_adet\"] = $reddedilen;\r\n+\t\t\t\t$data[\"tip_stats\"] = $tip_stats;\r\n \r\n+\t\t\t\t$data[\"vadesi_gecen\"] = $vadesi_gecen;\r\n+\r\n+\t\t\t\t\r\n+\r\n+\t\t\t\t// Eski format uyumluluğu için\r\n+\r\n+\t\t\t\t$data[\"onay_bekleyen_adet\"] = $durum_stats['bekleyen'];\r\n+\r\n+\t\t\t\t$data[\"onaylanan_adet\"] = $durum_stats['tamamlanan'];\r\n+\r\n+\t\t\t\t$data[\"reddedilen_adet\"] = $durum_stats['reddedilen'];\r\n+\r\n \t\t\t}\r\n \r\n \t\t}\r\n \r\n"
                }
            ],
            "date": 1755256998990,
            "name": "Commit-0",
            "content": "<?php\r\n\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n\r\n\r\nclass Muhasebe extends CI_Controller {\r\n\r\n\t\tpublic function __construct()\r\n\r\n\t{\r\n\r\n\t\tparent::__construct();\r\n\r\n\t\terror_reporting(E_ALL ^ (E_NOTICE | E_WARNING));\r\n\r\n\t\t$this->load->model('vt');\r\n\r\n\t\t$this->load->database();\r\n\r\n\t\t$this->load->helper('general');\r\n\r\n\r\n\r\n\t\t$control = session(\"r\", \"login\");\r\n\r\n\r\n\r\n\t\tif (!$control) {\r\n\r\n\t\t\tredirect(\"check\");\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Session kontrolü - varsa aktifleştir\r\n\r\n\t\t// sessionKontrolHelper();\r\n\r\n\t}\tpublic function onayBekleyenTahsilatlar()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '512M');\r\n\r\n\t\tini_set('max_execution_time', 600);\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Onay Bekleyen Tahsilatlar\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\t\t// Giriş yapan kullanıcı bilgisi\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosunun varlığını kontrol et\r\n\r\n\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n\r\n\t\t\r\n\r\n\t\tif ($tableExists == 0) {\r\n\r\n\t\t\t// Tablo yoksa boş veri döndür ve kullanıcıyı bilgilendir\r\n\r\n\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t$data[\"error_message\"] = \"Muhasebe tahsilat durum tablosu henüz oluşturulmamış. Lütfen 'muhase_database_setup.sql' dosyasını veritabanında çalıştırın.\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Bağımlı tabloların varlığını da kontrol et\r\n\r\n\t\t\t$requiredTables = ['bankaHareketleri', 'cek', 'kasaHareketleri', 'senet', 'cari', 'kullanicilar'];\r\n\r\n\t\t\t$missingTables = [];\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach($requiredTables as $table) {\r\n\r\n\t\t\t\t$exists = $this->db->query(\"SHOW TABLES LIKE '$table'\")->num_rows();\r\n\r\n\t\t\t\tif($exists == 0) {\r\n\r\n\t\t\t\t\t$missingTables[] = $table;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(!empty($missingTables)) {\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t\t$data[\"toplam_adet\"] = 0;\t\t\t\t$data[\"error_message\"] = \"Eksik tablolar tespit edildi: \" . implode(', ', $missingTables) . \". Lütfen veritabanı kurulumunu tamamlayın.\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t// Detaylı sorgu - Gerçek verilerle JOIN'ler\r\n\r\n\t\t\t\t$tahsilatlarQ = \"SELECT DISTINCT\r\n\r\n\t\t\t\t   mtd.id,\r\n\r\n\t\t\t\t   mtd.tahsilat_tipi,\r\n\r\n\t\t\t\t   mtd.kayit_id,\r\n\r\n\t\t\t\t   mtd.durum,\r\n\r\n\t\t\t\t   mtd.islem_tarihi,\r\n\r\n\t\t\t\t   mtd.olusturma_tarihi,\r\n\r\n\t\t\t\t   mtd.aciklama,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN 'Banka Hareketi'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa Hareketi'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as tahsilat_tipi_adi,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as durum_adi,\r\n\r\n\t\t\t\t   COALESCE(c.cari_ad, c.cari_soyad, 'Bilinmiyor') as musteri_adi,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN bh.bh_gorsel\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN ck.cek_gorsel\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN kh.kh_gorsel\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN s.senet_gorsel\r\n\r\n\t\t\t\t\t   ELSE NULL\r\n\r\n\t\t\t\t   END as gorsel,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN COALESCE(bh.bh_giris, bh.bh_cikis, 0)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN COALESCE(ck.cek_tutar, 0)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN COALESCE(kh.kh_giris, kh.kh_cikis, 0)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN COALESCE(s.senet_tutar, 0)\r\n\r\n\t\t\t\t\t   ELSE 0\r\n\r\n\t\t\t\t   END as tutar,\r\n\r\n\t\t\t\t   COALESCE(CONCAT(onay_personel.kullanici_ad, ' ', onay_personel.kullanici_soyad), onay_personel.kullanici_ad, 'Bilinmiyor') as onay_yapan_personel,\r\n\r\n\t\t\t\t   COALESCE(CONCAT(islem_personel.kullanici_ad, ' ', islem_personel.kullanici_soyad), islem_personel.kullanici_ad, 'Bilinmiyor') as islemi_yapan_personel\r\n\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n\r\n\t\t\t\tLEFT JOIN bankaHareketleri bh ON (mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id)\r\n\r\n\t\t\t\tLEFT JOIN cek ck ON (mtd.tahsilat_tipi = 2 AND mtd.kayit_id = ck.cek_id)\r\n\r\n\t\t\t\tLEFT JOIN kasaHareketleri kh ON (mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id)\r\n\r\n\t\t\t\tLEFT JOIN senet s ON (mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id)\r\n\r\n\t\t\t\tLEFT JOIN cari c ON (\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND c.cari_id = bh.bh_cariID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND c.cari_id = ck.cek_cariID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND c.cari_id = kh.kh_cariID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND c.cari_id = s.senet_cariID)\r\n\r\n\t\t\t\t)\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar onay_personel ON mtd.islemi_yapan = onay_personel.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar islem_personel ON (\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 1 AND islem_personel.kullanici_id = bh.bh_olusturan) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 2 AND islem_personel.kullanici_id = ck.cek_kullaniciID) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 3 AND islem_personel.kullanici_id = kh.kh_olusturan) OR\r\n\r\n\t\t\t\t\t(mtd.tahsilat_tipi = 4 AND islem_personel.kullanici_id = s.senet_kullaniciID)\r\n\r\n\t\t\t\t)\r\n\r\n\t\t\t\tWHERE mtd.durum = 1 AND mtd.tahsilat_tipi IN (1, 2, 3, 4)\r\n\r\n\t\t\t\tORDER BY mtd.olusturma_tarihi DESC\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Veritabanı sorgusunu try-catch ile çalıştır\r\n\r\n\t\t\ttry {\r\n\r\n\t\t\t\t$result = $this->db->query($tahsilatlarQ);\r\n\r\n\t\t\t\tif ($result) {\r\n\r\n\t\t\t\t\t$data[\"tahsilatlar\"] = $result->result();\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\tthrow new Exception(\"Veritabanı sorgusu başarısız oldu.\");\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} catch (Exception $e) {\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t\t$data[\"error_message\"] = \"Veritabanı hatası: \" . $e->getMessage();\r\n\r\n\t\t\t\terror_log(\"Muhasebe onay bekleyen tahsilatlar sorgu hatası: \" . $e->getMessage());\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\t// İstatistikler\r\n\r\n\t\t\t$data[\"toplam_adet\"] = count($data[\"tahsilatlar\"]);\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Toplam tutar hesapla\r\n\r\n\t\t\t$toplam_tutar = 0;\r\n\r\n\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n\r\n\t\t\t\tif($tahsilat->tutar) {\r\n\r\n\t\t\t\t\t$toplam_tutar += $tahsilat->tutar;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = $toplam_tutar;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Veri kontrolü\r\n\r\n\t\tif (!isset($data[\"tahsilatlar\"])) {\r\n\r\n\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t$data[\"error_message\"] = \"Tahsilat verileri yüklenemedi.\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfa yükle - Try-catch ile hata yakalama\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$this->load->view(\"muhasebe/onay-bekleyen-tahsilatlar\", $data);\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t// Hata durumunda basit hata sayfası göster\r\n\r\n\t\t\techo \"<h3>Sayfa Yükleme Hatası</h3>\";\r\n\r\n\t\t\techo \"<p>Hata: \" . $e->getMessage() . \"</p>\";\r\n\r\n\t\t\techo \"<p><a href='\" . base_url('muhasebe') . \"'>Muhasebe Ana Sayfaya Dön</a></p>\";\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function tahsilatOnay($tahsilat_id)\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosundan bilgiyi kontrol et\r\n\r\n\t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n\r\n\t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif ($tahsilat && $tahsilat->durum == 1) { // Sadece onay bekleyen durumda olanlar\r\n\r\n\t\t\t// Onay işlemi\r\n\r\n\t\t\t$data = array(\r\n\r\n\t\t\t\t'durum' => 2, // 2 = Onaylandı\r\n\r\n\t\t\t\t'islem_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t'islemi_yapan' => $u_id\r\n\r\n\t\t\t);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->db->where('id', $tahsilat_id);\r\n\r\n\t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->session->set_flashdata('tahsilat_onay_ok', 'OK');\r\n\r\n\t\t\tlogekle(1, 3); // Log ekle\r\n\r\n\t\t} else {\t\t\t$this->session->set_flashdata('tahsilat_onay_hata', 'OK');\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\tredirect(\"muhasebe/onay-bekleyen-tahsilatlar\");\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function tahsilatRed($tahsilat_id)\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosundan bilgiyi kontrol et\r\n\r\n\t\t$tahsilatQ = \"SELECT * FROM muhasebe_tahsilat_durum WHERE id = '$tahsilat_id'\";\r\n\r\n\t\t$tahsilat = $this->db->query($tahsilatQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif ($tahsilat && $tahsilat->durum == 1) { // Sadece onay bekleyen durumda olanlar\r\n\r\n\t\t\t// Red işlemi\r\n\r\n\t\t\t$data = array(\r\n\r\n\t\t\t\t'durum' => 3, // 3 = Reddedildi\r\n\r\n\t\t\t\t'islem_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t'islemi_yapan' => $u_id\r\n\r\n\t\t\t);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->db->where('id', $tahsilat_id);\r\n\r\n\t\t\t$this->db->update('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t\r\n\r\n\t\t\t$this->session->set_flashdata('tahsilat_red_ok', 'OK');\r\n\r\n\t\t\tlogekle(1, 3); // Log ekle\r\n\r\n\t\t} else {\t\t\t$this->session->set_flashdata('tahsilat_red_hata', 'OK');\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\tredirect(\"muhasebe/onay-bekleyen-tahsilatlar\");\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function tahsilatDetay($tahsilat_id)\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosundan detayı getir\r\n\r\n\t\t$tahsilatQ = \"SELECT \r\n\r\n\t\t   mtd.id,\r\n\r\n\t\t   mtd.tahsilat_tipi,\r\n\r\n\t\t   CASE \r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN 'Banka'\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa'\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t   END as tahsilat_tipi_adi,\r\n\r\n\t\t   mtd.kayit_id,\r\n\r\n\t\t   CASE \r\n\r\n\t\t\t   WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n\t\t\t   WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n\t\t\t   WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t   END as durum_adi,\r\n\r\n\t\t   mtd.durum,\r\n\r\n\t\t   COALESCE(bh_cari.cari_ad, c_cari.cari_ad, kh_cari.cari_ad, s_cari.cari_ad) as musteri_adi,\r\n\r\n\t\t   COALESCE(bh_cari.cari_kodu, c_cari.cari_kodu, kh_cari.cari_kodu, s_cari.cari_kodu) as musteri_kodu,\r\n\r\n\t\t   COALESCE(bh_cari.cari_firmaTelefon, c_cari.cari_firmaTelefon, kh_cari.cari_firmaTelefon, s_cari.cari_firmaTelefon) as musteri_telefon,\r\n\r\n\t\t   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as gorsel,\r\n\r\n\t\t   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n\r\n\t\t   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n\r\n\t\t   CASE \r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN CONCAT(bh_k.kullanici_ad, ' ', bh_k.kullanici_soyad)\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN CONCAT(c_k.kullanici_ad, ' ', c_k.kullanici_soyad)\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN CONCAT(kh_k.kullanici_ad, ' ', kh_k.kullanici_soyad)\r\n\r\n\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN CONCAT(s_k.kullanici_ad, ' ', s_k.kullanici_soyad)\r\n\r\n\t\t   END as islemi_yapan_personel,\r\n\r\n\t\t   mtd.islem_tarihi,\r\n\r\n\t\t   mtd.olusturma_tarihi,\r\n\r\n\t\t   mtd.aciklama\r\n\r\n\t\tFROM muhasebe_tahsilat_durum mtd\r\n\r\n\t\t\r\n\r\n\t\t-- Onay yapan personel\r\n\r\n\t\tLEFT JOIN kullanicilar onay_k ON mtd.islemi_yapan = onay_k.kullanici_id\r\n\r\n\t\t\r\n\r\n\t\t-- Banka hareketleri\r\n\r\n\t\tLEFT JOIN bankaHareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\r\n\t\tLEFT JOIN kullanicilar bh_k ON bh.bh_olusturan = bh_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari bh_cari ON bh.bh_cariID = bh_cari.cari_id\r\n\r\n\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n\r\n\t\t\r\n\r\n\t\t-- Çek\r\n\r\n\t\tLEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n\r\n\t\tLEFT JOIN kullanicilar c_k ON c.cek_kullaniciID = c_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari c_cari ON c.cek_cariID = c_cari.cari_id\r\n\r\n\t\t\r\n\r\n\t\t-- Kasa hareketleri\r\n\r\n\t\tLEFT JOIN kasaHareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\r\n\t\tLEFT JOIN kullanicilar kh_k ON kh.kh_olusturan = kh_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari kh_cari ON kh.kh_cariID = kh_cari.cari_id\r\n\r\n\t\t\r\n\r\n\t\t-- Senet\r\n\r\n\t\tLEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n\r\n\t\tLEFT JOIN kullanicilar s_k ON s.senet_kullaniciID = s_k.kullanici_id\r\n\r\n\t\tLEFT JOIN cari s_cari ON s.senet_cariID = s_cari.cari_id\r\n\r\n\t\t\r\n\r\n\t\tWHERE mtd.id = '$tahsilat_id'\";\r\n\r\n\t\t\r\n\r\n\t\t$data[\"tahsilat\"] = $this->db->query($tahsilatQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif ($data[\"tahsilat\"]) {\r\n\r\n\t\t\t$data[\"baslik\"] = \"Muhasebe / Tahsilat Detayı\";\r\n\r\n\t\t\t$this->load->view(\"muhasebe/tahsilat-detay\", $data);\r\n\r\n\t\t} else {\r\n\r\n\t\t\tredirect('hata');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\tpublic function tahsilatListesi()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Tahsilat Listesi\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Giriş yapan kullanıcı bilgisi\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Çek senkronizasyonu - çek tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeCekler();\r\n\r\n\t\t\r\n\r\n\t\t// Banka hareketleri senkronizasyonu - bankaHareketleri tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeBankaHareketleri();\r\n\r\n\t\t\r\n\r\n\t\t// Kasa hareketleri senkronizasyonu - kasaHareketleri tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeKasaHareketleri();\r\n\r\n\t\t\r\n\r\n\t\t// Senet senkronizasyonu - senet tablosundaki kayıtları muhasebe_tahsilat_durum'a ekle\r\n\r\n\t\t$this->senkronizeSenetler();\r\n\r\n\t\t\r\n\r\n\t\t// Muhasebe tahsilat durum tablosunun varlığını kontrol et\r\n\r\n\t\t$tableExists = $this->db->query(\"SHOW TABLES LIKE 'muhasebe_tahsilat_durum'\")->num_rows();\r\n\r\n\t\t\r\n\r\n\t\tif ($tableExists == 0) {\r\n\r\n\t\t\t// Tablo yoksa boş veri döndür ve kullanıcıyı bilgilendir\r\n\r\n\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t$data[\"error_message\"] = \"Muhasebe tahsilat durum tablosu henüz oluşturulmamış. Lütfen 'muhase_database_setup.sql' dosyasını veritabanında çalıştırın.\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Bağımlı tabloların varlığını da kontrol et\r\n\r\n\t\t\t$requiredTables = ['bankaHareketleri', 'cek', 'kasaHareketleri', 'senet', 'cari', 'kullanicilar'];\r\n\r\n\t\t\t$missingTables = [];\r\n\r\n\t\t\t\r\n\r\n\t\t\tforeach($requiredTables as $table) {\r\n\r\n\t\t\t\t$exists = $this->db->query(\"SHOW TABLES LIKE '$table'\")->num_rows();\r\n\r\n\t\t\t\tif($exists == 0) {\r\n\r\n\t\t\t\t\t$missingTables[] = $table;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(!empty($missingTables)) {\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = array();\r\n\r\n\t\t\t\t$data[\"toplam_tutar\"] = 0;\r\n\r\n\t\t\t\t$data[\"toplam_adet\"] = 0;\r\n\r\n\t\t\t\t$data[\"error_message\"] = \"Eksik tablolar tespit edildi: \" . implode(', ', $missingTables) . \". Lütfen veritabanı kurulumunu tamamlayın.\";\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t// Ana sorgu: Muhasebe tahsilat durum tablosundan tüm tahsilatları çek (durum filtresi yok)\r\n\r\n\t\t\t\t$tahsilatlarQ = \"SELECT \r\n\r\n\t\t\t\t   mtd.id,\r\n\r\n\t\t\t\t   mtd.tahsilat_tipi,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN 'Banka'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN 'Çek'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN 'Kasa'\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN 'Senet'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as tahsilat_tipi_adi,\r\n\r\n\t\t\t\t   mtd.kayit_id,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 1 THEN 'Onay Bekliyor'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 2 THEN 'Onaylandı'\r\n\r\n\t\t\t\t\t   WHEN mtd.durum = 3 THEN 'Reddedildi'\r\n\r\n\t\t\t\t\t   ELSE 'Bilinmiyor'\r\n\r\n\t\t\t\t   END as durum_adi,\r\n\r\n\t\t\t\t   mtd.durum,\r\n\r\n\t\t\t\t   COALESCE(bh_cari.cari_ad, c_cari.cari_ad, kh_cari.cari_ad, s_cari.cari_ad) as musteri_adi,\r\n\r\n\t\t\t\t   COALESCE(bh.bh_gorsel, c.cek_gorsel, kh.kh_gorsel, s.senet_gorsel) as gorsel,\r\n\r\n\t\t\t\t   COALESCE(bh.bh_giris, c.cek_tutar, kh.kh_giris, s.senet_tutar) as tutar,\r\n\r\n\t\t\t\t   -- Çek ek bilgileri\r\n\r\n\t\t\t\t   c.cek_seriNo as cek_seri_no,\r\n\r\n\t\t\t\t   c.cek_vadeTarih as cek_vade_tarih,\r\n\r\n\t\t\t\t   c.cek_portfoyNo as cek_portfoy_no,\r\n\r\n\t\t\t\t   c.cek_durum as cek_durum,\r\n\r\n\t\t\t\t   -- Senet ek bilgileri\r\n\r\n\t\t\t\t   s.senet_seriNo as senet_seri_no,\r\n\r\n\t\t\t\t   s.senet_vadeTarih as senet_vade_tarih,\r\n\r\n\t\t\t\t   s.senet_portfoyNo as senet_portfoy_no,\r\n\r\n\t\t\t\t   s.senet_durum as senet_durum,\r\n\r\n\t\t\t\t   s.senet_gorsel as senet_gorsel,\r\n\r\n\t\t\t\t   -- Banka ek bilgileri\r\n\r\n\t\t\t\t   bh.bh_belgeNumarasi as banka_belge_no,\r\n\r\n\t\t\t\t   bh.bh_turu as banka_turu,\r\n\r\n\t\t\t\t   bh.bh_bankaID as banka_id,\r\n\r\n\t\t\t\t   bh.bh_tarih as banka_tarih,\r\n\r\n\t\t\t\t   bh.bh_aciklama as banka_aciklama,\r\n\r\n\t\t\t\t   b.banka_bankaAd as banka_adi,\r\n\r\n\t\t\t\t   b.banka_hesapNo as banka_hesap_no,\r\n\r\n\t\t\t\t   -- Kasa ek bilgileri\r\n\r\n\t\t\t\t   kh.kh_belgeNumarasi as kasa_belge_no,\r\n\r\n\t\t\t\t   kh.kh_turu as kasa_turu,\r\n\r\n\t\t\t\t   kh.kh_kasaID as kasa_id,\r\n\r\n\t\t\t\t   kh.kh_tarih as kasa_tarih,\r\n\r\n\t\t\t\t   kh.kh_aciklama as kasa_aciklama,\r\n\r\n\t\t\t\t   k.kasa_adi as kasa_adi,\r\n\r\n\t\t\t\t   k.kasa_kodu as kasa_kodu,\r\n\r\n\t\t\t\t   CONCAT(onay_k.kullanici_ad, ' ', onay_k.kullanici_soyad) as onay_yapan_personel,\r\n\r\n\t\t\t\t   CASE \r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 1 THEN CONCAT(bh_k.kullanici_ad, ' ', bh_k.kullanici_soyad)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 2 THEN CONCAT(c_k.kullanici_ad, ' ', c_k.kullanici_soyad)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 3 THEN CONCAT(kh_k.kullanici_ad, ' ', kh_k.kullanici_soyad)\r\n\r\n\t\t\t\t\t   WHEN mtd.tahsilat_tipi = 4 THEN CONCAT(s_k.kullanici_ad, ' ', s_k.kullanici_soyad)\r\n\r\n\t\t\t\t   END as islemi_yapan_personel,\r\n\r\n\t\t\t\t   mtd.islem_tarihi,\r\n\r\n\t\t\t\t   mtd.olusturma_tarihi,\r\n\r\n\t\t\t\t   mtd.aciklama\r\n\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Onay yapan personel\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar onay_k ON mtd.islemi_yapan = onay_k.kullanici_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Banka hareketleri\r\n\r\n\t\t\t\tLEFT JOIN bankaHareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar bh_k ON bh.bh_olusturan = bh_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari bh_cari ON bh.bh_cariID = bh_cari.cari_id\r\n\r\n\t\t\t\tLEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Çek (ek dosyasından gelen yapıya göre güncellenmiş)\r\n\r\n\t\t\t\tLEFT JOIN cek c ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar c_k ON c.cek_kullaniciID = c_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari c_cari ON c.cek_cariID = c_cari.cari_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Kasa hareketleri\r\n\r\n\t\t\t\tLEFT JOIN kasaHareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar kh_k ON kh.kh_olusturan = kh_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari kh_cari ON kh.kh_cariID = kh_cari.cari_id\r\n\r\n\t\t\t\tLEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- Senet\r\n\r\n\t\t\t\tLEFT JOIN senet s ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar s_k ON s.senet_kullaniciID = s_k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN cari s_cari ON s.senet_cariID = s_cari.cari_id\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\tWHERE mtd.tahsilat_tipi IN (1, 2, 3, 4)\r\n\r\n\t\t\t\tORDER BY mtd.olusturma_tarihi DESC\";\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$data[\"tahsilatlar\"] = $this->db->query($tahsilatlarQ)->result();\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// İstatistikler\r\n\r\n\t\t\t\t$data[\"toplam_adet\"] = count($data[\"tahsilatlar\"]);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// Toplam tutar hesapla\r\n\r\n\t\t\t\t$toplam_tutar = 0;\r\n\r\n\t\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n\r\n\t\t\t\t\tif($tahsilat->tutar) {\r\n\r\n\t\t\t\t\t\t$toplam_tutar += $tahsilat->tutar;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$data[\"toplam_tutar\"] = $toplam_tutar;\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t// Durum bazında istatistikler\r\n\r\n\t\t\t\t$onay_bekleyen = 0;\r\n\r\n\t\t\t\t$onaylanan = 0;\r\n\r\n\t\t\t\t$reddedilen = 0;\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\tforeach($data[\"tahsilatlar\"] as $tahsilat) {\r\n\r\n\t\t\t\t\tswitch($tahsilat->durum) {\r\n\r\n\t\t\t\t\t\tcase 1: $onay_bekleyen++; break;\r\n\r\n\t\t\t\t\t\tcase 2: $onaylanan++; break;\r\n\r\n\t\t\t\t\t\tcase 3: $reddedilen++; break;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$data[\"onay_bekleyen_adet\"] = $onay_bekleyen;\r\n\r\n\t\t\t\t$data[\"onaylanan_adet\"] = $onaylanan;\r\n\r\n\t\t\t\t$data[\"reddedilen_adet\"] = $reddedilen;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfa yükle\r\n\r\n\t\t$this->load->view(\"muhasebe/tahsilat-listesi\", $data);\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Senet Yönetimi - Muhasebe altında\r\n\r\n\t */\r\n\r\n\tpublic function senet_yonetim()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '256M');\r\n\r\n\t\tini_set('max_execution_time', 300);\r\n\r\n\t\t\r\n\r\n\t\t// Session kontrolü\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Yetki kontrolü - Senet Yönetimi (ID: 522)\r\n\r\n\t\tif (!grup_modul_yetkisi_var(522)) {\r\n\r\n\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Senet Yönetimi (ID: 522)', 403);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Debug bilgisi - kullanıcı 187 için\r\n\r\n\t\t$debug_info = \"\";\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$debug_info = \"<!-- SENET YONETIM DEBUG: User={$control->kullanici_id}, Group={$control->grup_id}, YetkiKontrolü=522 -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Senet Yönetimi\";\r\n\r\n\t\t\r\n\r\n\t\t// Debug bilgisini data'ya ekle\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] = $debug_info . \"<!-- SENET YONETIM SUCCESS: Fonksiyon başarıyla başladı -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Durum filtresi\r\n\r\n\t\t$durum_filter = $this->input->get('durum');\r\n\r\n\t\t$valid_durumlar = ['eldeki', 'bankaya-verilen', 'tahsil-edilen', 'protesto', 'vadesi-gecen'];\r\n\r\n\t\t\r\n\r\n\t\tif (!$durum_filter || !in_array($durum_filter, $valid_durumlar)) {\r\n\r\n\t\t\t$durum_filter = 'eldeki'; // Default\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data['durum_filter'] = $durum_filter;\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Durum filtresi\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] .= \"<!-- DURUM FILTER: $durum_filter -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Durum ID'lerini map et\r\n\r\n\t\t$durum_map = [\r\n\r\n\t\t\t'eldeki' => 1,           // Eldeki Bekleyen Senetler\r\n\r\n\t\t\t'bankaya-verilen' => 2,  // Bankaya Verilen Senetler  \r\n\r\n\t\t\t'tahsil-edilen' => 3,    // Bankadan Tahsil Edilen Senetler\r\n\r\n\t\t\t'protesto' => 4,         // Protesto Olan Senetler\r\n\r\n\t\t\t'vadesi-gecen' => 5      // Vadesi Geçen Tahsilatlar\r\n\r\n\t\t];\r\n\r\n\t\t\r\n\r\n\t\t$durum_id = $durum_map[$durum_filter];\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Durum ID\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] .= \"<!-- DURUM ID: $durum_id -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfalama\r\n\r\n\t\t$page = $this->input->get('sayfa') ? $this->input->get('sayfa') : 1;\r\n\r\n\t\t$limit = 20;\r\n\r\n\t\t$offset = ($page - 1) * $limit;\r\n\r\n\t\t\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Ana sorgu - Vadesi geçen durumu için özel sorgu\r\n\r\n\t\tif ($durum_filter == 'vadesi-gecen') {\r\n\r\n\t\t\t$senetlerQ = \"\r\n\r\n\t\t\t\tSELECT s.*, \r\n\r\n\t\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n\r\n\t\t\t\t\t   c.cari_firmaTelefon as cari_telefon,\r\n\r\n\t\t\t\t\t   CONCAT_WS(' ', k.kullanici_ad, k.kullanici_soyad) as personel_adi,\r\n\r\n\t\t\t\t\t   s.senet_gorsel,\r\n\r\n\t\t\t\t\t   'Vadesi Geçen' as son_durum,\r\n\r\n\t\t\t\t\t   '#dc3545' as durum_rengi,\r\n\r\n\t\t\t\t\t   'fa-exclamation-triangle' as durum_ikonu,\r\n\r\n\t\t\t\t\t   NULL as son_hareket_tarihi,\r\n\r\n\t\t\t\t\t   NULL as banka_hesap_adi,\r\n\r\n\t\t\t\t\t   DATEDIFF(s.senet_vadeTarih, CURDATE()) as vade_gun_kalan\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n\r\n\t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n\r\n\t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n\r\n\t\t\t\tLIMIT $offset, $limit\r\n\r\n\t\t\t\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Ana sorgu - Senet tablosu için doğru sütun adlarını kullan\r\n\r\n\t\t\t$senetlerQ = \"\r\n\r\n\t\t\t\tSELECT s.*, \r\n\r\n\t\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n\r\n\t\t\t\t\t   c.cari_firmaTelefon as cari_telefon,\r\n\r\n\t\t\t\t\t   CONCAT_WS(' ', k.kullanici_ad, k.kullanici_soyad) as personel_adi,\r\n\r\n\t\t\t\t\t   s.senet_gorsel,\r\n\r\n\t\t\t\t\t   skt.skt_adi as son_durum,\r\n\r\n\t\t\t\t\t   skt.skt_renk as durum_rengi,\r\n\r\n\t\t\t\t\t   skt.skt_ikon as durum_ikonu,\r\n\r\n\t\t\t\t\t   sh_son.sh_tarih as son_hareket_tarihi,\r\n\r\n\t\t\t\t\t   b.banka_bankaAd as banka_hesap_adi,\r\n\r\n\t\t\t\t\t   DATEDIFF(s.senet_vadeTarih, CURDATE()) as vade_gun_kalan\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tLEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n\r\n\t\t\t\tLEFT JOIN kullanicilar k ON s.senet_kullaniciID = k.kullanici_id\r\n\r\n\t\t\t\tLEFT JOIN (\r\n\r\n\t\t\t\t\tSELECT sh1.sh_senet_id, MAX(sh1.sh_id) as max_id\r\n\r\n\t\t\t\t\tFROM senet_hareketleri sh1\r\n\r\n\t\t\t\t\tGROUP BY sh1.sh_senet_id\r\n\r\n\t\t\t\t) son_hareket ON s.senet_id = son_hareket.sh_senet_id\r\n\r\n\t\t\t\tLEFT JOIN senet_hareketleri sh_son ON son_hareket.max_id = sh_son.sh_id\r\n\r\n\t\t\t\tLEFT JOIN senet_konum_tipleri skt ON sh_son.sh_konum_tip_id = skt.skt_id\r\n\r\n\t\t\t\tLEFT JOIN banka b ON sh_son.sh_banka_id = b.banka_id\r\n\r\n\t\t\t\tWHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\r\n\r\n\t\t\t\tORDER BY s.senet_vadeTarih ASC\r\n\r\n\t\t\t\tLIMIT $offset, $limit\r\n\r\n\t\t\t\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sorguyu çalıştır ve hata kontrolü yap\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$senetlerResult = $this->db->query($senetlerQ);\r\n\r\n\t\t\tif (!$senetlerResult) {\r\n\r\n\t\t\t\tthrow new Exception(\"Senet listesi sorgusu başarısız: \" . $this->db->error()['message']);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data['senetler'] = $senetlerResult->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Debug - Sorgu sonucu\r\n\r\n\t\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t\t$data['debug_info'] .= \"<!-- SENET SORGUSU: \" . count($data['senetler']) . \" senet bulundu -->\";\r\n\r\n\t\t\t\t$data['debug_info'] .= \"<!-- SQL SORGU: \" . str_replace(\"\\n\", \" \", $senetlerQ) . \" -->\";\r\n\r\n\t\t\t\tif (!empty($data['senetler'])) {\r\n\r\n\t\t\t\t\t$ilkSenet = $data['senetler'][0];\r\n\r\n\t\t\t\t\t$data['debug_info'] .= \"<!-- İLK SENET: cari_ad='\" . $ilkSenet->cari_ad . \"', senet_cariID='\" . $ilkSenet->senet_cariID . \"' -->\";\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['senetler'] = array();\r\n\r\n\t\t\t$data['error_message'] = \"Senet listesi yüklenirken hata oluştu: \" . $e->getMessage();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Debug - Hata mesajı\r\n\r\n\t\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t\t$data['debug_info'] .= \"<!-- SENET SORGUSU HATA: \" . $e->getMessage() . \" -->\";\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Toplam sayı - Vadesi geçen durumu için özel sorgu\r\n\r\n\t\tif ($durum_filter == 'vadesi-gecen') {\r\n\r\n\t\t\t$countQ = \"\r\n\r\n\t\t\t\tSELECT COUNT(*) as total\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tWHERE s.senet_vadeTarih < CURDATE()\r\n\r\n\t\t\t\";\r\n\r\n\t\t} else {\r\n\r\n\t\t\t$countQ = \"\r\n\r\n\t\t\t\tSELECT COUNT(*) as total\r\n\r\n\t\t\t\tFROM senet s\r\n\r\n\t\t\t\tLEFT JOIN (\r\n\r\n\t\t\t\t\tSELECT sh1.sh_senet_id, MAX(sh1.sh_id) as max_id\r\n\r\n\t\t\t\t\tFROM senet_hareketleri sh1\r\n\r\n\t\t\t\t\tGROUP BY sh1.sh_senet_id\r\n\r\n\t\t\t\t) son_hareket ON s.senet_id = son_hareket.sh_senet_id\r\n\r\n\t\t\t\tLEFT JOIN senet_hareketleri sh_son ON son_hareket.max_id = sh_son.sh_id\r\n\r\n\t\t\t\tWHERE (sh_son.sh_konum_tip_id = '$durum_id' OR (sh_son.sh_konum_tip_id IS NULL AND '$durum_id' = '1'))\r\n\r\n\t\t\t\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$countResult = $this->db->query($countQ);\r\n\r\n\t\t\tif (!$countResult) {\r\n\r\n\t\t\t\tthrow new Exception(\"Toplam sayı sorgusu başarısız: \" . $this->db->error()['message']);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$data['total_count'] = $countResult->row()->total;\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['total_count'] = 0;\r\n\r\n\t\t\tif (!isset($data['error_message'])) {\r\n\r\n\t\t\t\t$data['error_message'] = \"Toplam sayı hesaplanırken hata oluştu: \" . $e->getMessage();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Sayfalama\r\n\r\n\t\t$this->load->library('pagination');\r\n\r\n\t\t$config['base_url'] = base_url(\"muhasebe/senet-yonetim?durum=$durum_filter\");\r\n\r\n\t\t$config['total_rows'] = $data['total_count'];\r\n\r\n\t\t$config['per_page'] = $limit;\r\n\r\n\t\t$config['page_query_string'] = TRUE;\r\n\r\n\t\t$config['query_string_segment'] = 'sayfa';\r\n\r\n\t\t$config['use_page_numbers'] = TRUE;\r\n\r\n\t\t\r\n\r\n\t\t// Pagination style\r\n\r\n\t\t$config['full_tag_open'] = '<nav><ul class=\"pagination justify-content-center\">';\r\n\r\n\t\t$config['full_tag_close'] = '</ul></nav>';\r\n\r\n\t\t$config['first_link'] = 'İlk';\r\n\r\n\t\t$config['last_link'] = 'Son';\r\n\r\n\t\t$config['first_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['first_tag_close'] = '</li>';\r\n\r\n\t\t$config['prev_link'] = '&laquo;';\r\n\r\n\t\t$config['prev_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['prev_tag_close'] = '</li>';\r\n\r\n\t\t$config['next_link'] = '&raquo;';\r\n\r\n\t\t$config['next_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['next_tag_close'] = '</li>';\r\n\r\n\t\t$config['last_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['last_tag_close'] = '</li>';\r\n\r\n\t\t$config['cur_tag_open'] = '<li class=\"page-item active\"><a class=\"page-link\" href=\"#\">';\r\n\r\n\t\t$config['cur_tag_close'] = '</a></li>';\r\n\r\n\t\t$config['num_tag_open'] = '<li class=\"page-item\">';\r\n\r\n\t\t$config['num_tag_close'] = '</li>';\r\n\r\n\t\t$config['attributes'] = array('class' => 'page-link');\r\n\r\n\t\t\r\n\r\n\t\t$this->pagination->initialize($config);\r\n\r\n\t\t$data['pagination'] = $this->pagination->create_links();\r\n\r\n\t\t\r\n\r\n\t\t// Konum tipleri - Veritabanından doğru tablo adını kullanarak getir\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$data['konum_tipleri'] = $this->db->query(\"SELECT skt_id as kt_id, skt_adi as kt_ad, skt_renk as kt_renk, skt_ikon as kt_ikon, skt_sira_no as kt_sira FROM senet_konum_tipleri WHERE skt_aktif = '1' ORDER BY skt_sira_no ASC\")->result();\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t// Eğer tablo hata verirse fallback data kullan\r\n\r\n\t\t\t$data['konum_tipleri'] = array(\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 1,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Eldeki',\r\n\r\n\t\t\t\t\t'kt_renk' => '#17a2b8',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-clock',\r\n\r\n\t\t\t\t\t'kt_sira' => 1\r\n\r\n\t\t\t\t),\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 2,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Bankaya Verilen',\r\n\r\n\t\t\t\t\t'kt_renk' => '#ffc107',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-university',\r\n\r\n\t\t\t\t\t'kt_sira' => 2\r\n\r\n\t\t\t\t),\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 3,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Tahsil Edilen',\r\n\r\n\t\t\t\t\t'kt_renk' => '#28a745',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-check',\r\n\r\n\t\t\t\t\t'kt_sira' => 3\r\n\r\n\t\t\t\t),\r\n\r\n\t\t\t\t(object) array(\r\n\r\n\t\t\t\t\t'kt_id' => 4,\r\n\r\n\t\t\t\t\t'kt_ad' => 'Protesto',\r\n\r\n\t\t\t\t\t'kt_renk' => '#dc3545',\r\n\r\n\t\t\t\t\t'kt_ikon' => 'fa-times',\r\n\r\n\t\t\t\t\t'kt_sira' => 4\r\n\r\n\t\t\t\t)\r\n\r\n\t\t\t);\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Bankalar\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$data['bankalar'] = $this->db->query(\"SELECT * FROM banka ORDER BY banka_bankaAd ASC\")->result();\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['bankalar'] = array();\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// İstatistikler - hata olmadan çalıştırmaya çalış\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$data['istatistikler'] = $this->getSenetIstatistikleri();\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data['istatistikler'] = (object)[\r\n\r\n\t\t\t\t'toplam_senet' => 0,\r\n\r\n\t\t\t\t'toplam_tutar' => 0,\r\n\r\n\t\t\t\t'vadesi_gecen' => 0,\r\n\r\n\t\t\t\t'vadesi_yaklasan' => 0\r\n\r\n\t\t\t];\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Debug - Final\r\n\r\n\t\tif ($control->kullanici_id == 187) {\r\n\r\n\t\t\t$data['debug_info'] .= \"<!-- VIEW YUKLENIYOR: muhasebe/senet-yonetim -->\";\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Durum başlıkları\r\n\r\n\t\t$data['durum_basliklar'] = [\r\n\r\n\t\t\t'eldeki' => 'Eldeki Bekleyen Senetler',\r\n\r\n\t\t\t'bankaya-verilen' => 'Bankaya Verilen Senetler',\r\n\r\n\t\t\t'tahsil-edilen' => 'Bankadan Tahsil Edilen Senetler',\r\n\r\n\t\t\t'protesto' => 'Protesto Olan Senetler',\r\n\r\n\t\t\t'vadesi-gecen' => 'Vadesi Geçen Tahsilatlar'\r\n\r\n\t\t];\r\n\r\n\t\t\r\n\r\n\t\t$this->load->view('muhasebe/senet-yonetim', $data);\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Senet istatistikleri - Doğru sütun adlarını kullan\r\n\r\n\t */\r\n\r\n\tprivate function getSenetIstatistikleri()\r\n\r\n\t{\r\n\r\n\t\t$istatistikQ = \"\r\n\r\n\t\t\tSELECT \r\n\r\n\t\t\t\tCOUNT(*) as toplam_senet,\r\n\r\n\t\t\t\tSUM(s.senet_tutar) as toplam_tutar,\r\n\r\n\t\t\t\tCOUNT(CASE WHEN s.senet_vadeTarih < CURDATE() THEN 1 END) as vadesi_gecen,\r\n\r\n\t\t\t\tCOUNT(CASE WHEN s.senet_vadeTarih BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY) THEN 1 END) as vadesi_yaklasan\r\n\r\n\t\t\tFROM senet s\r\n\r\n\t\t\";\r\n\r\n\r\n\r\n\t\treturn $this->db->query($istatistikQ)->row();\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function senet_detay($id)\r\n\r\n\t{\r\n\r\n\t\t// Yetki kontrolü - Senet Yönetimi (ID: 522)\r\n\r\n\t\tif (!grup_modul_yetkisi_var(522)) {\r\n\r\n\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Senet Yönetimi (ID: 522)', 403);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Senet Detayı\";\r\n\r\n\t\t\r\n\r\n\t\t// Debug bilgisi ekle\r\n\r\n\t\t$data[\"debug_info\"] = \"<!-- DEBUG: Senet ID: $id -->\";\r\n\r\n\t\t\r\n\r\n\t\t// Ana hesap kısıtlaması kaldırıldı - tüm senetleri göster\r\n\r\n\t\t$senetQ = \"SELECT s.*, \r\n\r\n\t\t\t\t   COALESCE(CONCAT(c.cari_ad, ' ', c.cari_soyad), c.cari_ad, 'Bilinmiyor') as cari_ad,\r\n\r\n\t\t\t\t   c.cari_firmaTelefon as cari_telefon\r\n\r\n\t\t\t\t   FROM senet s\r\n\r\n\t\t\t\t   LEFT JOIN cari c ON s.senet_cariID = c.cari_id\r\n\r\n\t\t\t\t   WHERE s.senet_id = '$id'\";\r\n\r\n\t\t\r\n\r\n\t\t$data[\"senet\"] = $this->db->query($senetQ)->row();\r\n\r\n\t\t\r\n\r\n\t\tif (!$data[\"senet\"]) {\r\n\r\n\t\t\t// Debug: Senet bulunamadı bilgisi\r\n\r\n\t\t\t$data[\"error_message\"] = \"Senet bulunamadı (ID: $id)\";\r\n\r\n\t\t\t$this->load->view(\"hata\", $data);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Senet hareketleri - ana hesap kısıtlaması kaldırıldı\r\n\r\n\t\t$hareketlerQ = \"SELECT sh.*, \r\n\r\n\t\t\t\t\t\tskt.skt_adi as konum_adi,\r\n\r\n\t\t\t\t\t\tskt.skt_renk as kt_renk,\r\n\r\n\t\t\t\t\t\tskt.skt_ikon as kt_ikon,\r\n\r\n\t\t\t\t\t\tb.banka_bankaAd as banka_ad,\r\n\r\n\t\t\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as islem_yapan\r\n\r\n\t\t\t\t\t\tFROM senet_hareketleri sh\r\n\r\n\t\t\t\t\t\tLEFT JOIN senet_konum_tipleri skt ON sh.sh_konum_tip_id = skt.skt_id\r\n\r\n\t\t\t\t\t\tLEFT JOIN banka b ON sh.sh_banka_id = b.banka_id\r\n\r\n\t\t\t\t\t\tLEFT JOIN kullanicilar k ON sh.sh_kullanici_id = k.kullanici_id\r\n\r\n\t\t\t\t\t\tWHERE sh.sh_senet_id = '$id'\r\n\r\n\t\t\t\t\t\tORDER BY sh.sh_tarih DESC, sh.sh_id DESC\";\r\n\r\n\t\t\r\n\r\n\t\t$data[\"hareketler\"] = $this->db->query($hareketlerQ)->result();\r\n\r\n\t\t\r\n\r\n\t\t// Konum tipleri ve bankalar bilgilerini de ekleyelim\r\n\r\n\t\t$data[\"konum_tipleri\"] = $this->db->query(\"SELECT * FROM senet_konum_tipleri ORDER BY skt_adi\")->result();\r\n\r\n\t\t$data[\"bankalar\"] = $this->db->query(\"SELECT * FROM banka ORDER BY banka_bankaAd\")->result();\r\n\r\n\t\t\r\n\r\n\t\t$this->load->view(\"muhasebe/senet-detay\", $data);\r\n\r\n\t}\r\n\r\n\r\n\r\n\tpublic function senet_konum_degistir()\r\n\r\n\t{\r\n\r\n\t\t// Session kontrolü\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// POST verilerini al\r\n\r\n\t\t$senet_id = $this->input->post('senet_id');\r\n\r\n\t\t$yeni_konum = $this->input->post('yeni_konum');\r\n\r\n\t\t$banka_id = $this->input->post('banka_id');\r\n\r\n\t\t$aciklama = $this->input->post('aciklama');\r\n\r\n\r\n\r\n\t\t// Veri doğrulama\r\n\r\n\t\tif (!$senet_id || !$yeni_konum) {\r\n\r\n\t\t\t$this->session->set_flashdata('hata', 'Gerekli alanlar eksik!');\r\n\r\n\t\t\tredirect('muhasebe/senet-detay/' . $senet_id);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Senet varlığını kontrol et\r\n\r\n\t\t$senet = $this->db->query(\"SELECT * FROM senet WHERE senet_id = '$senet_id'\")->row();\r\n\r\n\t\tif (!$senet) {\r\n\r\n\t\t\t$this->session->set_flashdata('hata', 'Senet bulunamadı!');\r\n\r\n\t\t\tredirect('muhasebe/senet-yonetim');\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Yeni hareket kaydı ekle\r\n\r\n\t\t$hareket_data = array(\r\n\r\n\t\t\t'sh_senet_id' => $senet_id,\r\n\r\n\t\t\t'sh_konum_tip_id' => $yeni_konum,\r\n\r\n\t\t\t'sh_banka_id' => $banka_id ? $banka_id : null,\r\n\r\n\t\t\t'sh_kullanici_id' => $control->kullanici_id,\r\n\r\n\t\t\t'sh_tarih' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t'sh_not' => $aciklama ? $aciklama : 'Konum değiştirildi'\r\n\r\n\t\t);\r\n\r\n\r\n\r\n\t\ttry {\r\n\r\n\t\t\t$this->db->insert('senet_hareketleri', $hareket_data);\r\n\r\n\t\t\t$this->session->set_flashdata('basarili', 'Senet konumu başarıyla değiştirildi!');\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$this->session->set_flashdata('hata', 'Konum değiştirme işlemi başarısız: ' . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\t// Detay sayfasına geri dön\r\n\r\n\t\tredirect('muhasebe/senet-detay/' . $senet_id);\r\n\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\r\n\t * Çek tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeCekler()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan çekleri bul\r\n\r\n\t\t\t$ceklerQ = \"SELECT c.cek_id \r\n\r\n\t\t\t\t\t\tFROM cek c \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = c.cek_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$cekler = $this->db->query($ceklerQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her çek için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($cekler as $cek) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 2, // 2 = Çek\r\n\r\n\t\t\t\t\t'kayit_id' => $cek->cek_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Çek tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($cekler) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($cekler) . \" çek kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Çek senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Banka hareketleri tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeBankaHareketleri()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan banka hareketlerini bul (sadece giriş hareketleri - tahsilat)\r\n\r\n\t\t\t$bankaHareketleriQ = \"SELECT bh.bh_id \r\n\r\n\t\t\t\t\t\tFROM bankaHareketleri bh \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL AND bh.bh_giris > 0\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$bankaHareketleri = $this->db->query($bankaHareketleriQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her banka hareketi için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($bankaHareketleri as $hareket) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 1, // 1 = Banka\r\n\r\n\t\t\t\t\t'kayit_id' => $hareket->bh_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Banka hareketleri tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($bankaHareketleri) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($bankaHareketleri) . \" banka hareketi kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Banka hareketleri senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Kasa hareketleri tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t * Açılış bakiyesi kayıtları hariç tutulur\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeKasaHareketleri()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan kasa hareketlerini bul (sadece giriş hareketleri - tahsilat)\r\n\r\n\t\t\t// Açılış bakiyesi kayıtlarını hariç tut\r\n\r\n\t\t\t$kasaHareketleriQ = \"SELECT kh.kh_id \r\n\r\n\t\t\t\t\t\tFROM kasaHareketleri kh \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL \r\n\r\n\t\t\t\t\t\tAND kh.kh_giris > 0 \r\n\r\n\t\t\t\t\t\tAND (kh.kh_aciklama IS NULL OR kh.kh_aciklama NOT LIKE '%Açılış Bakiyesi%')\r\n\r\n\t\t\t\t\t\tAND (kh.kh_aciklama IS NULL OR kh.kh_aciklama NOT LIKE '%Otomatik Oluşturulan%')\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$kasaHareketleri = $this->db->query($kasaHareketleriQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her kasa hareketi için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($kasaHareketleri as $hareket) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 3, // 3 = Kasa\r\n\r\n\t\t\t\t\t'kayit_id' => $hareket->kh_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Kasa hareketleri tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($kasaHareketleri) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($kasaHareketleri) . \" kasa hareketi kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Kasa hareketleri senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\t/**\r\n\r\n\t * Senet tablosundaki kayıtları muhasebe_tahsilat_durum tablosuna senkronize et\r\n\r\n\t */\r\n\r\n\tprivate function senkronizeSenetler()\r\n\r\n\t{\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Muhasebe tablosunda olmayan senetleri bul\r\n\r\n\t\t\t$senetlerQ = \"SELECT s.senet_id \r\n\r\n\t\t\t\t\t\tFROM senet s \r\n\r\n\t\t\t\t\t\tLEFT JOIN muhasebe_tahsilat_durum mtd ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = s.senet_id \r\n\r\n\t\t\t\t\t\tWHERE mtd.id IS NULL\";\r\n\r\n\t\t\t\r\n\r\n\t\t\t$senetler = $this->db->query($senetlerQ)->result();\r\n\r\n\t\t\t\r\n\r\n\t\t\t// Her senet için muhasebe tablosuna kayıt ekle\r\n\r\n\t\t\tforeach($senetler as $senet) {\r\n\r\n\t\t\t\t$data = array(\r\n\r\n\t\t\t\t\t'tahsilat_tipi' => 4, // 4 = Senet\r\n\r\n\t\t\t\t\t'kayit_id' => $senet->senet_id,\r\n\r\n\t\t\t\t\t'durum' => 1, // 1 = Onay bekliyor\r\n\r\n\t\t\t\t\t'olusturma_tarihi' => date('Y-m-d H:i:s'),\r\n\r\n\t\t\t\t\t'aciklama' => 'Senet tablosundan otomatik senkronize edildi'\r\n\r\n\t\t\t\t);\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t$this->db->insert('muhasebe_tahsilat_durum', $data);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t\tif(count($senetler) > 0) {\r\n\r\n\t\t\t\terror_log(\"Muhasebe senkronizasyonu: \" . count($senetler) . \" senet kaydı eklendi.\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\terror_log(\"Senet senkronizasyonu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\r\n\tpublic function musteriListesi()\r\n\r\n\t{\r\n\r\n\t\t// Memory limit artır (performans için)\r\n\r\n\t\tini_set('memory_limit', '512M');\r\n\r\n\t\tini_set('max_execution_time', 600);\r\n\r\n\t\t\r\n\r\n\t\t$data[\"baslik\"] = \"Muhasebe / Müşteri Listesi\";\r\n\r\n\t\t$anaHesap = anaHesapBilgisi();\r\n\r\n\t\t\r\n\r\n\t\t// Giriş yapan kullanıcı bilgisi\r\n\r\n\t\t$control = session(\"r\", \"login_info\");\r\n\r\n\t\tif (!$control || !isset($control->kullanici_id)) {\r\n\r\n\t\t\tredirect(base_url('check'));\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t$u_id = $control->kullanici_id;\r\n\r\n\t\t\r\n\r\n\t\t// Yetki kontrolü - Müşteri Listesi (ID: 530)\r\n\r\n\t\tif (!grup_modul_yetkisi_var(530)) {\r\n\r\n\t\t\tshow_error('Bu sayfaya erişim yetkiniz bulunmamaktadır. Gerekli yetki: Müşteri Listesi (ID: 530)', 403);\r\n\r\n\t\t\treturn;\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Database kütüphanesini yükle\r\n\r\n\t\t$this->load->database();\r\n\r\n\t\t\r\n\r\n\t\t// Cari tablosunun varlığını kontrol et - basit\r\n\r\n\t\t$data[\"musteriler\"] = array();\r\n\r\n\t\t$data[\"toplam_musteri\"] = 0;\r\n\r\n\t\t\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Basit sorgu - tüm cari kayıtlarını getir\r\n\r\n\t\t\t$musteriler = $this->vt->multiple(\"cari\", array(), \"cari_olusturmaTarihi\", \"DESC\");\r\n\r\n\t\t\tif ($musteriler && is_array($musteriler)) {\r\n\r\n\t\t\t\t$data[\"musteriler\"] = $musteriler;\r\n\r\n\t\t\t\t$data[\"toplam_musteri\"] = count($musteriler);\r\n\r\n\t\t\t}\r\n\r\n\t\t} catch (Exception $e) {\r\n\r\n\t\t\t$data[\"error_message\"] = \"Veritabanı hatası: \" . $e->getMessage();\r\n\r\n\t\t\terror_log(\"Muhasebe müşteri listesi sorgu hatası: \" . $e->getMessage());\r\n\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t// Aktif müşteri sayısı hesapla\r\n\r\n\t\t$aktif_musteri = 0;\r\n\r\n\t\tif (!empty($data[\"musteriler\"])) {\r\n\r\n\t\t\tforeach($data[\"musteriler\"] as $musteri) {\r\n\r\n\t\t\t\tif(isset($musteri->cari_durum) && $musteri->cari_durum == 1) {\r\n\r\n\t\t\t\t\t$aktif_musteri++;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$data[\"aktif_musteri\"] = $aktif_musteri;\r\n\r\n\t\t$data[\"pasif_musteri\"] = $data[\"toplam_musteri\"] - $aktif_musteri;\r\n\r\n\t\t\r\n\r\n\t\t// View yükle\r\n\r\n\t\t$this->load->view(\"muhasebe/musteri-listesi\", $data);\r\n\r\n\t}\r\n\t\r\n\t/**\r\n\t * Tam Ana Rapor - ID: 531\r\n\t */\r\n\tpublic function tam_ana_rapor()\r\n\t{\r\n\t\t// Memory limit artır (performans için)\r\n\t\tini_set('memory_limit', '512M');\r\n\t\tini_set('max_execution_time', 600);\r\n\t\t\r\n\t\t// Yetki kontrolü\r\n\t\t$control2 = session(\"r\", \"login\");\r\n\t\tif (!grup_modul_yetkisi_var(531)) {\r\n\t\t\tredirect(base_url(\"illegal\"));\r\n\t\t}\r\n\t\t\r\n\t\t$data = [];\r\n\t\t\r\n\t\ttry {\r\n\t\t// Tam Ana Rapor sorgusu\r\n\t\t$query = \"\r\n\t\t\tSELECT DISTINCT\r\n\t\t\t\tc.cari_id,\r\n\t\t\t\tc.cari_ad,\r\n\t\t\t\tc.cari_soyad,\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n\t\t\t\t\tTHEN c.cari_ad \r\n\t\t\t\t\tELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n\t\t\t\tEND as cari_isletme,\r\n\t\t\t\t\r\n\t\t\t\tNULL as satis_sozlesme_id,\r\n\t\t\t\tNULL as satis_sozlesme_tutar,\r\n\t\t\t\tNULL as satis_sozlesme_tutar_kdv_dahil,\r\n\t\t\t\tNULL as satis_sozlesme_hizmeti,\r\n\t\t\t\t\r\n\t\t\t\tNULL as evrak_gorselleri,\r\n\t\t\t\tNULL as sozlesme_gorselleri,\r\n\t\t\t\tNULL as tahsilat_gorselleri,\r\n\t\t\t\t\r\n\t\t\t\tSUM(CASE \r\n\t\t\t\t\tWHEN mtd.durum = 2 THEN \r\n\t\t\t\t\t\tCASE \r\n\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 1 THEN bh.bh_giris\r\n\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 2 THEN cek.cek_tutar\r\n\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 3 THEN kh.kh_giris\r\n\t\t\t\t\t\t\tWHEN mtd.tahsilat_tipi = 4 THEN senet.senet_tutar\r\n\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND) as tahsilat_tutar,\r\n\t\t\t\t\r\n\t\t\t\tCASE \r\n\t\t\t\t\tWHEN COUNT(mtd.id) = 0 THEN 'Tahsilat Yok'\r\n\t\t\t\t\tWHEN SUM(CASE WHEN mtd.durum = 1 THEN 1 ELSE 0 END) > 0 THEN 'Onay Bekliyor'\r\n\t\t\t\t\tWHEN SUM(CASE WHEN mtd.durum = 2 THEN 1 ELSE 0 END) = COUNT(mtd.id) THEN 'Onaylandi'\r\n\t\t\t\t\tWHEN SUM(CASE WHEN mtd.durum = 3 THEN 1 ELSE 0 END) > 0 THEN 'Reddedilen Var'\r\n\t\t\t\t\tELSE 'Karisik'\r\n\t\t\t\tEND as tahsilat_durum,\r\n\t\t\t\t\r\n\t\t\t\ta.aktivasyon_tarihi,\r\n\t\t\t\t\r\n\t\t\t\tCONCAT(k.kullanici_ad, ' ', k.kullanici_soyad) as personel\r\n\t\t\t\t\r\n\t\t\tFROM cari c\r\n\t\t\t\r\n\t\t\tLEFT JOIN (\r\n\t\t\t\tSELECT DISTINCT bh.bh_cariID as cari_id, mtd.*\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n\t\t\t\tINNER JOIN bankahareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT DISTINCT kh.kh_cariID as cari_id, mtd.*\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n\t\t\t\tINNER JOIN kasahareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT DISTINCT cek.cek_cariID as cari_id, mtd.*\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n\t\t\t\tINNER JOIN cek ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = cek.cek_id\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT DISTINCT senet.senet_cariID as cari_id, mtd.*\r\n\t\t\t\tFROM muhasebe_tahsilat_durum mtd \r\n\t\t\t\tINNER JOIN senet ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = senet.senet_id\r\n\t\t\t) mtd ON c.cari_id = mtd.cari_id\r\n\t\t\t\r\n\t\t\tLEFT JOIN bankahareketleri bh ON mtd.tahsilat_tipi = 1 AND mtd.kayit_id = bh.bh_id\r\n\t\t\tLEFT JOIN cek ON mtd.tahsilat_tipi = 2 AND mtd.kayit_id = cek.cek_id\r\n\t\t\tLEFT JOIN kasahareketleri kh ON mtd.tahsilat_tipi = 3 AND mtd.kayit_id = kh.kh_id\r\n\t\t\tLEFT JOIN senet ON mtd.tahsilat_tipi = 4 AND mtd.kayit_id = senet.senet_id\r\n\t\t\tLEFT JOIN aktivasyon a ON c.cari_id = a.aktivasyon_cari_id\r\n\t\t\tLEFT JOIN kullanicilar k ON c.cari_olusturan = k.kullanici_id\r\n\t\t\t\r\n\t\t\tWHERE c.cari_durum = 1\r\n\t\t\tGROUP BY c.cari_id, a.aktivasyon_id\r\n\t\t\tORDER BY c.cari_ad, c.cari_soyad\r\n\t\t\";\r\n\t\t\t\r\n\t\t\t$data[\"rapor_verileri\"] = $this->db->query($query)->result();\r\n\t\t\t\r\n\t\t\t// İstatistikler\r\n\t\t\t$data[\"toplam_kayit\"] = count($data[\"rapor_verileri\"]);\r\n\t\t\t\r\n\t\t\t$toplam_satis_tutar = 0;\r\n\t\t\t$toplam_tahsilat_tutar = 0;\r\n\t\t\t$onaylanan_sayisi = 0;\r\n\t\t\t$onay_bekleyen_sayisi = 0;\r\n\t\t\t\r\n\t\t\tforeach($data[\"rapor_verileri\"] as $veri) {\r\n\t\t\t\tif($veri->satis_sozlesme_tutar_kdv_dahil) {\r\n\t\t\t\t\t$toplam_satis_tutar += $veri->satis_sozlesme_tutar_kdv_dahil;\r\n\t\t\t\t}\r\n\t\t\t\tif($veri->tahsilat_tutar) {\r\n\t\t\t\t\t$toplam_tahsilat_tutar += $veri->tahsilat_tutar;\r\n\t\t\t\t}\r\n\t\t\t\tif($veri->tahsilat_durum == 'Onaylandı') {\r\n\t\t\t\t\t$onaylanan_sayisi++;\r\n\t\t\t\t}\r\n\t\t\t\tif($veri->tahsilat_durum == 'Onay Bekliyor') {\r\n\t\t\t\t\t$onay_bekleyen_sayisi++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$data[\"toplam_satis_tutar\"] = $toplam_satis_tutar;\r\n\t\t\t$data[\"toplam_tahsilat_tutar\"] = $toplam_tahsilat_tutar;\r\n\t\t\t$data[\"onaylanan_sayisi\"] = $onaylanan_sayisi;\r\n\t\t\t$data[\"onay_bekleyen_sayisi\"] = $onay_bekleyen_sayisi;\r\n\t\t\t\r\n\t\t} catch (Exception $e) {\r\n\t\t\t$data[\"error_message\"] = \"Veri yuklenirken bir hata olustu: \" . $e->getMessage();\r\n\t\t\t$data[\"rapor_verileri\"] = [];\r\n\t\t}\r\n\t\t\r\n\t\t// View yukle\r\n\t\t$this->load->view(\"muhasebe/tam-ana-rapor\", $data);\r\n\t}\r\n\t\r\n}\r\n\u0000\r\n\u0000"
        }
    ]
}