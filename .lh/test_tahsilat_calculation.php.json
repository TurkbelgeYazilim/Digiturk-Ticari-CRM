{
    "sourceFile": "test_tahsilat_calculation.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756197026859,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756197026859,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Test script for new tahsilat calculation method\r\n * This script verifies that the new calculation method works correctly\r\n */\r\n\r\n// Database connection\r\n$hostname = 'localhost';\r\n$username = 'ilekasoft_crmuser'; \r\n$password = 'KaleW356!';\r\n$database = 'ilekasoft_crmdb';\r\n\r\ntry {\r\n    $mysqli = new mysqli($hostname, $username, $password, $database);\r\n    \r\n    if ($mysqli->connect_error) {\r\n        die('Connection failed: ' . $mysqli->connect_error);\r\n    }\r\n    \r\n    echo \"<h2>Tahsilat Calculation Test - Test CariID: 19871</h2>\";\r\n    \r\n    $test_cari_id = 19871;\r\n    \r\n    // Test individual queries as specified in the request\r\n    echo \"<h3>Individual Queries:</h3>\";\r\n    \r\n    // Banka/Pos\r\n    $banka_query = \"SELECT SUM(bh_giris) as total FROM bankahareketleri WHERE bh_cariID = ?\";\r\n    $stmt = $mysqli->prepare($banka_query);\r\n    $stmt->bind_param(\"i\", $test_cari_id);\r\n    $stmt->execute();\r\n    $banka_result = $stmt->get_result()->fetch_assoc();\r\n    echo \"<strong>Banka/Pos:</strong> \" . ($banka_result['total'] ?: 0) . \" TL<br>\";\r\n    \r\n    // Çek \r\n    $cek_query = \"SELECT SUM(cek_tutar) as total FROM cek WHERE cek_cariID = ?\";\r\n    $stmt = $mysqli->prepare($cek_query);\r\n    $stmt->bind_param(\"i\", $test_cari_id);\r\n    $stmt->execute();\r\n    $cek_result = $stmt->get_result()->fetch_assoc();\r\n    echo \"<strong>Çek:</strong> \" . ($cek_result['total'] ?: 0) . \" TL<br>\";\r\n    \r\n    // Kasa/Nakit\r\n    $kasa_query = \"SELECT SUM(kh_giris) as total FROM kasahareketleri WHERE kh_cariID = ?\";\r\n    $stmt = $mysqli->prepare($kasa_query);\r\n    $stmt->bind_param(\"i\", $test_cari_id);\r\n    $stmt->execute();\r\n    $kasa_result = $stmt->get_result()->fetch_assoc();\r\n    echo \"<strong>Kasa/Nakit:</strong> \" . ($kasa_result['total'] ?: 0) . \" TL<br>\";\r\n    \r\n    // Senet\r\n    $senet_query = \"SELECT SUM(senet_tutar) as total FROM senet WHERE senet_cariID = ?\";\r\n    $stmt = $mysqli->prepare($senet_query);\r\n    $stmt->bind_param(\"i\", $test_cari_id);\r\n    $stmt->execute();\r\n    $senet_result = $stmt->get_result()->fetch_assoc();\r\n    echo \"<strong>Senet:</strong> \" . ($senet_result['total'] ?: 0) . \" TL<br>\";\r\n    \r\n    // Combined total\r\n    $total_new_method = ($banka_result['total'] ?: 0) + \r\n                       ($cek_result['total'] ?: 0) + \r\n                       ($kasa_result['total'] ?: 0) + \r\n                       ($senet_result['total'] ?: 0);\r\n    echo \"<strong>New Method Total:</strong> \" . $total_new_method . \" TL<br>\";\r\n    \r\n    echo \"<h3>Old Method (carihareketleri) for comparison:</h3>\";\r\n    \r\n    // Old method \r\n    $old_query = \"SELECT SUM(ch_alacak) as total FROM carihareketleri WHERE ch_cariID = ? AND ch_alacak IS NOT NULL AND ch_alacak > 0\";\r\n    $stmt = $mysqli->prepare($old_query);\r\n    $stmt->bind_param(\"i\", $test_cari_id);\r\n    $stmt->execute();\r\n    $old_result = $stmt->get_result()->fetch_assoc();\r\n    echo \"<strong>Old Method Total:</strong> \" . ($old_result['total'] ?: 0) . \" TL<br>\";\r\n    \r\n    echo \"<h3>New getTahsilatDetay Query Test:</h3>\";\r\n    \r\n    // Test the new getTahsilatDetay query\r\n    $detail_query = \"\r\n        -- Banka/Pos tahsilatları\r\n        SELECT \r\n            CONCAT('bh_', bh.bh_id) as unique_id,\r\n            bh.bh_id as source_id,\r\n            'Banka/Pos' as tahsilat_tipi,\r\n            bh.bh_tarih as tarih,\r\n            bh.bh_belgeNumarasi as belge_no,\r\n            bh.bh_giris as tutar,\r\n            bh.bh_aciklama as aciklama,\r\n            b.banka_adi as detay,\r\n            '1' as tip_kod\r\n        FROM bankahareketleri bh\r\n        LEFT JOIN banka b ON bh.bh_bankaID = b.banka_id\r\n        WHERE bh.bh_cariID = ? AND bh.bh_giris > 0\r\n        \r\n        UNION ALL\r\n        \r\n        -- Çek tahsilatları  \r\n        SELECT \r\n            CONCAT('cek_', c.cek_id) as unique_id,\r\n            c.cek_id as source_id,\r\n            'Çek' as tahsilat_tipi,\r\n            c.cek_vade_tarihi as tarih,\r\n            c.cek_numara as belge_no,\r\n            c.cek_tutar as tutar,\r\n            c.cek_aciklama as aciklama,\r\n            CONCAT(c.cek_banka_adi, ' - ', c.cek_numara) as detay,\r\n            '2' as tip_kod\r\n        FROM cek c\r\n        WHERE c.cek_cariID = ? AND c.cek_tutar > 0\r\n        \r\n        UNION ALL\r\n        \r\n        -- Kasa/Nakit tahsilatları\r\n        SELECT \r\n            CONCAT('kh_', kh.kh_id) as unique_id,\r\n            kh.kh_id as source_id,\r\n            'Kasa/Nakit' as tahsilat_tipi,\r\n            kh.kh_tarih as tarih,\r\n            kh.kh_belgeNumarasi as belge_no,\r\n            kh.kh_giris as tutar,\r\n            kh.kh_aciklama as aciklama,\r\n            k.kasa_adi as detay,\r\n            '3' as tip_kod\r\n        FROM kasahareketleri kh\r\n        LEFT JOIN kasa k ON kh.kh_kasaID = k.kasa_id\r\n        WHERE kh.kh_cariID = ? AND kh.kh_giris > 0\r\n        \r\n        UNION ALL\r\n        \r\n        -- Senet tahsilatları\r\n        SELECT \r\n            CONCAT('s_', s.senet_id) as unique_id,\r\n            s.senet_id as source_id,\r\n            'Senet' as tahsilat_tipi,\r\n            s.senet_vade_tarihi as tarih,\r\n            s.senet_numara as belge_no,\r\n            s.senet_tutar as tutar,\r\n            s.senet_aciklama as aciklama,\r\n            CONCAT('Senet No: ', s.senet_numara) as detay,\r\n            '4' as tip_kod\r\n        FROM senet s\r\n        WHERE s.senet_cariID = ? AND s.senet_tutar > 0\r\n        \r\n        ORDER BY tarih DESC\r\n    \";\r\n    \r\n    $stmt = $mysqli->prepare($detail_query);\r\n    $stmt->bind_param(\"iiii\", $test_cari_id, $test_cari_id, $test_cari_id, $test_cari_id);\r\n    $stmt->execute();\r\n    $detail_result = $stmt->get_result();\r\n    \r\n    echo \"<table border='1' style='border-collapse: collapse; width: 100%;'>\";\r\n    echo \"<tr><th>ID</th><th>Tip</th><th>Tarih</th><th>Belge No</th><th>Tutar</th><th>Açıklama</th><th>Detay</th></tr>\";\r\n    \r\n    $detail_total = 0;\r\n    while ($row = $detail_result->fetch_assoc()) {\r\n        $detail_total += $row['tutar'];\r\n        echo \"<tr>\";\r\n        echo \"<td>\" . htmlspecialchars($row['unique_id']) . \"</td>\";\r\n        echo \"<td>\" . htmlspecialchars($row['tahsilat_tipi']) . \"</td>\";\r\n        echo \"<td>\" . htmlspecialchars($row['tarih']) . \"</td>\";\r\n        echo \"<td>\" . htmlspecialchars($row['belge_no'] ?: '-') . \"</td>\";\r\n        echo \"<td>\" . number_format($row['tutar'], 2) . \" TL</td>\";\r\n        echo \"<td>\" . htmlspecialchars($row['aciklama'] ?: '-') . \"</td>\";\r\n        echo \"<td>\" . htmlspecialchars($row['detay'] ?: '-') . \"</td>\";\r\n        echo \"</tr>\";\r\n    }\r\n    \r\n    echo \"</table>\";\r\n    echo \"<p><strong>Detail Query Total: \" . number_format($detail_total, 2) . \" TL</strong></p>\";\r\n    \r\n    // Compare totals\r\n    echo \"<h3>Comparison:</h3>\";\r\n    echo \"New Calculation Method Total: \" . number_format($total_new_method, 2) . \" TL<br>\";\r\n    echo \"Detail Query Total: \" . number_format($detail_total, 2) . \" TL<br>\";\r\n    echo \"Old Method (carihareketleri): \" . number_format($old_result['total'] ?: 0, 2) . \" TL<br>\";\r\n    \r\n    if ($total_new_method == $detail_total) {\r\n        echo \"<p style='color: green;'><strong>✓ SUCCESS: New calculation and detail query totals match!</strong></p>\";\r\n    } else {\r\n        echo \"<p style='color: red;'><strong>✗ WARNING: New calculation and detail query totals do not match!</strong></p>\";\r\n    }\r\n    \r\n    $mysqli->close();\r\n    \r\n} catch (Exception $e) {\r\n    echo \"Error: \" . $e->getMessage();\r\n}\r\n?>\r\n"
        }
    ]
}