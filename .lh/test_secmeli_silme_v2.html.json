{
    "sourceFile": "test_secmeli_silme_v2.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1758628430263,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1758628430263,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\r\n<html lang=\"tr\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Seçmeli Silme Test</title>\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\r\n    <script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\r\n    <script src=\"https://cdn.jsdelivr.net/npm/sweetalert2@11\"></script>\r\n</head>\r\n<body>\r\n    <div class=\"container mt-5\">\r\n        <h2>Seçmeli Silme Test Sayfası</h2>\r\n        <p>Bu sayfa seçmeli silme özelliğini test etmek için hazırlanmıştır.</p>\r\n        \r\n        <div class=\"card\">\r\n            <div class=\"card-body\">\r\n                <h5 class=\"card-title\">Test Cari: TEST TEST (ID: 20436)</h5>\r\n                <p class=\"card-text\">Bu cariye ait <strong>2 adet Satış Faturası</strong> bulunmaktadır.</p>\r\n                \r\n                <div class=\"btn-group\" role=\"group\">\r\n                    <button type=\"button\" class=\"btn btn-outline-primary btn-sm\" \r\n                            onclick=\"secmeliVeriSil('satis_faturalari', 20436, 'Satış Faturaları', 2)\">\r\n                        <i class=\"fa fa-list\"></i> Seçmeli Sil\r\n                    </button>\r\n                    <button type=\"button\" class=\"btn btn-outline-danger btn-sm\" \r\n                            onclick=\"tekVeriSil('satis_faturalari', 20436, 'Satış Faturaları', 2)\">\r\n                        <i class=\"fa fa-trash\"></i> Tümünü Sil\r\n                    </button>\r\n                </div>\r\n                \r\n                <hr>\r\n                \r\n                <h6>Debug İşlemleri:</h6>\r\n                <button type=\"button\" class=\"btn btn-info btn-sm me-2\" onclick=\"testCarilSilKontrol()\">\r\n                    Test Cari Sil Kontrol API\r\n                </button>\r\n                <button type=\"button\" class=\"btn btn-info btn-sm me-2\" onclick=\"testVeriListesiGetir()\">\r\n                    Test Veri Listesi Getir API\r\n                </button>\r\n                \r\n                <div id=\"debugOutput\" class=\"mt-3\"></div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n<script>\r\n// Base URL ayarla\r\nconst BASE_URL = 'https://crm.ilekasoft.com/';\r\n\r\n// Seçmeli veri silme fonksiyonu\r\nfunction secmeliVeriSil(tabloKodu, cariId, tabloAdi, toplamAdet) {\r\n    console.log('Seçmeli veri sil - Cari ID:', cariId, 'Tablo:', tabloKodu);\r\n    \r\n    // Loading göster\r\n    Swal.fire({\r\n        title: 'Yükleniyor...',\r\n        text: `${tabloAdi} verileri getiriliyor...`,\r\n        icon: 'info',\r\n        allowOutsideClick: false,\r\n        allowEscapeKey: false,\r\n        showConfirmButton: false,\r\n        didOpen: () => {\r\n            Swal.showLoading();\r\n        }\r\n    });\r\n    \r\n    // AJAX ile veri listesini getir\r\n    $.ajax({\r\n        url: BASE_URL + 'muhasebe/veri_listesi_getir',\r\n        method: 'POST',\r\n        data: {\r\n            cari_id: cariId,\r\n            tablo_kodu: tabloKodu,\r\n            tablo_adi: tabloAdi\r\n        },\r\n        dataType: 'json',\r\n        success: function(response) {\r\n            console.log('Veri listesi yanıtı:', response);\r\n            \r\n            if (response.status === 'success' && response.data && response.data.length > 0) {\r\n                // Seçim modalı oluştur\r\n                let secimHtml = '<div class=\"text-left\">';\r\n                secimHtml += '<p><strong>Silmek istediğiniz kayıtları seçin:</strong></p>';\r\n                secimHtml += '<div class=\"mb-3\">';\r\n                secimHtml += '<button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"tumunuSec(true)\">Tümünü Seç</button> ';\r\n                secimHtml += '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" onclick=\"tumunuSec(false)\">Tümünü Kaldır</button>';\r\n                secimHtml += '</div>';\r\n                secimHtml += '<div style=\"max-height: 400px; overflow-y: auto;\">';\r\n                secimHtml += '<table class=\"table table-sm table-hover\">';\r\n                secimHtml += '<thead><tr>';\r\n                \r\n                // Tablo başlıklarını oluştur\r\n                if (response.columns && response.columns.length > 0) {\r\n                    secimHtml += '<th width=\"50\"><input type=\"checkbox\" id=\"selectAll\" onchange=\"tumunuSec(this.checked)\"></th>';\r\n                    response.columns.forEach(function(column) {\r\n                        secimHtml += '<th>' + column + '</th>';\r\n                    });\r\n                }\r\n                \r\n                secimHtml += '</tr></thead><tbody>';\r\n                \r\n                // Veri satırlarını oluştur\r\n                response.data.forEach(function(row, index) {\r\n                    secimHtml += '<tr>';\r\n                    secimHtml += '<td><input type=\"checkbox\" class=\"kayit-checkbox\" value=\"' + row.id + '\" data-index=\"' + index + '\"></td>';\r\n                    \r\n                    // Sütun verilerini göster\r\n                    if (response.columns && response.columns.length > 0) {\r\n                        response.columns.forEach(function(column) {\r\n                            let columnKey = column.toLowerCase().replace(' ', '_');\r\n                            let value = row[columnKey] || row[column] || '-';\r\n                            \r\n                            // Tarih formatlaması\r\n                            if (typeof value === 'string' && value.match(/^\\d{4}-\\d{2}-\\d{2}/)) {\r\n                                value = new Date(value).toLocaleDateString('tr-TR');\r\n                            }\r\n                            // Para formatlaması\r\n                            if (column.toLowerCase().includes('tutar') || column.toLowerCase().includes('toplam')) {\r\n                                if (!isNaN(value) && value !== '-') {\r\n                                    value = parseFloat(value).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' ₺';\r\n                                }\r\n                            }\r\n                            secimHtml += '<td>' + value + '</td>';\r\n                        });\r\n                    }\r\n                    \r\n                    secimHtml += '</tr>';\r\n                });\r\n                \r\n                secimHtml += '</tbody></table>';\r\n                secimHtml += '</div>';\r\n                secimHtml += '<div class=\"mt-3 text-muted\">';\r\n                secimHtml += '<small>Toplam ' + response.data.length + ' kayıt bulundu. Seçilen kayıtlar silinecektir.</small>';\r\n                secimHtml += '</div>';\r\n                secimHtml += '</div>';\r\n                \r\n                Swal.fire({\r\n                    title: tabloAdi + ' - Kayıt Seçimi',\r\n                    html: secimHtml,\r\n                    icon: 'question',\r\n                    showCancelButton: true,\r\n                    confirmButtonColor: '#dc3545',\r\n                    cancelButtonColor: '#6c757d',\r\n                    confirmButtonText: '<i class=\"fa fa-trash\"></i> Seçilenleri Sil',\r\n                    cancelButtonText: '<i class=\"fa fa-times\"></i> İptal',\r\n                    customClass: {\r\n                        confirmButton: 'btn btn-danger',\r\n                        cancelButton: 'btn btn-secondary'\r\n                    },\r\n                    buttonsStyling: false,\r\n                    width: '80%',\r\n                    preConfirm: () => {\r\n                        // Seçilen kayıtları al\r\n                        const secilenler = [];\r\n                        $('.kayit-checkbox:checked').each(function() {\r\n                            secilenler.push($(this).val());\r\n                        });\r\n                        \r\n                        if (secilenler.length === 0) {\r\n                            Swal.showValidationMessage('Lütfen en az bir kayıt seçin.');\r\n                            return false;\r\n                        }\r\n                        \r\n                        return secilenler;\r\n                    }\r\n                }).then((result) => {\r\n                    if (result.isConfirmed && result.value) {\r\n                        // Seçilen kayıtları sil\r\n                        seciliKayitlariSil(tabloKodu, cariId, tabloAdi, result.value);\r\n                    }\r\n                });\r\n                \r\n            } else {\r\n                Swal.fire({\r\n                    icon: 'info',\r\n                    title: 'Bilgi',\r\n                    text: response.message || 'Bu veri türünde kayıt bulunamadı.'\r\n                });\r\n            }\r\n        },\r\n        error: function(xhr, status, error) {\r\n            console.error('Veri listesi getirme hatası:', {xhr, status, error, response: xhr.responseText});\r\n            Swal.fire({\r\n                icon: 'error',\r\n                title: 'Hata',\r\n                text: 'Veri listesi getirilirken bir hata oluştu: ' + error\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// Tümünü seç/kaldır fonksiyonu\r\nfunction tumunuSec(secilsin) {\r\n    $('.kayit-checkbox').prop('checked', secilsin);\r\n    $('#selectAll').prop('checked', secilsin);\r\n}\r\n\r\n// Seçili kayıtları sil\r\nfunction seciliKayitlariSil(tabloKodu, cariId, tabloAdi, secilenIdler) {\r\n    console.log('Seçili kayıtları sil - Cari ID:', cariId, 'Tablo:', tabloKodu, 'Seçilen IDler:', secilenIdler);\r\n    \r\n    Swal.fire({\r\n        title: 'Silme Onayı',\r\n        text: `${secilenIdler.length} adet ${tabloAdi} kaydı silinecek. Emin misiniz?`,\r\n        icon: 'warning',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#dc3545',\r\n        cancelButtonColor: '#6c757d',\r\n        confirmButtonText: '<i class=\"fa fa-trash\"></i> Sil',\r\n        cancelButtonText: '<i class=\"fa fa-times\"></i> İptal',\r\n        customClass: {\r\n            confirmButton: 'btn btn-danger',\r\n            cancelButton: 'btn btn-secondary'\r\n        },\r\n        buttonsStyling: false\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            // Loading göster\r\n            Swal.fire({\r\n                title: 'Siliniyor...',\r\n                text: `${secilenIdler.length} kayıt siliniyor...`,\r\n                icon: 'info',\r\n                allowOutsideClick: false,\r\n                allowEscapeKey: false,\r\n                showConfirmButton: false,\r\n                didOpen: () => {\r\n                    Swal.showLoading();\r\n                }\r\n            });\r\n            \r\n            // AJAX ile seçili kayıtları sil\r\n            $.ajax({\r\n                url: BASE_URL + 'muhasebe/secili_kayitlari_sil',\r\n                method: 'POST',\r\n                data: {\r\n                    cari_id: cariId,\r\n                    tablo_kodu: tabloKodu,\r\n                    tablo_adi: tabloAdi,\r\n                    secilen_idler: secilenIdler\r\n                },\r\n                dataType: 'json',\r\n                success: function(response) {\r\n                    if (response.status === 'success') {\r\n                        Swal.fire({\r\n                            icon: 'success',\r\n                            title: 'Başarılı',\r\n                            text: response.message,\r\n                            confirmButtonText: 'Tamam'\r\n                        }).then(() => {\r\n                            // Test sayfası için reload yerine bilgi göster\r\n                            $('#debugOutput').html('<div class=\"alert alert-success\">Silme işlemi başarılı!</div>');\r\n                        });\r\n                    } else {\r\n                        Swal.fire({\r\n                            icon: 'error',\r\n                            title: 'Hata',\r\n                            text: response.message || 'Silme işlemi sırasında bir hata oluştu.'\r\n                        });\r\n                    }\r\n                },\r\n                error: function(xhr, status, error) {\r\n                    console.error('Silme hatası:', {xhr, status, error, response: xhr.responseText});\r\n                    Swal.fire({\r\n                        icon: 'error',\r\n                        title: 'Hata',\r\n                        text: 'Silme işlemi sırasında bir hata oluştu: ' + error\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// Tek veri silme (tümünü sil)\r\nfunction tekVeriSil(tabloKodu, cariId, tabloAdi, toplamAdet) {\r\n    Swal.fire({\r\n        title: 'Tümünü Sil Onayı',\r\n        text: `${toplamAdet} adet ${tabloAdi} kaydının tümü silinecek. Emin misiniz?`,\r\n        icon: 'warning',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#dc3545',\r\n        cancelButtonColor: '#6c757d',\r\n        confirmButtonText: '<i class=\"fa fa-trash\"></i> Tümünü Sil',\r\n        cancelButtonText: '<i class=\"fa fa-times\"></i> İptal'\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            // Bu işlemi şimdilik sadece simüle edelim\r\n            Swal.fire({\r\n                icon: 'info',\r\n                title: 'Simülasyon',\r\n                text: 'Tümünü sil işlemi simüle edildi. Gerçek silme işlemi yapılmadı.'\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// Debug API test fonksiyonları\r\nfunction testCarilSilKontrol() {\r\n    $.ajax({\r\n        url: BASE_URL + 'muhasebe/cari_sil_kontrol',\r\n        method: 'POST',\r\n        data: { cari_id: 20436 },\r\n        dataType: 'json',\r\n        success: function(response) {\r\n            $('#debugOutput').html('<div class=\"alert alert-success\"><strong>Cari Sil Kontrol API Yanıtı:</strong><pre>' + JSON.stringify(response, null, 2) + '</pre></div>');\r\n        },\r\n        error: function(xhr, status, error) {\r\n            $('#debugOutput').html('<div class=\"alert alert-danger\"><strong>Hata:</strong> ' + error + '<br><strong>Yanıt:</strong><pre>' + xhr.responseText + '</pre></div>');\r\n        }\r\n    });\r\n}\r\n\r\nfunction testVeriListesiGetir() {\r\n    $.ajax({\r\n        url: BASE_URL + 'muhasebe/veri_listesi_getir',\r\n        method: 'POST',\r\n        data: {\r\n            cari_id: 20436,\r\n            tablo_kodu: 'satis_faturalari',\r\n            tablo_adi: 'Satış Faturaları'\r\n        },\r\n        dataType: 'json',\r\n        success: function(response) {\r\n            $('#debugOutput').html('<div class=\"alert alert-success\"><strong>Veri Listesi Getir API Yanıtı:</strong><pre>' + JSON.stringify(response, null, 2) + '</pre></div>');\r\n        },\r\n        error: function(xhr, status, error) {\r\n            $('#debugOutput').html('<div class=\"alert alert-danger\"><strong>Hata:</strong> ' + error + '<br><strong>Yanıt:</strong><pre>' + xhr.responseText + '</pre></div>');\r\n        }\r\n    });\r\n}\r\n</script>\r\n\r\n</body>\r\n</html>\r\n"
        }
    ]
}