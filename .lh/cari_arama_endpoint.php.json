{
    "sourceFile": "cari_arama_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756367338188,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756367338188,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Cari Arama Endpoint\r\n * Tam Ana Rapor sayfası için cari arama işlevselliği\r\n */\r\n\r\n// CodeIgniter framework yükle\r\nrequire_once('index.php');\r\n\r\n// Enable error reporting for debugging\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\n// CORS headers\r\nheader('Content-Type: application/json; charset=utf-8');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: GET, POST, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\n// OPTIONS request handling\r\nif ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\ntry {\r\n    // Get CodeIgniter instance\r\n    $CI =& get_instance();\r\n    $CI->load->database();\r\n\r\n    // Get search term\r\n    $search_term = isset($_GET['term']) ? trim($_GET['term']) : '';\r\n    $search_term = isset($_POST['term']) ? trim($_POST['term']) : $search_term;\r\n\r\n    if (empty($search_term)) {\r\n        echo json_encode([\r\n            'success' => false,\r\n            'message' => 'Arama terimi gerekli'\r\n        ]);\r\n        exit;\r\n    }\r\n\r\n    // Minimum 2 karakter kontrolü\r\n    if (strlen($search_term) < 2) {\r\n        echo json_encode([\r\n            'success' => false,\r\n            'message' => 'En az 2 karakter gerekli'\r\n        ]);\r\n        exit;\r\n    }\r\n\r\n    // SQL injection koruması\r\n    $search_term_escaped = $CI->db->escape_like_str($search_term);\r\n\r\n    // Cari arama sorgusu - belirtilen alanlarında arama yap\r\n    $query = \"\r\n        SELECT DISTINCT\r\n            c.cari_id,\r\n            c.cari_ad,\r\n            c.cari_soyad,\r\n            c.cari_vergiNumarasi,\r\n            c.cari_firmaTelefon,\r\n            c.cari_tckn,\r\n            CASE \r\n                WHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n                THEN c.cari_ad \r\n                ELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n            END as label,\r\n            CASE \r\n                WHEN c.cari_bireysel = 0 OR c.cari_soyad IS NULL OR c.cari_soyad = '' \r\n                THEN c.cari_ad \r\n                ELSE CONCAT(c.cari_ad, ' ', c.cari_soyad)\r\n            END as value\r\n        FROM cari c\r\n        WHERE c.cari_durum = 1 \r\n        AND (\r\n            c.cari_ad LIKE '%{$search_term_escaped}%' OR \r\n            c.cari_soyad LIKE '%{$search_term_escaped}%' OR \r\n            c.cari_vergiNumarasi LIKE '%{$search_term_escaped}%' OR \r\n            c.cari_firmaTelefon LIKE '%{$search_term_escaped}%' OR \r\n            c.cari_tckn LIKE '%{$search_term_escaped}%'\r\n        )\r\n        ORDER BY \r\n            CASE \r\n                WHEN c.cari_ad LIKE '{$search_term_escaped}%' THEN 1\r\n                WHEN c.cari_soyad LIKE '{$search_term_escaped}%' THEN 2\r\n                ELSE 3\r\n            END,\r\n            c.cari_ad, c.cari_soyad\r\n        LIMIT 20\r\n    \";\r\n\r\n    $results = $CI->db->query($query)->result();\r\n\r\n    // Sonuçları formatla\r\n    $formatted_results = [];\r\n    foreach ($results as $row) {\r\n        $detail_info = [];\r\n        \r\n        if (!empty($row->cari_vergiNumarasi)) {\r\n            $detail_info[] = \"VN: \" . $row->cari_vergiNumarasi;\r\n        }\r\n        \r\n        if (!empty($row->cari_tckn)) {\r\n            $detail_info[] = \"TC: \" . $row->cari_tckn;\r\n        }\r\n        \r\n        if (!empty($row->cari_firmaTelefon)) {\r\n            $detail_info[] = \"Tel: \" . $row->cari_firmaTelefon;\r\n        }\r\n        \r\n        $detail_text = !empty($detail_info) ? \" (\" . implode(\", \", $detail_info) . \")\" : \"\";\r\n        \r\n        $formatted_results[] = [\r\n            'id' => $row->cari_id,\r\n            'label' => $row->label . $detail_text,\r\n            'value' => $row->value,\r\n            'cari_ad' => $row->cari_ad,\r\n            'cari_soyad' => $row->cari_soyad,\r\n            'cari_vergiNumarasi' => $row->cari_vergiNumarasi,\r\n            'cari_firmaTelefon' => $row->cari_firmaTelefon,\r\n            'cari_tckn' => $row->cari_tckn\r\n        ];\r\n    }\r\n\r\n    // JSON response\r\n    echo json_encode($formatted_results);\r\n\r\n} catch (Exception $e) {\r\n    // Error handling\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Arama sırasında hata oluştu: ' . $e->getMessage(),\r\n        'error' => $e->getMessage()\r\n    ]);\r\n}\r\n?>\r\n"
        }
    ]
}