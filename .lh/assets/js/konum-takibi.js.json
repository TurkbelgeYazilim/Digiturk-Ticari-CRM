{
    "sourceFile": "assets/js/konum-takibi.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756311206820,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756311206820,
            "name": "Commit-0",
            "content": "/**\r\n * Kullanıcı Konum Takibi JavaScript Modülü\r\n * Login olan kullanıcıların konum bilgilerini takip eder\r\n */\r\n\r\nclass KullaniciKonumTakibi {\r\n    constructor() {\r\n        this.watchId = null;\r\n        this.lastPosition = null;\r\n        this.isTracking = false;\r\n        this.updateInterval = 5 * 60 * 1000; // 5 dakika\r\n        this.maxAccuracy = 1000; // 1000 metre\r\n        this.init();\r\n    }\r\n\r\n    init() {\r\n        // Sayfa yüklendiğinde konum izinlerini kontrol et\r\n        this.checkGeolocationSupport();\r\n        \r\n        // Login olduğunda konum al\r\n        this.getCurrentLocation();\r\n        \r\n        // Periyodik konum güncellemeleri başlat\r\n        this.startPeriodicTracking();\r\n        \r\n        // Sayfa kapatılırken konum takibini durdur\r\n        window.addEventListener('beforeunload', () => {\r\n            this.stopTracking();\r\n        });\r\n    }\r\n\r\n    checkGeolocationSupport() {\r\n        if (!navigator.geolocation) {\r\n            console.warn('Bu tarayıcı geolocation desteklemiyor');\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    getCurrentLocation() {\r\n        if (!this.checkGeolocationSupport()) return;\r\n\r\n        const options = {\r\n            enableHighAccuracy: true,\r\n            timeout: 10000,\r\n            maximumAge: 60000 // 1 dakika\r\n        };\r\n\r\n        navigator.geolocation.getCurrentPosition(\r\n            (position) => this.onLocationSuccess(position),\r\n            (error) => this.onLocationError(error),\r\n            options\r\n        );\r\n    }\r\n\r\n    startContinuousTracking() {\r\n        if (!this.checkGeolocationSupport() || this.isTracking) return;\r\n\r\n        const options = {\r\n            enableHighAccuracy: true,\r\n            timeout: 15000,\r\n            maximumAge: 30000\r\n        };\r\n\r\n        this.watchId = navigator.geolocation.watchPosition(\r\n            (position) => this.onLocationSuccess(position),\r\n            (error) => this.onLocationError(error),\r\n            options\r\n        );\r\n\r\n        this.isTracking = true;\r\n        console.log('Konum takibi başlatıldı');\r\n    }\r\n\r\n    startPeriodicTracking() {\r\n        // Her 5 dakikada bir konum güncelle\r\n        setInterval(() => {\r\n            this.getCurrentLocation();\r\n        }, this.updateInterval);\r\n    }\r\n\r\n    stopTracking() {\r\n        if (this.watchId !== null) {\r\n            navigator.geolocation.clearWatch(this.watchId);\r\n            this.watchId = null;\r\n        }\r\n        this.isTracking = false;\r\n        console.log('Konum takibi durduruldu');\r\n    }\r\n\r\n    onLocationSuccess(position) {\r\n        const coords = position.coords;\r\n        \r\n        // Konum doğruluğunu kontrol et\r\n        if (coords.accuracy > this.maxAccuracy) {\r\n            console.warn('Konum doğruluğu düşük:', coords.accuracy, 'metre');\r\n        }\r\n\r\n        const locationData = {\r\n            latitude: coords.latitude,\r\n            longitude: coords.longitude,\r\n            accuracy: coords.accuracy,\r\n            timestamp: new Date().toISOString(),\r\n            speed: coords.speed || null,\r\n            heading: coords.heading || null\r\n        };\r\n\r\n        // Konum değişti mi kontrol et\r\n        if (this.hasLocationChanged(locationData)) {\r\n            this.sendLocationToServer(locationData);\r\n            this.lastPosition = locationData;\r\n        }\r\n    }\r\n\r\n    onLocationError(error) {\r\n        let message = '';\r\n        switch(error.code) {\r\n            case error.PERMISSION_DENIED:\r\n                message = 'Konum izni reddedildi';\r\n                break;\r\n            case error.POSITION_UNAVAILABLE:\r\n                message = 'Konum bilgisi alınamadı';\r\n                break;\r\n            case error.TIMEOUT:\r\n                message = 'Konum alma zaman aşımına uğradı';\r\n                break;\r\n            default:\r\n                message = 'Bilinmeyen konum hatası';\r\n                break;\r\n        }\r\n        \r\n        console.error('Konum hatası:', message);\r\n        \r\n        // Hata durumunda sunucuya bildir (isteğe bağlı)\r\n        this.sendErrorToServer({\r\n            error_code: error.code,\r\n            error_message: message,\r\n            timestamp: new Date().toISOString()\r\n        });\r\n    }\r\n\r\n    hasLocationChanged(newLocation) {\r\n        if (!this.lastPosition) return true;\r\n\r\n        const distance = this.calculateDistance(\r\n            this.lastPosition.latitude,\r\n            this.lastPosition.longitude,\r\n            newLocation.latitude,\r\n            newLocation.longitude\r\n        );\r\n\r\n        // 50 metreden fazla değişiklik varsa güncelle\r\n        return distance > 50;\r\n    }\r\n\r\n    calculateDistance(lat1, lon1, lat2, lon2) {\r\n        const R = 6371e3; // Earth radius in metres\r\n        const φ1 = lat1 * Math.PI/180;\r\n        const φ2 = lat2 * Math.PI/180;\r\n        const Δφ = (lat2-lat1) * Math.PI/180;\r\n        const Δλ = (lon2-lon1) * Math.PI/180;\r\n\r\n        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +\r\n                  Math.cos(φ1) * Math.cos(φ2) *\r\n                  Math.sin(Δλ/2) * Math.sin(Δλ/2);\r\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\r\n\r\n        return R * c; // Distance in metres\r\n    }\r\n\r\n    async sendLocationToServer(locationData) {\r\n        try {\r\n            // Adres bilgisini al (reverse geocoding)\r\n            const address = await this.getAddressFromCoordinates(\r\n                locationData.latitude, \r\n                locationData.longitude\r\n            );\r\n\r\n            const data = {\r\n                ...locationData,\r\n                address: address,\r\n                device_info: this.getDeviceInfo(),\r\n                user_agent: navigator.userAgent,\r\n                screen_resolution: `${screen.width}x${screen.height}`\r\n            };\r\n\r\n            const response = await fetch(base_url + 'kullanici/konum_guncelle', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'X-Requested-With': 'XMLHttpRequest'\r\n                },\r\n                body: JSON.stringify(data)\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error(`HTTP error! status: ${response.status}`);\r\n            }\r\n\r\n            const result = await response.json();\r\n            console.log('Konum başarıyla güncellendi:', result);\r\n\r\n        } catch (error) {\r\n            console.error('Konum gönderme hatası:', error);\r\n        }\r\n    }\r\n\r\n    async getAddressFromCoordinates(lat, lng) {\r\n        try {\r\n            // Google Geocoding API (isteğe bağlı)\r\n            // Kendi API anahtarınızı kullanın\r\n            const response = await fetch(\r\n                `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=tr`\r\n            );\r\n            \r\n            if (response.ok) {\r\n                const data = await response.json();\r\n                return data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;\r\n            }\r\n        } catch (error) {\r\n            console.warn('Adres alınamadı:', error);\r\n        }\r\n        \r\n        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;\r\n    }\r\n\r\n    getDeviceInfo() {\r\n        const ua = navigator.userAgent;\r\n        let device = 'Unknown';\r\n        \r\n        if (/Mobile|Android|iPhone|iPad/.test(ua)) {\r\n            if (/iPhone/.test(ua)) device = 'iPhone';\r\n            else if (/iPad/.test(ua)) device = 'iPad';\r\n            else if (/Android/.test(ua)) device = 'Android';\r\n            else device = 'Mobile';\r\n        } else {\r\n            device = 'Desktop';\r\n        }\r\n        \r\n        return device;\r\n    }\r\n\r\n    async sendErrorToServer(errorData) {\r\n        try {\r\n            await fetch(base_url + 'kullanici/konum_hata', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify(errorData)\r\n            });\r\n        } catch (error) {\r\n            console.error('Hata gönderme hatası:', error);\r\n        }\r\n    }\r\n\r\n    // Manuel konum güncelleme\r\n    updateLocation() {\r\n        this.getCurrentLocation();\r\n    }\r\n\r\n    // Konum paylaşım durumunu kontrol et\r\n    async checkPermissionStatus() {\r\n        if ('permissions' in navigator) {\r\n            const permission = await navigator.permissions.query({name: 'geolocation'});\r\n            return permission.state; // 'granted', 'denied', 'prompt'\r\n        }\r\n        return 'unknown';\r\n    }\r\n}\r\n\r\n// Sayfa yüklendiğinde konum takibini başlat\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    // Sadece login olan sayfalar için çalıştır\r\n    if (typeof base_url !== 'undefined') {\r\n        window.konumTakibi = new KullaniciKonumTakibi();\r\n        \r\n        // Debug için global erişim\r\n        if (typeof console !== 'undefined') {\r\n            console.log('Kullanıcı konum takibi sistemi aktif');\r\n        }\r\n    }\r\n});\r\n"
        }
    ]
}