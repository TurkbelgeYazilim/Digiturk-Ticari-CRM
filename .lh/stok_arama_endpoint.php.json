{
    "sourceFile": "stok_arama_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1755584922761,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1756388902121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,103 +1,129 @@\n <?php\r\n-// Stok arama endpoint - Standalone\r\n-// Manual database connection - CodeIgniter bypass\r\n+/**\r\n+ * Stok Arama Endpoint \r\n+ * Tam Ana Rapor sayfası için stok arama işlevselliği\r\n+ */\r\n \r\n+// CodeIgniter framework yükle\r\n+require_once('index.php');\r\n+\r\n+// Enable error reporting for debugging\r\n+error_reporting(E_ALL);\r\n+ini_set('display_errors', 1);\r\n+\r\n+// CORS headers\r\n header('Content-Type: application/json; charset=utf-8');\r\n header('Access-Control-Allow-Origin: *');\r\n-header('Access-Control-Allow-Methods: GET, OPTIONS');\r\n+header('Access-Control-Allow-Methods: GET, POST, OPTIONS');\r\n header('Access-Control-Allow-Headers: Content-Type');\r\n \r\n-if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n+// OPTIONS request handling\r\n+if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {\r\n     http_response_code(200);\r\n     exit();\r\n }\r\n \r\n-$term = isset($_GET['term']) ? trim($_GET['term']) : '';\r\n+try {\r\n+    // Get CodeIgniter instance\r\n+    $CI =& get_instance();\r\n+    $CI->load->database();\r\n \r\n-// En az 2 karakter gerekli\r\n-if (strlen($term) < 2) {\r\n-    echo json_encode([]);\r\n-    exit();\r\n-}\r\n+    // Get search term\r\n+    $search_term = isset($_GET['term']) ? trim($_GET['term']) : '';\r\n+    $search_term = isset($_POST['term']) ? trim($_POST['term']) : $search_term;\r\n \r\n-try {\r\n-    // Database connection\r\n-    $host = 'localhost';\r\n-    $dbname = 'ilekasoft_crmdb';\r\n-    $username = 'ilekasoft_crmuser';\r\n-    $password = 'KaleW356!';\r\n-    \r\n-    // MySQLi connection\r\n-    $mysqli = new mysqli($host, $username, $password, $dbname);\r\n-    $mysqli->set_charset(\"utf8mb4\");\r\n-    \r\n-    if ($mysqli->connect_error) {\r\n-        throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n+    if (empty($search_term)) {\r\n+        echo json_encode([\r\n+            'success' => false,\r\n+            'message' => 'Arama terimi gerekli'\r\n+        ]);\r\n+        exit;\r\n     }\r\n-    \r\n-    // Stok arama query - sadece aktif stoklar (stok_durum = 1)\r\n+\r\n+    // Minimum 2 karakter kontrolü\r\n+    if (strlen($search_term) < 2) {\r\n+        echo json_encode([\r\n+            'success' => false,\r\n+            'message' => 'En az 2 karakter gerekli'\r\n+        ]);\r\n+        exit;\r\n+    }\r\n+\r\n+    // Ana hesap bilgisini al\r\n+    $anaHesap = anaHesapBilgisi();\r\n+    if (!$anaHesap) {\r\n+        echo json_encode([\r\n+            'success' => false,\r\n+            'message' => 'Oturum geçersiz'\r\n+        ]);\r\n+        exit;\r\n+    }\r\n+\r\n+    // SQL injection koruması\r\n+    $search_term_escaped = $CI->db->escape_like_str($search_term);\r\n+\r\n+    // Stok arama sorgusu\r\n     $query = \"\r\n         SELECT \r\n             stok_id,\r\n             stok_ad,\r\n             stok_kodu,\r\n-            stok_alisFiyati,\r\n             stok_satisFiyati,\r\n             stok_satisKDV\r\n         FROM stok \r\n-        WHERE stok_durum = 1\r\n+        WHERE stok_olusturanAnaHesap = ? \r\n+        AND stok_durum = 1\r\n         AND (\r\n-            stok_ad LIKE ? \r\n-            OR stok_kodu LIKE ?\r\n+            stok_ad LIKE '%{$search_term_escaped}%' \r\n+            OR stok_kodu LIKE '%{$search_term_escaped}%'\r\n         )\r\n-        ORDER BY stok_ad ASC\r\n-        LIMIT 50\r\n+        ORDER BY \r\n+            CASE \r\n+                WHEN stok_ad LIKE '{$search_term_escaped}%' THEN 1\r\n+                WHEN stok_kodu LIKE '{$search_term_escaped}%' THEN 2\r\n+                ELSE 3\r\n+            END,\r\n+            stok_ad ASC\r\n+        LIMIT 20\r\n     \";\r\n-    \r\n-    $search_term = '%' . $term . '%';\r\n-    $stmt = $mysqli->prepare($query);\r\n-    \r\n-    if (!$stmt) {\r\n-        throw new Exception(\"Prepare failed: \" . $mysqli->error);\r\n-    }\r\n-    \r\n-    $stmt->bind_param(\"ss\", $search_term, $search_term);\r\n-    $stmt->execute();\r\n-    \r\n-    $result = $stmt->get_result();\r\n-    $data = [];\r\n-    \r\n-    while ($row = $result->fetch_assoc()) {\r\n-        $data[] = [\r\n-            'label' => $row['stok_ad'] . ' (' . ($row['stok_kodu'] ?: 'Kod Yok') . ')',\r\n-            'value' => $row['stok_ad'],\r\n-            'stok_id' => $row['stok_id'],\r\n-            'stok_kodu' => $row['stok_kodu'],\r\n-            'stok_ad' => $row['stok_ad'],\r\n-            'stok_alisFiyati' => $row['stok_alisFiyati'],\r\n-            'stok_satisFiyati' => $row['stok_satisFiyati'],\r\n-            'stok_satisKDV' => $row['stok_satisKDV']\r\n+\r\n+    $results = $CI->db->query($query, [$anaHesap])->result();\r\n+\r\n+    // Sonuçları formatla\r\n+    $formatted_results = [];\r\n+    foreach ($results as $row) {\r\n+        $detail_info = [];\r\n+        \r\n+        if (!empty($row->stok_kodu)) {\r\n+            $detail_info[] = \"Kod: \" . $row->stok_kodu;\r\n+        }\r\n+        \r\n+        if (!empty($row->stok_satisFiyati)) {\r\n+            $detail_info[] = \"Fiyat: \" . number_format($row->stok_satisFiyati, 2) . \" ₺\";\r\n+        }\r\n+        \r\n+        $detail_text = !empty($detail_info) ? \" (\" . implode(\", \", $detail_info) . \")\" : \"\";\r\n+        \r\n+        $formatted_results[] = [\r\n+            'label' => $row->stok_ad . $detail_text,\r\n+            'value' => $row->stok_ad,\r\n+            'stok_id' => $row->stok_id,\r\n+            'stok_kodu' => $row->stok_kodu,\r\n+            'stok_ad' => $row->stok_ad,\r\n+            'stok_satisFiyati' => $row->stok_satisFiyati,\r\n+            'stok_satisKDV' => $row->stok_satisKDV\r\n         ];\r\n     }\r\n-    \r\n-    $stmt->close();\r\n-    $mysqli->close();\r\n-    \r\n-    echo json_encode($data);\r\n-    \r\n+\r\n+    // JSON response\r\n+    echo json_encode($formatted_results);\r\n+\r\n } catch (Exception $e) {\r\n-    error_log(\"Stok arama error: \" . $e->getMessage());\r\n-    \r\n-    // Debug için hata detayını da döndür (production'da kaldırılabilir)\r\n-    if (isset($_GET['debug'])) {\r\n-        echo json_encode([\r\n-            'error' => true,\r\n-            'message' => $e->getMessage(),\r\n-            'term' => $term\r\n-        ]);\r\n-    } else {\r\n-        // Hata durumunda boş array döndür\r\n-        echo json_encode([]);\r\n-    }\r\n+    // Error handling\r\n+    echo json_encode([\r\n+        'success' => false,\r\n+        'message' => 'Arama sırasında hata oluştu: ' . $e->getMessage(),\r\n+        'error' => $e->getMessage()\r\n+    ]);\r\n }\r\n ?>\r\n"
                },
                {
                    "date": 1756902580990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,15 +23,20 @@\n     exit();\r\n }\r\n \r\n try {\r\n+    // Debug için log\r\n+    error_log(\"Stok Arama Endpoint - Request: \" . print_r($_REQUEST, true));\r\n+    \r\n     // Get CodeIgniter instance\r\n     $CI =& get_instance();\r\n     $CI->load->database();\r\n \r\n     // Get search term\r\n     $search_term = isset($_GET['term']) ? trim($_GET['term']) : '';\r\n     $search_term = isset($_POST['term']) ? trim($_POST['term']) : $search_term;\r\n+    \r\n+    error_log(\"Stok Arama Endpoint - Search term: \" . $search_term);\r\n \r\n     if (empty($search_term)) {\r\n         echo json_encode([\r\n             'success' => false,\r\n@@ -90,33 +95,28 @@\n     $results = $CI->db->query($query, [$anaHesap])->result();\r\n \r\n     // Sonuçları formatla\r\n     $formatted_results = [];\r\n+    \r\n+    if (empty($results)) {\r\n+        // Boş sonuç durumunda da geçerli JSON döndür\r\n+        echo json_encode([]);\r\n+        exit;\r\n+    }\r\n+    \r\n     foreach ($results as $row) {\r\n-        $detail_info = [];\r\n-        \r\n-        if (!empty($row->stok_kodu)) {\r\n-            $detail_info[] = \"Kod: \" . $row->stok_kodu;\r\n-        }\r\n-        \r\n-        if (!empty($row->stok_satisFiyati)) {\r\n-            $detail_info[] = \"Fiyat: \" . number_format($row->stok_satisFiyati, 2) . \" ₺\";\r\n-        }\r\n-        \r\n-        $detail_text = !empty($detail_info) ? \" (\" . implode(\", \", $detail_info) . \")\" : \"\";\r\n-        \r\n         $formatted_results[] = [\r\n-            'label' => $row->stok_ad . $detail_text,\r\n-            'value' => $row->stok_ad,\r\n+            'id' => $row->stok_id,\r\n+            'text' => $row->stok_ad . (!empty($row->stok_kodu) ? ' (' . $row->stok_kodu . ')' : ''),\r\n             'stok_id' => $row->stok_id,\r\n             'stok_kodu' => $row->stok_kodu,\r\n             'stok_ad' => $row->stok_ad,\r\n             'stok_satisFiyati' => $row->stok_satisFiyati,\r\n             'stok_satisKDV' => $row->stok_satisKDV\r\n         ];\r\n     }\r\n \r\n-    // JSON response\r\n+    // JSON response döndür\r\n     echo json_encode($formatted_results);\r\n \r\n } catch (Exception $e) {\r\n     // Error handling\r\n"
                }
            ],
            "date": 1755584922761,
            "name": "Commit-0",
            "content": "<?php\r\n// Stok arama endpoint - Standalone\r\n// Manual database connection - CodeIgniter bypass\r\n\r\nheader('Content-Type: application/json; charset=utf-8');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: GET, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\n$term = isset($_GET['term']) ? trim($_GET['term']) : '';\r\n\r\n// En az 2 karakter gerekli\r\nif (strlen($term) < 2) {\r\n    echo json_encode([]);\r\n    exit();\r\n}\r\n\r\ntry {\r\n    // Database connection\r\n    $host = 'localhost';\r\n    $dbname = 'ilekasoft_crmdb';\r\n    $username = 'ilekasoft_crmuser';\r\n    $password = 'KaleW356!';\r\n    \r\n    // MySQLi connection\r\n    $mysqli = new mysqli($host, $username, $password, $dbname);\r\n    $mysqli->set_charset(\"utf8mb4\");\r\n    \r\n    if ($mysqli->connect_error) {\r\n        throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n    }\r\n    \r\n    // Stok arama query - sadece aktif stoklar (stok_durum = 1)\r\n    $query = \"\r\n        SELECT \r\n            stok_id,\r\n            stok_ad,\r\n            stok_kodu,\r\n            stok_alisFiyati,\r\n            stok_satisFiyati,\r\n            stok_satisKDV\r\n        FROM stok \r\n        WHERE stok_durum = 1\r\n        AND (\r\n            stok_ad LIKE ? \r\n            OR stok_kodu LIKE ?\r\n        )\r\n        ORDER BY stok_ad ASC\r\n        LIMIT 50\r\n    \";\r\n    \r\n    $search_term = '%' . $term . '%';\r\n    $stmt = $mysqli->prepare($query);\r\n    \r\n    if (!$stmt) {\r\n        throw new Exception(\"Prepare failed: \" . $mysqli->error);\r\n    }\r\n    \r\n    $stmt->bind_param(\"ss\", $search_term, $search_term);\r\n    $stmt->execute();\r\n    \r\n    $result = $stmt->get_result();\r\n    $data = [];\r\n    \r\n    while ($row = $result->fetch_assoc()) {\r\n        $data[] = [\r\n            'label' => $row['stok_ad'] . ' (' . ($row['stok_kodu'] ?: 'Kod Yok') . ')',\r\n            'value' => $row['stok_ad'],\r\n            'stok_id' => $row['stok_id'],\r\n            'stok_kodu' => $row['stok_kodu'],\r\n            'stok_ad' => $row['stok_ad'],\r\n            'stok_alisFiyati' => $row['stok_alisFiyati'],\r\n            'stok_satisFiyati' => $row['stok_satisFiyati'],\r\n            'stok_satisKDV' => $row['stok_satisKDV']\r\n        ];\r\n    }\r\n    \r\n    $stmt->close();\r\n    $mysqli->close();\r\n    \r\n    echo json_encode($data);\r\n    \r\n} catch (Exception $e) {\r\n    error_log(\"Stok arama error: \" . $e->getMessage());\r\n    \r\n    // Debug için hata detayını da döndür (production'da kaldırılabilir)\r\n    if (isset($_GET['debug'])) {\r\n        echo json_encode([\r\n            'error' => true,\r\n            'message' => $e->getMessage(),\r\n            'term' => $term\r\n        ]);\r\n    } else {\r\n        // Hata durumunda boş array döndür\r\n        echo json_encode([]);\r\n    }\r\n}\r\n?>\r\n"
        }
    ]
}