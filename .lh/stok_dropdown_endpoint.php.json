{
    "sourceFile": "stok_dropdown_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1756810205232,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1757159372704,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,14 +3,12 @@\n  * Stok Dropdown Endpoint \r\n  * Stok adlarını dropdown için listeler\r\n  */\r\n \r\n-// CodeIgniter framework yükle\r\n-require_once('index.php');\r\n-\r\n-// Enable error reporting for debugging\r\n+// Enable error reporting for debugging but not in output\r\n error_reporting(E_ALL);\r\n-ini_set('display_errors', 1);\r\n+ini_set('display_errors', 0); // Don't display errors in JSON response\r\n+ini_set('log_errors', 1); // Log errors to file instead\r\n \r\n // CORS headers\r\n header('Content-Type: application/json; charset=utf-8');\r\n header('Access-Control-Allow-Origin: *');\r\n@@ -22,17 +20,89 @@\n     http_response_code(200);\r\n     exit();\r\n }\r\n \r\n+// CodeIgniter framework yükle - daha güvenli yöntem\r\n+define('BASEPATH', __DIR__ . '/system/');\r\n+define('ENVIRONMENT', 'production'); // Define ENVIRONMENT constant\r\n+\r\n+// Database config dosyasını dahil et\r\n+$db = [];\r\n+include(__DIR__ . '/application/config/database.php');\r\n+\r\n+// Database bağlantısı oluştur\r\n try {\r\n-    // Get CodeIgniter instance\r\n-    $CI =& get_instance();\r\n-    $CI->load->database();\r\n+    // Debug: Database bilgilerini logla\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Database config: \" . print_r($db['default'], true) . \"\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+    \r\n+    $connection = new mysqli(\r\n+        $db['default']['hostname'],\r\n+        $db['default']['username'], \r\n+        $db['default']['password'],\r\n+        $db['default']['database']\r\n+    );\r\n+    \r\n+    if ($connection->connect_error) {\r\n+        throw new Exception(\"Database connection failed: \" . $connection->connect_error);\r\n+    }\r\n+    \r\n+    $connection->set_charset('utf8');\r\n+    \r\n+    // Debug: Bağlantı başarılı\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Database connection successful\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+        \r\n+} catch (Exception $e) {\r\n+    // Debug: Bağlantı hatası\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Database connection error: \" . $e->getMessage() . \"\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+        \r\n+    echo json_encode([\r\n+        'results' => [\r\n+            [\r\n+                'id' => '',\r\n+                'text' => 'Database bağlantı hatası: ' . $e->getMessage(),\r\n+                'disabled' => true\r\n+            ]\r\n+        ],\r\n+        'error' => $e->getMessage()\r\n+    ], JSON_UNESCAPED_UNICODE);\r\n+    exit();\r\n+}\r\n \r\n+try {\r\n+    // Debug: İstek başladı\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Request started - GET: \" . print_r($_GET, true) . \" POST: \" . print_r($_POST, true) . \"\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+    \r\n     // Arama terimi al\r\n     $search_term = isset($_GET['q']) ? trim($_GET['q']) : '';\r\n     $search_term = isset($_POST['q']) ? trim($_POST['q']) : $search_term;\r\n+    \r\n+    // SQL injection koruması için escape\r\n+    $search_term = $connection->real_escape_string($search_term);\r\n+    \r\n+    // Debug: Arama terimi\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Search term: '{$search_term}'\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n \r\n+    // Önce stok tablosunun var olup olmadığını kontrol et\r\n+    $table_check = $connection->query(\"SHOW TABLES LIKE 'stok'\");\r\n+    if ($table_check->num_rows == 0) {\r\n+        throw new Exception(\"Stok tablosu bulunamadı\");\r\n+    }\r\n+    \r\n+    // Debug: Tablo kontrolü\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Stok table exists\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+\r\n     // Basit stok sorgusu - tüm aktif stokları getir\r\n     $query = \"\r\n         SELECT \r\n             stok_id,\r\n@@ -47,9 +117,28 @@\n         ORDER BY stok_ad ASC\r\n         LIMIT 50\r\n     \";\r\n \r\n-    $results = $CI->db->query($query)->result();\r\n+    $result = $connection->query($query);\r\n+    \r\n+    if (!$result) {\r\n+        throw new Exception(\"Query failed: \" . $connection->error);\r\n+    }\r\n+    \r\n+    // Debug: Query sonucu\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Query executed successfully. Rows found: \" . $result->num_rows . \"\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+    \r\n+    $results = [];\r\n+    while ($row = $result->fetch_object()) {\r\n+        $results[] = $row;\r\n+    }\r\n+    \r\n+    // Debug: Results\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Results count: \" . count($results) . \"\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n \r\n     // Select2 formatına uygun sonuçları hazırla\r\n     $formatted_results = [];\r\n     \r\n@@ -110,16 +199,31 @@\n         }\r\n     }\r\n \r\n     // Select2 yanıt formatı\r\n-    echo json_encode([\r\n+    $response = [\r\n         'results' => $formatted_results,\r\n         'pagination' => [\r\n             'more' => count($results) >= 50\r\n         ]\r\n-    ], JSON_UNESCAPED_UNICODE);\r\n+    ];\r\n+    \r\n+    // Debug: Final response\r\n+    file_put_contents(__DIR__ . '/debug_stok_dropdown.log', \r\n+        date('Y-m-d H:i:s') . \" - Final response: \" . json_encode($response, JSON_UNESCAPED_UNICODE) . \"\\n\", \r\n+        FILE_APPEND | LOCK_EX);\r\n+    \r\n+    echo json_encode($response, JSON_UNESCAPED_UNICODE);\r\n+    \r\n+    // Connection kapat\r\n+    $connection->close();\r\n \r\n } catch (Exception $e) {\r\n+    // Connection kapat (hata durumunda da)\r\n+    if (isset($connection)) {\r\n+        $connection->close();\r\n+    }\r\n+    \r\n     // Hata işleme\r\n     echo json_encode([\r\n         'results' => [\r\n             [\r\n"
                }
            ],
            "date": 1756810205232,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Stok Dropdown Endpoint \r\n * Stok adlarını dropdown için listeler\r\n */\r\n\r\n// CodeIgniter framework yükle\r\nrequire_once('index.php');\r\n\r\n// Enable error reporting for debugging\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 1);\r\n\r\n// CORS headers\r\nheader('Content-Type: application/json; charset=utf-8');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: GET, POST, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\n// OPTIONS request handling\r\nif ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\ntry {\r\n    // Get CodeIgniter instance\r\n    $CI =& get_instance();\r\n    $CI->load->database();\r\n\r\n    // Arama terimi al\r\n    $search_term = isset($_GET['q']) ? trim($_GET['q']) : '';\r\n    $search_term = isset($_POST['q']) ? trim($_POST['q']) : $search_term;\r\n\r\n    // Basit stok sorgusu - tüm aktif stokları getir\r\n    $query = \"\r\n        SELECT \r\n            stok_id,\r\n            stok_ad,\r\n            stok_kodu,\r\n            stok_satisFiyati,\r\n            stok_satisKDV\r\n        FROM stok \r\n        WHERE stok_durum = 1\r\n        AND (stok_ad IS NOT NULL AND stok_ad != '')\r\n        \" . (!empty($search_term) ? \"AND (stok_ad LIKE '%{$search_term}%' OR stok_kodu LIKE '%{$search_term}%')\" : \"\") . \"\r\n        ORDER BY stok_ad ASC\r\n        LIMIT 50\r\n    \";\r\n\r\n    $results = $CI->db->query($query)->result();\r\n\r\n    // Select2 formatına uygun sonuçları hazırla\r\n    $formatted_results = [];\r\n    \r\n    // Boş seçenek ekle (sadece arama terimi yoksa)\r\n    if (empty($search_term)) {\r\n        $formatted_results[] = [\r\n            'id' => '',\r\n            'text' => 'Stok seçiniz...',\r\n            'stok_data' => null\r\n        ];\r\n    }\r\n\r\n    foreach ($results as $row) {\r\n        // Stok adı boşsa atla\r\n        if (empty($row->stok_ad)) {\r\n            continue;\r\n        }\r\n        \r\n        $display_text = $row->stok_ad;\r\n        if (!empty($row->stok_kodu)) {\r\n            $display_text .= \" (Kod: {$row->stok_kodu})\";\r\n        }\r\n        if (!empty($row->stok_satisFiyati) && $row->stok_satisFiyati > 0) {\r\n            $display_text .= \" - \" . number_format($row->stok_satisFiyati, 2) . \" ₺\";\r\n        }\r\n        \r\n        $formatted_results[] = [\r\n            'id' => $row->stok_id,\r\n            'text' => $display_text,\r\n            'stok_data' => [\r\n                'stok_id' => $row->stok_id,\r\n                'stok_kodu' => $row->stok_kodu ?? '',\r\n                'stok_ad' => $row->stok_ad,\r\n                'stok_satisFiyati' => floatval($row->stok_satisFiyati ?? 0),\r\n                'stok_satisKDV' => floatval($row->stok_satisKDV ?? 20)\r\n            ]\r\n        ];\r\n    }\r\n\r\n    // Hiç sonuç yoksa mesaj göster\r\n    if (count($formatted_results) <= 1) { // 1 çünkü boş seçenek var\r\n        if (!empty($search_term)) {\r\n            $formatted_results = [\r\n                [\r\n                    'id' => '',\r\n                    'text' => \"'{$search_term}' için sonuç bulunamadı\",\r\n                    'disabled' => true\r\n                ]\r\n            ];\r\n        } else {\r\n            $formatted_results = [\r\n                [\r\n                    'id' => '',\r\n                    'text' => 'Aktif stok bulunamadı',\r\n                    'disabled' => true\r\n                ]\r\n            ];\r\n        }\r\n    }\r\n\r\n    // Select2 yanıt formatı\r\n    echo json_encode([\r\n        'results' => $formatted_results,\r\n        'pagination' => [\r\n            'more' => count($results) >= 50\r\n        ]\r\n    ], JSON_UNESCAPED_UNICODE);\r\n\r\n} catch (Exception $e) {\r\n    // Hata işleme\r\n    echo json_encode([\r\n        'results' => [\r\n            [\r\n                'id' => '',\r\n                'text' => 'Hata: ' . $e->getMessage(),\r\n                'disabled' => true\r\n            ]\r\n        ],\r\n        'error' => $e->getMessage()\r\n    ], JSON_UNESCAPED_UNICODE);\r\n}\r\n?>\r\n"
        }
    ]
}