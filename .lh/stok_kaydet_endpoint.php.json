{
    "sourceFile": "stok_kaydet_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1755587227967,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755591503056,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -145,8 +145,66 @@\n     if ($inserted_count == 0) {\r\n         throw new Exception(\"Hiçbir geçerli stok kaydı bulunamadı\");\r\n     }\r\n     \r\n+    // Ana fatura tablosunu güncelle - tüm stokların toplamını hesapla\r\n+    $kdv_haric_toplam = 0;\r\n+    $kdv_toplam = 0;\r\n+    $kdv_dahil_toplam = $toplam_tutar_kdv_dahil;\r\n+    \r\n+    // Her stok için KDV hariç tutarı hesapla\r\n+    foreach ($stok_bilgileri as $stok) {\r\n+        if (empty($stok['stok_adi']) || empty($stok['miktar']) || !isset($stok['birim_fiyat'])) {\r\n+            continue;\r\n+        }\r\n+        \r\n+        $miktar = floatval($stok['miktar']);\r\n+        $birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']);\r\n+        $kdv_orani = floatval($stok['kdv_orani']);\r\n+        \r\n+        $satir_toplam_kdv_dahil = $miktar * $birim_fiyat_kdv_dahil;\r\n+        $satir_toplam_kdv_haric = round($satir_toplam_kdv_dahil / (1 + $kdv_orani / 100), 2);\r\n+        $satir_kdv_tutari = round($satir_toplam_kdv_dahil - $satir_toplam_kdv_haric, 2);\r\n+        \r\n+        $kdv_haric_toplam += $satir_toplam_kdv_haric;\r\n+        $kdv_toplam += $satir_kdv_tutari;\r\n+    }\r\n+    \r\n+    // Final rounding\r\n+    $kdv_haric_toplam = round($kdv_haric_toplam, 2);\r\n+    $kdv_toplam = round($kdv_toplam, 2);\r\n+    \r\n+    // satisFaturasi tablosunu güncelle\r\n+    $update_invoice_query = \"\r\n+        UPDATE satisFaturasi SET \r\n+            satis_araToplam = ?,\r\n+            satis_kdvToplam = ?,\r\n+            satis_genelToplam = ?,\r\n+            satis_netTutar = ?,\r\n+            satis_vergiDahilToplam = ?\r\n+        WHERE satis_id = ?\r\n+    \";\r\n+    \r\n+    $update_stmt = $mysqli->prepare($update_invoice_query);\r\n+    if (!$update_stmt) {\r\n+        throw new Exception(\"Invoice update prepare failed: \" . $mysqli->error);\r\n+    }\r\n+    \r\n+    $update_stmt->bind_param(\"dddddi\", \r\n+        $kdv_haric_toplam,\r\n+        $kdv_toplam, \r\n+        $kdv_dahil_toplam,\r\n+        $kdv_haric_toplam,\r\n+        $kdv_dahil_toplam,\r\n+        $satis_id\r\n+    );\r\n+    \r\n+    if (!$update_stmt->execute()) {\r\n+        throw new Exception(\"Invoice update execution failed: \" . $update_stmt->error);\r\n+    }\r\n+    \r\n+    $update_stmt->close();\r\n+    \r\n     // Transaction'ı tamamla\r\n     $mysqli->commit();\r\n     $mysqli->close();\r\n     \r\n@@ -154,9 +212,12 @@\n         'success' => true, \r\n         'message' => \"$inserted_count stok kaydı başarıyla güncellendi\",\r\n         'data' => [\r\n             'inserted_count' => $inserted_count,\r\n-            'toplam_tutar' => $toplam_tutar_kdv_dahil\r\n+            'toplam_tutar_kdv_dahil' => $toplam_tutar_kdv_dahil,\r\n+            'kdv_haric_toplam' => $kdv_haric_toplam,\r\n+            'kdv_toplam' => $kdv_toplam,\r\n+            'fatura_guncellendi' => true\r\n         ]\r\n     ]);\r\n     \r\n } catch (Exception $e) {\r\n"
                },
                {
                    "date": 1757332850779,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,10 +89,11 @@\n             satisStok_kdv,\r\n             satisStok_indirimTutari,\r\n             satisStok_tevkifat_id,\r\n             satisStok_satirIskonto,\r\n-            satisStok_indirimlifiyat\r\n-        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n+            satisStok_indirimlifiyat,\r\n+            satisStok_kullanici_sayisi\r\n+        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n     \";\r\n     \r\n     $insert_stmt = $mysqli->prepare($insert_query);\r\n     if (!$insert_stmt) {\r\n@@ -107,8 +108,9 @@\n         $stok_id = !empty($stok['stok_id']) ? intval($stok['stok_id']) : null;\r\n         $miktar = floatval($stok['miktar']);\r\n         $birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']); // KDV dahil fiyat\r\n         $kdv_orani = floatval($stok['kdv_orani']);\r\n+        $kullanici_sayisi = !empty($stok['kullanici_sayisi']) ? intval($stok['kullanici_sayisi']) : null;\r\n         \r\n         // Toplam hesapla (KDV dahil fiyat olduğu için direkt çarp)\r\n         $satir_toplam = $miktar * $birim_fiyat_kdv_dahil;\r\n         $toplam_tutar_kdv_dahil += $satir_toplam;\r\n@@ -119,9 +121,9 @@\n         $satir_iskonto = 0;\r\n         $indirimli_fiyat = $birim_fiyat_kdv_dahil; // Same as birim fiyat since no discount\r\n         \r\n         // Veritabanına kaydet\r\n-        $insert_stmt->bind_param(\"iiddddiddd\", \r\n+        $insert_stmt->bind_param(\"iiddddidddi\", \r\n             $satis_id, \r\n             $stok_id, \r\n             $miktar, \r\n             $birim_fiyat_kdv_dahil,\r\n@@ -129,9 +131,10 @@\n             $kdv_orani,\r\n             $indirim_tutari,\r\n             $tevkifat_id,\r\n             $satir_iskonto,\r\n-            $indirimli_fiyat\r\n+            $indirimli_fiyat,\r\n+            $kullanici_sayisi\r\n         );\r\n \r\n         if (!$insert_stmt->execute()) {\r\n             throw new Exception(\"Insert execution failed: \" . $insert_stmt->error);\r\n"
                },
                {
                    "date": 1759751588097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,8 +57,51 @@\n     if ($mysqli->connect_error) {\r\n         throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n     }\r\n     \r\n+    // Türkçe sayı formatını parse etmek için fonksiyon\r\n+    function parseTurkishNumber($value) {\r\n+        if (empty($value)) return 0;\r\n+        \r\n+        // String'e çevir ve temizle\r\n+        $numStr = trim(strval($value));\r\n+        \r\n+        // Sadece rakam, nokta ve virgül bırak\r\n+        $numStr = preg_replace('/[^\\d.,]/', '', $numStr);\r\n+        \r\n+        // Eğer boşsa 0 döndür\r\n+        if (empty($numStr)) return 0;\r\n+        \r\n+        // Türkçe format kontrolü (414.000,50 formatında)\r\n+        if (strpos($numStr, '.') !== false && strpos($numStr, ',') !== false) {\r\n+            // Hem nokta hem virgül var - Türkçe format\r\n+            // Noktaları kaldır (binlik ayırıcı), virgülü ondalık ayırıcı yap\r\n+            $numStr = str_replace('.', '', $numStr);\r\n+            $numStr = str_replace(',', '.', $numStr);\r\n+        } else if (strpos($numStr, ',') !== false) {\r\n+            // Sadece virgül var\r\n+            $parts = explode(',', $numStr);\r\n+            if (count($parts) === 2 && strlen($parts[1]) <= 2) {\r\n+                // Ondalık ayırıcı olarak virgül kullanılmış\r\n+                $numStr = str_replace(',', '.', $numStr);\r\n+            } else {\r\n+                // Binlik ayırıcı olarak virgül kullanılmış\r\n+                $numStr = str_replace(',', '', $numStr);\r\n+            }\r\n+        } else if (strpos($numStr, '.') !== false) {\r\n+            // Sadece nokta var\r\n+            $parts = explode('.', $numStr);\r\n+            if (count($parts) === 2 && strlen($parts[1]) <= 2) {\r\n+                // Ondalık ayırıcı olarak nokta kullanılmış - değiştirme\r\n+            } else {\r\n+                // Binlik ayırıcı olarak nokta kullanılmış\r\n+                $numStr = str_replace('.', '', $numStr);\r\n+            }\r\n+        }\r\n+        \r\n+        return floatval($numStr);\r\n+    }\r\n+    \r\n     // Transaction başlat\r\n     $mysqli->autocommit(false);\r\n     \r\n     // Mevcut stok kayıtlarını sil\r\n@@ -105,13 +148,15 @@\n             continue;\r\n         }\r\n         \r\n         $stok_id = !empty($stok['stok_id']) ? intval($stok['stok_id']) : null;\r\n-        $miktar = floatval($stok['miktar']);\r\n-        $birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']); // KDV dahil fiyat\r\n-        $kdv_orani = floatval($stok['kdv_orani']);\r\n+        $miktar = parseTurkishNumber($stok['miktar']);\r\n+        $birim_fiyat_kdv_dahil = parseTurkishNumber($stok['birim_fiyat']); // KDV dahil fiyat\r\n+        $kdv_orani = parseTurkishNumber($stok['kdv_orani']);\r\n         $kullanici_sayisi = !empty($stok['kullanici_sayisi']) ? intval($stok['kullanici_sayisi']) : null;\r\n         \r\n+        error_log(\"DEBUG: Parsed values - miktar: $miktar, birim_fiyat: $birim_fiyat_kdv_dahil, kdv_orani: $kdv_orani\");\r\n+        \r\n         // Toplam hesapla (KDV dahil fiyat olduğu için direkt çarp)\r\n         $satir_toplam = $miktar * $birim_fiyat_kdv_dahil;\r\n         $toplam_tutar_kdv_dahil += $satir_toplam;\r\n         \r\n@@ -159,11 +204,11 @@\n         if (empty($stok['stok_adi']) || empty($stok['miktar']) || !isset($stok['birim_fiyat'])) {\r\n             continue;\r\n         }\r\n         \r\n-        $miktar = floatval($stok['miktar']);\r\n-        $birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']);\r\n-        $kdv_orani = floatval($stok['kdv_orani']);\r\n+        $miktar = parseTurkishNumber($stok['miktar']);\r\n+        $birim_fiyat_kdv_dahil = parseTurkishNumber($stok['birim_fiyat']);\r\n+        $kdv_orani = parseTurkishNumber($stok['kdv_orani']);\r\n         \r\n         $satir_toplam_kdv_dahil = $miktar * $birim_fiyat_kdv_dahil;\r\n         $satir_toplam_kdv_haric = round($satir_toplam_kdv_dahil / (1 + $kdv_orani / 100), 2);\r\n         $satir_kdv_tutari = round($satir_toplam_kdv_dahil - $satir_toplam_kdv_haric, 2);\r\n"
                },
                {
                    "date": 1760449972168,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,9 +133,9 @@\n             satisStok_indirimTutari,\r\n             satisStok_tevkifat_id,\r\n             satisStok_satirIskonto,\r\n             satisStok_indirimlifiyat,\r\n-            satisStok_kullanici_sayisi\r\n+            satisStok_abonelikBitisTarihi\r\n         ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n     \";\r\n     \r\n     $insert_stmt = $mysqli->prepare($insert_query);\r\n@@ -151,9 +151,9 @@\n         $stok_id = !empty($stok['stok_id']) ? intval($stok['stok_id']) : null;\r\n         $miktar = parseTurkishNumber($stok['miktar']);\r\n         $birim_fiyat_kdv_dahil = parseTurkishNumber($stok['birim_fiyat']); // KDV dahil fiyat\r\n         $kdv_orani = parseTurkishNumber($stok['kdv_orani']);\r\n-        $kullanici_sayisi = !empty($stok['kullanici_sayisi']) ? intval($stok['kullanici_sayisi']) : null;\r\n+        $abonelik_bitis_tarihi = !empty($stok['abonelik_bitis_tarihi']) ? $stok['abonelik_bitis_tarihi'] : null;\r\n         \r\n         error_log(\"DEBUG: Parsed values - miktar: $miktar, birim_fiyat: $birim_fiyat_kdv_dahil, kdv_orani: $kdv_orani\");\r\n         \r\n         // Toplam hesapla (KDV dahil fiyat olduğu için direkt çarp)\r\n@@ -166,9 +166,9 @@\n         $satir_iskonto = 0;\r\n         $indirimli_fiyat = $birim_fiyat_kdv_dahil; // Same as birim fiyat since no discount\r\n         \r\n         // Veritabanına kaydet\r\n-        $insert_stmt->bind_param(\"iiddddidddi\", \r\n+        $insert_stmt->bind_param(\"iidddddidds\", \r\n             $satis_id, \r\n             $stok_id, \r\n             $miktar, \r\n             $birim_fiyat_kdv_dahil,\r\n@@ -177,9 +177,9 @@\n             $indirim_tutari,\r\n             $tevkifat_id,\r\n             $satir_iskonto,\r\n             $indirimli_fiyat,\r\n-            $kullanici_sayisi\r\n+            $abonelik_bitis_tarihi\r\n         );\r\n \r\n         if (!$insert_stmt->execute()) {\r\n             throw new Exception(\"Insert execution failed: \" . $insert_stmt->error);\r\n"
                },
                {
                    "date": 1760450260626,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,11 +23,15 @@\n \r\n $satis_id = isset($post_data['satis_id']) ? intval($post_data['satis_id']) : 0;\r\n $cari_id = isset($post_data['cari_id']) ? intval($post_data['cari_id']) : 0;\r\n $stok_bilgileri = isset($post_data['stok_bilgileri']) ? $post_data['stok_bilgileri'] : [];\r\n+$sozlesme_tarihi = isset($post_data['sozlesme_tarihi']) ? $post_data['sozlesme_tarihi'] : null;\r\n+$sozlesme_no = isset($post_data['sozlesme_no']) ? $post_data['sozlesme_no'] : null;\r\n+$sozlesme_aciklama = isset($post_data['sozlesme_aciklama']) ? $post_data['sozlesme_aciklama'] : null;\r\n \r\n error_log(\"DEBUG: stok_kaydet called with satis_id: $satis_id, cari_id: $cari_id\");\r\n error_log(\"DEBUG: stok_bilgileri: \" . json_encode($stok_bilgileri));\r\n+error_log(\"DEBUG: sozlesme_tarihi: $sozlesme_tarihi, sozlesme_no: $sozlesme_no\");\r\n \r\n if (!$satis_id || !$stok_bilgileri || !is_array($stok_bilgileri)) {\r\n     echo json_encode([\r\n         'success' => false, \r\n@@ -220,30 +224,36 @@\n     // Final rounding\r\n     $kdv_haric_toplam = round($kdv_haric_toplam, 2);\r\n     $kdv_toplam = round($kdv_toplam, 2);\r\n     \r\n-    // satisFaturasi tablosunu güncelle\r\n+    // satisFaturasi tablosunu güncelle - sözleşme bilgileri dahil\r\n     $update_invoice_query = \"\r\n         UPDATE satisFaturasi SET \r\n             satis_araToplam = ?,\r\n             satis_kdvToplam = ?,\r\n             satis_genelToplam = ?,\r\n             satis_netTutar = ?,\r\n-            satis_vergiDahilToplam = ?\r\n+            satis_vergiDahilToplam = ?,\r\n+            satis_faturaTarihi = ?,\r\n+            satis_faturaNo = ?,\r\n+            satis_aciklama = ?\r\n         WHERE satis_id = ?\r\n     \";\r\n     \r\n     $update_stmt = $mysqli->prepare($update_invoice_query);\r\n     if (!$update_stmt) {\r\n         throw new Exception(\"Invoice update prepare failed: \" . $mysqli->error);\r\n     }\r\n     \r\n-    $update_stmt->bind_param(\"dddddi\", \r\n+    $update_stmt->bind_param(\"dddddssi\", \r\n         $kdv_haric_toplam,\r\n         $kdv_toplam, \r\n         $kdv_dahil_toplam,\r\n         $kdv_haric_toplam,\r\n         $kdv_dahil_toplam,\r\n+        $sozlesme_tarihi,\r\n+        $sozlesme_no,\r\n+        $sozlesme_aciklama,\r\n         $satis_id\r\n     );\r\n     \r\n     if (!$update_stmt->execute()) {\r\n"
                },
                {
                    "date": 1760450555960,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -243,9 +243,9 @@\n     if (!$update_stmt) {\r\n         throw new Exception(\"Invoice update prepare failed: \" . $mysqli->error);\r\n     }\r\n     \r\n-    $update_stmt->bind_param(\"dddddssi\", \r\n+    $update_stmt->bind_param(\"dddddsssi\", \r\n         $kdv_haric_toplam,\r\n         $kdv_toplam, \r\n         $kdv_dahil_toplam,\r\n         $kdv_haric_toplam,\r\n"
                },
                {
                    "date": 1760455607243,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,9 +31,10 @@\n error_log(\"DEBUG: stok_kaydet called with satis_id: $satis_id, cari_id: $cari_id\");\r\n error_log(\"DEBUG: stok_bilgileri: \" . json_encode($stok_bilgileri));\r\n error_log(\"DEBUG: sozlesme_tarihi: $sozlesme_tarihi, sozlesme_no: $sozlesme_no\");\r\n \r\n-if (!$satis_id || !$stok_bilgileri || !is_array($stok_bilgileri)) {\r\n+// satis_id 0 olabilir (yeni kayıt için), ama cari_id ve stok_bilgileri zorunlu\r\n+if ($satis_id === null || $satis_id === '' || !$cari_id || !$stok_bilgileri || !is_array($stok_bilgileri)) {\r\n     echo json_encode([\r\n         'success' => false, \r\n         'message' => 'Gerekli veriler eksik',\r\n         'debug' => [\r\n@@ -107,22 +108,57 @@\n     \r\n     // Transaction başlat\r\n     $mysqli->autocommit(false);\r\n     \r\n-    // Mevcut stok kayıtlarını sil\r\n-    $delete_query = \"DELETE FROM satisFaturasiStok WHERE satisStok_satisFaturasiID = ?\";\r\n-    $delete_stmt = $mysqli->prepare($delete_query);\r\n-    \r\n-    if (!$delete_stmt) {\r\n-        throw new Exception(\"Delete prepare failed: \" . $mysqli->error);\r\n+    // Eğer yeni kayıt ise (satis_id = 0), önce satisFaturasi kaydı oluştur\r\n+    if ($satis_id == 0) {\r\n+        $insert_satis_query = \"\r\n+            INSERT INTO satisFaturasi (\r\n+                satis_cariID,\r\n+                satis_faturaTarihi,\r\n+                satis_faturaNo,\r\n+                satis_aciklama,\r\n+                satis_araToplam,\r\n+                satis_kdvToplam,\r\n+                satis_genelToplam,\r\n+                satis_netTutar,\r\n+                satis_vergiDahilToplam,\r\n+                satis_olusturmaTarihi,\r\n+                satis_istisna_id,\r\n+                satis_vergiMuafiyetSebep\r\n+            ) VALUES (?, ?, ?, ?, 0, 0, 0, 0, 0, CURDATE(), 0, '')\r\n+        \";\r\n+        \r\n+        $insert_satis_stmt = $mysqli->prepare($insert_satis_query);\r\n+        if (!$insert_satis_stmt) {\r\n+            throw new Exception(\"Satis insert prepare failed: \" . $mysqli->error);\r\n+        }\r\n+        \r\n+        $insert_satis_stmt->bind_param(\"isss\", $cari_id, $sozlesme_tarihi, $sozlesme_no, $sozlesme_aciklama);\r\n+        if (!$insert_satis_stmt->execute()) {\r\n+            throw new Exception(\"Satis insert execution failed: \" . $insert_satis_stmt->error);\r\n+        }\r\n+        \r\n+        $satis_id = $mysqli->insert_id;\r\n+        $insert_satis_stmt->close();\r\n+        \r\n+        error_log(\"DEBUG: Yeni satisFaturasi kaydı oluşturuldu, satis_id: $satis_id\");\r\n+    } else {\r\n+        // Mevcut kayıt için stokları sil\r\n+        $delete_query = \"DELETE FROM satisFaturasiStok WHERE satisStok_satisFaturasiID = ?\";\r\n+        $delete_stmt = $mysqli->prepare($delete_query);\r\n+        \r\n+        if (!$delete_stmt) {\r\n+            throw new Exception(\"Delete prepare failed: \" . $mysqli->error);\r\n+        }\r\n+        \r\n+        $delete_stmt->bind_param(\"i\", $satis_id);\r\n+        if (!$delete_stmt->execute()) {\r\n+            throw new Exception(\"Delete execution failed: \" . $delete_stmt->error);\r\n+        }\r\n+        $delete_stmt->close();\r\n     }\r\n     \r\n-    $delete_stmt->bind_param(\"i\", $satis_id);\r\n-    if (!$delete_stmt->execute()) {\r\n-        throw new Exception(\"Delete execution failed: \" . $delete_stmt->error);\r\n-    }\r\n-    $delete_stmt->close();\r\n-    \r\n     $toplam_tutar_kdv_dahil = 0;\r\n     $inserted_count = 0;\r\n     \r\n     // Yeni stok kayıtlarını ekle\r\n"
                }
            ],
            "date": 1755587227967,
            "name": "Commit-0",
            "content": "<?php\r\n// Stok bilgileri kaydet endpoint - Standalone\r\n// Manual database connection - CodeIgniter bypass\r\n\r\nheader('Content-Type: application/json; charset=utf-8');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: POST, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\n// POST verilerini al\r\n$raw_post = file_get_contents('php://input');\r\n$post_data = json_decode($raw_post, true);\r\n\r\n// Form data formatında da olabilir\r\nif (!$post_data) {\r\n    $post_data = $_POST;\r\n}\r\n\r\n$satis_id = isset($post_data['satis_id']) ? intval($post_data['satis_id']) : 0;\r\n$cari_id = isset($post_data['cari_id']) ? intval($post_data['cari_id']) : 0;\r\n$stok_bilgileri = isset($post_data['stok_bilgileri']) ? $post_data['stok_bilgileri'] : [];\r\n\r\nerror_log(\"DEBUG: stok_kaydet called with satis_id: $satis_id, cari_id: $cari_id\");\r\nerror_log(\"DEBUG: stok_bilgileri: \" . json_encode($stok_bilgileri));\r\n\r\nif (!$satis_id || !$stok_bilgileri || !is_array($stok_bilgileri)) {\r\n    echo json_encode([\r\n        'success' => false, \r\n        'message' => 'Gerekli veriler eksik',\r\n        'debug' => [\r\n            'satis_id' => $satis_id,\r\n            'cari_id' => $cari_id,\r\n            'stok_count' => is_array($stok_bilgileri) ? count($stok_bilgileri) : 0,\r\n            'raw_post' => $raw_post,\r\n            'post_data' => $post_data\r\n        ]\r\n    ]);\r\n    exit;\r\n}\r\n\r\ntry {\r\n    // Database connection\r\n    $host = 'localhost';\r\n    $dbname = 'ilekasoft_crmdb';\r\n    $username = 'ilekasoft_crmuser';\r\n    $password = 'KaleW356!';\r\n    \r\n    // MySQLi connection\r\n    $mysqli = new mysqli($host, $username, $password, $dbname);\r\n    $mysqli->set_charset(\"utf8mb4\");\r\n    \r\n    if ($mysqli->connect_error) {\r\n        throw new Exception(\"MySQL connection failed: \" . $mysqli->connect_error);\r\n    }\r\n    \r\n    // Transaction başlat\r\n    $mysqli->autocommit(false);\r\n    \r\n    // Mevcut stok kayıtlarını sil\r\n    $delete_query = \"DELETE FROM satisFaturasiStok WHERE satisStok_satisFaturasiID = ?\";\r\n    $delete_stmt = $mysqli->prepare($delete_query);\r\n    \r\n    if (!$delete_stmt) {\r\n        throw new Exception(\"Delete prepare failed: \" . $mysqli->error);\r\n    }\r\n    \r\n    $delete_stmt->bind_param(\"i\", $satis_id);\r\n    if (!$delete_stmt->execute()) {\r\n        throw new Exception(\"Delete execution failed: \" . $delete_stmt->error);\r\n    }\r\n    $delete_stmt->close();\r\n    \r\n    $toplam_tutar_kdv_dahil = 0;\r\n    $inserted_count = 0;\r\n    \r\n    // Yeni stok kayıtlarını ekle\r\n    $insert_query = \"\r\n        INSERT INTO satisFaturasiStok (\r\n            satisStok_satisFaturasiID,\r\n            satisStok_stokID,\r\n            satisStok_miktar,\r\n            satisStok_birimFiyat,\r\n            satisStok_fiyatMiktar,\r\n            satisStok_kdv,\r\n            satisStok_indirimTutari,\r\n            satisStok_tevkifat_id,\r\n            satisStok_satirIskonto,\r\n            satisStok_indirimlifiyat\r\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    \";\r\n    \r\n    $insert_stmt = $mysqli->prepare($insert_query);\r\n    if (!$insert_stmt) {\r\n        throw new Exception(\"Insert prepare failed: \" . $mysqli->error);\r\n    }\r\n    \r\n    foreach ($stok_bilgileri as $stok) {\r\n        if (empty($stok['stok_adi']) || empty($stok['miktar']) || !isset($stok['birim_fiyat'])) {\r\n            continue;\r\n        }\r\n        \r\n        $stok_id = !empty($stok['stok_id']) ? intval($stok['stok_id']) : null;\r\n        $miktar = floatval($stok['miktar']);\r\n        $birim_fiyat_kdv_dahil = floatval($stok['birim_fiyat']); // KDV dahil fiyat\r\n        $kdv_orani = floatval($stok['kdv_orani']);\r\n        \r\n        // Toplam hesapla (KDV dahil fiyat olduğu için direkt çarp)\r\n        $satir_toplam = $miktar * $birim_fiyat_kdv_dahil;\r\n        $toplam_tutar_kdv_dahil += $satir_toplam;\r\n        \r\n        // Default values for missing fields\r\n        $indirim_tutari = 0;\r\n        $tevkifat_id = 0;\r\n        $satir_iskonto = 0;\r\n        $indirimli_fiyat = $birim_fiyat_kdv_dahil; // Same as birim fiyat since no discount\r\n        \r\n        // Veritabanına kaydet\r\n        $insert_stmt->bind_param(\"iiddddiddd\", \r\n            $satis_id, \r\n            $stok_id, \r\n            $miktar, \r\n            $birim_fiyat_kdv_dahil,\r\n            $satir_toplam, // satisStok_fiyatMiktar\r\n            $kdv_orani,\r\n            $indirim_tutari,\r\n            $tevkifat_id,\r\n            $satir_iskonto,\r\n            $indirimli_fiyat\r\n        );\r\n\r\n        if (!$insert_stmt->execute()) {\r\n            throw new Exception(\"Insert execution failed: \" . $insert_stmt->error);\r\n        }\r\n\r\n        $inserted_count++;\r\n    }\r\n    \r\n    $insert_stmt->close();\r\n    \r\n    if ($inserted_count == 0) {\r\n        throw new Exception(\"Hiçbir geçerli stok kaydı bulunamadı\");\r\n    }\r\n    \r\n    // Transaction'ı tamamla\r\n    $mysqli->commit();\r\n    $mysqli->close();\r\n    \r\n    echo json_encode([\r\n        'success' => true, \r\n        'message' => \"$inserted_count stok kaydı başarıyla güncellendi\",\r\n        'data' => [\r\n            'inserted_count' => $inserted_count,\r\n            'toplam_tutar' => $toplam_tutar_kdv_dahil\r\n        ]\r\n    ]);\r\n    \r\n} catch (Exception $e) {\r\n    if (isset($mysqli)) {\r\n        $mysqli->rollback();\r\n        $mysqli->close();\r\n    }\r\n    \r\n    echo json_encode([\r\n        'success' => false, \r\n        'message' => 'Kayıt sırasında bir hata oluştu: ' . $e->getMessage(),\r\n        'debug' => [\r\n            'satis_id' => $satis_id,\r\n            'cari_id' => $cari_id,\r\n            'error' => $e->getMessage()\r\n        ]\r\n    ]);\r\n}\r\n?>\r\n"
        }
    ]
}