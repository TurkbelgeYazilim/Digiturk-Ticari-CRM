{
    "sourceFile": "system/libraries/Upload.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1760098282553,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1760098282553,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * CodeIgniter\r\n *\r\n * An open source application development framework for PHP\r\n *\r\n * This content is released under the MIT License (MIT)\r\n *\r\n * Copyright (c) 2014 - 2019, British Columbia Institute of Technology\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in\r\n * all copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n * THE SOFTWARE.\r\n *\r\n * @package\tCodeIgniter\r\n * @author\tEllisLab Dev Team\r\n * @copyright\tCopyright (c) 2008 - 2014, EllisLab, Inc. (https://ellislab.com/)\r\n * @copyright\tCopyright (c) 2014 - 2019, British Columbia Institute of Technology (https://bcit.ca/)\r\n * @license\thttps://opensource.org/licenses/MIT\tMIT License\r\n * @link\thttps://codeigniter.com\r\n * @since\tVersion 1.0.0\r\n * @filesource\r\n */\r\ndefined('BASEPATH') OR exit('No direct script access allowed');\r\n\r\n/**\r\n * File Uploading Class\r\n *\r\n * @package\t\tCodeIgniter\r\n * @subpackage\tLibraries\r\n * @category\tUploads\r\n * @author\t\tEllisLab Dev Team\r\n * @link\t\thttps://codeigniter.com/userguide3/libraries/file_uploading.html\r\n */\r\nclass CI_Upload {\r\n\r\n\t/**\r\n\t * Maximum file size\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $max_size\t\t= 0;\r\n\r\n\t/**\r\n\t * Maximum image width\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $max_width\t\t= 0;\r\n\r\n\t/**\r\n\t * Maximum image height\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $max_height\t\t= 0;\r\n\r\n\t/**\r\n\t * Minimum image width\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $min_width\t\t= 0;\r\n\r\n\t/**\r\n\t * Minimum image height\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $min_height\t\t= 0;\r\n\r\n\t/**\r\n\t * Maximum filename length\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $max_filename\t\t= 0;\r\n\r\n\t/**\r\n\t * Maximum duplicate filename increment ID\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $max_filename_increment\t= 100;\r\n\r\n\t/**\r\n\t * Allowed file types\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $allowed_types\t\t= '';\r\n\r\n\t/**\r\n\t * File type\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $file_type\t\t= '';\r\n\r\n\t/**\r\n\t * File size\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $file_size\t\t= NULL;\r\n\r\n\t/**\r\n\t * File temp path\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $file_temp\t\t= NULL;\r\n\r\n\t/**\r\n\t * Filename\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $file_name\t\t= NULL;\r\n\r\n\t/**\r\n\t * Original filename\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $orig_name\t\t= NULL;\r\n\r\n\t/**\r\n\t * File extension\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $file_ext\t\t= NULL;\r\n\r\n\t/**\r\n\t * Upload path\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $upload_path\t\t= NULL;\r\n\r\n\t/**\r\n\t * Overwrite flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $overwrite\t\t= FALSE;\r\n\r\n\t/**\r\n\t * Obfuscate filename flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $encrypt_name\t\t= FALSE;\r\n\r\n\t/**\r\n\t * Is image flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $is_image\t\t= FALSE;\r\n\r\n\t/**\r\n\t * Image width\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $image_width\t\t= NULL;\r\n\r\n\t/**\r\n\t * Image height\r\n\t *\r\n\t * @var\tint\r\n\t */\r\n\tpublic $image_height\t\t= NULL;\r\n\r\n\t/**\r\n\t * Image type\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $image_type\t\t= NULL;\r\n\r\n\t/**\r\n\t * Image size string\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $image_size_str\t\t= NULL;\r\n\r\n\t/**\r\n\t * Error messages list\r\n\t *\r\n\t * @var\tarray\r\n\t */\r\n\tpublic $error_msg\t\t= array();\r\n\r\n\t/**\r\n\t * Remove spaces flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $remove_spaces\t\t= TRUE;\r\n\r\n\t/**\r\n\t * MIME detection flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $detect_mime\t\t= TRUE;\r\n\r\n\t/**\r\n\t * XSS filter flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $xss_clean\t\t= FALSE;\r\n\r\n\t/**\r\n\t * Apache mod_mime fix flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $mod_mime_override\t= TRUE;\r\n\r\n\t/**\r\n\t * File extension lowercase flag\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $file_ext_tolower\t= FALSE;\r\n\r\n\t/**\r\n\t * Temporary filename\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tpublic $temp_prefix\t\t= 'temp_file_';\r\n\r\n\t/**\r\n\t * Filename sent by the client\r\n\t *\r\n\t * @var\tbool\r\n\t */\r\n\tpublic $client_name\t\t= NULL;\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Filename override\r\n\t *\r\n\t * @var\tstring\r\n\t */\r\n\tprotected $_file_name_override\t= '';\r\n\r\n\t/**\r\n\t * MIME types list\r\n\t *\r\n\t * @var\tarray\r\n\t */\r\n\tprotected $_mimes\t\t= array();\r\n\r\n\t/**\r\n\t * CI Singleton\r\n\t *\r\n\t * @var\tobject\r\n\t */\r\n\tprotected $_CI;\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Constructor\r\n\t *\r\n\t * @param\tarray\t$config\r\n\t * @return\tvoid\r\n\t */\r\n\tpublic function __construct($config = array())\r\n\t{\r\n\t\t$this->_mimes =& get_mimes();\r\n\t\t$this->_CI =& get_instance();\r\n\r\n\t\tempty($config) OR $this->initialize($config, FALSE);\r\n\r\n\t\tlog_message('info', 'Upload Class Initialized');\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Initialize preferences\r\n\t *\r\n\t * @param\tarray\t$config\r\n\t * @param\tbool\t$reset\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function initialize(array $config = array(), $reset = TRUE)\r\n\t{\r\n\t\t$reflection = new ReflectionClass($this);\r\n\r\n\t\tif ($reset === TRUE)\r\n\t\t{\r\n\t\t\t$defaults = $reflection->getDefaultProperties();\r\n\t\t\tforeach (array_keys($defaults) as $key)\r\n\t\t\t{\r\n\t\t\t\tif ($key[0] === '_')\r\n\t\t\t\t{\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isset($config[$key]))\r\n\t\t\t\t{\r\n\t\t\t\t\tif ($reflection->hasMethod('set_'.$key))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$this->{'set_'.$key}($config[$key]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$this->$key = $config[$key];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->$key = $defaults[$key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tforeach ($config as $key => &$value)\r\n\t\t\t{\r\n\t\t\t\tif ($key[0] !== '_' && $reflection->hasProperty($key))\r\n\t\t\t\t{\r\n\t\t\t\t\tif ($reflection->hasMethod('set_'.$key))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$this->{'set_'.$key}($value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$this->$key = $value;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// if a file_name was provided in the config, use it instead of the user input\r\n\t\t// supplied file name for all uploads until initialized again\r\n\t\t$this->_file_name_override = $this->file_name;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Perform the file upload\r\n\t *\r\n\t * @param\tstring\t$field\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function do_upload($field = 'userfile')\r\n\t{\r\n\t\t// Is $_FILES[$field] set? If not, no reason to continue.\r\n\t\tif (empty($_FILES[$field]['name']))\r\n\t\t{\r\n\t\t\t$this->set_error('upload_no_file_selected');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// Is the upload path valid?\r\n\t\tif ( ! $this->validate_upload_path())\r\n\t\t{\r\n\t\t\t// errors will already be set by validate_upload_path() so just return FALSE\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// Was the file able to be uploaded? If not, determine the reason why.\r\n\t\tif ( ! is_uploaded_file($_FILES[$field]['tmp_name']))\r\n\t\t{\r\n\t\t\t$error = isset($_FILES[$field]['error']) ? $_FILES[$field]['error'] : 4;\r\n\r\n\t\t\tswitch ($error)\r\n\t\t\t{\r\n\t\t\t\tcase UPLOAD_ERR_INI_SIZE:\r\n\t\t\t\t\t$this->set_error('upload_file_exceeds_limit');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase UPLOAD_ERR_FORM_SIZE:\r\n\t\t\t\t\t$this->set_error('upload_file_exceeds_form_limit');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase UPLOAD_ERR_PARTIAL:\r\n\t\t\t\t\t$this->set_error('upload_file_partial');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase UPLOAD_ERR_NO_FILE:\r\n\t\t\t\t\t$this->set_error('upload_no_file_selected');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase UPLOAD_ERR_NO_TMP_DIR:\r\n\t\t\t\t\t$this->set_error('upload_no_temp_directory');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase UPLOAD_ERR_CANT_WRITE:\r\n\t\t\t\t\t$this->set_error('upload_unable_to_write_file');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase UPLOAD_ERR_EXTENSION:\r\n\t\t\t\t\t$this->set_error('upload_stopped_by_extension');\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\t$this->set_error('upload_no_file_selected');\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// Set the uploaded data as class variables\r\n\t\t$this->file_temp = $_FILES[$field]['tmp_name'];\r\n\t\t$this->file_size = $_FILES[$field]['size'];\r\n\r\n\t\t// Skip MIME type detection?\r\n\t\tif ($this->detect_mime !== FALSE)\r\n\t\t{\r\n\t\t\t$this->_file_mime_type($_FILES[$field]);\r\n\t\t}\r\n\r\n\t\t$this->file_type = preg_replace('/^(.+?);.*$/', '\\\\1', $this->file_type);\r\n\t\t$this->file_type = strtolower(trim(stripslashes($this->file_type), '\"'));\r\n\t\t$this->file_name = $this->_prep_filename($_FILES[$field]['name']);\r\n\t\t$this->file_ext\t = $this->get_extension($this->file_name);\r\n\t\t$this->client_name = $this->file_name;\r\n\r\n\t\t// Is the file type allowed to be uploaded?\r\n\t\tif ( ! $this->is_allowed_filetype())\r\n\t\t{\r\n\t\t\t$this->set_error('upload_invalid_filetype', 'debug');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// if we're overriding, let's now make sure the new name and type is allowed\r\n\t\tif ($this->_file_name_override !== '')\r\n\t\t{\r\n\t\t\t$this->file_name = $this->_prep_filename($this->_file_name_override);\r\n\r\n\t\t\t// If no extension was provided in the file_name config item, use the uploaded one\r\n\t\t\tif (strpos($this->_file_name_override, '.') === FALSE)\r\n\t\t\t{\r\n\t\t\t\t$this->file_name .= $this->file_ext;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t// An extension was provided, let's have it!\r\n\t\t\t\t$this->file_ext\t= $this->get_extension($this->_file_name_override);\r\n\t\t\t}\r\n\r\n\t\t\tif ( ! $this->is_allowed_filetype(TRUE))\r\n\t\t\t{\r\n\t\t\t\t$this->set_error('upload_invalid_filetype', 'debug');\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Convert the file size to kilobytes\r\n\t\tif ($this->file_size > 0)\r\n\t\t{\r\n\t\t\t$this->file_size = round($this->file_size/1024, 2);\r\n\t\t}\r\n\r\n\t\t// Is the file size within the allowed maximum?\r\n\t\tif ( ! $this->is_allowed_filesize())\r\n\t\t{\r\n\t\t\t$this->set_error('upload_invalid_filesize');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// Are the image dimensions within the allowed size?\r\n\t\t// Note: This can fail if the server has an open_basdir restriction.\r\n\t\tif ( ! $this->is_allowed_dimensions())\r\n\t\t{\r\n\t\t\t$this->set_error('upload_invalid_dimensions');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// Sanitize the file name for security\r\n\t\t$this->file_name = $this->_CI->security->sanitize_filename($this->file_name);\r\n\r\n\t\t// Truncate the file name if it's too long\r\n\t\tif ($this->max_filename > 0)\r\n\t\t{\r\n\t\t\t$this->file_name = $this->_limit_filename_length($this->file_name, $this->max_filename);\r\n\t\t}\r\n\r\n\t\t// Remove white spaces in the name\r\n\t\tif ($this->remove_spaces === TRUE)\r\n\t\t{\r\n\t\t\t$this->file_name = preg_replace('/\\s+/', '_', $this->file_name);\r\n\t\t}\r\n\r\n\t\tif ($this->file_ext_tolower && ($ext = strtolower($this->file_ext)) !== $this->file_ext)\r\n\t\t{\r\n\t\t\t$this->file_name = substr($this->file_name, 0, -strlen($this->file_ext)).$ext;\r\n\t\t\t$this->file_ext = $ext;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\t * Validate the file name\r\n\t\t * This function appends an number onto the end of\r\n\t\t * the file if one with the same name already exists.\r\n\t\t * If it returns false there was a problem.\r\n\t\t */\r\n\t\t$this->orig_name = $this->file_name;\r\n\r\n\t\tif (FALSE === ($this->file_name = $this->set_filename($this->upload_path, $this->file_name)))\r\n\t\t{\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\t * Run the file through the XSS hacking attempt filter\r\n\t\t * This helps prevent malicious code from being\r\n\t\t * embedded within a file. Scripts can easily\r\n\t\t * be disguised as images or other file types.\r\n\t\t */\r\n\t\tif ($this->xss_clean === TRUE && $this->do_xss_clean() === FALSE)\r\n\t\t{\r\n\t\t\t$this->set_error('upload_unable_to_write_file', 'debug');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\t * Move the file to the final destination\r\n\t\t * To deal with different server configurations\r\n\t\t * we'll attempt to use copy() first. If that fails\r\n\t\t * we'll use move_uploaded_file(). One of the two should\r\n\t\t * reliably work in most environments\r\n\t\t */\r\n\t\tif ( ! @copy($this->file_temp, $this->upload_path.$this->file_name))\r\n\t\t{\r\n\t\t\tif ( ! @move_uploaded_file($this->file_temp, $this->upload_path.$this->file_name))\r\n\t\t\t{\r\n\t\t\t\t$this->set_error('upload_destination_error', 'debug');\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\t * Set the finalized image dimensions\r\n\t\t * This sets the image width/height (assuming the\r\n\t\t * file was an image). We use this information\r\n\t\t * in the \"data\" function.\r\n\t\t */\r\n\t\t$this->set_image_properties($this->upload_path.$this->file_name);\r\n\r\n\t\treturn TRUE;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Finalized Data Array\r\n\t *\r\n\t * Returns an associative array containing all of the information\r\n\t * related to the upload, allowing the developer easy access in one array.\r\n\t *\r\n\t * @param\tstring\t$index\r\n\t * @return\tmixed\r\n\t */\r\n\tpublic function data($index = NULL)\r\n\t{\r\n\t\t$data = array(\r\n\t\t\t'file_name'\t\t=> $this->file_name,\r\n\t\t\t'file_type'\t\t=> $this->file_type,\r\n\t\t\t'file_path'\t\t=> $this->upload_path,\r\n\t\t\t'full_path'\t\t=> $this->upload_path.$this->file_name,\r\n\t\t\t'raw_name'\t\t=> str_replace($this->file_ext, '', $this->file_name),\r\n\t\t\t'orig_name'\t\t=> $this->orig_name,\r\n\t\t\t'client_name'\t\t=> $this->client_name,\r\n\t\t\t'file_ext'\t\t=> $this->file_ext,\r\n\t\t\t'file_size'\t\t=> $this->file_size,\r\n\t\t\t'is_image'\t\t=> $this->is_image(),\r\n\t\t\t'image_width'\t\t=> $this->image_width,\r\n\t\t\t'image_height'\t\t=> $this->image_height,\r\n\t\t\t'image_type'\t\t=> $this->image_type,\r\n\t\t\t'image_size_str'\t=> $this->image_size_str,\r\n\t\t);\r\n\r\n\t\tif ( ! empty($index))\r\n\t\t{\r\n\t\t\treturn isset($data[$index]) ? $data[$index] : NULL;\r\n\t\t}\r\n\r\n\t\treturn $data;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Upload Path\r\n\t *\r\n\t * @param\tstring\t$path\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_upload_path($path)\r\n\t{\r\n\t\t// Make sure it has a trailing slash\r\n\t\t$this->upload_path = rtrim($path, '/').'/';\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set the file name\r\n\t *\r\n\t * This function takes a filename/path as input and looks for the\r\n\t * existence of a file with the same name. If found, it will append a\r\n\t * number to the end of the filename to avoid overwriting a pre-existing file.\r\n\t *\r\n\t * @param\tstring\t$path\r\n\t * @param\tstring\t$filename\r\n\t * @return\tstring\r\n\t */\r\n\tpublic function set_filename($path, $filename)\r\n\t{\r\n\t\tif ($this->encrypt_name === TRUE)\r\n\t\t{\r\n\t\t\t$filename = md5(uniqid(mt_rand())).$this->file_ext;\r\n\t\t}\r\n\r\n\t\tif ($this->overwrite === TRUE OR ! file_exists($path.$filename))\r\n\t\t{\r\n\t\t\treturn $filename;\r\n\t\t}\r\n\r\n\t\t$filename = str_replace($this->file_ext, '', $filename);\r\n\t\t$new_filename = '';\r\n\t\tfor ($i = 1; $i < $this->max_filename_increment; $i++)\r\n\t\t{\r\n\t\t\tif ( ! file_exists($path.$filename.$i.$this->file_ext))\r\n\t\t\t{\r\n\t\t\t\t$new_filename = $filename.$i.$this->file_ext;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($new_filename === '')\r\n\t\t{\r\n\t\t\t$this->set_error('upload_bad_filename', 'debug');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\treturn $new_filename;\r\n\t\t}\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Maximum File Size\r\n\t *\r\n\t * @param\tint\t$n\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_max_filesize($n)\r\n\t{\r\n\t\t$this->max_size = (int) $n;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Maximum File Name Length\r\n\t *\r\n\t * @param\tint\t$n\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_max_filename($n)\r\n\t{\r\n\t\t$this->max_filename = (int) $n;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Maximum Image Width\r\n\t *\r\n\t * @param\tint\t$n\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_max_width($n)\r\n\t{\r\n\t\t$this->max_width = (int) $n;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Maximum Image Height\r\n\t *\r\n\t * @param\tint\t$n\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_max_height($n)\r\n\t{\r\n\t\t$this->max_height = (int) $n;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Minimum Image Width\r\n\t *\r\n\t * @param\tint\t$n\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_min_width($n)\r\n\t{\r\n\t\t$this->min_width = (int) $n;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Minimum Image Height\r\n\t *\r\n\t * @param\tint\t$n\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_min_height($n)\r\n\t{\r\n\t\t$this->min_height = (int) $n;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Allowed File Types\r\n\t *\r\n\t * @param\tmixed\t$types\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_allowed_types($types)\r\n\t{\r\n\t\t$this->allowed_types = (is_array($types)) ? implode('|', $types) : $types;\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set Image Properties\r\n\t *\r\n\t * Uses GD to determine the width/height/type of image\r\n\t *\r\n\t * @param\tstring\t$path\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_image_properties($path = '')\r\n\t{\r\n\t\tif ($this->is_image() && function_exists('getimagesize'))\r\n\t\t{\r\n\t\t\tif (FALSE !== ($D = @getimagesize($path)))\r\n\t\t\t{\r\n\t\t\t\t$types = array(1 => 'gif', 2 => 'jpeg', 3 => 'png');\r\n\r\n\t\t\t\t$this->image_width\t= $D[0];\r\n\t\t\t\t$this->image_height\t= $D[1];\r\n\t\t\t\t$this->image_type\t= isset($types[$D[2]]) ? $types[$D[2]] : 'unknown';\r\n\t\t\t\t$this->image_size_str\t= $D[3]; // string containing height and width\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set XSS Clean\r\n\t *\r\n\t * Enables the XSS flag so that the file that was uploaded\r\n\t * will be run through the XSS filter.\r\n\t *\r\n\t * @param\tbool\t$flag\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_xss_clean($flag = FALSE)\r\n\t{\r\n\t\t$this->xss_clean = ($flag === TRUE);\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Validate the image\r\n\t *\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function is_image()\r\n\t{\r\n\t\t// IE will sometimes return odd mime-types during upload, so here we just standardize all\r\n\t\t// jpegs or pngs to the same file type.\r\n\r\n\t\t$png_mimes  = array('image/x-png');\r\n\t\t$jpeg_mimes = array('image/jpg', 'image/jpe', 'image/jpeg', 'image/pjpeg');\r\n\r\n\t\tif (in_array($this->file_type, $png_mimes))\r\n\t\t{\r\n\t\t\t$this->file_type = 'image/png';\r\n\t\t}\r\n\t\telseif (in_array($this->file_type, $jpeg_mimes))\r\n\t\t{\r\n\t\t\t$this->file_type = 'image/jpeg';\r\n\t\t}\r\n\r\n\t\t$img_mimes = array(\r\n\t\t\t'image/gif',\r\n\t\t\t'image/jpeg',\r\n\t\t\t'image/png',\r\n\t\t);\r\n\r\n\t\treturn in_array($this->file_type, $img_mimes, TRUE);\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Verify that the filetype is allowed\r\n\t *\r\n\t * @param\tbool\t$ignore_mime\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function is_allowed_filetype($ignore_mime = FALSE)\r\n\t{\r\n\t\tif (empty($this->allowed_types) OR $this->allowed_types === '*')\r\n\t\t{\r\n\t\t\treturn TRUE;\r\n\t\t}\r\n\r\n\t\tif ( ! is_array($this->allowed_types))\r\n\t\t{\r\n\t\t\t$this->allowed_types = explode('|', $this->allowed_types);\r\n\t\t}\r\n\r\n\t\t$ext = strtolower(ltrim($this->file_ext, '.'));\r\n\t\tif ( ! in_array($ext, $this->allowed_types, TRUE))\r\n\t\t{\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t// Images get some additional checks\r\n\t\tif (in_array($ext, array('gif', 'jpg', 'jpeg', 'jpe', 'png'), TRUE) && @getimagesize($this->file_temp) === FALSE)\r\n\t\t{\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\tif ($ignore_mime === TRUE)\r\n\t\t{\r\n\t\t\treturn TRUE;\r\n\t\t}\r\n\r\n\t\tif (isset($this->_mimes[$ext]))\r\n\t\t{\r\n\t\t\treturn is_array($this->_mimes[$ext])\r\n\t\t\t\t? in_array($this->file_type, $this->_mimes[$ext], TRUE)\r\n\t\t\t\t: ($this->_mimes[$ext] === $this->file_type);\r\n\t\t}\r\n\r\n\t\treturn FALSE;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Verify that the file is within the allowed size\r\n\t *\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function is_allowed_filesize()\r\n\t{\r\n\t\treturn ($this->max_size === 0 OR $this->max_size > $this->file_size);\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Verify that the image is within the allowed width/height\r\n\t *\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function is_allowed_dimensions()\r\n\t{\r\n\t\tif ( ! $this->is_image())\r\n\t\t{\r\n\t\t\treturn TRUE;\r\n\t\t}\r\n\r\n\t\tif (function_exists('getimagesize'))\r\n\t\t{\r\n\t\t\t$D = @getimagesize($this->file_temp);\r\n\r\n\t\t\tif ($this->max_width > 0 && $D[0] > $this->max_width)\r\n\t\t\t{\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\r\n\t\t\tif ($this->max_height > 0 && $D[1] > $this->max_height)\r\n\t\t\t{\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\r\n\t\t\tif ($this->min_width > 0 && $D[0] < $this->min_width)\r\n\t\t\t{\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\r\n\t\t\tif ($this->min_height > 0 && $D[1] < $this->min_height)\r\n\t\t\t{\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn TRUE;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Validate Upload Path\r\n\t *\r\n\t * Verifies that it is a valid upload path with proper permissions.\r\n\t *\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function validate_upload_path()\r\n\t{\r\n\t\tif ($this->upload_path === '')\r\n\t\t{\r\n\t\t\t$this->set_error('upload_no_filepath', 'debug');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\tif (realpath($this->upload_path) !== FALSE)\r\n\t\t{\r\n\t\t\t$this->upload_path = str_replace('\\\\', '/', realpath($this->upload_path));\r\n\t\t}\r\n\r\n\t\tif ( ! is_dir($this->upload_path))\r\n\t\t{\r\n\t\t\t$this->set_error('upload_no_filepath', 'debug');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\tif ( ! is_really_writable($this->upload_path))\r\n\t\t{\r\n\t\t\t$this->set_error('upload_not_writable', 'debug');\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\t$this->upload_path = preg_replace('/(.+?)\\/*$/', '\\\\1/',  $this->upload_path);\r\n\t\treturn TRUE;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Extract the file extension\r\n\t *\r\n\t * @param\tstring\t$filename\r\n\t * @return\tstring\r\n\t */\r\n\tpublic function get_extension($filename)\r\n\t{\r\n\t\t$x = explode('.', $filename);\r\n\r\n\t\tif (count($x) === 1)\r\n\t\t{\r\n\t\t\treturn '';\r\n\t\t}\r\n\r\n\t\t$ext = ($this->file_ext_tolower) ? strtolower(end($x)) : end($x);\r\n\t\treturn '.'.$ext;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Clean the file name for security\r\n\t *\r\n\t * @param\tstring\t$filename\r\n\t * @return\tstring\r\n\t */\r\n\tpublic function _prep_filename($filename)\r\n\t{\r\n\t\tif ($this->mod_mime_override === FALSE OR preg_match('/\\.(?:php|pl|py|cgi|asp|js)(\\.|$)/i', $filename) === 0)\r\n\t\t{\r\n\t\t\treturn $filename;\r\n\t\t}\r\n\r\n\t\t$parts\t\t= explode('.', $filename);\r\n\t\t$ext\t\t= array_pop($parts);\r\n\t\t$filename\t= array_shift($parts);\r\n\r\n\t\tforeach ($parts as $part)\r\n\t\t{\r\n\t\t\tif ( ! empty($part) && ! ctype_alnum($part))\r\n\t\t\t{\r\n\t\t\t\t$filename .= '.'.$part.'_';\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$filename .= '.'.$part;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$filename .= '.'.$ext;\r\n\r\n\t\treturn $filename;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Limit the File Name Length\r\n\t *\r\n\t * @param\tstring\t$filename\r\n\t * @param\tint\t$length\r\n\t * @return\tstring\r\n\t */\r\n\tpublic function _limit_filename_length($filename, $length)\r\n\t{\r\n\t\tif (strlen($filename) < $length)\r\n\t\t{\r\n\t\t\treturn $filename;\r\n\t\t}\r\n\r\n\t\t$ext = '';\r\n\t\tif (strpos($filename, '.') !== FALSE)\r\n\t\t{\r\n\t\t\t$parts\t\t= explode('.', $filename);\r\n\t\t\t$ext\t\t= '.'.array_pop($parts);\r\n\t\t\t$filename\t= implode('.', $parts);\r\n\t\t}\r\n\r\n\t\treturn substr($filename, 0, ($length - strlen($ext))).$ext;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Runs the file through the XSS clean function\r\n\t *\r\n\t * This prevents people from embedding malicious code in their files.\r\n\t * I'm not sure that it won't negatively affect certain files in unexpected ways,\r\n\t * but so far I haven't found that it causes trouble.\r\n\t *\r\n\t * @return\tbool\r\n\t */\r\n\tpublic function do_xss_clean()\r\n\t{\r\n\t\t$file = $this->file_temp;\r\n\r\n\t\tif (filesize($file) == 0)\r\n\t\t{\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\tif (memory_get_usage() && ($memory_limit = ini_get('memory_limit')) != '')\r\n\t\t{\r\n\t\t\t$memory_limit = str_split($memory_limit, -1);\r\n\t\t\t$allowed_memory = 1024 * 1024;\r\n\r\n\t\t\tif (strtoupper($memory_limit[1]) == 'M')\r\n\t\t\t{\r\n\t\t\t\t$allowed_memory = 1024 * 1024 * (int) $memory_limit[0];\r\n\t\t\t}\r\n\t\t\telseif (strtoupper($memory_limit[1]) == 'G')\r\n\t\t\t{\r\n\t\t\t\t$allowed_memory = 1024 * 1024 * 1024 * (int) $memory_limit[0];\r\n\t\t\t}\r\n\r\n\t\t\tif (filesize($file) > $allowed_memory)\r\n\t\t\t{\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (function_exists('getimagesize') && @getimagesize($file) !== FALSE)\r\n\t\t{\r\n\t\t\tif (($file = @fopen($file, 'rb')) === FALSE) // \"b\" to force binary\r\n\t\t\t{\r\n\t\t\t\treturn FALSE; // Couldn't open the file, return FALSE\r\n\t\t\t}\r\n\r\n\t\t\t$opening_bytes = fread($file, 256);\r\n\t\t\tfclose($file);\r\n\r\n\t\t\t// These are known to throw IE into mime-type detection chaos\r\n\t\t\t// <a, <body, <head, <html, <img, <plaintext, <pre, <script, <table, <title\r\n\t\t\t// title is basically just in SVG, but we filter it anyhow\r\n\r\n\t\t\tif ( ! preg_match('/<(a|body|head|html|img|plaintext|pre|script|table|title)[\\s>]/i', $opening_bytes))\r\n\t\t\t{\r\n\t\t\t\treturn TRUE; // its an image, no \"triggers\" detected in the first 256 bytes, we're good\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\treturn FALSE;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (($data = @file_get_contents($file)) === FALSE)\r\n\t\t{\r\n\t\t\treturn FALSE;\r\n\t\t}\r\n\r\n\t\treturn $this->_CI->security->xss_clean($data, TRUE);\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set an error message\r\n\t *\r\n\t * @param\tstring\t$msg\r\n\t * @param\tstring\t$log_level\r\n\t * @return\tCI_Upload\r\n\t */\r\n\tpublic function set_error($msg, $log_level = 'error')\r\n\t{\r\n\t\t$this->_CI->lang->load('upload');\r\n\r\n\t\tif (is_array($msg))\r\n\t\t{\r\n\t\t\tforeach ($msg as $val)\r\n\t\t\t{\r\n\t\t\t\t$msg = ($this->_CI->lang->line($val) === FALSE) ? $val : $this->_CI->lang->line($val);\r\n\t\t\t\t$this->error_msg[] = $msg;\r\n\t\t\t\tlog_message($log_level, $msg);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$msg = ($this->_CI->lang->line($msg) === FALSE) ? $msg : $this->_CI->lang->line($msg);\r\n\t\t\t$this->error_msg[] = $msg;\r\n\t\t\tlog_message($log_level, $msg);\r\n\t\t}\r\n\r\n\t\treturn $this;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Display the error message\r\n\t *\r\n\t * @param\tstring\t$open\r\n\t * @param\tstring\t$close\r\n\t * @return\tstring\r\n\t */\r\n\tpublic function display_errors($open = '<p>', $close = '</p>')\r\n\t{\r\n\t\treturn (count($this->error_msg) > 0) ? $open.implode($close.$open, $this->error_msg).$close : '';\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * List of Error Messages\r\n\t *\r\n\t * @return\tarray\r\n\t */\r\n\tpublic function get_error_msg()\r\n\t{\r\n\t\treturn $this->error_msg;\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------\r\n\r\n\t/**\r\n\t * Set MIME type\r\n\t *\r\n\t * @param\tarray\t$file\r\n\t * @return\tvoid\r\n\t */\r\n\tprotected function _file_mime_type($file)\r\n\t{\r\n\t\t// Use if the Fileinfo extension, if available (only reliable method)\r\n\t\tif (function_exists('finfo_file'))\r\n\t\t{\r\n\t\t\t$finfo = @finfo_open(FILEINFO_MIME);\r\n\t\t\tif (is_resource($finfo)) // It is possible that a FALSE value is returned, if there is no magic MIME database file found on the system\r\n\t\t\t{\r\n\t\t\t\t$mime = @finfo_file($finfo, $file['tmp_name']);\r\n\t\t\t\tfinfo_close($finfo);\r\n\r\n\t\t\t\t/* According to the comments section of the PHP manual page,\r\n\t\t\t\t * it is possible that this function returns an empty string\r\n\t\t\t\t * for some files (e.g. if they don't exist in the magic MIME database)\r\n\t\t\t\t */\r\n\t\t\t\tif (is_string($mime) && preg_match('/^([a-z\\-]+\\/[a-z0-9\\-\\.\\+]+)(;\\s.+)?$/', $mime, $matches))\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->file_type = $matches[1];\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t/* This is an ugly hack, but UNIX-type systems provide a \"native\" way to detect the file type,\r\n\t\t * which is still more secure than depending on the value of $_FILES[$field]['type'], and as it\r\n\t\t * was reported in issue #750 (https://github.com/EllisLab/CodeIgniter/issues/750) - it's better\r\n\t\t * than mime_content_type() as well, hence the attempts to try calling the command line with\r\n\t\t * three different functions.\r\n\t\t *\r\n\t\t * Notes:\r\n\t\t *\t- the DIRECTORY_SEPARATOR comparison ensures that we're not on a Windows system\r\n\t\t *\t- many system admins would block the exec(), shell_exec(), popen() and similar functions\r\n\t\t *\t  (we can't know if any of them are available) for security reasons; hence the debug_mode check\r\n\t\t *\t- 'file' is a UNIX command, not available on Windows\r\n\t\t *\t- the '-b' switch would print only the MIME type, omitting the original file name\r\n\t\t *\t- the '-i' switch would print the MIME type in RFC 2045 format (e.g. 'text/plain; charset=us-ascii')\r\n\t\t *\t- the manual page says that both '-b' and '-i' switches are available since file version 3.27\r\n\t\t *\t- we assume that the hosting provider has applied the latest security patches and\r\n\t\t *\t  that we can trust the file utility\r\n\t\t */\r\n\t\tif (DIRECTORY_SEPARATOR !== '\\\\')\r\n\t\t{\r\n\t\t\t$cmd = 'file --brief --mime ' . escapeshellarg($file['tmp_name']) . ' 2>&1';\r\n\r\n\t\t\tif (function_exists('exec'))\r\n\t\t\t{\r\n\t\t\t\t/* This might look confusing, as $mime is being populated with all of the output when set in the second parameter.\r\n\t\t\t\t * However, we only need the first line, which is the actual return value of exec(), and as such - it overwrites\r\n\t\t\t\t * anything that could already be set for $mime previously. This effectively makes the second parameter pointless,\r\n\t\t\t\t * but we're leaving it in order to be consistent with the other calls.\r\n\t\t\t\t */\r\n\t\t\t\t$mime = @exec($cmd, $mime, $return_status);\r\n\t\t\t\tif ($return_status === 0 && is_string($mime) && preg_match('/^([a-z\\-]+\\/[a-z0-9\\-\\.\\+]+)(;\\s.+)?$/', $mime, $matches))\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->file_type = $matches[1];\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ( (bool) @ini_get('safe_mode') === FALSE && function_exists('shell_exec'))\r\n\t\t\t{\r\n\t\t\t\t$mime = @shell_exec($cmd);\r\n\t\t\t\tif (strlen($mime) > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$mime = explode(\"\\n\", trim($mime));\r\n\t\t\t\t\tif (preg_match('/^([a-z\\-]+\\/[a-z0-9\\-\\.\\+]+)(;\\s.+)?$/', $mime[(count($mime) - 1)], $matches))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$this->file_type = $matches[1];\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (function_exists('popen'))\r\n\t\t\t{\r\n\t\t\t\t$proc = @popen($cmd, 'r');\r\n\t\t\t\tif (is_resource($proc))\r\n\t\t\t\t{\r\n\t\t\t\t\t$mime = @fread($proc, 512);\r\n\t\t\t\t\t@pclose($proc);\r\n\t\t\t\t\tif ($mime !== FALSE)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$mime = explode(\"\\n\", trim($mime));\r\n\t\t\t\t\t\tif (preg_match('/^([a-z\\-]+\\/[a-z0-9\\-\\.\\+]+)(;\\s.+)?$/', $mime[(count($mime) - 1)], $matches))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$this->file_type = $matches[1];\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Fall back to mime_content_type(), if available (still better than $_FILES[$field]['type'])\r\n\t\tif (function_exists('mime_content_type'))\r\n\t\t{\r\n\t\t\t$this->file_type = @mime_content_type($file['tmp_name']);\r\n\t\t\tif (strlen($this->file_type) > 0) // It's possible that mime_content_type() returns FALSE or an empty string\r\n\t\t\t{\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$this->file_type = $file['type'];\r\n\t}\r\n\r\n}"
        }
    ]
}