{
    "sourceFile": "stok_gorsel_yukle_endpoint.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1757160318871,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1757160318871,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Stok Görsel Yükleme Endpoint\r\n * Direkt endpoint olarak çalışır\r\n */\r\n\r\n// Enable error reporting for debugging but not in output\r\nerror_reporting(E_ALL);\r\nini_set('display_errors', 0);\r\nini_set('log_errors', 1);\r\n\r\n// CORS headers\r\nheader('Content-Type: application/json; charset=utf-8');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: GET, POST, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\n// OPTIONS request handling\r\nif ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\n// CodeIgniter framework yükle\r\ndefine('BASEPATH', __DIR__ . '/system/');\r\ndefine('ENVIRONMENT', 'production');\r\n\r\n// Database config dosyasını dahil et\r\n$db = [];\r\ninclude(__DIR__ . '/application/config/database.php');\r\n\r\n// Database bağlantısı oluştur\r\ntry {\r\n    $connection = new mysqli(\r\n        $db['default']['hostname'],\r\n        $db['default']['username'], \r\n        $db['default']['password'],\r\n        $db['default']['database']\r\n    );\r\n    \r\n    if ($connection->connect_error) {\r\n        throw new Exception(\"Database connection failed: \" . $connection->connect_error);\r\n    }\r\n    \r\n    $connection->set_charset('utf8');\r\n    \r\n} catch (Exception $e) {\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Database bağlantı hatası: ' . $e->getMessage()\r\n    ], JSON_UNESCAPED_UNICODE);\r\n    exit();\r\n}\r\n\r\ntry {\r\n    // Debug log\r\n    file_put_contents(__DIR__ . '/debug_file_upload.log', \r\n        date('Y-m-d H:i:s') . \" - Upload started - POST: \" . print_r($_POST, true) . \" FILES: \" . print_r($_FILES, true) . \"\\n\", \r\n        FILE_APPEND | LOCK_EX);\r\n    \r\n    $satisStok_id = isset($_POST['satisStok_id']) ? trim($_POST['satisStok_id']) : '';\r\n    $stok_adi = isset($_POST['stok_adi']) ? trim($_POST['stok_adi']) : '';\r\n    \r\n    if (!$satisStok_id) {\r\n        echo json_encode(['success' => false, 'message' => 'Stok ID gerekli']);\r\n        exit();\r\n    }\r\n    \r\n    if (empty($_FILES['stok_gorseller'])) {\r\n        echo json_encode(['success' => false, 'message' => 'Dosya seçilmedi']);\r\n        exit();\r\n    }\r\n    \r\n    // Upload klasörü oluştur\r\n    $upload_path = __DIR__ . '/assets/uploads/stok_gorselleri/';\r\n    if (!is_dir($upload_path)) {\r\n        if (!mkdir($upload_path, 0777, true)) {\r\n            throw new Exception('Upload klasörü oluşturulamadı');\r\n        }\r\n    }\r\n    \r\n    $uploaded_files = [];\r\n    $files = $_FILES['stok_gorseller'];\r\n    \r\n    // Çoklu dosya kontrolü\r\n    if (is_array($files['tmp_name'])) {\r\n        $file_count = count($files['tmp_name']);\r\n        for ($i = 0; $i < $file_count; $i++) {\r\n            if ($files['error'][$i] == UPLOAD_ERR_OK) {\r\n                $tmp_name = $files['tmp_name'][$i];\r\n                $original_name = $files['name'][$i];\r\n                $size = $files['size'][$i];\r\n                \r\n                // Dosya boyutu kontrolü (max 10MB)\r\n                if ($size > 10 * 1024 * 1024) {\r\n                    throw new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n                }\r\n                \r\n                // Dosya tipi kontrolü\r\n                $ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));\r\n                $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n                if (!in_array($ext, $allowed_extensions)) {\r\n                    throw new Exception($original_name . ' dosya tipi desteklenmiyor');\r\n                }\r\n                \r\n                // Dosya adını oluştur\r\n                $filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n                $filepath = $upload_path . $filename;\r\n                \r\n                // Dosyayı yükle\r\n                if (move_uploaded_file($tmp_name, $filepath)) {\r\n                    $uploaded_files[] = $filename;\r\n                    file_put_contents(__DIR__ . '/debug_file_upload.log', \r\n                        date('Y-m-d H:i:s') . \" - File uploaded: \" . $filename . \"\\n\", \r\n                        FILE_APPEND | LOCK_EX);\r\n                } else {\r\n                    throw new Exception($original_name . ' dosyası yüklenemedi');\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        // Tek dosya\r\n        if ($files['error'] == UPLOAD_ERR_OK) {\r\n            $tmp_name = $files['tmp_name'];\r\n            $original_name = $files['name'];\r\n            $size = $files['size'];\r\n            \r\n            if ($size > 10 * 1024 * 1024) {\r\n                throw new Exception($original_name . ' dosyası çok büyük (max 10MB)');\r\n            }\r\n            \r\n            $ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));\r\n            $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf'];\r\n            if (!in_array($ext, $allowed_extensions)) {\r\n                throw new Exception($original_name . ' dosya tipi desteklenmiyor');\r\n            }\r\n            \r\n            $filename = 'stok_' . $satisStok_id . '_' . uniqid() . '.' . $ext;\r\n            $filepath = $upload_path . $filename;\r\n            \r\n            if (move_uploaded_file($tmp_name, $filepath)) {\r\n                $uploaded_files[] = $filename;\r\n            } else {\r\n                throw new Exception($original_name . ' dosyası yüklenemedi');\r\n            }\r\n        }\r\n    }\r\n    \r\n    if (empty($uploaded_files)) {\r\n        throw new Exception('Hiçbir dosya yüklenemedi');\r\n    }\r\n    \r\n    // Mevcut görsel listesini al\r\n    $satisStok_id_escaped = $connection->real_escape_string($satisStok_id);\r\n    $query = \"SELECT satisStok_gorsel FROM satisstok WHERE satisStok_id = '$satisStok_id_escaped'\";\r\n    $result = $connection->query($query);\r\n    \r\n    $current_images = [];\r\n    if ($result && $row = $result->fetch_assoc()) {\r\n        if (!empty($row['satisStok_gorsel'])) {\r\n            $current_images = explode(',', $row['satisStok_gorsel']);\r\n            $current_images = array_filter($current_images);\r\n        }\r\n    }\r\n    \r\n    // Yeni dosyaları ekle\r\n    $all_images = array_merge($current_images, $uploaded_files);\r\n    $image_string = implode(',', $all_images);\r\n    $image_string_escaped = $connection->real_escape_string($image_string);\r\n    \r\n    // Veritabanını güncelle\r\n    $update_query = \"UPDATE satisstok SET satisStok_gorsel = '$image_string_escaped' WHERE satisStok_id = '$satisStok_id_escaped'\";\r\n    $update_result = $connection->query($update_query);\r\n    \r\n    if (!$update_result) {\r\n        throw new Exception('Veritabanı güncellenemedi: ' . $connection->error);\r\n    }\r\n    \r\n    // Debug log\r\n    file_put_contents(__DIR__ . '/debug_file_upload.log', \r\n        date('Y-m-d H:i:s') . \" - Upload successful - Files: \" . print_r($uploaded_files, true) . \"\\n\", \r\n        FILE_APPEND | LOCK_EX);\r\n    \r\n    echo json_encode([\r\n        'success' => true, \r\n        'message' => count($uploaded_files) . ' dosya başarıyla yüklendi',\r\n        'uploaded_files' => $uploaded_files\r\n    ], JSON_UNESCAPED_UNICODE);\r\n    \r\n    $connection->close();\r\n    \r\n} catch (Exception $e) {\r\n    if (isset($connection)) {\r\n        $connection->close();\r\n    }\r\n    \r\n    // Debug log\r\n    file_put_contents(__DIR__ . '/debug_file_upload.log', \r\n        date('Y-m-d H:i:s') . \" - Upload error: \" . $e->getMessage() . \"\\n\", \r\n        FILE_APPEND | LOCK_EX);\r\n    \r\n    echo json_encode([\r\n        'success' => false, \r\n        'message' => $e->getMessage()\r\n    ], JSON_UNESCAPED_UNICODE);\r\n}\r\n?>\r\n"
        }
    ]
}