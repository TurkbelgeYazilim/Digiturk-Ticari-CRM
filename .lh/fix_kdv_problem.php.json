{
    "sourceFile": "fix_kdv_problem.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756560711351,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756560711351,
            "name": "Commit-0",
            "content": "<?php\r\n// KDV problemi düzeltme scripti\r\nheader('Content-Type: text/plain; charset=utf-8');\r\n\r\n$mysqli = new mysqli('localhost', 'ilekasoft_crmuser', 'KaleW356!', 'ilekasoft_crmdb');\r\n$mysqli->set_charset(\"utf8mb4\");\r\n\r\nif ($mysqli->connect_error) {\r\n    die('Connection failed: ' . $mysqli->connect_error);\r\n}\r\n\r\necho \"=== KDV Problemi Düzeltme Scripti ===\\n\\n\";\r\n\r\n// Çok büyük değerlere sahip kayıtları bul (scientific notation sorunlu olanlar)\r\n$query = \"\r\n    SELECT satisStok_id, satisStok_satisFaturasiID, satisStok_miktar, satisStok_birimFiyat, \r\n           satisStok_fiyatMiktar, satisStok_kdv, satisStok_toplam\r\n    FROM satisFaturasiStok \r\n    WHERE satisStok_birimFiyat > 1000000000000000 OR satisStok_fiyatMiktar > 1000000000000000 OR satisStok_toplam > 1000000000000000\r\n    ORDER BY satisStok_satisFaturasiID, satisStok_id\r\n\";\r\n\r\n$result = $mysqli->query($query);\r\nif (!$result) {\r\n    die(\"Sorgu hatası: \" . $mysqli->error);\r\n}\r\n\r\n$problematic_records = [];\r\nwhile ($row = $result->fetch_assoc()) {\r\n    $problematic_records[] = $row;\r\n}\r\n\r\necho \"Problematik kayıt sayısı: \" . count($problematic_records) . \"\\n\\n\";\r\n\r\nif (count($problematic_records) == 0) {\r\n    echo \"Düzeltilecek kayıt bulunamadı.\\n\";\r\n    $mysqli->close();\r\n    exit;\r\n}\r\n\r\n// Düzeltme işlemi\r\necho \"=== Düzeltme İşlemi Başlatılıyor ===\\n\\n\";\r\n\r\n$mysqli->autocommit(false); // Transaction başlat\r\n\r\n$fixed_count = 0;\r\n$error_count = 0;\r\n\r\nforeach ($problematic_records as $record) {\r\n    echo \"Kayıt ID: {$record['satisStok_id']}, Fatura ID: {$record['satisStok_satisFaturasiID']}\\n\";\r\n    echo \"Mevcut BirimFiyat: {$record['satisStok_birimFiyat']}\\n\";\r\n    echo \"Mevcut FiyatMiktar: {$record['satisStok_fiyatMiktar']}\\n\";\r\n    \r\n    // Bu kaydın gerçek değerini tahmin etmeye çalış\r\n    // Eğer scientific notation'da 8.33333E+15 gibi bir değer varsa,\r\n    // muhtemelen KDV dahil 1000 TL gibi normal bir değer olması gerekiyordu\r\n    \r\n    $miktar = floatval($record['satisStok_miktar']);\r\n    $kdv_orani = floatval($record['satisStok_kdv']);\r\n    \r\n    // Bilinen bir pattern: 8.33333E+15 -> muhtemelen 1000 TL KDV dahil\r\n    // Bu durumda birim fiyat 1000 / miktar olmalı\r\n    \r\n    $estimated_total_kdv_dahil = 1000; // Örnek değer, gerçek değer için kullanıcı inputu gerekebilir\r\n    \r\n    // Eğer miktar 1 ise, birim fiyat da bu değer olmalı\r\n    if ($miktar == 1) {\r\n        $new_birim_fiyat_kdv_dahil = $estimated_total_kdv_dahil;\r\n        $new_fiyat_miktar = $estimated_total_kdv_dahil;\r\n        $new_toplam = $estimated_total_kdv_dahil;\r\n    } else {\r\n        // Miktar > 1 ise, toplam tutarı miktara böl\r\n        $new_birim_fiyat_kdv_dahil = $estimated_total_kdv_dahil / $miktar;\r\n        $new_fiyat_miktar = $estimated_total_kdv_dahil;\r\n        $new_toplam = $estimated_total_kdv_dahil;\r\n    }\r\n    \r\n    // Bu kayıt için manuel düzeltme gerekiyor, şimdilik sadece listele\r\n    echo \"Önerilen BirimFiyat: $new_birim_fiyat_kdv_dahil\\n\";\r\n    echo \"Önerilen FiyatMiktar: $new_fiyat_miktar\\n\";\r\n    echo \"Önerilen Toplam: $new_toplam\\n\\n\";\r\n    \r\n    // UYARI: Gerçek düzeltme işlemi için kullanıcının onayı gereklidir\r\n    // Bu script şimdilik sadece listeleme yapacak\r\n}\r\n\r\necho \"=== UYARI ===\\n\";\r\necho \"Gerçek düzeltme işlemi için her kaydın doğru değerini bilmemiz gerekiyor.\\n\";\r\necho \"Lütfen her problemli fatura için doğru tutarları belirleyip manuel düzeltme yapın.\\n\\n\";\r\n\r\necho \"Örnek düzeltme SQL'i:\\n\";\r\necho \"UPDATE satisFaturasiStok SET \\n\";\r\necho \"  satisStok_birimFiyat = 1000,\\n\";\r\necho \"  satisStok_fiyatMiktar = 1000, \\n\";\r\necho \"  satisStok_toplam = 1000\\n\";\r\necho \"WHERE satisStok_id = [kayit_id];\\n\\n\";\r\n\r\n$mysqli->rollback(); // Transaction'ı geri al (hiçbir değişiklik yapma)\r\n$mysqli->close();\r\n\r\necho \"İşlem tamamlandı. Gerçek değişiklik yapılmadı.\\n\";\r\n?>\r\n"
        }
    ]
}