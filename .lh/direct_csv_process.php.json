{
    "sourceFile": "direct_csv_process.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1755002355456,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755004441776,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,8 +95,9 @@\n     $header = fgetcsv($handle, 0, ';');\r\n     echo \"BaÅŸlÄ±k okundu: \" . count($header) . \" sÃ¼tun<br>\";\r\n     \r\n     $processed = 0;\r\n+    $updated = 0;\r\n     $failed = 0;\r\n     $batch_size = 500;\r\n     $batch_data = [];\r\n     \r\n@@ -187,9 +188,71 @@\n             $mysqli->real_escape_string(trim($csv_data['MEMO_SON_DURUM'] ?? '')) . \"','\" .\r\n             $mysqli->real_escape_string(trim($csv_data['MEMO_SON_CEVAP'] ?? '')) . \"','\" .\r\n             $mysqli->real_escape_string(trim($csv_data['MEMO_SON_ACIKLAMA'] ?? '')) . \"',NOW())\";\r\n         \r\n-        $batch_data[] = $insert_values;\r\n+        // memo_id kontrolÃ¼ yap\r\n+        $memo_id = trim($csv_data['MEMO_ID'] ?? '');\r\n+        if (!empty($memo_id)) {\r\n+            // Mevcut kaydÄ± kontrol et\r\n+            $check_sql = \"SELECT id FROM voip_iris_rapor WHERE memo_id = '\" . $mysqli->real_escape_string($memo_id) . \"'\";\r\n+            $check_result = $mysqli->query($check_sql);\r\n+            \r\n+            if ($check_result && $check_result->num_rows > 0) {\r\n+                // KayÄ±t mevcut, gÃ¼ncelle\r\n+                $update_sql = \"UPDATE voip_iris_rapor SET \r\n+                    talep_id = '\" . $mysqli->real_escape_string(trim($csv_data['TALEP_ID'] ?? '')) . \"',\r\n+                    talep_turu = '\" . $mysqli->real_escape_string(trim($csv_data['TALEP_TURU'] ?? '')) . \"',\r\n+                    uydu_basvuru_potansiyel_no = '\" . $mysqli->real_escape_string(trim($csv_data['UYDU_BASVURU_POTANSIYEL_NO'] ?? '')) . \"',\r\n+                    uydu_basvuru_uye_no = '\" . $mysqli->real_escape_string(trim($csv_data['UYDU_BASVURU_UYE_NO'] ?? '')) . \"',\r\n+                    dt_musteri_no = '\" . $mysqli->real_escape_string(trim($csv_data['DT_MUSTERI_NO'] ?? '')) . \"',\r\n+                    memo_kayit_tipi = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_KAYIT_TIPI'] ?? '')) . \"',\r\n+                    memo_id_tip = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_ID_TIP'] ?? '')) . \"',\r\n+                    memo_kodu = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_KODU'] ?? '')) . \"',\r\n+                    memo_kapanis_tarihi = \" . ($memo_kapanis_tarihi ? \"'$memo_kapanis_tarihi'\" : \"NULL\") . \",\r\n+                    memo_yonlenen_bayi_kodu = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_KODU'] ?? '')) . \"',\r\n+                    memo_yonlenen_bayi_adi = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_ADI'] ?? '')) . \"',\r\n+                    memo_yonlenen_bayi_yoneticisi = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_YONETICISI'] ?? '')) . \"',\r\n+                    memo_yonlenen_bayi_bolge = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_BOLGE'] ?? '')) . \"',\r\n+                    memo_yonlenen_bayi_teknik_yntc = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_TEKNIK_YNTC'] ?? '')) . \"',\r\n+                    talep_giris_tarihi = \" . ($talep_giris_tarihi ? \"'$talep_giris_tarihi'\" : \"NULL\") . \",\r\n+                    talebi_giren_bayi_kodu = '\" . $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_BAYI_KODU'] ?? '')) . \"',\r\n+                    talebi_giren_bayi_adi = '\" . $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_BAYI_ADI'] ?? '')) . \"',\r\n+                    talebi_giren_personel = '\" . $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONEL'] ?? '')) . \"',\r\n+                    talebi_giren_personelno = '\" . $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONELNO'] ?? '')) . \"',\r\n+                    talebi_giren_personelkodu = '\" . $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONELKODU'] ?? '')) . \"',\r\n+                    talebi_giren_personel_altbayi = '\" . $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? '')) . \"',\r\n+                    talep_kaynak = '\" . $mysqli->real_escape_string(trim($csv_data['TALEP_KAYNAK'] ?? '')) . \"',\r\n+                    satis_durumu = '\" . $mysqli->real_escape_string(trim($csv_data['SATIS_DURUMU'] ?? '')) . \"',\r\n+                    internet_surec_durumu = '\" . $mysqli->real_escape_string(trim($csv_data['INTERNET_SUREC_DURUMU'] ?? '')) . \"',\r\n+                    aktive_edilen_uyeno = '\" . $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_UYENO'] ?? '')) . \"',\r\n+                    aktive_edilen_outletno = '\" . $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_OUTLETNO'] ?? '')) . \"',\r\n+                    aktive_edilen_sozlesmeno = '\" . $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_SOZLESMENO'] ?? '')) . \"',\r\n+                    aktive_edilen_sozlesmekmp = '\" . $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_SOZLESMEKMP'] ?? '')) . \"',\r\n+                    aktive_edilen_sozlesmedurum = '\" . $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_SOZLESMEDURUM'] ?? '')) . \"',\r\n+                    talep_takip_notu = '\" . $mysqli->real_escape_string(trim($csv_data['TALEP_TAKIP_NOTU'] ?? '')) . \"',\r\n+                    guncel_outlet_durum = '\" . $mysqli->real_escape_string(trim($csv_data['GUNCEL_OUTLET_DURUM'] ?? '')) . \"',\r\n+                    teyit_durum = '\" . $mysqli->real_escape_string(trim($csv_data['TEYIT_DURUM'] ?? '')) . \"',\r\n+                    teyit_arama_durum = '\" . $mysqli->real_escape_string(trim($csv_data['TEYIT_ARAMA_DURUM'] ?? '')) . \"',\r\n+                    randevu_tarihi = \" . ($randevu_tarihi ? \"'$randevu_tarihi'\" : \"NULL\") . \",\r\n+                    memo_son_durum = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_SON_DURUM'] ?? '')) . \"',\r\n+                    memo_son_cevap = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_SON_CEVAP'] ?? '')) . \"',\r\n+                    memo_son_aciklama = '\" . $mysqli->real_escape_string(trim($csv_data['MEMO_SON_ACIKLAMA'] ?? '')) . \"',\r\n+                    guncelleme_tarihi = NOW()\r\n+                    WHERE memo_id = '\" . $mysqli->real_escape_string($memo_id) . \"'\";\r\n+                \r\n+                if ($mysqli->query($update_sql)) {\r\n+                    $updated++;\r\n+                } else {\r\n+                    $failed++;\r\n+                }\r\n+            } else {\r\n+                // Yeni kayÄ±t ekle\r\n+                $batch_data[] = $insert_values;\r\n+            }\r\n+        } else {\r\n+            // memo_id boÅŸ ise direkt ekle\r\n+            $batch_data[] = $insert_values;\r\n+        }\r\n         \r\n         // Batch boyutuna ulaÅŸtÄ±ÄŸÄ±nda iÅŸle\r\n         if (count($batch_data) >= $batch_size) {\r\n             $sql = \"INSERT INTO voip_iris_rapor (talep_id, talep_turu, uydu_basvuru_potansiyel_no, uydu_basvuru_uye_no, dt_musteri_no, memo_id, memo_kayit_tipi, memo_id_tip, memo_kodu, memo_kapanis_tarihi, memo_yonlenen_bayi_kodu, memo_yonlenen_bayi_adi, memo_yonlenen_bayi_yoneticisi, memo_yonlenen_bayi_bolge, memo_yonlenen_bayi_teknik_yntc, talep_giris_tarihi, talebi_giren_bayi_kodu, talebi_giren_bayi_adi, talebi_giren_personel, talebi_giren_personelno, talebi_giren_personelkodu, talebi_giren_personel_altbayi, talep_kaynak, satis_durumu, internet_surec_durumu, aktive_edilen_uyeno, aktive_edilen_outletno, aktive_edilen_sozlesmeno, aktive_edilen_sozlesmekmp, aktive_edilen_sozlesmedurum, talep_takip_notu, guncel_outlet_durum, teyit_durum, teyit_arama_durum, randevu_tarihi, memo_son_durum, memo_son_cevap, memo_son_aciklama, kayit_tarihi) VALUES \" . implode(',', $batch_data);\r\n@@ -201,9 +264,9 @@\n             }\r\n             \r\n             $batch_data = [];\r\n             \r\n-            echo \"<script>updateProgress('Ä°ÅŸlendi: \" . number_format($processed) . \" kayÄ±t');</script>\";\r\n+            echo \"<script>updateProgress('Ä°ÅŸlendi: \" . number_format($processed) . \" yeni, \" . number_format($updated) . \" gÃ¼ncelleme');</script>\";\r\n             flush();\r\n         }\r\n     }\r\n     \r\n@@ -222,9 +285,16 @@\n     \r\n     echo \"<script>updateProgress('TamamlandÄ±!');</script>\";\r\n     echo \"<div style='color: green; font-size: 18px; margin-top: 20px;'>\";\r\n     echo \"âœ… Ä°ÅŸlem tamamlandÄ±!<br>\";\r\n-    echo \"ğŸ“Š Toplam iÅŸlenen: \" . number_format($processed) . \" kayÄ±t<br>\";\r\n+    if ($processed > 0) {\r\n+        echo \"ğŸ“Š Yeni eklenen: \" . number_format($processed) . \" kayÄ±t<br>\";\r\n+    }\r\n+    if ($updated > 0) {\r\n+        echo \"ğŸ”„ GÃ¼ncellenen: \" . number_format($updated) . \" kayÄ±t<br>\";\r\n+    }\r\n+    $total_successful = $processed + $updated;\r\n+    echo \"ğŸ“ˆ Toplam baÅŸarÄ±lÄ±: \" . number_format($total_successful) . \" kayÄ±t<br>\";\r\n     if ($failed > 0) {\r\n         echo \"âŒ BaÅŸarÄ±sÄ±z: \" . number_format($failed) . \" kayÄ±t<br>\";\r\n     }\r\n     echo \"</div>\";\r\n@@ -257,9 +327,10 @@\n         <strong>â„¹ï¸ Bu yÃ¶ntem hakkÄ±nda:</strong><br>\r\n         â€¢ CSV dosyasÄ±nÄ± upload etmek yerine direkt sunucuda iÅŸler<br>\r\n         â€¢ BÃ¼yÃ¼k dosyalar iÃ§in ideal (25MB+ dosyalar)<br>\r\n         â€¢ Upload limitleri problemi yaÅŸanmaz<br>\r\n-        â€¢ <strong>TÃ¼rkÃ§e karakter desteÄŸi otomatik</strong>\r\n+        â€¢ <strong>TÃ¼rkÃ§e karakter desteÄŸi otomatik</strong><br>\r\n+        â€¢ <strong>ğŸ¯ AkÄ±llÄ± GÃ¼ncelleme:</strong> MEMO_ID deÄŸeri tabloda mevcutsa gÃ¼nceller, yoksa yeni kayÄ±t ekler\r\n     </div>\r\n     \r\n     <?php if (!empty($available_files)): ?>\r\n         <div class=\"info\">\r\n"
                }
            ],
            "date": 1755002355456,
            "name": "Commit-0",
            "content": "<?php\r\n// Direkt sunucu dosyasÄ± iÅŸleme metodu - Ä°yileÅŸtirilmiÅŸ Versiyon\r\ndefine('BASEPATH', '');\r\nrequire_once 'application/config/database.php';\r\n\r\n// Database baÄŸlantÄ±sÄ±\r\n$mysqli = new mysqli($db['default']['hostname'], $db['default']['username'], $db['default']['password'], $db['default']['database']);\r\n\r\nif ($mysqli->connect_error) {\r\n    die(\"Connection failed: \" . $mysqli->connect_error);\r\n}\r\n\r\n// TÃ¼rkÃ§e karakter desteÄŸi iÃ§in charset ayarlama\r\n$mysqli->set_charset(\"utf8mb4\");\r\n\r\n// Dinamik CSV dosya yolu - kullanÄ±cÄ±nÄ±n yÃ¼klediÄŸi dosya\r\n$csv_file = \"\";\r\n$available_files = [];\r\n\r\n// YÃ¼klenen dosyalarÄ± kontrol et\r\n$uploads_dir = \"uploads/iris_rapor/\";\r\nif (is_dir($uploads_dir)) {\r\n    $files = glob($uploads_dir . \"*.csv\");\r\n    if (!empty($files)) {\r\n        foreach ($files as $file) {\r\n            $available_files[] = [\r\n                'path' => $file,\r\n                'name' => basename($file),\r\n                'size' => filesize($file),\r\n                'date' => filemtime($file)\r\n            ];\r\n        }\r\n        // En son yÃ¼klenen dosyayÄ± varsayÄ±lan olarak seÃ§\r\n        usort($available_files, function($a, $b) {\r\n            return $b['date'] - $a['date'];\r\n        });\r\n        if (!empty($available_files)) {\r\n            $csv_file = $available_files[0]['path'];\r\n        }\r\n    }\r\n}\r\n\r\n// 1OrnekData klasÃ¶rÃ¼ndeki dosyalarÄ± da ekle\r\nif (is_dir(\"1OrnekData/\")) {\r\n    $sample_files = glob(\"1OrnekData/*.csv\");\r\n    foreach ($sample_files as $file) {\r\n        $available_files[] = [\r\n            'path' => $file,\r\n            'name' => \"ğŸ“ \" . basename($file),\r\n            'size' => filesize($file),\r\n            'date' => filemtime($file)\r\n        ];\r\n    }\r\n}\r\n\r\n// KullanÄ±cÄ± dosya seÃ§tiyse\r\nif (isset($_GET['selected_file']) && !empty($_GET['selected_file'])) {\r\n    $selected = $_GET['selected_file'];\r\n    if (file_exists($selected)) {\r\n        $csv_file = $selected;\r\n    }\r\n}\r\n\r\n// EÄŸer hiÃ§ dosya yoksa, varsayÄ±lan Ã¶rnek dosyayÄ± kullan\r\nif (empty($csv_file) || !file_exists($csv_file)) {\r\n    $csv_file = \"1OrnekData/Talep Raporu - TÃ¼m KayÄ±tlar-09.08.2025 09_21.csv\";\r\n}\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['process_file'])) {\r\n    echo \"<h3>Dosya Ä°ÅŸleniyor...</h3>\";\r\n    \r\n    if (!file_exists($csv_file)) {\r\n        echo \"<div style='color: red;'>HATA: CSV dosyasÄ± bulunamadÄ±: $csv_file</div>\";\r\n        exit;\r\n    }\r\n    \r\n    // Performance ayarlarÄ±\r\n    ini_set('max_execution_time', 600);\r\n    ini_set('memory_limit', '1024M');\r\n    \r\n    $handle = fopen($csv_file, 'r');\r\n    if (!$handle) {\r\n        echo \"<div style='color: red;'>HATA: CSV dosyasÄ± aÃ§Ä±lamadÄ±</div>\";\r\n        exit;\r\n    }\r\n    \r\n    // CSV dosyasÄ±nÄ±n encoding'ini kontrol et ve UTF-8'e dÃ¶nÃ¼ÅŸtÃ¼r\r\n    $first_line = fgets($handle);\r\n    rewind($handle);\r\n    \r\n    $encoding = mb_detect_encoding($first_line, ['UTF-8', 'UTF-16', 'Windows-1254', 'ISO-8859-9'], true);\r\n    echo \"Dosya encoding algÄ±landÄ±: <strong>$encoding</strong><br>\";\r\n    \r\n    // CSV baÅŸlÄ±ÄŸÄ±nÄ± oku\r\n    $header = fgetcsv($handle, 0, ';');\r\n    echo \"BaÅŸlÄ±k okundu: \" . count($header) . \" sÃ¼tun<br>\";\r\n    \r\n    $processed = 0;\r\n    $failed = 0;\r\n    $batch_size = 500;\r\n    $batch_data = [];\r\n    \r\n    echo \"<div id='progress'>Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...</div>\";\r\n    echo \"<script>\r\n    function updateProgress(text) {\r\n        document.getElementById('progress').innerHTML = text;\r\n    }\r\n    </script>\";\r\n    \r\n    while (($data = fgetcsv($handle, 0, ';')) !== FALSE) {\r\n        if (count($data) < count($header)) {\r\n            $failed++;\r\n            continue;\r\n        }\r\n        \r\n        // Encoding dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)\r\n        if ($encoding !== 'UTF-8') {\r\n            $data = array_map(function($item) use ($encoding) {\r\n                return mb_convert_encoding($item, 'UTF-8', $encoding);\r\n            }, $data);\r\n        }\r\n        \r\n        $csv_data = array_combine($header, $data);\r\n        \r\n        // Tarih formatlarÄ±nÄ± dÃ¼zelt\r\n        $memo_kapanis_tarihi = null;\r\n        if (!empty($csv_data['MEMO_KAPANIS_TARIHI'])) {\r\n            $date_str = trim($csv_data['MEMO_KAPANIS_TARIHI']);\r\n            if (preg_match('/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})\\s+(\\d{1,2}):(\\d{2})/', $date_str, $matches)) {\r\n                $memo_kapanis_tarihi = \"{$matches[3]}-{$matches[2]}-{$matches[1]} {$matches[4]}:{$matches[5]}:00\";\r\n            }\r\n        }\r\n        \r\n        $talep_giris_tarihi = null;\r\n        if (!empty($csv_data['TALEP_GIRIS_TARIHI'])) {\r\n            $date_str = trim($csv_data['TALEP_GIRIS_TARIHI']);\r\n            if (preg_match('/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})\\s+(\\d{1,2}):(\\d{2})/', $date_str, $matches)) {\r\n                $talep_giris_tarihi = \"{$matches[3]}-{$matches[2]}-{$matches[1]} {$matches[4]}:{$matches[5]}:00\";\r\n            }\r\n        }\r\n        \r\n        $randevu_tarihi = null;\r\n        if (!empty($csv_data['RANDEVU_TARIHI'])) {\r\n            $date_str = trim($csv_data['RANDEVU_TARIHI']);\r\n            if (preg_match('/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})\\s+(\\d{1,2}):(\\d{2})/', $date_str, $matches)) {\r\n                $randevu_tarihi = \"{$matches[3]}-{$matches[2]}-{$matches[1]} {$matches[4]}:{$matches[5]}:00\";\r\n            }\r\n        }\r\n        \r\n        // Insert verisi hazÄ±rla\r\n        $insert_values = \"('\" . \r\n            $mysqli->real_escape_string(trim($csv_data['TALEP_ID'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEP_TURU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['UYDU_BASVURU_POTANSIYEL_NO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['UYDU_BASVURU_UYE_NO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['DT_MUSTERI_NO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_ID'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_KAYIT_TIPI'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_ID_TIP'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_KODU'] ?? '')) . \"',\" .\r\n            ($memo_kapanis_tarihi ? \"'$memo_kapanis_tarihi'\" : \"NULL\") . \",'\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_KODU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_ADI'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_YONETICISI'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_BOLGE'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_YONLENEN_BAYI_TEKNIK_YNTC'] ?? '')) . \"',\" .\r\n            ($talep_giris_tarihi ? \"'$talep_giris_tarihi'\" : \"NULL\") . \",'\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_BAYI_KODU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_BAYI_ADI'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONEL'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONELNO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONELKODU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEBI_GIREN_PERSONEL_ALTBAYI'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEP_KAYNAK'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['SATIS_DURUMU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['INTERNET_SUREC_DURUMU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_UYENO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_OUTLETNO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_SOZLESMENO'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_SOZLESMEKMP'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['AKTIVE_EDILEN_SOZLESMEDURUM'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TALEP_TAKIP_NOTU'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['GUNCEL_OUTLET_DURUM'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TEYIT_DURUM'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['TEYIT_ARAMA_DURUM'] ?? '')) . \"',\" .\r\n            ($randevu_tarihi ? \"'$randevu_tarihi'\" : \"NULL\") . \",'\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_SON_DURUM'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_SON_CEVAP'] ?? '')) . \"','\" .\r\n            $mysqli->real_escape_string(trim($csv_data['MEMO_SON_ACIKLAMA'] ?? '')) . \"',NOW())\";\r\n        \r\n        $batch_data[] = $insert_values;\r\n        \r\n        // Batch boyutuna ulaÅŸtÄ±ÄŸÄ±nda iÅŸle\r\n        if (count($batch_data) >= $batch_size) {\r\n            $sql = \"INSERT INTO voip_iris_rapor (talep_id, talep_turu, uydu_basvuru_potansiyel_no, uydu_basvuru_uye_no, dt_musteri_no, memo_id, memo_kayit_tipi, memo_id_tip, memo_kodu, memo_kapanis_tarihi, memo_yonlenen_bayi_kodu, memo_yonlenen_bayi_adi, memo_yonlenen_bayi_yoneticisi, memo_yonlenen_bayi_bolge, memo_yonlenen_bayi_teknik_yntc, talep_giris_tarihi, talebi_giren_bayi_kodu, talebi_giren_bayi_adi, talebi_giren_personel, talebi_giren_personelno, talebi_giren_personelkodu, talebi_giren_personel_altbayi, talep_kaynak, satis_durumu, internet_surec_durumu, aktive_edilen_uyeno, aktive_edilen_outletno, aktive_edilen_sozlesmeno, aktive_edilen_sozlesmekmp, aktive_edilen_sozlesmedurum, talep_takip_notu, guncel_outlet_durum, teyit_durum, teyit_arama_durum, randevu_tarihi, memo_son_durum, memo_son_cevap, memo_son_aciklama, kayit_tarihi) VALUES \" . implode(',', $batch_data);\r\n            \r\n            if ($mysqli->query($sql)) {\r\n                $processed += count($batch_data);\r\n            } else {\r\n                $failed += count($batch_data);\r\n            }\r\n            \r\n            $batch_data = [];\r\n            \r\n            echo \"<script>updateProgress('Ä°ÅŸlendi: \" . number_format($processed) . \" kayÄ±t');</script>\";\r\n            flush();\r\n        }\r\n    }\r\n    \r\n    // Kalan kayÄ±tlarÄ± iÅŸle\r\n    if (!empty($batch_data)) {\r\n        $sql = \"INSERT INTO voip_iris_rapor (talep_id, talep_turu, uydu_basvuru_potansiyel_no, uydu_basvuru_uye_no, dt_musteri_no, memo_id, memo_kayit_tipi, memo_id_tip, memo_kodu, memo_kapanis_tarihi, memo_yonlenen_bayi_kodu, memo_yonlenen_bayi_adi, memo_yonlenen_bayi_yoneticisi, memo_yonlenen_bayi_bolge, memo_yonlenen_bayi_teknik_yntc, talep_giris_tarihi, talebi_giren_bayi_kodu, talebi_giren_bayi_adi, talebi_giren_personel, talebi_giren_personelno, talebi_giren_personelkodu, talebi_giren_personel_altbayi, talep_kaynak, satis_durumu, internet_surec_durumu, aktive_edilen_uyeno, aktive_edilen_outletno, aktive_edilen_sozlesmeno, aktive_edilen_sozlesmekmp, aktive_edilen_sozlesmedurum, talep_takip_notu, guncel_outlet_durum, teyit_durum, teyit_arama_durum, randevu_tarihi, memo_son_durum, memo_son_cevap, memo_son_aciklama, kayit_tarihi) VALUES \" . implode(',', $batch_data);\r\n        \r\n        if ($mysqli->query($sql)) {\r\n            $processed += count($batch_data);\r\n        } else {\r\n            $failed += count($batch_data);\r\n        }\r\n    }\r\n    \r\n    fclose($handle);\r\n    \r\n    echo \"<script>updateProgress('TamamlandÄ±!');</script>\";\r\n    echo \"<div style='color: green; font-size: 18px; margin-top: 20px;'>\";\r\n    echo \"âœ… Ä°ÅŸlem tamamlandÄ±!<br>\";\r\n    echo \"ğŸ“Š Toplam iÅŸlenen: \" . number_format($processed) . \" kayÄ±t<br>\";\r\n    if ($failed > 0) {\r\n        echo \"âŒ BaÅŸarÄ±sÄ±z: \" . number_format($failed) . \" kayÄ±t<br>\";\r\n    }\r\n    echo \"</div>\";\r\n    \r\n    echo \"<div style='margin-top: 20px;'>\";\r\n    echo \"<a href='/voip/hakedis-iris-rapor' style='background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;'>Raporu GÃ¶rÃ¼ntÃ¼le</a>\";\r\n    echo \"</div>\";\r\n    \r\n    $mysqli->close();\r\n    exit;\r\n}\r\n\r\n?>\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <title>Direkt CSV Ä°ÅŸleme</title>\r\n    <style>\r\n        body { font-family: Arial, sans-serif; margin: 40px; }\r\n        .info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }\r\n        .warning { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; }\r\n        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }\r\n        .btn:hover { background: #0056b3; }\r\n    </style>\r\n</head>\r\n<body>\r\n    <h2>ğŸš€ Direkt CSV Ä°ÅŸleme (Alternatif YÃ¶ntem)</h2>\r\n    \r\n    <div class=\"info\">\r\n        <strong>â„¹ï¸ Bu yÃ¶ntem hakkÄ±nda:</strong><br>\r\n        â€¢ CSV dosyasÄ±nÄ± upload etmek yerine direkt sunucuda iÅŸler<br>\r\n        â€¢ BÃ¼yÃ¼k dosyalar iÃ§in ideal (25MB+ dosyalar)<br>\r\n        â€¢ Upload limitleri problemi yaÅŸanmaz<br>\r\n        â€¢ <strong>TÃ¼rkÃ§e karakter desteÄŸi otomatik</strong>\r\n    </div>\r\n    \r\n    <?php if (!empty($available_files)): ?>\r\n        <div class=\"info\">\r\n            <h3>ğŸ“‹ Mevcut CSV DosyalarÄ±</h3>\r\n            <form method=\"get\" style=\"margin: 10px 0;\">\r\n                <select name=\"selected_file\" onchange=\"this.form.submit()\" style=\"padding: 8px; width: 100%; max-width: 500px;\">\r\n                    <?php foreach ($available_files as $file): ?>\r\n                        <option value=\"<?= htmlspecialchars($file['path']) ?>\" <?= ($file['path'] == $csv_file) ? 'selected' : '' ?>>\r\n                            <?= htmlspecialchars($file['name']) ?> \r\n                            (<?= round($file['size']/1024/1024, 2) ?> MB - <?= date('d.m.Y H:i', $file['date']) ?>)\r\n                        </option>\r\n                    <?php endforeach; ?>\r\n                </select>\r\n            </form>\r\n        </div>\r\n    <?php endif; ?>\r\n    \r\n    <?php if (file_exists($csv_file)): ?>\r\n        <div class=\"info\">\r\n            âœ… SeÃ§ili dosya: <strong><?= basename($csv_file) ?></strong><br>\r\n            ğŸ“ Boyut: <strong><?= round(filesize($csv_file)/1024/1024, 2) ?> MB</strong><br>\r\n            ğŸ“Š Tahmini sÃ¼re: <strong><?= round(filesize($csv_file)/1024/1024*0.15, 1) ?> dakika</strong>\r\n        </div>\r\n        \r\n        <form method=\"post\">\r\n            <button type=\"submit\" name=\"process_file\" class=\"btn\" onclick=\"this.style.display='none'; document.getElementById('warning').style.display='block';\">\r\n                ğŸš€ SeÃ§ili CSV DosyasÄ±nÄ± Ä°ÅŸle\r\n            </button>\r\n        </form>\r\n        \r\n        <div id=\"warning\" class=\"warning\" style=\"display: none;\">\r\n            âš ï¸ <strong>Ä°ÅŸlem baÅŸlatÄ±ldÄ±!</strong> LÃ¼tfen sayfayÄ± kapatmayÄ±n ve bekleyin...\r\n        </div>\r\n        \r\n    <?php else: ?>\r\n        <div class=\"warning\">\r\n            âŒ CSV dosyasÄ± bulunamadÄ±: <strong><?= $csv_file ?></strong><br>\r\n            DosyayÄ± doÄŸru konuma yerleÅŸtirin ve tekrar deneyin.\r\n        </div>\r\n    <?php endif; ?>\r\n    \r\n    <hr>\r\n    <div style=\"margin-top: 20px;\">\r\n        <a href=\"/voip/hakedis-iris-rapor\" style=\"color: #007bff;\">â† Ana Upload SayfasÄ±na DÃ¶n</a>\r\n    </div>\r\n</body>\r\n</html>\r\n"
        }
    ]
}